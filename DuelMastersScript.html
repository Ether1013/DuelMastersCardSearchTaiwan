	
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duel Masters Script Director - æ±ºé¬¥ç‹åŠ‡æƒ…ç·¨è¼¯å™¨ (DM TCG Editor)</title>
    <meta name="description" content="Duel Masters Script Director is a web-based TCG simulator for creating battle scenarios, replays, and visual novel-style dialogues. æ±ºé¬¥ç‹åŠ‡æƒ…ç·¨è¼¯å™¨ï¼Œæä¾›ç·šä¸Šå°æˆ°æ¨¡æ“¬ã€åŠ‡æœ¬ç·¨å¯«èˆ‡é‡æ’­åŠŸèƒ½ã€‚ãƒ‡ãƒ¥ã‚¨ãƒ«ãƒ»ãƒã‚¹ã‚¿ãƒ¼ã‚ºã®å¯¾æˆ¦ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼å…¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆãƒ„ãƒ¼ãƒ«ã€‚">    
    <meta name="keywords" content="Duel Masters, Duel Masters Script Director, DM TCG, æ±ºé¬¥ç‹, æ±ºé¬¥ç‹åŠ‡æƒ…ç·¨è¼¯å™¨, æ±ºé¬¥å¤§å¸«, æ±ºé¬¥ç‹, å¡ç‰ŒéŠæˆ²æ¨¡æ“¬å™¨, TCG Editor, Replay Generator, ãƒ‡ãƒ¥ã‚¨ãƒ«ãƒ»ãƒã‚¹ã‚¿ãƒ¼ã‚º, ãƒ‡ãƒ¥ã‚¨ãƒ, DM, å¯¾æˆ¦ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼, ç›¤é¢ä½œæˆ, æ¶ç©ºå¯¾æˆ¦, ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¨ãƒ‡ã‚£ã‚¿">   
    <meta name="author" content="Ether">
    <meta property="og:title" content="Duel Masters Script Director - æ±ºé¬¥ç‹åŠ‡æƒ…ç·¨è¼¯å™¨">
    <meta property="og:description" content="Create, edit, and share Duel Masters battle scenarios with dialogue. ç·šä¸Šæ±ºé¬¥ç‹ç›¤é¢æ¨¡æ“¬èˆ‡åŠ‡æœ¬ç·¨è¼¯å·¥å…·ã€‚">
    <meta property="og:type" content="website">
    <style>
    /* =========================================
       1. ROOT VARIABLES & GLOBAL RESET
       ========================================= */
    :root {
        /* [è¨­å®š] å…¨åŸŸåŸºæº– (æ‰‹ç‰Œå€ä½¿ç”¨æ­¤å¤§å°) */
        --card-width: 60px;
        --card-height: 84px;
        
        --bg-color: #dcdcdc;
        
        /* å‹•æ…‹ä¸»é¡Œè®Šæ•¸ */
        --p1-main: #3498db;
        --p1-bg: #e3f2fd;
        --p2-main: #e53935;
        --p2-bg: #fce4ec;

        --timeline-width: 320px;
        --highlight-color: #f1c40f;
    }

    * { box-sizing: border-box; }

    body {
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg-color);
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden; /* é˜²æ­¢æ•´é«”æ²å‹• */
    }

    /* =========================================
       2. UI COMPONENTS (Buttons, Inputs, Scrollbars)
       ========================================= */
    /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ (Chrome/Safari/Webkit) */
    .hand-zone::-webkit-scrollbar,
    #toolbar::-webkit-scrollbar,
    .diag-text::-webkit-scrollbar {
        display: none;
    }
    /* Firefox / Edge */
    .hand-zone, #toolbar, .diag-text {
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    button {
        background: #34495e;
        color: white;
        border: 1px solid #566573;
        padding: 4px 10px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 0.85rem;
        transition: all 0.2s;
    }
    button:hover { background: #4e6479; transform: translateY(-1px); }
    button:active { transform: translateY(1px); }
    
    button.primary { background: #2ecc71; border-color: #27ae60; font-weight: bold; }
    button.primary:hover { background: #27ae60; }
    
    button.danger { background: #c0392b; border-color: #e74c3c; }
    button.danger:hover { background: #e74c3c; }

    button.disabled-gray {
        filter: grayscale(100%);
        opacity: 0.5;
        pointer-events: none;
        cursor: not-allowed;
    }

    input[type="text"], input[type="number"] {
        padding: 4px;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 0.85rem;
    }

    /* =========================================
       3. TOP TOOLBAR & STATUS BARS
       ========================================= */
    #toolbar {
        height: 40px;
        background: #2c3e50;
        color: white;
        display: flex;
        align-items: center;
        padding: 0 5px;
        gap: 5px;
        flex-shrink: 0;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 50;
        overflow-x: auto; 
        white-space: nowrap;
    }

    #toolbar button, 
    #toolbar select {
        font-size: 0.75rem !important;
        padding: 3px 6px !important;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #toolbar div[style*="font-weight: 800"] {
        font-size: 1rem !important;
        margin-right: 5px !important;
    }

    #lang-select {
        background: #34495e; color: white; border: 1px solid #566573;
        padding: 4px 8px; border-radius: 4px; margin-right: 10px;
        font-size: 0.85rem; cursor: pointer; outline: none;
    }
    #lang-select:hover { background: #4e6479; }

    #draft-bar, #point-bar {
        padding: 5px 10px;
        display: none;
        align-items: center;
        justify-content: space-between;
        font-size: 0.9rem;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    /* [ä¿®æ”¹] Draft Bar æ¨£å¼ï¼šç·Šæ¹Šå…©è¡Œç‰ˆ */
    #draft-bar {
        /* å‚ç›´æ’åˆ—å…©è¡Œ */
        flex-direction: column;
        align-items: stretch;
        justify-content: flex-start;
        
        background: #e67e22; 
        color: white;
        /* ç¸®å° padding èˆ‡é–“è· */
        padding: 4px 8px;
        gap: 2px;
        
        display: none; 
        border-bottom: 3px solid #d35400;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        flex-shrink: 0; 
        z-index: 50;
    }

    /* ç¬¬ä¸€è¡Œï¼šç‹€æ…‹æ–‡å­— */
    #draft-bar .row-info {
        text-align: left; /* [ä¿®æ”¹] æ”¹ç‚ºé å·¦å°é½Š */
        font-size: 0.9rem;
        font-weight: bold;
        padding-bottom: 2px;
        border-bottom: 1px solid rgba(255,255,255,0.2);
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* ç¬¬äºŒè¡Œï¼šæ§åˆ¶é … (Checkbox + æŒ‰éˆ•) */
    #draft-bar .row-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* èª¿æ•´æŒ‰éˆ•å¤§å°ä»¥é©æ‡‰çª„æ¬„ */
    #draft-bar button {
        padding: 1px 8px;
        font-size: 0.85rem;
        height: 24px; /* å›ºå®šé«˜åº¦ */
    }
    
    #draft-bar label {
        font-size: 0.8rem;
        background: transparent; /* ç§»é™¤åŸæœ¬èƒŒæ™¯ */
        padding: 0;
    }
	
    #point-bar { background: #8e44ad; color: white; }

    /* å¤šé‡é¸å–æç¤ºåˆ— */
    #multi-select-bar {
        display: none; position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
        background: rgba(44, 62, 80, 0.9); padding: 10px 20px; border-radius: 30px;
        color: white; font-weight: bold; z-index: 2000;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3); align-items: center; gap: 10px;
    }

    /* =========================================
       4. WORKSPACE & LAYOUT
       ========================================= */
    #workspace {
        display: flex;
        flex: 1;
        overflow: hidden;
        position: relative;
    }

    #game-board-container {
        flex: 1;
        background: #95a5a6;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        overflow: hidden; 
    }

    #main-board {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        background: white;
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }

    .rotated-view #main-board { transform: rotate(180deg); }

    /* SVG Arrows Layer */
    #svg-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 999; 
    }
    .arrow-line {
        stroke: rgba(231, 76, 60, 0.8); stroke-width: 4; stroke-dasharray: 10, 5;
        animation: dash 1s linear infinite; marker-end: url(#arrowhead); fill: none;
    }
    @keyframes dash { to { stroke-dashoffset: -15; } }

    /* =========================================
       5. ZONES & PLAYERS
       ========================================= */
    .player-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 2px;
        position: relative; /* ç¢ºä¿ z-index ç”Ÿæ•ˆ */
        padding-left: 15px;
        transition: z-index 0s; /* è®“åˆ‡æ›ç¬é–“ç”Ÿæ•ˆ */
        z-index: 1; /* é è¨­å±¤ç´š */
    }

    /* [æ–°å¢] é—œéµä¿®å¾©ï¼šæ»‘é¼ æ“ä½œä¸­çš„å€åŸŸè‡ªå‹•æµ®èµ· */
    /* é€™æ¨£ P2 å±•é–‹å¡ç‰‡æ™‚ï¼ŒP2 å€åŸŸæœƒåœ¨ P1 ä¹‹ä¸Šï¼Œåä¹‹äº¦ç„¶ */
    .player-area:hover {
        z-index: 100;
    }

    #player1-area { background-color: var(--p1-bg); }
    #player2-area { 
        background-color: var(--p2-bg);
        border-bottom: 2px dashed #999;
    }
    /* P2 Layout Reordering */
		{ order: -1; }
    #player2-area .bottom-row { order: -1; } /* æ‰‹ç‰Œåœ¨æœ€ä¸Šé¢ */
    #player2-area .middle-row { order: 0; }  /* è­·ç›¾+é­”åŠ›åœ¨ä¸­é–“ */
    #player2-area .battle-zone { order: 1; } /* æˆ°é¬¥å€åœ¨æœ€ä¸‹é¢(é å…§) */
	
	/* [æ–°å¢] ä¸­æ’å®¹å™¨ï¼šå°‡è­·ç›¾èˆ‡é­”åŠ›ä½µæ’ */
    .middle-row {
        display: flex;
        flex-direction: row;
        height: var(--card-height);
        width: 100%;
        margin: 1px 0;
        overflow: visible; /* é—œéµï¼šè®“å¡ç‰‡å¯ä»¥å‡¸å‡ºä¾†ï¼Œä¸è¦åˆ‡æ‰ */
        position: relative;
        z-index: 5; /* ç¢ºä¿ä¸­æ’åœ¨æˆ°é¬¥å€ä¹‹ä¸Š (é¿å…å±•é–‹æ™‚è¢«é®ä½) */
    }

    /* [ä¿®æ”¹] ç§»é™¤èˆŠçš„é«˜åº¦é™åˆ¶ï¼Œæ”¹ç‚º flex åˆ†é… */
    .mana-zone {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        
        /* flex-grow: 1 (è‡ªå‹•å¡«æ»¿å³é‚Šå‰©ä¸‹çš„æ‰€æœ‰ç©ºé–“) */
        flex: 1 1 auto; 
        
        padding-left: 15px;
        overflow: visible;
        z-index: 5;
    }
    
    .shield-zone {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        
        /* [æ ¸å¿ƒä¿®æ­£] 
           flex-grow: 0 (ä¸ä¸»å‹•è®Šå¤§ï¼Œè§£æ±ºç•™ç™½éå¤šçš„å•é¡Œ)
           flex-shrink: 1 (ç©ºé–“ä¸è¶³æ™‚å…è¨±ç¸®å°)
           flex-basis: 260px (åŸºæº–å¯¬åº¦ = 5å¼µç‰Œå¯¬ 250px + ç·©è¡ 10px) 
        */
        flex: 0 1 260px;
        
        padding-left: 5px;
        border-right: 2px dashed rgba(0,0,0,0.1);
        overflow: visible; 
        z-index: 10;
    }
	
	/* æ¢ä»¶4 & 5: è¦–è¦ºé‡ç–Šè¨­å®š */
    /* è®“é­”åŠ›å€èˆ‡è­·ç›¾å€å…§çš„å¡ç‰‡ç¾¤çµ„ç¨å¾®è² é‚Šè·ï¼Œè£½é€ é‡ç–Šæ„Ÿ */
    .mana-zone .card-group, .shield-zone .card-group {
        margin-right: -10px; /* è®“å¡ç‰‡æ›´ç·Šæ¹Š */
    }
	
	/* [æ–°å¢] é‡å°æˆ°é¬¥ã€é­”åŠ›ã€è­·ç›¾å€é€²è¡Œç¸®å° (50px/70px ç‚ºåŸå§‹å°ºå¯¸) */
    /* é€™æ»¿è¶³äº†ã€Œç¸®å°17%ã€çš„éœ€æ±‚ (60->50, 84->70) */
    .mana-zone, .shield-zone, .hand-zone {
        --card-width: 50px;
        --card-height: 70px;
    }
	
	/* [æ–°å¢] æ¢ä»¶ 4 & 5ï¼šå¡ç‰‡ç·Šæ¹Šæ’åˆ—èˆ‡é‡ç–Šé‚è¼¯ */
    /* é€™è£¡è¨­å®šé è¨­çš„è² é‚Šè·ï¼Œè®“å¡ç‰‡åƒæ‰‡å­ä¸€æ¨£ç–Šåœ¨ä¸€èµ· */
    .shield-zone .card-group,
    .mana-zone .card-group {
        margin-right: -15px; 
        transition: margin 0.2s ease, transform 0.2s;
    }

    /* æœ€å¾Œä¸€å¼µå¡ç‰‡ä¸éœ€è¦è² é‚Šè·ï¼Œå¦å‰‡å³é‚Šæœƒç©ºæ‰ */
    .shield-zone .card-group:last-child,
    .mana-zone .card-group:last-child {
        margin-right: 0;
    }

    /* [UX å„ªåŒ–] æ»‘é¼ æŒ‡åˆ°æŸå¼µé‡ç–Šå¡æ™‚ï¼Œæé«˜å±¤ç´šä»¥å…è¢«é®ä½ */
    .shield-zone .card-group:hover,
    .mana-zone .card-group:hover {
        z-index: 500 !important;
        margin-right: -2px; /* å±•é–‹æ–¹ä¾¿é¸å– */
    }

    .zone {
        border: 1px solid rgba(0,0,0,0.15);
        margin: 1px;
        display: flex;
        align-items: center;
        position: relative;
        min-height: var(--card-height);
        border-radius: 3px;
    }
    
    .zone-label {
        position: absolute; font-size: 0.8rem; color: rgba(0,0,0,0.25);
        font-weight: 900; pointer-events: none; z-index: 0; width: 100%; text-align: center;
        top: 50%; transform: translateY(-50%); text-transform: uppercase;
    }

    /* Layout specific zones */
    .bottom-row { display: flex; height: var(--card-height); margin-top: auto; }
    .hand-zone { flex: 1; overflow-x: auto; padding: 2px; z-index: 1000; margin: 0 5px; }
    .hand-zone .card-group { margin: 0 -5px; } /* æ‰‹ç‰Œé‡ç–Šæ•ˆæœ */
    
    .side-zone-group {
		display: flex;
		flex-direction: row;
		flex-wrap: nowrap;
		gap: 3px;
		padding: 0 5px;
		width: 215px; 
		align-items: center;
		justify-content: flex-start;
		/* æ–°å¢ï¼šé˜²æ­¢è¢«å·¦å´æ‰‹ç‰Œå€æ“ å£“ */
		flex-shrink: 0 !important; 
	}
	
	/* ä¿®æ­£ï¼šé‡å°å´é‚Šç¾¤çµ„å…§çš„å †ç–Šå€çµ¦äºˆå›ºå®šå¯¬åº¦ */
	.side-zone-group .stacked {
		/* å–æ¶ˆåŸæœ¬çš„ flex: 1ï¼Œæ”¹ç‚ºå›ºå®šä¸å£“ç¸® */
		flex: 0 0 50px !important; 
		width: 50px;
		justify-content: center;
		cursor: zoom-in;
		background: rgba(0,0,0,0.1);
		border: 1px solid rgba(0,0,0,0.3);
		/* ç¢ºä¿å…§éƒ¨å¡ç‰‡ç½®ä¸­ä¸”ä¸æº¢å‡ºå°è‡´é‡ç–Š */
		display: flex;
		align-items: center;
		position: relative;
	}

    .stacked { flex: 1; justify-content: center; cursor: zoom-in; background: rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.3); }
    
    /* =========================================
   ä¿®æ­£ç‰ˆä½ˆå±€ CSS (è«‹æ›¿æ›åŸæœ‰çš„å°æ‡‰å€å¡Š)
   ========================================= */

	/* 1. é–å®šéæˆ°é¬¥å€çš„é«˜åº¦ (é˜²æ­¢è®Šå¤§æˆ–è¢«æ“ å£“) */
	.middle-row, 
	.bottom-row {
		/* é—œéµï¼šä¸ä¼¸ç¸® (grow=0, shrink=0)ï¼Œé«˜åº¦è‡ªå‹• (ç”±å…§å®¹æ’é–‹) */
		flex: 0 0 auto !important; 
		height: auto !important; 
		z-index: 10;
		position: relative;
	}

	* [ä¿®æ”¹] é‡å°æ‰€æœ‰ã€Œéæˆ°é¬¥å€ã€çµ±ä¸€ç¸®å°å°ºå¯¸ (50x70) */
    /* åŒ…å«ï¼šé­”åŠ›ã€è­·ç›¾ã€æ‰‹ç‰Œã€ç‰Œåº«ã€å¢“åœ°ã€è¶…æ¬¡å…ƒ */
    .mana-zone, .shield-zone, .hand-zone, 
    .deck-zone, .grave-zone, .hyper-zone {
        --card-width: 40px;
        --card-height: 56px;
    }

	/* 2. æˆ°é¬¥å€è¨­å®šï¼šä½”æ“šå‰©ä¸‹æ‰€æœ‰ç©ºé–“ */
	/* 1. ç¢ºä¿æˆ°é¬¥å€æ˜¯ä¸€å€‹å½ˆæ€§å®¹å™¨ï¼Œä½†ä¸æœƒéš±è—å‡¸å‡ºçš„å…§å®¹ */
	/* ä¿®æ”¹é€™æ®µ */
	.battle-zone {
		flex: 1 1 0%; 
		width: 100%;
		display: flex;
		flex-direction: row;
		align-items: flex-start; 
		justify-content: center;
		gap: 0 !important; 
		
		/* ä¸Šä¸‹ç•™ç™½ (JS æœƒå‹•æ…‹è¦†è“‹å®ƒ) */
		padding-top: 20px;
		padding-bottom: 20px;
		
		box-sizing: border-box; 
		position: relative;
		overflow: visible !important; 
		z-index: 5;

		/* ã€æ–°å¢é€™è¡Œã€‘æ–¬æ–·ç„¡é™é•·é«˜çš„é—œéµï¼ */
		/* å‘Šè¨´ Flexboxï¼šå³ä½¿å…§å®¹è®Šå¤šï¼Œä¹Ÿä¸è¦æ’å¤§é€™å€‹å®¹å™¨ï¼Œè«‹ç¶­æŒåˆ†é…çš„é«˜åº¦ */
		min-height: 0; 
	}

	/* 3. ç¸®æ”¾é‚è¼¯ï¼šåš´æ ¼é™å®šåªåœ¨æˆ°é¬¥å€ç”Ÿæ•ˆ */
	.battle-zone .card-group {
		/* æ ¸å¿ƒä½ˆå±€ */
		transform-origin: center top; 
		flex-shrink: 0;
		position: relative;
		z-index: 10;
		margin: 0 2px;
		
		/* å¹³å¸¸é–‹å•Ÿå‹•ç•« (è®“æ“ä½œæ»‘é †) */
		transform: scale(var(--bz-scale, 1));
		transition: transform 0.2s ease, margin 0.2s ease;
	}
	
	/* ã€é–‹é—œã€‘åˆå§‹åŒ–æ™‚ï¼Œå¼·åˆ¶é—œé–‰æ‰€æœ‰å‹•ç•« (åŒ…å«å…§éƒ¨å­å…ƒç´ ) */
	.battle-zone .card-group.initializing,
	.battle-zone .card-group.initializing * {
		transition: none !important;
		animation: none !important;
	}
	
	/* ã€æ–°å¢ã€‘åˆå§‹åŒ–ç‹€æ…‹ï¼šå¼·åˆ¶é—œé–‰å‹•ç•« */
	/* ç•¶å¡ç‰‡å‰›ç”Ÿæˆã€JS é‚„åœ¨ç®—é–“è·æ™‚ï¼ŒåŠ ä¸Šé€™å€‹ class */
	.battle-zone .card-group.initializing {
		transition: none !important;
	}
	
	/* ã€æ–°å¢ã€‘ç•¶ JS è¨ˆç®—å®Œæˆä¸¦åŠ ä¸Šæ­¤ class å¾Œï¼Œæ‰è®“å¡ç‰‡ç¾èº« */
	.battle-zone .card-group.layout-done {
		opacity: 1;
	}

	/* (ç¢ºä¿é€™æ®µé‚„åœ¨) æ»‘é¼ æ‡¸åœæ™‚ç½®é ‚ */
	.battle-zone .card-group:hover {
		z-index: 9999 !important;
	}
	
	/* 4. [é—œéµ] æ¢å¾©å¡ç‰‡æœ¬é«”çš„æ»‘é¼ æ„Ÿæ‡‰ï¼Œé€™æ¨£ Hover/Click æ‰æœƒç”Ÿæ•ˆ */
	.battle-zone .card-group .card {
		pointer-events: auto;
	}

	/* æ©«ç½®ç¾¤çµ„ï¼šå‚ç›´ç½®ä¸­ (è¦†å¯«ä¸Šé¢çš„ flex-start) */
	.battle-zone .card-group.tapped-group {
		align-self: center;
		/* æ©«ç½®æ™‚æ”¹ç‚ºä¸­å¿ƒç¸®æ”¾ï¼Œç¢ºä¿è¦–è¦ºå±…ä¸­ */
		transform-origin: center center;
	}

	/* 4. å®‰å…¨ç¶²ï¼šå¼·åˆ¶å…¶ä»–å€åŸŸä¸ç¸®æ”¾ */
	.mana-zone .card-group,
	.shield-zone .card-group,
	.hand-zone .card-group,
	.side-zone-group .card-group {
		transform: none !important;
	}

    /* Zone Highlights */
    .zone.target-highlight {
        background-color: rgba(46, 204, 113, 0.4);
        border: 2px dashed #27ae60;
        box-shadow: inset 0 0 10px rgba(46, 204, 113, 0.5);
        cursor: copy; z-index: 100;
    }
    .zone.point-target-highlight {
        background-color: rgba(142, 68, 173, 0.2);
        border: 2px dashed #9b59b6;
        cursor: crosshair; z-index: 100;
    }

    /* Ability/Stack Zone (Left Panel) */
    #ability-stack-zone {
        width: 100px;
        background: #bdc3c7;
        border-right: 2px solid #7f8c8d;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        z-index: 10;
    }
    #ability-stack-zone.rotated-view { flex-direction: column-reverse; }
    
    .ability-column {
        flex: 1; display: flex; flex-direction: column; align-items: center;
        padding: 5px 0; overflow-y: auto; position: relative; gap: 5px;
    }
    #ability-zone-p1 { background: var(--p1-bg); }
    #ability-zone-p2 { background: var(--p2-bg); }
    
    #ability-stack-zone:not(.rotated-view) #ability-zone-p2 { border-bottom: 2px dashed #7f8c8d; }
    #ability-stack-zone.rotated-view #ability-zone-p1 { border-bottom: 2px dashed #7f8c8d; }
    
    .ability-label {
        font-size: 0.7rem; font-weight: bold; color: #555; margin-bottom: 5px; opacity: 0.7;
    }

    /* Reveal Zone (Center Overlay) */
    #reveal-zone {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        min-width: 200px; min-height: 120px;
        background: rgba(0, 0, 0, 0.8);
        border: 2px dashed #f1c40f; border-radius: 10px;
        z-index: 300; display: none;
        justify-content: center; align-items: center; flex-wrap: wrap;
        gap: 10px; padding: 30px 20px 20px 20px; 
        transition: opacity 0.3s;
        box-shadow: 0 0 20px rgba(241, 196, 15, 0.3);
    }
    #reveal-zone .zone-label {
        top: 5px; left: 10px; width: auto; transform: none;
        color: #f1c40f; text-shadow: none; font-size: 1rem; pointer-events: none;
    }

    /* Turn Indicators */
    .turn-bar {
        position: absolute; left: 0; top: 0; bottom: 0;
        width: 12px; background: #95a5a6; z-index: 50;
        transition: all 0.5s ease;
        border-right: 1px solid rgba(0,0,0,0.1); cursor: pointer;
    }
    #player1-area.active-turn .turn-bar {
        background: var(--p1-main);
        box-shadow: 0 0 15px 2px var(--p1-main);
        animation: pulse-p1 2s infinite;
    }
    #player2-area.active-turn .turn-bar {
        background: var(--p2-main);
        box-shadow: 0 0 15px 2px var(--p2-main);
        animation: pulse-p2 2s infinite;
    }
    @keyframes pulse-p1 {
        0%, 100% { box-shadow: 0 0 10px 2px var(--p1-main); opacity: 0.8; }
        50% { box-shadow: 0 0 25px 8px var(--p1-main); opacity: 1; }
    }
    @keyframes pulse-p2 {
        0%, 100% { box-shadow: 0 0 10px 2px var(--p2-main); opacity: 0.8; }
        50% { box-shadow: 0 0 25px 8px var(--p2-main); opacity: 1; }
    }

    /* =========================================
       6. CARDS
       ========================================= */
    .card-group {
        position: relative;
        width: auto; min-width: var(--card-width); height: var(--card-height);
        margin: 0 5px;
        display: flex; justify-content: center; align-items: center;
        transition: all 0.3s;
    }
    .card-group:hover { z-index: 1000 !important; }
    
    /* Disable CSS hover expansion to let JS handle it */
    .card-group:hover .stack-base,
    .card-group:hover .stack-top,
    .card-group:hover .stack-shift-up,
    .card-group:hover .stack-shift-down,
    .card-group:hover .stack-bottom { 
        top: auto; z-index: auto;
    }

    .card {
        width: var(--card-width); height: var(--card-height);
        background-color: white; border: 1px solid #333; border-radius: 3px;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        position: relative; font-size: 9px; cursor: pointer;
        box-shadow: 1px 1px 3px rgba(0,0,0,0.4); user-select: none;
        transition: box-shadow 0.2s, border-color 0.2s, top 0.2s cubic-bezier(0.25, 0.8, 0.25, 1), left 0.2s cubic-bezier(0.25, 0.8, 0.25, 1), transform 0.2s;
        z-index: 1; flex-shrink: 0; overflow: hidden;
        will-change: transform, top, left;
        background-size: cover; background-position: center; background-repeat: no-repeat;
    }

    .card.has-image { border: none; }
    .card.has-image[class*="glow-"] { border: 1px solid transparent; }
    .card.has-image .card-text { display: none; }
    .card:hover { z-index: 200; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    
    .card.selected { 
        box-shadow: 0 0 0 3px #f1c40f, 0 0 8px #f1c40f !important; 
        z-index: 100; 
    }
    .card.face-down { 
        background: #2c3e50;
        background-image: radial-gradient(circle, #34495e 10%, transparent 10%);
        background-size: 15px 15px; border: 1px solid white; color: transparent; 
    }
	
	.card.face-down .ace-star-mark {
		display: none !important;
	}

    .card-note {
        position: absolute; top: 1px; left: 2px; right: 2px;
        background: #f1c40f; color: black; font-size: 8px; text-align: center;
        border: 1px solid #d35400; z-index: 5;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        pointer-events: none; border-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .card-power { 
        position: absolute; bottom: 0; left: 0; width: 100%;
        background: rgba(255,255,255,0.9); border-top: 1px solid #000; 
        text-align: center; font-weight: bold; font-size: 9px; color: black;
    }
    .card-text { padding: 2px; text-align: center; line-height: 1.1; font-weight: 500;}

    /* Ability Card Specifics */
    .ability-card { 
        width: 80px; height: 35px; flex-direction: row; 
        font-size: 8px; transform: none !important; cursor: pointer; overflow: hidden; 
    }
    .ability-card .card-text { 
        font-size: 8px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 90%; 
        padding-left: 18px !important; text-align: left !important;
    }
    .ability-card .card-power { display: none; }
    
    /* Ability Card Side Note (Vertical) */
    .ability-card .card-note {
        top: 0 !important; bottom: 0 !important; left: 0 !important; right: auto !important;
        width: 16px; height: 100%;
        writing-mode: vertical-rl; text-orientation: upright;
        display: flex; justify-content: center; align-items: center;
        border-radius: 2px 0 0 2px !important; border: none !important; border-right: 1px solid #d35400 !important;
        box-shadow: 1px 0 3px rgba(0,0,0,0.2) !important;
        font-size: 9px; letter-spacing: 1px; padding: 2px 0;
    }
    
    .card.ability-card.continuous {
        border: 3px double #8e44ad !important;
        background: #f4ecf7;
        box-shadow: 0 0 5px rgba(142, 68, 173, 0.4);
    }
    .card.ability-card.continuous::after {
        content: "âˆ";
        position: absolute; top: -8px; right: -4px;
        color: #fff; background: #8e44ad; width: 18px; height: 18px;
        border-radius: 50%; font-size: 14px; font-weight: bold;
        display: flex; justify-content: center; align-items: center;
        z-index: 10; box-shadow: 1px 1px 2px rgba(0,0,0,0.3); line-height: 1;
    }

    /* Stacking Helper Classes */
    .stack-base { z-index: 10; position: absolute; }
    .stack-top { z-index: 20; position: absolute; }
    .stack-bottom { z-index: 5; position: absolute; }
    .stack-shift-up { z-index: 20; position: absolute; }
    .stack-shift-down { z-index: 20; position: absolute; }
    .stack-bottom-exposed { z-index: 5; position: absolute; }
    .stack-top-offset { z-index: 20; position: absolute; }
    .stack-puzzle-top { z-index: 20; position: absolute; }
    .stack-puzzle-bottom { z-index: 20; position: absolute; }
    .stack-puzzle-left { z-index: 20; position: absolute; }
    .stack-puzzle-right { z-index: 20; position: absolute; }

    /* Count Badge */
    .count-badge {
        position: absolute; top: -6px; right: -6px;
        background: #e74c3c; color: white;
        border-radius: 50%; width: 20px; height: 20px;
        display: flex; justify-content: center; align-items: center;
        font-size: 10px; font-weight: bold; z-index: 50;
        border: 1px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    /* =========================================
       7. TIMELINE PANEL (Right Side)
       ========================================= */
    #timeline-panel {
        width: var(--timeline-width);
        background: #ecf0f1;
        border-left: 1px solid #bdc3c7;
        display: flex; flex-direction: column; flex-shrink: 0; z-index: 20;
    }

    #timeline-header {
        padding: 8px; background: #34495e; color: white;
        font-weight: bold; text-align: center;
        display: flex; justify-content: space-between; align-items: center;
        font-size: 0.9rem;
    }

    #action-list {
        flex: 1; overflow-y: auto; list-style: none;
        padding: 0; margin: 0; padding-bottom: 20px;
    }
    #action-list.locked { overflow-y: hidden !important; padding-right: 0; }

    .action-item {
        padding: 8px 10px; border-bottom: 1px solid #dcdcdc;
        cursor: pointer; font-size: 0.85rem;
        display: flex; flex-direction: column; gap: 5px;
        background: #fdfdfd; border-left: 4px solid transparent;
    }
    .action-item:hover { background: #f0f4f7; }
    .action-item.active { background: #e8f6fd; border-left-color: #2980b9;}
    .action-item.editing { 
        background: #fffbe6 !important; border-left: 2px dashed #f39c12 !important; border: 2px dashed #f39c12 !important;
        transform: scale(1.02); box-shadow: 0 4px 10px rgba(0,0,0,0.15); z-index: 5;
    }
    .action-item.placeholder {
        border: 2px dashed #f1c40f; background: rgba(241, 196, 15, 0.1);
        color: #7f8c8d; text-align: center; padding: 15px 10px;
        font-style: italic; font-weight: bold; animation: pulse-placeholder 1.5s infinite; cursor: default;
    }
    @keyframes pulse-placeholder {
        0% { background: rgba(241, 196, 15, 0.05); }
        50% { background: rgba(241, 196, 15, 0.15); }
        100% { background: rgba(241, 196, 15, 0.05); }
    }

    .action-item.p1-action { border-left: 4px solid #3498db; background: rgba(52, 152, 219, 0.05); }
    .action-item.p1-action.active { background: rgba(52, 152, 219, 0.2); }
    
    .action-item.p2-action { border-left: 4px solid #e91e63; background: rgba(233, 30, 99, 0.05); }
    .action-item.p2-action.active { background: rgba(233, 30, 99, 0.2); }

    .action-header { display: flex; align-items: center; width: 100%; justify-content: space-between; }
    .action-index { font-weight: bold; margin-right: 6px; min-width: 18px; text-align: right; color: #7f8c8d;}
    .action-desc { flex: 1; white-space: pre-wrap; word-break: break-all; font-weight: 500;}
    
    .action-controls {
        display: flex; gap: 5px; margin-top: 5px; padding-left: 24px; opacity: 0.4; transition: opacity 0.2s;
    }
    .action-item:hover .action-controls, .action-item.active .action-controls { opacity: 1; }
    
    .mini-btn { font-size: 0.75rem; padding: 3px 8px; background: #bdc3c7; border: none; color: #2c3e50; border-radius: 3px; cursor: pointer;}
    .mini-btn:hover { background: #95a5a6; color: white; }
    .mini-btn.play-from { background: #2ecc71; color: white; }
    .mini-btn.play-step { background: #3498db; color: white; }
    .mini-btn.edit { background: #f39c12; color: white; }
    .mini-btn.delete-all { background: #c0392b; color: white; font-weight:bold; padding: 2px 6px; }
    .icon-btn { background: none; border: none; cursor: pointer; padding: 2px; opacity: 0.5; font-size: 1rem; }
    .icon-btn:hover { opacity: 1; transform: scale(1.1); }
    .icon-btn.delete { color: #c0392b; }

    /* Timeline Gaps & Insert Buttons */
    .timeline-gap {
        height: 14px; display: flex; justify-content: center; align-items: center;
        cursor: default; position: relative; gap: 15px; transition: background 0.2s;
    }
    .timeline-gap::before {
        content: ""; height: 2px; background: #ccc; width: 90%; position: absolute; z-index: 0;
    }
    .timeline-gap:hover::after { display: none !important; }
    
    .gap-btn {
        width: 24px; height: 24px; border-radius: 50%;
        display: none; justify-content: center; align-items: center;
        font-weight: bold; font-size: 16px; z-index: 10;
        cursor: pointer; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        transition: transform 0.1s; line-height: 1; padding-bottom: 2px;
        margin: 0 40px !important;
    }
    .timeline-gap:hover .gap-btn { display: flex; }
    .gap-btn:hover { transform: scale(1.2); }
    .gap-btn-plus { background: #3498db; color: white; }
    .gap-btn-minus { background: #c0392b; color: white; }

    /* =========================================
       8. FLOATING ACTION PANEL
       ========================================= */
    #card-action-panel {
        position: fixed; bottom: auto; left: 0; transform: none; cursor: move;
        background: rgba(44, 62, 80, 0.95); color: white;
        padding: 8px 12px; border-radius: 8px;
        display: none; flex-direction: column; gap: 8px;
        align-items: center; z-index: 1000;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        backdrop-filter: blur(5px); border: 1px solid #555;
        width: auto; max-width: 90vw;
    }
    #card-action-panel * { user-select: none; }
    #card-action-panel input, #card-action-panel button { cursor: pointer; }
    #card-action-panel input { cursor: text; user-select: auto; }

    .panel-row {
        display: flex; gap: 5px; align-items: center; justify-content: center; flex-wrap: wrap;
    }
    .panel-sep {
        border-left: 1px solid #7f8c8d; height: 20px; margin: 0 5px; opacity: 0.5;
    }

    /* =========================================
       9. CARD EFFECTS & ANIMATIONS
       ========================================= */
    
    /* Glow Effects */
    .glow-red { box-shadow: 0 0 8px 4px rgba(255, 0, 0, 0.8) !important; border-color: red !important; }
    .glow-yellow { box-shadow: 0 0 8px 4px rgba(255, 215, 0, 0.8) !important; border-color: gold !important; }
    .glow-green { box-shadow: 0 0 8px 4px rgba(0, 255, 0, 0.8) !important; border-color: lime !important; }
    .glow-blue { box-shadow: 0 0 8px 4px rgba(0, 191, 255, 0.8) !important; border-color: deepskyblue !important; }
    .glow-black { box-shadow: 0 0 8px 4px rgba(0, 0, 0, 0.8) !important; border-color: black !important; }
    .glow-white { box-shadow: 0 0 8px 4px rgba(255, 255, 255, 0.9) !important; border-color: white !important; }
    .glow-rainbow { animation: rainbow 2s linear infinite !important; }
    @keyframes rainbow {
        0% { box-shadow: 0 0 8px 4px rgba(255, 0, 0, 0.8); border-color: red; }
        15% { box-shadow: 0 0 8px 4px rgba(255, 165, 0, 0.8); border-color: orange; }
        30% { box-shadow: 0 0 8px 4px rgba(255, 255, 0, 0.8); border-color: yellow; }
        45% { box-shadow: 0 0 8px 4px rgba(0, 255, 0, 0.8); border-color: lime; }
        60% { box-shadow: 0 0 8px 4px rgba(0, 127, 255, 0.8); border-color: cyan; }
        75% { box-shadow: 0 0 8px 4px rgba(0, 0, 255, 0.8); border-color: blue; }
        90% { box-shadow: 0 0 8px 4px rgba(139, 0, 255, 0.8); border-color: violet; }
        100% { box-shadow: 0 0 8px 4px rgba(255, 0, 0, 0.8); border-color: red; }
    }

    /* Zone Glows */
    .zone.glow-red { box-shadow: inset 0 0 20px rgba(255, 0, 0, 0.5); border: 2px solid red; }
    .zone.glow-yellow { box-shadow: inset 0 0 20px rgba(255, 215, 0, 0.5); border: 2px solid gold; }
    .zone.glow-green { box-shadow: inset 0 0 20px rgba(0, 255, 0, 0.5); border: 2px solid lime; }
    .zone.glow-blue { box-shadow: inset 0 0 20px rgba(0, 191, 255, 0.5); border: 2px solid deepskyblue; }
    .zone.glow-black { box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5); border: 2px solid black; }
    .zone.glow-white { box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.8); border: 2px solid white; }
    .zone.glow-rainbow { animation: zone-rainbow 2s linear infinite; }
    @keyframes zone-rainbow {
        0% { border-color: red; box-shadow: inset 0 0 20px rgba(255,0,0,0.5); }
        50% { border-color: blue; box-shadow: inset 0 0 20px rgba(0,255,0,0.5); }
        100% { border-color: red; box-shadow: inset 0 0 20px rgba(255,0,0,0.5); }
    }

    /* Bottom Glow (Partial) */
    .card[class*="glow-bottom-"]::after {
        content: ""; position: absolute; bottom: 0; left: 0; width: 100%; height: 50%;
        z-index: 10; pointer-events: none; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px;
        opacity: 0.85; transition: opacity 0.2s;
    }
    .card.glow-bottom-red::after { background: linear-gradient(to top, rgba(255,0,0,0.8), transparent); border-bottom: 3px solid red; box-shadow: 0 4px 10px rgba(255,0,0,0.5); }
    .card.glow-bottom-yellow::after { background: linear-gradient(to top, rgba(255,215,0,0.8), transparent); border-bottom: 3px solid gold; box-shadow: 0 4px 10px rgba(255,215,0,0.5); }
    .card.glow-bottom-green::after { background: linear-gradient(to top, rgba(0,255,0,0.8), transparent); border-bottom: 3px solid lime; box-shadow: 0 4px 10px rgba(0,255,0,0.5); }
    .card.glow-bottom-blue::after { background: linear-gradient(to top, rgba(0,191,255,0.8), transparent); border-bottom: 3px solid deepskyblue; box-shadow: 0 4px 10px rgba(0,191,255,0.5); }
    .card.glow-bottom-black::after { background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); border-bottom: 3px solid black; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
    .card.glow-bottom-white::after { background: linear-gradient(to top, rgba(255,255,255,0.9), transparent); border-bottom: 3px solid white; box-shadow: 0 4px 10px rgba(255,255,255,0.5); }
    .card.glow-bottom-rainbow::after { background: linear-gradient(to top, rgba(255,0,255,0.6), transparent); border-bottom: 3px solid white; animation: bottom-rainbow-anim 2s linear infinite; }
    @keyframes bottom-rainbow-anim {
        0% { border-bottom-color: red; box-shadow: 0 4px 10px rgba(255,0,0,0.5); }
        50% { border-bottom-color: blue; box-shadow: 0 4px 10px rgba(0,0,255,0.5); }
        100% { border-bottom-color: red; box-shadow: 0 4px 10px rgba(255,0,0,0.5); }
    }

    /* Claw / Injury Effect */
    .claw-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 50; display: flex; justify-content: center; align-items: center; opacity: 0.9;
    }
    .claw-svg { width: 130%; height: 130%; overflow: visible; }
    .claw-path { fill: none; stroke: #c0392b; stroke-width: 8; stroke-linecap: round; filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.5)); }
    .claw-anim .claw-path { stroke-dasharray: 100; stroke-dashoffset: 100; animation: scratch-anim 0.3s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
    .claw-anim .p1 { animation-delay: 0s; }
    .claw-anim .p2 { animation-delay: 0.1s; }
    .claw-anim .p3 { animation-delay: 0.05s; }
    @keyframes scratch-anim { to { stroke-dashoffset: 0; } }

    /* Ace Card System */
    .ace-star-mark {
        position: absolute; top: -6px; right: -2px; font-size: 16px;
        color: white; -webkit-text-stroke: 1.5px black; text-shadow: 2px 2px 0px rgba(0,0,0,0.3);
        cursor: pointer; z-index: 50; transition: transform 0.2s;
    }
    .ace-star-mark:hover { transform: scale(1.4); color: #e74c3c; -webkit-text-stroke: 1px #c0392b; }
    body.is-playing .ace-star-mark, body.mobile-mode .ace-star-mark { display: none !important; }
    
    .ace-star-mark { cursor: default !important; pointer-events: none !important; } /* In panel mode */
    #btn-ace.active {
        background: #f1c40f !important; border-color: #f39c12 !important; color: #2c3e50 !important;
        font-weight: bold; box-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
    }

    /* Ace Animation (Internal Glow) */
    .card.animating-ace { overflow: visible !important; z-index: 3000 !important; will-change: transform; }
    .ace-internal-glow {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; border-radius: 4px;
        transform-origin: center center; animation: ace-pop-sequence 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }
    @keyframes ace-pop-sequence {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(var(--ace-color), 0); background: rgba(var(--ace-color), 0); opacity: 0.5; }
        40% { transform: scale(1.4); box-shadow: 0 0 30px 10px rgba(var(--ace-color), 0.8); background: rgba(var(--ace-color), 0.3); opacity: 1; }
        60% { transform: scale(1.5); box-shadow: 0 0 60px 20px rgba(255, 255, 255, 1); background: rgba(255, 255, 255, 0.6); opacity: 1; border: 2px solid white; }
        100% { transform: scale(1.6); box-shadow: 0 0 80px 40px rgba(var(--ace-color), 0); background: rgba(var(--ace-color), 0); opacity: 0; border: 0px solid white; }
    }
    
    #ace-flash-layer {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: white; z-index: 9999; opacity: 0; pointer-events: none; display: none;
    }
    .anim-flash-white { display: block !important; animation: flash-white 0.5s ease-out forwards; }
    @keyframes flash-white { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }

    /* Multi-Select Checkmark */
    .card .check-mark {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        font-size: 40px; color: #e74c3c; font-weight: 900;
        text-shadow: 2px 2px 0px white, -2px -2px 0px white, 2px -2px 0px white, -2px 2px 0px white;
        z-index: 200; pointer-events: none; display: none;
    }
    .card.multi-selected .check-mark { display: block; }
    .card.multi-selected { border: 3px solid #e74c3c !important; box-shadow: 0 0 10px rgba(231, 76, 60, 0.5); }
    #btn-multi-move.active {
        background: #e74c3c !important; border-color: #c0392b !important; animation: pulse-red 2s infinite;
    }
    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }

    /* EX-Life Overlay ä¿®è¨‚ */
    .ex-life-overlay {
        position: absolute; 
        top: 20%; 
        left: 0; 
        width: 100%; 
        height: 40%; 
        z-index: 15;
        /* ç§»é™¤åŸæœ¬çš„ background-size: coverï¼Œç”± JS å‹•æ…‹æ§åˆ¶æˆ–å¯«æ­»åœ¨ CSS */
        border-top: 1px dashed rgba(255,255,255,0.5); 
        border-bottom: 1px dashed rgba(255,255,255,0.5);
        pointer-events: none; 
        opacity: 0.9;
        overflow: hidden; /* ç¢ºä¿å…§å®¹ä¸æº¢å‡º */
    }
    .ex-life-close {
        position: absolute; top: -6px; right: -6px; width: 14px; height: 14px;
        font-size: 9px; font-weight: bold; background: #c0392b; color: white;
        border: 1px solid white; border-radius: 50%; cursor: pointer; display: none;
        justify-content: center; align-items: center; pointer-events: auto; z-index: 20;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    .card:hover .ex-life-close { display: flex; }

    /* Unseen Cards */
    @keyframes pulse-unseen {
        0%, 100% { box-shadow: 0 0 5px 2px rgba(0, 255, 255, 0.4); border-color: rgba(0, 255, 255, 0.5); }
        50% { box-shadow: 0 0 15px 5px rgba(0, 255, 255, 0.8); border-color: rgba(0, 255, 255, 1); }
    }
    .glow-unseen { animation: pulse-unseen 2s infinite ease-in-out !important; border: 2px dashed #00ffff !important; z-index: 500 !important; }

    /* Random Pick & Unseen Check Buttons */
    .random-pick-btn {
        position: absolute; top: 5px; right: 5px; z-index: 1500;
        background: rgba(44, 62, 80, 0.8); border: 1px solid rgba(255, 255, 255, 0.6);
        color: white; font-size: 0.75rem; padding: 4px 8px; border-radius: 12px;
        cursor: pointer; transition: all 0.2s; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .random-pick-btn:hover { background: #f1c40f; color: #2c3e50; border-color: #f39c12; transform: scale(1.1); }
    
    .unseen-check-btn {
        position: absolute; top: 38px; right: 5px; left: auto; z-index: 1500;
        background: rgba(0, 0, 0, 0.6); border: 1px solid rgba(0, 255, 255, 0.5);
        color: #00ffff; font-size: 0.75rem; padding: 2px 6px; border-radius: 12px;
        cursor: pointer; transition: all 0.2s; font-weight: bold;
    }
    .unseen-check-btn:hover, .unseen-check-btn.active { background: #00ffff; color: #000; box-shadow: 0 0 10px rgba(0, 255, 255, 0.6); }

    /* Card Jump Anim */
    @keyframes card-jump-twice {
        0%, 50%, 100% { transform: var(--base-transform) translateY(0); }
        25%, 75% { transform: var(--base-transform) translateY(-25px); }
    }
    .card-jump {
        animation: card-jump-twice 0.6s ease-in-out;
        box-shadow: 0 0 20px #f1c40f !important; border-color: #f1c40f !important;
        z-index: 2000 !important;
    }

    /* =========================================
       10. MODALS & POPUPS
       ========================================= */
    .modal {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); z-index: 2000;
        justify-content: center; align-items: center; backdrop-filter: blur(2px);
    }
    .modal-content {
        background: white; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        padding: 20px; display: flex; flex-direction: column;
        animation: slideUp 0.3s ease;
    }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Setup Modal */
    #setup-modal .modal-content { width: 320px; gap: 15px; }
    .input-group { display: flex; justify-content: space-between; align-items: center; }
    .input-group label { font-weight: bold; font-size: 0.9rem; }
    .input-group input { width: 60px; text-align: center; }

    /* Card Selector Modal */
    #card-selector-modal .modal-content { width: 85%; max-width: 900px; height: 85%; }
    #modal-body { flex: 1; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 12px; padding: 15px; background: #f8f9fa; border-radius: 4px; align-content: flex-start; }
    #modal-body .card.has-image-icon { background-size: cover; background-position: center; color: transparent; text-shadow: none; }

    /* Position Selector Modal */
    #position-selector-modal .modal-content { width: 90%; max-width: 600px; height: auto; max-height: 80vh; display: flex; flex-direction: column; }
    #position-list {
        flex: 1; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 8px;
        padding: 15px; background: #eee; border-radius: 4px; min-height: 0;
        align-content: flex-start; justify-content: flex-start;
    }
    .position-slot {
        width: var(--card-width); height: var(--card-height);
        background: rgba(255, 255, 255, 0.5); border: 2px dashed #999; border-radius: 4px;
        display: flex; justify-content: center; align-items: center;
        text-align: center; font-size: 0.7rem; color: #555; cursor: pointer;
        transition: all 0.2s; flex-shrink: 0; position: relative;
    }
    .position-slot:hover { background: #dff9fb; border-color: #2980b9; color: #2980b9; font-weight: bold; transform: scale(1.05); z-index: 10; }
    .position-card-ref {
        width: var(--card-width); height: var(--card-height);
        border: 1px solid #ccc; border-radius: 3px; background-color: #fff;
        display: flex; justify-content: center; align-items: center;
        font-size: 0.6rem; color: #aaa; opacity: 0.7; pointer-events: none;
        flex-shrink: 0; background-size: cover; background-position: center;
        box-shadow: 1px 1px 2px rgba(0,0,0,0.1); overflow: hidden; text-align: center; padding: 2px;
    }

    #stack-gui { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; overflow-y: auto; }
    .stack-option {
        background: #f8f9fa; border: 2px solid #ddd; border-radius: 8px; padding: 10px;
        text-align: center; cursor: pointer; transition: all 0.2s;
        display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 0.8rem;
    }
    .stack-option:hover { border-color: #3498db; background: #ebf5fb; transform: translateY(-2px); box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
    .stack-icon { width: 30px; height: 40px; background: #ccc; border: 1px solid #999; position: relative; display: block; margin-bottom: 5px; }
    /* Icons */
    .icon-top .child { position: absolute; top:0; left:0; width:100%; height:100%; background:#3498db; border:1px solid white; z-index:2; opacity:0.8; }
    .icon-bottom .child { position: absolute; top:0; left:0; width:100%; height:100%; background:#2c3e50; border:1px solid white; z-index:-1; }
    .icon-up .child { position: absolute; top:-15px; left:0; width:100%; height:100%; background:#e67e22; border:1px solid white; z-index:2; opacity:0.9; }
    .icon-down .child { position: absolute; top:15px; left:0; width:100%; height:100%; background:#9b59b6; border:1px solid white; z-index:2; opacity:0.9; }
    .icon-bottom-exp .child { position: absolute; top:20px; left:0; width:100%; height:100%; background:#27ae60; border:1px solid white; z-index:-1; opacity: 0.9; }
    .icon-p-top .child { position: absolute; top:-38px; left:0; width:100%; height:100%; background:#e74c3c; border:1px solid white; z-index:2; }
    .icon-p-bottom .child { position: absolute; top:38px; left:0; width:100%; height:100%; background:#e74c3c; border:1px solid white; z-index:2; }
    .icon-p-left .child { position: absolute; top:0; left:-28px; width:100%; height:100%; background:#e74c3c; border:1px solid white; z-index:2; }
    .icon-p-right .child { position: absolute; top:0; left:28px; width:100%; height:100%; background:#e74c3c; border:1px solid white; z-index:2; }

    /* Theme Picker */
    #theme-picker-modal .modal-content { width: 340px; }
    .color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
    .color-swatch {
        aspect-ratio: 1; border-radius: 8px; cursor: pointer; border: 3px solid transparent;
        transition: transform 0.2s; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .color-swatch:hover { transform: scale(1.1); }
    .color-swatch.active { border-color: #333; transform: scale(0.95); }
    .color-swatch.disabled { opacity: 0.2; cursor: not-allowed; filter: grayscale(1); }
    .color-swatch.disabled::after { content: "âœ–"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #333; font-weight: bold; }

    /* BGM Modal */
    .bgm-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s; }
    .bgm-item:hover { background: #f9f9f9; }
    .bgm-item.selected { background: #e8f6fd; color: #2980b9; font-weight: bold; }
    .bgm-item.playing-preview::after { content: "ğŸ”Š"; margin-left: auto; }

    /* Import List */
    .import-script-item {
        padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s;
        position: relative; display: flex; flex-direction: column; gap: 4px;
    }
    .import-script-item:hover { background: #e8f6fd; }
    .import-script-item:last-child { border-bottom: none; }
    .import-script-title { font-weight: bold; font-size: 1rem; color: #2c3e50; }
    .import-script-desc { font-size: 0.85rem; color: #7f8c8d; }
    .import-script-lang {
        position: absolute; top: 10px; right: 10px; font-size: 0.7rem; background: #eee;
        color: #555; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase;
    }

    /* =========================================
       11. DIALOGUE SYSTEM
       ========================================= */
    #dialogue-layer {
        position: absolute; top: 0; left: 100px; right: 380px; width: auto; height: 100%;
        pointer-events: none; z-index: 2000; display: none;
        flex-direction: column; justify-content: space-between; overflow: hidden; padding: 20px 0;
    }
    #dialogue-layer.active { display: flex; }

    .diag-row {
        display: flex; width: 100%; height: 180px; align-items: flex-end; position: relative;
        opacity: 0; transition: opacity 0.2s; pointer-events: none;
    }
    .diag-row.visible { opacity: 1; pointer-events: auto; }
    .diag-row.top { flex-direction: row-reverse; align-items: flex-start; }
    .diag-row.bottom { flex-direction: row; }

    .diag-portrait {
        width: 160px; height: 160px; flex-shrink: 0; margin: 0 10px; border-radius: 8px;
        background-size: cover; background-position: center;
        border: 2px solid rgba(255,255,255,0.5); box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        background-color: rgba(0,0,0,0.8); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .diag-box {
        flex: 1; height: 100%; max-width: 70%;
        background: linear-gradient(180deg, rgba(0,20,40,0.9) 0%, rgba(0,10,20,0.95) 100%);
        border: 2px solid var(--p1-main);
        display: flex; flex-direction: column; padding: 15px; position: relative; margin: 0 20px;
        box-shadow: 0 0 15px rgba(0,0,0,0.2); backdrop-filter: blur(2px);
    }

    .diag-row.bottom .diag-box { border-color: var(--p1-main); }
    .diag-row.bottom .diag-portrait { border-color: var(--p1-main); }
    .diag-row.bottom .diag-name { background: var(--p1-main); }
    .diag-row.top .diag-box { border-color: var(--p2-main); }
    .diag-row.top .diag-portrait { border-color: var(--p2-main); }
    .diag-row.top .diag-name { background: var(--p2-main); }

    .diag-name {
        background: #3498db; color: white; padding: 2px 10px;
        font-size: 0.9rem; font-weight: bold; display: inline-block;
        transform: skewX(-15deg); margin-bottom: 8px; align-self: flex-start;
        box-shadow: 2px 2px 0 rgba(0,0,0,0.5);
    }
    .diag-row.top .diag-name { align-self: flex-end; }

    .diag-text { 
        color: white; line-height: 1.4; white-space: pre-wrap; text-shadow: 1px 1px 2px black;
        flex: 1; overflow-y: auto; 
    }
    .text-s { font-size: 1rem; }
    .text-m { font-size: 1.5rem; }
    .text-l { font-size: 2.2rem; font-weight: bold; color: #f1c40f; }

    /* Animations */
    .fx-fade { animation: fadeIn 0.5s ease forwards; }
    .fx-slide { animation: slideInX 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .diag-row.bottom .fx-slide { animation-name: slideInLeft; }
    @keyframes slideInLeft { from { transform: translateX(-50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .diag-row.top .fx-slide { animation-name: slideInRight; }
    @keyframes slideInRight { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    /* Dialogue Editor */
    .emotion-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-top: 5px; }
    .emotion-opt { 
        width: 100%; aspect-ratio: 1; border: 2px solid #555; cursor: pointer; 
        background-size: cover; border-radius: 4px; opacity: 0.6;
    }
    .emotion-opt:hover { opacity: 1; }
    .emotion-opt.active { border-color: #f1c40f; opacity: 1; box-shadow: 0 0 5px #f1c40f; }
    .diag-editor-row { display: flex; gap: 10px; margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: #fdfdfd; }
    .diag-editor-col { flex: 1; display: flex; flex-direction: column; gap: 5px; }
    .diag-editor-col button { margin-top: 5px; }

    #emotion-preview-tooltip {
        position: fixed; width: 200px; height: 200px;
        background-color: #222; border: 2px solid #f1c40f; box-shadow: 0 4px 20px rgba(0,0,0,0.8);
        z-index: 10000; display: none; background-size: contain; background-repeat: no-repeat;
        background-position: center; pointer-events: none; border-radius: 8px; backdrop-filter: blur(5px);
    }

    /* =========================================
       12. SPECIAL EFFECTS & FEATURES
       ========================================= */
    
    /* Playback Slider (Vertical) */
    #playback-slider-container {
        position: fixed; right: 0px; top: 50%; transform: translateY(-50%); height: 95vh;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        z-index: 3001; gap: 10px; pointer-events: none;
    }
    #playback-slider-container > * { pointer-events: auto; }
    
    #slider-zone {
        width: 30px; background: #2c3e50; border-left: 1px solid #34495e; border-right: 1px solid #bdc3c7;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        position: relative; z-index: 20; flex-shrink: 0;
    }
    #slider-tooltip {
        position: absolute; top: 20px; background: rgba(241, 196, 15, 0.9); color: #000;
        padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold;
        pointer-events: none; z-index: 25; white-space: nowrap;
    }
    #playback-slider {
        -webkit-appearance: none; appearance: none; width: 90vh; height: 6px;
        background: rgba(255, 255, 255, 0.2); border-radius: 3px; outline: none;
        transform: rotate(90deg); cursor: pointer;
    }
    #playback-slider::-webkit-slider-thumb {
        -webkit-appearance: none; appearance: none; width: 16px; height: 16px;
        border-radius: 50%; background: #f1c40f; cursor: pointer; border: 2px solid #fff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.5); transition: transform 0.1s;
    }
    #playback-slider::-webkit-slider-thumb:hover { transform: scale(1.4); }

    /* RPS (Rock Paper Scissors) */
    /* =========================================
       RPS (Rock Paper Scissors) - Animated Sequence
       ========================================= */
    #rps-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 2500; display: none;
        flex-direction: column; justify-content: center; align-items: center;
        background: rgba(0,0,0,0.6); 
        perspective: 1000px;
    }

    .rps-container {
        position: absolute; width: 100%; height: 150px;
        display: flex; justify-content: center; align-items: center; gap: 15px;
    }
    /* P2 å®¹å™¨æ—‹è½‰ 180 åº¦ï¼Œæ»¿è¶³ã€Œåœ–é ‚æœä¸­ç·šã€çš„éœ€æ±‚ */
    .rps-container.p2 { top: 10%; transform: rotate(180deg); } 
    .rps-container.p1 { bottom: 10%; }

    .rps-card {
        width: var(--card-width); 
        height: var(--card-height);
        background-color: white; border: 1px solid #333; border-radius: 4px;
        background-size: cover; background-position: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        /* åˆå§‹ç‹€æ…‹ï¼šéœæ­¢æ–¼åŸä½ */
        transform: translateY(0) scale(1);
    }

    /* --- å‹•ç•«å®šç¾© (ç¸½é•· 1.5ç§’) --- */
    
    /* 1. å‡ºç‰Œå‹•ç•«ï¼šå‰ 30% æ™‚é–“éœæ­¢(æº–å‚™)ï¼Œä¹‹å¾Œä¼¸å‡º */
    @keyframes rps-play-sequence {
        0%, 30% { transform: translateY(0) scale(1); z-index: 1; } 
        100% { transform: translateY(-80px) scale(1.5); z-index: 50; } 
    }
	
	/* åŒæ­¥ä¿®æ­£å‹è€…å‹•ç•«çš„æœ€çµ‚ç‹€æ…‹ (ä¿æŒä¸€è‡´) */
    @keyframes rps-winner-pulse {
        from { box-shadow: 0 0 20px 5px gold; }
        to { box-shadow: 0 0 40px 10px rgba(255, 215, 0, 0.5); transform: translateY(-80px) scale(1.55); }
    }

    /* 2. æœªé¸ä¸­å‹•ç•«ï¼šå‰ 30% æ™‚é–“éœæ­¢ï¼Œä¹‹å¾Œæ·¡å‡º */
    @keyframes rps-fade-sequence {
        0%, 30% { opacity: 1; transform: scale(1); filter: grayscale(0%); }
        100% { opacity: 0.3; transform: scale(0.8); filter: grayscale(100%); }
    }

    /* 3. å‹è€…å…‰æšˆï¼šå»¶é²é–ƒçˆ */
    @keyframes rps-winner-flash {
        0% { box-shadow: 0 10px 30px rgba(0,0,0,0.8); border-color: #333; }
        100% { box-shadow: 0 0 40px 10px rgba(255, 215, 0, 0.8); border-color: gold; }
    }

    /* 4. çµæœæ–‡å­—å½ˆå‡º */
    @keyframes rps-pop-in {
        0% { transform: translate(-50%,-50%) rotate(-15deg) scale(0); opacity: 0; }
        100% { transform: translate(-50%,-50%) rotate(-15deg) scale(1); opacity: 1; }
    }

    /* --- å¥—ç”¨å‹•ç•«åˆ° Class --- */

    .rps-card.selected {
        /* åŸ·è¡Œå‡ºç‰Œå‹•ç•«ï¼Œåœåœ¨æœ€å¾Œä¸€æ ¼ */
        animation: rps-play-sequence 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    .rps-card.unselected {
        animation: rps-fade-sequence 1.5s ease forwards;
    }

    .rps-card.winner {
        /* å‡ºç‰Œå‹•ç•«: 1.5s 
           é–ƒçˆå‹•ç•«: å»¶é² 1.5s å¾Œé–‹å§‹ï¼ŒæŒçºŒé–ƒçˆ
        */
        animation: 
            rps-play-sequence 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards,
            rps-winner-flash 0.5s ease-in-out 1.5s infinite alternate; 
    }

    /* æ¨™ç±¤èˆ‡ VS æ–‡å­—ä¹Ÿé…åˆå»¶é²é¡¯ç¤º */
    .rps-label {
        position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%);
        color: white; font-weight: bold; background: rgba(0,0,0,0.5); 
        padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;
        opacity: 0; 
        animation: fadeIn 0.5s 1.5s forwards; /* ä¿®æ­£ç‚º 1.5s */
    }
    .rps-container.p2 .rps-label { transform: translateX(-50%) rotate(180deg); bottom: auto; top: -25px; }

    .rps-vs-text {
        font-size: 3rem; font-weight: 900; color: #f1c40f; 
        text-shadow: 2px 2px 0 #c0392b; z-index: 5;
        opacity: 0; 
        animation: fadeIn 0.5s 1.5s forwards; /* ä¿®æ­£ç‚º 1.5s */
    }
    
    /* å¹³æ‰‹æ–‡å­—æ¨£å¼ */
    .rps-result-msg {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%) rotate(-15deg);
        font-size: 4rem; color: white; font-weight: 900; text-shadow: 0 0 10px black;
        border: 5px solid white; padding: 10px 40px; border-radius: 10px; 
        background: rgba(230,126,34,0.9); z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        opacity: 0;
        animation: rps-pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) 1.5s forwards; /* æœ€æ™šå‡ºç¾ */
    }
	
    .rps-hand {
        font-size: 5rem; text-shadow: 0 0 10px rgba(0,0,0,0.5); display: flex; flex-direction: column;
        align-items: center; color: white; transition: transform 0.3s;
    }
    .rps-hand.winner { transform: scale(1.5); text-shadow: 0 0 20px gold; filter: drop-shadow(0 0 5px gold); }
    .rps-hand.loser { opacity: 0.5; transform: scale(0.8); filter: grayscale(1); }
    .rps-vs { font-size: 2rem; font-weight: 900; color: #f1c40f; font-family: impact, sans-serif; transform: rotate(-10deg); }
    .rps-tag { font-size: 1rem; background: #2c3e50; padding: 2px 8px; border-radius: 4px; margin-top: 10px; font-weight: bold; }
    .rps-hand.p1 .rps-tag { background: #3498db; }
    .rps-hand.p2 .rps-tag { background: #c0392b; }
    .rps-hand.p2 { position: absolute; top: 20%; }
    .rps-hand.p1 { position: absolute; bottom: 20%; }

    /* Reality Break (Cut In) */
    #rb-overlay {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        z-index: 9500; display: none; overflow: hidden; pointer-events: none;
    }
    #rb-inner-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #000; background-position: center; background-repeat: no-repeat; background-size: cover;
        z-index: 10; clip-path: polygon(50% 50%, 50% 50%, 50% 50%); transition: clip-path 2.5s cubic-bezier(0.2, 1, 0.3, 1); will-change: clip-path;
    }
    #rb-paper-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #fdfdfd; 
        background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.1'/%3E%3C/svg%3E");
        z-index: 5; clip-path: polygon(50% 50%, 50% 50%, 50% 50%); transition: clip-path 2.5s cubic-bezier(0.2, 1, 0.3, 1); will-change: clip-path;
    }
    #rb-overlay.editing #rb-inner-layer { clip-path: none !important; cursor: move; pointer-events: auto; border: 2px dashed #f1c40f; z-index: 20; }
    #rb-overlay.editing #rb-paper-layer { display: none; }
    #rb-edit-hint {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        color: rgba(255,255,255,0.5); font-size: 2rem; font-weight: bold; text-align: center;
        pointer-events: none; text-shadow: 0 0 5px black; display: none;
    }
    #rb-overlay.editing #rb-edit-hint { display: block; }
    #rb-flash-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: white; opacity: 0; pointer-events: none; z-index: 9600; transition: opacity 0.5s ease-out;
    }
    #rb-controls {
        position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
        display: none; gap: 10px; z-index: 9700; pointer-events: auto;
    }
    #rb-overlay.editing #rb-controls { display: flex; }
    #rb-url-input {
        background: #333; color: white; border: 1px solid #555; padding: 4px 8px;
        border-radius: 4px; width: 150px; font-size: 0.8rem; outline: none; transition: width 0.2s;
    }
    #rb-url-input:focus { width: 250px; border-color: #3498db; background: #444; }
    #btn-rb-effect.highlight {
        background-color: #f1c40f !important; color: #2c3e50 !important; font-weight: bold; border-color: #d35400 !important;
        box-shadow: 0 0 15px rgba(241, 196, 15, 0.8); animation: rb-btn-pulse 1.5s infinite ease-in-out;
    }
    @keyframes rb-btn-pulse {
        0% { transform: scale(1); box-shadow: 0 0 5px rgba(241, 196, 15, 0.5); }
        50% { transform: scale(1.1); box-shadow: 0 0 20px rgba(241, 196, 15, 1); }
        100% { transform: scale(1); box-shadow: 0 0 5px rgba(241, 196, 15, 0.5); }
    }
    /* [ä¿®æ­£å¾Œ] æ”¯æ´é˜²ç©¿å¹«çš„éœ‡å‹•å‹•ç•« */
	@keyframes violent-shake {
		/* åœ¨æ¯ä¸€å¹€éƒ½åŠ å…¥ scale(1.05) è®“åœ–ç‰‡æ”¾å¤§ 5%ï¼Œä½œç‚ºå‡ºè¡€é‚Š */
		0%, 100% { transform: scale(1.05) translate(0, 0) rotate(0deg); }
		10% { transform: scale(1.05) translate(-10px, -10px) rotate(-1deg); }
		20% { transform: scale(1.05) translate(10px, 10px) rotate(1deg); }
		30% { transform: scale(1.05) translate(-15px, 5px) rotate(0deg); }
		40% { transform: scale(1.05) translate(15px, -15px) rotate(1deg); }
		50% { transform: scale(1.05) translate(-5px, 15px) rotate(-1deg); }
		60% { transform: scale(1.05) translate(10px, 5px) rotate(0deg); }
		70% { transform: scale(1.05) translate(-15px, -15px) rotate(1deg); }
		80% { transform: scale(1.05) translate(10px, 10px) rotate(-1deg); }
		90% { transform: scale(1.05) translate(-5px, -5px) rotate(0deg); }
	}
    body.shaking-outer #workspace, body.shaking-outer #toolbar, body.shaking-outer #rb-paper-layer { animation: violent-shake 0.5s linear infinite; }
    body.shaking-inner #rb-inner-layer { animation: violent-shake 0.5s linear infinite; }

    /* Moonless Button */
    #btn-moonless { background: #34495e; border-color: #566573; color: #bdc3c7; transition: all 0.2s; }
    #btn-moonless.active {
        background: #8e44ad !important; border-color: #9b59b6 !important; color: #fff !important;
        box-shadow: 0 0 12px rgba(142, 68, 173, 0.8), inset 0 0 5px rgba(255,255,255,0.3);
        font-weight: bold; transform: scale(1.05);
    }

    /* Win Animation */
    #win-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2000;
        display: none; flex-direction: column; justify-content: center; align-items: center;
        background: rgba(0, 0, 0, 0.4); overflow: hidden;
    }
    .win-text {
        font-size: 5rem; font-weight: 900; text-transform: uppercase; color: #f1c40f;
        text-shadow: 0 0 20px rgba(0,0,0,0.8), 3px 3px 0 #c0392b; transform: scale(0);
        animation: win-pop 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    .win-sub {
        font-size: 2rem; color: white; margin-top: 10px; opacity: 0;
        animation: slideUp 0.5s ease 0.5s forwards; text-shadow: 0 0 5px black;
    }
    .confetti {
        position: absolute; width: 10px; height: 10px; background-color: #f00;
        animation: confetti-fall 3s linear infinite;
    }
    @keyframes win-pop { 0% { transform: scale(0) rotate(-15deg); opacity: 0; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
    @keyframes confetti-fall { 0% { transform: translateY(-100px) rotate(0deg); opacity: 1; } 100% { transform: translateY(800px) rotate(720deg); opacity: 0; } }

    /* Ending (CRT Shutdown) */
    #ending-overlay {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: black; z-index: 9999; display: none; flex-direction: column;
        justify-content: center; align-items: center; opacity: 0; transition: opacity 1.5s ease-in; pointer-events: none;
    }
    .end-title {
        color: white; font-size: 3rem; font-weight: 900; letter-spacing: 5px;
        margin-bottom: 20px; text-shadow: 0 0 10px rgba(255,255,255,0.8);
        font-family: 'Courier New', Courier, monospace;
    }
    .end-sub { color: #7f8c8d; font-size: 1.2rem; font-family: sans-serif; letter-spacing: 2px; }
    
    @keyframes crt-shutdown {
        0% { transform: scale(1, 1); filter: brightness(1); }
        40% { transform: scale(1, 0.005); filter: brightness(5); }
        50% { transform: scale(1, 0.005); }
        100% { transform: scale(0, 0.005); filter: brightness(0); }
    }
    body.shutdown-mode #workspace, body.shutdown-mode #toolbar, body.shutdown-mode #card-action-panel, body.shutdown-mode #timeline-panel {
        animation: crt-shutdown 0.5s cubic-bezier(0.23, 1, 0.32, 1) forwards;
    }
    
    .end-credits {
		margin-top: 50px; 
		display: flex; 
		flex-direction: column; 
		gap: 20px; 
		text-align: center;
		opacity: 0; 
		animation: slideUp 1.5s ease 2s forwards;

		/* [æ–°å¢] è™•ç†é•·åå–® overflow */
		max-height: 60vh; /* é™åˆ¶é«˜åº¦ï¼Œè¶…éå‰‡æ²å‹• (å¯ä¾éœ€æ±‚èª¿æ•´) */
		overflow-y: auto; /* å…è¨±å‚ç›´æ²å‹• */
		padding-bottom: 50px; /* åº•éƒ¨ç•™ç™½ï¼Œé¿å…æ–‡å­—åˆ‡é½Šé‚Šç·£ */
		
		/* [æ–°å¢] éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
		scrollbar-width: none; /* Firefox */
		-ms-overflow-style: none; /* IE/Edge */
	}

	/* [æ–°å¢] éš±è— Webkit (Chrome/Safari) æ²è»¸ */
	.end-credits::-webkit-scrollbar {
		display: none; 
	}
    .credit-group { display: flex; flex-direction: column; gap: 2px; }
    .credit-role { color: #7f8c8d; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; font-family: sans-serif; }
    .credit-name { color: #ecf0f1; font-size: 1rem; font-weight: bold; font-family: sans-serif; letter-spacing: 1px; }

    /* Shuffle Animation */
    .flying-card {
        position: fixed; width: var(--card-width); height: var(--card-height);
        background: #2c3e50; background-image: radial-gradient(circle, #34495e 10%, transparent 10%);
        background-size: 15px 15px; border: 2px solid white; border-radius: 4px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 9999; pointer-events: none;
        transform-origin: center center; opacity: 0;
    }

    /* Visitor Counter */
    #visitor-counter {
        position: fixed; z-index: 100; font-family: sans-serif; font-size: 10px; pointer-events: none;
        opacity: 0.5; display: block !important;
    }
    body:not(.mobile-mode) #visitor-counter { bottom: 5px; left: 5px; color: rgba(0, 0, 0, 0.3); }

    /* =========================================
       13. MODE SPECIFICS
       ========================================= */
    
    /* Play Mode (Interaction Lock) */
    body.is-playing .ace-star-mark,
    body.is-playing .random-pick-btn,
    body.is-playing .unseen-check-btn { display: none !important; }
    
    body.is-playing #game-board-container,
    body.is-playing #ability-stack-zone,
    body.is-playing #toolbar,
    body.is-playing #draft-bar,
    body.is-playing #card-action-panel,
    body.is-playing .turn-bar,
    body.is-playing #dialogue-layer,
    body.is-playing #dialogue-layer * {
        pointer-events: none !important;
    }

    /* =========================================
       14. MOBILE MODE OVERRIDES
       ========================================= */
    #mobile-controls, #orientation-overlay, #mobile-card-viewer, #mobile-script-selector { display: none; }

    body.mobile-mode {
        overflow: hidden; position: fixed; width: 100%; height: 100%;
    }
    
    body.mobile-mode #toolbar, 
    body.mobile-mode #draft-bar, 
    body.mobile-mode #point-bar, 
    body.mobile-mode #card-action-panel, 
    body.mobile-mode #setup-modal,
    body.mobile-mode #timeline-panel,
    body.mobile-mode .random-pick-btn,
    body.mobile-mode .unseen-check-btn,
    body.mobile-mode #btn-bgm {
        display: none !important;
    }

    body.mobile-mode #workspace {
        width: 1600px !important; height: 800px !important;
        position: absolute; top: 0; left: 0; transform-origin: 0 0;
        display: flex !important; flex-direction: row;
        background: #95a5a6; box-shadow: 0 0 50px rgba(0,0,0,0.5);
        pointer-events: none !important;
    }

    body.mobile-mode #svg-layer { pointer-events: none !important; z-index: 500; }
    body.mobile-mode #ability-stack-zone { display: flex !important; width: 100px !important; height: 100%; z-index: 600; }
    body.mobile-mode #game-board-container { flex: 1; height: 100%; overflow: hidden; pointer-events: none !important; }

	/* =========================================
	   [CSS] æ‰‹æ©Ÿç‰ˆï¼šå¡ç‰Œé è¦½å°ºå¯¸ä¿®æ­£ (65vh)
	   ========================================= */

	body.mobile-mode #hover-preview {
		/* 1. é«˜åº¦å¼·åˆ¶è¨­ç‚º 65% è¦–çª—é«˜åº¦ */
		height: 65vh !important;
		
		/* 2. å¯¬åº¦è¨­ç‚ºè‡ªå‹•ï¼Œè®“å®ƒä¾ç…§æ¯”ä¾‹ç¸®æ”¾ */
		width: auto !important;
		
		/* 3. é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œé¿å…æŸäº›å¯¬è¢å¹•æ‰‹æ©Ÿä¸Šå¤ªå¯¬ */
		max-width: 90vw !important;
		
		/* 4. ç¢ºä¿å®¹å™¨å…§çš„æ’ç‰ˆ */
		display: flex !important;
		align-items: center;
		justify-content: center;
		
		/* 5. ä½ç½®å¾®èª¿ (ä¿æŒå‚ç›´ç½®ä¸­) */
		top: 50% !important;
		transform: translateY(-50%) !important;
		
		/* ç¢ºä¿èƒŒæ™¯é€æ˜ï¼Œåªç§€åœ– */
		background-color: transparent !important;
		box-shadow: none !important; /* å¦‚æœåŸæœ¬æœ‰é™°å½±ï¼Œé€™æœƒç§»é™¤æ¡†æ¡†é™°å½±ï¼Œåªç•™åœ–ç‰‡ */
	}

	/* é‡å°å…§éƒ¨çš„åœ–ç‰‡å…ƒç´ é€²è¡Œå¼·åˆ¶ç´„æŸ */
	body.mobile-mode #hover-preview img {
		/* åœ–ç‰‡é«˜åº¦å¡«æ»¿å®¹å™¨ (ä¹Ÿå°±æ˜¯ 80vh) */
		height: 100% !important;
		
		/* å¯¬åº¦è‡ªå‹•ç¶­æŒæ¯”ä¾‹ */
		width: auto !important;
		
		/* ç¢ºä¿åœ–ç‰‡å®Œæ•´å‘ˆç¾ä¸è£åˆ‡ */
		object-fit: contain !important;
	}

    /* Mobile Controls */
    #mobile-controls {
        display: none; align-items: center; justify-content: flex-end; gap: 8px;
        position: fixed; bottom: calc(15px + env(safe-area-inset-bottom)); 
        right: calc(15px + env(safe-area-inset-right));
        z-index: 5000; flex-shrink: 0; opacity: 0.95;
    }
    body.mobile-mode #mobile-controls { display: flex; z-index: 2000; }
    
    .mobile-btn {
        width: 36px; height: 36px; border-radius: 50%; border: 2px solid white;
        background: rgba(44, 62, 80, 0.9); color: white; font-size: 0.9rem;
        cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        display: flex; justify-content: center; align-items: center; padding: 0; flex-shrink: 0;
    }
    .mobile-btn:active { transform: scale(0.95); }
    #mob-music-btn.active { border-color: #2ecc71; color: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
    
    #mob-speed-select {
        height: 36px; border-radius: 18px; border: 2px solid white;
        background: rgba(44, 62, 80, 0.9); color: white; font-size: 0.85rem;
        padding: 0 10px; outline: none; box-shadow: 0 2px 5px rgba(0,0,0,0.3); text-align: center;
    }

    /* Play Button Highlight Animation */
    @keyframes play-btn-pulse {
        0% { box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.7); transform: scale(1); }
        50% { transform: scale(1.1); }
        70% { box-shadow: 0 0 0 20px rgba(241, 196, 15, 0); transform: scale(1.1); }
        100% { box-shadow: 0 0 0 0 rgba(241, 196, 15, 0); transform: scale(1); }
    }
    .btn-highlight {
        animation: play-btn-pulse 2s infinite; background: #f39c12 !important;
        border-color: #f1c40f !important; font-weight: bold; z-index: 3005 !important;
    }

    /* Mobile Orientation Overlay */
    #orientation-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #2c3e50; color: white; z-index: 10000;
        flex-direction: column; justify-content: center; align-items: center; text-align: center;
    }
    #orientation-overlay .icon { font-size: 50px; margin-bottom: 20px; animation: rotate 2s infinite; }
    @keyframes rotate { 0% {transform: rotate(0deg);} 50% {transform: rotate(-90deg);} 100% {transform: rotate(0deg);} }

    /* Mobile Slider Zone */
    body.mobile-mode #slider-zone {
		/* åŸæœ¬æ¨£å¼ä¿ç•™ */
		display: flex !important;
		top: auto !important;
		right: auto !important;
		
		/* [ä¿®æ”¹] åº•éƒ¨ç•™å‡ºç©ºé–“çµ¦æŒ‰éˆ•ï¼ŒåŸæœ¬æ˜¯ height: 100% æœƒè“‹åˆ°åº• */
		bottom: 80px !important; 
		height: auto !important;
		top: 20px !important; /* é ‚éƒ¨ä¹Ÿç•™ä¸€é» */
		
		width: 60px !important;
		z-index: 3000 !important;
		background: rgba(44, 62, 80, 0.0); /* èƒŒæ™¯æ”¹é€æ˜ä¸€é» */
		border-left: none !important;
		pointer-events: auto !important;
		
		/* è®“ Slider å‚ç›´ç½®ä¸­ */
		flex-direction: column;
		justify-content: center;
	}
    body.mobile-mode #playback-slider {
		width: 60vh !important; /* æ”¹ç”¨è¦–çª—é«˜åº¦ç™¾åˆ†æ¯” */
		height: 40px !important;
		transform: rotate(90deg);
		background: rgba(255, 255, 255, 0.3);
		border-radius: 20px;
		margin: 0;
	}
	/* 2. ç¢ºä¿æ¡Œæ©Ÿæ’­æ”¾æ¨¡å¼ä¸æœƒå½±éŸ¿æ‰‹æ©Ÿç‰ˆ (å®‰å…¨ç¶²) */
	body.mobile-mode.desktop-playing #mobile-controls {
		display: flex !important; /* æ‰‹æ©Ÿç‰ˆåŸæœ¬å°±æœ‰ï¼Œç¢ºä¿é¡¯ç¤º */
	}
    body.mobile-mode #playback-slider::-webkit-slider-thumb {
        width: 36px !important; height: 36px !important; background: #f1c40f;
        box-shadow: 0 2px 5px rgba(0,0,0,0.5); border: 3px solid #fff;
    }
    body.mobile-mode #slider-tooltip {
        transform: rotate(0deg); top: 30px; right: auto;
        font-size: 1.5rem; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    body.mobile-mode .mana-zone .card-group, body.mobile-mode .hand-zone .card-group { margin: 0 2px !important; }
    body.mobile-mode #reveal-zone { padding: 20px 15px !important; gap: 8px !important; }
    body.mobile-mode #reveal-zone .card { transform: scale(1.5); transform-origin: center center; margin: 25px 8px !important; }
    
    /* Mobile Interaction Fixes */
    body.mobile-mode .turn-bar { display: block !important; width: 20px !important; z-index: 50 !important; }
    body.mobile-mode #player1-area.active-turn .turn-bar { box-shadow: 0 0 25px 5px rgba(52, 152, 219, 0.9); }
    body.mobile-mode #player2-area.active-turn .turn-bar { box-shadow: 0 0 25px 5px rgba(233, 30, 99, 0.9); }
    
    body.mobile-mode #dialogue-layer { right: 70 !important; } /* Adjust for hidden timeline */
    body.mobile-mode #dialogue-layer, body.mobile-mode #dialogue-layer * { pointer-events: none !important; }
    body.mobile-mode .deck-zone .card, body.mobile-mode .grave-zone .card, body.mobile-mode .hyper-zone .card, body.mobile-mode #ability-stack-zone .card { pointer-events: none !important; }
    body.mobile-mode #reveal-zone .card, body.mobile-mode .card { pointer-events: auto !important; }
    body.mobile-mode #game-board-container, body.mobile-mode .zone { pointer-events: none !important; }

    /* Mobile Card Viewer */
    #mobile-card-viewer {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.6); z-index: 6000; justify-content: flex-end; align-items: center;
        padding-right: 50px; backdrop-filter: blur(2px);
    }
    #mobile-card-viewer img {
        max-height: 90vh; max-width: 50vw; box-shadow: 0 0 20px rgba(0,0,0,0.8);
        border: 3px solid white; border-radius: 10px; animation: zoomIn 0.2s ease-out;
    }
    @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    /* Mobile Script Selector */
    #mobile-script-selector {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(10, 20, 30, 0.95); z-index: 9999; flex-direction: column;
        align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px);
    }
    .script-list-container {
        width: 100%; max-width: 500px; max-height: 60vh; overflow-y: auto; margin: 20px 0;
        border: 1px solid #444; border-radius: 8px; background: rgba(0,0,0,0.3);
    }
    .script-item {
        padding: 15px; border-bottom: 1px solid #444; cursor: pointer; transition: all 0.2s; color: #ccc; position: relative;
    }
    .script-item-lang {
        position: absolute; top: 12px; right: 12px; font-size: 0.7rem; font-weight: bold;
        text-transform: uppercase; padding: 2px 6px; border-radius: 4px;
        background: rgba(255, 255, 255, 0.1); border: 1px solid #555; color: #888;
    }
    .script-item.selected .script-item-lang { background: #2980b9; border-color: #5dade2; color: white; }
    .script-item:last-child { border-bottom: none; }
    .script-item:hover { background: rgba(255,255,255,0.05); }
    .script-item.selected { background: rgba(52, 152, 219, 0.2); border-left: 5px solid #3498db; color: white; }
    .script-item-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; }
    .script-item-desc { font-size: 0.85rem; opacity: 0.7; line-height: 1.4; }
    #btn-mobile-start {
        font-size: 1.2rem; padding: 12px 40px; background: #f1c40f; color: #2c3e50; border: none;
        border-radius: 30px; font-weight: 900; box-shadow: 0 4px 15px rgba(241, 196, 15, 0.4);
        cursor: pointer; transition: transform 0.2s;
    }
    #btn-mobile-start:active { transform: scale(0.95); }
    #btn-mobile-start:disabled { background: #7f8c8d; color: #bdc3c7; cursor: not-allowed; box-shadow: none; }

    /* Mobile Ending Screen Fixes */
    body.mobile-mode .end-title { font-size: 3rem !important; margin-bottom: 5px; }
    body.mobile-mode .end-sub { font-size: 1rem !important; letter-spacing: 1px; }
    body.mobile-mode .end-credits { margin-top: 30px !important; flex-direction: row !important; flex-wrap: wrap !important; justify-content: center !important; gap: 15px 25px !important; }
    body.mobile-mode .credit-group { display: flex; flex-direction: column; align-items: center; min-width: 120px; }
    body.mobile-mode .credit-role { font-size: 0.6rem !important; letter-spacing: 1px; margin-bottom: 3px; }
    body.mobile-mode .credit-name { font-size: 0.9rem !important; }
    body.mobile-mode.shutdown-mode #workspace {
        top: 50% !important; left: 50% !important; transform-origin: center center !important;
        margin-left: -800px !important; margin-top: -400px !important;
    }
    body.mobile-mode #visitor-counter { bottom: 5px; left: 5px; color: rgba(255, 255, 255, 0.3); transform: translate(5px, -5px); }
    body.mobile-mode #rps-overlay .rps-hand { font-size: 3rem; }
    body.mobile-mode #rps-overlay .rps-vs { font-size: 1.5rem; }
    body.mobile-mode #rps-overlay .rps-tag { font-size: 0.8rem; padding: 1px 6px; }
    body.mobile-mode #rps-overlay .rps-hand.p2 { top: 8% !important; }
    body.mobile-mode #rps-overlay .rps-hand.p1 { bottom: 8% !important; }
    body.mobile-mode #rps-overlay .rps-result-text { font-size: 1.5rem !important; padding: 5px 15px !important; }

    /* Mobile Text Offset Fixes */
    .hyper-zone .zone-label { top: 25% !important; }
    .grave-zone .zone-label { top: 50% !important; }
    .deck-zone .zone-label { top: 75% !important; }
	
	/* =========================================
       [ä¿®æ­£] æ‰‹æ©Ÿç‰ˆçŒœæ‹³é˜²æ’å°ˆç”¨è¨­å®š
       ========================================= */

    /* 1. å®šç¾©æ‰‹æ©Ÿç‰ˆå°ˆç”¨çš„å‡ºç‰Œå‹•ç•« 
       - ç§»å‹•è·é›¢æ¸›åŠï¼šç”± -80px æ”¹ç‚º -40px
       - ç¸®æ”¾æ¯”ä¾‹æ¸›å°ï¼šç”± 1.5å€ æ”¹ç‚º 1.25å€
    */
    @keyframes rps-play-sequence-mobile {
        0%, 30% { transform: translateY(0) scale(1); z-index: 1; }
        100% { transform: translateY(-40px) scale(1.25); z-index: 50; }
    }

    /* 2. å¥—ç”¨å‹•ç•«åˆ°æ‰‹æ©Ÿç‰ˆ (è¦†å¯«åŸæœ¬çš„å‹•ç•«åç¨±) */
    body.mobile-mode .rps-card.selected {
        animation-name: rps-play-sequence-mobile;
    }

    body.mobile-mode .rps-card.winner {
        /* å¿…é ˆå®Œæ•´é‡å¯« animation å±¬æ€§ï¼Œç¢ºä¿åŒæ™‚å¥—ç”¨æ–°çš„ç§»å‹•å‹•ç•« + èˆŠçš„é–ƒçˆå‹•ç•« */
        animation: 
            rps-play-sequence-mobile 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards,
            rps-winner-flash 0.5s ease-in-out 1.5s infinite alternate; 
    }

    /* 3. æ¥µé™è²¼é‚Šï¼šå°‡èµ·å§‹ä½ç½®å¾€ä¸Šä¸‹é‚Šç·£æ¨ 
       - åŸæœ¬ height: 150pxï¼Œè¨­å®šè² é‚Šè· (-20px) å¯ä»¥è®“å¡ç‰‡èµ·å§‹é»æ›´é é›¢ä¸­å¤®
    */
    body.mobile-mode .rps-container.p2 { 
        top: -20px !important; 
    }
    body.mobile-mode .rps-container.p1 { 
        bottom: -20px !important; 
    }
	/* [æ–°å¢] é˜²æ­¢æ’ç‰ˆè¨ˆç®—æ™‚çš„è¦–è¦ºæŠ–å‹• */
	body.no-transition * {
		transition: none !important;
	}
	
	/* æ·±æ·µå€åŸºç¤è¨­å®š (ç¹¼æ‰¿ stacked) */
	.abyss-zone {
		/* åŸºç¤èƒŒæ™¯ï¼Œæ·±ç°è‰² */
		background-color: #2c3e50; 
		border-color: #555;
		position: relative; /* ç‚ºäº†è®“å½å…ƒç´ å®šä½ */
	}

	/* é—œéµéœ€æ±‚ï¼š30% åŠé€æ˜é»‘å¹•é®ç½© */
	.abyss-zone::after {
		content: "";
		position: absolute;
		top: 0; left: 0; 
		width: 100%; height: 100%;
		
		/* 30% é»‘è‰²åŠé€æ˜ (opå±¬æ€§æ•ˆæœ) */
		background-color: rgba(0, 0, 0, 0.3); 
		
		/* é—œéµï¼špointer-events: none è®“æ»‘é¼ é»æ“Šå¯ä»¥ã€Œç©¿é€ã€é»‘å¹• */
		/* é€™æ¨£æ‰èƒ½é»åˆ°ä¸‹é¢çš„å¡ç‰‡è§¸ç™¼ handleZoneClick */
		pointer-events: none; 
		
		/* å±¤ç´šè¨­å®šï¼š */
		/* 100 æœƒè“‹éæ™®é€šå¡ç‰‡ (z-index 1~50) -> é”åˆ°å¡ç‰‡è®Šæš—çš„æ•ˆæœ */
		/* ä½† hover æ™‚å¡ç‰‡ z-index æœƒè®Šæˆ 200 -> å¡ç‰‡æµ®èµ·æ™‚æœƒè®Šäº®ï¼Œä¸å—é»‘å¹•å½±éŸ¿ */
		z-index: 100; 
		
		border-radius: 3px;
	}

	/* å¾®èª¿å´é‚Šæ¬„å¯¬åº¦ï¼Œå®¹ç´ç¬¬å››å€‹å€åŸŸ (åŸæœ¬ 170px -> 215px) */
	/* 40px * 4å¼µå¡ + 3px * 3é–“è· = 169pxï¼ŒåŸæœ¬å¯¬åº¦å…¶å¯¦å‹‰å¼·å¤ ï¼Œä½†ç‚ºäº†ä¿éšªç¨å¾®åŠ å¯¬ */
	.side-zone-group {
		width: 215px; 
	}
	
	
	/* === ç·¨è¼¯æ¨¡å¼å°ˆç”¨æ¨£å¼ (Edit Mode Veil) === */
	/* ç•¶é€²å…¥ç·¨è¼¯æ¨¡å¼æ™‚ï¼Œè®“æ‰€æœ‰ ActionLog è®Šæ·¡ã€æ¨¡ç³Šä¸¦ç„¡æ³•é»æ“Š */
	body.in-edit-mode .action-item {
		opacity: 0.2;
		pointer-events: none; /* ç¦æ­¢é»æ“Š */
		filter: blur(1px) grayscale(0.5); /* æ¨¡ç³Šèˆ‡ç°éšæ•ˆæœ */
		transition: all 0.3s ease;
	}

	/* [ä¾‹å¤–] æ­£åœ¨ç·¨è¼¯çš„é …ç›® (editing) èˆ‡ æ–°å¢ä¸­çš„è™›ç·šæ¡† (placeholder) ä¿æŒæ¸…æ™° */
	body.in-edit-mode .action-item.editing,
	body.in-edit-mode .action-item.placeholder {
		opacity: 1 !important;
		pointer-events: auto !important; /* æ¢å¾©å¯é»æ“Š */
		filter: none !important;
		z-index: 100; /* ç¢ºä¿æµ®åœ¨æœ€ä¸Šå±¤ */
		box-shadow: 0 0 15px rgba(0,0,0,0.3); /* åŠ å¼·å‡¸é¡¯æ•ˆæœ */
		transform: scale(1.02); /* ç¨å¾®æ”¾å¤§ */
	}

	/* é–å®š ActionLog åˆ—è¡¨çš„ Scrollbar (éš±è—æ²è»¸) */
	body.in-edit-mode #action-list {
		overflow-y: hidden !important;
		padding-right: 5px; /* é¿å…æ²è»¸æ¶ˆå¤±é€ æˆçš„ç‰ˆé¢è·³å‹• */
	}

	/* é–å®šä¸‹æ–¹é€²åº¦æ¢ (ç„¡æ³•æ‹–æ›³) */
	body.in-edit-mode #playback-slider {
		pointer-events: none !important;
		opacity: 0.3;
		cursor: not-allowed;
	}
	
	/* --- [ä¿®æ­£ç‰ˆ] å›åˆåˆ‡æ›åˆ‡å…¥å‹•ç•« (å…¨è¢å¹•ç½®ä¸­) --- */
	#turn-transition-overlay {
		position: fixed;
		top: 0;       /* å¾ 40% æ”¹ç‚º 0ï¼Œä½”æ»¿é ‚éƒ¨ */
		left: 0;
		width: 100%;
		height: 100%; /* æ”¹ç‚º 100%ï¼Œä½”æ»¿æ•´å€‹è¦–çª—é«˜åº¦ */
		display: flex;
		align-items: center;    /* å‚ç›´ç½®ä¸­é—œéµ */
		justify-content: center; /* æ°´å¹³ç½®ä¸­é—œéµ */
		background: rgba(0, 0, 0, 0.85);
		z-index: 9999;
		opacity: 0;
		pointer-events: none;
		transform: scaleX(1); /* ä¿®æ­£ï¼šé è¨­ä¸éœ€æ”¶ç¸®ï¼Œæ”¹ç”±é€æ˜åº¦æ§åˆ¶å³å¯ï¼Œé¿å…æ‰‹æ©Ÿç‰ˆé–ƒçˆ */
		transition: opacity 0.2s ease-in;
	}

	#turn-transition-overlay.active {
		opacity: 1;
		pointer-events: auto; /* é¡¯ç¤ºæ™‚é˜»æ“‹é»æ“Š */
	}

	/* å…§å®¹å€å¡Šç¶­æŒåŸæ¨£ï¼Œä½†ç¨å¾®èª¿æ•´æ‰‹æ©Ÿç‰ˆå­—é«”å¤§å° */
	#tto-content {
		font-size: 3.5rem; /* é›»è…¦ç‰ˆå­—é«” */
		font-weight: 900;
		font-style: italic;
		color: white;
		text-shadow: 4px 4px 0px rgba(0,0,0,0.5);
		white-space: nowrap;
		display: flex;
		align-items: center;
		gap: 20px;
		opacity: 0;
		transform: translateY(20px);
		transition: all 0.3s ease-out 0.2s;
		width: 100%;       /* ç¢ºä¿ç·šæ¢èƒ½å»¶ä¼¸ */
		justify-content: center;
	}

	#turn-transition-overlay.active #tto-content {
		opacity: 1;
		transform: translateY(0);
	}

	.tto-line {
		height: 4px;
		flex: 1; /* ç·šæ¢è‡ªå‹•å¡«æ»¿å‰©é¤˜ç©ºé–“ */
		max-width: 300px; /* é™åˆ¶ç·šæ¢æœ€å¤§é•·åº¦ï¼Œé¿å…å¯¬è¢å¹•æ™‚å¤ªé•· */
		background: white;
		box-shadow: 0 0 10px currentColor;
	}

	/* --- [æ–°å¢] æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼èª¿æ•´ --- */
	@media (max-width: 768px) {
		#tto-content {
			font-size: 2rem; /* æ‰‹æ©Ÿç‰ˆç¸®å°å­—é«” */
			gap: 10px;
		}
		.tto-line {
			height: 3px;
			max-width: 60px; /* æ‰‹æ©Ÿç‰ˆç·šæ¢ç¸®çŸ­ */
		}
	}
	
	/* =========================================
   [æ–°å¢] æ¡Œæ©Ÿæ’­æ”¾æ¨¡å¼å°ˆç”¨æ¨£å¼ (Desktop Playback Mode)
   ========================================= */

	/* 1. éš±è—æ¡Œæ©Ÿç‰ˆå³ä¸‹è§’ ActionLog ä¸‹æ–¹çš„ [åœæ­¢æ’¥æ”¾] éµ (ä¾æ‚¨çš„éœ€æ±‚) */
	/* æ³¨æ„ï¼šé€™æœƒéš±è—åŸæœ¬åœ¨ Timeline ä¸‹æ–¹çš„æŒ‰éˆ•å€ï¼Œå¦‚æœæ‚¨åªæƒ³éš±è—åœæ­¢éˆ•ï¼Œè«‹é‡å°è©²æŒ‰éˆ• ID è¨­å®š */
	/* é€™è£¡å‡è¨­æ‚¨æ˜¯æŒ‡éš±è—æµ®å‹•æŒ‰éˆ•æˆ–ç‰¹å®šæŒ‰éˆ•ï¼Œè‹¥ç„¡ç‰¹å®š IDï¼Œé€éæ¨¡å¼åˆ‡æ›æœƒè‡ªç„¶éš±è— Timeline */

	/* 2. ç•¶ body æ“æœ‰ .desktop-playing class æ™‚ï¼Œéš±è—æ‰€æœ‰ç·¨è¼¯å™¨ UI */
	body.desktop-playing #toolbar,
	body.desktop-playing #timeline-panel,      /* éš±è—å³å´æ™‚é–“è»¸ */
	body.desktop-playing #card-action-panel,   /* éš±è—å¡ç‰‡æ“ä½œé¢æ¿ */
	body.desktop-playing #draft-bar,
	body.desktop-playing #point-bar,
	body.desktop-playing #slider-zone,         /* éš±è—åŸæœ¬çš„å‚ç›´é€²åº¦æ¢ */
	body.desktop-playing .ace-star-mark,
	body.desktop-playing .random-pick-btn,
	body.desktop-playing .unseen-check-btn,
	body.desktop-playing #visitor-counter {
		display: none !important;
	}

	/* 3. å¼·åˆ¶é¡¯ç¤ºæ‰‹æ©Ÿç‰ˆçš„æ§åˆ¶åˆ— (åŸæœ¬åœ¨æ¡Œæ©Ÿç‰ˆæ˜¯éš±è—çš„) */
	body.desktop-playing #mobile-controls {
		display: flex !important;
		position: fixed;
		bottom: 20px;
		right: 20px;
		z-index: 9999;
	}

	/* 4. èª¿æ•´æ‰‹æ©Ÿç‰ˆé€²åº¦æ¢åœ¨æ¡Œæ©Ÿæ’­æ”¾æ¨¡å¼ä¸‹çš„æ¨£å¼ (è½‰ç‚ºæ©«å‘) */
	/* é€™è£¡æˆ‘å€‘å€Ÿç”¨åŸæœ¬æ‰‹æ©Ÿç‰ˆçš„ slider-zone ä½†èª¿æ•´ä½ç½® */
	body.desktop-playing #slider-zone {
		display: flex !important;
		position: fixed !important;
		top: auto !important;
		bottom: 80px !important; /* ä½æ–¼æ§åˆ¶åˆ—ä¸Šæ–¹ */
		right: 20px !important;
		left: auto !important;
		
		/* å¤–è§€è¨­å®š */
		width: auto !important;
		height: 40px !important;
		background: rgba(44, 62, 80, 0.8);
		border: 1px solid rgba(255,255,255,0.3);
		border-radius: 20px;
		padding: 0 15px;
		
		/* å–æ¶ˆåŸæœ¬çš„å‚ç›´è®Šå½¢ï¼Œæ”¹ç‚ºæ©«å‘ */
		transform: none !important;
		flex-direction: row;
		align-items: center;
		z-index: 5000;
	}

	/* é€²åº¦æ¢æœ¬é«”èª¿æ•´ */
	body.desktop-playing #playback-slider {
		width: 300px !important;
		height: 8px !important;
		transform: none !important; /* å–æ¶ˆæ—‹è½‰ */
		margin: 0 10px;
		cursor: pointer;
	}

	/* é€²åº¦æç¤ºæ–‡å­—ä½ç½®å¾®èª¿ */
	body.desktop-playing #slider-tooltip {
		top: -35px;
		left: 50%;
		transform: translateX(-50%);
		right: auto;
		font-size: 1rem;
		background: rgba(241, 196, 15, 0.9);
		padding: 2px 8px;
		border-radius: 4px;
	}
	
	/* =========================================
   [ä¿®æ­£] æ‰‹æ©Ÿç‰ˆä»‹é¢åŒæ­¥ (Mobile Sync)
   ========================================= */

	/* 1. è®“æ‰‹æ©Ÿç‰ˆçš„ Slider å›åˆ°è·Ÿæ¡Œæ©Ÿç‰ˆä¸€æ¨¡ä¸€æ¨£çš„ä½ç½® (å³å´ã€å‚ç›´ã€ç½®ä¸­) */
	body.mobile-mode #playback-slider-container {
		right: 0px !important;       /* è²¼é½Šå³é‚Š */
		left: auto !important;       /* å–æ¶ˆé å·¦ */
		top: 50% !important;         /* å‚ç›´ç½®ä¸­ */
		bottom: auto !important;
		transform: translateY(-50%) !important; /* ä¿®æ­£åç§» */
		
		flex-direction: column !important; /* ç¢ºä¿æ˜¯ç›´ç«‹æ’åˆ— */
		width: auto !important;
		height: 95vh !important;     /* æ‹‰é•·è§¸æ§å€ */
		background: none !important; /* ç§»é™¤é¡å¤–èƒŒæ™¯ï¼Œä¿æŒä¹¾æ·¨ */
		border: none !important;
	}

	/* ç¢ºä¿ Slider æœ¬é«”æ˜¯ç›´ç«‹çš„ (è·Ÿæ¡Œæ©Ÿä¸€æ¨£) */
	body.mobile-mode #playback-slider {
		width: 90vh !important;
		height: 6px !important;
		transform: rotate(90deg) !important; /* è½‰ç›´ */
		margin: 0 !important;
	}

	/* 2. æ’­æ”¾æ™‚éš±è—ç·¨è¼¯ UI (æ‰‹æ©Ÿèˆ‡æ¡Œæ©Ÿé‚è¼¯ä¸€è‡´) */
	/* ç•¶ body æœ‰ .playing-mode æ™‚ï¼Œéš±è—ç„¡é—œä»‹é¢ */
	body.playing-mode #toolbar,
	body.playing-mode #timeline-panel,
	body.playing-mode #card-action-panel,
	body.playing-mode #draft-bar,
	body.playing-mode #point-bar,
	body.playing-mode .ace-star-mark,
	body.playing-mode .random-pick-btn {
		display: none !important;
	}

	/* 3. ç¢ºä¿æ§åˆ¶æŒ‰éˆ•åœ¨å³ä¸‹è§’é¡¯ç¤º */
	body.playing-mode #mobile-controls,
	body.mobile-mode #mobile-controls {
		display: flex !important;
		z-index: 9999;
	}
	
	/* =========================================
   [ä¿®æ­£] æ¡Œæ©Ÿæ’­æ”¾æ¨¡å¼ (Desktop Playback Mode)
   ========================================= */

	/* 1. æ’­æ”¾æ¨¡å¼ä¸‹ï¼šéš±è—æ¡Œæ©Ÿç‰ˆç·¨è¼¯å™¨ UI */
	/* ç•¶ JS åŠ ä¸Š desktop-playing æ™‚ï¼Œé€™äº›æ±è¥¿æœƒæ¶ˆå¤± */
	body.desktop-playing #toolbar,
	body.desktop-playing #timeline-panel,      /* å³å´æ™‚é–“è»¸ */
	body.desktop-playing #card-action-panel,   /* ä¸‹æ–¹å¡ç‰‡æ“ä½œ */
	body.desktop-playing #draft-bar,
	body.desktop-playing #point-bar,
	body.desktop-playing .ace-star-mark,
	body.desktop-playing .random-pick-btn {
		display: none !important;
	}

	/* 2. æ’­æ”¾æ¨¡å¼ä¸‹ï¼šé¡¯ç¤ºé¡ä¼¼æ‰‹æ©Ÿç‰ˆçš„æ§åˆ¶åˆ— */
	/* é€™åŒ…å«äº†é€²åº¦æ¢èˆ‡åœæ­¢æŒ‰éˆ• */
	body.desktop-playing #mobile-controls {
		display: flex !important;
		position: fixed;
		bottom: 20px;
		right: 20px;
		z-index: 9999;
	}

	/* 3. æ’­æ”¾æ¨¡å¼ä¸‹ï¼šèª¿æ•´ Slider ä½ç½® (æ”¹ç‚ºæ©«å‘åº•éƒ¨ï¼Œé¡ä¼¼æ‰‹æ©Ÿç‰ˆé«”é©—) */
	body.desktop-playing #playback-slider-container {
		display: flex !important;
		position: fixed !important;
		bottom: 80px !important; /* åœ¨æ§åˆ¶åˆ—ä¸Šæ–¹ */
		right: 20px !important;
		left: auto !important;
		top: auto !important;
		
		width: 300px !important;
		height: 40px !important;
		background: rgba(44, 62, 80, 0.8);
		border-radius: 20px;
		border: 1px solid rgba(255,255,255,0.3);
		
		flex-direction: row !important;
		align-items: center !important;
		transform: none !important; /* å–æ¶ˆç›´ç«‹æ—‹è½‰ */
	}

	/* Slider æœ¬é«” */
	body.desktop-playing #playback-slider {
		width: 100% !important;
		height: 6px !important;
		margin: 0 10px;
		transform: none !important;
	}

	/* Tooltip æ–‡å­— */
	body.desktop-playing #slider-tooltip {
		top: -35px !important;
		right: 0 !important;
		left: auto !important;
	}
	
	/* =========================================
       15. DECK CONTEXT MENU & MODAL
       ========================================= */
    #deck-context-menu {
        display: none;
        position: absolute;
        z-index: 10000;
        background: #fff;
        border: 1px solid #bdc3c7;
        box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
        border-radius: 4px;
        min-width: 150px;
        font-family: sans-serif;
        color: #333;
        overflow: hidden;
    }
    #deck-context-menu ul { list-style: none; padding: 0; margin: 0; }
    #deck-context-menu li {
        padding: 10px 15px; cursor: pointer; font-size: 0.9rem;
        border-bottom: 1px solid #f0f0f0; transition: background 0.2s;
    }
    #deck-context-menu li:last-child { border-bottom: none; }
    #deck-context-menu li:hover { background-color: #e8f6fd; color: #2980b9; }

    /* Move Modal Specifics */
    #deck-move-modal .modal-content { width: 320px; text-align: center; }
    .dm-row { margin-bottom: 15px; text-align: left; }
    .dm-row label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.9rem; }
    .dm-row select, .dm-row input { 
        width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; 
        font-size: 1rem; box-sizing: border-box;
    }
    .dm-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
	/* --- å³ä¸Šè§’æ‡¸æµ®é—œé–‰æŒ‰éˆ• --- */
	.zone-close-btn {
		position: absolute;
		top: 30px;
		right: 40px;
		font-size: 50px;       /* å­—é«”åŠ å¤§ */
		font-weight: 100;      /* ç´°å­—é«”çœ‹èµ·ä¾†æ›´æœ‰è³ªæ„Ÿ */
		color: rgba(255, 255, 255, 0.6);
		cursor: pointer;
		z-index: 2100;         /* ç¢ºä¿æ¯” modal-content (2000) é‚„é«˜ */
		line-height: 1;
		transition: all 0.2s;
		user-select: none;     /* é˜²æ­¢è¢«é¸å– */
	}

	.zone-close-btn:hover {
		color: #ff5252;        /* æ‡¸åœè®Šç´… */
		transform: scale(1.1) rotate(90deg); /* æ‡¸åœæ™‚ç¨å¾®æ”¾å¤§ä¸¦æ—‹è½‰ */
		text-shadow: 0 0 10px rgba(255, 82, 82, 0.5);
	}
	
	/* --- New Move Modal UI --- */
	#deck-move-modal .modal-content {
		width: 450px; /* åŠ å¯¬ä¸€é»ä»¥å®¹ç´æŒ‰éˆ• */
		text-align: left;
	}

	/* æ•¸é‡é¸æ“‡å€ */
	.qty-group {
		display: flex;
		gap: 8px;
		margin-bottom: 15px;
		align-items: center;
	}
	.qty-btn {
		flex: 1;
		padding: 8px 0;
		border: 1px solid #bdc3c7;
		background: #f9f9f9;
		border-radius: 4px;
		cursor: pointer;
		font-weight: bold;
		color: #2c3e50;
		transition: all 0.2s;
	}
	.qty-btn:hover { background: #eef2f5; }
	.qty-btn.active {
		background: #3498db;
		color: white;
		border-color: #2980b9;
	}
	#dm-qty {
		width: 60px;
		text-align: center;
		font-weight: bold;
		padding: 8px;
	}

	/* ç›®æ¨™å€åŸŸé¸æ“‡ (ç¶²æ ¼ä½ˆå±€) */
	.dest-grid {
		display: grid;
		grid-template-columns: repeat(2, 1fr); /* å…©åˆ— */
		gap: 10px;
		margin-bottom: 20px;
	}
	.dest-btn {
		padding: 10px;
		border: 1px solid #bdc3c7;
		background: #fff;
		border-radius: 6px;
		cursor: pointer;
		text-align: left;
		display: flex;
		align-items: center;
		transition: all 0.1s;
		font-size: 0.95rem;
	}
	.dest-btn:hover {
		background: #f0f8ff;
		border-color: #3498db;
	}
	.dest-btn.active {
		background: #3498db;
		color: white;
		border-color: #2980b9;
		box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
	}
	.dest-btn i {
		font-style: normal;
		margin-right: 8px;
		font-size: 1.2rem;
		width: 24px;
		text-align: center;
	}
</style>
</head>
<body>

<div id="toolbar">
    <div style="font-weight: 800; font-size: 1.1rem; margin-right: 10px; color: #f1c40f;">DM Editor</div>
    
    <select id="lang-select" onchange="changeLanguage(this.value)">
        <option value="zh">ä¸­æ–‡</option>
        <option value="en">English</option>
        <option value="jp">æ—¥æœ¬èª</option>
    </select>

    <button onclick="openSetupModal()" data-i18n="btn_setup">Setup / Clear</button>
	<button onclick="actionRPS()" style="background:#e67e22; border-color:#d35400;" data-i18n="btn_rps">âœŠâœŒï¸ğŸ–ï¸ çŒœæ‹³ (RPS)</button>
    <button onclick="rotateBoard()" data-i18n="btn_rotate">ğŸ”„ æ›äºº (Switch Turn)</button>
    â†’
    <button onclick="resetCurrentTurnPlayer()" data-i18n="btn_reset_current">é‡ç½®ç•¶å‰ (Untap)</button>
    â†’
	<button onclick="actionDrawCard()" style="background:#2980b9; border-color:#2471a3;" data-i18n="btn_draw">ğŸ´ æŠ½ç‰Œ (Draw)</button>
	<button id="btn-rb-effect" onclick="openRealityBreakEditor()" style="background:#2c3e50; border-color:#fff;" data-i18n="btn_effect">âš¡ Cut In</button>
    <select onchange="handleWinSelect(this)" style="background:#f39c12; border-color:#d35400; color:white; padding:4px 8px; border-radius:4px; font-weight:bold; cursor:pointer; outline:none;">
        <option value="" data-i18n="opt_win_default">ğŸ† å®£å‘Šå‹åˆ©...</option>
        <option value="1" data-i18n="btn_p1_win">ğŸ† 1P Win</option>
        <option value="2" data-i18n="btn_p2_win">ğŸ† 2P Win</option>
    </select>
    <div style="flex:1"></div>
    <div style="flex:1"></div>
	<button id="btn-add-dialogue" onclick="openDialogueModal()" style="background:#8e44ad; border-color:#8e44ad;" data-i18n="btn_dialogue">ğŸ’¬ å°è©± (Dialog)</button>
    <button id="btn-bgm" onclick="openBGMModal()" style="background:#e67e22; border-color:#d35400;" data-i18n="btn_bgm">ğŸµ BGM</button>
	<button onclick="openImportModal()" data-i18n="btn_import">åŒ¯å…¥ (Import)</button>
	<input type="file" id="import-input" style="display:none" onchange="importData(this)">	
    <button onclick="exportData()" data-i18n="btn_export">åŒ¯å‡º (Export)</button>
	<button onclick="document.getElementById('trans-modal').style.display='flex'" style="background:#8e44ad; border-color:#8e44ad;" data-i18n="btn_trans">ğŸŒ ç¿»è­¯ (Trans)</button>
	<button onclick="openAboutModal()" style="background:#7f8c8d; border-color:#616a6b;" data-i18n="btn_about">â„¹ï¸ About</button>
</div>

<div id="point-bar">
    <span data-i18n="lbl_point_mode">ğŸ‘‰ æŒ‡å‘æ¨¡å¼ï¼šè«‹é¸æ“‡ç›®æ¨™ (å¯é¸æ“‡ä»»æ„å¡ç‰‡æˆ–å€åŸŸ)</span>
    <div style="display:flex; gap:10px;">
        <span id="point-target-info" style="font-size:0.8rem; align-self:center;"></span>
        <button id="btn-confirm-point" class="primary" style="display:none;" onclick="confirmPointTargets()" data-i18n="btn_confirm_point">âœ… ç¢ºèªæŒ‡å‘</button>
        <button onclick="cancelPointMode()" class="danger" data-i18n="btn_cancel">å–æ¶ˆ</button>
    </div>
</div>

<div id="move-status-bar" style="display:none;">
    <span style="font-weight:bold;">
        ğŸš€ ç§»å‹•æ¨¡å¼ (å·²é¸ <span id="move-count">0</span> å¼µ)
    </span>
    
    <label class="toggle-switch">
        <input type="checkbox" id="ace-entry-check">
        <span class="slider"></span>
        <span style="margin-left:5px; font-weight:bold; color:#f1c40f;">ç‹ç‰Œç™»å ´ (Ace Entry)</span>
    </label>

    <button onclick="cancelSelection()" class="danger">å–æ¶ˆ (Cancel)</button>
</div>

<div id="workspace">

	<svg id="svg-layer">
        <defs>
            <marker id="arrowhead" markerWidth="12" markerHeight="12" refX="10" refY="6" orient="auto" markerUnits="userSpaceOnUse">
                <path d="M0,0 L12,6 L0,12" fill="#e74c3c" />
            </marker>
        </defs>
    </svg>
	
    <div id="ability-stack-zone">
        <div id="ability-zone-p2" class="ability-column">
            <div class="ability-label" data-i18n="zone_ability">P2 èƒ½åŠ› (å¾…è™•ç†)</div>
        </div>
        <div id="ability-zone-p1" class="ability-column">
            <div class="ability-label" data-i18n="zone_ability">P1 èƒ½åŠ› (å¾…è™•ç†)</div>
        </div>
    </div>
	
	<div id="dialogue-layer">
        <div id="diag-row-p2" class="diag-row top">
            <div class="diag-box">
                <div class="diag-name" id="diag-name-p2">P2</div>
                <div class="diag-text text-m" id="diag-text-p2">...</div>
            </div>
            <div class="diag-portrait" id="diag-img-p2"></div>
        </div>
        <div id="diag-row-p1" class="diag-row bottom">
            <div class="diag-portrait" id="diag-img-p1"></div>
            <div class="diag-box">
                <div class="diag-name" id="diag-name-p1">P1</div>
                <div class="diag-text text-m" id="diag-text-p1">...</div>
            </div>
        </div>
    </div>

    <div id="game-board-container">
        <div id="main-board">
            
            <div id="reveal-zone" class="zone" data-zone="reveal-zone">
                <span class="zone-label">å±•ç¤ºå€ (Reveal Zone)</span>
                <button class="mini-btn danger" style="position:absolute; top:5px; right:5px;" onclick="closeRevealZone()">âœ•</button>
            </div>

            <div id="player2-area" class="player-area">
                <div class="turn-bar" onclick="openThemePicker(2)" title="é»æ“Šæ›´æ› P2 ä»£è¡¨è‰²"></div>
                
                <div class="battle-zone zone" data-zone="p2-battle" onclick="handleZoneClick('p2-battle')"><span class="zone-label" data-i18n="zone_battle">P2 æˆ°é¬¥å ´</span></div>
                
                <div class="middle-row">
                    <div class="shield-zone zone" data-zone="p2-shield" onclick="handleZoneClick('p2-shield')"><span class="zone-label" data-i18n="zone_shield">P2 è­·ç›¾å€</span></div>
                    <div class="mana-zone zone" data-zone="p2-mana" onclick="handleZoneClick('p2-mana')"><span class="zone-label" data-i18n="zone_mana">P2 é­”åŠ›å€</span></div>
                </div>

                <div class="bottom-row">
                    <div class="hand-zone zone" data-zone="p2-hand" onclick="handleZoneClick('p2-hand')">
						<span class="zone-label" data-i18n="zone_hand">P2 æ‰‹ç‰Œ</span>
						<button class="unseen-check-btn" onclick="event.stopPropagation(); toggleUnseenHighlight()" data-i18n="btn_check_unseen" title="Check Unseen Cards">ğŸ‘ï¸â€ğŸ—¨ï¸ æœªè¦‹</button>
						<button class="random-pick-btn" onclick="event.stopPropagation(); randomPickHand('p2-hand')" data-i18n="btn_random_pick" title="Random Select">ğŸ² éš¨æ©Ÿ</button>
					</div>
                    <div class="side-zone-group">
                        <div class="hyper-zone zone stacked" data-zone="p2-hyper" onclick="handleZoneClick('p2-hyper')"><span class="zone-label" data-i18n="zone_hyper">è¶…æ¬¡å…ƒ</span></div>
                        <div <div class="deck-zone zone stacked" data-zone="p2-deck" onclick="handleZoneClick('p2-deck')" 
							 oncontextmenu="showDeckContextMenu(event, 'p2-deck')">
							<span class="zone-label" data-i18n="zone_deck">ç‰Œåº«</span>
						</div>
                        <div class="grave-zone zone stacked" data-zone="p2-grave" onclick="handleZoneClick('p2-grave')"><span class="zone-label" data-i18n="zone_grave">å¢“åœ°</span></div>
						<div class="abyss-zone zone stacked" data-zone="p2-abyss" onclick="handleZoneClick('p2-abyss')">
							<span class="zone-label" data-i18n="zone_abyss">æ·±æ·µ</span>
						</div>
					</div>
                </div>
            </div>

            <div id="player1-area" class="player-area">
                <div class="turn-bar" onclick="openThemePicker(1)" title="é»æ“Šæ›´æ› P1 ä»£è¡¨è‰²"></div>
                
                <div class="battle-zone zone" data-zone="p1-battle" onclick="handleZoneClick('p1-battle')"><span class="zone-label" data-i18n="zone_battle">P1 æˆ°é¬¥å ´</span></div>
                
                <div class="middle-row">
                    <div class="shield-zone zone" data-zone="p1-shield" onclick="handleZoneClick('p1-shield')"><span class="zone-label" data-i18n="zone_shield">P1 è­·ç›¾å€</span></div>
                    <div class="mana-zone zone" data-zone="p1-mana" onclick="handleZoneClick('p1-mana')"><span class="zone-label" data-i18n="zone_mana">P1 é­”åŠ›å€</span></div>
                </div>

                <div class="bottom-row">
                    <div class="hand-zone zone" data-zone="p1-hand" onclick="handleZoneClick('p1-hand')">
						<span class="zone-label" data-i18n="zone_hand">P1 æ‰‹ç‰Œ</span>
						<button class="unseen-check-btn" onclick="event.stopPropagation(); toggleUnseenHighlight()" data-i18n="btn_check_unseen" title="Check Unseen Cards">ğŸ‘ï¸â€ğŸ—¨ï¸ æœªè¦‹</button>
						<button class="random-pick-btn" onclick="event.stopPropagation(); randomPickHand('p1-hand')" data-i18n="btn_random_pick" title="Random Select">ğŸ² éš¨æ©Ÿ</button>
					</div>
                    <div class="side-zone-group">
                        <div class="hyper-zone zone stacked" data-zone="p1-hyper" onclick="handleZoneClick('p1-hyper')"><span class="zone-label" data-i18n="zone_hyper">è¶…æ¬¡å…ƒ</span></div>
                        <div class="deck-zone zone stacked" data-zone="p1-deck" onclick="handleZoneClick('p1-deck')" 
							 oncontextmenu="showDeckContextMenu(event, 'p1-deck')">
							<span class="zone-label" data-i18n="zone_deck">ç‰Œåº«</span>
						</div>
						<div class="grave-zone zone stacked" data-zone="p1-grave" onclick="handleZoneClick('p1-grave')"><span class="zone-label" data-i18n="zone_grave">å¢“åœ°</span></div>
						<div class="abyss-zone zone stacked" data-zone="p1-abyss" onclick="handleZoneClick('p1-abyss')">
							<span class="zone-label" data-i18n="zone_abyss">æ·±æ·µ</span>
						</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

	<div id="slider-zone">
        <div id="slider-tooltip">0/0</div>
        <input type="range" id="playback-slider" min="0" max="0" value="0" step="1" 
               oninput="handleSliderDragging(this.value)" 
               onchange="handleSliderRelease(this.value)">
    </div>
	
    <div id="timeline-panel">
        <div id="timeline-header">
			<span style="flex:1;" data-i18n="lbl_action_log">Action Log</span>
			<small style="font-weight:normal; opacity:0.8; margin-right:5px;" id="step-counter">0/0</small>
		</div>
		<div id="draft-bar">
			<div class="row-info" id="draft-status-text">
				Loading...
			</div>
			
			<div class="row-controls">
				<label title="é–‹å•Ÿæ­¤é¸é …å¾Œï¼Œæœ¬æ¬¡ç·¨è¼¯çš„çµæœå°‡æœƒå½±éŸ¿å¾ŒçºŒæ‰€æœ‰æ­¥é©Ÿçš„ç‹€æ…‹" style="cursor: pointer; user-select: none;">
					<input type="checkbox" id="propagate-check" checked style="margin-right: 4px;"> 
					<span data-i18n="chk_propagate">ğŸ”— é€£å‹•å¾ŒçºŒ</span>
				</label>
				<div style="display:flex; gap:6px;">
					<button onclick="saveDraft()" class="primary" data-i18n="btn_save_step">ğŸ’¾ å­˜æª”</button>
					<button onclick="cancelDraft()" class="danger" data-i18n="btn_cancel">å–æ¶ˆ</button>
				</div>
			</div>
		</div>
        <ul id="action-list"></ul>
        <div style="padding: 10px; background: #ecf0f1; border-top:1px solid #bdc3c7;">
            <div style="display: flex; gap:5px; justify-content: center; margin-bottom: 5px;">
                <button onclick="prevStep()">â–²</button>
                <button onclick="togglePlay(true)" id="btn-play">â–¶</button>
				<button onclick="stopPlayback(true)" id="btn-stop">â¹</button>
                <button onclick="nextStep()">â–¼</button>
				<select id="speed-select" onchange="changePlaybackSpeed(this.value)" style="padding:2px; border-radius:4px; border:1px solid #ccc; background:#fff; font-size:0.85rem; cursor:pointer;">
					<option value="4.0">ğŸš€ 0.25x</option>
					<option value="2.0">ğŸ¢ 0.5x</option>
					<option value="1.33">ğŸš¶ 0.75x</option>
					<option value="1.0" selected>â–¶ 1.0x</option>
					<option value="0.66">ğŸƒ 1.5x</option>
					<option value="0.5">ğŸ‡ 2.0x</option>
					<option value="0.25">âš¡ 4.0x</option>
				</select>
            </div>
        </div>
    </div>
</div>

<div id="card-action-panel">
    
    <div class="panel-row">
        <button id="btn-paste" onclick="pasteImageMode()" data-i18n="act_paste">ğŸ–¼ï¸ ä¸Šåœ– (Ctrl+V)</button>
        <button id="btn-remove-image" style="display:none; background:#e74c3c;" onclick="removeImage()" data-i18n="btn_remove_img_short">âœ• åœ–</button>
        
        <div class="panel-sep"></div>
        
        <input type="text" id="rename-input" placeholder="åç¨±..." onkeydown="if(event.key==='Enter') renameCard()" style="width: 80px;" data-i18n-ph="ph_rename">
        <button onclick="renameCard()" data-i18n="act_rename">æ›´å</button>
        <input type="text" id="note-input" placeholder="è¨»è¨˜..." onkeydown="if(event.key==='Enter') addCardNote()" style="width: 80px;" data-i18n-ph="ph_note">
        <button onclick="addCardNote()" data-i18n="act_note">ğŸ“è¨»è¨˜</button>
        
        <div class="panel-sep"></div>

        <button id="btn-ace" onclick="toggleAceFromPanel()" data-i18n="act_ace">ğŸ‘‘ ç‹ç‰Œ</button>
        
        <button id="btn-delete-card" class="danger" style="display:none; margin-left:5px;" onclick="deleteSelectedCard()" data-i18n="act_delete">ğŸ—‘ï¸ åˆªé™¤</button>
    </div>

    <div class="panel-row">
        <button id="btn-rotate-l" onclick="rotateCard(-90)">â†¶</button>
        <button id="btn-rotate-r" onclick="rotateCard(90)">â†·</button>
        <button id="btn-flip" onclick="flipCard()" data-i18n="act_flip">ç¿»é¢</button>
        
        <button id="btn-moonless" onclick="toggleMoonless()" data-i18n="act_moonless">ğŸŒ‘ ç„¡æœˆä¹‹é–€</button>

        <div class="panel-sep"></div>

        <button id="btn-injured" style="display:none; background:#e74c3c; border-color:#c0392b;" onclick="toggleInjured()" data-i18n="act_injured">ğŸ’” å—å‚·</button>
        <button id="btn-clear-injured" style="display:none; background:#27ae60; border-color:#2ecc71;" onclick="clearInjured()" data-i18n="act_clear_injured">â¤ï¸ æ²»ç™’</button>
        
        <button id="btn-glow" onclick="toggleGlow()" data-i18n="act_glow">ğŸ’¡ç™¼å…‰</button>
        <button id="btn-glow-bottom" onclick="toggleBottomGlow()" style="background:#5dade2; border-color:#3498db;" data-i18n="act_glow_bottom">ğŸ‘‡åº•å…‰</button>
		<button id="btn-ex-life" style="display:none; background:#34495e; border-color:#fff;" onclick="enterExLifeMode()">ğŸ›¡ï¸ EX-Life</button>
        <button id="btn-unglow" style="display:none;" onclick="removeGlow()">âœ•</button>

        <div class="panel-sep"></div>

        <button id="btn-copy-ability" onclick="copyToAbility(false)" data-i18n="act_ability">âš¡å–®æ¬¡</button>
        <button id="btn-copy-continuous" onclick="copyToAbility(true)" style="background:#9b59b6; border-color:#8e44ad;" data-i18n="act_continuous">âˆ æŒçºŒ</button>
        
        <div id="ability-adjust-controls" style="display:none; width:1px;"></div>
        <div id="ability-adjust-buttons" style="display:none; gap:2px; align-items:center;">
            <button onclick="adjustAbilityCard('panX', -10)">â¬…</button>
            <button onclick="adjustAbilityCard('panX', 10)">â¡</button>
            <button onclick="adjustAbilityCard('panY', -10)">â¬†</button>
            <button onclick="adjustAbilityCard('panY', 10)">â¬‡</button>
            <button onclick="adjustAbilityCard('scale', 0.1)">+</button>
            <button onclick="adjustAbilityCard('scale', -0.1)">-</button>
        </div>

        <div class="panel-sep"></div>

        <button id="btn-reveal" onclick="revealCards()" data-i18n="act_reveal">ğŸ‘ï¸ å±•ç¤º</button>
        <button id="btn-point" style="display:none; background:#8e44ad; border-color:#9b59b6;" onclick="enterPointMode()" data-i18n="act_point">ğŸ‘‰ æŒ‡å‘</button>
        <button id="btn-end-point" style="display:none; background:#95a5a6; border-color:#7f8c8d;" onclick="endPoint()" data-i18n="act_end_point">ğŸ›‘ çµæŸæŒ‡å‘</button>
        
        <button id="btn-panel-close" class="danger" style="margin-left:5px;" onclick="cancelSelection()">âœ•</button>
    </div>
</div>

<div id="multi-select-bar" style="display:none; position:fixed; bottom:80px; left:50%; transform:translateX(-50%); background:rgba(44, 62, 80, 0.9); padding:10px 20px; border-radius:30px; color:white; font-weight:bold; z-index:2000; box-shadow:0 4px 15px rgba(0,0,0,0.3); align-items:center; gap:10px;">
    <span>ğŸ“š å¤šé¸æ¨¡å¼: <span id="multi-count-val">0</span> å¼µ</span>
    <span style="font-size:0.8rem; opacity:0.8;">(é»æ“Šå€åŸŸç§»å‹• / ESCå–æ¶ˆ)</span>
    <button onclick="cancelSelection()" style="background:#c0392b; border:none; padding:2px 8px; border-radius:10px; font-size:0.8rem; cursor:pointer;">âœ•</button>
</div>
<div id="theme-picker-modal" class="modal">
    <div class="modal-content">
        <h3 id="theme-picker-title" style="margin-top:0; text-align:center;">é¸æ“‡ä¸»é¡Œè‰²</h3>
        <p style="font-size:0.85rem; color:#666; text-align:center;" data-i18n="msg_theme_opponent">å°æ‰‹å·²ä½¿ç”¨çš„é¡è‰²ç„¡æ³•é¸æ“‡ã€‚</p>
        
        <div class="color-grid" id="theme-color-grid">
            </div>

        <div style="text-align:right;">
            <button class="danger" onclick="closeThemePicker()" data-i18n="btn_cancel">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<div id="setup-modal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; text-align:center;" data-i18n="title_setup">é–‹å±€è¨­å®š</h3>
        <div style="background:#fff3cd; padding:5px; margin-bottom:10px; font-size:0.85rem; border-radius:4px; text-align:center;" data-i18n="msg_setup_warn">
            æ³¨æ„ï¼šé–‹å§‹æ–°å±€æœƒæ¸…é™¤ç•¶å‰æœªåŒ¯å‡ºçš„é€²åº¦ã€‚
        </div>
        <div class="input-group">
            <label data-i18n="lbl_p1_deck">P1 ç‰Œåº«æ•¸:</label>
            <input type="number" id="setup-p1-deck" value="40" min="40" max="60">
        </div>
        <div class="input-group">
            <label>P1 è¶…æ¬¡å…ƒ:</label>
            <input type="number" id="setup-p1-hyper" value="0" min="0" max="8">
        </div>
        <hr style="width:100%; border:0; border-top:1px dashed #ccc;">
        <div class="input-group">
            <label data-i18n="lbl_p2_deck">P2 ç‰Œåº«æ•¸:</label>
            <input type="number" id="setup-p2-deck" value="40" min="40" max="60">
        </div>
        <div class="input-group">
            <label>P2 è¶…æ¬¡å…ƒ:</label>
            <input type="number" id="setup-p2-hyper" value="0" min="0" max="8">
        </div>
        <div style="margin-top:20px; display:flex; justify-content:space-between;">
            <button onclick="clearStorage()" style="background:#7f8c8d;" data-i18n="btn_clear_storage">æ¸…é™¤å­˜æª”</button>
            <button onclick="finishSetup()" class="primary" data-i18n="btn_start_game">é–‹å§‹éŠæˆ² (Start)</button>
        </div>
    </div>
</div>

<div id="card-selector-modal" class="modal">
	<div class="zone-close-btn" onclick="closeSelectorModal()" title="Close (ESC)">âœ•</div>
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <span id="modal-title" style="font-weight:bold; font-size:1.2rem;">Zone</span>
            <button onclick="closeSelectorModal()" style="border:none; background:none; font-size:1.5rem;">âœ•</button>
        </div>
        <div id="modal-body"></div>
        <div style="margin-top:15px; display:flex; gap:10px; justify-content:flex-end;">
			<button onclick="actionShuffleZone()" style="background:#8e44ad;" data-i18n="btn_shuffle_zone">æ´—ç‰Œæ­¤å€</button>
			<button onclick="prepareMove(true)" style="background:#d35400;" data-i18n="btn_shuffle_move">æ´—ç‰Œé¸å–ç‰Œä¸¦ç§»å‹•...</button>
			<button onclick="revealFromSelector()" style="background:#3498db;" data-i18n="btn_reveal_sel">ğŸ‘ï¸ å±•ç¤º</button>
			<button onclick="prepareMove(false)" style="background:#2980b9;" data-i18n="btn_move_sel">ç§»å‹•é¸å–ç‰Œ...</button>
		</div>
    </div>
</div>

<div id="position-selector-modal" class="modal">
    <div class="modal-content">
        <div id="pos-modal-title" style="font-weight:bold; font-size:1.2rem; margin-bottom:10px;" data-i18n="title_stack">å †ç–Šæ“ä½œ</div>
        <div style="margin-bottom:10px; font-size:0.9rem; color:#666;" data-i18n="lbl_stack_hint">è«‹é»æ“Šåœ–ç¤ºé¸æ“‡å †ç–Šæ–¹å¼ï¼š</div>
        
        <div id="stack-gui">
            <div class="stack-option" onclick="confirmStackMove('top')">
                <div class="stack-icon icon-top"><div class="child"></div></div>
                <span data-i18n="opt_stack_top">ç–Šåœ¨ä¸Šæ–¹</span>
            </div>
            <div class="stack-option" onclick="confirmStackMove('bottom')">
                <div class="stack-icon icon-bottom"><div class="child"></div></div>
                <span data-i18n="opt_stack_btm">ç–Šåœ¨ä¸‹æ–¹</span>
            </div>
            <div class="stack-option" onclick="confirmStackMove('puzzle_top')">
                <div class="stack-icon icon-p-top"><div class="child"></div></div>
                <span data-i18n="opt_puz_top">æ‹¼åœ¨ä¸Šæ–¹</span>
            </div>
            <div class="stack-option" onclick="confirmStackMove('puzzle_bottom')">
                <div class="stack-icon icon-p-bottom"><div class="child"></div></div>
                <span data-i18n="opt_puz_btm">æ‹¼åœ¨ä¸‹æ–¹</span>
            </div>
             <div class="stack-option" onclick="confirmStackMove('puzzle_left')">
                <div class="stack-icon icon-p-left"><div class="child"></div></div>
                <span data-i18n="opt_puz_left">æ‹¼åœ¨å·¦é‚Š</span>
            </div>
             <div class="stack-option" onclick="confirmStackMove('puzzle_right')">
                <div class="stack-icon icon-p-right"><div class="child"></div></div>
                <span data-i18n="opt_puz_right">æ‹¼åœ¨å³é‚Š</span>
            </div>
            
            <div class="stack-option" onclick="confirmStackMove('shift_up')">
                <div class="stack-icon icon-up"><div class="child"></div></div>
                <span data-i18n="opt_shift_up">ä¸Šæ–¹ (éœ²å‡ºåº•)</span>
            </div>
            <div class="stack-option" onclick="confirmStackMove('shift_down')">
                <div class="stack-icon icon-down"><div class="child"></div></div>
                <span data-i18n="opt_shift_down">ä¸Šæ–¹ (éœ²å‡ºé ‚)</span>
            </div>
            <div class="stack-option" onclick="confirmStackMove('bottom_exposed')">
                <div class="stack-icon icon-bottom-exp"><div class="child"></div></div>
                <span data-i18n="opt_btm_exp">ä¸‹æ–¹ (éœ²å‡ºåº•)</span>
            </div>
        </div>
        <div id="position-list" style="display:none;"></div> 
        <div style="margin-top:15px; text-align:right;">
            <button onclick="closePositionModal()" class="danger">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="import-conflict-modal" class="modal">
    <div class="modal-content" style="width: 400px; text-align: center;">
        <h3 data-i18n="title_import_conflict">ç™¼ç¾å¤–éƒ¨åŠ‡æœ¬</h3>
        <p data-i18n="msg_import_conflict">ç¶²å€åƒæ•¸åŒ…å«åŠ‡æœ¬æª”ï¼Œä½†åµæ¸¬åˆ°æ‚¨æœ‰æœªå„²å­˜çš„æœ¬åœ°é€²åº¦ã€‚</p>
        <p>è«‹å•è¦å¦‚ä½•è™•ç†ï¼Ÿ</p>
        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
            <button onclick="resolveImportConflict('cancel')" style="padding: 10px;" data-i18n="btn_conflict_cancel">âŒ ä¸åŒ¯å…¥ (ä½¿ç”¨æœ¬åœ°å­˜æª”)</button>
            <button onclick="resolveImportConflict('save')" style="padding: 10px; background: #2ecc71;" data-i18n="btn_conflict_save">ğŸ’¾ å­˜æª”ç„¶å¾ŒåŒ¯å…¥</button>
            <button onclick="resolveImportConflict('overwrite')" style="padding: 10px; background: #e74c3c;" data-i18n="btn_conflict_overwrite">âš ï¸ ä¸å­˜æª”ç›´æ¥åŒ¯å…¥</button>
        </div>
    </div>
</div>

<div id="mobile-controls">
    <select id="mob-speed-select" onchange="changePlaybackSpeed(this.value)">
        <option value="4.0">ğŸ¢ 0.25x</option>
        <option value="2.0">ğŸ‡ 0.5x</option>
        <option value="1.33">ğŸš¶ 0.75x</option>
        <option value="1.0" selected>â–¶ 1.0x</option>
        <option value="0.66">ğŸƒ 1.5x</option>
        <option value="0.5">ğŸš€ 2.0x</option>
        <option value="0.25">âš¡ 4.0x</option>
    </select>
	<button class="mobile-btn" id="mob-mute-btn" onclick="toggleMute()" style="margin-left: 5px; margin-right: 5px;">ğŸ”Š</button>
    <button class="mobile-btn" id="mob-stop-btn" onclick="stopPlayback(true)" style="margin-right:5px;">â¹</button>
    <button class="mobile-btn" id="mob-play-btn" onclick="togglePlay()">â–¶</button>
</div>

<div id="orientation-overlay">
    <div class="icon">ğŸ“±</div>
    
    <h2 style="margin: 10px 0 5px;">è«‹æ—‹è½‰è¢å¹•</h2>
    <p style="margin: 0 0 5px; font-size: 0.9rem; opacity: 0.8;">ç‚ºäº†æœ€ä½³è§€çœ‹é«”é©—ï¼Œè«‹å°‡æ‰‹æ©Ÿè½‰ç‚ºæ©«å‘ã€‚</p>
    <p style="margin: 0 0 15px; font-size: 0.85rem; color: #f1c40f; font-weight: bold;">âš ï¸ è¡Œå‹•è£ç½®åªæä¾›æ’­æ”¾ï¼Œç·¨è¼¯è«‹ä½¿ç”¨å€‹äººé›»è…¦é–‹å•Ÿã€‚</p>
    
    <h2 style="margin: 10px 0 5px; font-size: 1.3rem;">Please Rotate Screen</h2>
    <p style="margin: 0 0 5px; font-size: 0.9rem; opacity: 0.8;">For the best experience, please use landscape mode.</p>
    <p style="margin: 0 0 15px; font-size: 0.85rem; color: #f1c40f; font-weight: bold;">âš ï¸ Mobile is for playback only. Please use PC for editing.</p>
    
    <h2 style="margin: 10px 0 5px; font-size: 1.3rem;">ç”»é¢ã‚’å›è»¢ã—ã¦ãã ã•ã„</h2>
    <p style="margin: 0 0 5px; font-size: 0.9rem; opacity: 0.8;">æœ€é©ãªè¡¨ç¤ºã®ãŸã‚ã«ã€ç«¯æœ«ã‚’æ¨ªå‘ãã«ã—ã¦ãã ã•ã„ã€‚</p>
    <p style="margin: 0; font-size: 0.85rem; color: #f1c40f; font-weight: bold;">âš ï¸ ãƒ¢ãƒã‚¤ãƒ«ã¯å†ç”Ÿå°‚ç”¨ã§ã™ã€‚ç·¨é›†ã¯PCã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚</p>
</div>
<!--
ã€Œé€™æ˜¯ä¸€å€‹éŠæˆ²åŠ‡æœ¬çš„å°è©±æª” (JSON)ã€‚è«‹å¹«æˆ‘å°‡å…¶ä¸­çš„ text (å°è©) å’Œ name (åå­—) ç¿»è­¯æˆ [ç›®æ¨™èªè¨€ï¼Œä¾‹å¦‚ï¼šè‹±æ–‡]ã€‚

é‡è¦è¦å‰‡ï¼š

åš´æ ¼ä¿æŒ JSON æ ¼å¼ï¼Œä¸è¦æ›´æ”¹ idã€‚

åªç¿»è­¯ name å’Œ text çš„å€¼ï¼Œä¸è¦å‹• nullã€‚

ç›´æ¥çµ¦æˆ‘ä¿®æ”¹å¾Œçš„ JSON ç¨‹å¼ç¢¼ï¼Œä¸éœ€è¦å…¶ä»–è§£é‡‹ã€‚ã€
-->
<div id="trans-modal" class="modal">
    <div class="modal-content" style="width: 400px; text-align: center;">
        <h3 style="margin-top:0;"data-i18n="title_trans">ğŸŒ ç¿»è­¯å°å¹«æ‰‹ (Translation Tool)</h3>
        <p style="color:#666; font-size:0.9rem; text-align:left;" data-i18n="msg_trans_desc">
            æ­¤åŠŸèƒ½å¯å°‡åŠ‡æœ¬ä¸­çš„å°è©±æå–ç‚ºè¼•é‡ç´š JSON æª”ï¼Œæ–¹ä¾¿äº¤çµ¦ AI ç¿»è­¯ï¼Œå®Œæˆå¾Œå†åŒ¯å…¥è¦†è“‹ã€‚
        </p>
        
        <div style="margin: 20px 0; display: flex; flex-direction: column; gap: 10px;">
            <button onclick="exportDialogueJson()" style="background:#2980b9; padding: 10px;" data-i18n="btn_trans_export">
                ğŸ“¤ 1. åŒ¯å‡ºå°ç™½æª” (.json)
            </button>
            <div style="font-size:0.8rem; color:#888;" data-i18n="msg_trans_hint">
                (è«‹å°‡æ­¤æª”æ¡ˆå…§å®¹è²¼çµ¦ AIï¼Œä¸¦è¦æ±‚å®ƒåªç¿»è­¯å€¼ï¼Œä¿æŒæ ¼å¼ä¸è®Š)
            </div>
        </div>

        <div style="margin: 20px 0; display: flex; flex-direction: column; gap: 10px; border-top: 1px dashed #ccc; padding-top: 20px;">
            <button onclick="document.getElementById('trans-input').click()" style="background:#27ae60; padding: 10px;" data-i18n="btn_trans_import">
                ğŸ“¥ 2. åŒ¯å…¥ç¿»è­¯æª” (.json)
            </button>
            <input type="file" id="trans-input" style="display:none" accept=".json" onchange="importDialogueJson(this)">
        </div>

        <div style="text-align: right; margin-top: 10px;">
            <button class="danger" onclick="document.getElementById('trans-modal').style.display='none'"data-i18n="btn_close">é—œé–‰ (Close)</button>
        </div>
    </div>
</div>
<div id="bgm-modal" class="modal">
    <div class="modal-content" style="width: 400px;">
        <h3 style="margin-top:0; text-align:center;"data-i18n="title_bgm">ğŸµ è¨­å®šèƒŒæ™¯éŸ³æ¨‚ (BGM)</h3>
        <p style="font-size:0.8rem; color:#666; text-align:center;" data-i18n="msg_bgm_hint">é»æ“Šåˆ—è¡¨å¯è©¦è½ï¼ŒæŒ‰ä¸‹ç¢ºèªå¾Œç”Ÿæ•ˆã€‚</p>
        
        <div id="bgm-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
            </div>

        <div style="margin-top:15px; display:flex; justify-content:space-between;">
            <button class="danger" onclick="closeBGMModal()"data-i18n="btn_cancel">å–æ¶ˆ (Cancel)</button>
            <button class="primary" onclick="confirmBGM()" data-i18n="btn_confirm">ğŸ’¾ ç¢ºèª (Confirm)</button>
        </div>
    </div>
</div>
<div id="about-modal" class="modal">
    <div class="modal-content" style="width: 350px; text-align: center;">
        <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;" data-i18n="title_credits">Credits</h3>
        
        <div style="text-align: left; font-size: 0.9rem; line-height: 1.6; padding: 10px;">
            <div style="margin-bottom: 12px;">
                <div style="font-weight:bold; color:#2c3e50;">Project Lead & Design</div>
                <div>Ether (<a href="mailto:tairandodx@msn.com" style="color:#3498db; text-decoration:none;">tairandodx@msn.com</a>)</div>
            </div>
            
            <div style="margin-bottom: 12px;">
                <div style="font-weight:bold; color:#2c3e50;">Coding & Implementation</div>
                <div>Google Gemini Pro (v1.5 / v2.0 Flash)</div>
            </div>
            
            <div style="margin-bottom: 12px;">
                <div style="font-weight:bold; color:#2c3e50;">Music / BGM Assets</div>
                <div>é­”ç‹é­‚ (<a href="https://maou.audio" target="_blank" style="color:#e67e22; text-decoration:none;">maou.audio</a>)</div>
            </div>
        </div>

        <div style="margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
            <button class="primary" onclick="document.getElementById('about-modal').style.display='none'" data-i18n="btn_close">Close</button>
        </div>
    </div>
</div>
<div id="dialogue-modal" class="modal">
    <div class="modal-content" style="width: 700px; max-width:95vw;">
        <h3 style="margin-top:0; text-align:center;" data-i18n="title_dialogue_insert">æ’å…¥åŠ‡æƒ…å°è©± (Action)</h3>
        <p style="font-size:0.8rem; color:#666; text-align:center;" data-i18n="lbl_diag_replace_hint">
            é»æ“Šè¡¨æƒ…åœ–ç¤ºå¾Œï¼ŒæŒ‰ä¸‹[Ctrl+V]å¯æ›¿æ›è©²è¡¨æƒ…åœ–ç‰‡ (å…¨åŸŸç”Ÿæ•ˆ)ã€‚
        </p>
		<div style="text-align:center; margin-bottom:15px; padding-bottom:10px; border-bottom:1px dashed #ccc;">
            <button onclick="swapAndFlipAllPortraits()" style="background:#e67e22; border-color:#d35400; font-weight:bold;" data-i18n="btn_swap_flip">
                ğŸ” P1/P2 åœ–ç‰‡äº¤æ› & æ°´å¹³ç¿»è½‰
            </button>
            <div style="font-size:0.75rem; color:#888; margin-top:5px;" data-i18n="lbl_swap_flip_hint">
                * å°‡ P1 èˆ‡ P2 çš„æ‰€æœ‰è¡¨æƒ…åœ–ç‰‡äº’æ›ï¼Œä¸¦è‡ªå‹•é€²è¡Œæ°´å¹³ç¿»è½‰ (é è¨­åœ–é™¤å¤–)
            </div>
        </div>

        <div class="diag-editor-row" style="border-left: 5px solid var(--p2-main);">
            <div class="diag-editor-col" style="flex:0 0 100px; align-items:center; justify-content:center;">
                <label><input type="checkbox" id="edit-p2-active" onchange="toggleDiagEdit('p2')"> <span data-i18n="lbl_enable_p2">å•Ÿç”¨ P2</span></label>
                <div style="font-weight:bold; color:var(--p2-main);" data-i18n="lbl_p2_desc">(ä¸Šæ–¹/æ•µæ–¹)</div>
            </div>
            <div class="diag-editor-col">
                <input type="text" id="edit-p2-name" placeholder="Name..." data-i18n-ph="ph_name" value="Rival">
                <textarea id="edit-p2-text" rows="2" placeholder="Text..." data-i18n-ph="ph_text"></textarea>
                <div style="display:flex; gap:5px;">
                    <select id="edit-p2-size">
                        <option value="s" data-i18n="opt_size_s">å°å­—</option>
                        <option value="m" selected data-i18n="opt_size_m">ä¸­å­—</option>
                        <option value="l" data-i18n="opt_size_l">å¤§å­—</option>
                    </select>
                    <select id="edit-p2-effect">
                        <option value="direct" data-i18n="opt_effect_direct">ç›´æ¥é¡¯ç¤º</option>
                        <option value="fade" data-i18n="opt_effect_fade">æ·¡å…¥</option>
                        <option value="slide" selected data-i18n="opt_effect_slide">æ»‘å…¥</option>
                    </select>
                    <span style="font-size:0.8rem; margin:0 3px;">â¡</span>
                    <select id="edit-p2-exit">
                        <option value="direct" data-i18n="opt_exit_direct">ç›´æ¥æ¶ˆå¤±</option>
                        <option value="fade" data-i18n="opt_exit_fade">æ·¡å‡º</option>
                        <option value="slide" data-i18n="opt_exit_slide">æŠ½å‡º</option>
                    </select>
                </div>
            </div>
            <div class="diag-editor-col" style="flex:0 0 200px;">
                <div class="emotion-grid" id="emotion-grid-p2"></div>
                <input type="hidden" id="edit-p2-emotion" value="normal">
            </div>
        </div>

        <div class="diag-editor-row" style="border-left: 5px solid var(--p1-main);">
            <div class="diag-editor-col" style="flex:0 0 100px; align-items:center; justify-content:center;">
                <label><input type="checkbox" id="edit-p1-active" checked onchange="toggleDiagEdit('p1')"> <span data-i18n="lbl_enable_p1">å•Ÿç”¨ P1</span></label>
                <div style="font-weight:bold; color:var(--p1-main);" data-i18n="lbl_p1_desc">(ä¸‹æ–¹/æˆ‘æ–¹)</div>
            </div>
            <div class="diag-editor-col">
                <input type="text" id="edit-p1-name" placeholder="Name..." data-i18n-ph="ph_name" value="Player">
                <textarea id="edit-p1-text" rows="2" placeholder="Text..." data-i18n-ph="ph_text"></textarea>
                <div style="display:flex; gap:5px;">
                    <select id="edit-p1-size">
                        <option value="s" data-i18n="opt_size_s">å°å­—</option>
                        <option value="m" selected data-i18n="opt_size_m">ä¸­å­—</option>
                        <option value="l" data-i18n="opt_size_l">å¤§å­—</option>
                    </select>
                    <select id="edit-p1-effect">
                        <option value="direct" data-i18n="opt_effect_direct">ç›´æ¥é¡¯ç¤º</option>
                        <option value="fade" data-i18n="opt_effect_fade">æ·¡å…¥</option>
                        <option value="slide" selected data-i18n="opt_effect_slide">æ»‘å…¥</option>
                    </select>
                    <span style="font-size:0.8rem; margin:0 3px;">â¡</span>
                    <select id="edit-p1-exit">
                        <option value="direct" data-i18n="opt_exit_direct">ç›´æ¥æ¶ˆå¤±</option>
                        <option value="fade" data-i18n="opt_exit_fade">æ·¡å‡º</option>
                        <option value="slide" data-i18n="opt_exit_slide">æŠ½å‡º</option>
                    </select>
                </div>
            </div>
            <div class="diag-editor-col" style="flex:0 0 200px;">
                <div class="emotion-grid" id="emotion-grid-p1"></div>
                <input type="hidden" id="edit-p1-emotion" value="normal">
            </div>
        </div>

        <div style="text-align:right; margin-top:10px;">
            <button class="danger" onclick="document.getElementById('dialogue-modal').style.display='none'; cancelDraft();" data-i18n="btn_cancel">å–æ¶ˆ</button>
            <button class="primary" onclick="confirmDialogue()" data-i18n="btn_save_step">ğŸ’¾ å„²å­˜æ­¤æ­¥</button>
        </div>
    </div>
</div>

<script>

	// --- [æ–°å¢] é è¨­/å…¨åŸŸ è¨ˆæ•¸å™¨ (æ¡Œæ©Ÿç‰ˆæˆ–ç„¡åŠ‡æœ¬æ™‚ä½¿ç”¨) ---
    // è«‹å¡«å…¥æ‚¨ç”³è«‹çš„ã€Œä¸»é /å¤§å»³ã€å°ˆç”¨è¨ˆæ•¸å™¨ç¶²å€
    const DEFAULT_COUNTER_URL = 'https://www.f-counter.net/j/66/1765258234/';
	// --- [æ–°å¢] åŠ‡æœ¬æ¸…å–®è¨­å®š ---
    const AVAILABLE_SCRIPTS = [
        {
            filename: 'script20251205.txt',
            title: 'ç‹é¬¥é«˜éº—èœ VS æ³¢å¤å…‹é¾çš‡ç¥',
            description: 'ä½œè€…å¸¸ç©çš„è¨“ç·´å°å±€',
			counter_url: 'https://www.f-counter.net/j/66/1765257467/',
			speed: 1.0,
            lang: 'zh',
        },
        {
            filename: 'script20251208.txt',
            title: 'ç”²ç¸è»éšŠ VS çƒçˆ¾å¤©å¯¶',
            description: 'é€²è¡ŒDM25-RP4æ–°å¡çš„æ¸¬è©¦',
			counter_url: 'https://www.f-counter.net/j/66/1765258081/',
			speed: 1.0,
            lang: 'zh',
        },
        {
            filename: 'script20251209.txt',
            title: 'æ–°æƒ¡é­” VS æ–°æ­¦å£«',
            description: 'é€²è¡ŒDM25-RP4æ–°å¡çš„æ¸¬è©¦',
			counter_url: 'https://www.f-counter.net/j/66/1765258098/',
			speed: 1.0,
            lang: 'zh',
        },
        {
            filename: 'script20251210.txt',
            title: 'æ„›çˆ†ç™¼å…§æˆ°',
            description: 'é€²è¡Œç„¡æœˆä¹‹é–€çš„ç‰¹æ•ˆæ¸¬è©¦',
			counter_url: 'https://www.f-counter.net/j/66/1765355583/',
			speed: 1.0,
            lang: 'zh',
        },
        {
            filename: 'script20251210_jp.txt',
            title: 'æ„›çˆ†ç™¼ã®ãƒŸãƒ©ãƒ¼ãƒãƒƒãƒ',
            description: 'ã€Œç„¡æœˆã®é–€ã€ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒ†ã‚¹ãƒˆã‚’è¡Œã†',
			counter_url: 'https://www.f-counter.net/j/66/1765421671/',
			speed: 1.0,
            lang: 'jp',
			credits: [
                { role: 'Language Guidance', name: 'SHAO' },
            ]
			
        },
        {
            filename: 'script20251212.txt',
            title: 'ç”²é¾QX VS é¦¬é†‰æœ¨',
            description: 'é€²è¡ŒCutInç‰¹æ•ˆèˆ‡æ´—ç‰Œæ¸¬è©¦',
			counter_url: 'https://www.f-counter.net/j/66/1765522611/',
			speed: 1.0,
            lang: 'zh',
        },
        {
            filename: 'script20251214.txt',
            title: 'ç«é³¥ VS å¿è€…',
            description: 'å‹äººçš„å¼·åŠ›å€‹äººç‰Œçµ„å°æ±ºå±•ç¤º',
			counter_url: 'https://www.f-counter.net/j/66/1765675947/',
			speed: 1.33,
            lang: 'zh',
			credits: [
                { role: 'Deck Provided', name: 'Mr. ãƒ‘ã‚¤' },
            ]
        },
		/*
		{
            filename: 'script_test.txt',
            title: 'æ³¢å¤å…‹ VS éœ¸é¾å‡°',
            description: 'éš¨æ™‚éƒ½æœƒæ›´æ›å…§å®¹çš„æ¸¬è©¦ç”¨å°å±€',
			counter_url: 'https://www.f-counter.net/j/66/1766109155/',
			speed: 1,
            lang: 'zh',
        },
		*/
        {
            filename: 'script_test2.txt',
            title: 'å¤©å¯¶éŠ€æ²³ VS æ³¢å¤å…‹',
            description: 'éš¨æ™‚éƒ½æœƒæ›´æ›å…§å®¹çš„æ¸¬è©¦ç”¨å°å±€#2',
			counter_url: 'https://www.f-counter.net/j/66/1766112376/',
			speed: 1,
            lang: 'zh',
        },
		/*
		        {
            filename: 'script_test3.txt',
            title: 'è¤»ç€†è€…ãƒ»é™¶ VS ä¸‰é­‚',
            description: 'éš¨æ™‚éƒ½æœƒæ›´æ›å…§å®¹çš„æ¸¬è©¦ç”¨å°å±€#3',
			counter_url: 'https://www.f-counter.net/j/66/1766124689/',
			speed: 1,
            lang: 'zh',
        },
		*/
        {
            filename: 'script20251222.txt',
            title: 'Aniki vs Kouji',
            description: 'é‡ç¸ vs å¦–ç²¾',
			counter_url: 'https://www.f-counter.net/j/66/1766393180/',
			speed: 1,
            lang: 'zh',
			credits: [
                { role: 'Special Thanks', name: 'COAT CORPORATION / All Worlds Video' },
            ]
        },
        {
            filename: 'script_mamoru_20251223.txt',
            title: 'é¦¬éœ²éœ²è»¸åŠè½Ÿåœ˜é•·',
            description: 'æ¸¬è©¦æ§‹ç¯‰å±•ç¤ºComboæ ¸å¿ƒæ¦‚å¿µ',
			counter_url: 'https://www.f-counter.net/j/66/1766495206/',
			speed: 1,
            lang: 'zh',
			credits: [
                { role: 'â¤ï¸', name: 'Ether' },
            ]
        },
        {
            filename: 'script20251224.txt',
            title: 'æ·±æ·µ VS ä¿³å¥çˆµ',
            description: 'é¤…åœ–å¤§æ±ºæˆ°',
			counter_url: 'https://www.f-counter.net/j/66/1766542455/',
			speed: 1,
            lang: 'zh',
			credits: [
                { role: 'Special Thanks', name: 'ã‚¨ãƒ«ã‚·ãƒ£ãƒ€ã‚¤ / UTV Ignition Entertainment' },
            ]
        },
        {
            filename: 'script20251224_tw.txt',
            title: 'æ·±æ·µ VS ä¿³å¥çˆµ',
            description: 'é¤…åœ–å¤§æ±ºæˆ°',
			counter_url: 'https://www.f-counter.net/j/66/1766542455/',
			speed: 1,
            lang: 'tw',
			credits: [
                { role: 'Special Thanks', name: 'ã‚¨ãƒ«ã‚·ãƒ£ãƒ€ã‚¤ / UTV Ignition Entertainment' },
            ]
        },
        {
            filename: 'script20251224_en.txt',
            title: 'Abyss VS Drache derâ€™Bande',
            description: 'Battle of the Meta',
			counter_url: 'https://www.f-counter.net/j/66/1766542455/',
			speed: 1,
            lang: 'en',
			credits: [
                { role: 'Special Thanks', name: 'El Shaddai / UTV Ignition Entertainment' },
            ]
        },
        {
            filename: 'script20251227.txt',
            title: 'ç©¶æ¥µéŠ€æ²³ VS é­”èª•ä¸–ç•Œå·´ç¾…å§†',
            description: 'ä¸æ‰“ç›¾ vs æ‰“å…¨ç›¾',
			counter_url: 'https://www.f-counter.net/j/66/1765939832/',
			speed: 1,
            lang: 'zh',
        },
        {
            filename: 'script20251230.txt',
            title: 'ç¥å®˜é­”é© VS æ©Ÿæ¢°',
            description: 'é·ºç§‘å¤§æˆ°',
			counter_url: 'https://www.f-counter.net/j/66/1765257662/',
			speed: 1,
            lang: 'zh',
        },
        // æ‚¨å¯ä»¥åœ¨æ­¤æ“´å……æ›´å¤šåŠ‡æœ¬...
    ];
	// [æ–°å¢] ç”¨ä¾†è¨˜éŒ„ç•¶å‰æ­£åœ¨é‹è¡Œçš„åŠ‡æœ¬è¨­å®š (åŒ…å« credits)
	let currentScriptConfig = null;

	// --- Dialogue Assets Generation ---
    const EMOTIONS = ['normal', 'blank', 'serious', 'smug', 'furious', 'terrified'];
    const EMOTION_LABELS = {normal:'ä¸€èˆ¬', blank:'å‘†æ»¯', serious:'èªçœŸ', smug:'å¾—æ„', furious:'ç››æ€’', terrified:'é©šæ'};
    
    // ç”Ÿæˆç°¡å–®çš„ Canvas é ­åƒ
    function generateDefaultPortraits() {
        const drawFace = (color, emotion) => {
            const canvas = document.createElement('canvas');
            canvas.width = 160; canvas.height = 160;
            const ctx = canvas.getContext('2d');
            
            // èƒŒæ™¯èˆ‡æ¡†
            ctx.fillStyle = '#222'; ctx.fillRect(0,0,160,160);
            ctx.lineWidth = 4; ctx.strokeStyle = color; ctx.strokeRect(5,5,150,150);
            
            // è‡‰å‹
            ctx.beginPath(); ctx.arc(80, 80, 50, 0, Math.PI*2); ctx.stroke();
            
            // çœ¼ç›
            ctx.beginPath();
            if(emotion==='blank') { ctx.arc(65, 70, 3, 0, Math.PI*2); ctx.arc(95, 70, 3, 0, Math.PI*2); }
            else if(emotion==='serious') { ctx.moveTo(55,65); ctx.lineTo(75,75); ctx.moveTo(105,65); ctx.lineTo(85,75); } // çœ‰é ­æ·±é–
            else if(emotion==='furious') { ctx.moveTo(55,60); ctx.lineTo(75,80); ctx.moveTo(105,60); ctx.lineTo(85,80); } // ç”Ÿæ°£çœ‰æ¯›
            else if(emotion==='terrified') { ctx.arc(65, 70, 8, 0, Math.PI*2); ctx.arc(95, 70, 8, 0, Math.PI*2); } // ç³å­”æ”¾å¤§
            else { ctx.arc(65, 70, 5, 0, Math.PI*2); ctx.arc(95, 70, 5, 0, Math.PI*2); }
            ctx.stroke();

            // å˜´å·´
            ctx.beginPath();
            if(emotion==='smug') { ctx.arc(80, 90, 10, 0, Math.PI, false); } // å¾®ç¬‘
            else if(emotion==='furious') { ctx.moveTo(70,105); ctx.lineTo(90,105); ctx.rect(70,100,20,10); } // æ€’å¼
            else if(emotion==='terrified') { ctx.ellipse(80, 110, 10, 15, 0, 0, Math.PI*2); } // å¼µå£
            else if(emotion==='serious') { ctx.moveTo(70,105); ctx.lineTo(90,105); } // æŠ¿å˜´
            else { ctx.arc(80, 90, 15, 0, Math.PI, false); } // ä¸€èˆ¬ç¬‘
            ctx.stroke();

            return canvas.toDataURL();
        };

        ['p1', 'p2'].forEach(p => {
            const color = p === 'p1' ? '#3498db' : '#c0392b';
            EMOTIONS.forEach(emo => {
                const key = `avatar_${p}_${emo}`;
                if (!globalImageRegistry[key]) {
                    globalImageRegistry[key] = drawFace(color, emo);
                }
            });
        });
    }
	
	// [æ–°å¢] ç”¢ç”ŸçŒœæ‹³å¡ç‰‡çš„é è¨­åœ– (è‹¥ globalImageRegistry æ²’åœ–æ™‚ä½¿ç”¨)
    function generateRpsPlaceholders() {
        const types = ['rock', 'paper', 'scissors'];
        const icons = { rock: 'âœŠ', paper: 'ğŸ–ï¸', scissors: 'âœŒï¸' };
        const colors = { rock: '#e74c3c', paper: '#3498db', scissors: '#2ecc71' };

        types.forEach(type => {
            const key = `rps_${type}`;
            // åªæœ‰ç•¶å°šæœªè¨»å†Šæ™‚æ‰ç”Ÿæˆ
            if (!globalImageRegistry[key]) {
                const canvas = document.createElement('canvas');
                canvas.width = 200; canvas.height = 280; // ç¬¦åˆå¡ç‰‡æ¯”ä¾‹
                const ctx = canvas.getContext('2d');
                
                // èƒŒæ™¯
                ctx.fillStyle = '#fdfdfd';
                ctx.fillRect(0,0,200,280);
                
                // é‚Šæ¡†
                ctx.lineWidth = 10;
                ctx.strokeStyle = colors[type];
                ctx.strokeRect(5,5,190,270);
                
                // åœ–ç¤º
                ctx.font = "100px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(icons[type], 100, 140);
                
                // æ–‡å­—
                ctx.font = "bold 30px Arial";
                ctx.fillStyle = "#333";
                ctx.fillText(type.toUpperCase(), 100, 220);

                globalImageRegistry[key] = canvas.toDataURL();
            }
        });
    }
	
	// --- [æ–°å¢] URL åƒæ•¸è®€å–å·¥å…· ---
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }
	
	// --- [æ–°å¢] æ’­æ”¾æ™‚é–“åƒæ•¸è¨­å®š (Global Config for Playback) ---
    // æ‚¨å¯ä»¥åœ¨é€™è£¡çµ±ä¸€èª¿æ•´æ‰€æœ‰é€Ÿåº¦ (å–®ä½ï¼šæ¯«ç§’)
    
    const TIME_ACTION_BASE = 1200;       // ä¸€èˆ¬å‹•ä½œ (å¦‚ç§»å‹•å¡ç‰‡) çš„é è¨­åœç•™æ™‚é–“
    const TIME_DIALOGUE_BASE = 500;      // å°è©±å‹•ä½œçš„ã€Œèµ·è·³ã€æ™‚é–“
    const TIME_CHAR_READING = 120;       // å°è©±ä¸­ã€Œæ¯å€‹å­—ã€å¢åŠ çš„é–±è®€æ™‚é–“
    const TIME_DIALOGUE_MIN = 1500;      // å°è©±å‹•ä½œçš„ã€Œæœ€çŸ­ã€åœç•™æ™‚é–“ (é¿å…å­—å¤ªå°‘ä¸€é–ƒè€Œé)
	
	let lastRbStep = -1; 
	let lastShuffleStep = -1; // [æ–°å¢] ç”¨æ–¼è¨˜éŒ„æ´—ç‰Œå‹•ç•«æ˜¯å¦å·²åœ¨è©²æ­¥é©Ÿæ’­æ”¾é
	
	// --- å¤šèªè¨€è¨­å®š (i18n) ---
    const TRANSLATIONS = {
		'zh': {
			'btn_setup': 'Setup / Clear',
			'btn_rotate': 'ğŸ”„ å›åˆçµæŸ',
			'btn_p1_reset': 'P1 é‡ç½®',
			'btn_p2_reset': 'P2 é‡ç½®',
			'btn_reset_current': 'é‡ç½®ç•¶å‰ (Untap)', // [æ–°å¢]
			'btn_p1_win': 'ğŸ† 1P Win',
			'btn_p2_win': 'ğŸ† 2P Win',
			'opt_win_default': 'ğŸ† å®£å‘Šå‹åˆ©...', // [æ–°å¢]
			'btn_import': 'åŒ¯å…¥ (Import)',
			'btn_export': 'åŒ¯å‡º (Export)',
            'btn_dialogue': 'ğŸ’¬ å°è©± (Dialog)', // [æ–°å¢]
			
			'zone_battle': 'æˆ°é¬¥å ´',
			'zone_shield': 'è­·ç›¾å€',
			'zone_mana': 'é­”åŠ›å€',
			'zone_hand': 'æ‰‹ç‰Œ',
			'zone_hyper': 'è¶…æ¬¡å…ƒ',
			'zone_grave': 'å¢“åœ°',
			'zone_deck': 'ç‰Œåº«',
			'zone_ability': 'èƒ½åŠ› (å¾…è™•ç†)',
			
			'act_flip': 'ç¿»é¢',
			'act_injured': 'ğŸ’” å—å‚·',
			'act_clear_injured': 'â¤ï¸ æ²»ç™’', // [æ–°å¢]
			'act_glow': 'ğŸ’¡ç™¼å…‰',
			'act_ability': 'âš¡è§¸ç™¼èƒ½åŠ›',
			'act_continuous': 'âˆ æŒçºŒèƒ½åŠ›',
			'act_reveal': 'ğŸ‘ï¸ å±•ç¤º',
			'act_point': 'ğŸ‘‰ æŒ‡å‘',
			'act_end_point': 'ğŸ›‘ çµæŸæŒ‡å‘',
			'act_paste': 'ğŸ–¼ï¸ ä¸Šåœ– (Ctrl+V)',
			'act_rename': 'æ›´å',
			'act_note': 'ğŸ“è¨»è¨˜',
			'act_delete': 'ğŸ—‘ï¸ åˆªé™¤',

			'lbl_draft_warning': 'âš ï¸ ç·¨è¼¯ä¸­... (å·²ç´¯ç© ',
			'lbl_draft_ops': ' å€‹æ“ä½œ)',
			'lbl_draft_ops_prefix': 'åŒ…å«', 
			'chk_propagate': 'ğŸ”— é€£å‹•æ›´æ–°å¾ŒçºŒ',
			'btn_cancel': 'å–æ¶ˆ',
			'btn_save_step': 'ğŸ’¾ å„²å­˜æ­¤æ­¥',
			'lbl_point_mode': 'ğŸ‘‰ æŒ‡å‘æ¨¡å¼ï¼šè«‹é¸æ“‡ç›®æ¨™ (å¯é¸æ“‡ä»»æ„å¡ç‰‡æˆ–å€åŸŸ)',
			'btn_confirm_point': 'âœ… ç¢ºèªæŒ‡å‘',
			'btn_reset_all': 'ğŸ—‘ï¸é‡è¨­',

			'title_setup': 'é–‹å±€è¨­å®š',
			'msg_setup_warn': 'æ³¨æ„ï¼šé–‹å§‹æ–°å±€æœƒæ¸…é™¤ç•¶å‰æœªåŒ¯å‡ºçš„é€²åº¦ã€‚',
            'btn_clear_storage': 'æ¸…é™¤å­˜æª”',
			'btn_start_game': 'é–‹å§‹éŠæˆ² (Start)',
			'btn_draw': 'ğŸ´ æŠ½ç‰Œ (Draw)', // [æ–°å¢]

            // --- å°è©±ç›¸é—œç¿»è­¯ [æ–°å¢] ---
            'title_dialogue_insert': 'æ’å…¥åŠ‡æƒ…å°è©± (Action)',
            'lbl_diag_replace_hint': 'é»æ“Šè¡¨æƒ…åœ–ç¤ºå¾Œï¼ŒæŒ‰ä¸‹[Ctrl+V]å¯æ›¿æ›è©²è¡¨æƒ…åœ–ç‰‡ (å…¨åŸŸç”Ÿæ•ˆ)ã€‚',
            'lbl_enable_p2': 'å•Ÿç”¨ P2',
            'lbl_p2_desc': '(ä¸Šæ–¹/æ•µæ–¹)',
            'lbl_enable_p1': 'å•Ÿç”¨ P1',
            'lbl_p1_desc': '(ä¸‹æ–¹/æˆ‘æ–¹)',
            'ph_name': 'åå­—...',
            'ph_text': 'å°è©...',
            'opt_size_s': 'å°å­—',
            'opt_size_m': 'ä¸­å­—',
            'opt_size_l': 'å¤§å­—',
            'opt_effect_direct': 'ç›´æ¥é¡¯ç¤º',
            'opt_effect_fade': 'æ·¡å…¥',
            'opt_effect_slide': 'æ»‘å…¥',
            'opt_exit_direct': 'ç›´æ¥æ¶ˆå¤±',
            'opt_exit_fade': 'æ·¡å‡º',
            'opt_exit_slide': 'æŠ½å‡º',
            // -----------------------

            // ... (ä¿ç•™èˆŠæœ‰çš„å…¶ä»–ç¿»è­¯ï¼Œå¦‚å †ç–Šæ“ä½œã€è¨Šæ¯ç­‰) ...
            'btn_shuffle_zone': 'æ´—ç‰Œæ­¤å€',
			'btn_shuffle_move': 'æ´—ç‰Œé¸å–ç‰Œä¸¦ç§»å‹•...',
			'btn_reveal_sel': 'ğŸ‘ï¸ å±•ç¤º',
			'btn_move_sel': 'ç§»å‹•é¸å–ç‰Œ...',
            'title_stack': 'å †ç–Šæ“ä½œ',
            'lbl_stack_hint': 'è«‹é»æ“Šåœ–ç¤ºé¸æ“‡å †ç–Šæ–¹å¼ï¼š',
            'msg_storage_full': 'âš ï¸ è‡ªå‹•å­˜æª”å¤±æ•—ï¼šå„²å­˜ç©ºé–“å·²æ»¿ã€‚\nå»ºè­°æ‚¨ç«‹å³ã€ŒåŒ¯å‡ºã€ä¿å­˜é€²åº¦ã€‚',
            'msg_confirm_clear_storage': 'ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è‡ªå‹•å­˜æª”å—ï¼Ÿ',
            'msg_cleared': 'å­˜æª”å·²æ¸…é™¤ã€‚',
            'msg_confirm_del_all': 'ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰å‹•ä½œä¸¦é‡æ–°é–‹å§‹æ–°å±€å—ï¼Ÿ',
            'msg_unsaved_draft': 'ç›®å‰æœ‰æœªå„²å­˜çš„è®Šæ›´ï¼Œæ˜¯å¦æ¨æ£„ä¸¦é–‹å§‹æ–°æ­¥é©Ÿï¼Ÿ',
            'msg_unsaved_edit': 'ç›®å‰æœ‰æœªå„²å­˜çš„è®Šæ›´ï¼Œæ˜¯å¦æ¨æ£„ä¸¦ç·¨è¼¯æ­¤æ­¥é©Ÿï¼Ÿ',
            'msg_confirm_del_step': 'ç¢ºå®šåˆªé™¤æ­¤æ­¥é©Ÿï¼Ÿ',
            'msg_confirm_p1_reset': 'ç¢ºå®šè¦é‡ç½® P1 ç›¤é¢æ–¹å‘å—ï¼Ÿ',
            'msg_confirm_p2_reset': 'ç¢ºå®šè¦é‡ç½® P2 ç›¤é¢æ–¹å‘å—ï¼Ÿ',
            'msg_glow_err': 'åªæœ‰ã€Œå¾…è™•ç†å€ã€çš„å¡ç‰‡å¯ä»¥ä¸‹é”ç™¼å…‰æŒ‡ä»¤ã€‚',
            'msg_glow_ability_only': 'åªæœ‰ã€Œå¾…è™•ç†å€ã€çš„å¡ç‰‡å¯ä»¥æ“ä½œç™¼å…‰ç‹€æ…‹ã€‚',
            'msg_injured_err': 'åªæœ‰ã€Œæˆ°é¬¥å€ã€èˆ‡ã€Œè­·ç›¾å€ã€çš„å¡ç‰‡å¯ä»¥æ¨™è¨˜ç‚ºå—å‚·ã€‚',
            'msg_select_one_copy': 'è«‹ä¸€æ¬¡é¸æ“‡ä¸€å¼µç‰Œé€²è¡Œè¤‡è£½',
            'msg_select_one_point': 'è«‹é¸æ“‡ä¸€å¼µå¡ç‰‡é€²è¡ŒæŒ‡å‘',
            'msg_point_save_first': 'è«‹å…ˆå„²å­˜ç•¶å‰æ­¥é©Ÿï¼Œå†çµæŸæŒ‡å‘',
            'msg_mobile_blocked': 'æ­¤åŠŸèƒ½æœªå°è¡Œå‹•è£ç½®é–‹æ”¾',
            'msg_import_success': 'åŒ¯å…¥æˆåŠŸï¼',
            'msg_import_fail': 'åŒ¯å…¥å¤±æ•—',
            'msg_confirm_import': 'ç¢ºå®šè¦åŒ¯å…¥æ­¤æª”æ¡ˆå—ï¼Ÿ',
            'msg_replace_img': 'ç¢ºå®šè¦æ›¿æ›é€™å¼µå¡ç‰‡çš„åœ–ç‰‡å—ï¼Ÿ',
            'msg_remove_img': 'ç¢ºå®šè¦ç§»é™¤é€™å¼µå¡ç‰‡çš„åœ–ç‰‡å—ï¼Ÿ',
            'msg_init_fail': 'åˆå§‹åŒ–å¤±æ•—: ',
            'msg_cannot_del_init': 'ç„¡æ³•åˆªé™¤åˆå§‹æ­¥é©Ÿã€‚',
            'btn_cancel_draft': 'å–æ¶ˆ',
            'msg_confirm_delete_all': 'ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰å‹•ä½œä¸¦é‡æ–°é–‹å§‹æ–°å±€å—ï¼Ÿ',
            'msg_confirm_reveal_close': 'ç¢ºå®šè¦é—œé–‰å±•ç¤ºå€ä¸¦å°‡å¡ç‰‡é€å…¥å¢“åœ°å—ï¼Ÿ',
            'msg_delete_card_confirm': 'ç¢ºå®šè¦åˆªé™¤é¸å–çš„å¡ç‰‡å—ï¼Ÿ(åƒ…å»ºè­°ç”¨æ–¼èƒ½åŠ›è™•ç†å€)',
            'msg_confirm_point_zone': 'ç¢ºèªæŒ‡å‘ {zone}?',
            'msg_ability_cant_move': 'èƒ½åŠ›å¾…è™•ç†å€çš„å¡ç‰‡ä¸èƒ½ç§»å‹•',
            'msg_insert_pos_title': 'æ’å…¥ä½ç½®é¸æ“‡ (é»æ“Šè™›ç·šæ¡†)',
            'msg_load_script_fail': 'ç„¡æ³•è¼‰å…¥æŒ‡å®šåŠ‡æœ¬: ',
			'msg_editing_step': 'ğŸ“ æ­£åœ¨ç·¨è¼¯ #{n}',
			'msg_insert_after': 'â• å°‡æ–°å¢æ–¼ #{n} ä¹‹å¾Œ',
            'btn_play_from': 'â–¶ å¾æ­¤æ’­æ”¾',
            'btn_play_step': 'ğŸ‘ï¸ æ¼”ç¤ºæ­¤æ­¥',
            'btn_edit_step': 'âœï¸ ç·¨è¼¯',
            'btn_delete_step': 'ğŸ—‘ åˆªé™¤',
            'btn_play': 'â–¶',
            'btn_pause': 'â¸',
            'lbl_reveal_zone': 'å±•ç¤ºå€ (Reveal Zone)',
            'lbl_action_log': 'Action Log (æ“ä½œç´€éŒ„)',
            'op_default': 'æ“ä½œ',
            'op_count_suffix': ' å€‹å‹•ä½œ',
            'desc_end_reveal': 'çµæŸå±•ç¤º',
            'desc_end_point': 'çµæŸæŒ‡å‘',
            'lbl_move': 'ä½ç§»:',
            'lbl_scale': 'ç¸®æ”¾:',
            'btn_remove_img_short': 'âœ• åœ–',
            'title_stack_target': 'å †ç–Šæ“ä½œ: ç›®æ¨™ [{target}]',
             // ... ä¿ç•™å…¶ä»–æ‚¨åŸæœ¬å¯èƒ½æœ‰çš„ç¿»è­¯ ...
            'opt_stack_top': 'ç–Šåœ¨ä¸Šæ–¹',
            'opt_stack_btm': 'ç–Šåœ¨ä¸‹æ–¹',
            'opt_puz_top': 'æ‹¼åœ¨ä¸Šæ–¹',
            'opt_puz_btm': 'æ‹¼åœ¨ä¸‹æ–¹',
            'opt_puz_left': 'æ‹¼åœ¨å·¦é‚Š',
            'opt_puz_right': 'æ‹¼åœ¨å³é‚Š',
            'opt_shift_up': 'ä¸Šæ–¹ (éœ²å‡ºåº•)',
            'opt_shift_down': 'ä¸Šæ–¹ (éœ²å‡ºé ‚)',
            'opt_btm_exp': 'ä¸‹æ–¹ (éœ²å‡ºåº•)',
            'lbl_p1_deck': 'P1 ç‰Œåº«æ•¸:',
            'lbl_p2_deck': 'P2 ç‰Œåº«æ•¸:',
            'op_POINT': 'æŒ‡å‘',
            'op_ATTACK': 'æ”»æ“Šå®£è¨€',
			'btn_multi_move': 'ğŸ“š ç§»å‹•å¤šå¼µ...',
            'btn_multi_confirm': 'âŒ å–æ¶ˆ / âœ… ä¸€èµ·ç§»å‹•',
            'msg_select_dest': 'å·²é¸å– {n} å¼µå¡ç‰‡ï¼Œè«‹é»æ“Šã€Œç›®æ¨™å€åŸŸã€é€²è¡Œç§»å‹• (è‹¥æ˜¯ç‰Œåº«/è­·ç›¾å°‡è·³å‡ºæ’å…¥é¸å–®)ã€‚',
			// ... (åŸæœ¬çš„å…§å®¹) ...
            'act_glow_bottom': 'ğŸ‘‡åº•å…‰',
            'btn_swap_flip': 'ğŸ” P1/P2 åœ–ç‰‡äº¤æ› & æ°´å¹³ç¿»è½‰',
            'lbl_swap_flip_hint': '* å°‡ P1 èˆ‡ P2 çš„æ‰€æœ‰è¡¨æƒ…åœ–ç‰‡äº’æ›ï¼Œä¸¦è‡ªå‹•é€²è¡Œæ°´å¹³ç¿»è½‰ (é è¨­åœ–é™¤å¤–)',
            'msg_confirm_swap': 'ç¢ºå®šè¦äº¤æ› P1 èˆ‡ P2 çš„æ‰€æœ‰åœ–ç‰‡ä¸¦é€²è¡Œç¿»è½‰å—ï¼Ÿ\n(æ³¨æ„ï¼šé€™æ˜¯å…¨åŸŸä¿®æ”¹ï¼Œæœƒå½±éŸ¿æ‰€æœ‰å°è©±æ­¥é©Ÿ)',
            'msg_swap_done': 'åœ–ç‰‡äº¤æ›èˆ‡ç¿»è½‰å®Œæˆï¼',
			'act_moonless': 'ğŸŒ‘ ç„¡æœˆä¹‹é–€',
			'btn_rps': 'âœŠâœŒï¸ğŸ–ï¸ çŒœæ‹³ (RPS)',
            'act_rps': 'çŒœæ‹³',
            'rps_rock': 'âœŠ çŸ³é ­',
            'rps_paper': 'ğŸ–ï¸ å¸ƒ',
            'rps_scissors': 'âœŒï¸ å‰ªåˆ€',
            'rps_draw': 'å¹³æ‰‹ï¼å†ä¾†ä¸€æŠŠï¼',
            'rps_p1_win': 'P1 ç²å‹ï¼',
            'rps_p2_win': 'P2 ç²å‹ï¼',
			'btn_effect': 'âš¡ Cut In',
			'btn_bgm': 'ğŸµ BGM',
			'btn_trans': 'ğŸŒ ç¿»è­¯ (Trans)',
			'btn_about': 'â„¹ï¸ About',
			'title_theme_picker': 'é¸æ“‡ P{n} ä»£è¡¨è‰²',
			'msg_theme_opponent': 'å°æ‰‹å·²ä½¿ç”¨çš„é¡è‰²ç„¡æ³•é¸æ“‡ã€‚',
			'title_bgm': 'ğŸµ è¨­å®šèƒŒæ™¯éŸ³æ¨‚ (BGM)',
			'msg_bgm_hint': 'é»æ“Šåˆ—è¡¨å¯è©¦è½ï¼ŒæŒ‰ä¸‹ç¢ºèªå¾Œç”Ÿæ•ˆã€‚',
			'opt_bgm_stop': 'ğŸ›‘ åœæ­¢æ’­æ”¾ (Stop Music)',
			'btn_confirm': 'ğŸ’¾ ç¢ºèª',
			'title_trans': 'ğŸŒ ç¿»è­¯å°å¹«æ‰‹ (Translation Tool)',
			'msg_trans_desc': 'æ­¤åŠŸèƒ½å¯å°‡åŠ‡æœ¬ä¸­çš„å°è©±æå–ç‚ºè¼•é‡ç´š JSON æª”ï¼Œæ–¹ä¾¿äº¤çµ¦ AI ç¿»è­¯ï¼Œå®Œæˆå¾Œå†åŒ¯å…¥è¦†è“‹ã€‚',
			'btn_trans_export': 'ğŸ“¤ 1. åŒ¯å‡ºå°ç™½æª” (.json)',
			'msg_trans_hint': '(è«‹å°‡æ­¤æª”æ¡ˆå…§å®¹è²¼çµ¦ AIï¼Œä¸¦è¦æ±‚å®ƒåªç¿»è­¯å€¼ï¼Œä¿æŒæ ¼å¼ä¸è®Š)',
			'btn_trans_import': 'ğŸ“¥ 2. åŒ¯å…¥ç¿»è­¯æª” (.json)',
			'btn_close': 'é—œé–‰ (Close)',
			'title_credits': 'Credits',
			'title_import_conflict': 'ç™¼ç¾å¤–éƒ¨åŠ‡æœ¬',
			'msg_import_conflict': 'ç¶²å€åƒæ•¸åŒ…å«åŠ‡æœ¬æª”ï¼Œä½†åµæ¸¬åˆ°æ‚¨æœ‰æœªå„²å­˜çš„æœ¬åœ°é€²åº¦ã€‚\nè«‹å•è¦å¦‚ä½•è™•ç†ï¼Ÿ',
			'btn_conflict_cancel': 'âŒ ä¸åŒ¯å…¥ (ä½¿ç”¨æœ¬åœ°å­˜æª”)',
			'btn_conflict_save': 'ğŸ’¾ å­˜æª”ç„¶å¾ŒåŒ¯å…¥',
			'btn_conflict_overwrite': 'âš ï¸ ä¸å­˜æª”ç›´æ¥åŒ¯å…¥',
			'title_select_script': 'é¸æ“‡åŠ‡æœ¬ (Select Script)',
			'title_import_source': 'é¸æ“‡åŒ¯å…¥ä¾†æº (Import Source)',
			'btn_local_file': 'ğŸ“‚ é¸æ“‡æœ¬åœ°æª”æ¡ˆ (.txt/.json)',
			'lbl_or_examples': 'â–¼ æˆ–é¸æ“‡ç¯„ä¾‹åŠ‡æœ¬ (Built-in Scripts) â–¼',
			'lbl_no_script': 'ç„¡å¯ç”¨åŠ‡æœ¬',
			'lbl_rb_style': 'ç‰¹æ•ˆæ¨£å¼:',
			'opt_rb_random': 'ğŸ² éš¨æ©Ÿ (Random)',
			'opt_rb_center': 'âš¡ ä¸­é–“æ’•è£‚ (Center)',
			'opt_rb_tl': 'ğŸ“ å·¦ä¸Šæ’•è£‚ (Top-Left)',
			'opt_rb_br': 'ğŸ“ å³ä¸‹æ’•è£‚ (Btm-Right)',
			'opt_rb_pan_up': 'ğŸ”¼ ç·©ç·©ä¸Šå‡ (Pan Up)',
			'opt_rb_pan_down': 'ğŸ”½ ç·©ç·©ä¸‹é™ (Pan Down)', // [æ–°å¢]
			'btn_preview': 'â–¶ é è¦½',
			'btn_save': 'ğŸ’¾ å„²å­˜ (Save)',
			'msg_rb_hint': 'é»æ“Šæ­¤è™•ä¸¦æŒ‰ä¸‹ Ctrl+V è²¼ä¸Šåœ–ç‰‡\n(æ‹–æ›³å¯ç§»å‹•ï¼Œæ»¾è¼ªå¯ç¸®æ”¾)',
			'msg_paste_img_hint': 'è«‹å…ˆé¸æ“‡ä¸€å¼µå¡ç‰‡ï¼Œç„¶å¾ŒæŒ‰ä¸‹ Ctrl+V è²¼ä¸Šåœ–ç‰‡',
			'msg_deck_empty': 'P{n} ç‰Œåº«å·²ç©º (Empty Deck)ï¼',
			'msg_dialog_exclusive': 'å°è©±å‹•ä½œå¿…é ˆç¨ç«‹ï¼Œç„¡æ³•èˆ‡å…¶ä»–å‹•ä½œæ··åˆ (è«‹å¦é–‹æ–°æ­¥é©Ÿ)ã€‚',
			'msg_finish_edit_first': 'è«‹å…ˆå®Œæˆç›®å‰çš„ç·¨è¼¯å‹•ä½œã€‚',
			'msg_no_dialog': 'ç›®å‰åŠ‡æœ¬ä¸­æ²’æœ‰ä»»ä½•å°è©±ï¼',
			'msg_trans_result': 'åŒ¯å…¥æˆåŠŸï¼å…±æ›´æ–°äº† {n} è™•å°è©±ã€‚',
			'msg_trans_fail_fmt': 'åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤æˆ–å…§å®¹ç„¡æ•ˆã€‚',
			'msg_select_rotate': 'è«‹å…ˆé¸æ“‡è¦æ—‹è½‰çš„å¡ç‰‡',
			'msg_rps_again': 'è¦ç¹¼çºŒçŒœæ‹³å—ï¼Ÿ',
			'msg_confirm_load_script': 'ç¢ºå®šè¦è¼‰å…¥åŠ‡æœ¬ï¼š\nã€Œ{title}ã€å—ï¼Ÿ\n(æœªå„²å­˜çš„é€²åº¦å°‡æœƒéºå¤±)',
			'msg_p1_win': 'P1 WIN!',
			'msg_p2_win': 'P2 WIN!',
			'msg_congrats': 'Congratulations!',
			'desc_rb': '[ç‰¹æ•ˆ] æ¬¡å…ƒç ´è£‚ (Reality Break)',
			'desc_bgm_play': '[BGM] æ’­æ”¾ {name}',
			'desc_bgm_stop': '[BGM] åœæ­¢éŸ³æ¨‚',
			'desc_dialogue': '[å°è©±]',
			'msg_editing_placeholder': '... ç·¨è¼¯ä¸­ (Editing) ...',
			'lbl_rb_shake_in': 'ğŸ«¨ å…§éœ‡ (Inner)',
			'lbl_rb_shake_out': 'ğŸ«¨ å¤–éœ‡ (Outer)',
			'lbl_rb_intensity': 'è£‚åº¦ (Scale):',
			'msg_truncate_confirm': 'âš ï¸ å±éšªæ“ä½œ âš ï¸\n\nç¢ºå®šè¦åˆªé™¤æ­¤è™• (Step #{n}) ä¹‹å¾Œçš„æ‰€æœ‰ ActionLog å—ï¼Ÿ',
			'msg_truncate_backup': 'é€™å€‹å‹•ä½œæœƒåˆªé™¤å¤§é‡è³‡æ–™ï¼Œæ˜¯å¦è¦å…ˆåŒ¯å‡ºå‚™ä»½ï¼Ÿ\n\n(æŒ‰ã€Œç¢ºå®šã€= åŒ¯å‡ºä¸¦åˆªé™¤ï¼ŒæŒ‰ã€Œå–æ¶ˆã€= ç›´æ¥åˆªé™¤)',
			'btn_random_pick': 'ğŸ² éš¨æ©Ÿ',
			'msg_turn_change': "äº¤æ›è‡³ {player} çš„å›åˆ",
			// --- Context Menu & Deck Modal ---
			ctx_shuffle: "ğŸ”„ æ´—ç‰Œ",
			ctx_move: "â¡ï¸ ç§»å‹•å¡ç‰‡...",
			ctx_recall: "ğŸ”™ å…¨éƒ¨æ”¶å›",
			ctx_close: "âœ– é—œé–‰é¸å–®",
			
			title_move_modal: "å¾ç‰Œåº«é ‚ç§»å‹•",
			lbl_qty: "æ•¸é‡:",
			lbl_dest: "ç§»å‹•åˆ°:",
			btn_do_move: "ç¢ºèªç§»å‹•",
			
			dest_hand: "âœ‹ æ‰‹ç‰Œ",
			dest_mana: "ğŸ’§ é­”åŠ›å€",
			dest_shield: "ğŸ›¡ï¸ è­·ç›¾å€",
			dest_grave: "ğŸ’€ å¢“åœ°",
			dest_battle: "âš”ï¸ æˆ°é¬¥å ´",
			dest_hyper: "ğŸŒ€ è¶…æ¬¡å…ƒ",
			dest_abyss: "ğŸŒ‘ æ·±æ·µ",
			dest_reveal: "ğŸ‘ï¸ å±•ç¤ºå€",
			
			msg_confirm_recall: "ç¢ºå®šè¦å°‡ {player} çš„æ‰€æœ‰å¤–éƒ¨å¡ç‰‡ï¼ˆæ‰‹ç‰Œ/æˆ°å ´/å¢“åœ°ç­‰ï¼‰å…¨éƒ¨æ”¶å›ç‰Œåº«ä¸¦æ´—ç‰Œå—ï¼Ÿ",
			msg_no_recall_cards: "æ²’æœ‰éœ€è¦æ”¶å›çš„å¡ç‰‡ã€‚",
			log_blind_move: "[ç›²ç§»]",
			log_recall: "[é‡ç½®] å…¨å¡å›ç‰Œåº«",
		},
        // ç‚ºäº†ç¯€çœç©ºé–“ï¼Œè‹±æ–‡èˆ‡æ—¥æ–‡è«‹ä¾ç…§ç›¸åŒé‚è¼¯è£œä¸Šå°æ‡‰ç¿»è­¯ (è‹¥ç„¡å‰‡é¡¯ç¤ºKey)
		'en': {
            'btn_dialogue': 'ğŸ’¬ Dialog',
            'title_dialogue_insert': 'Insert Dialogue',
            'lbl_diag_replace_hint': 'Click an icon and press [Ctrl+V] to replace image (Global).',
            'lbl_enable_p2': 'Enable P2',
            'lbl_p2_desc': '(Top/Rival)',
            'lbl_enable_p1': 'Enable P1',
            'lbl_p1_desc': '(Bottom/Self)',
            'ph_name': 'Name...',
            'ph_text': 'Dialogue...',
            'opt_size_s': 'Small', 'opt_size_m': 'Medium', 'opt_size_l': 'Large',
            'opt_effect_direct': 'Instant', 'opt_effect_fade': 'Fade In', 'opt_effect_slide': 'Slide In',
            'opt_exit_direct': 'Instant', 'opt_exit_fade': 'Fade Out', 'opt_exit_slide': 'Slide Out',
            // ... (å…¶é¤˜è«‹ä¿ç•™åŸæ¨£) ...
            'btn_setup': 'Setup / Clear', 'btn_rotate': 'ğŸ”„ Switch Turn', 'btn_reset_current': 'Untap Current','btn_p1_reset': 'P1 Untap', 'btn_p2_reset': 'P2 Untap',
            'btn_p1_win': 'ğŸ† 1P Win', 'btn_p2_win': 'ğŸ† 2P Win', 'opt_win_default': 'ğŸ† Declare Win...', 'btn_import': 'Import', 'btn_export': 'Export',
            'zone_battle': 'Battle Zone', 'zone_shield': 'Shields', 'zone_mana': 'Mana', 'zone_hand': 'Hand',
            'zone_hyper': 'Hyper Zone', 'zone_grave': 'Graveyard', 'zone_deck': 'Deck', 'zone_ability': 'Ability (Pending)',
            'act_flip': 'Flip', 'act_injured': 'ğŸ’” Injured', 'act_clear_injured': 'â¤ï¸ Heal', 'act_glow': 'ğŸ’¡ Glow', 'act_ability': 'âš¡ One-shot', 'act_continuous': 'âˆ Continuous',
            'act_reveal': 'ğŸ‘ï¸ Reveal', 'act_point': 'ğŸ‘‰ Point', 'act_end_point': 'ğŸ›‘ End Point', 'act_paste': 'ğŸ–¼ï¸ Paste Img',
            'act_rename': 'Rename', 'act_note': 'ğŸ“ Note', 'act_delete': 'ğŸ—‘ï¸ Delete', 'btn_cancel': 'Cancel', 'btn_save_step': 'ğŸ’¾ Save Step',
            'lbl_point_mode': 'ğŸ‘‰ Point Mode: Select Target(s)', 'btn_confirm_point': 'âœ… Confirm', 'btn_reset_all': 'ğŸ—‘ï¸ Reset',
            'title_setup': 'Setup Game', 'msg_setup_warn': 'Note: Starting new game clears unsaved progress.',
            'lbl_p1_deck': 'P1 Deck:', 'lbl_p2_deck': 'P2 Deck:', 'btn_clear_storage': 'Clear Storage', 'btn_start_game': 'Start Game','btn_draw': 'ğŸ´ Draw', // [æ–°å¢]
            'btn_shuffle_zone': 'Shuffle Zone', 'btn_shuffle_move': 'Shuffle & Move...', 'btn_reveal_sel': 'ğŸ‘ï¸ Reveal', 'btn_move_sel': 'Move Selected...',
            'title_stack': 'Stacking', 'lbl_stack_hint': 'Choose stacking method:', 'opt_stack_top': 'Cover Top', 'opt_stack_btm': 'Underneath',
            'opt_puz_top': 'Puzzle Top', 'opt_puz_btm': 'Puzzle Btm', 'opt_puz_left': 'Puzzle Left', 'opt_puz_right': 'Puzzle Right',
            'opt_shift_up': 'Shift Up', 'opt_shift_down': 'Shift Down', 'opt_btm_exp': 'Bottom Exposed', 'ph_rename': 'Name...', 'ph_note': 'Note...',
            'msg_storage_full': 'âš ï¸ Storage full. Please Export data.', 'msg_confirm_clear_storage': 'Clear all auto-saved data?',
            'msg_cleared': 'Storage cleared.', 'msg_confirm_del_all': 'Delete all actions and restart?', 'msg_unsaved_draft': 'Discard changes and start new?',
            'msg_unsaved_edit': 'Discard changes and edit this step?', 'msg_confirm_del_step': 'Delete this step?',
            'msg_confirm_p1_reset': 'Reset P1 board?', 'msg_confirm_p2_reset': 'Reset P2 board?', 'msg_glow_err': 'Glow is only for Ability Zone.',
            'msg_glow_ability_only': 'Only cards in Ability Zone can glow.', 'msg_injured_err': 'Only cards in Battle/Shield Zone can be injured.',
            'msg_select_one_copy': 'Select exactly one card to copy.', 'msg_select_one_point': 'Select one card to point.',
            'msg_point_save_first': 'Save step before ending point mode.', 'msg_mobile_blocked': 'Not available on mobile.',
            'msg_import_success': 'Import Success!', 'msg_import_fail': 'Import Failed', 'msg_confirm_import': 'Import this file?',
            'msg_replace_img': 'Replace existing image?', 'msg_remove_img': 'Remove image from card?', 'msg_init_fail': 'Init Failed: ',
            'msg_cannot_del_init': 'Cannot delete the initial step.', 'btn_cancel_draft': 'Cancel', 'msg_confirm_delete_all': 'Delete all actions and restart?',
            'msg_confirm_reveal_close': 'Close reveal zone and send cards to grave?', 'msg_delete_card_confirm': 'Delete selected card(s)?',
            'msg_confirm_point_zone': 'Confirm point to {zone}?', 'msg_ability_cant_move': 'Ability cards cannot be moved.',
            'msg_insert_pos_title': 'Select Insert Position', 'msg_load_script_fail': 'Failed to load script: ', 'btn_play_from': 'â–¶ Play From Here',
            'msg_editing_step': 'ğŸ“ Editing #{n}',
			'msg_insert_after': 'â• Will insert after #{n}',
			'btn_play_step': 'ğŸ‘ï¸ Demo Step', 'btn_edit_step': 'âœï¸ Edit', 'btn_delete_step': 'ğŸ—‘ Delete', 'btn_play': 'â–¶', 'btn_pause': 'â¸',
            'lbl_reveal_zone': 'Reveal Zone', 'lbl_action_log': 'Action Log', 'op_default': 'Action', 'op_count_suffix': ' Actions',
            'desc_end_reveal': 'End Reveal', 'desc_end_point': 'End Pointing', 'lbl_move': 'Move:', 'lbl_scale': 'Scale:', 'btn_remove_img_short': 'âœ• Img',
            'title_stack_target': 'Stacking: Target [{target}]', 'lbl_draft_warning': 'âš ï¸ Editing... (Steps: ', 'lbl_draft_ops': ')',
            'lbl_draft_ops_prefix': 'Contains ', 'chk_propagate': 'ğŸ”— Propagate Changes',
			'btn_multi_move': 'ğŸ“š Move Multi...',
            'btn_multi_confirm': 'âŒ Cancel / âœ… Move All',
            'msg_select_dest': '{n} cards selected. Click a Destination Zone to move.',		
			// ... (Original content) ...
            'act_glow_bottom': 'ğŸ‘‡Btm Glow',
            'btn_swap_flip': 'ğŸ” Swap P1/P2 & Flip',
            'lbl_swap_flip_hint': '* Swaps all P1/P2 portraits and flips them horizontally (Default avatars excluded).',
            'msg_confirm_swap': 'Are you sure you want to swap and flip all portraits?\n(Note: This is global and affects all dialogue steps.)',
            'msg_swap_done': 'Swap and flip complete!',
			'act_moonless': 'ğŸŒ‘ Moonless',
			'btn_rps': 'âœŠâœŒï¸ğŸ–ï¸ RPS',
            'act_rps': 'RPS',
            'rps_rock': 'âœŠ Rock',
            'rps_paper': 'ğŸ–ï¸ Paper',
            'rps_scissors': 'âœŒï¸ Scissors',
            'rps_draw': 'Draw! Again!',
            'rps_p1_win': 'P1 Wins!',
            'rps_p2_win': 'P2 Wins!',
			'btn_effect': 'âš¡ Cut In',
			'btn_bgm': 'ğŸµ BGM',
			'btn_trans': 'ğŸŒ Trans',
			'btn_about': 'â„¹ï¸ About',
			'title_theme_picker': 'Select Color for P{n}',
			'msg_theme_opponent': 'Colors used by opponent are disabled.',
			'title_bgm': 'ğŸµ BGM Settings',
			'msg_bgm_hint': 'Click to preview. Confirm to apply.',
			'opt_bgm_stop': 'ğŸ›‘ Stop Music',
			'btn_confirm': 'ğŸ’¾ Confirm',
			'title_trans': 'ğŸŒ Translation Tool',
			'msg_trans_desc': 'Extract dialogue to JSON for AI translation, then import back.',
			'btn_trans_export': 'ğŸ“¤ 1. Export JSON',
			'msg_trans_hint': '(Ask AI to translate values only, keeping keys unchanged)',
			'btn_trans_import': 'ğŸ“¥ 2. Import JSON',
			'btn_close': 'Close',
			'title_credits': 'Credits',
			'title_import_conflict': 'External Script Found',
			'msg_import_conflict': 'URL contains a script, but you have unsaved local progress.\nWhat would you like to do?',
			'btn_conflict_cancel': 'âŒ Cancel (Use Local)',
			'btn_conflict_save': 'ğŸ’¾ Save & Import',
			'btn_conflict_overwrite': 'âš ï¸ Overwrite (No Save)',
			'title_select_script': 'Select Script',
			'title_import_source': 'Import Source',
			'btn_local_file': 'ğŸ“‚ Local File (.txt/.json)',
			'lbl_or_examples': 'â–¼ Built-in Scripts â–¼',
			'lbl_no_script': 'No scripts available',
			'lbl_rb_style': 'Style:',
			'opt_rb_random': 'ğŸ² Random',
			'opt_rb_center': 'âš¡ Center Tear',
			'opt_rb_tl': 'ğŸ“ Top-Left',
			'opt_rb_br': 'ğŸ“ Btm-Right',
			'opt_rb_pan_up': 'ğŸ”¼ Pan Up',
			'opt_rb_pan_down': 'ğŸ”½ Pan Down', // [æ–°å¢]
			'btn_preview': 'â–¶ Preview',
			'btn_save': 'ğŸ’¾ Save',
			'msg_rb_hint': 'Click here & Ctrl+V to paste image\n(Drag to move, Scroll to scale)',
			'msg_paste_img_hint': 'Select a card first, then Ctrl+V to paste image.',
			'msg_deck_empty': 'P{n} Deck is Empty!',
			'msg_dialog_exclusive': 'Dialogue must be a standalone step.',
			'msg_finish_edit_first': 'Please finish current editing first.',
			'msg_no_dialog': 'No dialogue found in script!',
			'msg_trans_result': 'Success! Updated {n} dialogues.',
			'msg_trans_fail_fmt': 'Import failed: Invalid format.',
			'msg_select_rotate': 'Select cards to rotate first.',
			'msg_rps_again': 'Play RPS again?',
			'msg_confirm_load_script': 'Load script:\n"{title}"?\n(Unsaved progress will be lost)',
			'msg_p1_win': 'P1 WIN!',
			'msg_p2_win': 'P2 WIN!',
			'msg_congrats': 'Congratulations!',
			'desc_rb': '[Effect] Reality Break',
			'desc_bgm_play': '[BGM] Play {name}',
			'desc_bgm_stop': '[BGM] Stop',
			'desc_dialogue': '[Dialog]',
			'msg_editing_placeholder': '... Editing ...',
			'lbl_rb_shake_in': 'ğŸ«¨ Inner Shake',
			'lbl_rb_shake_out': 'ğŸ«¨ Outer Shake',
			'lbl_rb_intensity': 'Scale:',
			'msg_truncate_confirm': 'âš ï¸ DANGER âš ï¸\n\nAre you sure you want to delete all steps after Step #{n}?',
			'msg_truncate_backup': 'This action will delete a large amount of data. Do you want to export a backup first?\n\n(OK = Export & Delete, Cancel = Delete immediately)',
			'btn_random_pick': 'ğŸ² Random',
			'msg_turn_change': "Switch to {player}\'s Turn",
			// --- Context Menu & Deck Modal ---
			ctx_shuffle: "ğŸ”„ Shuffle",
			ctx_move: "â¡ï¸ Move Cards...",
			ctx_recall: "ğŸ”™ Recall All",
			ctx_close: "âœ– Close Menu",

			title_move_modal: "Move from Deck Top",
			lbl_qty: "Quantity:",
			lbl_dest: "Destination:",
			btn_do_move: "Move",

			dest_hand: "âœ‹ Hand",
			dest_mana: "ğŸ’§ Mana Zone",
			dest_shield: "ğŸ›¡ï¸ Shield Zone",
			dest_grave: "ğŸ’€ Graveyard",
			dest_battle: "âš”ï¸ Battle Zone",
			dest_hyper: "ğŸŒ€ Hyperspatial",
			dest_abyss: "ğŸŒ‘ Abyss",
			dest_reveal: "ğŸ‘ï¸ Reveal Zone",

			msg_confirm_recall: "Are you sure you want to recall all cards for {player} to the deck?",
			msg_no_recall_cards: "No cards found to recall.",
			log_blind_move: "[Blind Move]",
			log_recall: "[Reset] Recall All",
		},
		'jp': {
            'btn_dialogue': 'ğŸ’¬ ä¼šè©± (Dialog)',
            'title_dialogue_insert': 'ä¼šè©±ã‚¤ãƒ™ãƒ³ãƒˆæŒ¿å…¥',
            'lbl_diag_replace_hint': 'ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯å¾Œã€[Ctrl+V]ã§ç”»åƒã‚’ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ï¼ˆå…¨ä½“åæ˜ ï¼‰ã€‚',
            'lbl_enable_p2': 'P2ã‚’æœ‰åŠ¹åŒ–',
            'lbl_p2_desc': '(ä¸Šå´/æ•µ)',
            'lbl_enable_p1': 'P1ã‚’æœ‰åŠ¹åŒ–',
            'lbl_p1_desc': '(ä¸‹å´/è‡ªåˆ†)',
            'ph_name': 'åå‰...',
            'ph_text': 'ã‚»ãƒªãƒ•...',
            'opt_size_s': 'å°', 'opt_size_m': 'ä¸­', 'opt_size_l': 'å¤§',
            'opt_effect_direct': 'å³æ™‚', 'opt_effect_fade': 'ãƒ•ã‚§ãƒ¼ãƒ‰', 'opt_effect_slide': 'ã‚¹ãƒ©ã‚¤ãƒ‰',
            'opt_exit_direct': 'å³æ™‚æ¶ˆå¤±', 'opt_exit_fade': 'ãƒ•ã‚§ãƒ¼ãƒ‰', 'opt_exit_slide': 'ã‚¹ãƒ©ã‚¤ãƒ‰',
            // ... (å…¶é¤˜è«‹ä¿ç•™åŸæ¨£) ...
            'btn_setup': 'è¨­å®š / ã‚¯ãƒªã‚¢', 'btn_rotate': 'ğŸ”„ ã‚¿ãƒ¼ãƒ³äº¤ä»£', 'btn_reset_current': 'ã‚¢ãƒ³ã‚¿ãƒƒãƒ— (Current)', 'btn_p1_reset': 'P1 ã‚¢ãƒ³ã‚¿ãƒƒãƒ—', 'btn_p2_reset': 'P2 ã‚¢ãƒ³ã‚¿ãƒƒãƒ—',
            'btn_p1_win': 'ğŸ† 1P å‹åˆ©', 'btn_p2_win': 'ğŸ† 2P å‹åˆ©', 'opt_win_default': 'ğŸ† å‹åˆ©å®£è¨€...', 'btn_import': 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆ', 'btn_export': 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ',
            'zone_battle': 'ãƒãƒˆãƒ«ã‚¾ãƒ¼ãƒ³', 'zone_shield': 'ã‚·ãƒ¼ãƒ«ãƒ‰', 'zone_mana': 'ãƒãƒŠã‚¾ãƒ¼ãƒ³', 'zone_hand': 'æ‰‹æœ­',
            'zone_hyper': 'è¶…æ¬¡å…ƒ', 'zone_grave': 'å¢“åœ°', 'zone_deck': 'å±±æœ­', 'zone_ability': 'åŠ¹æœå‡¦ç†',
            'act_flip': 'è£è¿”ã™', 'act_injured': 'ğŸ’” è² å‚·', 'act_clear_injured': 'â¤ï¸ å›å¾©', 'act_glow': 'ğŸ’¡ ç™ºå…‰', 'act_ability': 'âš¡ ãƒˆãƒªã‚¬ãƒ¼èƒ½åŠ›','act_continuous': 'âˆ å¸¸åœ¨èƒ½åŠ›',
            'act_reveal': 'ğŸ‘ï¸ å…¬é–‹', 'act_point': 'ğŸ‘‰ å¯¾è±¡é¸æŠ', 'act_end_point': 'ğŸ›‘ é¸æŠçµ‚äº†', 'act_paste': 'ğŸ–¼ï¸ ç”»åƒè²¼ä»˜',
            'act_rename': 'åå‰å¤‰æ›´', 'act_note': 'ğŸ“ ãƒ¡ãƒ¢', 'act_delete': 'ğŸ—‘ï¸ å‰Šé™¤', 'lbl_draft_warning': 'âš ï¸ ç·¨é›†ä¸­... (æ“ä½œæ•°: ',
            'lbl_draft_ops': ')', 'lbl_draft_ops_prefix': '', 'chk_propagate': 'ğŸ”— ä»¥é™ã¸åæ˜ ', 'btn_cancel': 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
            'btn_save_step': 'ğŸ’¾ ä¿å­˜', 'lbl_point_mode': 'ğŸ‘‰ å¯¾è±¡ã‚’é¸æŠã—ã¦ãã ã•ã„ (ã‚«ãƒ¼ãƒ‰/é ˜åŸŸ)', 'btn_confirm_point': 'âœ… æ±ºå®š',
            'btn_reset_all': 'ğŸ—‘ï¸ ãƒªã‚»ãƒƒãƒˆ', 'title_setup': 'ã‚²ãƒ¼ãƒ è¨­å®š', 'msg_setup_warn': 'æ³¨æ„ï¼šæ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã‚‹ã¨ã€æœªä¿å­˜ã®é€²è¡ŒçŠ¶æ³ã¯æ¶ˆå»ã•ã‚Œã¾ã™ã€‚',
            'lbl_p1_deck': 'P1 å±±æœ­æ•°:', 'lbl_p2_deck': 'P2 å±±æœ­æ•°:', 'btn_clear_storage': 'ãƒ‡ãƒ¼ã‚¿å‰Šé™¤', 'btn_start_game': 'ã‚²ãƒ¼ãƒ é–‹å§‹','btn_draw': 'ğŸ´ ãƒ‰ãƒ­ãƒ¼', // [æ–°å¢]
            'btn_shuffle_zone': 'ã‚·ãƒ£ãƒƒãƒ•ãƒ«', 'btn_shuffle_move': 'ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ç§»å‹•...', 'btn_reveal_sel': 'ğŸ‘ï¸ å…¬é–‹', 'btn_move_sel': 'é¸æŠã—ãŸã‚«ãƒ¼ãƒ‰ã‚’ç§»å‹•...',
            'title_stack': 'é‡ã­æ–¹ã‚’é¸æŠ', 'lbl_stack_hint': 'ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š', 'opt_stack_top': 'ä¸Šã«é‡ã­ã‚‹', 'opt_stack_btm': 'ä¸‹ã«é‡ã­ã‚‹',
            'opt_puz_top': 'ä¸Šã«ãƒªãƒ³ã‚¯', 'opt_puz_btm': 'ä¸‹ã«ãƒªãƒ³ã‚¯', 'opt_puz_left': 'å·¦ã«ãƒªãƒ³ã‚¯', 'opt_puz_right': 'å³ã«ãƒªãƒ³ã‚¯',
            'opt_shift_up': 'å°‘ã—ä¸Šã¸', 'opt_shift_down': 'å°‘ã—ä¸‹ã¸', 'opt_btm_exp': 'ä¸‹ã¸ãšã‚‰ã™', 'ph_rename': 'ã‚«ãƒ¼ãƒ‰å...', 'ph_note': 'ãƒ¡ãƒ¢...',
            'msg_storage_full': 'âš ï¸ ä¿å­˜é ˜åŸŸãŒã„ã£ã±ã„ã§ã™ã€‚ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚', 'msg_confirm_clear_storage': 'ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',
            'msg_cleared': 'ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚', 'msg_confirm_del_all': 'ã™ã¹ã¦ã®æ‰‹é †ã‚’å‰Šé™¤ã—ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ', 'msg_unsaved_draft': 'æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ç ´æ£„ã—ã¦æ–°ã—ã„æ‰‹é †ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ',
            'msg_unsaved_edit': 'æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ç ´æ£„ã—ã¦ã“ã®æ‰‹é †ã‚’ç·¨é›†ã—ã¾ã™ã‹ï¼Ÿ', 'msg_confirm_del_step': 'ã“ã®æ‰‹é †ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',
            'msg_confirm_p1_reset': 'P1ã®ç›¤é¢ã‚’ã‚¢ãƒ³ã‚¿ãƒƒãƒ—çŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ', 'msg_confirm_p2_reset': 'P2ã®ç›¤é¢ã‚’ã‚¢ãƒ³ã‚¿ãƒƒãƒ—çŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ',
            'msg_glow_err': 'åŠ¹æœå‡¦ç†ã‚¨ãƒªã‚¢ã®ã‚«ãƒ¼ãƒ‰ã®ã¿ç™ºå…‰è¨­å®šãŒå¯èƒ½ã§ã™ã€‚', 'msg_glow_ability_only': 'åŠ¹æœå‡¦ç†ã‚¨ãƒªã‚¢ã®ã‚«ãƒ¼ãƒ‰ã®ã¿ç™ºå…‰è¨­å®šãŒå¯èƒ½ã§ã™ã€‚',
            'msg_injured_err': 'ãƒãƒˆãƒ«ã‚¾ãƒ¼ãƒ³ã¾ãŸã¯ã‚·ãƒ¼ãƒ«ãƒ‰ã®ã‚«ãƒ¼ãƒ‰ã®ã¿è² å‚·çŠ¶æ…‹ã«ã§ãã¾ã™ã€‚', 'msg_select_one_copy': 'ã‚³ãƒ”ãƒ¼ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’1æšé¸æŠã—ã¦ãã ã•ã„ã€‚',
            'msg_select_one_point': 'å¯¾è±¡ã®ã‚«ãƒ¼ãƒ‰ã‚’1æšé¸æŠã—ã¦ãã ã•ã„ã€‚', 'msg_point_save_first': 'å¯¾è±¡é¸æŠã‚’çµ‚äº†ã™ã‚‹å‰ã«ã€ç¾åœ¨ã®æ‰‹é †ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚',
            'msg_mobile_blocked': 'ã“ã®æ©Ÿèƒ½ã¯ãƒ¢ãƒã‚¤ãƒ«ç«¯æœ«ã§ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚', 'msg_import_success': 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸï¼', 'msg_import_fail': 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—',
            'msg_confirm_import': 'ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ', 'msg_replace_img': 'ç”»åƒã‚’ç½®ãæ›ãˆã¾ã™ã‹ï¼Ÿ', 'msg_remove_img': 'ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',
            'msg_init_fail': 'åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ', 'msg_cannot_del_init': 'åˆæœŸçŠ¶æ…‹ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚', 'btn_cancel_draft': 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
            'msg_confirm_delete_all': 'ã™ã¹ã¦ã®æ“ä½œã‚’å‰Šé™¤ã—ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ', 'msg_confirm_reveal_close': 'å…¬é–‹é ˜åŸŸã‚’é–‰ã˜ã¦ã€ã‚«ãƒ¼ãƒ‰ã‚’å¢“åœ°ã«é€ã‚Šã¾ã™ã‹ï¼Ÿ',
            'msg_delete_card_confirm': 'é¸æŠã—ãŸã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ(åŠ¹æœå‡¦ç†ã‚¨ãƒªã‚¢æ¨å¥¨)', 'msg_confirm_point_zone': '{zone} ã‚’å¯¾è±¡ã«ã—ã¾ã™ã‹ï¼Ÿ',
            'msg_ability_cant_move': 'åŠ¹æœå‡¦ç†ä¸­ã®ã‚«ãƒ¼ãƒ‰ã¯ç§»å‹•ã§ãã¾ã›ã‚“ã€‚', 'msg_insert_pos_title': 'æŒ¿å…¥ä½ç½®ã‚’é¸æŠ (ç‚¹ç·šæ ã‚’ã‚¯ãƒªãƒƒã‚¯)',
            'msg_load_script_fail': 'ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ', 'btn_play_from': 'â–¶ ã“ã“ã‹ã‚‰å†ç”Ÿ', 'btn_play_step': 'ğŸ‘ï¸ ã“ã®æ‰‹é †ã‚’ç¢ºèª',
            'msg_editing_step': 'ğŸ“ æ‰‹é † #{n} ã‚’ç·¨é›†ä¸­',
			'msg_insert_after': 'â• æ‰‹é † #{n} ã®å¾Œã«è¿½åŠ ',
			'btn_edit_step': 'âœï¸ ç·¨é›†', 'btn_delete_step': 'ğŸ—‘ å‰Šé™¤', 'btn_play': 'â–¶', 'btn_pause': 'â¸ ä¸€æ™‚åœæ­¢',
            'lbl_reveal_zone': 'å…¬é–‹é ˜åŸŸ', 'lbl_action_log': 'è¡Œå‹•ãƒ­ã‚°', 'op_default': 'æ“ä½œ', 'op_count_suffix': ' ã‚¢ã‚¯ã‚·ãƒ§ãƒ³',
            'desc_end_reveal': 'å…¬é–‹çµ‚äº†', 'desc_end_point': 'é¸æŠçµ‚äº†', 'lbl_move': 'ç§»å‹•:', 'lbl_scale': 'ç¸®å°/æ‹¡å¤§:', 'btn_remove_img_short': 'âœ• ç”»åƒ',
            'title_stack_target': 'ã‚¹ã‚¿ãƒƒã‚¯æ“ä½œ: å¯¾è±¡ [{target}]', 'op_POINT': 'å¯¾è±¡é¸æŠ', 'op_ATTACK': 'æ”»æ’ƒå®£è¨€',
			'btn_multi_move': 'ğŸ“š è¤‡æ•°ç§»å‹•...',
            'btn_multi_confirm': 'âŒ å–æ¶ˆ / âœ… ä¸€æ‹¬ç§»å‹•',
            'msg_select_dest': '{n} æšé¸æŠä¸­ã€‚ç§»å‹•å…ˆã®ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚',	
			// ... (Original content) ...
            'act_glow_bottom': 'ğŸ‘‡ä¸‹ç™ºå…‰',
            'btn_swap_flip': 'ğŸ” P1/P2 ç”»åƒäº¤æ› & åè»¢',
            'lbl_swap_flip_hint': '* P1ã¨P2ã®ç«‹ã¡çµµã‚’å…¥ã‚Œæ›¿ãˆã€å·¦å³åè»¢ã—ã¾ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒã‚’é™¤ãï¼‰ã€‚',
            'msg_confirm_swap': 'ã™ã¹ã¦ã®ç”»åƒã‚’äº¤æ›ã—ã¦åè»¢ã—ã¾ã™ã‹ï¼Ÿ\n(æ³¨æ„ï¼šã“ã‚Œã¯å…¨ä½“ã«é©ç”¨ã•ã‚Œã€ã™ã¹ã¦ã®ä¼šè©±ã«å½±éŸ¿ã—ã¾ã™)',
            'msg_swap_done': 'äº¤æ›ã¨åè»¢ãŒå®Œäº†ã—ã¾ã—ãŸï¼',		
			'act_moonless': 'ğŸŒ‘ ç„¡æœˆã®é–€',	
			'btn_rps': 'âœŠâœŒï¸ğŸ–ï¸ ã˜ã‚ƒã‚“ã‘ã‚“',
            'act_rps': 'ã˜ã‚ƒã‚“ã‘ã‚“',
            'rps_rock': 'âœŠ ã‚°ãƒ¼',
            'rps_paper': 'ğŸ–ï¸ ãƒ‘ãƒ¼',
            'rps_scissors': 'âœŒï¸ ãƒãƒ§ã‚­',
            'rps_draw': 'ã‚ã„ã“ã§ã—ã‚‡ï¼',
            'rps_p1_win': 'P1 å‹åˆ©ï¼',
            'rps_p2_win': 'P2 å‹åˆ©ï¼',	
			'btn_effect': 'âš¡ ã‚«ãƒƒãƒˆã‚¤ãƒ³',
			'btn_bgm': 'ğŸµ BGM',
			'btn_trans': 'ğŸŒ ç¿»è¨³ (Trans)',
			'btn_about': 'â„¹ï¸ About',
			'title_theme_picker': 'P{n}ã®ãƒ†ãƒ¼ãƒè‰²ã‚’é¸æŠ',
			'msg_theme_opponent': 'ç›¸æ‰‹ãŒä½¿ç”¨ä¸­ã®è‰²ã¯é¸æŠã§ãã¾ã›ã‚“ã€‚',
			'title_bgm': 'ğŸµ BGMè¨­å®š',
			'msg_bgm_hint': 'ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©¦è´ã€ç¢ºèªãƒœã‚¿ãƒ³ã§é©ç”¨ã€‚',
			'opt_bgm_stop': 'ğŸ›‘ åœæ­¢ (Stop Music)',
			'btn_confirm': 'ğŸ’¾ æ±ºå®š',
			'title_trans': 'ğŸŒ ç¿»è¨³ãƒ„ãƒ¼ãƒ«',
			'msg_trans_desc': 'å°è©ã‚’JSONã§æŠ½å‡ºã—ã€AIç¿»è¨³å¾Œã«å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã¾ã™ã€‚',
			'btn_trans_export': 'ğŸ“¤ 1. å°è©å‡ºåŠ› (.json)',
			'msg_trans_hint': '(AIã«å€¤ã®ã¿ç¿»è¨³ã•ã›ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ç¶­æŒã—ã¦ãã ã•ã„)',
			'btn_trans_import': 'ğŸ“¥ 2. ç¿»è¨³èª­è¾¼ (.json)',
			'btn_close': 'é–‰ã˜ã‚‹',
			'title_credits': 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ',
			'title_import_conflict': 'å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ¤œå‡º',
			'msg_import_conflict': 'URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã‚ã‚Šã¾ã™ãŒã€æœªä¿å­˜ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚\nã©ã†ã—ã¾ã™ã‹ï¼Ÿ',
			'btn_conflict_cancel': 'âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ« (ãƒ­ãƒ¼ã‚«ãƒ«å„ªå…ˆ)',
			'btn_conflict_save': 'ğŸ’¾ ä¿å­˜ã—ã¦èª­è¾¼',
			'btn_conflict_overwrite': 'âš ï¸ ä¿å­˜ã›ãšèª­è¾¼',
			'title_select_script': 'ã‚·ãƒŠãƒªã‚ªé¸æŠ',
			'title_import_source': 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ƒã‚’é¸æŠ',
			'btn_local_file': 'ğŸ“‚ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ« (.txt/.json)',
			'lbl_or_examples': 'â–¼ ã‚µãƒ³ãƒ—ãƒ«ã‚·ãƒŠãƒªã‚ª â–¼',
			'lbl_no_script': 'åˆ©ç”¨å¯èƒ½ãªã‚·ãƒŠãƒªã‚ªãŒã‚ã‚Šã¾ã›ã‚“',
			'lbl_rb_style': 'ã‚¹ã‚¿ã‚¤ãƒ«:',
			'opt_rb_random': 'ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ',
			'opt_rb_center': 'âš¡ ä¸­å¤®å¼•ãè£‚ã',
			'opt_rb_tl': 'ğŸ“ å·¦ä¸Šã‹ã‚‰',
			'opt_rb_br': 'ğŸ“ å³ä¸‹ã‹ã‚‰',
			'opt_rb_pan_up': 'ğŸ”¼ ç·©ã‚„ã‹ã«ä¸Šæ˜‡ (Pan Up)',
			'opt_rb_pan_down': 'ğŸ”½ ç·©ã‚„ã‹ã«ä¸‹é™ (Pan Down)', // [æ–°å¢]
			'btn_preview': 'â–¶ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼',
			'btn_save': 'ğŸ’¾ ä¿å­˜',
			'msg_rb_hint': 'ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ Ctrl+V ã§ç”»åƒè²¼ã‚Šä»˜ã‘\n(ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ã€ãƒ›ã‚¤ãƒ¼ãƒ«ã§æ‹¡å¤§)',
			'msg_paste_img_hint': 'ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ã‹ã‚‰ Ctrl+V ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚',
			'msg_deck_empty': 'P{n} å±±æœ­åˆ‡ã‚Œ (Empty Deck)!',
			'msg_dialog_exclusive': 'ä¼šè©±ã‚¤ãƒ™ãƒ³ãƒˆã¯ä»–ã®æ“ä½œã¨æ··åˆã§ãã¾ã›ã‚“ã€‚',
			'msg_finish_edit_first': 'ç¾åœ¨ã®ç·¨é›†ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚',
			'msg_no_dialog': 'ä¼šè©±ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼',
			'msg_trans_result': 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸï¼ {n} ç®‡æ‰€ã®ä¼šè©±ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚',
			'msg_trans_fail_fmt': 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒç„¡åŠ¹ã§ã™ã€‚',
			'msg_select_rotate': 'å›è»¢ã•ã›ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚',
			'msg_rps_again': 'ã˜ã‚ƒã‚“ã‘ã‚“ã‚’ç¶šã‘ã¾ã™ã‹ï¼Ÿ',
			'msg_confirm_load_script': 'ã‚·ãƒŠãƒªã‚ªã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿï¼š\nã€Œ{title}ã€\n(æœªä¿å­˜ã®é€²è¡ŒçŠ¶æ³ã¯å¤±ã‚ã‚Œã¾ã™)',
			'msg_p1_win': 'P1 WIN!',
			'msg_p2_win': 'P2 WIN!',
			'msg_congrats': 'Congratulations!',
			'desc_rb': '[æ¼”å‡º] æ¬¡å…ƒæ–­è£‚ (Reality Break)',
			'desc_bgm_play': '[BGM] å†ç”Ÿ {name}',
			'desc_bgm_stop': '[BGM] åœæ­¢',
			'desc_dialogue': '[ä¼šè©±]',		
			'msg_editing_placeholder': '... ç·¨é›†ä¸­ (Editing) ...',	
			'lbl_rb_shake_in': 'ğŸ«¨ å…§æºã‚Œ (In)',
			'lbl_rb_shake_out': 'ğŸ«¨ å¤–æºã‚Œ (Out)',
			'lbl_rb_intensity': 'è£‚ã‘ç›®:',
			'msg_truncate_confirm': 'âš ï¸ å±é™ºãªæ“ä½œ âš ï¸\n\nã“ã“ (Step #{n}) ã‹ã‚‰å¾Œã®ã™ã¹ã¦ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',
			'msg_truncate_backup': 'ã“ã®æ“ä½œã¯å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚å…ˆã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ\n\n(OK = ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦å‰Šé™¤, ã‚­ãƒ£ãƒ³ã‚»ãƒ« = ãã®ã¾ã¾å‰Šé™¤)',
			'btn_random_pick': 'ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ',
			'msg_turn_change': "{player} ã®ã‚¿ãƒ¼ãƒ³ã¸",
			
			// --- Context Menu & Deck Modal ---
			ctx_shuffle: "ğŸ”„ ã‚·ãƒ£ãƒƒãƒ•ãƒ«",
			ctx_move: "â¡ï¸ ç§»å‹•...",
			ctx_recall: "ğŸ”™ å…¨ã¦å›å",
			ctx_close: "âœ– ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹",

			title_move_modal: "å±±æœ­ã®ä¸Šã‹ã‚‰ç§»å‹•",
			lbl_qty: "æšæ•°:",
			lbl_dest: "ç§»å‹•å…ˆ:",
			btn_do_move: "ç§»å‹•å®Ÿè¡Œ",

			dest_hand: "âœ‹ æ‰‹æœ­",
			dest_mana: "ğŸ’§ ãƒãƒŠã‚¾ãƒ¼ãƒ³",
			dest_shield: "ğŸ›¡ï¸ ã‚·ãƒ¼ãƒ«ãƒ‰",
			dest_grave: "ğŸ’€ å¢“åœ°",
			dest_battle: "âš”ï¸ ãƒãƒˆãƒ«ã‚¾ãƒ¼ãƒ³",
			dest_hyper: "ğŸŒ€ è¶…æ¬¡å…ƒ",
			dest_abyss: "ğŸŒ‘ ã‚¢ãƒ“ã‚¹",
			dest_reveal: "ğŸ‘ï¸ å…¬é–‹é ˜åŸŸ",

			msg_confirm_recall: "{player} ã®ã‚«ãƒ¼ãƒ‰ï¼ˆæ‰‹æœ­ãƒ»å ´ãƒ»å¢“åœ°ãªã©ï¼‰ã‚’å…¨ã¦å±±æœ­ã«æˆ»ã—ã¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã™ã‹ï¼Ÿ",
			msg_no_recall_cards: "å›åã™ã‚‹ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚",
			log_blind_move: "[å±±æœ­ç§»å‹•]",
			log_recall: "[ãƒªã‚»ãƒƒãƒˆ] å…¨å›å",
		}
	};
	
	// --- [æ–°å¢] ç¿»è­¯ ---
	if (typeof TRANSLATIONS !== 'undefined') {
		if(TRANSLATIONS.zh) TRANSLATIONS.zh.btn_check_unseen = 'ğŸ‘ï¸â€ğŸ—¨ï¸ æœªè¦‹';
		if(TRANSLATIONS.en) TRANSLATIONS.en.btn_check_unseen = 'ğŸ‘ï¸â€ğŸ—¨ï¸ Unseen';
		if(TRANSLATIONS.jp) TRANSLATIONS.jp.btn_check_unseen = 'ğŸ‘ï¸â€ğŸ—¨ï¸ æœªè¦‹';
		TRANSLATIONS.zh['zone_abyss'] = 'æ·±æ·µå€';
		TRANSLATIONS.en['zone_abyss'] = 'Abyss';
		TRANSLATIONS.jp['zone_abyss'] = 'æ·±æ·µ';
	}

	// --- [æ–°å¢] å…¨åŸŸè®Šæ•¸ ---
	let globalSeenCardIds = new Set(); // å„²å­˜æ‰€æœ‰ã€Œå·²è¦‹éã€çš„å¡ç‰‡ ID
	let isUnseenHighlightOn = false;   // æ¨™è¨˜æ˜¯å¦é–‹å•Ÿé«˜äº®æ¨¡å¼

    let currentLang = 'zh';
	
	// --- [æ–°å¢] æ“ä½œé¢æ¿ä½ç½®è¨˜æ†¶è®Šæ•¸ ---
    // é è¨­å€¼ï¼šP1 åœ¨ä¸Šé¢ (Top: 15%)ï¼ŒP2 åœ¨ä¸‹é¢ (Top: 80%)ï¼Œæ°´å¹³å¤§è‡´ç½®ä¸­
    let panelPosSettings = {
        p1: { x: window.innerWidth / 2 - 200, y: window.innerHeight * 0.8 }, 
        p2: { x: window.innerWidth / 2 - 200, y: window.innerHeight * 0.15 } 
    };
    let currentPanelOwner = 'p1'; // è¨˜éŒ„ç›®å‰æ˜¯èª°çš„é¢æ¿

    // --- [æ–°å¢] åˆå§‹åŒ–æ‹–æ›³åŠŸèƒ½ ---
    function initDraggablePanel() {
        const panel = document.getElementById('card-action-panel');
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };

        panel.addEventListener('mousedown', (e) => {
            // å¦‚æœé»æ“Šçš„æ˜¯æŒ‰éˆ•æˆ–è¼¸å…¥æ¡†ï¼Œä¸è§¸ç™¼æ‹–æ›³
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
            
            isDragging = true;
            // è¨ˆç®—æ»‘é¼ é»æ“Šé»èˆ‡é¢æ¿å·¦ä¸Šè§’çš„åç§»é‡
            const rect = panel.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            
            // è¦–è¦ºå›é¥‹ï¼šç¨å¾®è®Šé€æ˜
            panel.style.opacity = '0.8';
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault(); // é˜²æ­¢é¸å–æ–‡å­—
            
            // è¨ˆç®—æ–°ä½ç½®
            let newX = e.clientX - dragOffset.x;
            let newY = e.clientY - dragOffset.y;

            // é‚Šç•Œæª¢æŸ¥ (é˜²æ­¢æ‹–å‡ºè¢å¹•)
            const panelW = panel.offsetWidth;
            const panelH = panel.offsetHeight;
            const maxW = window.innerWidth - panelW;
            const maxH = window.innerHeight - panelH;

            if (newX < 0) newX = 0;
            if (newY < 0) newY = 0;
            if (newX > maxW) newX = maxW;
            if (newY > maxH) newY = maxH;

            // å¥—ç”¨ä½ç½®
            panel.style.left = newX + 'px';
            panel.style.top = newY + 'px';
        });

        window.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                panel.style.opacity = '1'; // æ¢å¾©ä¸é€æ˜
                
                // [é—œéµ] æ‹–æ›³çµæŸå¾Œï¼Œè¨˜æ†¶ç•¶å‰æ“æœ‰è€…çš„ä½ç½®
                const rect = panel.getBoundingClientRect();
                panelPosSettings[currentPanelOwner] = { x: rect.left, y: rect.top };
            }
        });
        
        // è¦–çª—ç¸®æ”¾æ™‚é‡æ–°æ ¡æ­£ç½®ä¸­ (é¸ç”¨)
        window.addEventListener('resize', () => {
             panelPosSettings.p1.x = window.innerWidth / 2 - 300;
             panelPosSettings.p2.x = window.innerWidth / 2 - 300;
             // Y è»¸ä¿æŒæ¯”ä¾‹
             panelPosSettings.p1.y = window.innerHeight * 0.15;
             panelPosSettings.p2.y = window.innerHeight * 0.8;
        });
    }

    // è«‹å‹™å¿…åœ¨ window.onload è£¡é¢å‘¼å« initDraggablePanel();
	
	// --- [æ–°å¢] BGM è¨­å®š ---
    const BGM_FOLDER = 'bgm/'; // è«‹ç¢ºä¿æ‚¨çš„ bgm è³‡æ–™å¤¾åœ¨æ ¹ç›®éŒ„
    const BGM_FILES = [
        'heightenedAlert.mp3',
        'SpeedKing.mp3',
        'TheGodsTrial.mp3',
        'Edgy.mp3',
        'Village.mp3',
        'Mischievous.mp3',
		"Tutorial.mp3",
		"SpaceFactory.mp3",
		"UnderWorld.mp3",
        'Battle01.mp3',
        'Battle02.mp3',
        'Battle03.mp3',
		"Battle15.mp3",
		"Battle20.mp3",
        'BattleLastBoss01.mp3',
    ];
    
    // å…¨åŸŸéŸ³æ¨‚æ’­æ”¾ç‰©ä»¶
    const globalAudioPlayer = new Audio();
    globalAudioPlayer.loop = true; // BGM é€šå¸¸éœ€è¦å¾ªç’°
    
    // é è¦½ç”¨çš„æ’­æ”¾ç‰©ä»¶ (é¿å…å¹²æ“¾ä¸»æ’­æ”¾å™¨)
    const previewAudioPlayer = new Audio();

    // åŒæ™‚ä¿®æ”¹ getPlayButtonText åˆ¤å®š
    function getPlayButtonText() { return playTimeout ? t('btn_pause') : t('btn_play'); }
    // --- [æ•´åˆç‰ˆ] æ›´æ–°æ’­æ”¾æŒ‰éˆ• UI (åŒæ™‚è™•ç†æ¡Œæ©Ÿèˆ‡æ‰‹æ©Ÿ) ---
    function updatePlayButtonUI() {
        const isPlaying = !!playTimeout; // è½‰ç‚ºå¸ƒæ—å€¼
        const text = isPlaying ? t('btn_pause') : t('btn_play');
        const icon = isPlaying ? "â¸" : "â–¶";

        // 1. æ›´æ–°æ¡Œæ©Ÿç‰ˆæŒ‰éˆ•
        const deskBtn = document.getElementById('btn-play');
        if (deskBtn) deskBtn.innerText = text;

        // 2. æ›´æ–°æ‰‹æ©Ÿç‰ˆæŒ‰éˆ•
        const mobBtn = document.getElementById('mob-play-btn');
        if (mobBtn) mobBtn.innerText = icon;
    }
	
	// [æ–°å¢] æ’­æ”¾é€Ÿåº¦å› å­ (é è¨­ 1.0)
	let currentSpeedFactor = 1.0;

	// --- [ä¿®æ”¹] changePlaybackSpeed å‡½å¼ --
	function changePlaybackSpeed(val) {
		currentSpeedFactor = parseFloat(val);

		// [æ–°å¢] åŒæ­¥å…©å€‹é¸å–®çš„é¡¯ç¤ºç‹€æ…‹
		// é€™æ¨£ç„¡è«–æ˜¯ç”¨é›»è…¦ç‰ˆé‚„æ˜¯æ‰‹æ©Ÿç‰ˆæ“ä½œï¼Œå¦ä¸€é‚Šéƒ½æœƒè·Ÿè‘—è®Š
		const deskSelect = document.getElementById('speed-select');
		const mobSelect = document.getElementById('mob-speed-select');
		
		if (deskSelect) deskSelect.value = val;
		if (mobSelect) mobSelect.value = val;
	}
	
	// --- [è£œå›éºå¤±çš„å‡½å¼] å–å¾—èˆ‡é¸å–å¡ç‰‡æœ‰é€£çµé—œä¿‚çš„æ‰€æœ‰å¡ç‰‡ ID (å®¶æ—æ¨¹æœå°‹) ---
    function getAllLinkedCardIds(state, initialIds) {
        const resultIds = new Set(initialIds);
        
        // è¼”åŠ©ï¼šæ‰¾æŸå¼µå¡çš„ Parent (å¾€ä¸Šæ‰¾)
        const getParent = (id) => state.cards.find(c => c.id === id);
        
        // è¼”åŠ©ï¼šæ‰¾æŸå¼µå¡çš„ Children (å¾€ä¸‹æ‰¾)
        const getChildren = (parentId) => state.cards.filter(c => c.parentId === parentId);

        // å°æ¯ä¸€å€‹é¸å–çš„ ID é€²è¡Œæ“´æ•£æœå°‹
        initialIds.forEach(startId => {
            let current = state.cards.find(c => c.id === startId);
            if (!current) return;

            // 1. å‘ä¸Šæº¯æºï¼šæ‰¾åˆ°æœ€é ‚å±¤/æœ€åº•å±¤çš„ Root (æ²’æœ‰ parentId çš„é‚£å¼µ)
            let root = current;
            while (root.parentId) {
                const p = getParent(root.parentId);
                if (!p) break; // é˜²å‘†
                root = p;
            }

            // 2. å‘ä¸‹æ“´æ•£ï¼šå¾ Root é–‹å§‹ï¼ŒæŠŠæ‰€æœ‰å­å­«å…¨éƒ¨åŠ å…¥
            const stack = [root];
            while (stack.length > 0) {
                const node = stack.pop();
                resultIds.add(node.id);
                
                const children = getChildren(node.id);
                children.forEach(child => stack.push(child));
            }
        });

        return Array.from(resultIds);
    }
	
    function changeLanguage(lang) {
        currentLang = lang;
        const dict = TRANSLATIONS[lang];
        if (!dict) return;

        // 1. æ›´æ–°ä¸€èˆ¬æ¨™ç±¤ (innerText / value)
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (dict[key]) {
                if (el.tagName === 'INPUT' && el.type === 'button') {
                    el.value = dict[key];
                } else {
                    // ä½¿ç”¨ innerText æœƒè¦†è“‹æ‰å­å…ƒç´ ï¼Œè‹¥åªæ˜¯ç´”æ–‡å­—æ›¿æ›é€™æœ€å®‰å…¨
                    // å°æ–¼æœ‰æ›è¡Œç¬¦è™Ÿ (\n) çš„ç¿»è­¯ï¼Œå¯ä»¥ç”¨ innerText è‡ªå‹•è™•ç†æ›è¡Œ
                    el.innerText = dict[key]; 
                }
            }
        });
        
        // 2. æ›´æ–° Placeholder (è¼¸å…¥æ¡†æç¤º)
        document.querySelectorAll('[data-i18n-ph]').forEach(el => {
            const key = el.getAttribute('data-i18n-ph');
            if (dict[key]) {
                el.placeholder = dict[key];
            }
        });

        // 3. æ›´æ–° Play æŒ‰éˆ•
        updatePlayButtonUI();

        // 4. é‡ç¹ª Timeline (æŒ‰éˆ•æ‰æœƒè®Šæ›èªè¨€)
        renderTimeline();
        
        // 5. å…¶ä»–å‹•æ…‹ä»‹é¢æ›´æ–°
        if (isDrafting) updateDraftBar();
        if (isPointing) updatePointInfo();
    }
    
    // è¼”åŠ©å‡½å¼ï¼šçµ¦ JS å…§éƒ¨ä½¿ç”¨çš„ç¿»è­¯
    function t(key) {
        return (TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang][key]) ? TRANSLATIONS[currentLang][key] : key;
    }

    class Card {
        constructor(id, ownerId, text, zone) {
            this.id = id;
            this.ownerId = ownerId;
            this.text = text;
            this.zone = zone;
            this.faceUp = false;
            this.rotation = 0; 
            this.power = 0;
            this.image = null;
            this.isHyper = false;
            this.glow = null; 
            this.parentId = null; 
            this.stackType = null; // top, bottom, shift_up, puzzle_right, etc.
            this.note = "";
            this.imageKey = 'img_' + id;
            this.backImageKey = 'img_back_' + id;
            this.sourceId = null; // New: Link to source card (for Ability cards)
        }
    }
	
	// --- [å–ä»£] toggleAceSilent å‡½å¼ ---
	function toggleAceSilent(cardId, isAce) {
		if (isAce) {
			globalAceRegistry[cardId] = true;
		} else {
			delete globalAceRegistry[cardId];
		}

		// åªéœ€é‡ç¹ªç•¶å‰ç•«é¢ï¼Œä¸ç”¨å‹•æ­·å²ç´€éŒ„
		renderUI(true); 
		if(!document.body.classList.contains('mobile-mode')) saveToStorage();
	}

	// --- [æ–°å¢] ä¸»é¡Œé¡è‰²å®šç¾© ---
    const THEME_PALETTE = {
        red:    { main: '#e53935', bg: '#f9ebe7', name: 'ç†±è¡€ç´…' },
        orange: { main: '#e67e22', bg: '#fdf2e9', name: 'æ´»åŠ›æ©™' },
        yellow: { main: '#f1c40f', bg: '#fef9e7', name: 'é–ƒè€€é»ƒ' },
        teal:   { main: '#1abc9c', bg: '#e8f8f5', name: 'é’ç¶ è‰²' },
        olive:  { main: '#6b8e23', bg: '#f4f6f0', name: 'è»ç¶ è‰²' }, // Olive Drab
        blue:   { main: '#3498db', bg: '#e3f2fd', name: 'å†·éœè—' },
		purple: { main: '#9b59b6', bg: '#f4ecf7', name: 'ç¥ç§˜ç´«' },
        black:  { main: '#2c3e50', bg: '#eaeded', name: 'æ·±æ²‰é»‘' },
        white:  { main: '#95a5a6', bg: '#f7f9f9', name: 'ç´”æ½”ç™½' }, // ä½¿ç”¨ç°éŠ€è‰²ä»£æ›¿ç´”ç™½ä»¥é¡¯ç¤ºé‚Šæ¡†
		pink:   { main: '#e91e63', bg: '#fce4ec', name: 'é­…å½±ç²‰' },   // æ–°å¢
        indigo: { main: '#3f51b5', bg: '#e8eaf6', name: 'æ·±é‚ƒè—' },   // æ–°å¢
        emerald:{ main: '#2ecc71', bg: '#eafaf1', name: 'ç¿¡ç¿ ç¶ ' },   // æ–°å¢
    };

    // å…¨åŸŸè¨­å®š (é è¨­å€¼)
    let globalThemeSettings = { p1: 'blue', p2: 'red' };

    // 1. å¥—ç”¨é¡è‰²è®Šæ•¸åˆ° CSS
    function applyThemeVariables() {
        const root = document.documentElement;
        
        const p1 = THEME_PALETTE[globalThemeSettings.p1] || THEME_PALETTE.blue;
        const p2 = THEME_PALETTE[globalThemeSettings.p2] || THEME_PALETTE.red;

        root.style.setProperty('--p1-main', p1.main);
        root.style.setProperty('--p1-bg', p1.bg);
        
        root.style.setProperty('--p2-main', p2.main);
        root.style.setProperty('--p2-bg', p2.bg);
    }

    // 2. é–‹å•Ÿé¸æ“‡å™¨
    let currentPickingPlayer = 0; // 1 or 2

    function openThemePicker(playerId) {
        // å¦‚æœæ˜¯æ‰‹æ©Ÿç‰ˆï¼Œä¸å…è¨±é»æ“Š (å› ç‚ºæ‰‹æŒ‡å®¹æ˜“èª¤è§¸)
        if (document.body.classList.contains('mobile-mode')) return;

        currentPickingPlayer = playerId;
        const modal = document.getElementById('theme-picker-modal');
        const grid = document.getElementById('theme-color-grid');
        const title = document.getElementById('theme-picker-title');
        
        title.innerText = t('title_theme_picker').replace('{n}', playerId);
        grid.innerHTML = '';

        // å–å¾—å°æ‰‹ç”¨çš„é¡è‰² (éœ€è¦è¢«åœç”¨)
        const opponentColor = playerId === 1 ? globalThemeSettings.p2 : globalThemeSettings.p1;
        const myColor = playerId === 1 ? globalThemeSettings.p1 : globalThemeSettings.p2;

        Object.keys(THEME_PALETTE).forEach(key => {
            const colorData = THEME_PALETTE[key];
            const div = document.createElement('div');
            div.className = 'color-swatch';
            div.style.backgroundColor = colorData.main;
            div.title = colorData.name;

            // ç‹€æ…‹åˆ¤æ–·
            if (key === opponentColor) {
                div.classList.add('disabled');
                div.title += " (å°æ‰‹å·²ä½”ç”¨)";
            } else {
                div.onclick = () => selectThemeColor(key);
            }

            if (key === myColor) {
                div.classList.add('active');
            }

            grid.appendChild(div);
        });

        modal.style.display = 'flex';
    }

    function closeThemePicker() {
        document.getElementById('theme-picker-modal').style.display = 'none';
    }

    function selectThemeColor(colorKey) {
        if (currentPickingPlayer === 1) {
            globalThemeSettings.p1 = colorKey;
        } else {
            globalThemeSettings.p2 = colorKey;
        }

        applyThemeVariables();
        closeThemePicker();
        
        // è®Šæ›´è¨­å®šå¾Œï¼Œè‡ªå‹•å­˜æª” (æ›´æ–° core data)
        saveToStorage();
    }
	
    class GameState {
        constructor() {
            this.cards = [];
            this.turnPlayer = 1;
            // Removed phase per requirement
            this.globalRotation = false; 
            this.cardIdCounter = 1;
			this.dialogueData = null; // æ ¼å¼: { p1: {...}, p2: {...} }
			// [æ–°å¢] BGM ç‹€æ…‹ (null ä»£è¡¨åœæ­¢/ç„¡éŸ³æ¨‚)
            this.bgm = null;

			// [æ–°å¢] ç„¡æœˆä¹‹é–€ç‹€æ…‹ (å­˜æ–¼ State å…§)
			// æ ¼å¼: { cardId: true, ... }
			this.moonless = {};
			// [æ–°å¢] çŒœæ‹³çµæœ (ç”¨æ–¼é¡¯ç¤º UI)
			this.rpsResult = null; // { p1: 'rock', p2: 'scissors', winner: 1 }
        }
    }

    class Action {
        constructor(description) {
            this.id = Date.now() + Math.random();
            this.description = description;
            this.operations = []; 
        }
    }

    let history = [];
    let currentIndex = -1;
    let initialState = null;
    let isDrafting = false;
    let draftOperations = []; 
    let insertIndex = -1; 
    let tempState = null; 
    let selectedCardsInModal = []; 
    let pendingMove = null; 
	// [æ–°å¢] ç”¨æ–¼é˜²æ­¢é•·æŒ‰å¾Œè‡ªå‹•å–æ¶ˆé¸å–çš„é˜²å‘†è®Šæ•¸
    let ignoreClickId = null;
    let playInterval = null;
    let lastRenderedState = null;
    let editModeType = 'INSERT';
    
    let isPointing = false;
    let pointerId = null;
	let forceNewStep = false;
    let pointTargets = []; 
    let currentStackTargetId = null;
	
	// [æ–°å¢] å¤šé‡é¸å–æ¨¡å¼è®Šæ•¸
    let isMultiSelectMode = false;
    let multiSelectedIds = [];
	
	let lastAnimatedStep = -1; // [è£œä¸Šé€™è¡Œ] ç”¨æ–¼è¨˜éŒ„å‹•ç•«ç‹€æ…‹ï¼Œé¿å…é‡è¤‡æ’­æ”¾
	let winOverlayTimeout = null; // [æ–°å¢] ç”¨ä¾†è¨˜éŒ„å‹åˆ©ç•«é¢çš„è‡ªå‹•é—œé–‰è¨ˆæ™‚å™¨
	
    let globalImageRegistry = {}; 
	// [æ–°å¢] å…¨åŸŸç‹ç‰Œè¨»å†Šè¡¨ (åªå­˜ IDï¼Œä¸å­˜å¡ç‰‡ç‰©ä»¶)
	// æ ¼å¼: { cardId: true, ... }
	let globalAceRegistry = {};
    let globalAbilityStyleRegistry = {}; 
    let storageQuotaExceeded = false; 
    let hasAlertedQuota = false;    
    let pendingImportData = null;
	let globalLastUsedStyles = {}; // [æ–°å¢] ç”¨ä¾†è¨˜éŒ„æ¯å¼µåœ–ç‰‡æœ€å¾Œä¸€æ¬¡ä½¿ç”¨çš„æ¨£å¼

    const STORAGE_KEY = 'dm_editor_data_v1'; // Updated Key
    const STORAGE_EXPIRY = 7 * 24 * 60 * 60 * 1000; 

	document.addEventListener('keydown', (e) => {
		// 1. è™•ç† Ctrl+Z (å¾©åŸ)
		if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') {
			e.preventDefault(); // é˜»æ­¢ç€è¦½å™¨é è¨­è¡Œç‚º

			if (isDrafting) {
				// æƒ…å¢ƒ A: æ­£åœ¨ç·¨è¼¯ä¸­ -> é‚„åŸç·¨è¼¯çš„å‹•ä½œ (ä¾‹å¦‚ç§»å‹•å¡ç‰‡ã€è²¼åœ–)
				undoLastDraftOp();
			} else {
				// æƒ…å¢ƒ B: éç·¨è¼¯æ¨¡å¼ -> åŸ·è¡Œå…¨åŸŸå¾©åŸ (é‚„åŸåˆªé™¤æ­¥é©Ÿã€æ–°å¢æ­¥é©Ÿ)
				performGlobalUndo();
			}
			return;
		}

		// [æ–°å¢] 2. è™•ç† Ctrl+S (å„²å­˜æ­¤æ­¥)
		// æ¢ä»¶ï¼šæ­£åœ¨ç·¨è¼¯(isDrafting) ä¸” æœ‰ç·¨è¼¯å…§å®¹(draftOperations.length > 0)
		if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
			e.preventDefault(); // é˜»æ­¢ç€è¦½å™¨é è¨­çš„ç¶²é å­˜æª”
			if (isDrafting && draftOperations.length > 0) {
				saveDraft(); // åŸ·è¡Œå„²å­˜
				return;
			}
		}

		// 3. è™•ç† ESC (å–æ¶ˆ/é—œé–‰è¦–çª—)
		if (e.key === 'Escape') {
			const cardModal = document.getElementById('card-selector-modal');
			const posModal = document.getElementById('position-selector-modal');
			const diagModal = document.getElementById('dialogue-modal');
			const setupModal = document.getElementById('setup-modal');

			if (posModal && posModal.style.display === 'flex') closePositionModal();
			else if (cardModal && cardModal.style.display === 'flex') closeSelectorModal();
			else if (diagModal && diagModal.style.display === 'flex') diagModal.style.display = 'none';
			else if (setupModal && setupModal.style.display === 'flex') setupModal.style.display = 'none';
			else if (isPointing) cancelPointMode();
			else cancelSelection();
		}
	});

	// [æ–°å¢] æŠ½ç‰ŒåŠŸèƒ½å‡½å¼
	function actionDrawCard() {
		// 1. å–å¾—ç•¶å‰ç‹€æ…‹èˆ‡å›åˆç©å®¶
		const state = getCurrentDisplayState();
		const pid = state.turnPlayer; // 1 æˆ– 2
		
		// 2. å®šç¾©ä¾†æº(ç‰Œåº«)èˆ‡ç›®æ¨™(æ‰‹ç‰Œ)
		const deckId = `p${pid}-deck`;
		const handId = `p${pid}-hand`;

		// 3. æª¢æŸ¥ç‰Œåº«æ˜¯å¦æœ‰ç‰Œ
		// æ³¨æ„ï¼šfilter å‡ºä¾†çš„é™£åˆ—é †åºï¼Œæœ€å¾Œä¸€å¼µ (length-1) é€šå¸¸è¦–ç‚ºç‰Œåº«é ‚ (Top)
		const deckCards = state.cards.filter(c => c.zone === deckId);
		
		if (deckCards.length === 0) {
			alert(t('msg_deck_empty').replace('{n}', pid));
			return;
		}

		// 4. å–å‡ºç‰Œåº«é ‚çš„ä¸€å¼µç‰Œ
		const topCard = deckCards[deckCards.length - 1];

		// 5. å¦‚æœç›®å‰ä¸åœ¨ç·¨è¼¯æ¨¡å¼ï¼Œè‡ªå‹•é–‹å•Ÿæ–°æ­¥é©Ÿ (è®“é€™å€‹å‹•ä½œè¢«è¨˜éŒ„)
		if (!isDrafting) startDraftAtEnd();

		// 6. åŸ·è¡Œç§»å‹•å‹•ä½œ (ä½¿ç”¨ MOVE é¡å‹)
		addOperation({
			type: 'MOVE',
			cardIds: [topCard.id],
			toZone: handId,
			faceUp: true, // æ‰‹ç‰Œå°ç©å®¶ä¾†èªªæ˜¯å¯è¦‹çš„
			shuffleSelection: false
		});
	}
	
	// --- [æ–°å¢] å…¨åŸŸå¾©åŸç³»çµ± (Global Undo) ---
	const MAX_GLOBAL_UNDO = 8; // æœ€å¤§å¾©åŸæ­¥æ•¸é™åˆ¶
	let globalUndoStack = [];  // å­˜æ”¾æ­·å²å¿«ç…§

	// å»ºç«‹å¿«ç…§ (åœ¨åŸ·è¡Œç ´å£æ€§æ“ä½œå‰å‘¼å«)
	function takeGlobalSnapshot() {
		// 1. æ·±æ‹·è²ç›®å‰çš„ history èˆ‡ currentIndex
		// æ³¨æ„ï¼šé€™è£¡åªå‚™ä»½é‚è¼¯çµæ§‹ï¼Œä¸å‚™ä»½åœ–ç‰‡åº« (åœ–ç‰‡åº«æ˜¯å…¨åŸŸçš„ï¼Œä¸éœ€è¦é‚„åŸ)
		const snapshot = {
			history: JSON.parse(JSON.stringify(history)),
			currentIndex: currentIndex,
			// å¦‚æœæœ‰å…¶ä»–é—œéµç‹€æ…‹(å¦‚ BGM ç‹€æ…‹)ä¹Ÿå¯ä»¥å­˜ï¼Œä½† history è£¡é¢å·²ç¶“åŒ…å«äº† state
		};

		// 2. æ¨å…¥å †ç–Š
		globalUndoStack.push(snapshot);

		// 3. ç¶­æŒæœ€å¤§æ•¸é‡é™åˆ¶ (è¶…é 8 æ­¥å°±ç§»é™¤æœ€èˆŠçš„)
		if (globalUndoStack.length > MAX_GLOBAL_UNDO) {
			globalUndoStack.shift(); // ç§»é™¤é™£åˆ—ç¬¬ä¸€å€‹å…ƒç´  (æœ€èˆŠçš„)
		}
	}

	// åŸ·è¡Œå…¨åŸŸå¾©åŸ
	function performGlobalUndo() {
		if (globalUndoStack.length === 0) {
			console.log("æ²’æœ‰å¯å¾©åŸçš„å‹•ä½œ");
			return;
		}

		// 1. å–å‡ºæœ€æ–°çš„å¿«ç…§
		const snapshot = globalUndoStack.pop();

		// 2. é‚„åŸè³‡æ–™
		history = snapshot.history;
		currentIndex = snapshot.currentIndex;

		// 3. é‡ç¹ªä»‹é¢
		renderUI(true); // true = è·³éæ²å‹• (ç¨å¾Œæ‰‹å‹•æ²)
		saveToStorage(); // å­˜æª”ä»¥ç¢ºä¿ç‹€æ…‹åŒæ­¥

		// 4. UX å„ªåŒ–ï¼šæ²å‹•åˆ°ç•¶å‰æ­¥é©Ÿ
		setTimeout(() => scrollToActiveStep(), 50);
		
		// æç¤º
		const hint = document.getElementById('draft-mode-hint'); // å€Ÿç”¨ä¸€ä¸‹æç¤ºæ¬„
		if(hint) {
			const originalText = hint.innerText;
			hint.innerText = "â†©ï¸ å·²å¾©åŸä¸Šä¸€æ­¥";
			hint.style.opacity = 1;
			setTimeout(() => hint.innerText = originalText, 1500);
		}
	}

	document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') {
            if (isDrafting) {
                e.preventDefault(); 
                undoLastDraftOp();
                return;
            }
        }
		// [æ–°å¢] Ctrl + ä¸Šä¸‹éµï¼šå¿«é€Ÿè·³è½‰è‡³ ä¸Šä¸€å€‹/ä¸‹ä¸€å€‹ å°è©± (Dialogue)
		if ((e.ctrlKey || e.metaKey) && (e.key === 'ArrowUp' || e.key === 'ArrowDown')) {
			e.preventDefault();

			// å®‰å…¨æª¢æŸ¥ï¼šå¦‚æœæ­£åœ¨ç·¨è¼¯ä¸”æœ‰æœªå„²å­˜å…§å®¹ï¼Œå…ˆè©¢å•
			if (isDrafting && draftOperations.length > 0) {
				if (!confirm(t('msg_unsaved_draft'))) return;
			}

			const direction = e.key === 'ArrowUp' ? -1 : 1;
			let targetIndex = -1;

			if (direction === -1) {
				// å¾€ä¸Šæ‰¾ (Previous)
				for (let i = currentIndex - 1; i >= 0; i--) {
					const ops = history[i].action.operations;
					if (ops && ops.some(o => o.type === 'DIALOGUE')) {
						targetIndex = i;
						break;
					}
				}
			} else {
				// å¾€ä¸‹æ‰¾ (Next)
				for (let i = currentIndex + 1; i < history.length; i++) {
					const ops = history[i].action.operations;
					if (ops && ops.some(o => o.type === 'DIALOGUE')) {
						targetIndex = i;
						break;
					}
				}
			}

			// å¦‚æœæ‰¾åˆ°äº†ç›®æ¨™
			if (targetIndex !== -1) {
				// å¼·åˆ¶é€€å‡ºç·¨è¼¯æ¨¡å¼ (å¦‚æœæœ‰çš„è©±)
				if (isDrafting) cancelDraft();

				currentIndex = targetIndex;
				
				// åŸ·è¡Œè·³è½‰
				renderUI();
				if (!document.body.classList.contains('mobile-mode')) saveToStorage();
				
				// UX å„ªåŒ–ï¼šè‡ªå‹•æ²å‹•åˆ—è¡¨åˆ°è©²ä½ç½®
				scrollToActiveStep();
			}
			return;
		}
        if (e.key === 'Escape') {
            const cardModal = document.getElementById('card-selector-modal');
            const posModal = document.getElementById('position-selector-modal');
            const diagModal = document.getElementById('dialogue-modal');
            const setupModal = document.getElementById('setup-modal'); // [æ–°å¢]
            
            if (posModal && posModal.style.display === 'flex') closePositionModal();
            else if (cardModal && cardModal.style.display === 'flex') closeSelectorModal();
            else if (diagModal && diagModal.style.display === 'flex') diagModal.style.display = 'none';
            else if (setupModal && setupModal.style.display === 'flex') setupModal.style.display = 'none'; // [æ–°å¢]
            else if (isPointing) cancelPointMode();
            else cancelSelection();
        }
    });
	
	// --- [æ–°å¢] å°‡åœ–ç‰‡è¨»å†Šåˆ°å…¨åŸŸåœ–åº«ä¸¦å›å‚³ Key ---
	function registerImageToGlobal(base64) {
		if (!base64) return null;

		// 1. æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ (å»é‡è¤‡åŒ–)
		for (const [key, value] of Object.entries(globalImageRegistry)) {
			if (value === base64) {
				return key; // æ‰¾åˆ°é‡è¤‡çš„ï¼Œç›´æ¥å›å‚³èˆŠ Key
			}
		}

		// 2. ä¸å­˜åœ¨ï¼Œç”¢ç”Ÿæ–° Key
		const newKey = `img_cutin_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
		globalImageRegistry[newKey] = base64;
		return newKey;
	}
    
    function pasteImageMode() {
        if (!pendingMove || pendingMove.cardIds.length !== 1) {
            alert(t('msg_paste_img_hint'));
            return;
        }
        window.focus();
    }
    
    // --- [ä¿®æ”¹] åœ–ç‰‡è™•ç† (ç•«è³ªæå‡è‡³ 200x280) ---
	function processImage(dataUrl, targetId = null) {
		const img = new Image();
		img.onload = () => {
			const canvas = document.createElement('canvas');
			const ctx = canvas.getContext('2d');
			
			// [ä¿®æ”¹ 1] è§£æåº¦æå‡ (åŸæœ¬ 100x140 -> 200x280)
			// é€™æ¨£åœ¨æ‰‹æ©Ÿç‰ˆæ”¾å¤§æ™‚ä¾ç„¶æ¸…æ™°
			const targetW = 240;
			const targetH = 336;
			
			canvas.width = targetW;
			canvas.height = targetH;
			
			ctx.fillStyle = "#fff"; 
			ctx.fillRect(0, 0, targetW, targetH);
			ctx.drawImage(img, 0, 0, targetW, targetH);
			
			// ä½¿ç”¨ 0.85 å“è³ªå£“ç¸®ï¼Œå–å¾—å¹³è¡¡
			const compressedBase64 = canvas.toDataURL('image/jpeg', 0.85);
			
			const idToUse = targetId || (pendingMove ? pendingMove.cardIds[0] : null);
			
			if (idToUse) {
				updateCardImageGlobal(idToUse, compressedBase64);
			}
		};
		img.src = dataUrl;
	}
    
	// --- [æ–°å¢] åƒåœ¾å›æ”¶è¼”åŠ©ï¼šæ‰¾å‡ºæ‰€æœ‰æ­£åœ¨ä½¿ç”¨çš„åœ–ç‰‡ Key ---
	// --- [ä¿®æ­£ç‰ˆ] åƒåœ¾å›æ”¶è¼”åŠ©ï¼šæ‰¾å‡ºæ‰€æœ‰æ­£åœ¨ä½¿ç”¨çš„åœ–ç‰‡ Key ---
	function getUsedImageKeys() {
		const used = new Set();
		
		// 1. æƒæç‹€æ…‹ (State) ä¸­çš„å¡ç‰‡èˆ‡å°è©±
		const scanState = (s) => {
			if (!s || !s.cards) return;
			s.cards.forEach(c => {
				if (c.imageKey) used.add(c.imageKey);
				if (c.backImageKey) used.add(c.backImageKey);
				if (c.styleKey) used.add(c.styleKey); 
			});
			
			if (s.dialogueData) {
				['p1', 'p2'].forEach(p => {
					if (s.dialogueData[p] && s.dialogueData[p].emotion) {
						used.add(`avatar_${p}_${s.dialogueData[p].emotion}`);
					}
				});
			}
		};

		scanState(initialState);
		
		// 2. æƒææ­·å²ç´€éŒ„ (History)
		history.forEach(h => {
			scanState(h.state);
			if (h.detachedStartState) scanState(h.detachedStartState);

			// [æ–°å¢] æƒæ Action ä¸­çš„ Cut In (Reality Break) å¼•ç”¨
			// é€™æ˜¯æ‚¨è²¼ä¸Šçš„èˆŠç‰ˆç¨‹å¼ç¢¼æ‰€ç¼ºå°‘çš„é—œéµéƒ¨åˆ†
			if (h.action && h.action.operations) {
				h.action.operations.forEach(op => {
					// å¦‚æœæ“ä½œä¸­æœ‰ imgKeyï¼Œæ¨™è¨˜ç‚ºã€Œä½¿ç”¨ä¸­ã€
					if (op.type === 'REALITY_BREAK' && op.data && op.data.imgKey) {
						used.add(op.data.imgKey);
					}
				});
			}
		});
		
		// 3. æƒææš«å­˜ç‹€æ…‹
		if (tempState) scanState(tempState);

		// 4. [æ–°å¢] æƒæç·¨è¼¯ä¸­çš„æ“ä½œ (Draft)
		// é€™æ˜¯ç‚ºäº†é˜²æ­¢æ‚¨æ­£åœ¨ç·¨è¼¯ç‰¹æ•ˆé‚„æ²’å„²å­˜æ­¥é©Ÿæ™‚ï¼Œè§¸ç™¼å­˜æª”å°è‡´åœ–ç‰‡è¢«æ¸…æ‰
		if (isDrafting && draftOperations.length > 0) {
			draftOperations.forEach(op => {
				if (op.type === 'REALITY_BREAK' && op.data && op.data.imgKey) {
					used.add(op.data.imgKey);
				}
			});
		}

		// 5. ä¿ç•™é è¨­é ­åƒ
		Object.keys(globalImageRegistry).forEach(k => {
			if (k.startsWith('avatar_')) used.add(k);
		});

		return used;
	}

	// --- [ä¿®æ”¹] å…¨åŸŸåœ–ç‰‡æ›´æ–° (å«å»é‡è¤‡åŒ–èˆ‡å¼•ç”¨æ›´æ–°) ---
	function updateCardImageGlobal(cardId, base64) {
		const state = getCurrentDisplayState();
		const targetCard = state.cards.find(c => c.id === cardId);
		if(!targetCard) return;

		// 1. [å»é‡è¤‡åŒ–] æª¢æŸ¥é€™å¼µåœ–ç‰‡æ˜¯å¦å·²ç¶“å­˜åœ¨æ–¼åœ–åº«ä¸­
		let finalKey = null;
		
		// éæ­·ç›®å‰çš„åœ–åº«å°‹æ‰¾ç›¸åŒå…§å®¹
		for (const [key, value] of Object.entries(globalImageRegistry)) {
			if (value === base64) {
				finalKey = key; // æ‰¾åˆ°äº†ä¸€æ¨¡ä¸€æ¨£çš„åœ–ï¼ç›´æ¥å€Ÿç”¨å®ƒçš„ Key
				break;
			}
		}

		// 2. å¦‚æœæ²’æ‰¾åˆ°ï¼Œç”Ÿæˆä¸€å€‹å…¨æ–°çš„ Key (ä¸å†ç¶å®šå¡ç‰‡ IDï¼Œæ”¹ç”¨æ™‚é–“æˆ³+äº‚æ•¸)
		if (!finalKey) {
			// ä½¿ç”¨ img_æ™‚é–“æˆ³_äº‚æ•¸ï¼Œç¢ºä¿å”¯ä¸€æ€§
			finalKey = `img_${Date.now()}_${Math.floor(Math.random() * 10000)}`;
			// å¯«å…¥åœ–åº«
			globalImageRegistry[finalKey] = base64;
		}

		// 3. æ›´æ–°ç›®æ¨™å¡ç‰‡çš„ Reference (æŒ‡å‘ finalKey)
		// æ³¨æ„ï¼šåŸæœ¬çš„é‚è¼¯æ˜¯ç¶å®š img_CardIDï¼Œç¾åœ¨æˆ‘å€‘æ”¹è®Šå¡ç‰‡æœ¬èº«çš„ imageKey å±¬æ€§
		
		// åˆ¤æ–·æ˜¯è¦æ›´æ–°æ­£é¢é‚„æ˜¯èƒŒé¢ (è¶…æ¬¡å…ƒèƒŒé¢)
		const isUpdatingBack = (targetCard.isHyper && !targetCard.faceUp);

		// å®šç¾©æ›´æ–°å‡½å¼ï¼šèµ°è¨ªæ‰€æœ‰æ­·å²ç´€éŒ„ï¼ŒæŠŠé€™å¼µå¡(IDç›¸åŒ)çš„ key æ›´æ–°
		const updateCardRef = (s) => {
			// æ‰¾å‡ºæ‰€æœ‰ ID ç›¸åŒçš„å¡ç‰‡å¯¦ä¾‹ (åŒ…å«åˆ†èº«)
			s.cards.forEach(c => {
				if (c.id === cardId) {
					if (isUpdatingBack) {
						c.backImageKey = finalKey;
					} else {
						c.imageKey = finalKey;
						c.image = true; // æ¨™è¨˜æœ‰åœ–
					}
				}
				// åŒæ­¥æ›´æ–°ï¼šå¦‚æœå ´ä¸Šæœ‰å…¶ä»–å¡ç‰‡åŸæœ¬å°±è·Ÿé€™å¼µå¡å…±ç”¨èˆŠåœ–ç‰‡ï¼Œ
				// ä¸”æˆ‘å€‘ç¢ºå®šè¦æŠŠæ‰€æœ‰ã€Œé•·å¾—åƒé€™å¼µå¡ã€çš„éƒ½æ›æ‰ï¼Œå¯ä»¥åœ¨é€™è£¡è™•ç†ã€‚
				// ä½†ç‚ºäº†å®‰å…¨èµ·è¦‹ï¼Œæˆ‘å€‘ç›®å‰åªæ›´æ–° ID å»åˆçš„å¡ç‰‡ã€‚
			});
		};
		
		updateCardRef(initialState);
		history.forEach(h => updateCardRef(h.state));
		if (tempState) updateCardRef(tempState);
		
		// 4. è§¸ç™¼å­˜æª”èˆ‡é‡ç¹ª
		renderUI();
		saveToStorage(); // saveToStorage å…§æœƒåŸ·è¡Œåƒåœ¾å›æ”¶ (GC)ï¼Œè‡ªå‹•æ¸…ç†æ²’äººç”¨çš„èˆŠåœ–

		// [UI åˆ·æ–°é‚è¼¯ç¶­æŒä¸è®Š]
		const selectorModal = document.getElementById('card-selector-modal');
		if (selectorModal && selectorModal.style.display === 'flex') {
			const zoneId = document.getElementById('modal-title').getAttribute('data-zone-id');
			if (zoneId) {
				openSelectorModal(zoneId);
				return;
			}
		}

		if (!isDrafting || draftOperations.length === 0) {
			cancelSelection();
		}
	}
    
    function removeImage() {
        if (!pendingMove || pendingMove.cardIds.length !== 1) return;
        const cardId = pendingMove.cardIds[0];
        const state = getCurrentDisplayState();
        const card = state.cards.find(c => c.id === cardId);
        if(!card) return;

        if (!card.imageKey) {
            card.imageKey = 'img_' + card.id;
            card.backImageKey = 'img_back_' + card.id;
        }

        let keyToUpdate = card.imageKey;
        if (card.isHyper && !card.faceUp) {
             keyToUpdate = card.backImageKey;
        }
        
        if(!confirm(t('msg_remove_img'))) return;
        
        delete globalImageRegistry[keyToUpdate];

        const unsetFlag = (s) => {
            const c = s.cards.find(x => x.id === cardId);
            if(c) c.image = false;
            
            s.cards.forEach(other => {
                if (other.imageKey === keyToUpdate || other.backImageKey === keyToUpdate) {
                    other.image = false;
                }
            });
        };

        unsetFlag(initialState);
        history.forEach(h => unsetFlag(h.state));
        if (tempState) unsetFlag(tempState);

        saveToStorage();
        renderUI();
    }

    function cloneState(state) {
        return JSON.parse(JSON.stringify(state));
    }

    function openSetupModal() {
        const modal = document.getElementById('setup-modal');
        if(modal) modal.style.display = 'flex';
    }

    function clearStorage(silent = false) {
        if(!silent && !confirm(t('msg_confirm_clear_storage'))) return;
        
        localStorage.removeItem(STORAGE_KEY_CORE);
        localStorage.removeItem(STORAGE_KEY_CARDS);
        localStorage.removeItem(STORAGE_KEY_PORTRAITS);
        localStorage.removeItem(STORAGE_KEY_LEGACY); // ä¹Ÿæ¸…ä¸€ä¸‹èˆŠçš„
        
        if (!silent) {
            alert(t('msg_cleared'));
            location.reload();
        }
    }
    
    function deleteAllActions() {
        if(!confirm(t('msg_confirm_delete_all'))) return;
        
        history = [];
        initialState = null;
        currentIndex = -1;
        draftOperations = [];
        isDrafting = false;
        
        // æ¸…é™¤æ‰€æœ‰å­˜æª”
        localStorage.removeItem(STORAGE_KEY_CORE);
        localStorage.removeItem(STORAGE_KEY_CARDS);
        localStorage.removeItem(STORAGE_KEY_PORTRAITS);
        localStorage.removeItem(STORAGE_KEY_LEGACY);
        
        storageQuotaExceeded = false;
        hasAlertedQuota = false;

        document.getElementById('action-list').innerHTML = '';
        document.getElementById('step-counter').innerText = '0/0';
        updateDraftBar();
        
        openSetupModal();
    }

    function finishSetup() {
        try {
            const getVal = (id, def) => {
                const el = document.getElementById(id);
                if(!el) return def;
                const val = parseInt(el.value);
                return isNaN(val) ? def : val;
            };

            const p1d = getVal('setup-p1-deck', 40);
            const p1h = getVal('setup-p1-hyper', 8);
            const p2d = getVal('setup-p2-deck', 40);
            const p2h = getVal('setup-p2-hyper', 8);
            
            initGame({p1d, p1h, p2d, p2h});
            document.getElementById('setup-modal').style.display = 'none';
        } catch (e) {
            console.error(e);
            alert(t('msg_init_fail') + e.message)
        }
    }

    function initGame(config) {
        const state = new GameState();
        globalImageRegistry = {}; 
        globalAbilityStyleRegistry = {};
		globalLastUsedStyles = {}; // [æ–°å¢] é‡ç½®è¨˜æ†¶
        globalAceRegistry = {}; // [ä¿®æ­£] ç¢ºä¿æ–°é–‹å±€æ™‚æ¸…ç©ºç‹ç‰Œè¨­å®š
        
        if(!config) config = {p1d:40, p1h:8, p2d:40, p2h:8};

        const zones = [
            {id: 'p1-deck', count: config.p1d, prefix: 'C'}, {id: 'p1-hyper', count: config.p1h, prefix: 'H', hyper:true},
            {id: 'p2-deck', count: config.p2d, prefix: 'C'}, {id: 'p2-hyper', count: config.p2h, prefix: 'H', hyper:true}
        ];
        
        state.cards = []; 
        
        zones.forEach(z => {
            for(let i=0; i<z.count; i++) {
                let c = new Card(state.cardIdCounter++, z.id.startsWith('p1')?1:2, `${z.prefix}-${i+1}`, z.id);
                if(z.hyper) { c.isHyper=true; c.faceUp=true; }
                state.cards.push(c);
            }
        });

        initialState = cloneState(state);
        history = [];
        let initAct = new Action('éŠæˆ²é–‹å§‹');
        initAct.operations.push({type: 'INIT'});
        history.push({ action: initAct, state: initialState });
        currentIndex = 0;

        isDrafting = false;
        draftOperations = [];
        updateDraftBar();
        renderUI();
        saveToStorage();
    }

	// ä¿®æ”¹åŸæœ‰çš„ STORAGE_KEY å®šç¾©
    const STORAGE_KEY_CORE = 'dm_editor_data_v1_core';           // æ ¸å¿ƒï¼šæ­·å²ç´€éŒ„ã€ç‹€æ…‹
    const STORAGE_KEY_CARDS = 'dm_editor_data_v1_card_imgs';     // åœ–ç‰‡ï¼šå¡ç‰‡åœ–
    const STORAGE_KEY_PORTRAITS = 'dm_editor_data_v1_portraits'; // åœ–ç‰‡ï¼šå°è©±é ­åƒ
    
    // ç‚ºäº†ç›¸å®¹èˆŠç‰ˆï¼Œä¿ç•™èˆŠ Key çš„åƒè€ƒ
    const STORAGE_KEY_LEGACY = 'dm_editor_data_v1';
	
	function saveToStorage() {
        if (document.body.classList.contains('mobile-mode')) return;

        try {
            // 1. æº–å‚™æ ¸å¿ƒè³‡æ–™ (Lean History)
			const leanHistory = history.map((item, index) => {
				// [åŸæœ¬æ‚¨å•çš„é‚£æ®µ delete op.data.imgData å·²ç¶“å¯ä»¥æ‹¿æ‰äº†]
				// å› ç‚ºç¾åœ¨ data è£¡é¢å­˜çš„æ˜¯ imgKey (å­—ä¸²)ï¼Œä¸ä½”ç©ºé–“ï¼Œç•™è‘—æ²’é—œä¿‚
				
				// ç›´æ¥è¤‡è£½ action å³å¯
				const safeAction = JSON.parse(JSON.stringify(item.action));
				
				if (index === 0) return { ...item, action: safeAction };
				
				const leanItem = { action: safeAction };
				if (item.detachedStartState) leanItem.detachedStartState = item.detachedStartState;
				return leanItem;
			});

			const coreData = {
				timestamp: Date.now(),
				history: leanHistory,
				initialState: initialState,
				currentIndex: currentIndex,
				abilityRegistry: globalAbilityStyleRegistry,
				lastUsedStyles: globalLastUsedStyles,
				lastDiagSettings: (typeof lastDiagSettings !== 'undefined') ? lastDiagSettings : null,
				aceRegistry: globalAceRegistry,
				themeSettings: globalThemeSettings,
			};

			// 2. [é—œéµä¿®æ”¹] åƒåœ¾å›æ”¶èˆ‡åœ–ç‰‡åˆ†æµ
			const usedKeys = getUsedImageKeys(); // å–å¾—æ‰€æœ‰ç”¨åˆ°çš„ Key (å« Cut In)
			
			const cardImages = {};
			const portraitImages = {};

			Object.keys(globalImageRegistry).forEach(key => {
				if (usedKeys.has(key)) {
					// -------------------------------------------------------------
					// [é‡é»] é€™è£¡åŠ å…¥éæ¿¾ï¼šå¦‚æœæ˜¯ Cut In çš„å¤§åœ–ï¼Œå°±ä¸å­˜å…¥ LocalStorage
					// -------------------------------------------------------------
					if (key.startsWith('img_cutin_')) {
						// è·³éï¼Œä¸å­˜ï¼
						return; 
					}
					
					if (key.startsWith('avatar_')) {
						portraitImages[key] = globalImageRegistry[key];
					} else {
						cardImages[key] = globalImageRegistry[key];
					}
				}
			});

			// 3. å¯«å…¥ (æ­¤æ™‚ Cut In çš„ Key é‚„åœ¨ history è£¡ï¼Œä½†åœ–ç‰‡æœ¬é«”æ²’å­˜é€²å»)
			localStorage.setItem(STORAGE_KEY_CORE, JSON.stringify(coreData));
			localStorage.setItem(STORAGE_KEY_CARDS, JSON.stringify(cardImages));
			localStorage.setItem(STORAGE_KEY_PORTRAITS, JSON.stringify(portraitImages));
            
            if (storageQuotaExceeded) {
                storageQuotaExceeded = false;
                hasAlertedQuota = false;
            }
        } catch(e) {
            console.warn("Storage save failed (Quota?)", e);
            storageQuotaExceeded = true;
            if (!hasAlertedQuota) {
                alert(t('msg_storage_full'));
                hasAlertedQuota = true;
            }
        }
    }

    function loadFromStorage() {
        // --- éšæ®µ 0: æª¢æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆçµæ§‹ ---
        const coreRaw = localStorage.getItem(STORAGE_KEY_CORE);
        
        // å¦‚æœæ²’æœ‰æ–°ç‰ˆè³‡æ–™ï¼Œå˜—è©¦è®€å–èˆŠç‰ˆ (Migration)
        if (!coreRaw) {
            return loadFromLegacyStorage();
        }

        try {
            // --- éšæ®µ 1: å„ªå…ˆè®€å–æ ¸å¿ƒé‚è¼¯ (æœ€å¿«ï¼Œç„¡åœ–ç‰‡ I/O) ---
            const data = JSON.parse(coreRaw);
            
            // æª¢æŸ¥éæœŸ
            if (data.timestamp && (Date.now() - data.timestamp > STORAGE_EXPIRY)) {
                clearStorage(true); // å‚³å…¥ true è¡¨ç¤ºå®‰éœæ¸…é™¤ï¼Œä¸ reload
                return false;
            }

            // åˆå§‹åŒ–è¨­å®š
            globalImageRegistry = {}; 
            globalAbilityStyleRegistry = data.abilityRegistry || {};
            globalLastUsedStyles = data.lastUsedStyles || {};
            if (data.lastDiagSettings && typeof lastDiagSettings !== 'undefined') {
                lastDiagSettings = data.lastDiagSettings;
            }
            
            globalAceRegistry = data.aceRegistry || {};
            
            // è¼‰å…¥ä¸»é¡Œ
            if (data.themeSettings) {
                globalThemeSettings = data.themeSettings;
            } else {
                globalThemeSettings = { p1: 'blue', p2: 'red' };
            }
            applyThemeVariables(); // å¥—ç”¨
            
            // è™•ç†ç„¡æœˆä¹‹é–€é·ç§»
            if (data.moonlessRegistry) {
                if (!data.initialState.moonless) data.initialState.moonless = {};
                Object.assign(data.initialState.moonless, data.moonlessRegistry);
            }

            // é‡å»ºç‹€æ…‹
            initialState = data.initialState;
            if (!initialState.moonless) initialState.moonless = {};
            if (initialState.rpsResult === undefined) initialState.rpsResult = null;
            
            let loadedHistory = data.history;
            if (!loadedHistory[0].state) loadedHistory[0].state = cloneState(initialState);
            
            for (let i = 1; i < loadedHistory.length; i++) {
                if (!loadedHistory[i].state) {
                    const prevState = loadedHistory[i-1].state;
                    const newState = cloneState(prevState);
                    const ops = loadedHistory[i].action.operations;
                    ops.forEach(op => applyOperation(newState, op));
                    loadedHistory[i].state = newState;
                }
            }
            
            history = loadedHistory;
            currentIndex = (typeof data.currentIndex === 'number' && data.currentIndex >= -1 && data.currentIndex < history.length) 
                           ? data.currentIndex 
                           : (history.length - 1);
                           
            // [ä¿®æ­£] F5 åˆ·æ–°å¾Œï¼Œç«‹åˆ»æ ¹æ“šè®€å›ä¾†çš„æ­·å²ç´€éŒ„ï¼Œé‡æ–°è¨ˆç®—å·²è¦‹å¡
            calculateSeenCards();
            
            // **é—œéµé» 1**: é¦¬ä¸Šæ¸²æŸ“ UI (ç´”æ–‡å­—ç‰ˆ)
            try { renderUI(); } catch(e) { console.error(e); }

            // --- éšæ®µ 2: å»¶é²è®€å–å¡ç‰‡åœ–ç‰‡ ---
            setTimeout(() => {
                const cardsRaw = localStorage.getItem(STORAGE_KEY_CARDS);
                if (cardsRaw) {
                    try {
                        const cardImgs = JSON.parse(cardsRaw);
                        Object.assign(globalImageRegistry, cardImgs);
                        
                        // **é—œéµé» 2**: å¡ç‰‡åœ–ç‰‡è¼‰å…¥å®Œæˆï¼Œé‡ç¹ª
                        renderUI(); 
                    } catch(e) { console.error("Error loading card images", e); }
                }

                // --- éšæ®µ 3: æœ€å¾Œè®€å–å°è©±é ­åƒ (å„ªå…ˆç´šæœ€ä½) ---
                setTimeout(() => {
                    const portRaw = localStorage.getItem(STORAGE_KEY_PORTRAITS);
                    if (portRaw) {
                        try {
                            const portImgs = JSON.parse(portRaw);
                            Object.assign(globalImageRegistry, portImgs);
                            
                            // ç¢ºä¿é è¨­é ­åƒå­˜åœ¨
                            if (typeof generateDefaultPortraits === 'function') {
                                generateDefaultPortraits();
                            }
                            
                            renderUI(); 

                        } catch(e) { console.error("Error loading portraits", e); }
                    } else {
                        // å¦‚æœæ²’å­˜æª”ï¼Œä¹Ÿè¦ç”Ÿæˆé è¨­é ­åƒä¸¦é‡ç¹ª
                        if (typeof generateDefaultPortraits === 'function') {
                            generateDefaultPortraits();
                            renderUI();
                        }
                    }

                    // ã€é—œéµä¿®æ­£ã€‘åœ¨æ‰€æœ‰åœ–ç‰‡è³‡æ–™ (Base64 + URL Key) éƒ½è¼‰å…¥å­—å…¸å¾Œ
                    // è§¸ç™¼ä¸€æ¬¡ç¶²å€åœ–ç‰‡é è¼‰ï¼Œç¢ºä¿ Cut In ç­‰ç‰¹æ•ˆåœ–è¢«ç€è¦½å™¨å¿«å–
                    preloadImagesFromRegistry();

                }, 50); 
                
            }, 50); 

            return true;

        } catch (e) {
            console.error("Load failed", e);
            return false;
        }
    }

    // è¼”åŠ©å‡½å¼ï¼šèˆŠç‰ˆç›¸å®¹è®€å–
    function loadFromLegacyStorage() {
        const raw = localStorage.getItem(STORAGE_KEY_LEGACY);
        if (!raw) return false;
        
        try {
            const data = JSON.parse(raw);
            // ... (ä½¿ç”¨åŸæœ¬çš„è§£æé‚è¼¯) ...
            globalImageRegistry = data.imageRegistry || {};
            globalAbilityStyleRegistry = data.abilityRegistry || {};
            initialState = data.initialState;
            // ... Replay logic ...
            let loadedHistory = data.history;
            if (!loadedHistory[0].state) loadedHistory[0].state = cloneState(initialState);
            for (let i = 1; i < loadedHistory.length; i++) {
                if (!loadedHistory[i].state) {
                    const prevState = loadedHistory[i-1].state;
                    const newState = cloneState(prevState);
                    const ops = loadedHistory[i].action.operations;
                    ops.forEach(op => applyOperation(newState, op));
                    loadedHistory[i].state = newState;
                }
            }
            history = loadedHistory;
            currentIndex = data.currentIndex || (history.length - 1);
            
            if (typeof generateDefaultPortraits === 'function') generateDefaultPortraits();
            renderUI();
            
            // **é—œéµ**: è®€å–æˆåŠŸå¾Œï¼Œé¦¬ä¸Šå­˜æˆæ–°æ ¼å¼ï¼Œä¸‹æ¬¡å°±æœƒå¿«äº†
            saveToStorage(); 
            return true;
        } catch(e) {
            return false;
        }
    }

    function getCurrentDisplayState() {
        return isDrafting ? tempState : ((currentIndex >= 0 && currentIndex < history.length) ? history[currentIndex].state : initialState);
    }

    function startDraftAtEnd() {
        startDraft(history.length);
    }

	function startDraft(index) {
		if (isDrafting) {
			if(!confirm(t('msg_unsaved_draft'))) return;
				document.getElementById('action-list').classList.remove('locked');
		}
		
		isDrafting = true;
		insertIndex = index;
		draftOperations = [];
		editModeType = 'INSERT';
		
		let baseIndex = index - 1;
		if (baseIndex < 0) baseIndex = 0; 
		
		// è¤‡è£½ä¸Šä¸€æ­¥é©Ÿçš„ç‹€æ…‹
		tempState = cloneState(history[baseIndex].state);

		// --- [ä¿®æ”¹] æ¸…é™¤æ®˜ç•™ç‹€æ…‹é‚è¼¯ ---
		// 2. æ¸…é™¤å°è©±ç‹€æ…‹ (ç¶­æŒåŸæ¨£)
		tempState.dialogueData = null; // æ¸…é™¤å°è©±
		tempState.rpsResult = null;    // [æ–°å¢] æ¸…é™¤çŒœæ‹³çµæœ
		
		// ---------------------------
		
		updateDraftBar();
		renderUI();

		const list = document.getElementById('action-list');
		const placeholder = document.getElementById('active-placeholder');
		
		if (placeholder) {
			// ä½¿ç”¨ behavior: 'smooth' å¯èƒ½æœƒæ¯”è¼ƒèˆ’é©ï¼Œä½† auto è¼ƒå¿«
			placeholder.scrollIntoView({ block: "center", behavior: "auto" });
			setTimeout(() => {
				list.classList.add('locked');
			}, 50);
		}
	}

    function editAction(index) {
        if (isDrafting) {
            if(!confirm(t('msg_unsaved_edit'))) return;
            // å¦‚æœåŸæœ¬é–å®šï¼Œå…ˆè§£é–
            document.getElementById('action-list').classList.remove('locked');
        }
        
        isDrafting = true;
        insertIndex = index; 
        editModeType = 'EDIT';
        
        // åˆ¤æ–·æ˜¯å¦è¦ä½¿ç”¨ã€Œæ–·å±¤å­˜æª”ã€
		// å¦‚æœç•¶å‰æ­¥é©Ÿ (Action 5) æœ‰ç´€éŒ„ detachedStartStateï¼Œå°±ç”¨å®ƒç•¶ä½œç·¨è¼¯çš„èµ·é»
		if (history[index].detachedStartState) {
			console.log("ç™¼ç¾æ–·å±¤å­˜æª”ï¼Œè¼‰å…¥èˆŠçš„æ™‚é–“è»¸ç‹€æ…‹...");
			tempState = cloneState(history[index].detachedStartState);
		} 
		else {
			// å¦å‰‡èµ°åŸæœ¬çš„é‚è¼¯ (æ‰¾ä¸Šä¸€æ­¥çš„çµæœ)
			let baseIndex = index - 1;
			if (baseIndex < 0) {
				tempState = cloneState(initialState);
			} else {
				tempState = cloneState(history[baseIndex].state);
			}
		}
        
        tempState.dialogueData = null; // æ¸…é™¤å°è©±
		tempState.rpsResult = null;    // [æ–°å¢] æ¸…é™¤çŒœæ‹³çµæœ (é™¤é Action æœ¬èº«å°±æ˜¯ RPSï¼Œé‚£ä¸‹é¢ applyOperation æœƒè£œå›ä¾†ï¼Œä½†é€™æ™‚ renderUI çš„ !isDrafting æœƒæ“‹ä½å®ƒ)
        // ---------------------------------------------------

        const actionToEdit = history[index].action;
        
        // ä½¿ç”¨æ·±æ‹·è²ï¼Œé¿å…ç›´æ¥ä¿®æ”¹åˆ°æ­·å²ç´€éŒ„ (ç›´åˆ°æŒ‰ä¸‹å„²å­˜)
        draftOperations = JSON.parse(JSON.stringify(actionToEdit.operations));
        
        draftOperations.forEach(op => applyOperation(tempState, op));
        
        updateDraftBar();
        renderUI();

        // --- [æ–°å¢] è‡ªå‹•é–‹å•Ÿå°è©±ç·¨è¼¯è¦–çª— ---
        const isDialogue = draftOperations.some(op => op.type === 'DIALOGUE');
        if (isDialogue) {
            openDialogueModal();
        }
        // --------------------------------

        // --- [åŒæ­¥ä¿®æ­£] é–å®š Scrollbar ---
        const list = document.getElementById('action-list');
        const placeholder = document.getElementById('active-placeholder');
        
        if (placeholder) {
            placeholder.scrollIntoView({ block: "center", behavior: "auto" });
            setTimeout(() => {
                list.classList.add('locked');
            }, 50);
        }
    }

    // [ä¿®æ”¹] å¢åŠ  skipRender åƒæ•¸ï¼Œå…è¨±æ‰‹å‹•è™•ç† DOM æ›´æ–°ä»¥æå‡æ•ˆèƒ½
	function addOperation(op, skipRender = false) {
		// äº’æ–¥é–é‚è¼¯ (ç¶­æŒåŸæ¨£)
		const hasDialog = draftOperations.some(o => o.type === 'DIALOGUE');
		if (hasDialog && op.type !== 'DIALOGUE') { alert(t('msg_dialog_exclusive')); return; }
		if (!hasDialog && draftOperations.length > 0 && op.type === 'DIALOGUE') { alert(t('msg_dialog_exclusive')); return; }

		// è‡ªå‹•åˆ¤æ–·ç·¨è¼¯æ¨¡å¼ (ç¶­æŒåŸæ¨£)
		if (!isDrafting) {
			if (currentIndex >= 0 && currentIndex < history.length) {
				if (currentIndex === history.length - 1 && forceNewStep) {
					startDraftAtEnd();
				} else {
					editAction(currentIndex);
				}
			} else {
				startDraftAtEnd();
			}
		}

		// 1. æ‡‰ç”¨ç‹€æ…‹è®Šæ›´ (ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§)
		applyOperation(tempState, op);
		draftOperations.push(op);
		
		// 2. æ›´æ–°ä¸‹æ–¹ Draft Bar ç‹€æ…‹æ–‡å­—
		updateDraftBar();

		// 3. [é—œéµ] æ ¹æ“šåƒæ•¸æ±ºå®šæ˜¯å¦é‡ç¹ª
		if (!skipRender) {
			renderUI();
		}
	}

	// --- æ–°å¢åŠŸèƒ½: é‚„åŸä¸Šä¸€æ­¥ (Ctrl+Z) ---
    function undoLastDraftOp() {
        if (!isDrafting) return;
        if (draftOperations.length === 0) return;

        // 1. ç§»é™¤ Draft ä¸­çš„æœ€å¾Œä¸€å€‹æ“ä½œ
        draftOperations.pop();

        // 2. é‡æ–°è¨ˆç®— tempState
        // å¿…é ˆå¾ Draft é–‹å§‹å‰çš„ç‹€æ…‹ (Base State) é‡æ–°å¥—ç”¨å‰©é¤˜çš„æ“ä½œ
        let baseIndex = insertIndex - 1;
        let baseState;
        
        if (baseIndex < 0) {
            baseState = cloneState(initialState);
        } else {
            // å–å‡ºé€²å…¥ç·¨è¼¯æ¨¡å¼å‰çš„ç‹€æ…‹å¿«ç…§
            baseState = cloneState(history[baseIndex].state);
        }

        // é‡ç½® tempState ç‚ºåˆå§‹ç‹€æ…‹
        tempState = baseState;

        // ä¾åºé‡æ–°åŸ·è¡Œå‰©é¤˜çš„æ‰€æœ‰æ“ä½œ
        draftOperations.forEach(op => applyOperation(tempState, op));

        // 3. æ›´æ–°ä»‹é¢
        updateDraftBar();
        renderUI();
        
        // è‹¥å‰›å¥½é‚„åŸäº†ç§»å‹•æ“ä½œï¼Œå–æ¶ˆç›®å‰çš„é¸å–ç‹€æ…‹ä»¥é¿å… UI éŒ¯äº‚
        cancelSelection(); 
    }
	
    // [ä¿®æ”¹] å¢åŠ  skipRender åƒæ•¸
	function saveDraft(customDesc, skipRender = false) {
		if (draftOperations.length === 0) {
			cancelDraft();
			return;
		}

		// è‡ªå‹•ç”Ÿæˆæè¿° (ç¶­æŒåŸæ¨£)
		let desc = customDesc;
		if (!desc && editModeType === 'EDIT' && insertIndex < history.length) {
			desc = history[insertIndex].action.description;
		}
		if (!desc) {
			const opCount = draftOperations.length;
			const firstOp = draftOperations[0];
			let typeDesc = t('op_' + firstOp.type) || t('op_default');
			
			if (firstOp.type === 'POINT') desc = firstOp.desc || t('op_POINT');
			else if (firstOp.type === 'ATTACK') desc = firstOp.desc || t('op_ATTACK');
			else if (firstOp.type === 'DIALOGUE') {
				 const data = firstOp.data;
				 desc = "[å°è©±] ";
				 if (data.p2 && data.p2.active) desc += `${data.p2.name}... `;
				 if (data.p1 && data.p1.active) desc += `${data.p1.name}...`;
			} else if (firstOp.type === 'REALITY_BREAK') desc = t('desc_rb');
			else desc = `${typeDesc} ${t('lbl_draft_ops_prefix') || ''} ${opCount} ${t('op_count_suffix')}`;
		}

		takeGlobalSnapshot();

		// å»ºç«‹æ–°çš„ History Item
		const newAction = new Action(desc);
		newAction.operations = [...draftOperations];
		const finalState = cloneState(tempState);
		const newItem = { action: newAction, state: finalState };

		// è™•ç†æ’å…¥èˆ‡é€£å‹• (Propagate)
		const propagate = document.getElementById('propagate-check').checked;
		const head = history.slice(0, insertIndex);
		let tail = (editModeType === 'EDIT') ? history.slice(insertIndex + 1) : history.slice(insertIndex);

		if (propagate) {
			let runningState = cloneState(finalState);
			tail = tail.map(item => {
				if (item.detachedStartState) delete item.detachedStartState;
				try { item.action.operations.forEach(op => applyOperation(runningState, op)); } 
				catch(e) { console.error("Propagate Error", e); }
				return { action: item.action, state: cloneState(runningState) };
			});
		} else {
			if (tail.length > 0 && editModeType === 'EDIT' && !tail[0].detachedStartState) {
				 tail[0].detachedStartState = cloneState(history[insertIndex].state);
			}
		}

		history = [...head, newItem, ...tail];
		isDrafting = false;
		currentIndex = insertIndex;
		insertIndex = -1;
		draftOperations = [];
		
		// æ›´æ–°ä»‹é¢
		updateDraftBar(); // éš±è— Draft Bar
		
		// [é—œéµ] è‹¥æŒ‡å®šè·³éæ¸²æŸ“ï¼Œå‰‡ä¸å‘¼å« renderUI
		if (!skipRender) {
			renderUI();
		}
		
		// è§£é– Action Log
		const list = document.getElementById('action-list');
		if (list) {
			list.classList.remove('locked');
			// [Fix] å»¶é² 100ms å†æ¬¡è§£é–ï¼Œé˜²æ­¢ startDraft çš„ setTimeout(50ms) è¦†è“‹æ­¤è¨­å®š
			setTimeout(() => list.classList.remove('locked'), 100);
		}

		forceNewStep = (currentIndex === history.length - 1);
		
		// é‡æ–°è¨ˆç®—æœªè¦‹å¡ (è³‡æ–™é¢)
		calculateSeenCards();
		
		// å­˜æª”
		saveToStorage();

		// æ²å‹•åˆ—è¡¨
		if (!skipRender) {
			setTimeout(() => scrollToActiveStep(), 50);
		} else {
			renderTimeline(); // è‡³å°‘è¦æ›´æ–°å³å´åˆ—è¡¨
			scrollToActiveStep();
		}
	}

    function cancelDraft() {
        isDrafting = false;
        draftOperations = [];
        editModeType = 'INSERT'; // é‡ç½®æ¨¡å¼
        
        // æ¸…é™¤é¸å–ç‹€æ…‹
        cancelSelection();
        
        // 1. æ›´æ–° Draft Bar (å› ç‚º isDrafting=falseï¼Œé€™æœƒéš±è—å®ƒ)
        updateDraftBar();
        
        // 2. [é—œéµä¿®æ­£] è§£é– Action Log çš„æ²è»¸
        const list = document.getElementById('action-list');
        if (list) {
            list.classList.remove('locked');
        }

        // æ ¡æ­£ç´¢å¼•
        if(currentIndex >= history.length) currentIndex = history.length - 1;
        
        // é‡ç¹ªç•«é¢
        renderUI();

        // 3. è‡ªå‹•æ²å‹•å›åŸæœ¬çš„ä½ç½® (æå‡é«”é©—)
        setTimeout(() => {
            scrollToActiveStep();
        }, 50);
    }

    function updateDraftBar() {
        const bar = document.getElementById('draft-bar');
        const statusText = document.getElementById('draft-status-text');

        if (isDrafting) {
            bar.style.display = 'flex';
            
            // --- ç”¢ç”Ÿ L1 æ–‡å­—: "æ–°å¢/ä¿®æ”¹#126 5å€‹å‹•ä½œ" ---
            let modeStr = "";
            if (editModeType === 'EDIT') {
                // ç·¨è¼¯æ¨¡å¼
                modeStr = t('msg_editing_step').replace('{n}', insertIndex);
            } else {
                // æ–°å¢æ¨¡å¼
                const prevIndex = insertIndex > 0 ? (insertIndex - 1) : 0;
                modeStr = t('msg_insert_after').replace('{n}', prevIndex);
            }
            
            const opCount = draftOperations.length;
            // çµ„åˆå­—ä¸²
            statusText.innerText = `${modeStr} (${opCount} ${t('op_count_suffix') || 'ops'})`;
            // -------------------------------------------

            // æ›´æ–°æŒ‰éˆ•ç¿»è­¯
            const saveBtn = bar.querySelector('.primary');
            const cancelBtn = bar.querySelector('.danger');
            
            if (saveBtn) saveBtn.innerText = t('btn_save_step'); // "ğŸ’¾ å„²å­˜æ­¤æ­¥"
            if (cancelBtn) cancelBtn.innerText = t('btn_cancel'); // "å–æ¶ˆ"

        } else {
            bar.style.display = 'none';
        }
    }

    // --- [å–ä»£] deleteAction å‡½å¼ (å¼·åŒ–ç‰ˆ) ---
	function deleteAction(index) {
        // 1. å®‰å…¨æª¢æŸ¥
        if (typeof isDrafting !== 'undefined' && isDrafting) {
            alert(t('msg_finish_edit_first'));
            return;
        }

        if (index === 0) return alert(t('msg_cannot_del_init'));
        if (!confirm(t('msg_confirm_del_step'))) return;
		
		// --- [æ–°å¢] åœ¨åˆªé™¤å‰ï¼Œå…ˆå‚™ä»½ç•¶å‰ç‹€æ…‹ ---
		takeGlobalSnapshot();
		// ------------------------------------

        // 2. åˆ‡å‰²é™£åˆ—
        const head = history.slice(0, index);
        let tail = history.slice(index + 1);

        // æ¸…é™¤æ–·å±¤å¿«ç…§
        if (tail.length > 0) {
            if (tail[0].detachedStartState) {
                delete tail[0].detachedStartState;
            }
        }

        // å¼·åˆ¶é‡ç®—å¾ŒçºŒç‹€æ…‹
        if (tail.length > 0) {
            let runningState = cloneState(head[head.length - 1].state);
            tail = tail.map(item => {
                if (item.detachedStartState) delete item.detachedStartState;
                try {
                    item.action.operations.forEach(op => applyOperation(runningState, op));
                } catch(e) { console.error("Recalc Error after delete", e); }
                return { action: item.action, state: cloneState(runningState) };
            });
        }

        // 3. çµ„åˆæ–°çš„æ­·å²ç´€éŒ„
        history = [...head, ...tail];

        // 4. UI æ›´æ–°
        lastRenderedState = null; 
        
        // å¼·åˆ¶å°‡ç„¦é»è¨­ç‚ºè¢«åˆªé™¤è€…çš„ã€Œä¸Šä¸€æ­¥ã€
        currentIndex = index - 1;
        if (currentIndex < 0) currentIndex = 0;
        
        if (typeof cancelSelection === 'function') cancelSelection(); 
        
        renderUI(true);
        saveToStorage();

        // --- [é—œéµä¿®æ­£] åˆªé™¤å¾Œå¼·åˆ¶è§£é– Scrollbar ---
        // é€™æ˜¯è§£æ±ºåˆªé™¤å¾Œç„¡æ³•æ²å‹•çš„é—œéµ
        const list = document.getElementById('action-list');
        if (list) {
            list.classList.remove('locked');
        }
        
        // é‡æ–°å®šä½åˆ°ç•¶å‰æ­¥é©Ÿ
        setTimeout(() => {
            scrollToActiveStep();
        }, 100);
		
		// ã€é—œéµæª¢æŸ¥é»ã€‘ç¢ºä¿é€™è£¡æœ‰å‘¼å«é‡ç®—
        calculateSeenCards();
    }

	function applyOperation(state, op) {
	
		// [æ–°å¢] æ¯æ¬¡æ“ä½œå‰ï¼Œé è¨­æ¸…é™¤ä¸Šä¸€æ­¥çš„çŒœæ‹³çµæœ (é™¤éé€™ä¸€æ­¥å°±æ˜¯çŒœæ‹³)
		// é€™æ¨£æ‰ä¸æœƒè®“çŒœæ‹³åœ–ç¤ºä¸€ç›´ç•™åœ¨ç•«é¢ä¸Š
		if (op.type !== 'RPS') {
			state.rpsResult = null;
		}

		// [ä¿®æ”¹] å¦‚æœä¸æ˜¯å°è©±å‹•ä½œï¼Œæ¸…é™¤å°è©±è³‡æ–™ (è®“ç•«é¢æ¶ˆå¤±)
		if (op.type !== 'DIALOGUE') {
			state.dialogueData = null;
		}
		
		if (op.type === 'PASS') return;

		// [æ–°å¢] å°è©±è™•ç†
		if (op.type === 'DIALOGUE') {
			state.dialogueData = op.data; // ç›´æ¥å¥—ç”¨è³‡æ–™
			return; // å°è©±ä¸æ¶‰åŠå…¶ä»–é‚è¼¯
		}
		
		// [æ–°å¢] è™•ç†ç„¡æœˆä¹‹é–€åˆ‡æ›
		if (op.type === 'TOGGLE_MOONLESS') {
            const { cardIds } = op;
            // é˜²å‘†åˆå§‹åŒ– (é¿å…èˆŠå­˜æª”æ²’æœ‰é€™å€‹å±¬æ€§)
            if (!state.moonless) state.moonless = {};
            
            cardIds.forEach(id => {
                if (state.moonless[id]) {
                    delete state.moonless[id];
                } else {
                    state.moonless[id] = true;
                }
            });
        }
		// [æ–°å¢] è™•ç†çŒœæ‹³
		if (op.type === 'RPS') {
			state.rpsResult = op.data;
		}
		// --- æ–°å¢: ç”¨æ–¼åˆ‡æ–·é€£çµçš„æ“ä½œ ---
		if (op.type === 'BREAK_LINKS') {
			const { cardIds } = op;
			state.cards.forEach(c => {
				// [ä¿®æ­£] æ”¹ç”¨ some + == (å¯¬é¬†æ¯”å°)ï¼Œè§£æ±º 1 èˆ‡ "1" ä¸ç›¸ç­‰çš„å•é¡Œ
				if (cardIds.some(id => id == c.id)) { 
					c.parentId = null;
					c.stackType = null;
				}
				if (c.parentId && cardIds.some(id => id == c.parentId)) { 
					c.parentId = null;
					c.stackType = null;
				}
			});
		}
		// --- [æ–°å¢] å‹åˆ©ç‹€æ…‹ ---
		else if (op.type === 'GAME_WIN') {
			const { winnerId } = op;
			state.winner = winnerId;
		}
		// ----------------------
		else if (op.type === 'MOVE') {
			const { cardIds, toZone, faceUp, shuffleSelection, insertIndex, stackTargetId, stackType } = op;
			
            // 1. å…ˆå¾ç‹€æ…‹ä¸­æ‰¾å‡ºé€™äº›å¡ç‰‡ (æ­¤æ™‚é †åºæ˜¯ä¾ç…§åŸæœ¬ state ä¸­çš„é †åºï¼Œä¸ä¸€å®šæ˜¯æˆ‘å€‘æƒ³è¦çš„)
			let movingCards = state.cards.filter(c => cardIds.some(id => id == c.id));
			
            // [é—œéµä¿®æ­£] 2. ä¾ç…§ cardIds (æŒ‡ä»¤ä¸­çš„é †åº) å° movingCards é€²è¡Œé‡æ’
            // é€™æ¨£æ‰èƒ½ç¢ºä¿ã€Œå·¦ä¸Š(ç¬¬ä¸€å¼µ)ã€å°±æ˜¯ä½¿ç”¨è€…ã€Œé¸çš„ç¬¬ä¸€å¼µã€(æˆ–æ˜¯ç‰Œåº«çš„æœ€ä¸Šæ–¹)
            if (shuffleSelection) {
                movingCards.sort(() => Math.random() - 0.5); 
            } else {
                movingCards.sort((a, b) => {
                    // ä½¿ç”¨ findIndex ç¢ºä¿èƒ½æ¯”å°å­—ä¸²èˆ‡æ•¸å­— ID
                    const idxA = cardIds.findIndex(id => id == a.id);
                    const idxB = cardIds.findIndex(id => id == b.id);
                    return idxA - idxB;
                });
            }
			
            // 3. å¾åŸå€åŸŸç§»é™¤
			state.cards = state.cards.filter(c => !cardIds.some(id => id == c.id)); 
			
            // 4. è¨­å®šæ–°å±¬æ€§
			movingCards.forEach(c => {
				c.zone = toZone;
				c.parentId = null;
				c.stackType = null;
				if (faceUp !== undefined) c.faceUp = faceUp;
				if (toZone.includes('hand')) c.rotation = 0; 
				if (stackTargetId) {
					c.parentId = stackTargetId;
					c.stackType = stackType;
				}
			});

            // 5. æ”¾å…¥ç›®æ¨™å€åŸŸ
			if (insertIndex !== undefined && insertIndex !== -1) {
				let zoneCards = state.cards.filter(c => c.zone === toZone);
				let otherCards = state.cards.filter(c => c.zone !== toZone);
				zoneCards.splice(insertIndex, 0, ...movingCards);
				state.cards = [...otherCards, ...zoneCards];
			} else {
				state.cards.push(...movingCards);
			}
		} else if (op.type === 'SHUFFLE') {
			const { zoneId, order } = op; 
			let zoneCards = state.cards.filter(c => c.zone === zoneId);
			let otherCards = state.cards.filter(c => c.zone !== zoneId);
			if (order) {
				// [ä¿®æ­£] å¯¬é¬†æ¯”å°
				zoneCards = order.map(id => state.cards.find(c => c.id == id)).filter(c=>c);
			} else {
				zoneCards.sort(() => Math.random() - 0.5);
			}
			state.cards = [...otherCards, ...zoneCards];

		} else if (op.type === 'ROTATE' || op.type === 'SWITCH_TURN') {
			state.turnPlayer = state.turnPlayer === 1 ? 2 : 1;
		} 
		else if (op.type === 'ROTATE_CARD') {
			const { cardIds, deg, finalRotation } = op;
			state.cards.forEach(c => {
				if (cardIds.some(id => id == c.id)) { // [ä¿®æ­£]
					if (finalRotation !== undefined) c.rotation = finalRotation;
					else c.rotation = (c.rotation + deg) % 360;
				}
			});
		}
		else if (op.type === 'FLIP_CARD') {
			const { cardIds, finalFaceUp } = op;
			state.cards.forEach(c => {
				if (cardIds.some(id => id == c.id)) { // [ä¿®æ­£]
					if (finalFaceUp !== undefined) c.faceUp = finalFaceUp;
					else c.faceUp = !c.faceUp;
				}
			});
		}
		else if (op.type === 'RENAME_CARD') {
			const { cardIds, text } = op;
			const targets = state.cards.filter(c => cardIds.some(id => id == c.id)); // [ä¿®æ­£]
			targets.forEach(target => {
				 state.cards.forEach(c => {
					 if (c.imageKey === target.imageKey) {
						 c.text = text;
					 }
				 });
			});
		}
		else if (op.type === 'RESET_BOARD') {
			const { playerId } = op;
			state.cards.forEach(c => {
				if (c.zone.includes(`p${playerId}-battle`)) {
					c.rotation = 0;
				}
				else if (c.zone.includes(`p${playerId}-mana`)) {
					c.rotation = 180;
				}
			});
		}
		else if (op.type === 'SET_GLOW') {
			const { cardIds, color } = op;
			state.cards.forEach(c => {
				if (cardIds.some(id => id == c.id)) { // [ä¿®æ­£]
					if (c.zone.includes('ability')) {
						c.glow = color;
						if (c.sourceId) {
							const source = state.cards.find(s => s.id == c.sourceId); // [ä¿®æ­£]
							if (source) {
								source.glow = color;
							}
						}
					}
				}
			});
		}
		// --- é—œéµä¿®æ­£å€å¡Šï¼šINJURED æ“ä½œ ---
		else if (op.type === 'INJURED') {
			const { cardIds, setInjured } = op;
			state.cards.forEach(c => {
				// [ä¿®æ­£] ä½¿ç”¨ some + == é€²è¡Œå¯¬é¬†æ¯”å° (1 == "1" ç‚º true)
				// é€™æ˜¯ä¿®å¾©åŒ¯å…¥å¾Œè‡ªå‹•æ¸…é™¤å—å‚·å¤±æ•ˆçš„é—œéµ
				if (cardIds.some(id => id == c.id)) {
					c.isInjured = setInjured;
				}
			});
		}
		// --------------------------------
		else if (op.type === 'CREATE_ABILITY') {
			const { sourceCardId, targetZone, newId, isContinuous } = op;
			const source = state.cards.find(c => c.id == sourceCardId);
			
			// å˜—è©¦æ‰¾å›ä¾†æºå¡ (é˜²å‘†é‚è¼¯ä¿æŒä¸è®Š)
			let effectiveSource = source;
			if (!effectiveSource) {
				effectiveSource = state.cards.find(c => 
					c.ownerId === (targetZone.includes('p1') ? 1 : 2) && 
					(c.zone.includes('battle') || c.zone.includes('mana')) &&
					true 
				);
			}

			if (effectiveSource) {
				// [æ ¸å¿ƒä¿®æ­£] ç›´æ¥ä½¿ç”¨æ“ä½œæŒ‡ä»¤ä¸­è¨˜éŒ„çš„ IDï¼Œä¸å†é‡æ–°è¨ˆç®—
				// å¦‚æœæ˜¯èˆŠç‰ˆå­˜æª”æ²’æœ‰ newIdï¼Œæ‰ä½¿ç”¨ fallback (å…¼å®¹èˆŠç‰ˆ)
				let idToUse = newId;
				if (!idToUse) {
					// åªæœ‰èˆŠç‰ˆå­˜æª”æœƒé€²ä¾†é€™è£¡
					idToUse = (state.cards.reduce((max, c) => Math.max(max, c.id), 0) + 1);
				}

				const suffix = isContinuous ? " (Cont)" : " (Eff)";
				const newCard = new Card(idToUse, effectiveSource.ownerId, effectiveSource.text + suffix, targetZone);
				
				newCard.faceUp = true;
				newCard.rotation = 0;
				newCard.imageKey = effectiveSource.imageKey; 
				newCard.backImageKey = effectiveSource.backImageKey;
				newCard.image = effectiveSource.image; 
				newCard.text = effectiveSource.text;
				newCard.sourceId = effectiveSource.id;
				
				if (isContinuous) newCard.isContinuous = true;

				// [é—œéµ] è¨­å®šå”¯ä¸€çš„ StyleKeyï¼Œç¢ºä¿ä½ç½®è¨­å®šè·Ÿè‘—é€™å¼µå¡è·‘ï¼Œè€Œä¸æ˜¯è·Ÿè‘—åœ–ç‰‡è·‘
				// é€™æ¨£å³ä½¿å…©å¼µå¡ç”¨åŒä¸€å¼µåœ–ï¼Œä½ç½®ä¹Ÿå¯ä»¥ä¸åŒ
				newCard.styleKey = 'style_' + idToUse;

				// åˆå§‹åŒ–æ¨£å¼ï¼šå¦‚æœé€™å¼µåœ–ä»¥å‰èª¿éï¼Œç¹¼æ‰¿ä¸Šæ¬¡çš„ä½ç½®ï¼›å¦å‰‡æ­¸é›¶
				if (!globalAbilityStyleRegistry[newCard.styleKey]) {
					let initialStyle = { x: 50, y: 50, scale: 1.2 };
					
					// å„ªå…ˆç¹¼æ‰¿ã€Œé€™å¼µåœ–ç‰‡æœ€å¾Œä¸€æ¬¡è¢«èª¿æ•´çš„æ¨£å­ã€(User Friendly)
					if (globalLastUsedStyles && globalLastUsedStyles[effectiveSource.imageKey]) {
						initialStyle = { ...globalLastUsedStyles[effectiveSource.imageKey] };
					} 
					// å…¶æ¬¡ç¹¼æ‰¿åœ–ç‰‡æœ¬èº«çš„è¨­å®š
					else if (globalAbilityStyleRegistry[effectiveSource.imageKey]) {
						initialStyle = { ...globalAbilityStyleRegistry[effectiveSource.imageKey] };
					}
					
					globalAbilityStyleRegistry[newCard.styleKey] = initialStyle;
				}

				state.cards.push(newCard);
			}
		}
		else if (op.type === 'DELETE_CARD') {
			const { cardIds } = op;
			cardIds.forEach(id => {
			   const c = state.cards.find(x => x.id == id); // [ä¿®æ­£]
			   if (c && c.zone.includes('ability') && c.sourceId) {
				   const source = state.cards.find(s => s.id == c.sourceId); // [ä¿®æ­£]
				   if (source) source.glow = null;
			   }
			});
			state.cards = state.cards.filter(c => !cardIds.some(id => id == c.id)); // [ä¿®æ­£]
		}
		else if (op.type === 'POINT') { }
		else if (op.type === 'ATTACK') {
			const { attackerId } = op;
			const card = state.cards.find(c => c.id == attackerId); // [ä¿®æ­£]
			if(card) {
				card.rotation = 90; 
			}
		}
		else if (op.type === 'ADD_NOTE') {
			const { cardIds, note } = op;
			state.cards.forEach(c => {
				if(cardIds.some(id => id == c.id)) c.note = note; // [ä¿®æ­£]
			});
		}
		else if (op.type === 'ADJUST_STYLE') {
			const { cardIds, key, val, isDelta } = op;
			state.cards.forEach(c => {
				if(cardIds.some(id => id == c.id)) { // [ä¿®æ­£]
					if (isDelta) c[key] += val;
					else c[key] = val;
				}
			});
		}
		else if (op.type === 'SET_BGM') {
            const { filename } = op;
            state.bgm = filename;
        }
		// åœ¨ applyOperation å‡½å¼å…§éƒ¨çš„ if-else éˆä¸­åŠ å…¥ï¼š
		// ä¿®æ”¹ç‚º (ç›´æ¥åˆªé™¤æˆ–è¨»è§£æ‰)ï¼š
		else if (op.type === 'REALITY_BREAK') {
			// ä»€éº¼éƒ½ä¸åšã€‚
			// ç‰¹æ•ˆæ’­æ”¾é‚è¼¯å·²ç§»äº¤çµ¦ renderUI è™•ç†ï¼Œé¿å…åœ¨ Loading è¨ˆç®—æ™‚èª¤è§¸ã€‚
		}
		else if (op.type === 'GAME_END') {
            // åªæœ‰åœ¨è‡ªå‹•æ’­æ”¾æ™‚æ‰è§¸ç™¼ç‰¹æ•ˆï¼Œé¿å…ç·¨è¼¯æ™‚ä¸€ç›´è·³å‡ºä¾†ç…©äºº
            // ä½†å¦‚æœä½ æƒ³åœ¨ç·¨è¼¯æ™‚é è¦½ï¼Œå¯ä»¥ç§»é™¤é€™å€‹ if æª¢æŸ¥
            if (document.body.classList.contains('is-playing') || document.body.classList.contains('mobile-mode')) {
                triggerEnding();
            }
        }// --- [æ–°å¢] EX-Life æ“ä½œ ---
		else if (op.type === 'SET_EX_LIFE') {
			const { targetId, imgKey } = op;
			const card = state.cards.find(c => c.id === targetId);
			if (card) {
				card.exLifeKey = imgKey; // åœ¨å¡ç‰‡ç‰©ä»¶ä¸Šæ–°å¢æ­¤å±¬æ€§
			}
		}
		else if (op.type === 'REMOVE_EX_LIFE') {
			const { targetId } = op;
			const card = state.cards.find(c => c.id === targetId);
			if (card) {
				card.exLifeKey = null; // æ¸…é™¤å±¬æ€§
			}
		}
	}
	
	
	// --- [ä¿®æ”¹] finishMove (ç·¨è¼¯æ™‚ä¸æ’­å‹•ç•«ï¼Œåƒ…è¨˜éŒ„æ¨™è¨˜) ---
	// --- [ä¿®æ­£ç‰ˆ] finishMove (åš´æ ¼é™åˆ¶ï¼šåƒ…æˆ°é¬¥å€äº’è½‰ä¿ç•™ç‹€æ…‹) ---
	function finishMove(toZone, insertIdx, stackTargetId = null, stackType = null) {
		if (!pendingMove) return;

		const movingIds = [...pendingMove.cardIds];
		const isShuffling = pendingMove.shuffle; 

		// 1. éš¨æ©Ÿé †åºè™•ç†
		let finalCardIds = [...movingIds];
		if (isShuffling) {
			finalCardIds.sort(() => Math.random() - 0.5);
		}

		// 2. åˆ‡æ–·èˆŠé€£çµ
		const state = getCurrentDisplayState();
		const needsBreak = movingIds.some(id => {
			const c = state.cards.find(x => x.id === id);
			if (!c) return false;
			if (c.parentId) return true;
			const isParent = state.cards.some(child => child.parentId === c.id);
			if (isParent) return true;
			return false;
		});

		if (needsBreak) {
			addOperation({ type: 'BREAK_LINKS', cardIds: [...movingIds] });
		}

		// 3. åŒæ­¥æ—‹è½‰è§’åº¦
		if (stackTargetId) {
			const targetCard = state.cards.find(c => c.id === stackTargetId);
			if (targetCard) {
				addOperation({ 
					type: 'ROTATE_CARD', 
					cardIds: movingIds, 
					finalRotation: targetCard.rotation 
				});
			}
		}

		// --- [é—œéµä¿®æ­£] ç‹€æ…‹åˆ¤å®šé‚è¼¯ ---
		let faceUp = true; // é è¨­å€¼ï¼šå¤§å¤šæƒ…æ³ç§»å‹•å¾Œéƒ½æ˜¯è¡¨å´ (æ‰‹ç‰Œ->æˆ°å ´, é­”åŠ›->æˆ°å ´, å¢“åœ°->æˆ°å ´)

		// A. é€²å…¥éš±è—å€åŸŸ -> å¼·åˆ¶è“‹ç‰Œ
		if (toZone.includes('shield') || toZone.includes('deck')) {
			faceUp = false;
		}
		// B. P2 æ‰‹ç‰Œ -> å¼·åˆ¶è¡¨å´ (å°æ“ä½œè€…å¯è¦‹)
		else if (toZone.includes('hand') && toZone.includes('p2')) {
			faceUp = true;
		}
		// C. [ä¿®æ­£] åªæœ‰ã€Œæˆ°é¬¥å€ -> æˆ°é¬¥å€ã€æ‰ä¿ç•™åŸæœ¬ç‹€æ…‹
		else if (toZone.includes('battle')) {
			const firstCard = state.cards.find(c => c.id === movingIds[0]);
			
			// æª¢æŸ¥ä¾†æºæ˜¯å¦ä¹Ÿæ˜¯æˆ°é¬¥å€
			if (firstCard && firstCard.zone.includes('battle')) {
				// æ˜¯å ´ä¸Šçš„å¡ç§»å‹• (ä¾‹å¦‚å †ç–Šé€²åŒ–å…ƒ)ï¼Œä¿ç•™ç›®å‰çš„è¡¨/è£¡ç‹€æ…‹
				faceUp = firstCard.faceUp;
			} else {
				// å¾æ‰‹ç‰Œã€é­”åŠ›å€ã€å¢“åœ°ç­‰å…¶ä»–åœ°æ–¹ä¾†çš„ -> å¼·åˆ¶ç¿»é–‹
				faceUp = true;
			}
		}
		// D. é€²å…¥é­”åŠ›å€ -> å¼·åˆ¶è¡¨å´ (ä¸¦åœ¨ä¸‹æ–¹è½‰180åº¦)
		else if (toZone.includes('mana')) {
			faceUp = true;
		}

		// 4. åŸ·è¡Œç§»å‹•æŒ‡ä»¤
		addOperation({
			type: 'MOVE',
			cardIds: finalCardIds, 
			toZone: toZone,
			faceUp: faceUp, // å¥—ç”¨åˆ¤å®šçµæœ
			shuffleSelection: false, 
			withShuffleAnim: isShuffling, 
			insertIndex: insertIdx,
			stackTargetId: stackTargetId,
			stackType: stackType
		});

		// 5. å€åŸŸç‰¹æ®Šè™•ç† (é­”åŠ›å€å€’ç½®)
		if (toZone.includes('mana')) {
			addOperation({ type: 'ROTATE_CARD', cardIds: movingIds, deg: 180 });
		}
		
		// é€²å…¥ç‰Œåº«/å¢“åœ°/è¶…æ¬¡å…ƒ -> è½‰æ­£ (0åº¦)
		if (toZone.includes('deck') || toZone.includes('grave') || toZone.includes('hyper')) {
			addOperation({ 
				type: 'ROTATE_CARD', 
				cardIds: movingIds, 
				finalRotation: 0 
			});
		}

		cancelSelection();
		closeSelectorModal();
		closePositionModal();
	}

    function actionShuffleZone() {
        const zoneId = document.getElementById('modal-title').getAttribute('data-zone-id');
        if(!zoneId) return;
        
        const state = getCurrentDisplayState();
        const cards = getCardsInZone(state, zoneId);
        const ids = cards.map(c => c.id);
        ids.sort(() => Math.random() - 0.5); 
        
        addOperation({ type: 'SHUFFLE', zoneId: zoneId, order: ids });
        //closeSelectorModal();
		// ç¨å¾®å»¶é²ä¸€é»é»ï¼Œç¢ºä¿ addOperation å·²ç¶“æ›´æ–°äº† history/tempState
        setTimeout(() => {
            openSelectorModal(zoneId);
        }, 50);
    }
	
	// --- [æ–°å¢] æ‹–æ›³ä¸­ï¼šåªæ›´æ–° UI æ–‡å­—ï¼Œä¸åˆ‡æ›ç•«é¢/éŸ³æ¨‚ ---
    function handleSliderDragging(val) {
        const step = parseInt(val);
        const tooltip = document.getElementById('slider-tooltip');
        
        // åªæ›´æ–° tooltip æ–‡å­—ï¼Œå‘Šè¨´ä½¿ç”¨è€…ç¾åœ¨æ‹–åˆ°ç¬¬å¹¾æ­¥äº†
        if (tooltip) {
            tooltip.innerText = `${step}/${history.length - 1}`;
        }
    }

    // --- [æ–°å¢] æ”¾é–‹å¾Œï¼šæ­£å¼åˆ‡æ› ActionLog èˆ‡ éŸ³æ¨‚ ---
    function handleSliderRelease(val) {
        const step = parseInt(val);
        
        // 1. æ›´æ–°å…¨åŸŸæ­¥é©Ÿç´¢å¼•
        currentIndex = step;
        
        // 2. é‡ç¹ªç•«é¢ (ActionLog æœƒåœ¨é€™è£¡æ›´æ–°)
        renderUI();
        
        // 3. å­˜æª” (éæ‰‹æ©Ÿç‰ˆæ‰å­˜ï¼Œé¿å…è¦†è“‹)
        if(!document.body.classList.contains('mobile-mode')) {
            saveToStorage();
        }

        // 4. [éœ€æ±‚ 2] åŒæ­¥éŸ³æ¨‚ç‹€æ…‹
        // ç•¶ä½¿ç”¨è€…æ”¾é–‹é€²åº¦æ¢ï¼Œæˆ‘å€‘æª¢æŸ¥è©²æ­¥é©Ÿçš„ BGM è¨­å®š
        const state = getCurrentDisplayState();
        const targetBgm = state.bgm;

        if (targetBgm) {
            const targetSrc = BGM_FOLDER + targetBgm;
            // å¦‚æœ BGM ä¸åŒï¼Œæ‰é€²è¡Œåˆ‡æ›
            // encodeURI é¿å…æª”åç©ºç™½é€ æˆèª¤åˆ¤
            if (!globalAudioPlayer.src.includes(encodeURI(targetBgm))) {
                globalAudioPlayer.src = targetSrc;
                
                // å¦‚æœç›®å‰ã€Œä¸æ˜¯éœéŸ³ã€ï¼Œå°±è‡ªå‹•æ’­æ”¾æ–°çš„ BGM
                // å¦‚æœæ˜¯éœéŸ³ (muted=true)ï¼Œé€™è£¡ play ä¹Ÿåªæœƒç¹¼çºŒéœéŸ³æ’­æ”¾ï¼Œç¬¦åˆé æœŸ
                globalAudioPlayer.play().catch(e => {});
            }
        } else {
            // å¦‚æœè©²æ­¥é©Ÿæ²’æœ‰ BGMï¼Œå°±æš«åœ
            globalAudioPlayer.pause();
        }
    }

    function rotateCard(deg) {
		if (!pendingMove || pendingMove.cardIds.length === 0) return;
		const state = getCurrentDisplayState();

		// --- 1. å°‹æ‰¾æ•´çµ„é—œè¯å¡ç‰‡ (ä¿æŒåŸæ¨£) ---
		const getRoot = (cardId) => {
			let current = state.cards.find(c => c.id === cardId);
			while (current && current.parentId) {
				const parent = state.cards.find(c => c.id === current.parentId);
				if (!parent) break;
				current = parent;
			}
			return current;
		};

		const getRotatableTree = (rootIds) => {
			const results = new Set();
			const queue = [...rootIds];
			rootIds.forEach(id => results.add(id));
			while(queue.length > 0) {
				const currentId = queue.shift();
				const children = state.cards.filter(c => c.parentId === currentId);
				const isMoonless = state.moonless && state.moonless[currentId];
				children.forEach(child => {
					if (isMoonless && child.stackType === 'bottom') return;
					if (!results.has(child.id)) {
						results.add(child.id);
						queue.push(child.id);
					}
				});
			}
			return Array.from(results);
		};

		const roots = new Set();
		pendingMove.cardIds.forEach(id => {
			const r = getRoot(id);
			if (r) roots.add(r.id);
		});

		const allTargets = getRotatableTree(Array.from(roots));

		// --- 2. é€å‡ºæŒ‡ä»¤ (é—œéµä¿®æ”¹) ---
		// [Fix] ç§»é™¤ç¬¬äºŒå€‹åƒæ•¸ (true)ï¼Œè®“ addOperation è‡ªå‹•è§¸ç™¼ renderUI()
		// é€™æ¨£ä»‹é¢æœƒæ•´å€‹é‡ç•«ï¼ŒexpandStack å°±èƒ½è®€åˆ°æœ€æ–°çš„ rotation
		addOperation({ type: 'ROTATE_CARD', cardIds: allTargets, deg: deg }); 

		// --- 3. ç§»é™¤èˆŠçš„æ‰‹å‹• DOM æ›´æ–°ä»£ç¢¼ ---
		// (åŸæœ¬é€™è£¡æœ‰ä¸€å¤§æ®µ allTargets.forEach... ä¿®æ”¹ style.transform çš„ç¨‹å¼ç¢¼ï¼Œè«‹å…¨éƒ¨åˆªé™¤)
		// å› ç‚º renderUI() å·²ç¶“æœƒç”¢ç”Ÿæ­£ç¢ºè§’åº¦çš„æ–° DOM äº†ã€‚
	}

    function flipCard() {
        if (!pendingMove) return;
        const state = getCurrentDisplayState();
        const card = state.cards.find(c => c.id === pendingMove.cardIds[0]);
        const targetFace = !card.faceUp;
        addOperation({ type: 'FLIP_CARD', cardIds: pendingMove.cardIds, finalFaceUp: targetFace });
    }

    // [å„ªåŒ–] æ›´åï¼šç›´æ¥ä¿®æ”¹ innerText
	function renameCard() {
		if (!pendingMove || pendingMove.cardIds.length !== 1) return;
		const id = pendingMove.cardIds[0];
		const val = document.getElementById('rename-input').value;
		
		const op = { type: 'RENAME_CARD', cardIds: [id], text: val };
		addOperation(op, true);
		
		const el = document.querySelector(`.card[data-id="${id}"] .card-text`);
		if(el) el.innerText = val;
	}
    
    // [ä¿®æ­£] è¨»è¨˜ï¼šä½¿ç”¨æ­£ç¢ºçš„ ADD_NOTE æŒ‡ä»¤
	function addCardNote() {
		if (!pendingMove || pendingMove.cardIds.length === 0) return;
		const val = document.getElementById('note-input').value;
		
		// æŒ‡ä»¤åç¨±ä¿®æ­£ç‚º ADD_NOTE
		const op = { type: 'ADD_NOTE', cardIds: [...pendingMove.cardIds], note: val };
		addOperation(op, true);
		
		pendingMove.cardIds.forEach(id => {
			const cardEl = document.querySelector(`.card[data-id="${id}"]`);
			if (cardEl) {
				let noteEl = cardEl.querySelector('.card-note');
				if (val) {
					if (!noteEl) {
						noteEl = document.createElement('div');
						noteEl.className = 'card-note';
						cardEl.appendChild(noteEl);
					}
					noteEl.innerText = val;
				} else {
					if (noteEl) noteEl.remove();
				}
			}
		});
	}
    
    // 1. èª¿æ•´ä½ç½®å¾Œå­˜æª”
	function adjustAbilityCard(key, val) {
		if (!pendingMove || pendingMove.cardIds.length === 0) return;
		
		const state = getCurrentDisplayState();
		const targetIds = pendingMove.cardIds;
		let hasChanges = false;

		targetIds.forEach(id => {
			const c = state.cards.find(card => card.id === id);
			if (c) {
				// ç¢ºä¿ styleKey å­˜åœ¨
				let keyToUpdate = c.styleKey || ('style_' + c.id);
				c.styleKey = keyToUpdate;

				let currentStyle = globalAbilityStyleRegistry[keyToUpdate] || { x: 50, y: 50, scale: 1 };
				let newStyle = { ...currentStyle };

				if (key === 'panX') newStyle.x += val;
				else if (key === 'panY') newStyle.y += val;
				else if (key === 'scale') newStyle.scale += val;

				globalAbilityStyleRegistry[keyToUpdate] = newStyle;
				
				// è¨˜æ†¶é€™å€‹æ¨£å¼ä¾›ä¸‹æ¬¡ç”Ÿæˆä½¿ç”¨
				if (c.imageKey) {
					globalLastUsedStyles[c.imageKey] = { ...newStyle };
				}

				hasChanges = true;
			}
		});

		if (hasChanges) {
			renderUI();
			// [ä¿®æ­£] å¼·åˆ¶å­˜æª”ï¼Œç¢ºä¿åˆ·æ–°å¾Œä½ç½®é‚„åœ¨
			if(!document.body.classList.contains('mobile-mode')) saveToStorage();
		}
	}
    
    function resetBoard(playerId) {
//        if(!confirm(playerId === 1 ? t('msg_confirm_p1_reset') : t('msg_confirm_p2_reset'))) return;
        addOperation({ type: 'RESET_BOARD', playerId: playerId });
    }
	
	// --- [æ–°å¢] é‡ç½®ç•¶å‰å›åˆç©å®¶çš„ç›¤é¢ ---
    function resetCurrentTurnPlayer() {
        const state = getCurrentDisplayState();
        // è®€å–ç•¶å‰æ˜¯èª°çš„å›åˆ (1 æˆ– 2)ï¼Œä¸¦å‘¼å«åŸæœ¬çš„ resetBoard
        resetBoard(state.turnPlayer);
    }

    // [ä¿®æ­£] ç™¼å…‰ï¼šåƒ…å‘ä¸Šè¿½æº¯ (Child -> Source)ï¼Œæ–·é–‹å‘ä¸‹æ“´æ•£ä»¥é¿å…å…„å¼Ÿå¡é€£å‹•
	function toggleGlow() {
		if (!pendingMove || pendingMove.cardIds.length === 0) return;
		const state = getCurrentDisplayState();

		// --- 1. å°‹æ‰¾é—œè¯å¡ç‰‡ (åƒ…å‘ä¸Š) ---
		const getLinkedGroup = (startIds) => {
			const resultIds = new Set();
			const queue = [...startIds];
			// å…ˆå°‡é¸å–çš„å¡ç‰‡åŠ å…¥çµæœ
			startIds.forEach(id => resultIds.add(id));

			let idx = 0;
			while(idx < queue.length){
				const currId = queue[idx++];
				const currCard = state.cards.find(c => c.id === currId);
				if (!currCard) continue;

				// A. å¾€ä¸Šæ‰¾ (Find Parents/Sources)
				// é€™æ˜¯ç‚ºäº†è®“æ•ˆæœå¡(101)èƒ½æ‰¾åˆ°æœ¬é«”(100)
				const sourceId = currCard.sourceId;
				if (sourceId && !resultIds.has(sourceId)) {
					resultIds.add(sourceId);
					queue.push(sourceId);
				}

				// [ä¿®æ”¹é»] ç§»é™¤äº†ã€ŒB. å¾€ä¸‹æ‰¾ã€çš„é‚è¼¯
				// åŸæœ¬çš„ç¨‹å¼ç¢¼æœƒåœ¨é€™è£¡æœå°‹æ‰€æœ‰ sourceId === currId çš„å¡ç‰‡ (å³å…„å¼Ÿå¡)
				// ç§»é™¤å¾Œï¼Œé»æ“Š 101 åªæœƒæ‰¾åˆ° 100ï¼Œè€Œ 100 ä¸æœƒå†å›é ­å»æ‰¾ 102ï¼Œé”æˆæ‚¨çš„éœ€æ±‚ã€‚
			}
			return Array.from(resultIds);
		};

		const allTargetIds = getLinkedGroup(pendingMove.cardIds);

		// ----------------------------------------
		// ä»¥ä¸‹é‚è¼¯ç¶­æŒä¸è®Š (æ±ºå®šé¡è‰²èˆ‡é€å‡ºæŒ‡ä»¤)
		// ----------------------------------------
		
		// 2. æ±ºå®šä¸‹ä¸€å€‹é¡è‰²
		const mainCardId = allTargetIds.find(id => {
			const c = state.cards.find(x => x.id === id);
			return c && (c.zone.includes('battle') || c.zone.includes('hand') || c.zone.includes('mana'));
		}) || allTargetIds[0];
		
		const mainCard = state.cards.find(c => c.id === mainCardId);
		const colors = ['red', 'yellow', 'green', 'blue', 'black', 'white', 'rainbow', null];
		
		let currentGlow = mainCard ? mainCard.glow : null;
		if (currentGlow && currentGlow.startsWith('bottom-')) currentGlow = null;

		let idx = colors.indexOf(currentGlow);
		if (idx === -1) idx = 7; 
		let nextColor = colors[(idx + 1) % colors.length];

		// 3. é€å‡ºæŒ‡ä»¤
		const op = { type: 'SET_GLOW', cardIds: allTargetIds, color: nextColor };
		addOperation(op, true); 

		// 4. æ‰‹å‹•æ›´æ–° DOM
		allTargetIds.forEach(id => {
			const el = document.querySelector(`.card[data-id="${id}"]`);
			if (el) {
				el.classList.forEach(cls => {
					if(cls.startsWith('glow-') && cls !== 'glow-unseen') el.classList.remove(cls);
				});
				if (nextColor) el.classList.add(`glow-${nextColor}`);
			}
		});
	}

	// [ä¿®æ­£] åº•å…‰ï¼šåƒ…å‘ä¸Šè¿½æº¯ (Child -> Source)ï¼Œæ–·é–‹å‘ä¸‹æ“´æ•£ä»¥é¿å…å…„å¼Ÿå¡é€£å‹•
	function toggleBottomGlow() {
		if (!pendingMove || pendingMove.cardIds.length === 0) return;
		const state = getCurrentDisplayState();

		// 1. å°‹æ‰¾é—œè¯å¡ç‰‡ (åƒ…å‘ä¸Š)
		const getLinkedGroup = (startIds) => {
			const resultIds = new Set();
			const queue = [...startIds];
			startIds.forEach(id => resultIds.add(id));

			let idx = 0;
			while(idx < queue.length){
				const currId = queue[idx++];
				const currCard = state.cards.find(c => c.id === currId);
				if (!currCard) continue;

				// A. å¾€ä¸Šæ‰¾ (Find Parents/Sources)
				if (currCard.sourceId && !resultIds.has(currCard.sourceId)) {
					resultIds.add(currCard.sourceId);
					queue.push(currCard.sourceId);
				}

				// [ä¿®æ”¹é»] é€™è£¡åŸæœ¬æœ‰çš„ã€ŒB. å¾€ä¸‹æ‰¾ (Downward)ã€é‚è¼¯å·²ç§»é™¤
				// é€™æ¨£å¯ä»¥é˜²æ­¢é€éæœ¬é«” (Source) æŠ“åˆ°å…¶ä»–çš„æ•ˆæœå¡ (Siblings)
			}
			return Array.from(resultIds);
		};

		const allTargetIds = getLinkedGroup(pendingMove.cardIds);

		// ----------------------------------------
		// ä»¥ä¸‹é‚è¼¯ç¶­æŒä¸è®Š (æ±ºå®šé¡è‰²èˆ‡é€å‡ºæŒ‡ä»¤)
		// ----------------------------------------

		// 2. æ±ºå®šé¡è‰²
		const mainCardId = allTargetIds.find(id => {
			const c = state.cards.find(x => x.id === id);
			return c && (c.zone.includes('battle') || c.zone.includes('hand') || c.zone.includes('mana'));
		}) || allTargetIds[0];

		const mainCard = state.cards.find(c => c.id === mainCardId);
		const bottomColors = [
			'bottom-red', 'bottom-yellow', 'bottom-green', 'bottom-blue', 'bottom-black', 'bottom-white', 'bottom-rainbow'
		];
		
		let currentGlow = mainCard ? mainCard.glow : null;
		// å¦‚æœç›®å‰æ˜¯æ™®é€šç™¼å…‰ï¼Œè¦–ç‚ºç„¡åº•å…‰ï¼Œå¾é ­é–‹å§‹
		if (currentGlow && !currentGlow.startsWith('bottom-')) currentGlow = null;

		let idx = bottomColors.indexOf(currentGlow);
		let nextColor;
		if (idx === -1) {
			nextColor = bottomColors[0];
		} else {
			nextColor = bottomColors[(idx + 1) % bottomColors.length];
		}

		// 3. é€å‡ºæŒ‡ä»¤
		const op = { type: 'SET_GLOW', cardIds: allTargetIds, color: nextColor };
		addOperation(op, true); 

		// 4. æ‰‹å‹•æ›´æ–° DOM
		allTargetIds.forEach(id => {
			const el = document.querySelector(`.card[data-id="${id}"]`);
			if (el) {
				el.classList.forEach(cls => {
					if(cls.startsWith('glow-') && cls !== 'glow-unseen') el.classList.remove(cls);
				});
				if (nextColor) el.classList.add(`glow-${nextColor}`);
			}
		});
	}

    function removeGlow() {
        if (!pendingMove) return;
        // Same strict check for removing glow manually via UI
        const state = getCurrentDisplayState();
        const invalid = pendingMove.cardIds.some(id => {
            const c = state.cards.find(x => x.id === id);
            return !c || !c.zone.includes('ability');
        });
        
        if (invalid) {
             alert(t('msg_glow_ability_only'));
             return;
        }

        addOperation({ type: 'SET_GLOW', cardIds: pendingMove.cardIds, color: null });
    }
    
    function revealCards() {
        if(!pendingMove) return;
        finishMove('reveal-zone', undefined);
    }
    
    function revealFromSelector() {
        if(selectedCardsInModal.length === 0) return;
        pendingMove = { cardIds: [...selectedCardsInModal], shuffle: false };
        closeSelectorModal();
        finishMove('reveal-zone', undefined);
    }
    
    function closeRevealZone() {
        if(confirm(t('msg_confirm_reveal_close'))) {
             const state = getCurrentDisplayState();
             const cards = state.cards.filter(c => c.zone === 'reveal-zone');
             const p1Cards = cards.filter(c => c.ownerId === 1).map(c=>c.id);
             const p2Cards = cards.filter(c => c.ownerId === 2).map(c=>c.id);
             
             if (!isDrafting) startDraftAtEnd();
             
             if(p1Cards.length > 0) {
                 addOperation({
                    type: 'MOVE',
                    cardIds: p1Cards,
                    toZone: 'p1-grave',
                    faceUp: true,
                    shuffleSelection: false
                 });
             }
             if(p2Cards.length > 0) {
                 addOperation({
                    type: 'MOVE',
                    cardIds: p2Cards,
                    toZone: 'p2-grave',
                    faceUp: true,
                    shuffleSelection: false
                 });
             }
             saveDraft(t('desc_end_reveal'));
        }
    }

    function endPoint() {
        if (isDrafting) {
            alert(t('msg_point_save_first'));
            return;
        }
        startDraftAtEnd();
        addOperation({ type: 'PASS' });
        saveDraft(t('desc_end_point'));
    }
	
	// --- [æ–°å¢] è§¸ç™¼å‹åˆ© ---
    // --- [ä¿®æ­£ç‰ˆ] triggerWin ---
	function triggerWin(winnerId) {
		// 1. å¦‚æœä¸åœ¨ç·¨è¼¯æ¨¡å¼ï¼Œé–‹å•Ÿæ–°æ­¥é©Ÿ (é€™æœƒè§¸ç™¼ startDraft çš„ 50ms é–å®šè¨ˆæ™‚å™¨)
		if (!isDrafting) startDraftAtEnd();
		
		// 2. åŠ å…¥å‹åˆ©å‹•ä½œ
		addOperation({ 
			type: 'GAME_WIN', 
			winnerId: winnerId 
		});
		
		// 3. å„²å­˜ (é€™æœƒå˜—è©¦è§£é™¤é–å®š)
		saveDraft(`Player ${winnerId} ç²å‹!!`);

		// 4. [é—œéµä¿®æ­£] å¼·åˆ¶ä¿®å¾© ScrollBar
		// è¨­å®šä¸€å€‹æ¯” startDraft (50ms) æ›´æ™šåŸ·è¡Œçš„è¨ˆæ™‚å™¨ (ä¾‹å¦‚ 100ms)
		// ç¢ºä¿æœ€å¾Œç‹€æ…‹ä¸€å®šæ˜¯ã€Œç§»é™¤ lockedã€
		setTimeout(() => {
			const list = document.getElementById('action-list');
			if (list) list.classList.remove('locked');
		}, 100);
	}
	
	// --- [æ–°å¢] å‹åˆ©é¸å–®è™•ç†å‡½å¼ ---
    function handleWinSelect(el) {
        const val = el.value;
        if (!val) return; // å¦‚æœé¸çš„æ˜¯é è¨­å€¼ï¼Œä¸å‹•ä½œ
        
        // 1. åŸ·è¡Œå‹åˆ©é‚è¼¯
        triggerWin(parseInt(val));
        
        // 2. åŸ·è¡Œå¾Œè‡ªå‹•æ­¸ä½ (è®Šå›é è¨­é¸é …)ï¼Œæ–¹ä¾¿ä¸‹æ¬¡æ“ä½œ
        el.value = ""; 
        el.blur(); // ç§»é™¤ç„¦é»ï¼Œé¿å…èª¤è§¸
    }
	
	// [ä¿®æ­£] å—å‚·ï¼šæ¢å¾© INJURED æŒ‡ä»¤
	function toggleInjured() {
		if (!pendingMove || pendingMove.cardIds.length === 0) return;
		const state = getCurrentDisplayState();

		// 1. æª¢æŸ¥å€åŸŸ
		const validZones = ['p1-battle', 'p2-battle', 'p1-shield', 'p2-shield'];
		const isValid = pendingMove.cardIds.every(id => {
			const c = state.cards.find(x => x.id === id);
			return c && validZones.includes(c.zone);
		});
		if (!isValid) { alert(t('msg_injured_err')); return; }

		// 2. è¨ˆç®—ç‹€æ…‹ (åªè¦æœ‰ä¸€å¼µå—å‚·ï¼Œå°±å…¨éƒ¨æ”¹ç‚ºæœªå—å‚·ï¼›å¦å‰‡å…¨éƒ¨å—å‚·)
		const hasInjured = pendingMove.cardIds.some(id => {
			const c = state.cards.find(x => x.id === id);
			return c.isInjured;
		});
		const nextState = !hasInjured;

		// 3. é€å‡ºæŒ‡ä»¤
		const op = { type: 'INJURED', cardIds: [...pendingMove.cardIds], setInjured: nextState };
		addOperation(op, true);

		// 4. æ‰‹å‹•æ›´æ–° DOM
		pendingMove.cardIds.forEach(id => {
			const el = document.querySelector(`.card[data-id="${id}"]`);
			if (el) {
				const oldClaw = el.querySelector('.claw-overlay');
				if (oldClaw) oldClaw.remove();

				if (nextState) {
					const clawDiv = document.createElement('div');
					// ç·¨è¼¯æ™‚ä¸åŠ å‹•ç•« class ä»¥å…ä¸€ç›´æ’­æ”¾
					clawDiv.className = 'claw-overlay'; 
					clawDiv.innerHTML = `
						<svg class="claw-svg" viewBox="0 0 100 100">
							<path class="claw-path p1" d="M20,20 Q50,50 80,80" />
							<path class="claw-path p2" d="M30,10 Q60,40 90,70" />
							<path class="claw-path p3" d="M10,30 Q40,60 70,90" />
						</svg>
					`;
					el.appendChild(clawDiv);
				}
			}
		});
		
		// å¼·åˆ¶åˆ·æ–°æ“ä½œé¢æ¿æŒ‰éˆ•ç‹€æ…‹ (è®Šè‰²)
		if(typeof updateSelectionUI === 'function') updateSelectionUI();
	}

	// --- [æ–°å¢] BGM ç›¸é—œé‚è¼¯ ---

    let tempSelectedBgm = null; // æš«å­˜ä½¿ç”¨è€…åœ¨ Modal ä¸­é¸çš„éŸ³æ¨‚

    function openBGMModal() {
        // å¦‚æœæ­£åœ¨ç·¨è¼¯é BGM çš„å‹•ä½œï¼Œé˜»æ­¢ (Optional)
        if (isDrafting && draftOperations.length > 0 && !draftOperations.some(o => o.type === 'SET_BGM')) {
            alert("è«‹å…ˆå®Œæˆç›®å‰çš„ç·¨è¼¯å‹•ä½œã€‚");
            return;
        }

        const listEl = document.getElementById('bgm-list');
        listEl.innerHTML = '';
        tempSelectedBgm = null;

        // 1. åŠ å…¥ã€Œåœæ­¢æ’­æ”¾ã€é¸é …
        const stopItem = createBGMItem(null, t('opt_bgm_stop'));
        listEl.appendChild(stopItem);

        // 2. åŠ å…¥æª”æ¡ˆåˆ—è¡¨
        BGM_FILES.forEach(filename => {
            listEl.appendChild(createBGMItem(filename, filename));
        });

        // é è¨­é¸å–ç•¶å‰ç‹€æ…‹çš„ BGM (å¦‚æœæœ‰çš„è©±)
        const currentState = getCurrentDisplayState();
        if (currentState.bgm) {
            selectBGMPreview(currentState.bgm);
        } else {
            selectBGMPreview(null);
        }

        document.getElementById('bgm-modal').style.display = 'flex';
    }

    function createBGMItem(filename, label) {
        const div = document.createElement('div');
        div.className = 'bgm-item';
        div.dataset.file = filename || '';
        div.innerText = label;
        div.onclick = () => selectBGMPreview(filename);
        return div;
    }

    function selectBGMPreview(filename) {
		tempSelectedBgm = filename;

		// [æ–°å¢] ç•¶ä½¿ç”¨è€…é–‹å§‹é¸æ“‡/è©¦è½éŸ³æ¨‚æ™‚ï¼Œå…ˆæš«åœåŸæœ¬å…¨åŸŸæ’­æ”¾å™¨æ­£åœ¨æ’¥æ”¾çš„éŸ³æ¨‚
		if (typeof globalAudioPlayer !== 'undefined') {
			globalAudioPlayer.pause();
		}

		// UI æ›´æ–° (ç¶­æŒåŸæ¨£)
		document.querySelectorAll('.bgm-item').forEach(el => {
			el.classList.remove('selected', 'playing-preview');
			const targetVal = filename === null ? '' : filename;
			if (el.dataset.file === targetVal) {
				el.classList.add('selected');
				if (filename) el.classList.add('playing-preview');
			}
		});

		// è©¦è½é‚è¼¯ (ç¶­æŒåŸæ¨£)
		if (filename) {
			previewAudioPlayer.src = BGM_FOLDER + filename;
			previewAudioPlayer.currentTime = 0;
			previewAudioPlayer.play().catch(e => console.warn("Preview play failed", e));
		} else {
			previewAudioPlayer.pause();
		}
	}

    function closeBGMModal() {
        document.getElementById('bgm-modal').style.display = 'none';
        previewAudioPlayer.pause(); // é—œé–‰è¦–çª—å³åœæ­¢è©¦è½
    }

    function confirmBGM() {
        closeBGMModal();

        // åˆ¤æ–·ï¼šå¦‚æœç›®å‰å·²ç¶“æ˜¯ç·¨è¼¯æ¨¡å¼ä¸”æœ‰ SET_BGMï¼Œå‰‡è¦†è“‹ï¼›å¦å‰‡æ–°å¢
        if (draftOperations.length > 0 && draftOperations[0].type === 'SET_BGM') {
            draftOperations = [];
        }

        addOperation({
            type: 'SET_BGM',
            filename: tempSelectedBgm
        });

        // è‡ªå‹•å­˜æª”ä¸¦çµæŸé€™ä¸€æ­¥ (å› ç‚º BGM è¨­å®šé€šå¸¸æ˜¯ç¨ç«‹å‹•ä½œ)
        let desc = tempSelectedBgm ? 
			t('desc_bgm_play').replace('{name}', tempSelectedBgm) : 
			t('desc_bgm_stop');
        saveDraft(desc);
    }
	
	// --- [æ–°å¢] çŒœæ‹³å‹•ä½œ ---
    function actionRPS() {
        // 1. å®šç¾©é¸é … (0:çŸ³é ­, 1:å¸ƒ, 2:å‰ªåˆ€)
        // ç‚ºäº†æ–¹ä¾¿åˆ¤æ–·å‹è² ï¼š (A - B + 3) % 3
        // çµæœ 0=å¹³æ‰‹, 1=Aè´, 2=Bè´
        const CHOICES = ['rock', 'paper', 'scissors'];
        
        // 2. éš¨æ©Ÿç”¢ç”Ÿçµæœ
        const p1ChoiceIdx = Math.floor(Math.random() * 3);
        const p2ChoiceIdx = Math.floor(Math.random() * 3);
        
        const p1Val = CHOICES[p1ChoiceIdx];
        const p2Val = CHOICES[p2ChoiceIdx];
        
        // 3. åˆ¤æ–·å‹è² 
        // 0: Draw, 1: P1 Win, 2: P2 Win
        const resultCalc = (p1ChoiceIdx - p2ChoiceIdx + 3) % 3;
        let winner = null;
        if (resultCalc === 1) winner = 1;
        if (resultCalc === 2) winner = 2;

        // 4. å¦‚æœä¸åœ¨ç·¨è¼¯æ¨¡å¼ï¼Œé–‹å•Ÿæ–°æ­¥é©Ÿ
        if (!isDrafting) startDraftAtEnd();

        // 5. åŠ å…¥æ“ä½œæŒ‡ä»¤ (å°‡çµæœå¯«æ­»åœ¨ data è£¡)
        addOperation({
            type: 'RPS',
            data: {
                p1: p1Val,
                p2: p2Val,
                winner: winner
            }
        });

        // 6. ç”¢ç”Ÿæè¿°ä¸¦å­˜æª”
        // ç‚ºäº†è®“ Action Log é¡¯ç¤ºæ¸…æ¥šï¼Œæˆ‘å€‘æŠŠçµæœå¯«åœ¨æè¿°è£¡
        const p1Label = t('rps_' + p1Val);
        const p2Label = t('rps_' + p2Val);
        let resultLabel = "";
        
        if (winner === 1) resultLabel = t('rps_p1_win');
        else if (winner === 2) resultLabel = t('rps_p2_win');
        else resultLabel = t('rps_draw');

        saveDraft(`[${t('act_rps')}] P1:${p1Label} vs P2:${p2Label} -> ${resultLabel}`);
        
        // 7. å¦‚æœå¹³æ‰‹ï¼Œè‡ªå‹•è·³å‡ºæç¤ºï¼Œè©¢å•æ˜¯å¦è¦å†ä¾†ä¸€æŠŠ
        if (winner === null) {
            // å»¶é²ä¸€ä¸‹è®“ç•«é¢å…ˆç•«å‡ºä¾†ï¼Œå†è·³æç¤º
            setTimeout(() => {
                // å¦‚æœæ˜¯åœ¨è‡ªå‹•æ’­æ”¾ä¸­ï¼Œå°±ä¸è·³ confirmï¼Œç›´æ¥ç¹¼çºŒ (æ¨¡æ“¬é€£çºŒçŒœæ‹³)
                // å¦‚æœæ˜¯æ‰‹å‹•æ“ä½œï¼Œæ‰è·³ confirm
                if (!document.body.classList.contains('is-playing') && confirm(`${t('rps_draw')}\n${t('msg_rps_again')}`)) {
                    actionRPS(); // éè¿´å‘¼å«ï¼Œç”¢ç”Ÿä¸‹ä¸€å±€
                }
            }, 500);
        }
    }
	
    // [æ–°å¢] æ¸…é™¤å—å‚·ç‹€æ…‹
	function clearInjured() {
		if (!pendingMove) return;
		
		

		// æª¢æŸ¥å€åŸŸé™åˆ¶ (åƒ…æˆ°é¬¥å€èˆ‡è­·ç›¾å€)
		const state = getCurrentDisplayState();
		const validZones = ['p1-battle', 'p2-battle', 'p1-shield', 'p2-shield'];
		const isValid = pendingMove.cardIds.every(id => {
			const c = state.cards.find(x => x.id === id);
			return c && validZones.includes(c.zone);
		});

		if (!isValid) {
			alert(t('msg_injured_err'));
			return;
		}

		// å¼·åˆ¶è¨­å®šç‚º false (æ²»ç™’)
		addOperation({ 
			type: 'INJURED', 
			cardIds: pendingMove.cardIds, 
			setInjured: false 
		});
		
		// ã€æ–°å¢é€™è¡Œã€‘å¼·åˆ¶åˆ·æ–°æ“ä½œé¢æ¿ç‹€æ…‹
        updateSelectionUI();
	}
	
	// --- [ä¿®æ­£ç‰ˆ] è¤‡è£½åˆ°èƒ½åŠ›å€ (åŒæ­¥é¸å–ç‰ˆ) ---
	function copyToAbility(isContinuous = false) {
		if (!pendingMove) return;
		if (pendingMove.cardIds.length !== 1) return alert(t('msg_select_one_copy'));
		
		const state = getCurrentDisplayState();
		const card = state.cards.find(c => c.id === pendingMove.cardIds[0]);
		if (!card) return;
		
		const targetZone = card.ownerId === 1 ? 'p1-ability' : 'p2-ability';
		
		// ä½¿ç”¨æ™‚é–“æˆ³è¨˜ + éš¨æ©Ÿæ•¸ç”Ÿæˆã€Œçµ•å°å”¯ä¸€ IDã€
		const fixedId = parseInt(`${Date.now()}${Math.floor(Math.random() * 1000)}`);
		
		// 1. åŸ·è¡Œæ–°å¢å‹•ä½œ (é€™æœƒè§¸ç™¼ç¬¬ä¸€æ¬¡ renderUIï¼Œç”¢ç”Ÿå¡ç‰‡ DOM)
		addOperation({ 
			type: 'CREATE_ABILITY', 
			sourceCardId: card.id, 
			targetZone: targetZone, 
			newId: fixedId, 
			isContinuous: isContinuous 
		});
	}

    function deleteSelectedCard() {
        if (!pendingMove) return;
        if(!confirm(t('msg_delete_card_confirm'))) return;
        
        addOperation({ type: 'DELETE_CARD', cardIds: pendingMove.cardIds });
        cancelSelection();
    }

    // --- Point Mode Logic ---
    function enterPointMode() {
        if (!pendingMove || pendingMove.cardIds.length !== 1) return alert(t('msg_select_one_point'));
        pointerId = pendingMove.cardIds[0];
        isPointing = true;
        pointTargets = [];
        
        document.getElementById('card-action-panel').style.display = 'none';
        document.getElementById('point-bar').style.display = 'flex';
        updatePointInfo();
        document.querySelectorAll('.zone').forEach(el => el.classList.add('point-target-highlight'));
        renderUI(); 
    }

    function cancelPointMode() {
        isPointing = false;
		// --- [æ–°å¢] ---
		if (isExLifeSelecting) {
			isExLifeSelecting = false;
			exLifeTargetId = null;
			document.getElementById('point-bar').querySelector('span').innerText = t('lbl_point_mode'); // æ¢å¾©åŸæœ¬æ–‡å­—
		}
		// -------------
        pointerId = null;
        pointTargets = [];
        document.getElementById('point-bar').style.display = 'none';
        document.querySelectorAll('.point-target-highlight').forEach(el => el.classList.remove('point-target-highlight'));
        document.querySelectorAll('.point-target-selected').forEach(el => el.classList.remove('point-target-selected'));
        cancelSelection(); 
    }

	function handlePointClick(zoneId, cardId) {
        if (!isPointing) return;
        
        // [ä¿®æ­£] å…è¨±æŒ‡å‘ ç‰Œåº«(Deck)ã€è¶…æ¬¡å…ƒ(Hyper)ã€å¢“åœ°(Grave)
		if (!cardId && (zoneId.includes('deck') || zoneId.includes('hyper') || zoneId.includes('grave'))) {
			let zoneName = t('zone_generic');
			if(zoneId.includes('deck')) zoneName = t('zone_player_deck');
			if(zoneId.includes('hyper')) zoneName = t('zone_hyper_area');
			if(zoneId.includes('grave')) zoneName = t('zone_grave_area');

			// ä½¿ç”¨ replace è™•ç†åƒæ•¸å­—ä¸²
			const msg = t('msg_confirm_point_zone').replace('{zone}', zoneName);
			if (confirm(msg)) {
				// [é—œéµä¿®æ­£] é€™è£¡åŸæœ¬å‚³ nullï¼Œæ”¹æˆå‚³å…¥é™£åˆ— [zoneId]
				// é€™æ¨£ç•«ç®­é ­çš„å‡½å¼æ‰çŸ¥é“ç›®æ¨™æ˜¯èª°
				finishPoint('ZONE', [zoneId]);
			}
			return;
		}
        
        if (cardId) {
            if (pointTargets.includes(cardId)) {
                pointTargets = pointTargets.filter(id => id !== cardId);
            } else {
                pointTargets.push(cardId);
            }
            updatePointInfo();
            renderUI(); 
        }
    }

    function updatePointInfo() {
        const btn = document.getElementById('btn-confirm-point');
        const info = document.getElementById('point-target-info');
        if (pointTargets.length > 0) {
            info.innerText = `å·²é¸æ“‡ ${pointTargets.length} å€‹ç›®æ¨™`;
            btn.style.display = 'block';
        } else {
            info.innerText = "è«‹é»æ“Šç›®æ¨™...";
            btn.style.display = 'none';
        }
    }

    function confirmPointTargets() {
        if (pointTargets.length === 0) return;
        finishPoint('CARD', pointTargets);
    }

    function finishPoint(type, targetIds) {
        const state = getCurrentDisplayState();
        const pointer = state.cards.find(c => c.id === pointerId);
        let desc = `[æŒ‡å‘] ${pointer.text} æŒ‡å‘ `;
        if (type === 'PLAYER') desc += 'ç©å®¶/ç‰Œåº«';
        else if (type === 'CARD') desc += `${targetIds.length} å€‹ç›®æ¨™`;

        addOperation({
            type: 'POINT',
            attackerId: pointerId,
            targetType: type,
            targetIds: targetIds,
            desc: desc
        });
        cancelPointMode();
    }

    // --- [å–ä»£] handleZoneClick å‡½å¼ ---
	// --- [ä¿®æ­£] å€åŸŸé»æ“Šè™•ç† ---
	function handleZoneClick(zoneId) {
		// [æ–°å¢] æ‰‹æ©Ÿç‰ˆå¼·åˆ¶é˜»æ“‹æ‰€æœ‰å€åŸŸé»æ“Š (åŒ…å«ç‰Œåº«ã€å¢“åœ°ç­‰æ¸…å–®é–‹å•Ÿè¡Œç‚º)
		if (document.body.classList.contains('mobile-mode')) {
			return; 
		}

		if (isPointing) {
			handlePointClick(zoneId, null); 
			return;
		}

		if (pendingMove) {
			const state = getCurrentDisplayState();
			// FILTER: Prevent moving Ability cards
			const hasAbilityCard = pendingMove.cardIds.some(id => {
				const c = state.cards.find(card => card.id === id);
				return c && c.zone.includes('ability');
			});
			if(hasAbilityCard) {
				alert(t('msg_ability_cant_move'));
				return;
			}

			if (isStackZone(zoneId)) {
				const cardsInZone = getCardsInZone(state, zoneId);
				if (zoneId.includes('shield') && cardsInZone.length === 0) {
					finishMove(zoneId, undefined);
					return;
				}
				openPositionSelector(zoneId, pendingMove);
			} else {
				finishMove(zoneId, undefined);
			}
			return;
		}
		openSelectorModal(zoneId);
	}
	
	// --- [æ–°å¢] æ‰‹ç‰Œéš¨æ©Ÿé¸æ“‡åŠŸèƒ½ (ç„¡ç´€éŒ„) ---
	function randomPickHand(zoneId) {
		// 1. å–å¾—ç•¶å‰ç‹€æ…‹ä¸‹çš„æ‰‹ç‰Œ
		const state = getCurrentDisplayState();
		const cards = state.cards.filter(c => c.zone === zoneId);
		
		if (cards.length === 0) {
			// å¦‚æœæ²’ç‰Œï¼Œç¨å¾®é–ƒçˆä¸€ä¸‹å€åŸŸæç¤º
			const zoneEl = document.querySelector(`.zone[data-zone="${zoneId}"]`);
			if(zoneEl) {
				zoneEl.style.boxShadow = "inset 0 0 20px red";
				setTimeout(() => zoneEl.style.boxShadow = "", 300);
			}
			return;
		}

		// 2. éš¨æ©ŸæŠ½é¸ä¸€å¼µ
		const randomIndex = Math.floor(Math.random() * cards.length);
		const targetCard = cards[randomIndex];
		const cardId = targetCard.id;

		// 3. æŠ“å– DOM å…ƒç´ 
		const cardEl = document.querySelector(`.card[data-id="${cardId}"]`);
		
		if (cardEl) {
			// 4. è¨­å®š CSS è®Šæ•¸ä»¥ä¿ç•™åŸæœ¬çš„ transform (æ—‹è½‰è§’åº¦)
			// é€™æ˜¯ç‚ºäº†é¿å…å‹•ç•«åŸ·è¡Œæ™‚ï¼Œå¡ç‰‡åŸæœ¬çš„æ—‹è½‰è¢«è¦†è“‹è®Šæˆç›´ç«‹çš„
			const currentTransform = cardEl.style.transform || '';
			cardEl.style.setProperty('--base-transform', currentTransform);

			// 5. é‡ç½®å‹•ç•« (ç§»é™¤ class -> å¼·åˆ¶ reflow -> åŠ å› class)
			cardEl.classList.remove('card-jump');
			void cardEl.offsetWidth; // Trigger reflow
			cardEl.classList.add('card-jump');

			// 6. å‹•ç•«çµæŸå¾Œ (0.6s) è‡ªå‹•ç§»é™¤ class
			setTimeout(() => {
				cardEl.classList.remove('card-jump');
				// æ¸…é™¤æš«å­˜æ¨£å¼
				cardEl.style.removeProperty('--base-transform');
			}, 600);
		}
	}
    
    document.addEventListener('click', (e) => {
        // [ä¿®æ”¹] å¢åŠ  e.target.closest('#card-action-panel') 
        // é€™æ¨£é»æ“Šæˆ–æ‹–æ›³é¢æ¿æœ¬èº«æ™‚ï¼Œå°±ä¸æœƒè§¸ç™¼å–æ¶ˆé¸å–
        if (e.target.closest('.card') || 
            e.target.closest('.zone') || 
            e.target.closest('button') || 
            e.target.closest('input') || 
            e.target.closest('.modal') || 
            e.target.closest('#card-action-panel')) { // <--- åŠ å…¥é€™è¡Œ
            return;
        }

        if (!isPointing) cancelSelection();
    });

    function cancelSelection() {
        if (pendingMove) {
            pendingMove = null;
            document.querySelectorAll('.zone').forEach(el => el.classList.remove('target-highlight'));
            document.querySelectorAll('.card.selected').forEach(el => el.classList.remove('selected'));
            document.getElementById('card-action-panel').style.display = 'none';
        }
    }

    function isStackZone(zid) {
        return zid.includes('deck') || zid.includes('shield') || zid.includes('hyper');
    }
	
	// [æ–°å¢] å¾é¢æ¿åˆ‡æ›ç‹ç‰Œç‹€æ…‹
    function toggleAceFromPanel() {
        if (!pendingMove || pendingMove.cardIds.length !== 1) return;
        
        const cardId = pendingMove.cardIds[0];
        // æª¢æŸ¥ç›®å‰æ˜¯å¦å·²ç¶“æ˜¯ Ace
        const isAce = !!globalAceRegistry[cardId];
        
        // åˆ‡æ›ç‹€æ…‹ (toggle)
        toggleAceSilent(cardId, !isAce);
        
        // æ›´æ–°æŒ‰éˆ•å¤–è§€
        updateSelectionUI();
    }

	// --- [æ–°å¢] å¤šé‡é¸å–æ¨¡å¼åˆ‡æ› ---
    function toggleMultiSelectMode() {
        // å¦‚æœæ­£åœ¨ä¸€èˆ¬é¸å–æ¨¡å¼(å–®å¼µ)ï¼Œå…ˆå–æ¶ˆ
        if (pendingMove) cancelSelection();

        isMultiSelectMode = !isMultiSelectMode;
        const btn = document.getElementById('btn-multi-move');

        if (isMultiSelectMode) {
            // é€²å…¥æ¨¡å¼
            multiSelectedIds = [];
            btn.classList.add('active');
            // æ›´æ–°æŒ‰éˆ•æ–‡å­—ç‚ºã€Œå–æ¶ˆ/ç¢ºèªã€
            btn.innerText = t('btn_multi_confirm');
            
            // ç‚ºäº†ä¸è®“ä½¿ç”¨è€…æ··æ·†ï¼Œå¯ä»¥æš«æ™‚éš±è—ä¸‹æ–¹çš„ Action Panel
            document.getElementById('card-action-panel').style.display = 'none';
        } else {
            // é›¢é–‹æ¨¡å¼ (æˆ–æ˜¯æŒ‰ä¸‹ç¢ºèª)
            btn.classList.remove('active');
            btn.innerText = t('btn_multi_move'); // æ”¹å›åŸæœ¬æ–‡å­—

            if (multiSelectedIds.length === 0) {
                // å¦‚æœæ²’é¸åŠå¼µï¼Œå°±å–®ç´”å–æ¶ˆï¼Œä»€éº¼éƒ½ä¸åš
                renderUI(); // æ¸…é™¤å‹¾å‹¾
                return;
            }

            // å¦‚æœæœ‰é¸å¡ç‰‡ï¼Œé€²å…¥ã€Œæº–å‚™ç§»å‹•ã€ç‹€æ…‹
            // è¨­å®š pendingMoveï¼Œè®“ç³»çµ±ä»¥ç‚ºé€™æ˜¯ä½¿ç”¨è€…é¸å¥½çš„ä¸€çµ„ç‰Œ
            pendingMove = { cardIds: [...multiSelectedIds], shuffle: false };
            
            // æç¤ºä½¿ç”¨è€…
            const msg = t('msg_select_dest').replace('{n}', multiSelectedIds.length);
            alert(msg);
            
            // æ­¤æ™‚ isMultiSelectMode å·²ç¶“ falseï¼Œä½† pendingMove æœ‰å€¼
            // æ‰€ä»¥ä½¿ç”¨è€…çš„ä¸‹ä¸€å€‹é»æ“Šå‹•ä½œ (handleZoneClick) å°±æœƒè§¸ç™¼ finishMove
            updateSelectionUI(); // é€™æœƒè®“ç•«é¢ä¸Šçš„å¡ç‰‡é¡¯ç¤ºé¸å–æ¡†
        }
        renderUI();
    }

    function openStackingModal(targetCard) {
        const modal = document.getElementById('position-selector-modal');
        const list = document.getElementById('position-list');
        const gui = document.getElementById('stack-gui');
        
        const titleTemplate = t('title_stack_target') || 'å †ç–Šæ“ä½œ: ç›®æ¨™ [{target}]';
		document.getElementById('pos-modal-title').innerText = titleTemplate.replace('{target}', targetCard.text);
        document.getElementById('position-list').style.display = 'none';
        document.getElementById('stack-gui').style.display = 'grid';
        
        // --- [æ ¸å¿ƒä¿®æ”¹] æ™ºæ…§å †ç–Šé‚è¼¯ ---
        window.confirmStackMove = (type) => {
            let finalTargetId = targetCard.id;

            // å®šç¾©å“ªäº›é¡å‹å±¬æ–¼ã€Œä¸‹æ–¹å †ç–Šã€
            // åŒ…å«ï¼šç–Šåœ¨ä¸‹æ–¹(bottom)ã€éœ²å‡ºåº•(bottom_exposed)ã€æ‹¼åœ¨ä¸‹æ–¹(puzzle_bottom)
            const bottomTypes = ['bottom', 'bottom_exposed', 'puzzle_bottom'];

            // åªæœ‰ç•¶ä½¿ç”¨è€…é¸æ“‡ã€Œå¾€ä¸‹ç–Šã€æ™‚ï¼Œæ‰å•Ÿå‹•è‡ªå‹•è¿½å°¾åŠŸèƒ½
            if (bottomTypes.includes(type)) {
                const state = getCurrentDisplayState();
                
                // éè¿´å°‹æ‰¾æœ€åº•å±¤çš„å¡ç‰‡ (Chain Traversal)
                // é‚è¼¯ï¼šå¦‚æœ A ä¸‹é¢æœ‰ Bï¼ŒB ä¸‹é¢æœ‰ Cï¼Œå‰‡ç›®æ¨™è‡ªå‹•ä¿®æ­£ç‚º C
                let current = state.cards.find(c => c.id === finalTargetId);
                
                // é˜²æ­¢ç„¡çª®è¿´åœˆçš„ç°¡å–®è¨ˆæ•¸å™¨ (é›–ç„¶ç†è«–ä¸Šä¸æœƒç™¼ç”Ÿ)
                let safetyLoop = 0;

                while (current && safetyLoop < 100) {
                    safetyLoop++;
                    
                    // æ‰¾å‡ºã€Œä»¥ current ç‚ºçˆ¶å°è±¡ã€ä¸”ã€Œå †ç–Šé¡å‹å±¬æ–¼ä¸‹æ–¹ã€çš„å­å¡ç‰‡
                    // æ³¨æ„ï¼šå¦‚æœä¸€å¼µå¡ä¸‹é¢åŒæ™‚æ›äº†å¤šå¼µ(æ¥µå°‘è¦‹)ï¼Œé€™è£¡æœƒæŠ“åˆ°ç¬¬ä¸€å¼µ
                    const child = state.cards.find(c => 
                        c.parentId === current.id && bottomTypes.includes(c.stackType)
                    );
                    
                    if (child) {
                        current = child; // ç™¼ç¾æ›´ä¸‹é¢çš„å¡ï¼Œç¹¼çºŒå¾€ä¸‹é‘½
                        finalTargetId = child.id;
                    } else {
                        break; // ä¸‹é¢æ²’æœ‰æ±è¥¿äº†ï¼Œcurrent å°±æ˜¯æœ€åº•å±¤
                    }
                }
            }

            // ä½¿ç”¨ä¿®æ­£å¾Œçš„ ID é€²è¡Œç§»å‹•
            finishMove(targetCard.zone, undefined, finalTargetId, type);
        };
        // -----------------------------

        modal.style.display = 'flex';
    }

    function updateSelectionUI() {
        // æ¸…é™¤èˆŠçš„é¸å–æ¨£å¼
        document.querySelectorAll('.card.selected').forEach(el => el.classList.remove('selected'));
        
        // --- 1. æ›´æ–°å¤šé¸æç¤ºåˆ— ---
        const multiBar = document.getElementById('multi-select-bar');
        const multiCount = document.getElementById('multi-count-val');
        if (isMultiSelectMode) {
            multiBar.style.display = 'flex';
            multiCount.innerText = multiSelectedIds.length;
            // é è¨­å…ˆéš±è—é¢æ¿ï¼Œç¨å¾Œåœ¨ä¸‹æ–¹åˆ¤æ–·æ˜¯å¦è¦é–‹å•Ÿ
            document.getElementById('card-action-panel').style.display = 'none';
        } else {
            multiBar.style.display = 'none';
        }
        
        // å–å¾—é¢æ¿èˆ‡æŒ‰éˆ• DOM
        const panel = document.getElementById('card-action-panel');
        // A. å–å¾—æ‰€æœ‰æŒ‰éˆ•å…ƒç´ 
        const btnRotateL = document.getElementById('btn-rotate-l');
        const btnRotateL_Clone = btnRotateL; // æ–¹ä¾¿ä¸‹æ–¹åƒç…§
        const btnRotateR = document.getElementById('btn-rotate-r');
        const btnFlip = document.getElementById('btn-flip');
        const btnAce = document.getElementById('btn-ace');
        const btnReveal = document.getElementById('btn-reveal');
        const btnPaste = document.getElementById('btn-paste'); 
        const btnRemoveImg = document.getElementById('btn-remove-image');
        const btnGlow = document.getElementById('btn-glow');
        const btnGlowBottom = document.getElementById('btn-glow-bottom');
        const btnUnglow = document.getElementById('btn-unglow');
        const btnCopyOne = document.getElementById('btn-copy-ability');
        const btnCopyCont = document.getElementById('btn-copy-continuous');
        const adjustControls = document.getElementById('ability-adjust-controls');
        const adjustButtons = document.getElementById('ability-adjust-buttons');
        const btnInjured = document.getElementById('btn-injured');
        const btnClearInjured = document.getElementById('btn-clear-injured');
        const btnMoonless = document.getElementById('btn-moonless'); 
        const btnDelete = document.getElementById('btn-delete-card');
        const btnPoint = document.getElementById('btn-point');
        const btnEndPoint = document.getElementById('btn-end-point'); // ä¿®æ­£å¯èƒ½æ¼æ‰çš„æŒ‰éˆ•
		// ã€æ–°å¢é€™è¡Œã€‘å–å¾—é—œé–‰æŒ‰éˆ•
        const btnPanelClose = document.getElementById('btn-panel-close');
        
        // å–å¾—è¼¸å…¥æ¡†
        const inputRename = document.getElementById('rename-input');
        const inputNote = document.getElementById('note-input');
        const btnRename = document.querySelector('button[onclick="renameCard()"]');
        const btnNote = document.querySelector('button[onclick="addCardNote()"]');
		const btnExLife = document.getElementById('btn-ex-life'); // å–å¾—æŒ‰éˆ• DOM
        // --- 2. è™•ç†å–®é¸/å¤šé¸æ“ä½œé¢æ¿ ---
        // æ³¨æ„ï¼špendingMove åœ¨å–®é¸æ™‚æœ‰å€¼ï¼Œåœ¨å¤šé¸æ™‚(è‹¥å·²é¸)ä¹Ÿæœ‰å€¼
        if (pendingMove && pendingMove.cardIds.length > 0) {
            const state = getCurrentDisplayState();
            
            // --- [ä½ç½®è¨­å®š] ---
            const firstCard = state.cards.find(c => c.id === pendingMove.cardIds[0]);
            if (firstCard) {
                currentPanelOwner = (firstCard.ownerId === 1) ? 'p1' : 'p2';
                const savedPos = panelPosSettings[currentPanelOwner];
                panel.style.left = savedPos.x + 'px';
                panel.style.top = savedPos.y + 'px';
            }
			
			// --- [æ–°å¢] åˆ¤æ–·æ˜¯å¦é¡¯ç¤º EX-Life æŒ‰éˆ• ---
			// æ¢ä»¶ï¼šå–®é¸ + ç›®æ¨™åœ¨è­·ç›¾å€
			if (!isMultiSelectMode && pendingMove.cardIds.length === 1) {
				const card = state.cards.find(c => c.id === pendingMove.cardIds[0]);
				if (card && card.zone.includes('shield')) {
					if (btnExLife) btnExLife.style.display = 'block';
				} else {
					if (btnExLife) btnExLife.style.display = 'none';
				}
			} else {
				if (btnExLife) btnExLife.style.display = 'none';
			}

            // ==========================================
            // [åˆ†æ”¯ A] ä¸€èˆ¬æ¨¡å¼ (å–®é¸)
            // ==========================================
            if (!isMultiSelectMode) {
                panel.style.display = 'flex';

                // --- [ç‹€æ…‹åˆ¤æ–·] æƒææ‰€æœ‰é¸å–å¡ç‰‡ ---
                let allAbility = true;      
                let isBattleOrShield = true; 
                let hasInjuredCard = false;  
                
                pendingMove.cardIds.forEach(id => {
                    const c = state.cards.find(card => card.id === id);
                    if (!c) return;
                    
                    if (!c.zone.includes('ability')) {
                        allAbility = false;
                    }
                    const z = c.zone;
                    if (!z.includes('battle') && !z.includes('shield')) {
                        isBattleOrShield = false;
                    }
                    if (c.isInjured) {
                        hasInjuredCard = true;
                    }
                });
                
                // B. é è¨­å°‡æ‰€æœ‰ã€ŒåŠŸèƒ½é¡ã€æŒ‰éˆ•é‡ç½®ç‚ºé¡¯ç¤º
                const allElements = [
                    btnRotateL, btnRotateR, btnFlip, btnAce, btnReveal, btnPaste, 
                    btnGlow, btnGlowBottom, btnCopyOne, btnCopyCont, adjustControls, adjustButtons, 
                    btnPoint, inputRename, inputNote, btnRename, btnNote, btnMoonless,
					btnPanelClose
                ];
                allElements.forEach(el => { if(el) el.style.display = ''; }); // æ¸…ç©º inline style å›å¾©é è¨­ (block/flex/inline)
                
                // ä¿®æ­£ flex æ’ç‰ˆå…ƒä»¶
                adjustButtons.style.display = 'flex';
				
				// -----------------------------------------------------------
				// ã€âœ… BUG ä¿®å¾©ï¼šå¼·åˆ¶é‡ç½®èª¿æ•´æŒ‰éˆ•å…§éƒ¨çš„å­æŒ‰éˆ•ã€‘
				// åŸå› ï¼šå¤šé¸æ¨¡å¼æœƒéš±è—é¢æ¿å…§ã€Œæ‰€æœ‰ã€æŒ‰éˆ•ï¼ŒåŒ…å«é€™äº›æ²’æœ‰ ID çš„ç®­é ­æŒ‰éˆ•ã€‚
				// ç•¶åˆ‡æ›å›å–®é¸æ™‚ï¼Œå¿…é ˆæ‰‹å‹•æŠŠé€™äº›å­æŒ‰éˆ•æ•‘å›ä¾†ã€‚
				// -----------------------------------------------------------
				if (adjustButtons) {
					adjustButtons.querySelectorAll('button').forEach(b => b.style.display = '');
				}
                
                // C. ç‹€æ…‹ä¾è³´å‹æŒ‰éˆ•å…ˆé è¨­éš±è—
                if(btnRemoveImg) btnRemoveImg.style.display = 'none';
                if(btnUnglow) btnUnglow.style.display = 'none';
                if(btnInjured) btnInjured.style.display = 'none';
                if(btnClearInjured) btnClearInjured.style.display = 'none';
                if(btnDelete) btnDelete.style.display = 'none';
                if(btnEndPoint) btnEndPoint.style.display = 'none';

                // D. ä¾æ“šã€Œå¡ç‰‡é¡å‹ã€åŸ·è¡Œåˆªå»æ³•
                if (allAbility) {
                    // æ•ˆæœå°å¡ï¼šéš±è—ä¸å¿…è¦åŠŸèƒ½
                    [btnRotateL, btnRotateR, btnFlip, btnAce, btnReveal, btnPaste, btnCopyOne, btnCopyCont, btnMoonless].forEach(el => el.style.display = 'none');
                    btnGlow.classList.remove('disabled-gray');
                    btnGlowBottom.classList.remove('disabled-gray');
                    btnDelete.style.display = 'block';
                } else {
                    // ä¸€èˆ¬å¡ç‰‡ï¼šéš±è—ç™¼å…‰/å¾®èª¿
                    [btnGlow, btnGlowBottom, adjustControls, adjustButtons].forEach(el => el.style.display = 'none');
                }

                // E. ç´°éƒ¨é¡¯ç¤º
                if (isBattleOrShield) {
                    if (hasInjuredCard) btnClearInjured.style.display = 'block'; 
                    else btnInjured.style.display = 'block';      
                }
                if (!allAbility && firstCard && firstCard.image) btnRemoveImg.style.display = 'block';
                if (allAbility && firstCard && firstCard.glow) btnUnglow.style.display = 'block';

                // F. å–®é¸é™åˆ¶
                if (pendingMove.cardIds.length === 1) {
                    const cid = pendingMove.cardIds[0];
                    if (!allAbility) {
                        // Ace & Moonless ç‹€æ…‹é¡¯ç¤º
                        if (globalAceRegistry[cid]) {
                            btnAce.classList.add('active');
                            btnAce.innerText = "ğŸ‘‘ å–æ¶ˆç‹ç‰Œ";
                        } else {
                            btnAce.classList.remove('active');
                            btnAce.innerText = "ğŸ‘‘ è¨­ç‚ºç‹ç‰Œ";
                        }
                        if (state.moonless && state.moonless[cid]) btnMoonless.classList.add('active');
                        else btnMoonless.classList.remove('active');
                    }
                    
                    // è¼‰å…¥åç¨±èˆ‡è¨»è¨˜
                    if (firstCard) {
                        inputRename.value = firstCard.text;
                        inputNote.value = firstCard.note || "";
                    }
                } else {
                    // é›–ç„¶å–®é¸æ¨¡å¼ä¸å¤ªæœƒé€²ä¾†é€™(å› ç‚ºé€™UIåªæ”¯æ´å–®å¼µé»æ“Š)ï¼Œä½†é˜²å‘†
                    [btnAce, btnMoonless, btnPoint].forEach(el => el.style.display = 'none');
                    inputRename.value = '';
                    inputNote.value = '';
                }

            } 
            // ==========================================
            // [åˆ†æ”¯ B] å¤šé¸æ¨¡å¼ (Multi-Select) - [æ‚¨çš„éœ€æ±‚åœ¨é€™è£¡]
            // ==========================================
            else {
                // æª¢æŸ¥æ¢ä»¶ï¼šæ‰€æœ‰é¸å–çš„å¡ç‰‡æ˜¯å¦éƒ½åœ¨ æˆ°å ´ æˆ– é­”åŠ›å€
                const validZones = ['p1-battle', 'p2-battle', 'p1-mana', 'p2-mana'];
                
                const allValid = pendingMove.cardIds.every(id => {
                    const c = state.cards.find(x => x.id === id);
                    // æª¢æŸ¥å€åŸŸï¼Œä¸”å¿…é ˆæ˜¯ã€Œå¯è¦‹ã€çš„ (éç‰Œåº«/è­·ç›¾/å¢“åœ°/è¶…æ¬¡å…ƒ)
                    // é€™è£¡ç›´æ¥ç”¨ validZones ç™½åå–®æœ€æº–ç¢º
                    return c && validZones.includes(c.zone);
                });

                if (allValid) {
                    panel.style.display = 'flex';
                    
                    // 1. å…ˆéš±è—é¢æ¿å…§ã€Œæ‰€æœ‰ã€æ§åˆ¶é …
                    const allControls = panel.querySelectorAll('button, input, .panel-sep, div');
                    allControls.forEach(el => {
                        // é€™è£¡è¦æ³¨æ„ä¸è¦éš±è—åˆ° panel-row (div)ï¼Œå¦å‰‡æ’ç‰ˆæœƒäº‚æ‰
                        if (el.tagName !== 'DIV') {
                            el.style.display = 'none';
                        }
                    });

                    // 2. é¡¯ç¤ºå¿…è¦çš„ Row (ç¢ºä¿ div å®¹å™¨æ˜¯é–‹çš„)
                    panel.querySelectorAll('.panel-row').forEach(row => row.style.display = 'flex');

                    // 3. å”¯ç¨é–‹å•Ÿå…©å€‹æ—‹è½‰æŒ‰éˆ•
                    if(btnRotateL) btnRotateL.style.display = 'block';
                    if(btnRotateR) btnRotateR.style.display = 'block';
                    
                } else {
                    // å¦‚æœåŒ…å«äº†å…¶ä»–å€åŸŸ (å¦‚æ‰‹ç‰Œã€ç‰Œåº«)ï¼Œå°±ä¸é¡¯ç¤ºé¢æ¿
                    panel.style.display = 'none';
                }
            }
            
            // æœ€å¾ŒåŠ ä¸Šé«˜äº®
            document.querySelectorAll('.zone').forEach(el => el.classList.add('target-highlight'));

        } else {
            // æ²’æœ‰é¸å–ä»»ä½•å¡ç‰‡
            panel.style.display = 'none';
            document.querySelectorAll('.zone').forEach(el => el.classList.remove('target-highlight'));
        }
		
		// [æ–°å¢] æª¢æŸ¥é‡ç–Š (å»¶é²ä¸€å¹€ä»¥ç¢ºä¿ CSS display åˆ‡æ›å·²ç”Ÿæ•ˆä¸” DOM ä½ˆå±€å®Œæˆ)
        setTimeout(checkAndFixPanelOverlap, 0);
    }
	
	// [æ–°å¢] è‡ªå‹•æª¢æ¸¬ä¸¦ä¿®å¾©é¢æ¿é‡ç–Š
    function checkAndFixPanelOverlap() {
        const panel = document.getElementById('card-action-panel');
        const bar = document.getElementById('multi-select-bar');
        
        if (!panel || !bar) return;
        // åªæœ‰ç•¶å…©è€…éƒ½é¡¯ç¤ºæ™‚æ‰è¨ˆç®— (æ³¨æ„: display ç‚º '' æ™‚ä¹Ÿè¦–ç‚ºé¡¯ç¤ºï¼Œè¦– CSS è€Œå®šï¼Œé€™è£¡æª¢æŸ¥ none å³å¯)
        if (panel.style.display === 'none' || bar.style.display === 'none') return;

        const pRect = panel.getBoundingClientRect();
        const bRect = bar.getBoundingClientRect();

        // ç¢°æ’æª¢æ¸¬ (AABB Intersection Check)
        // åˆ¤æ–·æ˜¯å¦ã€Œæ²’æœ‰é‡ç–Šã€ï¼Œç„¶å¾Œå–å
        const overlap = !(pRect.right < bRect.left || 
                          pRect.left > bRect.right || 
                          pRect.bottom < bRect.top || 
                          pRect.top > bRect.bottom);

        if (overlap) {
            // console.log("åµæ¸¬åˆ° UI é‡ç–Šï¼Œè‡ªå‹•èª¿æ•´é¢æ¿ä½ç½®...");
            
            // ç­–ç•¥ï¼šå°‡é¢æ¿å¾€ä¸Šç§»ï¼Œä½¿å…¶ä½æ–¼æç¤ºåˆ—ä¸Šæ–¹ (ç•™ 15px é–“è·)
            // ç›®æ¨™ Top = æç¤ºåˆ— Top - é¢æ¿é«˜åº¦ - é–“è·
            const newTop = bRect.top - pRect.height - 15;
            
            // åªæœ‰ç•¶æ–°ä½ç½®ä¸æœƒè·‘å‡ºé ‚éƒ¨æ™‚æ‰å¥—ç”¨
            if (newTop >= 0) {
                panel.style.top = newTop + 'px';
                
                // é †ä¾¿æ›´æ–°è¨˜æ†¶ä½ç½®ï¼Œé¿å…ä¸‹æ¬¡åˆ‡æ›ç„¦é»æ™‚åˆè·³å›èˆŠä½ç½®
                if (currentPanelOwner && panelPosSettings[currentPanelOwner]) {
                    panelPosSettings[currentPanelOwner].y = newTop;
                    // æ›´æ–° X ä»¥é˜²è¬ä¸€ï¼Œç¢ºä¿è¨˜æ†¶èˆ‡ç•¶å‰ä½ç½®åŒæ­¥
                    // panel.style.left å¸¶æœ‰ 'px'ï¼Œéœ€è½‰æ•¸å­—
                    panelPosSettings[currentPanelOwner].x = parseFloat(panel.style.left) || pRect.left;
                }
            }
        }
    }
	
	function updateToolbarState() {
        const btnDiag = document.getElementById('btn-add-dialogue');
        if (!btnDiag) return;

        // å¦‚æœæ­£åœ¨ç·¨è¼¯éå°è©±å‹•ä½œï¼Œå‰‡åœç”¨å°è©±æŒ‰éˆ•
        const isEditingNonDialog = isDrafting && draftOperations.length > 0 && !draftOperations.some(o => o.type === 'DIALOGUE');
        
        if (isEditingNonDialog) {
            btnDiag.classList.add('disabled-gray');
        } else {
            btnDiag.classList.remove('disabled-gray');
        }
    }

    // [å„ªåŒ–ç‰ˆ] æ”¯æ´ç•¥éæ¸…å–®çš„åº§æ¨™æ¸¬é‡å‡½å¼
	function getCardPositions(zonesToSkip = null) {
		const positions = {};
		
		// å®šç¾©æ‰€æœ‰éœ€è¦æª¢æŸ¥çš„å€åŸŸ ID
		const allZones = [
			'p1-battle', 'p1-mana', 'p1-shield', 'p1-hand', 'p1-grave', 'p1-deck', 'p1-hyper', 'p1-abyss',
			'p2-battle', 'p2-mana', 'p2-shield', 'p2-hand', 'p2-grave', 'p2-deck', 'p2-hyper', 'p2-abyss',
			'reveal-zone', 'ability-zone-p1', 'ability-zone-p2'
		];

		allZones.forEach(zoneId => {
			// [é—œéµå„ªåŒ–] å¦‚æœæ­¤å€åŸŸåœ¨ç•¥éåå–®ä¸­ï¼Œç›´æ¥ returnï¼Œä¸åŸ·è¡Œ querySelectorAll
			if (zonesToSkip && zonesToSkip.has(zoneId)) return;

			// å–å¾—å€åŸŸ DOM (è™•ç† ID åç¨±ä¸ä¸€è‡´çš„æƒ…æ³)
			let el;
			if (zoneId === 'ability-zone-p1') el = document.getElementById('ability-zone-p1');
			else if (zoneId === 'ability-zone-p2') el = document.getElementById('ability-zone-p2');
			else el = document.querySelector(`.zone[data-zone="${zoneId}"]`);

			if (el) {
				// 1. æ¸¬é‡å€åŸŸå…§æ‰€æœ‰å¡ç‰‡
				el.querySelectorAll('.card').forEach(card => {
					if (card.dataset.id) {
						const rect = card.getBoundingClientRect();
						positions[card.dataset.id] = { 
							top: rect.top, 
							left: rect.left, 
							width: rect.width, 
							height: rect.height 
						};
					}
				});
				
				// 2. é †ä¾¿æ¸¬é‡å€åŸŸæœ¬èº« (å †ç–Šå‹•ç•«å¯èƒ½éœ€è¦)
				const zRect = el.getBoundingClientRect();
				// ç‚ºäº†ç›¸å®¹æ€§ï¼ŒåŒæ™‚å„²å­˜å…©ç¨® Key æ ¼å¼
				positions['ZONE_' + zoneId] = { top: zRect.top, left: zRect.left, width: zRect.width, height: zRect.height };
			}
		});

		return positions;
	}

    function getCardsInZone(state, zoneName) {
        return state.cards.filter(c => c.zone === zoneName);
    }

    function getZoneName(zoneId) {
        return zoneId.toUpperCase(); 
    }
	
	// --- [æ–°å¢] é‹¸é½’è·¯å¾‘ç”Ÿæˆå™¨ ---
    // progress: 0 (é–‰åˆ) ~ 1 (å…¨é–‹)
    // pattern: 'center', 'corner-tl', 'corner-br'
    // seedArr: é å…ˆç”Ÿæˆçš„äº‚æ•¸é™£åˆ— (ç¢ºä¿ç´™å¼µå±¤å’Œåœ–ç‰‡å±¤çš„é‹¸é½’å½¢ç‹€ä¸€è‡´)
    // layerType: 'image' æˆ– 'paper' (ç´™å¼µå±¤æœƒæ¯”åœ–ç‰‡å±¤ç¨å¾®å¯¬ä¸€é»)
    // --- [ä¿®æ­£ç‰ˆ] é‹¸é½’è·¯å¾‘ç”Ÿæˆå™¨ (å‹•æ…‹ç™½é‚Šå¯¬åº¦) ---
    function generateJaggedPoly(progress, pattern, seedArr, layerType) {
        const points = [];
        const segments = 40; // é‹¸é½’å¯†åº¦
        
        // [åƒæ•¸è¨­å®š]
        // 1. åŸºç¤é›œè¨Šå¼·åº¦ (æ•¸å­—è¶Šå¤§ï¼Œé‹¸é½’è¶Šæ·±)
        const noiseIntensity = 0.5; 
        // 2. éš¨æ©Ÿè®ŠåŒ–å¹…åº¦ (æ•¸å­—è¶Šå¤§ï¼Œå½¢ç‹€è¶Šäº‚)
        const randomFactor = 6.0; 

        if (pattern === 'center') {
            // ä¸­é–“å‚ç›´æ’•è£‚
            const centerX = 50;
            const maxOpenWidth = 60; 
            
            // å·¦é‚Šç•Œ
            for (let i = 0; i <= segments; i++) {
                const y = (i / segments) * 100;
                const baseOpen = (progress * maxOpenWidth);
                
                // [æ ¸å¿ƒä¿®æ”¹ 1] åªæœ‰æ‰“é–‹æ™‚æ‰è¨ˆç®—é›œè¨Šï¼Œé¿å…é–‰åˆæ™‚æœ‰ç¸«
                let noise = 0;
                let dynamicGap = 0;

                if (progress > 0.01) {
                    // åœ–ç‰‡å±¤èˆ‡ç´™å¼µå±¤ä½¿ç”¨å„è‡ªçš„ seedï¼Œç”¢ç”Ÿä¸åŒçš„æŠ–å‹•
                    noise = seedArr[i] * randomFactor;
                    
                    // [æ ¸å¿ƒä¿®æ”¹ 2] å¦‚æœæ˜¯ç´™å¼µå±¤ï¼Œé¡å¤–åŠ ä¸Šéš¨æ©Ÿå¯¬åº¦ (1% ~ 5%)
                    // ä½¿ç”¨ Math.abs ç¢ºä¿ç´™å¼µæ°¸é æ¯”åœ–ç‰‡å¯¬ (æˆ–ç›¸ç­‰)ï¼Œä¸æœƒç¸®é€²å»
                    if (layerType === 'paper') {
                        // åˆ©ç”¨ seed ç”¢ç”Ÿè®Šå‹•å¯¬åº¦ï¼šåŸºç¤ 1.5% + éš¨æ©Ÿ 0~3.5%
                        dynamicGap = 1.5 + Math.abs(seedArr[i] * 3.5);
                    }
                }
                
                const x = centerX - baseOpen - noise - dynamicGap;
                points.push(`${x}% ${y}%`);
            }
            
            // å³é‚Šç•Œ
            for (let i = segments; i >= 0; i--) {
                const y = (i / segments) * 100;
                const baseOpen = (progress * maxOpenWidth);
                
                let noise = 0;
                let dynamicGap = 0;

                if (progress > 0.01) {
                    // ä½¿ç”¨å¾ŒåŠæ®µ seed
                    noise = seedArr[i + segments] * randomFactor;
                    
                    if (layerType === 'paper') {
                        // å³é‚Šä¹Ÿè¦ç¨ç«‹çš„éš¨æ©Ÿå¯¬åº¦
                        dynamicGap = 1.5 + Math.abs(seedArr[i + segments] * 3.5);
                    }
                }
                
                const x = centerX + baseOpen + noise + dynamicGap;
                points.push(`${x}% ${y}%`);
            }

        } else if (pattern === 'corner-tl') {
            // å·¦ä¸Šè§’æ’•è£‚
            points.push('0% 0%'); // é ‚é»

            for (let i = 0; i <= segments; i++) {
                const ratio = i / segments; 
                const angle = (Math.PI / 2) * ratio; 
                
                // åŸºç¤åŠå¾‘
                let radius = progress * 180;
                
                if (progress > 0.01) {
                    // åŠ å…¥é›œè¨Š
                    radius += (seedArr[i] * randomFactor);
                    
                    // åŠ å…¥ç´™å¼µå±¤éš¨æ©Ÿåšåº¦
                    if (layerType === 'paper') {
                        radius += (1.5 + Math.abs(seedArr[i] * 4.0));
                    }
                }

                const finalX = radius * Math.sin(angle);
                const finalY = radius * Math.cos(angle);
                
                points.push(`${finalX}% ${finalY}%`);
            }
            points.push('0% 0%'); 

        } else {
            // å³ä¸‹è§’æ’•è£‚
            points.push('100% 100%'); 
            
            for (let i = 0; i <= segments; i++) {
                const ratio = i / segments; 
                const angle = (Math.PI / 2) * ratio; 
                
                let radius = progress * 180;
                
                if (progress > 0.01) {
                    radius += (seedArr[i] * randomFactor);
                    if (layerType === 'paper') {
                        radius += (1.5 + Math.abs(seedArr[i] * 4.0));
                    }
                }
                
                const offX = radius * Math.sin(angle);
                const offY = radius * Math.cos(angle);
                
                points.push(`${100 - offX}% ${100 - offY}%`);
            }
        }

        return `polygon(${points.join(',')})`;
    }

	// =========================================================
	// [æ•ˆèƒ½å„ªåŒ–æ¨¡çµ„] Dirty Checking (é«’å€æª¢æŸ¥)
	// =========================================================
	let lastZoneHashes = {}; 

	// =========================================================
	// [å®Œæ•´ç‰ˆ renderUI] åŒ…å«æ•ˆèƒ½å„ªåŒ–èˆ‡åŸå§‹å®Œæ•´é‚è¼¯
	// =========================================================
	function renderUI(skipScroll) {
	
		// =========================================================
		// 0. [ä¿®æ­£] å…ˆå–å¾—ç•¶å‰ç‹€æ…‹ï¼Œä¾›å…¨å‡½å¼ä½¿ç”¨
		// =========================================================
		const state = getCurrentDisplayState();

		// --- [æ•ˆèƒ½å„ªåŒ–] å€åŸŸé‡ç¹ªåˆ¤æ–· (ActionLog Mode) ---
		const zonesToSkip = new Set();
		const allZoneIds = [
			'p1-battle', 'p1-mana', 'p1-hand', 'p1-shield', 'p1-grave', 'p1-deck', 'p1-hyper', 'p1-abyss', 'ability-zone-p1',
			'p2-battle', 'p2-mana', 'p2-hand', 'p2-shield', 'p2-grave', 'p2-deck', 'p2-hyper', 'p2-abyss', 'ability-zone-p2',
			'reveal-zone'
		];

		// åˆå§‹åŒ–å…¨åŸŸè¨˜éŒ„è®Šæ•¸
		if (typeof window.lastRenderedStepIndex === 'undefined') window.lastRenderedStepIndex = -1;

		// åˆ¤æ–·æ˜¯å¦å•Ÿç”¨å„ªåŒ–ï¼šéç·¨è¼¯æ¨¡å¼ã€éé¦–æ­¥ã€ä¸”ç‚ºé€£çºŒæ’­æ”¾
		const isOptimizationActive = (!isDrafting && currentIndex > 0 && 
									  window.lastRenderedStepIndex === (currentIndex - 1) &&
									  history[currentIndex] && history[currentIndex-1]);

		if (isOptimizationActive) {
			// 1. é è¨­å…¨è·³é
			allZoneIds.forEach(id => zonesToSkip.add(id));

			const dirtyZones = new Set();
			const currentAction = history[currentIndex].action;
			const prevState = history[currentIndex - 1].state;

			const markDirty = (z) => {
				if (!z) return;
				if (z === 'p1-ability') z = 'ability-zone-p1';
				if (z === 'p2-ability') z = 'ability-zone-p2';
				dirtyZones.add(z);
			};

			if (currentAction && currentAction.operations) {
				currentAction.operations.forEach(op => {
					// A. æ¨™è¨˜ç›®æ¨™å€åŸŸ
					if (op.toZone) markDirty(op.toZone);
					if (op.zoneId) markDirty(op.zoneId);
					if (op.targetZone) markDirty(op.targetZone);
					if (op.targetType === 'ZONE' && op.targetIds) op.targetIds.forEach(zid => markDirty(zid));
					
					// --- [è«‹åœ¨æ­¤è™•æ’å…¥ä¿®æ­£ä»£ç¢¼] ---
					// ä¿®æ­£ï¼šé‡å°é‡ç½®å‹•ä½œ (Untap)ï¼Œå¼·åˆ¶æ¨™è¨˜æˆ°é¬¥å€èˆ‡é­”åŠ›å€ç‚ºã€Œé«’å€åŸŸã€(éœ€è¦åˆ·æ–°)
					if (op.type === 'RESET_BOARD') {
						markDirty(`p${op.playerId}-battle`);
						markDirty(`p${op.playerId}-mana`);
					}
					// ---------------------------

					// B. æ¨™è¨˜å—å½±éŸ¿å¡ç‰‡çš„ã€Œèµ·å§‹ã€èˆ‡ã€ŒçµæŸã€å€åŸŸ
					let affectedCardIds = [];
					if (op.cardIds && Array.isArray(op.cardIds)) affectedCardIds = [...op.cardIds];
					if (op.sourceCardId) affectedCardIds.push(op.sourceCardId);
					if (op.attackerId) affectedCardIds.push(op.attackerId);
					if (op.targetId) affectedCardIds.push(op.targetId);

					// --- [ä¿®æ­£] åœ¨æ¨™è¨˜ Dirty æ™‚åŠ å…¥ Source (æ•ˆæœå¡) é€£å‹•æª¢æŸ¥ ---
					affectedCardIds.forEach(cid => {
						// 1. çµæŸä½ç½® (Current State)
						const currC = state.cards.find(c => c.id == cid);
						if (currC) {
							markDirty(currC.zone);
							// [ä¿®æ­£] å¦‚æœæ˜¯ Ability å¡ä¸”æœ‰ä¾†æº (Source)ï¼Œä¾†æºæ‰€åœ¨å€åŸŸä¹Ÿè¦é‡ç¹ª
							if (currC.sourceId && currC.zone.includes('ability')) {
								const source = state.cards.find(s => s.id === currC.sourceId);
								if (source) markDirty(source.zone);
							}
						}

						// 2. èµ·å§‹ä½ç½® (Previous State)
						const prevC = prevState.cards.find(c => c.id == cid);
						if (prevC) {
							markDirty(prevC.zone);
							// [ä¿®æ­£] ç§»é™¤æˆ–ç§»å‹•æ™‚ï¼ŒèˆŠä¾†æºçš„å€åŸŸä¹Ÿè¦é‡ç¹ª
							if (prevC.sourceId && prevC.zone.includes('ability')) {
								const source = prevState.cards.find(s => s.id === prevC.sourceId);
								if (source) markDirty(source.zone);
							}
						}
					});
				});
			}
			
			// ç§»é™¤é«’å€åŸŸ (å³éœ€è¦é‡ç¹ª)
			dirtyZones.forEach(z => zonesToSkip.delete(z));
			
			// å¼·åˆ¶é‡ç¹ªå±•ç¤ºå€èˆ‡å°è©±ï¼Œç¢ºä¿åœ–å±¤æ­£ç¢º
			zonesToSkip.delete('reveal-zone');
			if (state.dialogueData) zonesToSkip.clear();

		} else {
			zonesToSkip.clear(); // å¼·åˆ¶å…¨ç¹ª
		}
		
		window.lastRenderedStepIndex = currentIndex;
		
		// =========================================================
		// 2. [å„ªåŒ–] åªé‡æ¸¬ã€Œéè·³éå€åŸŸã€çš„å¡ç‰‡åº§æ¨™
		// =========================================================
		const getOptimizedPositions = () => {
			const positions = {};
			// åªæœ‰ç•¶ zonesToSkip æ²’æœ‰åŒ…å«è©²å€åŸŸæ™‚ï¼Œæ‰å» querySelectorAll
			// é€™æ¨£å¯ä»¥é¿å…å°ç„¡è®Šå‹•çš„å€åŸŸè§¸ç™¼ Reflow
			const scanZone = (zoneId) => {
				// ID è½‰æ›ç¢ºä¿ä¸€è‡´
				let checkId = zoneId;
				if (zoneId === 'p1-ability') checkId = 'ability-zone-p1';
				if (zoneId === 'p2-ability') checkId = 'ability-zone-p2';

				if (zonesToSkip.has(checkId)) return; // â˜… é—œéµå„ªåŒ–ï¼šè·³éé‡æ¸¬

				let el = document.querySelector(`.zone[data-zone="${zoneId}"]`);
				if (zoneId.includes('ability')) el = document.getElementById(checkId);

				if (el) {
					// ã€ğŸ‘‡ğŸ‘‡ğŸ‘‡ è«‹è£œä¸Šé€™æ®µéºå¤±çš„ç¨‹å¼ç¢¼ ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€‘
					// å¿…é ˆç´€éŒ„å€åŸŸæœ¬èº«çš„åº§æ¨™ï¼Œå¦å‰‡å †ç–Šä¸­çœ‹ä¸è¦‹çš„å¡ç‰‡æœƒå› ç‚ºæ‰¾ä¸åˆ°èµ·é»è€Œç„¡æ³•åŸ·è¡Œå‹•ç•«
					const zRect = el.getBoundingClientRect();
					positions['ZONE_' + zoneId] = { left: zRect.left, top: zRect.top, width: zRect.width, height: zRect.height };
					// ã€ğŸ‘†ğŸ‘†ğŸ‘† ä¿®æ­£çµæŸ ğŸ‘†ğŸ‘†ğŸ‘†ã€‘

					const cards = el.querySelectorAll('.card');
					cards.forEach(c => {
						// é€™è£¡æ˜¯ getBoundingClientRect æ˜¯æ˜‚è²´æ“ä½œï¼Œç¾åœ¨åªå°é«’å€åŸŸåŸ·è¡Œ
						const rect = c.getBoundingClientRect();
						positions[c.dataset.id] = { left: rect.left, top: rect.top };
					});
				}
			};

			// æƒææ‰€æœ‰å¯èƒ½çš„å€åŸŸ
			allZoneIds.forEach(zid => scanZone(zid));
			return positions;
		};

		// â˜… åŸ·è¡Œå„ªåŒ–å¾Œçš„é‡æ¸¬ (è®Šå‹•å‰)
		const firstPositions = getOptimizedPositions();


		let winOverlay = document.getElementById('win-overlay');
		if (!winOverlay) {
			winOverlay = document.createElement('div');
			winOverlay.id = 'win-overlay';
			document.body.appendChild(winOverlay);
		}

		const board = document.getElementById('game-board-container');
		const abilityZone = document.getElementById('ability-stack-zone');
		
		const p1Area = document.getElementById('player1-area');
		const p2Area = document.getElementById('player2-area');
		
		if (p1Area && p2Area) {
			p1Area.classList.remove('active-turn');
			p2Area.classList.remove('active-turn');
			if (state.turnPlayer === 1) p1Area.classList.add('active-turn');
			else p2Area.classList.add('active-turn');
		}
		
		if (state.globalRotation) {
			board.classList.add('rotated-view');
			abilityZone.classList.add('rotated-view');
		} else {
			board.classList.remove('rotated-view');
			abilityZone.classList.remove('rotated-view');
		}

		document.querySelectorAll('.zone, .ability-column').forEach(el => {
			// [æ•ˆèƒ½å„ªåŒ–] å¦‚æœæ­¤å€åŸŸåœ¨ Skip åå–®ä¸­ï¼Œç›´æ¥è·³é DOM æ¸…ç©ºæ“ä½œ
			const zId = el.getAttribute('data-zone') || el.id;
			if (zonesToSkip.has(zId)) return; 

			const label = el.querySelector('.zone-label, .ability-label');
			
			// [ä¿®æ­£] åœ¨æ¸…ç©ºå‰ï¼Œå…ˆå°‹æ‰¾ä¸¦æš«å­˜éš¨æ©ŸæŒ‰éˆ•
			const randomBtn = el.querySelector('.random-pick-btn');
			const unseenBtn = el.querySelector('.unseen-check-btn'); // <--- æ–°å¢é€™è¡Œ

			el.innerHTML = ''; // é€™è¡Œæœƒæ¸…ç©ºå…§å®¹ (åŒ…å«åŸæœ¬çš„æŒ‰éˆ•)

			if(label) el.appendChild(label);
			
			// [ä¿®æ­£] å¦‚æœåŸæœ¬æœ‰æŒ‰éˆ•ï¼Œå°±æŠŠå®ƒæ”¾å›å»
			if(unseenBtn) el.appendChild(unseenBtn); // <--- æ–°å¢é€™è¡Œ
			if(randomBtn) el.appendChild(randomBtn);

			el.classList.remove('target-highlight');
			el.classList.remove('point-target-highlight'); 
			el.className = el.className.replace(/\bglow-\S+/g, '');
		});
		
		// å±•ç¤ºå€æ¯”è¼ƒç‰¹æ®Šï¼Œä¸”å…§å®¹é€šå¸¸è¼ƒå°‘ï¼Œé€™è£¡ç¶­æŒåŸæ¨£ (æˆ–è€…ä¹Ÿå¯ä»¥åŠ å…¥ Skip åˆ¤æ–·ï¼Œä½†ç‚ºäº†ä¿éšªèµ·è¦‹å…ˆä¸å‹•)
		const revealZoneEl = document.getElementById('reveal-zone');
		if (revealZoneEl && !zonesToSkip.has('reveal-zone')) {
			const revealCards = state.cards.filter(c => c.zone === 'reveal-zone');
			if (revealCards.length > 0) {
				revealZoneEl.style.display = 'flex';
				// ä¿®æ”¹é€™è£¡ï¼šä½¿ç”¨ t() å’Œ data-i18n
				revealZoneEl.innerHTML = `
					<span class="zone-label" data-i18n="lbl_reveal_zone">${typeof t === 'function' ? t('lbl_reveal_zone') : 'Reveal Zone'}</span>
					<button class="mini-btn danger" style="position:absolute; top:5px; right:5px;" onclick="closeRevealZone()">âœ•</button>
				`;
				revealCards.forEach(c => revealZoneEl.appendChild(createCardElement(c)));
			} else {
				revealZoneEl.style.display = 'none';
				revealZoneEl.innerHTML = '';
			}
		}

		if (pendingMove) document.querySelectorAll('.zone').forEach(el => el.classList.add('target-highlight'));
		if (isPointing) document.querySelectorAll('.zone').forEach(el => el.classList.add('point-target-highlight'));

		const zoneMap = {};
		const childMap = {}; 
		const rootCards = []; 

		state.cards.forEach(card => {
			if (card.zone === 'reveal-zone') return;
			if(!zoneMap[card.zone]) zoneMap[card.zone] = [];
			zoneMap[card.zone].push(card);
			if (card.parentId) {
				if (!childMap[card.parentId]) childMap[card.parentId] = [];
				childMap[card.parentId].push(card);
			} else {
				rootCards.push(card);
			}
		});

		['p1-deck', 'p1-grave', 'p1-hyper', 'p2-deck', 'p2-grave', 'p2-hyper'].forEach(zid => {
			// Skip check
			if (zonesToSkip.has(zid)) return;

			const cards = zoneMap[zid] || [];
			const glowingCard = cards.find(c => c.glow);
			if (glowingCard) {
				const zoneEl = document.querySelector(`.zone[data-zone="${zid}"]`);
				if (zoneEl) zoneEl.classList.add(`glow-${glowingCard.glow}`);
			}
		});

		const stackedZones = [
			'p1-deck', 'p1-grave', 'p1-hyper', 'p1-abyss', // åŠ å…¥ p1-abyss
			'p2-deck', 'p2-grave', 'p2-hyper', 'p2-abyss', // åŠ å…¥ p2-abyss
			'p1-shield', 'p2-shield'
		];

		const renderCardTree = (rootCard, container) => {
			const isSpreadZone = !stackedZones.includes(rootCard.zone) || rootCard.zone.includes('shield');
			if (!isSpreadZone) return;

			// é å…ˆæƒæå®¶æ—æˆå“¡
			const familyMembers = [];
			const queue = [rootCard];
			while(queue.length > 0) {
				const node = queue.shift();
				familyMembers.push(node);
				const children = (childMap[node.id] || []);
				children.forEach(c => queue.push(c));
			}

			// --- [ä¿®æ”¹é»] å¾ state.moonless åˆ¤æ–· ---
			const moonlessAce = familyMembers.find(c => state.moonless && state.moonless[c.id]);

			const createContainer = (bounds) => {
				const totalW = bounds.maxX - bounds.minX;
				const totalH = bounds.maxY - bounds.minY;
				const div = document.createElement('div');
				
				// ã€ä¿®æ”¹ã€‘åŠ ä¸Š initializing
				div.className = 'card-group initializing'; 
				
				div.style.width = `${totalW}px`;
				div.style.height = `${totalH}px`;
				div.style.position = 'relative'; 
				div.dataset.baseW = totalW; 

				div.onmouseenter = () => expandStack(div, familyMembers);
				div.onmouseleave = () => collapseStack(div);

				container.appendChild(div);
				return { div, offsetX: -bounds.minX, offsetY: -bounds.minY };
			};

			// Mode 1: ç„¡æœˆä¹‹é–€ä¾‹å¤–æ¸²æŸ“ (ä¿æŒä¸è®Š)
			if (moonlessAce) {
				const isPuzzle = (c) => c.stackType && c.stackType.includes('puzzle');
				const subjects = familyMembers.filter(c => c.id !== moonlessAce.id && !isPuzzle(c));
				const puzzlePartners = familyMembers.filter(c => c.id !== moonlessAce.id && isPuzzle(c));

				const count = subjects.length;
				const radius = 12; 
				let bounds = { minX: 0, maxX: 50, minY: 0, maxY: 70 };
				const layoutCache = new Map(); 

				if (count > 0) {
					const step = 360 / count;
					const startAngle = -90 + (step / 2); 
					subjects.forEach((sub, idx) => {
						const angleDeg = startAngle + step * idx;
						const rad = angleDeg * (Math.PI / 180);
						const offX = radius * Math.cos(rad);
						const offY = radius * Math.sin(rad);
						const visualRot = angleDeg + 270;
						layoutCache.set(sub.id, { x: offX, y: offY, rot: visualRot });
						const margin = 40; 
						bounds.minX = Math.min(bounds.minX, offX - margin);
						bounds.maxX = Math.max(bounds.maxX, offX + margin);
						bounds.minY = Math.min(bounds.minY, offY - margin);
						bounds.maxY = Math.max(bounds.maxY, offY + margin);
					});
				} else {
					bounds = { minX: -5, maxX: 55, minY: -5, maxY: 75 };
				}

				const puzzleCache = new Map();
				const measurePuzzleRecursive = (currentCard, parentX, parentY) => {
					const baseOffset = getBaseStackOffset(currentCard.stackType);
					const r = rotateVector(baseOffset.x, baseOffset.y, moonlessAce.rotation);
					const myX = parentX + r.x;
					const myY = parentY + r.y;
					puzzleCache.set(currentCard.id, { x: myX, y: myY });
					bounds.minX = Math.min(bounds.minX, myX);
					bounds.maxX = Math.max(bounds.maxX, myX + 50);
					bounds.minY = Math.min(bounds.minY, myY);
					bounds.maxY = Math.max(bounds.maxY, myY + 70);
					const children = puzzlePartners.filter(p => p.parentId === currentCard.id);
					children.forEach(child => measurePuzzleRecursive(child, myX, myY));
				};
				const directPuzzles = puzzlePartners.filter(p => p.parentId === moonlessAce.id);
				directPuzzles.forEach(p => measurePuzzleRecursive(p, 0, 0));

				const { div, offsetX, offsetY } = createContainer(bounds);
				
				// --- [æ’å…¥é€™æ®µ] åˆ¤æ–·å°é½Šæ–¹å¼ ---
				// æ ¹æ“š Root Card çš„æ—‹è½‰è§’åº¦åˆ¤æ–·
				const isRootTapped = (Math.abs(rootCard.rotation) % 180) === 90;

				if (isRootTapped) {
					// æ¢ä»¶ 6: æ©«ç½®ç‹€æ…‹å…ƒç´ é ä¸­å°é½Š
					div.classList.add('tapped-group');
				} else {
					// æ¢ä»¶ 6: é‡ç½®ç‹€æ…‹å…ƒç´ é ä¸Šå°é½Š (é è¨­ Flex-start)
					div.classList.remove('tapped-group');
				}
				
				// --- [ä¿®æ­£] ç„¡æœˆä¹‹é–€å°é½Šä¿®æ­£ ---
				// ç„¡æœˆä¹‹é–€çš„é™£å‹ç‚ºåœ“å½¢ï¼Œç„¡è«–ä¸»å¡æ˜¯å¦æ©«ç½®ï¼Œå®¹å™¨æœ¬èº«éƒ½æ‡‰è©²ã€Œæ°¸é å‚ç›´ç½®ä¸­ã€ã€‚
				
				// å¼·åˆ¶åŠ å…¥ tapped-group class (åˆ©ç”¨æ—¢æœ‰çš„ CSS è®“å®ƒ align-self: center)
				div.classList.add('tapped-group');
				
				// é¡å¤–ç¢ºä¿è®Šå½¢åŸé»åœ¨ä¸­å¿ƒ (é…åˆåœ“å½¢æ—‹è½‰è¦–è¦º)
				div.style.transformOrigin = 'center center';
				
				// --- [æ–°å¢ä¿®æ­£] å¼·åˆ¶å‚ç›´ç½®ä¸­æ ¡æ­£ (Fix Vertical Alignment) ---
				// 1. è¨ˆç®—å®¹å™¨ç¸½é«˜åº¦
				const containerHeight = bounds.maxY - bounds.minY;
				// 2. å¡ç‰‡æ¨™æº–é«˜åº¦ (70px)
				const cardHeight = 70; 
				// 3. è¨ˆç®— Ace æ‡‰è©²ä½æ–¼çš„ Top åº§æ¨™ (å®¹å™¨æ­£ä¸­é–“)
				const idealAceTop = (containerHeight - cardHeight) / 2;
				// 4. è¨ˆç®—ä½ç§»é‡ (ç›®æ¨™ä½ç½® - åŸæœ¬è¨ˆç®—å‡ºçš„ offsetY)
				// åŸæœ¬ offsetY æ˜¯ -bounds.minYï¼Œå³ Ace çš„ Top åº§æ¨™
				const shiftY = idealAceTop - offsetY;
				// -------------------------------------------------------

				subjects.forEach(sub => {
					const layout = layoutCache.get(sub.id);
					const cardEl = createCardElement(sub);
					cardEl.style.position = 'absolute';
					cardEl.style.left = `${offsetX + layout.x}px`;
					
					// [ä¿®æ”¹] åŠ ä¸Š shiftY
					cardEl.style.top = `${offsetY + layout.y + shiftY}px`;
					
					cardEl.style.zIndex = 5; 
					cardEl.dataset.visualRot = layout.rot;
					cardEl.style.transform = `rotate(${layout.rot}deg)`;
					div.appendChild(cardEl);
				});

				const aceEl = createCardElement(moonlessAce);
				aceEl.style.position = 'absolute';
				aceEl.style.left = `${offsetX}px`;
				// [ä¿®æ”¹] åŠ ä¸Š shiftY
				aceEl.style.top = `${offsetY + shiftY}px`;
				aceEl.style.zIndex = 50; 
				aceEl.classList.add('stack-base');
				let aceTransform = `rotate(${moonlessAce.rotation}deg)`;
				if (pendingMove && pendingMove.cardIds.includes(moonlessAce.id)) {
					aceTransform += ` translateY(-5px)`;
				}
				aceEl.style.transform = aceTransform;
				div.appendChild(aceEl);

				puzzlePartners.forEach(p => {
					const pos = puzzleCache.get(p.id);
					if (!pos) return; 
					const pEl = createCardElement(p);
					pEl.style.position = 'absolute';
					pEl.style.left = `${offsetX + pos.x}px`;
					// [ä¿®æ”¹] åŠ ä¸Š shiftY
					pEl.style.top = `${offsetY + pos.y + shiftY}px`;
					pEl.style.zIndex = 51;
					let pTransform = `rotate(${moonlessAce.rotation}deg)`; 
					if (pendingMove && pendingMove.cardIds.includes(p.id)) {
						pTransform += ` translateY(-5px)`;
					}
					pEl.style.transform = pTransform;
					div.appendChild(pEl);
				});

			} else {
				// Mode 2: Standard (ä¸€èˆ¬å †ç–Š)
				let bounds = { minX: Infinity, maxX: -Infinity, minY: Infinity, maxY: -Infinity };
				const nodePositions = new Map(); 
				const measureNode = (card, currentX, currentY) => {
					nodePositions.set(card.id, { x: currentX, y: currentY });
					const cx = currentX + 25; 
					const cy = currentY + 35;
					const corners = [{x:-25,y:-35}, {x:25,y:-35}, {x:25,y:35}, {x:-25,y:35}];
					corners.forEach(p => {
						const r = rotateVector(p.x, p.y, card.rotation);
						const finalX = cx + r.x;
						const finalY = cy + r.y;
						if (finalX < bounds.minX) bounds.minX = finalX;
						if (finalX > bounds.maxX) bounds.maxX = finalX;
						if (finalY < bounds.minY) bounds.minY = finalY;
						if (finalY > bounds.maxY) bounds.maxY = finalY;
					});
					const children = childMap[card.id] || [];
					children.forEach(child => {
						const baseOffset = getBaseStackOffset(child.stackType);
						const rotatedOffset = rotateVector(baseOffset.x, baseOffset.y, card.rotation);
						measureNode(child, currentX + rotatedOffset.x, currentY + rotatedOffset.y);
					});
				};
				measureNode(rootCard, 0, 0);
				if (bounds.minX === Infinity) bounds = { minX:0, maxX:50, minY:0, maxY:70 };
				const { div, offsetX, offsetY } = createContainer(bounds);
				
				const renderNodeRecursive = (card, zIndex) => {
					const pos = nodePositions.get(card.id);
					if (!pos) return;
					
					const cardW = 60; 
					const cardH = 84; 

					// [æ ¸å¿ƒä¿®æ­£ 1: è¨ˆç®—çµ•å° Group å…§éƒ¨ä¸­å¿ƒé»]
					const absCenterX = pos.x + offsetX + (cardW / 2); 
					const absCenterY = pos.y + offsetY + (cardH / 2); 

					const cardEl = createCardElement(card);
					
					// [æ ¸å¿ƒä¿®æ­£ 2: å„²å­˜çµ•å°ç•«å¸ƒä¸­å¿ƒé»]
					cardEl.dataset.logicX = absCenterX; 
					cardEl.dataset.logicY = absCenterY; 
					
					// è¨˜éŒ„åŸå§‹ä½ç½®åˆ° dataset (ä¾› expandStack ä½¿ç”¨) - ä¿æŒåŸæ¨£
					const orgLeft = pos.x + offsetX;
					const orgTop = pos.y + offsetY;
					
					cardEl.style.position = 'absolute';
					cardEl.style.left = `${orgLeft}px`;
					cardEl.style.top = `${orgTop}px`;
					
					// å¯«å…¥ dataset ä¾› expandStack ä½¿ç”¨
					cardEl.dataset.orgLeft = orgLeft;
					cardEl.dataset.orgTop = orgTop;
					cardEl.dataset.zIndex = zIndex; // åŸå§‹å±¤ç´š

					cardEl.style.zIndex = zIndex;
					let transformCSS = `rotate(${card.rotation}deg)`;
					if (pendingMove && pendingMove.cardIds.includes(card.id)) {
						transformCSS += ` translateY(-5px)`;
					}
					cardEl.style.transform = transformCSS;
					if (!card.parentId) cardEl.classList.add('stack-base');
					div.appendChild(cardEl);
					const children = childMap[card.id] || [];
					children.forEach(child => {
						let nextZ = zIndex;
						const type = child.stackType;
						if (['top','shift_up','puzzle_top','shift_down'].includes(type)) nextZ += 1;
						else nextZ -= 1;
						renderNodeRecursive(child, nextZ);
					});
				};
				renderNodeRecursive(rootCard, 10);
			}
		};

		Object.keys(zoneMap).forEach(zoneId => {
			// --- ğŸ”´ [ä¿®æ­£é–‹å§‹] åŠ å…¥ ID è½‰æ›é‚è¼¯ï¼Œç¢ºä¿èˆ‡ zonesToSkip å…§çš„ Key ä¸€è‡´ ---
			let checkId = zoneId;
			if (zoneId === 'p1-ability') checkId = 'ability-zone-p1';
			if (zoneId === 'p2-ability') checkId = 'ability-zone-p2';
			if (zonesToSkip.has(checkId)) return;			// [æ•ˆèƒ½å„ªåŒ–] å¦‚æœæ­¤å€åŸŸåœ¨ Skip åå–®ä¸­ï¼Œç›´æ¥è·³éç¹ªåœ–é‹ç®—

			const cardsInZone = zoneMap[zoneId];
			if (zoneId.includes('ability')) {
				const zoneEl = document.getElementById(zoneId === 'p1-ability' ? 'ability-zone-p1' : 'ability-zone-p2');
				
				// [æ–°å¢] æ’åºé‚è¼¯ï¼šæŒçºŒæ•ˆæœ (isContinuous) å„ªå…ˆæ’åœ¨å‰é¢ (è¦–è¦ºä¸Šçš„ä¸Šæ–¹)
				cardsInZone.sort((a, b) => {
					const valA = a.isContinuous ? 1 : 0;
					const valB = b.isContinuous ? 1 : 0;
					return valB - valA; // å¤§çš„æ’å‰é¢ (1 > 0)
				});

				cardsInZone.forEach(card => zoneEl.appendChild(createCardElement(card)));
				return;
			}
			const zoneEl = document.querySelector(`.zone[data-zone="${zoneId}"]`);
			if (!zoneEl) return;
			if (stackedZones.includes(zoneId) && !zoneId.includes('shield')) {
				const count = cardsInZone.length;
				
				if (count > 0) {
					// [æ™ºæ…§æ¸²æŸ“æ¼”ç®—æ³•]
					const indicesToRender = new Set();
					indicesToRender.add(0);          // åº•
					indicesToRender.add(count - 1);  // é ‚
					
					for (let i = 0; i < count - 1; i++) {
						const current = cardsInZone[i];
						const next = cardsInZone[i+1];
						// å¦‚æœé€™å¼µè·Ÿä¸Šé¢é‚£å¼µè§’åº¦ä¸ä¸€æ¨£ï¼Œå…©å¼µéƒ½è¦ç•«å‡ºä¾†ï¼Œæ‰èƒ½å‘ˆç¾äº¤éŒ¯æ„Ÿ
						if (current.rotation !== next.rotation) {
							indicesToRender.add(i);
							indicesToRender.add(i+1);
						}
					}
					
					// å°‡ Set è½‰ç‚ºé™£åˆ—ä¸¦æ’åºï¼Œç¢ºä¿ Z-Index æ­£ç¢º (ç”±åº•åˆ°é ‚)
					const sortedIndices = Array.from(indicesToRender).sort((a,b) => a - b);
					
					sortedIndices.forEach(index => {
						const card = cardsInZone[index];
						const cardEl = createCardElement(card);
						
						// å¼·åˆ¶å †ç–Šæ¨£å¼
						cardEl.style.position = 'absolute';
						// å±…ä¸­å®šä½
						cardEl.style.top = '0';
						cardEl.style.left = '0';
						cardEl.style.right = '0';
						cardEl.style.bottom = '0';
						cardEl.style.margin = 'auto';
						
						// è¨­å®šå±¤ç´šï¼Œç¢ºä¿ä¸Šé¢çš„è“‹ä½ä¸‹é¢çš„
						cardEl.style.zIndex = index + 1; 
						
						zoneEl.appendChild(cardEl);
					});
				}

				// æ•¸é‡æ¨™è¨˜ (Badge)
				const badge = document.createElement('div');
				badge.className = 'count-badge';
				badge.innerText = count;
				// ç¢ºä¿æ•¸å­—æ°¸é æµ®åœ¨æœ€ä¸Šé¢
				badge.style.zIndex = 1000; 
				zoneEl.appendChild(badge);
			} else {
				const roots = rootCards.filter(c => c.zone === zoneId);
				roots.forEach(root => renderCardTree(root, zoneEl));
			}
		});

		// [æ–°å¢] åœ¨æ‰€æœ‰å¡ç‰‡ DOM ç”Ÿæˆå®Œç•¢å¾Œï¼ŒåŸ·è¡Œç¸®æ”¾è¨ˆç®—
		requestAnimationFrame(() => {
			// ä¿®æ”¹å¾Œï¼š
			// æª¢æŸ¥ p1-battle æˆ– p2-battle æ˜¯å¦åœ¨ã€Œä¸éœ€è¦é‡ç¹ª (Skip)ã€çš„æ¸…å–®ä¸­
			// å¦‚æœå®ƒä¸åœ¨ Skip æ¸…å–®ä¸­ (!has)ï¼Œä»£è¡¨å®ƒæ˜¯ã€Œé«’ã€çš„ï¼Œéœ€è¦é‡æ–°è¨ˆç®—
			const battleZonesDirty = !zonesToSkip.has('p1-battle') || !zonesToSkip.has('p2-battle');
			applyBattleZoneScaling(battleZonesDirty);
			
			// 2. åœ¨ç¸®æ”¾è¨ˆç®—ã€Œä¹‹å¾Œã€çš„ä¸‹ä¸€å¹€ï¼Œæ‰åŸ·è¡Œç•«ç®­é ­
			requestAnimationFrame(() => {
				renderArrows();
			});
		});
		renderTimeline();

		// --- Dialogue Rendering ---
		const diagLayer = document.getElementById('dialogue-layer');
		if (state.dialogueData) {
			diagLayer.classList.add('active');
			['p1', 'p2'].forEach(id => {
				const data = state.dialogueData[id];
				const row = document.getElementById(`diag-row-${id}`);
				const img = document.getElementById(`diag-img-${id}`);
				const name = document.getElementById(`diag-name-${id}`);
				const text = document.getElementById(`diag-text-${id}`);
				
				// [æ–°å¢] å–å¾—å°è©±æ¡†æœ¬é«”
				const box = row.querySelector('.diag-box');

				if (data && data.active) {
					row.classList.add('visible');
					
					// [é—œéµä¿®æ”¹] è®“å°è©±æ¡†å¯ä»¥è¢«é»æ“Š
					box.style.pointerEvents = 'auto'; 
					box.style.cursor = 'pointer';
					box.title = "é»æ“Šç·¨è¼¯å°è©±";
					
					// ç¶å®šé»æ“Šäº‹ä»¶
					box.onclick = (e) => {
						e.stopPropagation();
						if (!isDrafting) {
							editAction(currentIndex);
						} else {
							openDialogueModal();
						}
					};

					// é‡ç½®å‹•ç•« Class ä»¥è§¸ç™¼é‡æ’­
					row.classList.remove('fx-fade', 'fx-slide', 'fx-direct');
					void row.offsetWidth; // å¼·åˆ¶é‡ç¹ª (Reflow)
					row.classList.add(`fx-${data.effect}`);

					name.innerText = data.name;
					text.innerText = data.dataText; 
					text.className = `diag-text text-${data.size}`;
					
					// --- [æ–°å¢] å¼·åˆ¶æ²å‹•åˆ°æœ€åº•éƒ¨ (Auto Scroll to Bottom) ---
					setTimeout(() => {
						text.scrollTop = text.scrollHeight;
					}, 0);

					const imgKey = `avatar_${id}_${data.emotion}`;
					const src = globalImageRegistry[imgKey];
					img.style.backgroundImage = src ? `url(${src})` : 'none';
				} else {
					row.classList.remove('visible');
					// éš±è—æ™‚ç¢ºä¿ä¸å¯é»æ“Š (é¿å…æ“‹åˆ°ä¸‹æ–¹çš„å¡ç‰‡)
					if (box) box.style.pointerEvents = 'none';
				}
			});
		} else {
			diagLayer.classList.remove('active');
			document.querySelectorAll('.diag-row').forEach(el => el.classList.remove('visible'));
		}

		// --- [ä¿®æ”¹] å‹åˆ©ç•«é¢æ¸²æŸ“é‚è¼¯ (é™åˆ¶åƒ…åœ¨è§¸ç™¼ç•¶ä¸‹æ’­æ”¾) ---
		
		// 1. åˆ¤æ–·ç•¶å‰æ­¥é©Ÿæ˜¯å¦ç‚ºã€Œè§¸ç™¼å‹åˆ©ã€çš„é‚£ä¸€æ­¥
		let isWinActionStep = false;
		if (currentIndex >= 0 && history[currentIndex]) {
			// æª¢æŸ¥ç•¶å‰çš„ Action è£¡é¢æœ‰æ²’æœ‰åŒ…å« GAME_WIN æ“ä½œ
			isWinActionStep = history[currentIndex].action.operations.some(o => o.type === 'GAME_WIN');
		}

		// 2. åªæœ‰åœ¨ã€Œç‹€æ…‹æœ‰è´å®¶ã€ä¸”ã€Œç•¶å‰æ­¥é©Ÿæ­£æ˜¯å‹åˆ©æ™‚åˆ»ã€æ‰é¡¯ç¤ºç‰¹æ•ˆ
		if (state.winner && isWinActionStep) {
			
			// å¦‚æœç•«é¢é‚„æ²’é¡¯ç¤ºï¼Œæ‰é€²è¡Œå…§å®¹ç”Ÿæˆ
			if (winOverlay.style.display !== 'flex') {
				winOverlay.style.display = 'flex';
				
				const winnerText = state.winner === 1 ? t('msg_p1_win') : t('msg_p2_win');
				const color = state.winner === 1 ? "var(--p1-main)" : "var(--p2-main)";
				
				winOverlay.innerHTML = `
					<div class="win-text" style="color: ${color}">${winnerText}</div>
					<div class="win-sub">Congratulations!</div>
				`;
				
				// ç”Ÿæˆå½©å¸¶ç‰¹æ•ˆ
				const colors = ['#f1c40f', '#e74c3c', '#3498db', '#9b59b6', '#2ecc71'];
				for (let i = 0; i < 50; i++) {
					const conf = document.createElement('div');
					conf.className = 'confetti';
					conf.style.left = Math.random() * 100 + 'vw';
					conf.style.animationDuration = (Math.random() * 3 + 2) + 's';
					conf.style.animationDelay = (Math.random() * 2) + 's';
					conf.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
					winOverlay.appendChild(conf);
				}
				
				// è‡ªå‹•æ¸…é™¤è¨ˆæ™‚å™¨
				if (winOverlayTimeout) clearTimeout(winOverlayTimeout);
				winOverlayTimeout = setTimeout(() => {
					winOverlay.style.display = 'none';
					winOverlay.innerHTML = '';
				}, 4500);

				winOverlay.onclick = () => {
					winOverlay.style.display = 'none';
					if (winOverlayTimeout) clearTimeout(winOverlayTimeout);
				};
			}
		} else {
			// [é—œéµ] å¦‚æœä¸æ˜¯å‹åˆ©ç•¶ä¸‹çš„æ­¥é©Ÿ (ä¾‹å¦‚å¾ŒçºŒçš„è£œè¿°ã€ç§»å‹•)ï¼Œå¼·åˆ¶éš±è—é®ç½©
			winOverlay.style.display = 'none';
			winOverlay.innerHTML = ''; 
		}
		// ------------------------------
		// ------------------------------

		// --- [ä¿®æ”¹] å–å¾—ç•¶å‰æ­¥é©Ÿçš„ç§»å‹•å¡ç‰‡ (é€šç”¨åŒ–) ---
		// åŸæœ¬åªæª¢æŸ¥ reveal-zoneï¼Œç¾åœ¨æ”¹ç‚ºæŠ“å–ä»»ä½• MOVE æ“ä½œ
		let movingCardIds = [];

		// åªæœ‰åœ¨æ’­æ”¾æˆ–é‡ç¹ªç•¶ä¸‹ï¼Œæª¢æŸ¥ç•¶å‰ Action
		if (currentIndex >= 0 && history[currentIndex]) {
			const action = history[currentIndex].action;
			// ä½¿ç”¨ Set ä¾†ç¢ºä¿ ID ä¸é‡è¤‡ï¼Œä¸¦ä¿æŒæ’å…¥é †åº
			const uniqueMovingIds = new Set();
			// æ‰¾å‡ºé€™ä¸€æ­¥é©Ÿä¸­çš„ç§»å‹•æ“ä½œ (MOVE)
			const moveOps = action.operations.filter(o => o.type === 'MOVE');
			moveOps.forEach(op => {
				op.cardIds.forEach(id => uniqueMovingIds.add(id));
			});
			
			// 2. [æ–°å¢] æŠ“å– TOGGLE_MOONLESS æ“ä½œ
			// å¦‚æœé€™ä¸€æ­¥æœ‰åˆ‡æ›ç„¡æœˆä¹‹é–€ï¼Œå—å½±éŸ¿çš„æ•´å€‹å®¶æ—éƒ½æ‡‰è©²è¦–ç‚ºã€Œæ­£åœ¨ç§»å‹•ã€
			const moonOps = action.operations.filter(o => o.type === 'TOGGLE_MOONLESS');
			moonOps.forEach(op => {
				// op.cardIds é€šå¸¸æ˜¯é»æ“Šçš„é‚£å¼µä¸»å¡
				// æˆ‘å€‘éœ€è¦æ‰¾å‡ºè·Ÿå®ƒé€£å‹•çš„æ‰€æœ‰å¡ç‰‡ (ä¸»å¡ + ç´ æ)
				const familyIds = getAllLinkedCardIds(state, op.cardIds);
				familyIds.forEach(id => uniqueMovingIds.add(id));
			});

			// è½‰å›é™£åˆ—ï¼Œé€™å°±æ˜¯æœ€çµ‚è¦å¥—ç”¨ 0.2s å»¶é²çš„æ¸…å–®
			movingCardIds = Array.from(uniqueMovingIds);
		}

		requestAnimationFrame(() => {
			const lastPositions = getCardPositions(zonesToSkip);
			
			Object.keys(lastPositions).forEach(id => {
				if (id.startsWith('ZONE_')) return;
				const cardEl = document.querySelector(`.card[data-id="${id}"]`);
				if (!cardEl) return;
				
				let start = firstPositions[id];
				if (!start && lastRenderedState) {
					const prevCard = lastRenderedState.cards.find(c => c.id == id);
					if (prevCard) start = firstPositions['ZONE_' + prevCard.zone];
				}
				
				if (start) {
					const last = lastPositions[id];
					const deltaX = start.left - last.left;
					const deltaY = start.top - last.top;
					
					// åªæœ‰ç•¶ä½ç½®çœŸçš„æœ‰è®Šå‹•æ™‚æ‰åŸ·è¡Œå‹•ç•«
					if (Math.abs(deltaX) > 1 || Math.abs(deltaY) > 1) {
						const cardData = state.cards.find(c => c.id == id);
						let rotation = cardData ? cardData.rotation : 0;
						const isAbility = cardData && cardData.zone.includes('ability');

						// [ä¿®æ­£] å¦‚æœ DOM å…ƒç´ ä¸Šæœ‰æ¨™è¨˜ã€Œè¦–è¦ºè§’åº¦ã€(ä¾†è‡ªç„¡æœˆæ¨¡å¼)ï¼Œå„ªå…ˆä½¿ç”¨å®ƒ
						if (cardEl.dataset.visualRot) {
							rotation = parseFloat(cardEl.dataset.visualRot);
						}

						if (cardData && cardData.stackType && cardData.stackType.includes('puzzle')) {
							 // puzzle å¡ç‰‡é€šå¸¸æ˜¯è·Ÿéš¨ç§»å‹•ï¼Œæš«ä¸è™•ç†å€‹åˆ¥å‹•ç•«
						} else {
							// 1. å…ˆç¬é–“ç§»å‹•å›èµ·é» (ä¿æŒåœ¨åŸå€åŸŸçš„ä½ç½®)
							cardEl.style.transition = 'none';
							cardEl.style.transform = `translate(${deltaX}px, ${deltaY}px) rotate(${isAbility?0:rotation}deg)`;
							
							// 2. ä¸‹ä¸€å¹€åŸ·è¡Œç§»å‹•å‹•ç•«
							requestAnimationFrame(() => {
								const flyTime = 0.5; // å–®å¼µé£›è¡Œæ™‚é–“ 0.5ç§’
								
								let duration = `${flyTime}s`;
								let delay = '0s';
								let easing = 'cubic-bezier(0.25, 0.8, 0.25, 1)';

								// --- [æ ¸å¿ƒä¿®æ”¹] é€šç”¨åºåˆ—å‹•ç•«é‚è¼¯ ---
								// æª¢æŸ¥é€™å¼µå¡ç‰‡æ˜¯å¦åœ¨ç•¶å‰çš„ç§»å‹•æ¸…å–®ä¸­
								// ä½¿ç”¨ loose equality (==) é¿å…å­—ä¸²/æ•¸å­—å‹åˆ¥å•é¡Œ
								const moveIndex = movingCardIds.findIndex(mid => mid == id);

								if (moveIndex !== -1) {
									const totalCards = movingCardIds.length;
									
									// å¦‚æœåªæœ‰ä¸€å¼µç‰Œï¼Œå°±ä¸éœ€è¦å»¶é²
									if (totalCards > 1) {
										// æ¼”ç®—æ³•ï¼šæ¯å¼µç‰Œé–“éš”é£›è¡Œæ™‚é–“çš„ 20%
										let interval = flyTime * 0.2;
										
										// é˜²å‘†ï¼šå¦‚æœä¸€æ¬¡ç§»å‹•è¶…å¤šå¼µ (å¦‚æ•´å‰¯ç‰Œ 40å¼µ)ï¼Œé™åˆ¶ç¸½ç™¼ç‰Œæ™‚é–“ä¸è¶…é 1.5 ç§’
										const maxTotalLag = 1.5;
										if ((interval * totalCards) > maxTotalLag) {
											interval = maxTotalLag / totalCards;
										}
										
										// è¨­å®šå»¶é²ï¼šç¬¬ N å¼µç‰Œå»¶é² N * interval ç§’
										delay = `${moveIndex * interval}s`;
									}
								}
								// -------------------------------

								cardEl.style.transition = `transform ${duration} ${easing} ${delay}`;
								cardEl.style.transform = `translate(0, 0) rotate(${isAbility?0:rotation}deg)`;
							});
						}
					}
				}
			});
			
			lastRenderedState = cloneState(state);
			
			// --- [æ–°å¢] ä¿®æ­£ï¼šåœ¨æ’­æ”¾æ™‚è§¸ç™¼æ¬¡å…ƒç ´è£‚ (Reality Break) ---
			if (currentIndex >= 0 && history[currentIndex]) {
				const action = history[currentIndex].action;
			
				// 1. æª¢æŸ¥æ˜¯å¦è™•æ–¼æ’­æ”¾æ¨¡å¼ (æˆ–æ‰‹æ©Ÿç‰ˆ)
				const isPlaying = document.body.classList.contains('is-playing');
				const isMobile = document.body.classList.contains('mobile-mode');

				// 2. æƒææ­¤æ­¥é©Ÿçš„æ‰€æœ‰æ“ä½œï¼Œåªè¦æœ‰ä»»ä½•ã€Œæ´—ç‰Œã€è¡Œç‚ºå°±è¦–ç‚ºè§¸ç™¼
				// åŒ…å«: type='SHUFFLE' (åŸåœ°æ´—ç‰Œ) æˆ– type='MOVE'ä¸”å¸¶æœ‰withShuffleAnim (ç§»å‹•ä¸¦æ´—ç‰Œ)
				const hasShuffle = action.operations.some(o => 
					o.type === 'SHUFFLE' || (o.type === 'MOVE' && o.withShuffleAnim)
				);

				// 3. è§¸ç™¼æ¢ä»¶ï¼š(æœ‰æ´—ç‰Œ) AND (æ­£åœ¨æ’­æ”¾/æ‰‹æ©Ÿ) AND (é€™ä¸€æ­¥é‚„æ²’æ’­é)
				if (hasShuffle && (isPlaying || isMobile) && currentIndex !== lastShuffleStep) {
					console.log("ğŸ”€ åµæ¸¬åˆ°æ´—ç‰ŒæŒ‡ä»¤ï¼Œæ’­æ”¾ç‰¹æ•ˆ...");
					
					lastShuffleStep = currentIndex; // [é—œéµ] é–å®šæ­¤æ­¥é©Ÿï¼Œé¿å…é‡è¤‡æ’­æ”¾
					
					// [ä¿®æ­£ç‰ˆ] æ‰¾å‡ºæ‰€æœ‰éœ€è¦æ’­æ”¾ç‰¹æ•ˆçš„å€åŸŸ (ä½¿ç”¨ Set å»é™¤é‡è¤‡)
					const targetZones = new Set();

					action.operations.forEach(o => {
						if (o.type === 'SHUFFLE') {
							// åŸåœ°æ´—ç‰Œï¼šç›®æ¨™æ˜¯ zoneId
							targetZones.add(o.zoneId);
						} else if (o.type === 'MOVE' && o.withShuffleAnim) {
							// ç§»å‹•ä¸¦æ´—ç‰Œï¼šç›®æ¨™æ˜¯ toZone
							targetZones.add(o.toZone);
						}
					});

					// é‡å°æ¯ä¸€å€‹ç¨ç«‹å€åŸŸè§¸ç™¼å‹•ç•«
					targetZones.forEach(zoneId => {
						// ç¨å¾®éŒ¯é–‹ä¸€é»é»æ™‚é–“ (éå¿…è¦ï¼Œä½†è¦–è¦ºä¸Šæ¯”è¼ƒè‡ªç„¶)
						setTimeout(() => {
							triggerShuffleAnimation(12, zoneId);
						}, Math.random() * 200);
					});
				} 
				else if (!hasShuffle) {
					// é›¢é–‹äº†æœ‰æ´—ç‰Œçš„é‚£ä¸€æ­¥ï¼Œé‡ç½®é–å®šè®Šæ•¸ï¼Œé€™æ¨£ä¸‹æ¬¡è·³å›ä¾†æ™‚å¯ä»¥å†æ’­
					lastShuffleStep = -1;
				}
				const rbOp = action.operations.find(o => o.type === 'REALITY_BREAK');
				
				// æ¢ä»¶ï¼š(æœ‰ç‰¹æ•ˆæŒ‡ä»¤) AND (æ­£åœ¨æ’­æ”¾) AND (é€™ä¸€æ­¥é‚„æ²’æ’­é)
				if (rbOp && (isPlaying || isMobile) && currentIndex !== lastRbStep) {
					console.log("åµæ¸¬åˆ°æ¬¡å…ƒç ´è£‚ç‰¹æ•ˆï¼Œé–‹å§‹æ’­æ”¾...");
					lastRbStep = currentIndex; // æ¨™è¨˜æ­¤æ­¥é©Ÿå·²è™•ç†
					playRealityBreak(rbOp.data);
				}
				// æƒ…æ³ Bï¼šé€™ä¸€æ­¥æ²’æœ‰ç‰¹æ•ˆ -> è§£é– (é—œéµä¿®æ”¹ï¼)
				else {
					// åªè¦é›¢é–‹äº†æœ‰ç‰¹æ•ˆçš„é‚£ä¸€æ­¥ï¼Œå°±é‡ç½®è®Šæ•¸
					// é€™æ¨£ä¸‹æ¬¡å†å›ä¾†æ™‚ï¼ŒcurrentIndex(5) != lastRbStep(-1) å°±æœƒæˆç«‹ï¼Œç‰¹æ•ˆå°±æœƒé‡æ’­
					lastRbStep = -1; 
				}
			}

			// [æ–°å¢] ç‹ç‰Œé€²å ´ç‰¹æ•ˆè§¸ç™¼æª¢æŸ¥
			// æª¢æŸ¥ç•¶å‰é€™ä¸€æ­¥ (currentIndex) æ˜¯å¦æœ‰ç§»å‹•æ“ä½œ
			if (currentIndex >= 0 && history[currentIndex]) {
				
				// 1. ç¯©é¸å‡ºé€™ä¸€æ­¥é©Ÿæœ‰ç§»å‹•ä¸”æ˜¯ç‹ç‰Œçš„å¡ç‰‡
				const movedAces = movingCardIds.filter(id => globalAceRegistry[id]);

				if (movedAces.length > 0 && currentIndex !== lastAnimatedStep) {
					
					const currState = history[currentIndex].state;
					const prevState = (currentIndex > 0) ? history[currentIndex - 1].state : initialState;

					for (const aceId of movedAces) {
						// A. æª¢æŸ¥çµ‚é» (Current State): å¿…é ˆåœ¨æˆ°é¬¥å€
						const currCard = currState.cards.find(c => c.id == aceId);
						const isInBattleNow = currCard && currCard.zone.includes('battle');

						// B. æª¢æŸ¥èµ·é» (Previous State): å¿…é ˆã€Œä¸åœ¨ã€æˆ°é¬¥å€
						let wasInBattleBefore = false;
						if (prevState) {
							const prevCard = prevState.cards.find(c => c.id == aceId);
							if (prevCard && prevCard.zone.includes('battle')) {
								wasInBattleBefore = true;
							}
						}

						// C. æª¢æŸ¥å †ç–Šç‹€æ…‹: æ˜¯å¦ç‚ºéš±è—çš„é€²åŒ–å…ƒ?
						// æˆ‘å€‘åªéæ¿¾æ‰ 'bottom' å’Œ 'bottom_exposed' (é€²åŒ–å…ƒ)
						// ä½†ä¿ç•™ 'puzzle_bottom' (é€£çµå¡)ï¼Œå› ç‚ºé€£çµå¡è¦–ç‚ºå ´ä¸Šçš„å€‹åˆ¥ç”Ÿç‰©
						const isUnderneath = currCard.parentId && currCard.stackType && 
											 (currCard.stackType === 'bottom' || currCard.stackType === 'bottom_exposed');

						// D. ç¶œåˆåˆ¤æ–·ï¼š(é€²æˆ°å ´) AND (åŸæœ¬ä¸åœ¨) AND (ä¸æ˜¯é€²åŒ–å…ƒ)
						if (isInBattleNow && !wasInBattleBefore && !isUnderneath) {
							
							// è¨ˆç®—ç²¾ç¢ºçš„è½åœ°æ™‚é–“
							const flyTime = 0.5; // CSSå‹•ç•«æ™‚é–“ 0.5s
							let arrivalTime = flyTime * 1000; 

							// è¨ˆç®—æ’éšŠå»¶é²
							const mIndex = movingCardIds.findIndex(mid => mid == aceId);
							if (mIndex !== -1 && movingCardIds.length > 1) {
								let interval = flyTime * 0.2; 
								const maxTotalLag = 1.5;
								if ((interval * movingCardIds.length) > maxTotalLag) {
									interval = maxTotalLag / movingCardIds.length;
								}
								arrivalTime += (mIndex * interval * 1000);
							}

							console.log("è§¸ç™¼ç‹ç‰Œç‰¹æ•ˆ (é€²å ´ - å…è¨±Puzzle) ID:", aceId);
							
							triggerAceAnimation(aceId, arrivalTime);
							
							lastAnimatedStep = currentIndex;
							break; 
						}
					}
					
					// æ¨™è¨˜å·²æª¢æŸ¥éæ­¤æ­¥é©Ÿ
					if (currentIndex !== lastAnimatedStep) {
						lastAnimatedStep = currentIndex;
					}
				}
			}
		});
		
		// --- [ä¿®æ”¹] æ¸²æŸ“çŒœæ‹³çµæœ (å¡ç‰Œç‰ˆ) ---
		const rpsOverlay = document.getElementById('rps-overlay');
		
		if (state.rpsResult && !isDrafting) { 
			const { p1, p2, winner } = state.rpsResult;
			const options = ['rock', 'paper', 'scissors'];

			// è¼”åŠ©å‡½å¼ï¼šç”¢ç”Ÿç©å®¶çš„æ‰‹ç‰Œ HTML
			const createHandHTML = (playerId, chosenType, isWinner) => {
				
				// =========== [è¨­å®š] çŒœæ‹³åœ–ç‰‡ç¶²å€è¨­å®šå€ ===========
				const rpsImages = {
					rock:     'https://dm.takaratomy.co.jp/wp-content/card/cardthumb/dm28-056.jpg',   // âœŠ çŸ³é ­
					paper:    'https://dm.takaratomy.co.jp/wp-content/card/cardthumb/dm28-103.jpg',   // ğŸ–ï¸ å¸ƒ
					scissors: 'https://dm.takaratomy.co.jp/wp-content/card/cardthumb/dm28-060.jpg'    // âœŒï¸ å‰ªåˆ€
				};
				// =================================================

				let html = '';
				options.forEach(type => {
					const isSelected = (type === chosenType);
					let classes = 'rps-card';
					if (isSelected) classes += ' selected';
					else classes += ' unselected';
					if (isSelected && isWinner) classes += ' winner';

					const imgKey = `rps_${type}`;
					const bgUrl = globalImageRegistry[imgKey] || rpsImages[type] || '';

					html += `
						<div class="${classes}" style="background-image: url('${bgUrl}')">
							${isSelected ? `<div class="rps-label">P${playerId}</div>` : ''}
						</div>
					`;
				});
				return html;
			};

			const p1Win = (winner === 1);
			const p2Win = (winner === 2);

			rpsOverlay.innerHTML = `
				<div class="rps-container p2">
					${createHandHTML(2, p2, p2Win)}
				</div>
				<div class="rps-vs-text">VS</div>
				<div class="rps-container p1">
					${createHandHTML(1, p1, p1Win)}
				</div>
				${winner === null ? '<div class="rps-result-msg">DRAW!</div>' : ''}
			`;
			
			// 2. é¡¯ç¤ºç•«é¢ä¸¦é‡ç½®é€æ˜åº¦
			rpsOverlay.style.display = 'flex';
			rpsOverlay.style.transition = 'none'; // ç§»é™¤éæ¸¡ä»¥ä¾¿ç¬é–“é¡¯ç¤º
			rpsOverlay.style.opacity = '1';

			// 3. è¨­å®šè‡ªå‹•é—œé–‰ (ç¸½æ™‚é•· 3.5ç§’ = 1.5ç§’å‹•ç•« + 2ç§’é–ƒçˆ)
			const timerId = setTimeout(() => {
				// é–‹å§‹æ·¡å‡º
				rpsOverlay.style.transition = 'opacity 0.5s ease';
				rpsOverlay.style.opacity = '0';
				
				// æ·¡å‡ºå‹•ç•«çµæŸå¾Œéš±è— DOM
				setTimeout(() => {
					rpsOverlay.style.display = 'none';
				}, 500); 
			}, 3500); 

			rpsOverlay.dataset.timer = timerId;

		} else {
			rpsOverlay.style.display = 'none';
		}
		
		updateSliderUI();
		
		// [æ–°å¢] æª¢æŸ¥æ‰‹æ©Ÿç‰ˆéŸ³æ¨‚æŒ‰éˆ•å¯è¦‹æ€§
		if (typeof checkMobileMusicButtonVisibility === 'function') {
			checkMobileMusicButtonVisibility();
		}

		// --- [æ–°å¢] æª¢æŸ¥ä¸¦æ›´æ–°ã€Œç‰¹æ•ˆæŒ‰éˆ•ã€ç‹€æ…‹ ---
		const btnRb = document.getElementById('btn-rb-effect');
		if (btnRb) {
			let hasRb = false;

			// 1. å„ªå…ˆæª¢æŸ¥ Draft (ç·¨è¼¯æ¨¡å¼)
			if (isDrafting && draftOperations.length > 0) {
				if (draftOperations.some(o => o.type === 'REALITY_BREAK')) {
					hasRb = true;
				}
			} 
			// 2. å…¶æ¬¡æª¢æŸ¥ Current Step (æª¢è¦–æ¨¡å¼)
			else if (currentIndex >= 0 && history[currentIndex]) {
				const ops = history[currentIndex].action.operations;
				if (ops && ops.some(o => o.type === 'REALITY_BREAK')) {
					hasRb = true;
				}
			}

			// åˆ‡æ›æ¨£å¼
			if (hasRb) {
				btnRb.classList.add('highlight');
				btnRb.title = "é»æ“Šç·¨è¼¯æ­¤ç‰¹æ•ˆ"; // åŠ å…¥æç¤ºæ–‡å­—
			} else {
				btnRb.classList.remove('highlight');
				btnRb.title = "æ’å…¥æ–°ç‰¹æ•ˆ";
			}
		}
		// ----------------------------------------
		
		// [ä¿®æ”¹] å¢åŠ  !skipScroll åˆ¤æ–·ï¼Œæ‰‹å‹•é»æ“Šæ™‚ä¸æ²å‹•
		if (!document.body.classList.contains('mobile-mode') && !skipScroll) {
			 scrollToActiveStep();
		}
	}
	
	// --- [æœ€çµ‚ä¿®æ­£ç‰ˆ JS] æˆ°é¬¥å€è‡ªå‹•ä½ˆå±€æ¼”ç®—æ³• ---

	// 1. è¨ˆç®—å¡ç‰‡ç¾¤çµ„çš„çµ•å°é‚Šç•Œ (åŒ…å«å­å¡ç‰‡èˆ‡æ—‹è½‰æ¨¡æ“¬)
	function measureCardGroupBounds(rootCard, allCards, forcedRotation = null) {
		const CARD_W = 60; const CARD_H = 84;
		const HW = CARD_W / 2; const HH = CARD_H / 2;
		const state = getCurrentDisplayState();

		// å»ºç«‹å®¶æ—æ¨¹
		const familyMembers = [];
		const childMap = {};
		const queue = [rootCard];
		const processed = new Set();
		while(queue.length > 0) {
			const node = queue.shift();
			if (processed.has(node.id)) continue;
			processed.add(node.id);
			familyMembers.push(node);
			const children = allCards.filter(c => c.parentId === node.id);
			if (children.length > 0) childMap[node.id] = children;
			children.forEach(c => queue.push(c));
		}

		const moonlessAce = familyMembers.find(c => state.moonless && state.moonless[c.id]);

		// === ç„¡æœˆä¹‹é–€ï¼šè¨ˆç®—æœ€å¤§åŒ…åœç›’ (Union) ===
		if (moonlessAce) {
			let minX = 0, maxX = 0, minY = 0, maxY = 0;

			// 1. ç´ æåœˆ (ä¸æ—‹è½‰)
			const isPuzzle = (c) => c.stackType && c.stackType.includes('puzzle');
			const subjects = familyMembers.filter(c => c.id !== moonlessAce.id && !isPuzzle(c));
			
			if (subjects.length > 0) {
				const step = 360 / subjects.length;
				const startAngle = -90 + (step / 2); 
				subjects.forEach((sub, idx) => {
					const rad = (startAngle + step * idx) * (Math.PI / 180);
					const offX = 12 * Math.cos(rad);
					const offY = 12 * Math.sin(rad);
					// Margin = 40
					if (offX - 40 < minX) minX = offX - 40;
					if (offX + 40 > maxX) maxX = offX + 40;
					if (offY - 40 < minY) minY = offY - 40;
					if (offY + 40 > maxY) maxY = offY + 40;
				});
			} else {
				minX = -30; maxX = 30; minY = -42; maxY = 42;
			}

			// 2. ä¸»å¡èˆ‡é€£çµå¡ (æª¢æŸ¥ 0åº¦ èˆ‡ 90åº¦ å–æœ€å¤§å€¼)
			const puzzlePartners = familyMembers.filter(c => c.id !== moonlessAce.id && isPuzzle(c));
			const checkBounds = (simAngle) => {
				const rotRad = simAngle * (Math.PI / 180);
				const cos = Math.cos(rotRad), sin = Math.sin(rotRad);
				const checkCorner = (cx, cy) => {
					[{x:-HW,y:-HH}, {x:HW,y:-HH}, {x:HW,y:HH}, {x:-HW,y:HH}].forEach(pt => {
						const rx = pt.x * cos - pt.y * sin;
						const ry = pt.x * sin + pt.y * cos;
						const absX = cx + rx; const absY = cy + ry;
						if (absX < minX) minX = absX; if (absX > maxX) maxX = absX;
						if (absY < minY) minY = absY; if (absY > maxY) maxY = absY;
					});
				};
				checkCorner(0, 0); // Check Ace
				const measurePuzzle = (card, px, py) => {
					const children = puzzlePartners.filter(p => p.parentId === card.id);
					children.forEach(child => {
						const base = getBaseStackOffset(child.stackType);
						const ro = rotateVector(base.x, base.y, simAngle);
						const cx = px + ro.x; const cy = py + ro.y;
						checkCorner(cx, cy);
						measurePuzzle(child, cx, cy);
					});
				};
				puzzlePartners.filter(p => p.parentId === moonlessAce.id).forEach(p => {
					const base = getBaseStackOffset(p.stackType);
					const ro = rotateVector(base.x, base.y, simAngle);
					measurePuzzle(p, ro.x, ro.y);
				});
			};
			checkBounds(0);
			checkBounds(90);
			return { width: maxX - minX, height: maxY - minY };
		} 
		// === æ™®é€šå †ç–Šï¼šç¶­æŒåŸæ¨£ (å®‰å…¨) ===
		else {
			let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
			const baseRotation = (forcedRotation !== null) ? forcedRotation : rootCard.rotation;
			const traverse = (card, ox, oy) => {
				const rotRad = baseRotation * (Math.PI / 180);
				const cos = Math.cos(rotRad), sin = Math.sin(rotRad);
				const fcx = ox * cos - oy * sin;
				const fcy = ox * sin + oy * cos;
				[{x:-HW,y:-HH}, {x:HW,y:-HH}, {x:HW,y:HH}, {x:-HW,y:HH}].forEach(pt => {
					const rx = pt.x * cos - pt.y * sin;
					const ry = pt.x * sin + pt.y * cos;
					const ax = fcx + rx; const ay = fcy + ry;
					if (ax < minX) minX = ax; if (ax > maxX) maxX = ax;
					if (ay < minY) minY = ay; if (ay > maxY) maxY = ay;
				});
				(childMap[card.id] || []).forEach(child => {
					const off = getBaseStackOffset(child.stackType);
					traverse(child, ox + off.x, oy + off.y);
				});
			};
			traverse(rootCard, 0, 0);
			if (minX === Infinity) return { width: CARD_W, height: CARD_H };
			return { width: maxX - minX, height: maxY - minY };
		}
	}

	// --- [æœ€çµ‚ä¿®æ­£ç‰ˆ] æˆ°é¬¥å€ä½ˆå±€ï¼šP1/P2åŒæ­¥ + æœ€å¤§åŒ– + å¾Œç®—é–“è· ---
	function applyBattleZoneScaling(force = true) {
		if (!force) return; // å¦‚æœæ²’æœ‰å¼·åˆ¶æ›´æ–°ï¼Œç›´æ¥è·³å‡ºï¼Œç¯€çœè¨ˆç®—è³‡æº
		const state = getCurrentDisplayState();
		const zones = [
			{ id: 'p1-battle', el: document.querySelector('.battle-zone[data-zone="p1-battle"]') },
			{ id: 'p2-battle', el: document.querySelector('.battle-zone[data-zone="p2-battle"]') }
		];
		
		// [ä¿®æ­£ 2] ç§»é™¤é è¨­ GAP_RATIOï¼Œæ”¹ç‚ºå‹•æ…‹è¨ˆç®—
		const allCards = state.cards;

		// 1. è¨ˆç®— Scale
		const zoneCalculations = zones.map(zone => {
			if (!zone.el) return null;
			
			// æ¸…é™¤èˆŠ Padding ä»¥å–å¾—çœŸå¯¦é«˜åº¦
			zone.el.style.paddingTop = '';
			zone.el.style.paddingBottom = '';
			
			const style = window.getComputedStyle(zone.el);
			const paddingX = parseFloat(style.paddingLeft) + parseFloat(style.paddingRight);
			
			const containerH = zone.el.clientHeight;
			const availW = zone.el.clientWidth - paddingX;
			
			const rootCards = allCards.filter(c => c.zone === zone.id && !c.parentId);
			
			if (rootCards.length === 0) {
				return { hasCards: false, idealScale: Infinity, maxSafeHeight: 0, containerH, availW, rootCount: 0 };
			}

			let totalSafeWidth = 0;
			let maxSafeHeight = 0;

			rootCards.forEach(root => {
				const b0 = measureCardGroupBounds(root, allCards, 0);
				const b90 = measureCardGroupBounds(root, allCards, 90);
				
				const safeW = Math.max(b0.width, b90.width);
				const safeH = Math.max(b0.height, b90.height);
				
				// [ä¿®æ­£ 2] ç´¯åŠ æ™‚ä¸åŒ…å«é–“è·ï¼Œåªè¨ˆç®—ç´”å…§å®¹å¯¬åº¦
				totalSafeWidth += safeW; 
				if (safeH > maxSafeHeight) maxSafeHeight = safeH;
			});

			const targetH = containerH * 0.9;
			const scaleByHeight = targetH / maxSafeHeight;
			const scaleByWidth = availW / totalSafeWidth; // [ä¿®æ­£ 2] åˆ†æ¯ä¸å«é–“è·ï¼Œå…è¨±å¡ç‰‡ç·Šè²¼ä»¥ç²å¾—æœ€å¤§å°ºå¯¸

			return { 
				hasCards: true, 
				idealScale: Math.min(scaleByHeight, scaleByWidth), 
				maxSafeHeight: maxSafeHeight, 
				containerH: containerH,
				availW: availW,
				totalBaseWidth: totalSafeWidth,
				rootCount: rootCards.length
			};
		});

		// 2. æ±ºå®šå…¨åŸŸ Scale (å–æœ€å°å€¼)
		const isMobile = document.body.classList.contains('mobile-mode');
		
		// [ä¿®æ­£ 1] æ”¾å¯¬æœ€å¤§ç¸®æ”¾é™åˆ¶ (2.2 -> 10.0)ï¼Œè§£æ±ºç€è¦½å™¨ç¸®æ”¾æ™‚å¡ç‰‡ç„¡æ³•æœ€å¤§åŒ–çš„å•é¡Œ
		const maxScaleLimit = isMobile ? 1.8 : 10.0; 
		const minScaleLimit = 0.3;

		const validScales = zoneCalculations.filter(res => res && res.hasCards).map(res => res.idealScale);
		let finalScale = (validScales.length > 0) ? Math.min(...validScales) : maxScaleLimit;

		if (finalScale > maxScaleLimit) finalScale = maxScaleLimit;
		if (finalScale < minScaleLimit) finalScale = minScaleLimit;

		// 3. å¥—ç”¨æ¨£å¼ (Padding èˆ‡ Margin)
		zones.forEach((zone, index) => {
			if (!zone.el) return;
			const calc = zoneCalculations[index];
			if (!calc) return;

			zone.el.style.setProperty('--bz-scale', finalScale);

			if (calc.hasCards) {
				// å‚ç›´ç½®ä¸­ Padding
				const visualHeight = calc.maxSafeHeight * finalScale;
				const paddingV = Math.max(0, (calc.containerH - visualHeight) / 2);
				zone.el.style.paddingTop = `${paddingV}px`;
				zone.el.style.paddingBottom = `${paddingV}px`;
				
				// [ä¿®æ­£ 2] é€™è£¡æ‰é–‹å§‹è¨ˆç®—é–“è· (å¾Œç®—)
				// å‰©é¤˜ç©ºé–“ = å®¹å™¨å¯¬åº¦ - (ç´”å…§å®¹å¯¬åº¦ * ç¸®æ”¾æ¯”ä¾‹)
				const occupiedW = calc.totalBaseWidth * finalScale;
				const remainingW = calc.availW - occupiedW;
				
				let gapPerCard = 0;
				if (calc.rootCount > 1) {
					// å°‡å‰©é¤˜ç©ºé–“åˆ†é…çµ¦é–“è· (å¦‚æœå¡ç‰‡æ˜¯å› é«˜åº¦å—é™ï¼Œå‰©é¤˜ç©ºé–“æœƒå¾ˆå¤§)
					const gapTotal = Math.max(0, remainingW);
					// åˆ†é…ç­–ç•¥ï¼šè®“å¡ç‰‡ä¹‹é–“æœ‰ç©ºéš™
					gapPerCard = gapTotal / (calc.rootCount + 1); 
					
					// è¨­å®šé–“è·ä¸Šé™ (ä¾‹å¦‚å¡ç‰‡å¯¬åº¦çš„ 25%)ï¼Œé¿å…å¡ç‰‡åˆ†å¤ªé–‹
					const maxGap = (60 * finalScale) * 0.25; 
					if (gapPerCard > maxGap) gapPerCard = maxGap;
				}

				const groupEls = Array.from(zone.el.querySelectorAll('.card-group'));
				groupEls.forEach((groupDiv) => {
					const baseW = parseFloat(groupDiv.dataset.baseW || 60);
					const visualW = baseW * finalScale;
					
					// Margin è¨ˆç®—å…¬å¼ï¼š
					// ç›®æ¨™ä½”ç”¨ç©ºé–“ = (è¦–è¦ºå¯¬åº¦ + åˆ†é…åˆ°çš„é–“è·)
					// å¯¦éš› DOM ä½”ç”¨ç©ºé–“ = (åŸºç¤å¯¬åº¦) [å› ç‚º scale ä¸å½±éŸ¿ flow]
					// ä¿®æ­£ Margin = ç›®æ¨™ - å¯¦éš›
					
					const neededTotalMargin = (visualW + gapPerCard) - baseW;
					const marginPerSide = neededTotalMargin / 2;
					
					groupDiv.style.marginLeft = `${marginPerSide}px`;
					groupDiv.style.marginRight = `${marginPerSide}px`;
				});
				
			} else {
				zone.el.style.paddingTop = '20px';
				zone.el.style.paddingBottom = '20px';
			}

			// è§£é–å‹•ç•«
			void zone.el.offsetWidth; 
			const groupEls = Array.from(zone.el.querySelectorAll('.card-group'));
			groupEls.forEach(el => el.classList.remove('initializing'));
		});
	}
	
	function expandStack(groupDiv, familyMembers) {
        // 1. æª¢æŸ¥ç„¡æœˆä¹‹é–€ç‹€æ…‹ (è‹¥æœ‰ç„¡æœˆå¡å‰‡ä¸å±•é–‹)
        const state = getCurrentDisplayState();
        if (state.moonless && familyMembers.some(c => state.moonless[c.id])) {
            return; 
        }

        // 2. å–å¾—è©²ç¾¤çµ„å…§æ‰€æœ‰å¡ç‰‡ DOM
        const cardEls = Array.from(groupDiv.querySelectorAll('.card'));
        if (cardEls.length <= 1) return;

        // 3. æ‰¾å‡ºã€Œè¦–è¦ºé ‚å±¤ã€å¡ç‰‡
        let topCardEl = null;
        let maxZ = -1;

        cardEls.forEach(el => {
            const z = parseInt(el.style.zIndex || el.dataset.zIndex || 0);
            if (z > maxZ) {
                maxZ = z;
                topCardEl = el;
            }
        });

        if (!topCardEl) return;

        // 4. å–å¾—é ‚å±¤å¡ç‰‡çš„è³‡æ–™èˆ‡ä½ç½® (ä½œç‚ºçµ•å°åŸºæº–é»)
        const topCardId = parseInt(topCardEl.dataset.id);
        const topCardData = familyMembers.find(c => c.id === topCardId);
        const rotation = topCardData ? topCardData.rotation : 0;
        
        // [é—œéµæ–°å¢] è®€å–é ‚å¡çš„åŸå§‹åº§æ¨™ï¼Œä½œç‚ºæ‰€æœ‰å­å¡çš„ã€Œæ­¸é›¶èµ·é»ã€
        const baseTop = parseFloat(topCardEl.dataset.orgTop);
        const baseLeft = parseFloat(topCardEl.dataset.orgLeft);

        // 5. è¨ˆç®—å±•é–‹å‘é‡ (é–“è· 35px)
        const gap = 35; 
        const vector = rotateVector(0, gap, rotation);

        // [é—œéµæ–°å¢] åˆ¤æ–·å±•é–‹çš„ä¸»è»¸æ–¹å‘
        // å¦‚æœ Y è»¸è®Šå‹•é‡å¤§æ–¼ X è»¸ï¼Œä»£è¡¨æ˜¯å‚ç›´å±•é–‹ (0åº¦/180åº¦)
        const isVerticalExpand = Math.abs(vector.y) > Math.abs(vector.x);

        // 6. åˆ†å±¤è™•ç† (Depth Calculation)
        const sortedEls = cardEls.sort((a, b) => {
            return parseInt(b.style.zIndex) - parseInt(a.style.zIndex);
        });

        const depthMap = {};
        let currentDepth = 0;

        sortedEls.forEach((el, index) => {
            const cardId = parseInt(el.dataset.id);
            const cardData = familyMembers.find(c => c.id === cardId);
            
            if (index === 0) {
                depthMap[cardId] = 0;
                return;
            }

            // åˆ¤æ–·æ˜¯å¦ç‚º Puzzle Link (å…„å¼Ÿå¡) - ä¿æŒ Depth 0
            let isTopSibling = false;
            if (cardData.parentId === topCardId && cardData.stackType && cardData.stackType.includes('puzzle')) {
                isTopSibling = true;
            }
            if (cardData.id === topCardId) isTopSibling = true;

            if (isTopSibling) {
                depthMap[cardId] = 0; 
            } else {
                currentDepth++;
                depthMap[cardId] = currentDepth; 
            }
        });
        
        // 7. å¥—ç”¨ã€Œå¼·åˆ¶å°é½Šã€ä½ç§»
        sortedEls.forEach(el => {
            const id = parseInt(el.dataset.id);
            const depth = depthMap[id] || 0; 
            
            if (depth > 0) {
                // [æ ¸å¿ƒé‚è¼¯ä¿®æ”¹]
                // ä¸ä½¿ç”¨ el.dataset.orgTop (å¡ç‰‡è‡ªå·±çš„åŸå§‹ä½ç½®)
                // è€Œæ˜¯ä½¿ç”¨ baseTop (é ‚å¡çš„åŸå§‹ä½ç½®) + å‘é‡åç§»
                
                // è¨ˆç®—ã€Œç†æƒ³ã€çš„çµ•å°ä½ç½®
                const idealTop = baseTop + (vector.y * depth);
                const idealLeft = baseLeft + (vector.x * depth);

                // [è»¸å‘åˆ†é›¢] 
                // ç‚ºäº†é¿å…æŠŠå·¦å³æ‹¼åœ– (Puzzle Link) å¼·åˆ¶æ‹‰å›ä¸­é–“ï¼Œæˆ‘å€‘åªè¦†å¯«ã€Œå±•é–‹è»¸å‘ã€çš„åº§æ¨™
                if (isVerticalExpand) {
                    // å‚ç›´å±•é–‹æ¨¡å¼ï¼š
                    // Top (Yè»¸): å¼·åˆ¶å°é½Šåˆ°ç†æƒ³ç¶²æ ¼ (baseTop + gap*depth)
                    // Left (Xè»¸): ä¿æŒå¡ç‰‡åŸæœ¬çš„ X åº§æ¨™ (ä¿ç•™å·¦å³æ‹¼åœ–çš„åç§»)
                    el.style.top = `${idealTop}px`;
                    el.style.left = `${el.dataset.orgLeft}px`; 
                } else {
                    // æ©«å‘å±•é–‹æ¨¡å¼ (90åº¦/270åº¦)ï¼š
                    // Left (Xè»¸): å¼·åˆ¶å°é½Šåˆ°ç†æƒ³ç¶²æ ¼
                    // Top (Yè»¸): ä¿æŒå¡ç‰‡åŸæœ¬çš„ Y åº§æ¨™
                    el.style.left = `${idealLeft}px`;
                    el.style.top = `${el.dataset.orgTop}px`;
                }
                
                // ä¿æŒåŸæœ‰çš„ Z-Index (ä¸è¦†è“‹)
            }
        });
    }

    function collapseStack(groupDiv) {
        // é‚„åŸæ‰€æœ‰å¡ç‰‡ä½ç½®
        const cardEls = groupDiv.querySelectorAll('.card');
        cardEls.forEach(el => {
            const orgTop = el.dataset.orgTop;
            const orgLeft = el.dataset.orgLeft;
            const orgZ = el.dataset.zIndex;
            
            if (orgTop && orgLeft) {
                el.style.top = `${orgTop}px`;
                el.style.left = `${orgLeft}px`;
                el.style.zIndex = orgZ;
            }
        });
    }
	
	// --- [ä¿®æ­£ç‰ˆ] åˆ‡æ›ç„¡æœˆä¹‹é–€ (Action ç‰ˆæœ¬) ---
    function toggleMoonless() {
        if (!pendingMove || pendingMove.cardIds.length !== 1) return;
        
        // ç™¼é€æ“ä½œæŒ‡ä»¤ (addOperation æœƒè‡ªå‹•è™•ç† state æ›´æ–°ã€å­˜æª”èˆ‡é‡ç¹ª)
        addOperation({ 
            type: 'TOGGLE_MOONLESS', 
            cardIds: [...pendingMove.cardIds] 
        });
    }
	
	// --- [æ–°å¢] EX-Life ç›¸é—œè®Šæ•¸ ---
	let isExLifeSelecting = false;
	let exLifeTargetId = null; // è­·ç›¾å€çš„é‚£å¼µç›®æ¨™å¡ (S)

	// 1. é€²å…¥ EX-Life é¸æ“‡æ¨¡å¼
	function enterExLifeMode() {
		if (!pendingMove || pendingMove.cardIds.length !== 1) return;
		
		exLifeTargetId = pendingMove.cardIds[0];
		const state = getCurrentDisplayState();
		const card = state.cards.find(c => c.id === exLifeTargetId);
		
		// é˜²å‘†ï¼šç¢ºèªç›®æ¨™æ˜¯åœ¨è­·ç›¾å€
		if (!card || !card.zone.includes('shield')) {
			alert("åªæœ‰ã€Œè­·ç›¾å€ã€çš„å¡ç‰‡å¯ä»¥ä½¿ç”¨ EX-Lifeã€‚");
			return;
		}

		// åˆ‡æ›ç‹€æ…‹
		isExLifeSelecting = true;
		
		// éš±è—æ“ä½œé¢æ¿ï¼Œé¡¯ç¤ºæç¤ºåˆ—
		document.getElementById('card-action-panel').style.display = 'none';
		
		// å€Ÿç”¨ Draft Bar æˆ– Point Bar ä¾†é¡¯ç¤ºæç¤º (é€™è£¡å€Ÿç”¨ Point Bar çš„æ¨£å¼)
		const pointBar = document.getElementById('point-bar');
		const info = document.getElementById('point-target-info');
		const btnConfirm = document.getElementById('btn-confirm-point');
		
		pointBar.style.display = 'flex';
		pointBar.querySelector('span').innerText = "ğŸ›¡ï¸ EX-Life æ¨¡å¼ï¼šè«‹é¸æ“‡ä¸€å¼µã€Œæˆ°é¬¥å€ã€çš„å¡ç‰‡ä½œç‚ºç´ æ (C)";
		info.innerText = "ç­‰å¾…é¸æ“‡...";
		btnConfirm.style.display = 'none'; // ä¸éœ€è¦ç¢ºèªæŒ‰éˆ•ï¼Œé»æ“Šå³è§¸ç™¼
		
		// é«˜äº®æˆ°é¬¥å€
		document.querySelectorAll('.battle-zone').forEach(el => el.classList.add('point-target-highlight'));
	}

	// 2. å–æ¶ˆ EX-Life æ¨¡å¼ (ç¶å®šåˆ°åŸæœ¬çš„ cancelPointMode æˆ– cancelSelection)
	// ä¿®æ”¹åŸæœ¬çš„ cancelPointModeï¼ŒåŠ å…¥ isExLifeSelecting = false;
	// æˆ–è€…æ–°å¢ä¸€å€‹å°ˆç”¨å–æ¶ˆå‡½å¼ (é€™è£¡ç‚ºäº†æ–¹ä¾¿æ•´åˆï¼Œæˆ‘å€‘åœ¨åŸæœ¬çš„ cancel é‚è¼¯ä¸­æ’å…¥åˆ¤æ–·)
	
	function checkMobileMusicButtonVisibility() {
		const btn = document.getElementById('mob-music-btn');
		if (!btn) return;

		// å–å¾—ç•¶å‰ç‹€æ…‹
		const state = getCurrentDisplayState();
		const currentBgm = state.bgm;

		// [ä¿®æ”¹éœ€æ±‚ 3] ç•¶ ActionLog è¨­å®šç‚ºç„¡éŸ³æ¨‚ (null/undefined) æ™‚ï¼Œéš±è—æŒ‰éˆ•
		if (currentBgm) {
			btn.style.display = 'flex'; // æœ‰éŸ³æ¨‚ï¼šé¡¯ç¤ºæŒ‰éˆ•
			updateMobileMusicUI(); // åŒæ­¥é¡¯ç¤ºéœéŸ³/æ’­æ”¾åœ–ç¤º
		} else {
			btn.style.display = 'none'; // ç„¡éŸ³æ¨‚ï¼šéš±è—æŒ‰éˆ•
			
			// [è£œå……] æ—¢ç„¶æ²’éŸ³æ¨‚ï¼Œç¢ºä¿æ’­æ”¾å™¨æ˜¯å®‰éœçš„
			if (!globalAudioPlayer.paused) {
				globalAudioPlayer.pause();
			}
		}
	}
	
	// --- [æ–°å¢] å †ç–Šåç§»é‡è¨ˆç®—ç³»çµ± ---

    // 1. å®šç¾©å„ç¨®å †ç–Šé¡å‹çš„ã€ŒåŸå§‹åç§»é‡ã€ (å‡è¨­å¡ç‰‡æ˜¯ç›´ç«‹ 0åº¦æ™‚çš„ç›¸å°ä½ç½®)
    // --- [æ•¸å­¸è¼”åŠ©] å‘é‡æ—‹è½‰èˆ‡åç§» ---

    // 1. å®šç¾©å„ç¨®å †ç–Šé¡å‹çš„ã€ŒåŸå§‹åç§»é‡ã€
    function getBaseStackOffset(type) {
        switch (type) {
            case 'top':           return { x: 0, y: 0 };
            case 'bottom':        return { x: 0, y: 0 };
            case 'shift_up':      return { x: 0, y: -25 };
            case 'shift_down':    return { x: 0, y: 25 };
            case 'bottom_exposed':return { x: 0, y: 20 };
            case 'puzzle_top':    return { x: 0, y: -70 };
            case 'puzzle_bottom': return { x: 0, y: 70 };
            case 'puzzle_left':   return { x: -50, y: 0 };
            case 'puzzle_right':  return { x: 50, y: 0 };
            default:              return { x: 0, y: 0 };
        }
    }

    // 2. å‘é‡æ—‹è½‰å…¬å¼
    function rotateVector(x, y, deg) {
        const rad = deg * (Math.PI / 180);
        const cos = Math.cos(rad);
        const sin = Math.sin(rad);
        return {
            x: x * cos - y * sin,
            y: x * sin + y * cos
        };
    }
	
	// --- [å…§éƒ¨æ³¨å…¥ç‰ˆ + Debug Log] ç‹ç‰Œç‰¹æ•ˆå‡½å¼ ---
	// ä¿®æ”¹ï¼šå¢åŠ  startDelay åƒæ•¸ï¼Œé è¨­ç‚º 400ms (ç›¸å®¹èˆŠå‘¼å«)ï¼Œä½†æˆ‘å€‘æœƒå‚³å…¥è¨ˆç®—å¾Œçš„ç²¾ç¢ºæ™‚é–“
	function triggerAceAnimation(cardId, startDelay = 400) {
		console.log(`%c[AceAnim] æ”¶åˆ°æŒ‡ä»¤: ID ${cardId} (æº–å‚™ç­‰å¾… ${startDelay/1000}s...)`, "color: orange");

		// ä½¿ç”¨å‚³å…¥çš„ startDelayï¼Œç¢ºä¿å¡ç‰‡å·²ç¶“é£›åˆ°ä½
		setTimeout(() => {
			// 1. æŠ“å–ç›®æ¨™å¡ç‰Œçš„ DOM
			const cardEl = document.querySelector(`.card[data-id="${cardId}"]`);
			
			if (!cardEl) {
				console.error(`[AceAnim] éŒ¯èª¤: æ‰¾ä¸åˆ° DOM å…ƒç´  (ID: ${cardId})`);
				return;
			}

			// 2. æº–å‚™é¡è‰²é‚è¼¯
			const state = getCurrentDisplayState();
			const cardData = state.cards.find(c => c.id === cardId);
			
			if (!cardData) {
				console.warn(`[AceAnim] è­¦å‘Š: ç‹€æ…‹ä¸­æ‰¾ä¸åˆ°å¡ç‰‡è³‡æ–™ (ID: ${cardId})`);
				return;
			}

			const colorMap = {
				'red': '255, 0, 0',
				'blue': '0, 191, 255',
				'green': '0, 255, 0',
				'yellow': '255, 215, 0',
				'white': '255, 255, 255',
				'black': '100, 100, 100',
				'rainbow': '255, 0, 255'
			};

			let finalColor = '255, 215, 0'; // é è¨­é‡‘è‰²
			let debugSource = "é è¨­ (é‡‘è‰²)"; // ç”¨æ–¼ Log ç´€éŒ„ä¾†æº

			// --- é¡è‰²åˆ¤å®šé‚è¼¯ ---
			let colorFoundFromProxy = false;
			
			// æª¢æŸ¥é€£çµçš„å°å¡ (Proxy)
			const proxyCards = state.cards.filter(c => c.zone.includes('ability') && c.sourceId == cardId);
			
			if (proxyCards.length > 0) {
				// ID è¶Šå¤§ä»£è¡¨è¶Šæ–°
				proxyCards.sort((a, b) => b.id - a.id);
				const activeProxy = proxyCards.find(c => c.glow && colorMap[c.glow]);
				
				if (activeProxy) {
					finalColor = colorMap[activeProxy.glow];
					colorFoundFromProxy = true;
					debugSource = `å°å¡ (ID:${activeProxy.id}, Glow:${activeProxy.glow})`;
				}
			}

			// æª¢æŸ¥æœ¬é«” (Self)
			if (!colorFoundFromProxy) {
				if (cardData.glow && colorMap[cardData.glow]) {
					finalColor = colorMap[cardData.glow];
					debugSource = `æœ¬é«” (Glow:${cardData.glow})`;
				}
			}
			
			console.log(`%c[AceAnim] åˆ¤å®šçµæœ -> ä¾†æº: ${debugSource} | RGB: ${finalColor}`, "color: #2ecc71; font-weight: bold;");
			// -----------------------------

			// 3. å…§éƒ¨æ³¨å…¥å…‰æšˆ
			cardEl.classList.add('animating-ace');

			const glowDiv = document.createElement('div');
			glowDiv.className = 'ace-internal-glow';
			glowDiv.style.setProperty('--ace-color', finalColor);

			cardEl.appendChild(glowDiv);

			// 4. è§¸ç™¼å…¨è¢å¹•ç™½å…‰
			setTimeout(() => {
				const flashLayer = document.getElementById('ace-flash-layer');
				if (flashLayer) {
					flashLayer.classList.remove('anim-flash-white');
					void flashLayer.offsetWidth; // Trigger reflow
					flashLayer.classList.add('anim-flash-white');
				}
			}, 300);

			// 5. æ¸…ç†å·¥ä½œ
			setTimeout(() => {
				if (glowDiv.parentNode) {
					glowDiv.parentNode.removeChild(glowDiv);
				}
				cardEl.classList.remove('animating-ace');
				console.log(`[AceAnim] å‹•ç•«çµæŸï¼Œæ¸…ç†å®Œæˆ (ID: ${cardId})`);
			}, 900); 

		}, startDelay); 
	}

    // --- [ä¿®æ­£ç‰ˆ] å»ºç«‹å¡ç‰‡ DOM å…ƒç´  ---
    function createCardElement(card) {
        // 1. åŸºç¤ Class è¨­å®š
        // å¦‚æœ faceUp ç‚º falseï¼Œå¼·åˆ¶åŠ ä¸Š face-down class (é¡¯ç¤ºå¡èƒŒæ¨£å¼)
        const el = document.createElement('div');
        el.className = `card ${card.faceUp ? '' : 'face-down'}`; 
        el.dataset.id = card.id; 

        // [æ–°å¢] æœªè¦‹å¡é«˜äº®é‚è¼¯
        if (isUnseenHighlightOn && !globalSeenCardIds.has(card.id)) {
            el.classList.add('glow-unseen');
        }

        // [æ–°å¢] å¤šé¸æ¨¡å¼æª¢æŸ¥
        if (isMultiSelectMode && multiSelectedIds.includes(card.id)) {
            el.classList.add('multi-selected');
        }
		
		// ç²å–å¡ç‰‡çš„åŸå§‹é‚è¼¯å¯¬é«˜ (é€™æ˜¯åœ¨æœªç¸®æ”¾ç•«å¸ƒä¸Šçš„å°ºå¯¸)
		const cardW = parseFloat(getComputedStyle(el).getPropertyValue('--card-width').trim()) || 60;
		const cardH = parseFloat(getComputedStyle(el).getPropertyValue('--card-height').trim()) || 84;
		
		let logicalX = 0;
		let logicalY = 0;

		// 1. è™•ç†å †ç–Šå¡ (Stacking Card - å¿…é ˆå¾ position å–å¾—é‚è¼¯åº§æ¨™)
		if (card.parentId || card.zone.includes('battle')) {
			// å°æ–¼ Battle Zone çš„å¡ï¼Œæˆ‘å€‘å¿…é ˆæå–å…¶çµ•å°å®šä½æˆ–ç›¸å°å®šä½çš„é‚è¼¯å€¼
			// ç”±æ–¼æ‚¨åœ¨ renderCardTree ä¸­ä½¿ç”¨äº† orgLeft/orgTop å„²å­˜äº†å¡ç‰‡ç›¸å°æ–¼å…¶çˆ¶å®¹å™¨çš„æœªç¸®æ”¾åº§æ¨™ï¼Œ
			// æˆ‘å€‘æ‡‰ä½¿ç”¨é€™äº›å€¼ï¼Œä¸¦å°‡å…¶è½‰æ›ç‚ºä¸­å¿ƒé»ã€‚
			
			// å¦‚æœæ˜¯å †ç–Šå¡ï¼Œç›´æ¥å¾ dataset è®€å– renderCardTree è³¦äºˆçš„ç›¸å°åº§æ¨™
			const orgLeft = parseFloat(el.dataset.orgLeft) || 0;
			const orgTop = parseFloat(el.dataset.orgTop) || 0;
			
			// é‚è¼¯ä¸­å¿ƒé» = é ‚é»åº§æ¨™ + é‚è¼¯å°ºå¯¸çš„ä¸€åŠ
			logicalX = orgLeft + (cardW / 2); 
			logicalY = orgTop + (cardH / 2); 
		} else {
			// å°æ–¼éæˆ°é¬¥å€çš„å¡ç‰‡ï¼Œæˆ‘å€‘æš«æ™‚ä¿æŒåŸä¾†çš„ DOM åº§æ¨™ç²å–æ–¹å¼
			// ç”±æ–¼æˆ‘å€‘åªé—œæ³¨æˆ°é¬¥å€ï¼Œé€™è£¡å¯ä»¥æš«æ™‚å¿½ç•¥ã€‚
			// ä½†å¦‚æœç›®æ¨™æ˜¯å€åŸŸï¼ˆZoneï¼‰ï¼ŒrenderArrows æœƒå¾ getBoundingClientRect ç²å–ã€‚
			
			// ç¢ºä¿éæˆ°å ´å¡ç‰‡çš„ä¸­å¿ƒé»åœ¨æœªä¾†ä¹Ÿèƒ½è¢«æ­£ç¢ºè¨ˆç®—ï¼ˆå¯é¸ï¼Œå› ç‚ºé€šå¸¸ä¸æŒ‡å‘éæˆ°å ´å–®å¡ï¼‰
			logicalX = 0; 
			logicalY = 0; 
		}

		// å°‡é‚è¼¯ä¸­å¿ƒé»å„²å­˜åˆ° datasetï¼Œé€™æ˜¯æœªç¸®æ”¾ç•«å¸ƒï¼ˆSVG åæ¨™ç³»ï¼‰çš„åº§æ¨™ï¼
		// æ³¨æ„ï¼šé€™è£¡å­˜çš„åº§æ¨™æ˜¯ç›¸å°æ–¼ card-group çˆ¶å…ƒç´ ï¼Œè€Œéæ•´å€‹ SVG ç•«å¸ƒï¼Œéœ€è¦åœ¨ renderArrows ä¸­æ ¡æ­£ã€‚
		// [å„ªåŒ–] ç”±æ–¼å¡ç‰‡åœ¨ Battle Zone ä¸­ï¼Œæˆ‘å€‘åªéœ€è¦çŸ¥é“å®ƒç›¸å°æ–¼å…¶ Group çš„é‚è¼¯ä¸­å¿ƒé»ã€‚
		el.dataset.logicCenterX = logicalX;
		el.dataset.logicCenterY = logicalY;

        // 2. æ’å…¥è¼”åŠ©æ¨™è¨˜ (å‹¾å‹¾ã€æ˜Ÿæ˜Ÿã€å—å‚·ã€EX-Life)
        
        // é¸å–å‹¾å‹¾
        const checkDiv = document.createElement('div');
        checkDiv.className = 'check-mark';
        checkDiv.innerText = 'âœ”';
        el.appendChild(checkDiv);

        // ç‹ç‰Œæ˜Ÿæ˜Ÿ
        if (globalAceRegistry[card.id]) {
            const star = document.createElement('div');
            star.className = 'ace-star-mark';
            star.innerText = 'â˜…';
            el.appendChild(star);
        }

        // å—å‚·çˆªç—•
        if (card.isInjured) {
            const clawDiv = document.createElement('div');
            const animClass = isDrafting ? '' : 'claw-anim';
            clawDiv.className = `claw-overlay ${animClass}`;
            clawDiv.innerHTML = `
                <svg class="claw-svg" viewBox="0 0 100 100">
                    <path class="claw-path p1" d="M20,20 Q50,50 80,80" />
                    <path class="claw-path p2" d="M30,10 Q60,40 90,70" />
                    <path class="claw-path p3" d="M10,30 Q40,60 70,90" />
                </svg>
            `;
            el.appendChild(clawDiv);
        }
        
        // ç™¼å…‰ç‰¹æ•ˆ
        // --- [ä¿®æ­£] Glow é‚è¼¯ (åŒ…å« Ability ç¹¼æ‰¿) ---
        let activeGlow = card.glow;
        
        // å¦‚æœé€™å¼µå¡ä¸æ˜¯ Ability å¡ï¼Œæª¢æŸ¥å®ƒæ˜¯å¦æœ‰æ­£åœ¨ç™¼å…‰çš„ Ability å­å¡
        if (!card.zone.includes('ability')) {
             // [ä¿®æ­£] å–å¾—ç•¶å‰ç‹€æ…‹
             // å› ç‚º createCardElement åœ¨å‡½å¼å¤–éƒ¨ï¼Œç„¡æ³•è®€å– 'state'ï¼Œæ‰€ä»¥è¦ç”¨ getCurrentDisplayState()
             const currentState = (typeof state !== 'undefined') ? state : getCurrentDisplayState();

             // [ä¿®æ­£] æ‰¾å‡ºæ‰€æœ‰æŒ‡èªé€™å¼µå¡ç‚º Source çš„ Ability å¡
             // æ³¨æ„ï¼šæ”¹ç‚ºä½¿ç”¨ currentState
             const abilityChildren = currentState.cards.filter(c => c.sourceId === card.id && c.zone.includes('ability'));
             
             // å¦‚æœæœ‰ä»»ä½•å­å¡ç™¼å…‰ï¼Œç¹¼æ‰¿å…¶å…‰æšˆ
             const glowingChild = abilityChildren.find(c => c.glow);
             if (glowingChild) activeGlow = glowingChild.glow;
        }

        if (activeGlow) el.classList.add(`glow-${activeGlow}`);
        if (card.isContinuous) el.classList.add('continuous');

        // 3. [é—œéµä¿®æ”¹] åœ–ç‰‡é¡¯ç¤ºé‚è¼¯
        // åªæœ‰åœ¨ (è¡¨å´) æˆ– (æ˜¯è¶…æ¬¡å…ƒå¡) æ™‚æ‰å˜—è©¦é¡¯ç¤ºåœ–ç‰‡
        // å¦‚æœæ˜¯é€²åŒ–å…ƒä¸”ç‚ºè“‹ç‰Œç‹€æ…‹ (faceUp=false)ï¼Œé€™è£¡æœƒç‚º falseï¼Œå› æ­¤é¡¯ç¤ºå¡èƒŒ
        if (card.image && (card.faceUp || card.isHyper)) {
            const imageSrc = globalImageRegistry[card.imageKey];
            if (imageSrc) {
                el.style.backgroundImage = `url(${imageSrc})`;
                el.classList.add('has-image');
                
                // é‡å° Ability å€çš„ç‰¹æ®Šè£åˆ‡è™•ç†
                if (card.zone.includes('ability')) {
                    const lookupKey = card.styleKey || card.imageKey;
                    const style = globalAbilityStyleRegistry ? (globalAbilityStyleRegistry[lookupKey] || { x: 50, y: 50, scale: 1 }) : { x: 50, y: 50, scale: 1 };
                    el.style.backgroundPosition = `${style.x}% ${style.y}%`;
                    el.style.backgroundSize = `${100 * style.scale}%`;
                } else {
                     el.style.backgroundSize = 'cover';
                     el.style.backgroundPosition = 'center';
                     el.style.backgroundRepeat = 'no-repeat';
                }
            }
        } else if (!card.faceUp) {
            // [ä¿éšª] å¦‚æœæ˜¯è£¡å´è¡¨ç¤ºï¼Œä¸”æ²’æœ‰åœ–ç‰‡ (æˆ–ä¸è©²é¡¯ç¤ºåœ–ç‰‡)ï¼Œç¢ºä¿å®ƒæ˜¯å¡èƒŒæ¨£å¼
            // é€™è£¡å¯ä»¥æ“´å……ï¼šå¦‚æœæœ‰è‡ªè¨‚å¡èƒŒåœ– (Sleeve)ï¼Œå¯ä»¥åœ¨é€™è£¡è®€å– globalImageRegistry çš„å¡èƒŒ Key
            // ç›®å‰ç¶­æŒé è¨­ CSS æ¨£å¼ (radial-gradient)
        }

        // 4. [æ¨£å¼ä¿®æ­£] èƒ½åŠ›å¡æ¨£å¼
        if (card.zone.includes('ability')) {
            el.classList.add('ability-card');
            if (!card.faceUp) el.className = `card ability-card`; // å¼·åˆ¶é‡ç½® class é¿å…å¹²æ“¾
        } else {
            // ä¸€èˆ¬å¡ç‰‡æ—‹è½‰ (æ’é™¤ Puzzle æ‹¼åœ–å¡ï¼Œå› ç‚ºæ‹¼åœ–å¡ä½ç½®ç”± parent æ±ºå®š)
            if (!card.stackType || !card.stackType.includes('puzzle')) {
                el.style.transform = `rotate(${card.rotation}deg)`;
            }
        }
        
        // é¸å–æ™‚çš„æµ®èµ·æ•ˆæœ
        if (pendingMove && pendingMove.cardIds.includes(card.id)) {
            el.classList.add('selected');
            if (!card.zone.includes('ability') && el.classList.contains('selected')) {
               if (!card.stackType || !card.stackType.includes('puzzle')) {
                   el.style.transform = `rotate(${card.rotation}deg) translateY(-5px)`;
               }
            }
        }
        
        // æŒ‡å‘é«˜äº®
        if (isPointing && pointTargets.includes(card.id)) {
            el.classList.add('point-target-selected');
        }
        
        // è¨»è¨˜ (Note)
        if (card.note) {
            const noteEl = document.createElement('div');
            noteEl.className = 'card-note';
            noteEl.innerText = card.note;
            el.appendChild(noteEl);
        }

        // 5. [é—œéµä¿®æ”¹] æ–‡å­—å…§å®¹é¡¯ç¤ºé‚è¼¯
        // åªæœ‰åœ¨ (è¡¨å´) æˆ– (èƒ½åŠ›å€) æ™‚æ‰é¡¯ç¤ºæ–‡å­—
        // é€™æ¨£è“‹ç‰Œçš„é€²åŒ–å…ƒå°±ä¸æœƒé€å‡ºæ–‡å­—
        if (card.faceUp || card.zone.includes('ability')) {
            const contentDiv = document.createElement('div');
            contentDiv.style.marginTop = card.note ? '10px' : '0';
            contentDiv.innerHTML = `<div class="card-text">${card.text}</div>`;
            if (card.power > 0) contentDiv.innerHTML += `<div class="card-power">${card.power}</div>`;
            el.appendChild(contentDiv);
        }
        
        // é•·æŒ‰äº‹ä»¶ (æ‰‹æ©Ÿç‰ˆå¤šé¸ç”¨)
        let pressTimer = null;
        const startPress = (e) => {
            if (e.button !== 0) return;
            if (isMultiSelectMode) return;
            pressTimer = setTimeout(() => {
                enterMultiSelectModeByCard(card.id);
                if (navigator.vibrate) navigator.vibrate(50);
            }, 200);
        };
        const cancelPress = () => { if (pressTimer) clearTimeout(pressTimer); };

        el.onpointerdown = startPress;
        el.onpointerup = cancelPress;
        el.onpointerleave = cancelPress;
        el.onpointercancel = cancelPress;

        // é»æ“Šäº‹ä»¶ç¶å®š
        const isViewerZone = card.zone.includes('deck') || card.zone.includes('grave') || card.zone.includes('hyper') || card.zone.includes('abyss');;
        if (card.zone.includes('ability') || !isViewerZone) {
             el.onclick = (e) => handleCardSingleClick(e, card.id);
             if (card.zone.includes('ability')) {
                 el.oncontextmenu = (e) => { e.preventDefault(); handleCardSingleClick(e, card.id); };
             }
        } else {
             el.onclick = (e) => { e.stopPropagation(); handleZoneClick(card.zone); };
        }
        
        // EX-Life è¦†è“‹å±¤
        if (card.exLifeKey) {
			const imgSrc = globalImageRegistry[card.exLifeKey];
			if (imgSrc) {
				const overlay = document.createElement('div');
				overlay.className = 'ex-life-overlay';
				
				// ç›´æ¥å¼•ç”¨åŸå§‹åœ–ç‰‡
				overlay.style.backgroundImage = `url(${imgSrc})`;
				
				// åƒè€ƒæ•ˆæœå°å¡çš„å‘ˆç¾é‚è¼¯ï¼š
				// å›ºå®šé¡¯ç¤ºä¸­å¿ƒ (50% 50%)ï¼Œç¸®æ”¾å€ç‡ç¶­æŒ 1.0 (æˆ–ä¾éœ€æ±‚å¾®èª¿)
				// ä¸éœ€è¦ UI èª¿æ•´ï¼Œç›´æ¥å¯«æ­»åŸå§‹æ“·å–ä½ç½®
				overlay.style.backgroundPosition = 'center';
				overlay.style.backgroundSize = '120%'; // ç¨å¾®æ”¾å¤§ä»¥ç¬¦åˆæ“·å–æ„Ÿ
				overlay.style.backgroundRepeat = 'no-repeat';

				const closeBtn = document.createElement('div');
				closeBtn.className = 'ex-life-close';
				closeBtn.innerText = 'âœ•';
				closeBtn.title = 'ç§»é™¤ EX-Life';
				closeBtn.onclick = (e) => {
					e.stopPropagation();
					removeExLife(card.id);
				};
				overlay.appendChild(closeBtn);
				el.appendChild(overlay);
			}
		}
        
        setTimeout(() => el.classList.add('interactive'), 0);
        return el;
    }
	
	// [ä¿®æ­£] é€éé•·æŒ‰å¡ç‰‡é€²å…¥å¤šé¸æ¨¡å¼
    function enterMultiSelectModeByCard(cardId) {
        if (isMultiSelectMode) return;
        
        // åˆ‡æ›æ¨¡å¼æ¨™è¨˜
        isMultiSelectMode = true;
        multiSelectedIds = [cardId];
        
        // è¨­å®š pendingMove
        pendingMove = { cardIds: [...multiSelectedIds], shuffle: false };
        
        // æ›´æ–° UI
        const el = document.querySelector(`.card[data-id="${cardId}"]`);
        if (el) el.classList.add('multi-selected');
        
        updateSelectionUI();

        // --- [æ–°å¢] é˜²å‘†é‚è¼¯ ---
        // è¨˜éŒ„é€™å¼µå¡ç‰‡çš„ IDï¼Œå‘Šè¨´ handleCardSingleClick å¿½ç•¥å®ƒæ¥ä¸‹ä¾†çš„ã€Œæ”¾é–‹ã€é»æ“Šäº‹ä»¶
        ignoreClickId = cardId;
        
        // è¨­å®š 2 ç§’å¾Œè‡ªå‹•æ¸…é™¤ (ä»¥é˜²ä½¿ç”¨è€…é•·æŒ‰å¾Œä¸€ç›´ä¸æ”¾é–‹ï¼Œæˆ–æ‹–æ›³åˆ°åˆ¥è™•æ²’è§¸ç™¼é»æ“Š)
        setTimeout(() => {
            if (ignoreClickId === cardId) ignoreClickId = null;
        }, 2000);
    }

    // --- [ä¿®æ”¹] é»æ“Šå¡ç‰‡è™•ç† ---
	// --- [ä¿®æ­£] é»æ“Šå¡ç‰‡è™•ç† (æ•ˆæœå¡å¼·åˆ¶å–®é¸) ---
	function handleCardSingleClick(e, cardId) {
		e.stopPropagation(); 
		
		// --- [æ–°å¢] EX-Life é¸æ“‡æ””æˆª ---
		if (isExLifeSelecting) {
			processExLifeSelection(cardId);
			return;
		}
		// ----------------------------
		
		// --- [æ–°å¢] æª¢æŸ¥æ˜¯å¦éœ€è¦å¿½ç•¥æ­¤é»æ“Š (ä¾†è‡ªé•·æŒ‰è§¸ç™¼) ---
        if (ignoreClickId === cardId) {
            ignoreClickId = null; // æ¶ˆè€—æ‰é€™æ¬¡é˜²å‘†ï¼Œä¸‹æ¬¡é»æ“Šæ¢å¾©æ­£å¸¸
            return; // ç›´æ¥çµæŸï¼Œä¸åŸ·è¡Œé¸å–/å–æ¶ˆé‚è¼¯
        }

		// 1. æ‰‹æ©Ÿç‰ˆé»æ“Šæª¢è¦–é‚è¼¯ (ç¶­æŒä¸è®Š)
		if (document.body.classList.contains('mobile-mode')) {
			const state = getCurrentDisplayState();
			const card = state.cards.find(c => c.id === cardId);
			if (!card) return;
			const ignoredZones = [
				'p1-deck', 'p2-deck', 
				'p1-grave', 'p2-grave', 
				'p1-hyper', 'p2-hyper',
				'p1-abyss', 'p2-abyss'
			];
			const isIgnored = ignoredZones.includes(card.zone) || card.zone.includes('ability');
			if (card.image && card.faceUp && !isIgnored) {
				showMobileCardZoom(card.id);
			}
			return; 
		}
		
		// 2. å¤šé¸æ¨¡å¼ (ç¶­æŒä¸è®Š - åœ¨æ­¤æ¨¡å¼ä¸‹ä¾ç„¶å…è¨±é¸å¤šå¼µæ•ˆæœå¡ï¼Œæ–¹ä¾¿æ‰¹æ¬¡åˆªé™¤)
		if (isMultiSelectMode) {
			const index = multiSelectedIds.indexOf(cardId);
			const el = document.querySelector(`.card[data-id="${cardId}"]`);
			
			if (index > -1) {
				multiSelectedIds.splice(index, 1);
				if (el) el.classList.remove('multi-selected');
				if (multiSelectedIds.length === 0) {
					cancelSelection(); 
					return;
				}
			} else {
				multiSelectedIds.push(cardId);
				if (el) el.classList.add('multi-selected');
			}
			pendingMove = { cardIds: [...multiSelectedIds], shuffle: false };
			updateSelectionUI();
			return;
		}

		// 3. æŒ‡å‘æ¨¡å¼ (ç¶­æŒä¸è®Š)
		if (isPointing) {
			handlePointClick(null, cardId);
			return;
		}

		// 4. ä¸€èˆ¬é»æ“Šé‚è¼¯
		if (pendingMove) {
            // å¦‚æœé»æ“Šçš„æ˜¯ã€Œå·²ç¶“è¢«é¸å–ã€çš„å¡ç‰‡ -> å–æ¶ˆé¸å–è©²å¼µ
			if (pendingMove.cardIds.includes(cardId)) {
				 pendingMove.cardIds = pendingMove.cardIds.filter(id => id !== cardId);
				 if (pendingMove.cardIds.length === 0) {
					 cancelSelection();
					 return;
				 }
				 updateSelectionUI();
				 return;
			}
			
			const state = getCurrentDisplayState();
			const targetCard = state.cards.find(c => c.id === cardId);
			
            // å †ç–Šæ“ä½œé‚è¼¯ (ç¶­æŒä¸è®Š - æ’é™¤èƒ½åŠ›å¡ã€ç‰Œåº«ç­‰)
			if (targetCard && !targetCard.zone.includes('deck') && !targetCard.zone.includes('grave') && !targetCard.zone.includes('ability')) {
				openStackingModal(targetCard);
				return;
			}

            // --- [é—œéµä¿®æ”¹] åˆ¤æ–·æ˜¯å¦ç‚ºæ•ˆæœå°å¡ ---
            if (targetCard && targetCard.zone.includes('ability')) {
                // å¦‚æœé»æ“Šçš„æ˜¯æ•ˆæœå°å¡ï¼Œå¼·åˆ¶è®Šæˆã€Œå–®é¸æ–°å¡ç‰‡ã€
                // (æ¨æ£„åŸæœ¬å·²ç¶“é¸å–çš„å¡ç‰‡ï¼Œç›´æ¥åˆ‡æ›ç„¦é»åˆ°é€™å¼µæ–°å¡)
                pendingMove = { cardIds: [cardId], shuffle: false };
            } else {
                // å¦‚æœæ˜¯æ™®é€šå¡ç‰‡ï¼Œç¶­æŒåŸæœ¬çš„ã€ŒåŠ é¸ã€è¡Œç‚º
                pendingMove.cardIds.push(cardId);
            }
            // ------------------------------------
		} else {
            // å¦‚æœæ²’æœ‰é¸å–ä»»ä½•å¡ç‰‡ï¼Œå»ºç«‹æ–°é¸å–
			pendingMove = { cardIds: [cardId], shuffle: false };
		}
        
		updateSelectionUI();
	}
	
	// --- [æ–°å¢] æˆªæ–·æ™‚é–“è»¸ (åˆªé™¤å¾ŒçºŒæ‰€æœ‰å‹•ä½œ) ---
	function truncateTimeline(index) {
		// 1. ç¬¬ä¸€é“é˜²ç·šï¼šç¢ºèªæ˜¯å¦çœŸçš„è¦åˆªé™¤
		const confirmMsg = t('msg_truncate_confirm').replace('{n}', index);
		if (!confirm(confirmMsg)) return;

		// 2. ç¬¬äºŒé“é˜²ç·šï¼šè©¢å•æ˜¯å¦å‚™ä»½
		// æ ¹æ“šéœ€æ±‚ï¼š"é€™å€‹å‹•ä½œæœƒåˆªé™¤å¤§é‡è³‡æ–™ï¼Œæ˜¯å¦è¦å…ˆåŒ¯å‡ºå‚™ä»½"
		const wantBackup = confirm(t('msg_truncate_backup'));
		
		if (wantBackup) {
			exportData();
		}

		// 3. åŸ·è¡Œåˆªé™¤å‰çš„æº–å‚™
		takeGlobalSnapshot(); // [é—œéµ] å­˜å…¥ Undo Stackï¼Œè®“ Ctrl+Z å¯ä»¥æ•‘å›

		// 4. åŸ·è¡Œæˆªæ–·é‚è¼¯
		// index ä»£è¡¨ Gap çš„ä½ç½®ã€‚
		// Gap 0 åœ¨ Step 0 ä¹‹å‰ã€‚ Gap 5 åœ¨ Step 4 èˆ‡ 5 ä¹‹é–“ã€‚
		// å¦‚æœæŒ‰äº† index=5 çš„ Gap æ¸›è™Ÿï¼Œä»£è¡¨è¦ä¿ç•™ 0~4 (å‰5æ­¥)ï¼Œåˆªé™¤ 5 ä¹‹å¾Œçš„ã€‚
		// Array.slice(0, index) æ­£å¥½ç¬¦åˆé€™å€‹é‚è¼¯ã€‚
		
		const head = history.slice(0, index);
		
		// å¦‚æœå…¨éƒ¨åˆªå…‰å…‰ (index=0)ï¼Œéœ€è¦é‡æ–°åˆå§‹åŒ–
		if (head.length === 0) {
			alert(t('msg_cannot_del_init')); // å€Ÿç”¨åŸæœ¬çš„è¨Šæ¯ï¼Œç¦æ­¢åˆªé™¤åˆå§‹ç‹€æ…‹
			return;
		}

		// æ›´æ–°æ­·å²ç´€éŒ„
		history = head;

		// ä¿®æ­£ç›®å‰çš„æŒ‡æ¨™
		currentIndex = history.length - 1;
		
		// æ¸…é™¤é¸å–ç‹€æ…‹
		cancelSelection();
		
		// 5. æ›´æ–°ä»‹é¢èˆ‡å­˜æª”
		renderUI(true);
		saveToStorage();
		
		// æç¤ºè¨Šæ¯
		const hint = document.getElementById('draft-mode-hint');
		if(hint) {
			hint.innerText = "âœ‚ï¸ å·²æˆªæ–·æ™‚é–“è»¸ (Ctrl+Z å¯å¾©åŸ)";
			hint.style.opacity = 1;
		}
	}
	
	function processExLifeSelection(materialCardId) {
		const state = getCurrentDisplayState();
		const materialCard = state.cards.find(c => c.id === materialCardId);
		
		if (!materialCard || !materialCard.imageKey) return;

		// ç›´æ¥å°‡ç´ æçš„ imageKey å­˜å…¥ç›®æ¨™è­·ç›¾çš„ exLifeKey
		addOperation({
			type: 'SET_EX_LIFE',
			targetId: exLifeTargetId,
			imgKey: materialCard.imageKey // ä¸å†å‚³å…¥æ–°çš„ canvas åœ–ç‰‡ï¼Œè€Œæ˜¯åŸå§‹å¼•ç”¨
		});

		cancelPointMode(); // çµæŸé¸æ“‡æ¨¡å¼
	}

	// 4. ç§»é™¤ EX-Life
	function removeExLife(cardId) {
		if (confirm("ç§»é™¤ EX-Life è­·ç›¾æ•ˆæœï¼Ÿ")) {
			addOperation({
				type: 'REMOVE_EX_LIFE',
				targetId: cardId
			});
		}
	}

	// --- [æ–°å¢] æ‰‹æ©Ÿç‰ˆæ”¾å¤§å¡åœ–å‡½å¼ ---
	function showMobileCardZoom(cardId) {
		const state = getCurrentDisplayState();
		const card = state.cards.find(c => c.id === cardId);
		
		// å–å¾—åœ–ç‰‡ (å„ªå…ˆæ‰¾æ­£é¢åœ–)
		const imgKey = card.imageKey;
		const src = globalImageRegistry[imgKey];
		
		if (!src) return; // æ²’åœ–å°±ä¸å‹•ä½œ

		// 1. åŸ·è¡Œã€Œè¦–è¦ºæš«åœã€ (ä½†ä¸é—œéŸ³æ¨‚)
		if (playTimeout) {
			clearTimeout(playTimeout);
			playTimeout = null;
			updatePlayButtonUI(); // æ›´æ–°æŒ‰éˆ•ç‚ºã€Œæš«åœã€åœ–ç¤º
			// æ³¨æ„ï¼šé€™è£¡æ•…æ„ä¸å‘¼å« globalAudioPlayer.pause()ï¼Œä»¥é”æˆèƒŒæ™¯éŸ³æ¨‚ç¹¼çºŒçš„éœ€æ±‚
		}

		// 2. é¡¯ç¤ºæ”¾å¤§è¦–çª—
		const viewer = document.getElementById('mobile-card-viewer');
		viewer.innerHTML = `<img src="${src}" />`;
		viewer.style.display = 'flex';
	}
	
	// --- [ä¿®æ”¹] æ‰‹æ©Ÿç‰ˆï¼šæˆ°é¬¥å€é€²å ´å¡ç‰‡ä¾åºç‰¹å¯« (å«éæ¿¾é‚è¼¯) ---
	function runMobileBattleZoomSequence(cardIds, onComplete) {
		const viewer = document.getElementById('mobile-card-viewer');
		const state = getCurrentDisplayState();
		
		// [æ ¸å¿ƒä¿®æ”¹] éæ¿¾é‚è¼¯æ›´æ–°
		const validCards = cardIds.map(id => state.cards.find(c => c.id == id)).filter(c => {
            // 1. åŸºç¤æª¢æŸ¥ï¼šå¡ç‰‡å­˜åœ¨ä¸”æœ‰åœ–ç‰‡
            if (!c || !c.imageKey) return false;

            // 2. æ¢ä»¶ Aï¼šå¿…é ˆæ˜¯è¡¨å´ (Face Up)
            if (!c.faceUp) return false;

            // 3. æ¢ä»¶ Bï¼šä¸èƒ½æ˜¯ç–Šåœ¨ä¸‹æ–¹çš„ç‰Œ
            // æª¢æŸ¥ stackTypeï¼Œå¦‚æœæ˜¯ bottom æˆ– bottom_exposed ä»£è¡¨å®ƒæ˜¯é€²åŒ–å…ƒæˆ–è¢«è¦†è“‹çš„ç‰Œ
            if (c.stackType === 'bottom' || c.stackType === 'bottom_exposed') return false;

            return true;
        });
		
		if (validCards.length === 0) {
			if (onComplete) onComplete();
			return;
		}

		let idx = 0;

		function showNext() {
			if (idx >= validCards.length) {
				// å…¨éƒ¨æ’­å®Œï¼Œéš±è—è¦–çª—ä¸¦åŸ·è¡Œå›å‘¼
				viewer.style.display = 'none';
				if (onComplete) onComplete();
				return;
			}

			const card = validCards[idx];
			const src = globalImageRegistry[card.imageKey];
			if (src) {
				viewer.innerHTML = `<img src="${src}" style="border: 4px solid #f1c40f; box-shadow: 0 0 30px rgba(0,0,0,0.8);" />`;
				viewer.style.display = 'flex';
			}

			idx++;
			// åœç•™ 1 ç§’å¾Œæ’­ä¸‹ä¸€å¼µ
			setTimeout(showNext, 1000);
		}

		showNext();
	}

	function hideMobileCardZoom() {
		// 1. é—œé–‰è¦–çª—
		document.getElementById('mobile-card-viewer').style.display = 'none';
		
		// 2. æ¢å¾©æ’­æ”¾ (è¦–ç‚ºæŒ‰ä¸‹ Play éµ)
		togglePlay();
	}
    
    // [ä¿®æ”¹] å–æ¶ˆé¸å– (ç¢ºä¿ä¹Ÿæœƒé—œé–‰å¤šé¸æ¨¡å¼)
    function cancelSelection() {
        // é‡ç½®å¤šé¸ç›¸é—œè®Šæ•¸
        isMultiSelectMode = false;
        multiSelectedIds = [];
        document.querySelectorAll('.multi-selected').forEach(el => el.classList.remove('multi-selected'));
        
        if (pendingMove) {
            // ... (åŸæœ¬çš„å–æ¶ˆé‚è¼¯) ...
            pendingMove = null;
            document.querySelectorAll('.zone').forEach(el => el.classList.remove('target-highlight'));
            document.querySelectorAll('.card.selected').forEach(el => el.classList.remove('selected'));
            document.getElementById('card-action-panel').style.display = 'none';
        }
        
        // éš±è—å¤šé¸æç¤ºåˆ—
        const multiBar = document.getElementById('multi-select-bar');
        if(multiBar) multiBar.style.display = 'none';
    }

    function renderArrows() {
		// ä½¿ç”¨ requestAnimationFrame ç¢ºä¿åœ¨ CSS transform (ç¸®æ”¾) å¥—ç”¨å¾Œæ‰è¨ˆç®—åº§æ¨™
		requestAnimationFrame(() => {
			const svg = document.getElementById('svg-layer');
			const workspace = document.getElementById('workspace');
			
			// 1. æ¸…ç©º SVG
			svg.innerHTML = `
				<defs>
					<marker id="arrowhead" markerWidth="12" markerHeight="12" refX="10" refY="6" orient="auto" markerUnits="userSpaceOnUse">
						<path d="M0,0 L12,6 L0,12" fill="#e74c3c" />
					</marker>
				</defs>
			`;
			
			let ops = [];
			if (isDrafting) {
				ops = draftOperations;
			} else if (currentIndex >= 0 && history[currentIndex]) {
				ops = history[currentIndex].action.operations;
			}

			if (!ops || ops.length === 0) return;

			// --- [æ ¸å¿ƒåº§æ¨™è¨ˆç®—ä¿®æ­£] ---
			
			const wsRect = workspace.getBoundingClientRect();
			
			// [é—œéµ] è¨ˆç®— Workspace æœ¬èº«çš„å…¨åŸŸç¸®æ”¾å› å­ (Global Scale)
			// offsetWidth æ˜¯å…ƒç´ å…§éƒ¨çš„ CSS å¯¬åº¦ (ä¾‹å¦‚ 1600px)
			// wsRect.width æ˜¯å…ƒç´ åœ¨è¢å¹•ä¸Šå¯¦éš›é¡¯ç¤ºçš„å¯¬åº¦ (ä¾‹å¦‚æ‰‹æ©Ÿä¸Šå¯èƒ½ç¸®å°æˆ 800px)
			// æ¯”ä¾‹ = è¢å¹•å¯¬ / CSSå¯¬
			const globalScaleX = wsRect.width / workspace.offsetWidth;
			const globalScaleY = wsRect.height / workspace.offsetHeight;

			// è¼”åŠ©å‡½å¼ï¼šå–å¾—å…ƒç´ åœ¨ã€ŒSVG åº§æ¨™ç³»ã€ä¸­çš„æº–ç¢ºä¸­å¿ƒé»
			// æ­¤æ–¹æ³•å¯ä»¥å®Œç¾ç›¸å®¹ CSS transform: scale() é€ æˆçš„ä½ç§»
			const getSvgCenterPoint = (el) => {
				// 1. ç²å–å…ƒç´ çš„è¢å¹•çµ•å°ä½ç½® (BoundingBox åŒ…å«ç¸®æ”¾å¾Œçš„çµæœ)
				const rect = el.getBoundingClientRect();
				
				// 2. è¨ˆç®—è©²å…ƒç´ åœ¨ã€Œè¢å¹•ä¸Šã€çš„è¦–è¦ºä¸­å¿ƒé»
				const screenCenterX = rect.left + rect.width / 2;
				const screenCenterY = rect.top + rect.height / 2;
				
				// 3. å°‡ã€Œè¢å¹•åº§æ¨™ã€è½‰æ›ç‚ºã€ŒWorkspace å…§éƒ¨åº§æ¨™ (SVGåº§æ¨™)ã€
				// å…¬å¼ï¼š(è¢å¹•çµ•å°åº§æ¨™ - Workspaceè¢å¹•èµ·é») / ç¸®æ”¾å› å­
				const svgX = (screenCenterX - wsRect.left) / globalScaleX;
				const svgY = (screenCenterY - wsRect.top) / globalScaleY;

				return { x: svgX, y: svgY };
			};

			// --- åŸ·è¡Œç¹ªåœ– ---
			const pointOps = ops.filter(o => o.type === 'POINT' || o.type === 'ATTACK'); 
			
			pointOps.forEach(op => {
				const attacker = document.querySelector(`.card[data-id="${op.attackerId}"]`);
				if (!attacker) return;
				
				const startPoint = getSvgCenterPoint(attacker);
				if (!startPoint) return;
				
				let targetEls = [];
				// ç›®æ¨™é¸å–é‚è¼¯ (ä¿æŒä¸è®Š)
				if (op.targetType === 'CARD' || op.type === 'CREATURE' || op.type === 'SHIELD') {
					if (Array.isArray(op.targetIds)) {
						op.targetIds.forEach(tid => {
							const el = document.querySelector(`.card[data-id="${tid}"]`);
							if(el) targetEls.push(el);
						});
					}
				} else if (op.targetType === 'ZONE') {
					if (Array.isArray(op.targetIds)) {
						op.targetIds.forEach(zid => {
							const el = document.querySelector(`.zone[data-zone="${zid}"]`);
							if(el) targetEls.push(el);
						});
					}
				} else if (op.targetType === 'PLAYER') {
					const attackerOwner = attacker.closest('.player-area').id.includes('player1') ? 1 : 2;
					const oppId = attackerOwner === 1 ? 2 : 1;
					const deck = document.querySelector(`.deck-zone[data-zone="p${oppId}-deck"]`);
					if(deck) targetEls.push(deck);
				}

				targetEls.forEach(target => {
					const endPoint = getSvgCenterPoint(target);
					if (!endPoint) return; 

					const isSelf = (target === attacker);
					
					if (isSelf) {
						const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
						const r = 40; 
						const d = `M ${startPoint.x},${startPoint.y} C ${startPoint.x+r*2},${startPoint.y-r*2} ${startPoint.x-r*2},${startPoint.y-r*2} ${startPoint.x},${startPoint.y}`;
						path.setAttribute("d", d);
						path.setAttribute("class", "arrow-line");
						path.setAttribute("fill", "none");
						svg.appendChild(path);
					} else {
						const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
						line.setAttribute("x1", startPoint.x);
						line.setAttribute("y1", startPoint.y);
						line.setAttribute("x2", endPoint.x);
						line.setAttribute("y2", endPoint.y);
						line.setAttribute("class", "arrow-line");
						svg.appendChild(line);
					}
				});
			});
		}); // End requestAnimationFrame
	}

    function renderTimeline() {
		// ã€å„ªåŒ– 1ã€‘æ’­æ”¾æ¨¡å¼ä¸‹ä¸é€²è¡Œè™•ç† (å› ç‚ºè§€çœ¾çœ‹ä¸åˆ°ï¼Œä¸”å¤§é‡ DOM æ“ä½œæœƒæ‹–æ…¢å‹•ç•«)
		if (document.body.classList.contains('desktop-playing') || 
			document.body.classList.contains('mobile-mode')) {
			return;
		}

		// æ ¹æ“šç·¨è¼¯ç‹€æ…‹åˆ‡æ› body çš„ class
		if (isDrafting) document.body.classList.add('in-edit-mode');
		else document.body.classList.remove('in-edit-mode');

		const list = document.getElementById('action-list');
		
		// è¨ˆç®—é æœŸçš„ DOM å…ƒç´ æ•¸é‡ï¼š (æ­·å²æ­¥é©Ÿæ•¸ * 2) + 1 å€‹çµå°¾ Gap
		// çµæ§‹æ˜¯ï¼š[Gap, Item, Gap, Item, ..., Gap]
		const expectedCount = (history.length * 2) + 1;

		// ã€å„ªåŒ– 2ã€‘CSS æ§åˆ¶ï¼šè‹¥çµæ§‹æœªè®Šï¼Œåƒ…åˆ‡æ› Active æ¨£å¼ (é¿å… innerHTML æš´åŠ›é‡ç¹ª)
		// æ¢ä»¶ï¼šä¸åœ¨ç·¨è¼¯æ¨¡å¼ (ç·¨è¼¯æ¨¡å¼å¯èƒ½æ¶‰åŠæ’å…¥/åˆªé™¤) ä¸” DOM æ•¸é‡ç¬¦åˆé æœŸ
		// ... (å‰ç•¥)
		// ã€å„ªåŒ– 2ã€‘CSS æ§åˆ¶ï¼šè‹¥çµæ§‹æœªè®Šï¼Œåƒ…åˆ‡æ› Active æ¨£å¼
		if (!isDrafting && list.children.length === expectedCount) {
			// 1. ç§»é™¤èˆŠçš„æ¨£å¼ (æ”¹ç‚ºç§»é™¤ editing)
			const prevActive = list.querySelector('.action-item.editing'); 
			if (prevActive) {
				prevActive.classList.remove('editing');
			}
			// ç‚ºäº†ä¿éšªèµ·è¦‹ï¼Œä¹Ÿç§»é™¤å¯èƒ½æ®˜ç•™çš„ active (å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åˆ‡æ›)
			const prevOldActive = list.querySelector('.action-item.active');
			if (prevOldActive) prevOldActive.classList.remove('active');

			// 2. è¨­å®šæ–°çš„æ¨£å¼ (æ”¹ç‚ºåŠ å…¥ editing)
			const newActive = list.children[currentIndex * 2 + 1];
			if (newActive && newActive.classList.contains('action-item')) {
				newActive.classList.add('editing'); // <--- é—œéµä¿®æ”¹ï¼šä½¿ç”¨è™›ç·šæ¨£å¼
				
				// (é¸ç”¨) ç¢ºä¿ç›®å‰æ­¥é©Ÿåœ¨è¦–é‡å…§
				// newActive.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
			}

			// 3. æ›´æ–°è¨ˆæ•¸å™¨æ–‡å­—
			const counter = document.getElementById('step-counter');
			if (counter) counter.innerText = `${currentIndex}/${history.length-1}`;

			return;
		}

		// ===================================
		// ä¸‹æ–¹ç‚ºã€Œçµæ§‹æ”¹è®Šã€æ™‚çš„å®Œæ•´é‡ç¹ªé‚è¼¯ (å¦‚æ–°å¢ã€åˆªé™¤ã€è¼‰å…¥åŠ‡æœ¬æ™‚åŸ·è¡Œ)
		// ===================================
		list.innerHTML = '';

		// è¼”åŠ©å‡½å¼ï¼šå»ºç«‹ä½”ä½ç¬¦ (è™›ç·šæ¡†)
		const createPlaceholder = () => {
			const li = document.createElement('li');
			li.className = 'action-item placeholder';
			li.innerText = (typeof t === 'function') ? t('msg_editing_placeholder') : '... Editing ...';
			li.id = 'active-placeholder';
			return li;
		};

		history.forEach((item, index) => {
			const gap = document.createElement('div');
			gap.className = 'timeline-gap';
			gap.title = "æ’å…¥æ–°æ­¥é©Ÿ";

			if (isDrafting && editModeType === 'INSERT' && insertIndex === index) {
				gap.style.pointerEvents = 'none';
				list.appendChild(gap);
				list.appendChild(createPlaceholder());
			} else {
				// å»ºç«‹ [+] æŒ‰éˆ•
				const btnPlus = document.createElement('div');
				btnPlus.className = 'gap-btn gap-btn-plus';
				btnPlus.innerText = '+';
				btnPlus.onclick = (e) => {
					e.stopPropagation();
					startDraft(index);
				};
				
				// å»ºç«‹ [-] æŒ‰éˆ•
				const btnMinus = document.createElement('div');
				btnMinus.className = 'gap-btn gap-btn-minus';
				btnMinus.innerText = '-';
				btnMinus.onclick = (e) => {
					e.stopPropagation();
					truncateTimeline(index);
				};

				gap.appendChild(btnPlus);
				if (index > 0) gap.appendChild(btnMinus);
				list.appendChild(gap);
			}

			const li = document.createElement('li');
			let colorClass = '';
			
			// åˆ¤æ–·é¡è‰²æ¢ (P1/P2)
			if (item.action.operations && item.action.operations.length > 0) {
				const op = item.action.operations.find(o => o.cardIds && o.cardIds.length > 0);
				if (op) {
					const cardId = op.cardIds[0];
					const card = item.state.cards.find(c => c.id === cardId);
					if (card) {
						if (card.ownerId === 1) colorClass = 'p1-action';
						else if (card.ownerId === 2) colorClass = 'p2-action';
					}
				}
			}

			// [ä¿®æ”¹é»] åˆ¤æ–· class çš„åœ°æ–¹
			if (isDrafting && editModeType === 'EDIT' && insertIndex === index) {
				li.className = `action-item editing ${colorClass}`;
			} else {
				// åŸæœ¬æ˜¯ 'active'ï¼Œæ”¹ç‚º 'editing' ä»¥å¥—ç”¨è™›ç·šé¢¨æ ¼
				li.className = `action-item ${index === currentIndex ? 'editing' : ''} ${colorClass}`;
			}

			// æŒ‰éˆ•å€å¡Š
			const btnDelTitle = (typeof t === 'function') ? t('btn_delete_step') : 'Delete';
			const delBtn = `<button class="icon-btn delete" onclick="event.stopPropagation(); deleteAction(${index})" title="${btnDelTitle}">ğŸ—‘</button>`;
			const btnPlayFrom = (typeof t === 'function') ? t('btn_play_from') : 'Play From Here';
			const btnPlayStep = (typeof t === 'function') ? t('btn_play_step') : 'Demo Step';

			const controls = `
				<div class="action-controls">
					<button class="mini-btn play-from" onclick="event.stopPropagation(); playFromStep(${index})">${btnPlayFrom}</button>
					<button class="mini-btn play-step" onclick="event.stopPropagation(); playSingleStep(${index})">${btnPlayStep}</button>
					${delBtn}
				</div>
			`;

			li.onclick = (e) => {
				if (isDrafting) return;
				if(e.target.tagName === 'BUTTON') return;
				
				currentIndex = index;
				forceNewStep = false;
				// é»æ“Šåˆ—è¡¨æ™‚ï¼Œå¼·åˆ¶é€²è¡Œä¸€æ¬¡å®Œæ•´é‡ç¹ªä»¥æ›´æ–°ç•«é¢ï¼Œä½† Timeline æœ¬èº«å› ç‚ºä¸Šé¢çš„å„ªåŒ–ï¼Œåªæœƒåˆ‡æ› Class
				renderUI(true); 
				if(typeof saveToStorage === 'function') saveToStorage();
			};

			li.innerHTML = `
				<div class="action-header">
					<span class="action-index">${index}</span>
					<span class="action-desc">${item.action.description}</span>
				</div>
				${controls}
			`;
			list.appendChild(li);
		});

		// è™•ç†çµå°¾ Gap
		const endGap = document.createElement('div');
		endGap.className = 'timeline-gap';

		if (isDrafting && editModeType === 'INSERT' && insertIndex === history.length) {
			endGap.style.pointerEvents = 'none';
			list.appendChild(endGap);
			list.appendChild(createPlaceholder());
		} else {
			const btnPlusEnd = document.createElement('div');
			btnPlusEnd.className = 'gap-btn gap-btn-plus';
			btnPlusEnd.innerText = '+';
			btnPlusEnd.onclick = (e) => {
				e.stopPropagation();
				startDraftAtEnd();
			};
			endGap.appendChild(btnPlusEnd);
			list.appendChild(endGap);
		}

		const counter = document.getElementById('step-counter');
		if (counter) counter.innerText = `${currentIndex}/${history.length-1}`;
	}

    function prevStep() { if (currentIndex > 0) { currentIndex--; renderUI(); saveToStorage(); } }
    function nextStep() { if (currentIndex < history.length - 1) { currentIndex++; renderUI(); saveToStorage(); } }
    
    // --- [2] æŒ‡å®šæ­¥æ•¸æ’­æ”¾ (Action Log é»æ“Šè§¸ç™¼) ---
	function playFromStep(idx) {
		currentIndex = idx;
		
		// å…ˆæ¸²æŸ“è©²ç¦ï¼Œè®“ç•«é¢è·³è½‰
		renderUI();
		
		// [é—œéµ] å¼·åˆ¶é€²å…¥æ’­æ”¾æ¨¡å¼ (éš±è—ç·¨è¼¯ UI)
		if (!document.body.classList.contains('mobile-mode')) {
			document.body.classList.add('desktop-playing');
		}
		
		document.body.classList.add('is-playing');

		// å¦‚æœæ²’åœ¨æ’­ï¼Œå°±é–‹å§‹æ’­
		if (!playTimeout) {
			togglePlay(); 
		}
	}
	
	// --- [è£œå›] æ‰‹æ©Ÿç‰ˆæ©«ç›´å‘åµæ¸¬é‚è¼¯ ---
	function checkOrientation() {
		// å¦‚æœä¸æ˜¯æ‰‹æ©Ÿç‰ˆï¼Œå°±ä¸åŸ·è¡Œè‡ªå‹•æ’­æ”¾é‚è¼¯
		if (!document.body.classList.contains('mobile-mode')) return;

		const isLandscape = window.innerWidth > window.innerHeight;
		
		// ç‹€æ…‹æ”¹è®Šæ™‚æ‰è§¸ç™¼
		if (lastOrientation !== isLandscape) {
			lastOrientation = isLandscape;
			
			if (isLandscape) {
				// [æ©«å¼] -> è‡ªå‹•é–‹å§‹æ’­æ”¾
				console.log("Switch to Landscape: Auto Play");
				if (!playTimeout) togglePlay();
			} else {
				// [ç›´å¼] -> æš«åœ (è®“ä½¿ç”¨è€…é¸åŠ‡æœ¬)
				console.log("Switch to Portrait: Pause");
				if (playTimeout) togglePlay(); // togglePlay åˆ¤æ–·æœ‰ playTimeout æœƒåŸ·è¡Œæš«åœ
			}
		}
	}
	
	// è«‹ç¢ºä¿åœ¨ window resize æ™‚å‘¼å«æ­¤å‡½å¼
	window.addEventListener('resize', checkOrientation);
	// åˆå§‹åŒ–æ™‚ä¹Ÿå‘¼å«ä¸€æ¬¡
	window.addEventListener('load', checkOrientation);
	// --- [æ–°å¢/ä¿®æ”¹] é é¢è¼‰å…¥åˆå§‹åŒ– ---
	window.addEventListener('load', () => {
		// 1. åˆå§‹åŒ–æ‹–æ›³é¢æ¿ (åŸæœ¬å»ºè­°çš„)
		initDraggablePanel();
		
		// 2. æª¢æŸ¥è½‰å‘ (æ‰‹æ©Ÿç‰ˆ)
		checkOrientation();

		// 3. [é—œéµä¿®æ­£] å¼·åˆ¶åˆæ¬¡æ¸²æŸ“
		// æ¸…ç©ºå„ªåŒ–å¿«å–ï¼Œæ¬ºé¨™ç³»çµ±èªç‚ºã€Œæ‰€æœ‰å€åŸŸéƒ½è®Šé«’äº†ã€ï¼Œå¼·åˆ¶é‡ç¹ª
		if (typeof lastZoneHashes !== 'undefined') {
			lastZoneHashes = {}; 
		}
		
		// å˜—è©¦å¾ LocalStorage è¼‰å…¥ä¸Šæ¬¡é€²åº¦
		// (å¦‚æœ loadFromStorage å…§éƒ¨æœ‰å‘¼å« renderUIï¼Œé€™æœƒæ˜¯ç¬¬ä¸€æ¬¡)
		const hasLoaded = loadFromStorage(); 

		// 4. [ä¿éšªæ©Ÿåˆ¶] å»¶é²å†æ¬¡æ¸²æŸ“
		// ç‚ºäº†ç¢ºä¿å­—å‹ã€åœ–ç‰‡æˆ– DOM ä½ˆå±€å®Œå…¨å°±ç·’ï¼Œç¨å¾®å»¶é²å¾Œå†å¼·åˆ¶ç•«ä¸€æ¬¡
		// é€™èƒ½è§£æ±ºã€Œä¸€é–‹å•Ÿæ™‚ç•«é¢ç©ºç™½ã€çš„å•é¡Œ
		setTimeout(() => {
			// å†æ¬¡æ¸…ç©ºå¿«å– (ç¢ºä¿é€™æ¬¡ render ä¸€å®šæœƒåŸ·è¡Œ DOM æ“ä½œ)
			if (typeof lastZoneHashes !== 'undefined') {
				lastZoneHashes = {}; 
			}
			renderUI(); 
			
			// å¦‚æœè¼‰å…¥æˆåŠŸï¼Œé †ä¾¿æ²å‹•åˆ°æœ€æ–°çš„æ­¥é©Ÿ
			if (hasLoaded && typeof scrollToActiveStep === 'function') {
				scrollToActiveStep();
			}
		}, 200); // 200ms çš„å»¶é²é€šå¸¸è¶³å¤ è®“ç€è¦½å™¨å®Œæˆç‰ˆé¢é…ç½®
	});

    function playSingleStep(idx) {
        if (playTimeout) togglePlay(); 
        if (idx > 0) {
            currentIndex = idx - 1; renderUI();
            setTimeout(() => { currentIndex = idx; renderUI(); saveToStorage(); }, 500);
        } else {
            currentIndex = 0; renderUI(); saveToStorage();
        }
    }

    let playTimeout = null; // å–ä»£ playInterval
	// --- æ‰‹æ©Ÿç‰ˆå°ˆç”¨ç‹€æ…‹è®Šæ•¸ ---
	let wasPlayingBeforePortrait = false; // è¨˜éŒ„è½‰ç›´å‰æ˜¯å¦æ­£åœ¨æ’­æ”¾
	let hasEnteredLandscapeOnce = false;  // è¨˜éŒ„æ˜¯å¦å·²ç¶“é€²å…¥éæ©«å‘æ¨¡å¼(ç”¨æ–¼ç¬¬ä¸€æ¬¡è‡ªå‹•æ’­æ”¾)

    // --- [è®Šæ•¸] å„²å­˜æ©«ç›´å‘ç‹€æ…‹ ---
	let lastOrientation = null;

	// --- [1] åˆ‡æ›æ’­æ”¾/æš«åœ ---
	function togglePlay( fullScreen ) {
		// åˆ¤æ–·æ˜¯å¦ç‚ºæ‰‹æ©Ÿ (æ‰‹æ©Ÿç‰ˆä¸å¥—ç”¨ desktop-playingï¼Œä»¥å…èˆ‡æ‰‹æ©ŸåŸç”Ÿæ¨£å¼è¡çª)
		const isMobile = document.body.classList.contains('mobile-mode');
		if ( !isMobile && fullScreen ){
			document.documentElement.requestFullscreen();
		}

		if (playTimeout) {
			// === æš«åœ ===
			clearTimeout(playTimeout);
			playTimeout = null;
			updatePlayButtonUI();
			
			// æš«åœæ™‚ç§»é™¤äº’å‹•é–å®š
			document.body.classList.remove('is-playing');
			
			// è¨»ï¼šæš«åœæ™‚ã€Œä¸ç§»é™¤ã€desktop-playingï¼Œè®“ä½¿ç”¨è€…å¯ä»¥çœ‹æ¸…æ¥šç•¶å‰æˆ°æ³
			// åªæœ‰æŒ‰ä¸‹ [åœæ­¢] æ‰æœƒåˆ‡å›ç·¨è¼¯ä»‹é¢

			if (isMobile) globalAudioPlayer.pause();
		} else {
			// === æ’­æ”¾ ===
			
			// iOS éŸ³æ¨‚è§£é–
			if (globalAudioPlayer.paused) {
				globalAudioPlayer.play().then(() => {
					const currState = (currentIndex >= 0 && history[currentIndex]) ? history[currentIndex].state : initialState;
					if (!currState.bgm) globalAudioPlayer.pause();
				}).catch(e => {});
			}
			
			// å¾ªç’°æ’­æ”¾
			if (currentIndex >= history.length - 1) {
				currentIndex = -1;
			}

			document.body.classList.add('is-playing');
			
			// [é—œéµ] å¦‚æœæ˜¯æ¡Œæ©Ÿç‰ˆï¼Œé€²å…¥ã€Œæ²‰æµ¸æ’­æ”¾æ¨¡å¼ã€(éš±è—ç·¨è¼¯ UI)
			if (!isMobile) {
				document.body.classList.add('desktop-playing');
			}

			// BGM è™•ç†
			let startBgm = null;
			if (currentIndex >= 0 && history[currentIndex]) startBgm = history[currentIndex].state.bgm;
			else if (initialState) startBgm = initialState.bgm;

			if (startBgm) {
				const targetSrc = BGM_FOLDER + startBgm;
				if (!globalAudioPlayer.src.includes(encodeURI(startBgm))) {
					globalAudioPlayer.src = targetSrc;
					globalAudioPlayer.currentTime = 0;
				}
				globalAudioPlayer.play().catch(e => {});
			}

			playNextStep();
			updatePlayButtonUI();
		}
	}
	
	// --- [æ–°å¢] æ‰‹æ©Ÿç‰ˆéœéŸ³åˆ‡æ› ---
    function toggleMute() {
        // 1. åˆ‡æ› Audio ç‰©ä»¶çš„éœéŸ³ç‹€æ…‹
        globalAudioPlayer.muted = !globalAudioPlayer.muted;
        
        // 2. æ›´æ–°æŒ‰éˆ•å¤–è§€
        updateMuteButtonUI();
    }

    function updateMuteButtonUI() {
        const btn = document.getElementById('mob-mute-btn');
        if (!btn) return;

        const isMuted = globalAudioPlayer.muted;
        
        if (isMuted) {
            btn.innerText = "ğŸ”‡";
            // éœéŸ³æ™‚æŒ‰éˆ•è®Šç´…ï¼Œæç¤ºæ¯”è¼ƒæ˜é¡¯
            btn.style.borderColor = "#e74c3c";
            btn.style.color = "#e74c3c";
        } else {
            btn.innerText = "ğŸ”Š";
            // å›å¾©åŸæœ¬æ¨£å¼
            btn.style.borderColor = "white";
            btn.style.color = "white";
        }
    }
	
	// --- [æ–°å¢] Play éµç™¼å…‰å¼•å°é‚è¼¯ ---
    function checkFirstTimePlayHighlight() {
        // ä½¿ç”¨ localStorage è¨˜éŒ„ä½¿ç”¨è€…æ˜¯å¦æ›¾ç¶“æŒ‰éæ’­æ”¾
        // å¦‚æœæ²’æœ‰ç´€éŒ„ (null)ï¼Œä»£è¡¨æ˜¯ç¬¬ä¸€æ¬¡
        const hasPlayed = localStorage.getItem('dm_has_played_mobile');
        
        if (!hasPlayed) {
            const btn = document.getElementById('mob-play-btn');
            if (btn) btn.classList.add('btn-highlight');
        }
    }

    function removePlayHighlight() {
        const btn = document.getElementById('mob-play-btn');
        if (btn && btn.classList.contains('btn-highlight')) {
            btn.classList.remove('btn-highlight');
            // å¯«å…¥ç´€éŒ„ï¼Œä¸‹æ¬¡é€²ä¾†å°±ä¸æœƒå†é–ƒäº†
            localStorage.setItem('dm_has_played_mobile', 'true');
        }
    }

	// --- [3] åœæ­¢æ’­æ”¾ (æ¢å¾© UI + åœåœ¨ç•¶ä¸‹) ---
	function stopPlayback( closeMusic ) {
		if (document.fullscreenElement) {
			document.exitFullscreen().catch(err => {}); // é˜²æ­¢éå…¨è¢å¹•æ™‚å ±éŒ¯
		}
		// 1. åœæ­¢è¨ˆæ™‚å™¨
		if (playTimeout) {
			clearTimeout(playTimeout);
			playTimeout = null;
		}
		// 2. æ›´æ–°æŒ‰éˆ•åœ–ç¤º
		updatePlayButtonUI();
		// 3. [é—œéµ] ç§»é™¤æ’­æ”¾æ¨¡å¼ Class -> é€™æœƒè®“ CSS è£¡çš„ display:none å¤±æ•ˆ
		// æ–¼æ˜¯ Toolbar, Timeline ç­‰ç·¨è¼¯ä»‹é¢å°±æœƒã€Œæ¢å¾©é¡¯ç¤ºã€
		document.body.classList.remove('desktop-playing');
		document.body.classList.remove('is-playing');
		
		// 4. [é—œéµ] è¨»è§£æ‰é‡ç½®é‚è¼¯ï¼Œç¢ºä¿åœåœ¨ç•¶ä¸‹
		// currentIndex = 0;

		// 5. æš«åœéŸ³æ¨‚
		if ( closeMusic ){
			globalAudioPlayer.pause();
		}

		// -----------------------------------------------------------
		// [ä¿®æ­£] æ”¹ç”¨æ—¢æœ‰çš„ isMobileDevice() å‡½å¼åˆ¤æ–·
		// å¦‚æœã€Œä¸æ˜¯è¡Œå‹•è£ç½®ã€(å³æ¡Œæ©Ÿç‰ˆ)ï¼Œæ‰åŸ·è¡Œåˆ—è¡¨é‡ç¹ªèˆ‡æ²å‹•
		if (!isMobileDevice()) { 
			renderTimeline();
			
			setTimeout(() => {
				scrollToActiveStep();
			}, 50);
		}
		// -----------------------------------------------------------;
	}

    // --- [ä¿®æ”¹] æ’­æ”¾ä¸‹ä¸€æ­¥ (playNextStep) - ç°¡åŒ–ç‰ˆ ---
	let isTurnAnimPlaying = false; 

	function playNextStep() {
		if (isTurnAnimPlaying) return;

		if (currentIndex < history.length - 1) {
			const nextIndex = currentIndex + 1;
			const currState = history[currentIndex].state;
			const nextState = history[nextIndex].state;

			// æª¢æŸ¥å›åˆæ˜¯å¦åˆ‡æ› (ä¸”åœ¨è‡ªå‹•æ’­æ”¾ä¸­)
			if (currState.turnPlayer !== nextState.turnPlayer) {
				if (playTimeout) clearTimeout(playTimeout);
				isTurnAnimPlaying = true; 
				
				const nextPlayer = nextState.turnPlayer;
				
				// ç›´æ¥å‘¼å«å‹•ç•«ï¼Œä¸éœ€è¦å‚³å…¥ turnCount
				showTurnTransition(nextPlayer, () => {
					isTurnAnimPlaying = false; 
					performStepLogic(nextIndex); 
				});
				return; 
			}

			performStepLogic(nextIndex);

		} else {
			stopPlayback( false );
			setTimeout(() => { triggerEnding(); }, 2000);
		}
	}

	// --- [æ–°å¢] æŠ½é›¢å‡ºä¾†çš„æ­¥é©ŸåŸ·è¡Œé‚è¼¯ (ä¾›ä¸Šé¢å‘¼å«) ---
	function performStepLogic(nextIndex) {
		const prevBgm = history[currentIndex].state.bgm;
		
		currentIndex = nextIndex; // å‰é€²ä¸€æ­¥
		
		renderUI();
		// ä¿®æ”¹å»ºè­°
		if(!document.body.classList.contains('mobile-mode') && !document.body.classList.contains('is-playing')) {
			saveToStorage();
		}

		const currState = history[currentIndex].state;
		const currAction = history[currentIndex].action; // å–å¾— Action ç‰©ä»¶
		
		// BGM æª¢æŸ¥
		const currBgm = currState.bgm;
		if (currBgm !== prevBgm) {
			if (currBgm) {
				const bgmSrc = BGM_FOLDER + currBgm;
				if (!globalAudioPlayer.src.includes(encodeURI(currBgm))) {
					globalAudioPlayer.src = bgmSrc;
					globalAudioPlayer.play().catch(e => {});
				} else {
					globalAudioPlayer.play().catch(e => {});
				}
			} else {
				globalAudioPlayer.pause();
			}
		}

		// --- å»¶é²è¨ˆç®—é‚è¼¯ (ç¶­æŒåŸæœ‰) ---
		let delay = TIME_ACTION_BASE;
		const currOp = currAction.operations ? currAction.operations[0] : null;

		// ç‰¹æ®Šå‹•ä½œå»¶é²åˆ¤æ–·
		if (currAction.operations.length === 1 && currOp && currOp.type === 'SET_BGM') {
			delay = 50;
		} else if (currOp && currOp.type === 'REALITY_BREAK') {
			delay = 2800;
		} else if (currOp && currOp.type === 'RPS') {
			delay = 4000;
		} else if (currOp && currOp.type === 'DIALOGUE') {
			delay = 1500;
		} else if (currOp && currOp.type === 'SHUFFLE') {
			delay = 2100;
		} else if (currOp && currOp.type === 'MOVE' && currOp.withShuffleAnim) {
			delay = 1500;
		}

		// æ‰‹æ©Ÿç‰ˆæˆ°é¬¥ç‰¹å¯«é‚è¼¯ (ç¶­æŒåŸæœ‰)
		const isMobile = document.body.classList.contains('mobile-mode');
		let battleEntryIds = [];
		if (isMobile) {
			const prevState = (currentIndex > 0) ? history[currentIndex - 1].state : initialState;
			currState.cards.forEach(currCard => {
				if (!currCard.zone.includes('battle')) return;
				if (!currCard.faceUp) return;
				if (currCard.stackType === 'bottom' || currCard.stackType === 'bottom_exposed') return;
				const prevCard = prevState.cards.find(c => c.id === currCard.id);
				if (prevCard && prevCard.zone.includes('battle')) return;
				battleEntryIds.push(currCard.id);
			});
		}

		let finalDelay = delay * currentSpeedFactor;

		if (battleEntryIds.length > 0) {
			playTimeout = setTimeout(() => {
				if (typeof runMobileBattleZoomSequence === 'function') {
					runMobileBattleZoomSequence(battleEntryIds, () => {
						playNextStep();
					});
				} else {
					playNextStep();
				}
			}, 1500);
		} else {
			playTimeout = setTimeout(playNextStep, finalDelay);
		}
	}
    
    function rotateBoard() { addOperation({type: 'ROTATE'}); }

	// --- [ä¿®æ”¹] é¡¯ç¤ºéå ´å‹•ç•« (ä¸é¡¯ç¤ºå›åˆæ•¸) ---
	function showTurnTransition(nextPlayerId, callback) {
		const overlay = document.getElementById('turn-transition-overlay');
		const content = document.getElementById('tto-content');
		
		// 1. å–å¾—è¨­å®šé¡è‰²èˆ‡åç¨±
		const colorKey = (nextPlayerId === 1) ? globalThemeSettings.p1 : globalThemeSettings.p2;
		const theme = THEME_PALETTE[colorKey] || (nextPlayerId === 1 ? THEME_PALETTE.blue : THEME_PALETTE.red);
		const pName = (nextPlayerId === 1) ? "1P" : "2P"; 
		
		// 2. è¨­å®šæ–‡å­—èˆ‡é¡è‰² (åªæ›¿æ› playerï¼Œä¸éœ€ count)
		const msg = t('msg_turn_change').replace('{player}', pName);
			
		content.innerHTML = `
			<div class="tto-line" style="background:${theme.main}; box-shadow:0 0 15px ${theme.main}"></div>
			<span style="color:${theme.main}; border-bottom: 3px solid ${theme.main}; padding-bottom:5px;">${msg}</span>
			<div class="tto-line" style="background:${theme.main}; box-shadow:0 0 15px ${theme.main}"></div>
		`;

		// 3. æ’­æ”¾å‹•ç•«
		overlay.classList.add('active');

		// 4. åœç•™ 1.5 ç§’å¾Œæ¶ˆå¤±ä¸¦å›èª¿
		setTimeout(() => {
			overlay.classList.remove('active');
			setTimeout(() => {
				if (callback) callback();
			}, 200); 
		}, 1500);
	}

    function exportData() {
        // [æ–°å¢] åœ¨åŒ¯å‡ºå‰åŸ·è¡Œä¸€æ¬¡é·ç§»è…³æœ¬ï¼Œç¢ºä¿èˆŠè³‡æ–™éƒ½è¢«å„ªåŒ–
        optimizeAndMigrateImages(); 

        // 1. æ·±æ‹·è²æ­·å²ç´€éŒ„ (ç§»é™¤ state å¿«ç…§ä»¥ç¯€çœç©ºé–“)
        let historyToExport = JSON.parse(JSON.stringify(history));
        historyToExport.forEach((item, index) => { if (index > 0) delete item.state; });

        // --- [æ–°å¢] 2. åŸ·è¡Œæ—‹è½‰å‹•ä½œå„ªåŒ– (Rotation Optimization) ---
        historyToExport = optimizeHistoryForExport(historyToExport);
        // -------------------------------------------------------
        
        // 3. åŸ·è¡Œ GC éæ¿¾ï¼ŒåªåŒ¯å‡ºæœ‰ç”¨çš„åœ–ç‰‡
        const usedKeys = getUsedImageKeys();
        const cleanImageRegistry = {};
        
        Object.keys(globalImageRegistry).forEach(key => {
            if (usedKeys.has(key)) {
                cleanImageRegistry[key] = globalImageRegistry[key];
            }
        });
        
        const data = {
            history: historyToExport,
            initialState: initialState,
            currentIndex: currentIndex,
            timestamp: Date.now(),
            imageRegistry: cleanImageRegistry, 
            abilityRegistry: globalAbilityStyleRegistry,
            lastUsedStyles: globalLastUsedStyles,
            lastDiagSettings: (typeof lastDiagSettings !== 'undefined') ? lastDiagSettings : null,
            aceRegistry: globalAceRegistry,
            themeSettings: globalThemeSettings,
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:"text/plain"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `dm-script-${Date.now()}.txt`;
        a.click();
    }

    // --- [æ–°å¢] æ—‹è½‰å„ªåŒ–è¼”åŠ©å‡½å¼ ---
    function optimizeHistoryForExport(hist) {
        console.log("æ­£åœ¨å„ªåŒ–æ—‹è½‰æŒ‡ä»¤...");
        
        return hist.map(step => {
            // å¦‚æœé€™ä¸€æ­¥æ²’æœ‰æ“ä½œï¼Œç›´æ¥å›å‚³
            if (!step.action || !step.action.operations) return step;

            const ops = step.action.operations;
            const cardRotationMap = {}; // è¨˜éŒ„æ¯å¼µå¡ç‰‡çš„ç´¯è¨ˆè§’åº¦ { cardId: totalDeg }
            const unsafeCardIds = new Set(); // è¨˜éŒ„é€™ä¸€æ­¥ä¸­æœ‰åŸ·è¡Œã€Œéæ—‹è½‰ã€æ“ä½œçš„å¡ç‰‡ (ä¸è©²è¢«å„ªåŒ–)

            // 1. ç¬¬ä¸€è¼ªæƒæï¼šåˆ†æå¡ç‰‡æ“ä½œç‹€æ…‹
            ops.forEach(op => {
                if (op.cardIds) {
                    if (op.type === 'ROTATE_CARD' && typeof op.deg === 'number') {
                        // é€™æ˜¯å¯å„ªåŒ–çš„æ—‹è½‰æ“ä½œï¼Œæš«æ™‚ä¸åšæ¨™è¨˜
                    } else {
                        // é€™æ˜¯å…¶ä»–æ“ä½œ (Move, Flip, Injured...)
                        // é€™äº›å¡ç‰‡è¢«è¦–ç‚ºã€Œä¸å®‰å…¨ã€ï¼Œä¸èƒ½åˆä½µæ—‹è½‰ï¼Œä»¥å…ç ´å£é †åºé‚è¼¯
                        op.cardIds.forEach(id => unsafeCardIds.add(id));
                    }
                }
            });

            // 2. ç¬¬äºŒè¼ªæƒæï¼šè¨ˆç®—ç´¯è¨ˆè§’åº¦ & éæ¿¾æ“ä½œ
            const newOps = [];
            
            ops.forEach(op => {
                let isOptimizableRotation = false;

                if (op.type === 'ROTATE_CARD' && typeof op.deg === 'number') {
                    // æª¢æŸ¥é€™å¼µæŒ‡ä»¤æ¶‰åŠçš„å¡ç‰‡ï¼Œæ˜¯å¦å…¨éƒ¨éƒ½æ˜¯ã€Œå®‰å…¨ã€çš„
                    // (å³ï¼šåœ¨é€™ä¸€æ­¥é©Ÿä¸­ï¼Œé€™äº›å¡ç‰‡é™¤äº†æ—‹è½‰å¤–ï¼Œæ²’æœ‰åšå…¶ä»–ç§»å‹•æˆ–ç¿»é¢)
                    const isSafe = op.cardIds.every(id => !unsafeCardIds.has(id));

                    if (isSafe) {
                        isOptimizableRotation = true;
                        // ç´¯è¨ˆè§’åº¦
                        op.cardIds.forEach(id => {
                            cardRotationMap[id] = (cardRotationMap[id] || 0) + op.deg;
                        });
                    }
                }

                // å¦‚æœä¸æ˜¯å¯å„ªåŒ–çš„æ—‹è½‰ (æ˜¯ç§»å‹•ã€å°è©±ã€æˆ–æ˜¯æ¶‰åŠç§»å‹•çš„æ—‹è½‰)ï¼Œå‰‡ä¿ç•™åŸæŒ‡ä»¤
                if (!isOptimizableRotation) {
                    newOps.push(op);
                }
            });

            // 3. ç¬¬ä¸‰è¼ªï¼šå°‡ç´¯è¨ˆå¾Œçš„è§’åº¦ç”Ÿæˆæ–°çš„æ—‹è½‰æŒ‡ä»¤
            // ç‚ºäº†ç¯€çœæŒ‡ä»¤æ•¸ï¼Œæˆ‘å€‘å°‡ã€Œç›¸åŒæ—‹è½‰è§’åº¦ã€çš„å¡ç‰‡åˆä½µæˆä¸€å€‹æŒ‡ä»¤
            const degToCards = {}; // { 90: [id1, id2], 180: [id3] }

            Object.keys(cardRotationMap).forEach(cardId => {
                const totalDeg = cardRotationMap[cardId] % 360; // å–é¤˜æ•¸ (ä¾‹å¦‚è½‰ 450åº¦ = 90åº¦)
                if (totalDeg !== 0) { // å¦‚æœè½‰äº†ä¸€åœˆå›åˆ° 0 åº¦ï¼Œå°±ç›´æ¥çœç•¥
                    if (!degToCards[totalDeg]) degToCards[totalDeg] = [];
                    degToCards[totalDeg].push(parseInt(cardId));
                }
            });

            // ç”¢ç”Ÿåˆä½µå¾Œçš„æŒ‡ä»¤
            Object.keys(degToCards).forEach(deg => {
                newOps.push({
                    type: 'ROTATE_CARD',
                    cardIds: degToCards[deg],
                    deg: parseFloat(deg)
                });
            });

            // æ›´æ–°æ­¥é©Ÿçš„æ“ä½œæ¸…å–®
            step.action.operations = newOps;
            return step;
        });
    }
	
	// --- [ä¿®æ­£ç‰ˆ] åœ–ç‰‡æœ€ä½³åŒ–èˆ‡é·ç§»è…³æœ¬ ---
	function optimizeAndMigrateImages() {
		console.log("é–‹å§‹åŸ·è¡Œåœ–ç‰‡æœ€ä½³åŒ–èˆ‡é·ç§»...");
		
		// 1. å»ºç«‹å…§å®¹é›œæ¹Šè¡¨ (Base64 -> FirstKey)
		const contentMap = new Map();
		const replacementMap = new Map(); // OldKey -> NewKey

		// éæ­·ç›®å‰çš„ Registryï¼Œæ‰¾å‡ºé‡è¤‡çš„åœ–ç‰‡
		for (const [key, base64] of Object.entries(globalImageRegistry)) {
			// è·³éé ­åƒ (é ­åƒé€šå¸¸å¾ˆå°ä¸”å›ºå®šï¼Œä¸éœ€è™•ç†)
			if (key.startsWith('avatar_')) continue;

			if (contentMap.has(base64)) {
				// ç™¼ç¾é‡è¤‡ï¼è¨˜éŒ„ä¸‹ä¾†ï¼šé€™å€‹ key æ‡‰è©²è¢«æ›æˆ contentMap è£¡å­˜çš„é‚£å€‹ key
				const existingKey = contentMap.get(base64);
				replacementMap.set(key, existingKey);
			} else {
				// ç¬¬ä¸€æ¬¡çœ‹åˆ°é€™å¼µåœ–ï¼Œä»¥æ­¤ key ç‚ºä¸»
				contentMap.set(base64, key);
			}
		}

		if (replacementMap.size === 0) {
			console.log("æ²’æœ‰ç™¼ç¾é‡è¤‡åœ–ç‰‡ï¼Œç„¡éœ€é·ç§»ã€‚");
			return;
		}

		console.log(`ç™¼ç¾ ${replacementMap.size} å€‹é‡è¤‡åœ–ç‰‡ Keyï¼Œé–‹å§‹æ›¿æ› Reference...`);

		// 2. å®šç¾©æ›¿æ›é‚è¼¯
		
		// A. æ›¿æ›å¡ç‰‡ç‹€æ…‹ä¸­çš„å¼•ç”¨
		const replaceInState = (s) => {
			if (!s || !s.cards) return;
			s.cards.forEach(c => {
				if (c.imageKey && replacementMap.has(c.imageKey)) {
					c.imageKey = replacementMap.get(c.imageKey);
				}
				if (c.backImageKey && replacementMap.has(c.backImageKey)) {
					c.backImageKey = replacementMap.get(c.backImageKey);
				}
				// --- [æ–°å¢] æª¢æŸ¥ EX-Life åœ–ç‰‡å¼•ç”¨ ---
				if (c.exLifeKey && replacementMap.has(c.exLifeKey)) {
					c.exLifeKey = replacementMap.get(c.exLifeKey);
				}
				// ----------------------------------
			});
		};

		// B. [é—œéµæ–°å¢] æ›¿æ› Action æ“ä½œä¸­çš„å¼•ç”¨ (ä¿®å¾© Cut In éºå¤±å•é¡Œ)
		const replaceInOps = (ops) => {
			if (!ops) return;
			ops.forEach(op => {
				// æª¢æŸ¥ Reality Break
				if (op.type === 'REALITY_BREAK' && op.data && op.data.imgKey) {
					if (replacementMap.has(op.data.imgKey)) {
						op.data.imgKey = replacementMap.get(op.data.imgKey);
					}
				}
				// --- [æ–°å¢] æª¢æŸ¥ SET_EX_LIFE ---
				if (op.type === 'SET_EX_LIFE' && op.imgKey) {
					if (replacementMap.has(op.imgKey)) {
						op.imgKey = replacementMap.get(op.imgKey);
					}
				}
				// -----------------------------
			});
		};

		// 3. åŸ·è¡Œå…¨é¢æ›¿æ›
		replaceInState(initialState);
		
		history.forEach(h => {
			// æ›´æ–°ç‹€æ…‹å¿«ç…§
			replaceInState(h.state);
			if (h.detachedStartState) replaceInState(h.detachedStartState);
			
			// [æ–°å¢] æ›´æ–°æ­·å²æ“ä½œ (History Action Operations)
			if (h.action && h.action.operations) {
				replaceInOps(h.action.operations);
			}
		});
		
		if (tempState) replaceInState(tempState);

		// [æ–°å¢] æ›´æ–°æ­£åœ¨ç·¨è¼¯ä¸­çš„æ“ä½œ (Draft)
		if (isDrafting && draftOperations.length > 0) {
			replaceInOps(draftOperations);
		}

		// 4. æ¸…ç† globalImageRegistry (åˆªé™¤è¢«æ›¿æ›æ‰çš„ Key)
		replacementMap.forEach((newKey, oldKey) => {
			delete globalImageRegistry[oldKey];
		});

		console.log("åœ–ç‰‡é·ç§»å®Œæˆï¼");
		renderUI(); // é‡ç¹ªç¢ºä¿é¡¯ç¤ºæ­£å¸¸
	}
	
	// --- [ä¿®æ­£ç‰ˆ] åœ–ç‰‡é è¼‰å…¥å‡½å¼ (æ”¯æ´ Cut-In ç¶²è·¯åœ–ç‰‡) ---
	function preloadImagesFromRegistry() {
		console.log("æ­£åœ¨æƒæä¸¦é è¼‰å…¥åœ–ç‰‡...");
		let count = 0;

		// 1. é è¼‰åŠ‡æœ¬ä¸­çš„åœ–ç‰‡ (Registry)
		Object.values(globalImageRegistry).forEach(src => {
			if (src && typeof src === 'string' && !src.startsWith('data:')) {
				const img = new Image();
				img.src = src;
				count++;
			}
		});

		// 2. [æ–°å¢] æƒææ­·å²ç´€éŒ„ä¸­çš„ Cut-In ç¶²è·¯åœ–ç‰‡ (Reality Break)
		if (typeof history !== 'undefined' && Array.isArray(history)) {
			history.forEach(step => {
				if (step.action && step.action.operations) {
					step.action.operations.forEach(op => {
						// æª¢æŸ¥æ˜¯å¦ç‚ºç‰¹æ•ˆæ“ä½œï¼Œä¸”åŒ…å« imgUrl (ç¶²è·¯é€£çµ)
						if (op.type === 'REALITY_BREAK' && op.data && op.data.imgUrl) {
							const img = new Image();
							img.src = op.data.imgUrl;
							count++;
							// console.log("é è¼‰ Cut-In URL:", op.data.imgUrl);
						}
					});
				}
			});
		}

		// 3. é è¼‰å¯«æ­»çš„çŒœæ‹³åœ–ç‰‡ (Hardcoded RPS)
		const rps_urls = [
			'https://dm.takaratomy.co.jp/wp-content/card/cardthumb/dm28-056.jpg',
			'https://dm.takaratomy.co.jp/wp-content/card/cardthumb/dm28-103.jpg',
			'https://dm.takaratomy.co.jp/wp-content/card/cardthumb/dm28-060.jpg'
		];
		rps_urls.forEach(src => {
			const img = new Image();
			img.src = src;
			count++;
		});

		if (count > 0) {
			console.log(`[Preload] ç¸½è¨ˆå·²å•Ÿå‹• ${count} å¼µåœ–ç‰‡çš„é å…ˆè¼‰å…¥ã€‚`);
		}
	}

    function processGameData(data, resetToStart = false) {
		globalImageRegistry = data.imageRegistry || {};
		
		// [å„ªåŒ–] CutIn åœ–ç‰‡èƒŒæ™¯è¼‰å…¥ (ä¸å¡ä½ä¸»åŸ·è¡Œç·’)
		setTimeout(() => {
			// 1. è¼‰å…¥ä¸€èˆ¬å¡åœ–
			preloadImagesFromRegistry();
			
			// 2. æƒæåŠ‡æœ¬æ‰¾å‡º CutIn èƒŒæ™¯ä¸¦è¼‰å…¥
			if (data.history) {
				const bgSet = new Set();
				data.history.forEach(step => {
					if (step.action && step.action.operations) {
						step.action.operations.forEach(op => {
							if (op.type === 'REALITY_BREAK' && op.bgImage) {
								bgSet.add(op.bgImage);
							}
						});
					}
				});
				// è§¸ç™¼ç€è¦½å™¨å¿«å–
				bgSet.forEach(url => { const img = new Image(); img.src = url; });
				console.log(`[Background Load] ${bgSet.size} CutIn images.`);
			}
		}, 100); // å»¶é² 0.1 ç§’åŸ·è¡Œ

		// ... (ä»¥ä¸‹ç‚ºåŸæœ¬é‚è¼¯ï¼Œä¿æŒä¸è®Š) ...
		globalAbilityStyleRegistry = data.abilityRegistry || {};
		globalLastUsedStyles = data.lastUsedStyles || {};
		globalAceRegistry = data.aceRegistry || {};
		
		if (data.themeSettings) globalThemeSettings = data.themeSettings;
		else globalThemeSettings = { p1: 'blue', p2: 'red' };
		applyThemeVariables();

		initialState = data.initialState;
		if (!initialState.moonless) initialState.moonless = {};
		if (initialState.rpsResult === undefined) initialState.rpsResult = null;

		let loadedHistory = data.history;
		if (!loadedHistory[0].state) loadedHistory[0].state = cloneState(initialState);
		
		// é‡å»º State éˆ
		for (let i = 1; i < loadedHistory.length; i++) {
			if (!loadedHistory[i].state) {
				if (loadedHistory[i].detachedStartState) {
					loadedHistory[i].state = cloneState(loadedHistory[i].detachedStartState);
				} else {
					const prevState = loadedHistory[i-1].state;
					const newState = cloneState(prevState);
					if (loadedHistory[i].action && loadedHistory[i].action.operations) {
						loadedHistory[i].action.operations.forEach(op => applyOperation(newState, op));
					}
					loadedHistory[i].state = newState;
				}
			}
		}
		history = loadedHistory;
		currentIndex = resetToStart ? 0 : (data.currentIndex || 0);

		lastRbStep = currentIndex; 
		lastShuffleStep = currentIndex;
		storageQuotaExceeded = false;
		hasAlertedQuota = false;
		lastRenderedState = null;

		calculateSeenCards();
		renderUI();
		saveToStorage();
	}

    function resolveImportConflict(choice) {
        document.getElementById('import-conflict-modal').style.display = 'none';
        if (choice === 'cancel') { pendingImportData = null; return; }
        if (choice === 'save') exportData(); 
        if (choice === 'save' || choice === 'overwrite') {
            if (pendingImportData) {
                try { processGameData(pendingImportData, true); alert(t('msg_import_success')); } 
                catch(e) { alert(t('msg_import_fail')); }
            }
        }
        pendingImportData = null;
    }

    function importData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(!data.history || !data.initialState) throw new Error("Invalid format");
                if(confirm(t('msg_confirm_import'))) {
                    processGameData(data);
                    alert(t('msg_import_success'));
                }
            } catch(err) { alert(t('msg_import_fail')); console.error(err); }
            input.value = ''; 
        };
        reader.readAsText(file);
    }

    // --- [ä¿®æ­£ç‰ˆ] é–‹å•Ÿå¡ç‰‡é¸å–® (è¦–è¦ºåŒ–éšå±¤æ’åº) ---
    function openSelectorModal(zoneId) {
        const state = getCurrentDisplayState();
        // å–å¾—è©²å€åŸŸæ‰€æœ‰å¡ç‰‡
        const rawCards = getCardsInZone(state, zoneId);
        
        const body = document.getElementById('modal-body');
        body.innerHTML = '';
        selectedCardsInModal = [];
        
        const title = document.getElementById('modal-title');
		// [ä¿®æ­£] æ ¹æ“šå…¨åŸŸè®Šæ•¸æ±ºå®šæ˜¯å¦åŠ ä¸Š active class
		const activeClass = isUnseenHighlightOn ? 'active' : '';
        title.innerHTML = `
			${getZoneName(zoneId)} (${rawCards.length})
			<button class="unseen-check-btn" 
				style="position:relative; top:0; left:10px; display:inline-block;" 
				onclick="toggleUnseenHighlight()" 
				data-i18n="btn_check_unseen">ğŸ‘ï¸â€ğŸ—¨ï¸ æœªè¦‹</button>
		`;
		title.setAttribute('data-zone-id', zoneId);

        // --------------------------------------------------------
        // [æ ¸å¿ƒæ¼”ç®—æ³•] è¦–è¦ºåŒ–æ’åºï¼šå·¦ç¾¤å„ªå…ˆ -> é ‚å±¤å„ªå…ˆ -> æ·ºå±¤å„ªå…ˆ
        // --------------------------------------------------------
        
        let sortedCards = [];

        // 1. æ‰¾å‡ºæ‰€æœ‰çš„ã€Œæ ¹å¡ (Roots)ã€
        // é€™äº›å¡ç‰‡æ²’æœ‰ parentIdï¼Œä¸”åœ¨ rawCards é™£åˆ—ä¸­çš„é †åºé€šå¸¸å°æ‡‰ç•«é¢ä¸Šçš„ç”±å·¦è‡³å³
        const roots = rawCards.filter(c => !c.parentId);

        // [ä¿®æ”¹] é‡å°ã€Œå †ç–Šå‹å€åŸŸã€(ç‰Œåº«/å¢“åœ°/è¶…æ¬¡å…ƒ)ï¼Œé€²è¡Œåå‘æ’åº
        // è®“æœ€ä¸Šé¢çš„ç‰Œ (Top/Latest) é¡¯ç¤ºåœ¨åˆ—è¡¨çš„æœ€å‰é¢ (å·¦ä¸Šè§’)
        if (zoneId.includes('deck') || zoneId.includes('grave') || zoneId.includes('hyper')) {
            roots.reverse();
        }

        // 2. é‡å°æ¯ä¸€å€‹å¡ç¾¤ (Cluster) é€²è¡Œå…§éƒ¨æ’åº
        roots.forEach(root => {
            // A. æ‰¾å‡ºè©²å®¶æ—çš„æ‰€æœ‰æˆå“¡
            // ä½¿ç”¨æ—¢æœ‰çš„ getAllLinkedCardIds (è‹¥ç„¡æ­¤å‡½å¼ï¼Œé€™è£¡ä½¿ç”¨ç°¡æ˜“éè¿´æŸ¥æ‰¾)
            const clusterIds = getAllLinkedCardIds(state, [root.id]);
            const clusterMembers = clusterIds
                .map(id => rawCards.find(c => c.id === id))
                .filter(c => c); // éæ¿¾æ‰æ‰¾ä¸åˆ°çš„(é˜²å‘†)

            // B. å°‡å®¶æ—æˆå“¡åˆ†ç‚ºã€Œè¡¨å±¤ (Surface)ã€èˆ‡ã€Œæ·±å±¤ (Buried)ã€
            // è¡¨å±¤ï¼šæ ¹å¡ã€æ‹¼åœ–é€£çµ (Puzzle)
            // æ·±å±¤ï¼šç–Šåœ¨ä¸‹æ–¹ (Bottom)ã€ä½ç§» (Shift)
            const surface = [];
            const buried = [];

            clusterMembers.forEach(c => {
                const isUnder = c.stackType && (c.stackType.includes('bottom') || c.stackType.includes('shift'));
                if (isUnder) {
                    buried.push(c);
                } else {
                    surface.push(c);
                }
            });

            // C. æ’åºã€Œè¡¨å±¤å¡ã€
            // é‚è¼¯ï¼šæ ¹å¡ (Root) æ°¸é æ”¾ç¬¬ä¸€å€‹ï¼Œå…¶ä»–çš„ (Puzzle) ä¾ ID æˆ–åŠ å…¥é †åºæ’åˆ—
            // é€™è£¡ç°¡å–®å°‡ Root ç½®é ‚ï¼Œå…¶ä»–ç¶­æŒåŸæ¨£
            surface.sort((a, b) => {
                if (a.id === root.id) return -1;
                if (b.id === root.id) return 1;
                return 0; 
            });

            // D. æ’åºã€Œæ·±å±¤å¡ã€
            // é‚è¼¯ï¼šè¶Šæ¥è¿‘è¡¨å±¤çš„è¶Šå‰é¢ (c åœ¨ d å‰é¢)
            // å¯¦ä½œï¼šè¨ˆç®—æ¯å€‹æ·±å±¤å¡èˆ‡æ ¹å¡çš„ã€Œä»£æ•¸è·é›¢ (Generation Distance)ã€
            const getDepth = (card) => {
                let depth = 0;
                let curr = card;
                while (curr && curr.parentId) {
                    depth++;
                    curr = rawCards.find(x => x.id === curr.parentId);
                }
                return depth;
            };

            buried.sort((a, b) => {
                // æ·±åº¦æ·ºçš„å„ªå…ˆ (æ•¸å­—å°çš„åœ¨å‰)
                const depthA = getDepth(a);
                const depthB = getDepth(b);
                if (depthA !== depthB) return depthA - depthB;
                // è‹¥æ·±åº¦ç›¸åŒï¼Œå‰‡ä¾ ParentID åˆ†çµ„
                return a.parentId - b.parentId;
            });

            // E. åˆä½µä¸¦æ¨å…¥æœ€çµ‚æ¸…å–®ï¼š [è¡¨å±¤] + [æ·±å±¤]
            // çµæœç¯„ä¾‹ï¼š A, B, c, d
            sortedCards.push(...surface, ...buried);
        });

        // F. é˜²å‘†ï¼šå¦‚æœæœ‰å¡ç‰‡æ²’è¢«æ­¸é¡åˆ°ä»»ä½• Root (å­¤å…’å¡)ï¼Œè£œåœ¨æœ€å¾Œé¢
        const processedIds = new Set(sortedCards.map(c => c.id));
        const orphans = rawCards.filter(c => !processedIds.has(c.id));
        sortedCards.push(...orphans);

        // --------------------------------------------------------
        // [æ¸²æŸ“] ä¾ç…§æ’åºå¾Œçš„ sortedCards ç”¢ç”Ÿ DOM
        // --------------------------------------------------------

        sortedCards.forEach((card, i) => {
            const index = i; 
            const el = document.createElement('div');
            el.className = 'card';
            
			// --- [æ–°å¢] Modal å…§çš„æœªè¦‹å¡é«˜äº® ---
            if (isUnseenHighlightOn && !globalSeenCardIds.has(card.id)) {
                el.classList.add('glow-unseen');
            }
            // ---------------------------------
			
            if (card.image && (globalImageRegistry[card.imageKey] || globalImageRegistry[card.backImageKey])) {
                const imgKey = card.imageKey || card.backImageKey;
                el.style.backgroundImage = `url(${globalImageRegistry[imgKey]})`;
                el.classList.add('has-image-icon');
            }

            if (card.rotation) {
                el.style.transform = `rotate(${card.rotation}deg) scale(0.9)`;
                el.style.boxShadow = '0 0 5px rgba(0,0,0,0.5)';
            }

            // ç‚ºäº†å€åˆ†ç¾¤çµ„ï¼Œè‹¥æ˜¯ Root å¡ï¼Œå¯ä»¥åŠ å€‹æ˜é¡¯çš„æ¨™è¨˜ (é¸ç”¨)
            // é€™è£¡ç¶­æŒåŸæœ¬æ¨£å¼ï¼Œåƒ…é€éæ’åˆ—é †åºè¡¨é”
            const isRoot = !card.parentId;
            const isBuried = card.stackType && (card.stackType.includes('bottom') || card.stackType.includes('shift'));
            
            // è¦–è¦ºå„ªåŒ–ï¼šæ·±å±¤å¡ç‰‡é¡¯ç¤ºç¨å¾®å°ä¸€é»çš„ç·¨è™Ÿé¡è‰²ï¼Œè¡¨å±¤å¡ç‰‡é¡¯ç¤ºäº®ä¸€é»
            const numColor = isRoot ? '#e74c3c' : (isBuried ? '#888' : '#3498db');
            
            el.innerHTML += `<div style="position:absolute; top:2px; left:2px; font-size:10px; color:${numColor}; font-weight:bold; z-index:10;">#${index+1}</div>
                            <div class="card-text">${card.text}</div>`;
            
            // é»æ“Šé¸å–é‚è¼¯
            el.onclick = () => {
                if (selectedCardsInModal.includes(card.id)) {
                    selectedCardsInModal = selectedCardsInModal.filter(id=>id!==card.id);
                    el.classList.remove('selected');
                } else {
                    selectedCardsInModal.push(card.id);
                    el.classList.add('selected');
                }
            };
            body.appendChild(el);
        });
        
        // Modal åº•éƒ¨æ§åˆ¶é … (ç¶­æŒä¸è®Š)
        const modalFooter = document.querySelector('#card-selector-modal .modal-content > div:last-child');
        let rotControls = document.getElementById('modal-rotate-controls');
        if (!rotControls && modalFooter) {
            rotControls = document.createElement('div');
            rotControls.id = 'modal-rotate-controls';
            rotControls.style.display = 'inline-flex';
            rotControls.style.gap = '5px';
            rotControls.style.marginRight = '10px';
            rotControls.innerHTML = `
                <button onclick="rotateSelectedInModal(-90)" style="background:#7f8c8d;">â†¶</button>
                <button onclick="rotateSelectedInModal(90)" style="background:#7f8c8d;">â†·</button>
            `;
            modalFooter.insertBefore(rotControls, modalFooter.firstChild);
        }

        document.getElementById('card-selector-modal').style.display = 'flex';
    }
	
	// --- [æ–°å¢] åœ¨æ¸…å–®è¦–çª—å…§æ—‹è½‰å¡ç‰‡ ---
	function rotateSelectedInModal(deg) {
		if (selectedCardsInModal.length === 0) {
			alert(t('msg_select_rotate'));
			return;
		}

		// 1. åŸ·è¡Œæ—‹è½‰å‹•ä½œ
		addOperation({ type: 'ROTATE_CARD', cardIds: [...selectedCardsInModal], deg: deg });
		
		// 2. ç‚ºäº†è®“ä½¿ç”¨è€…ç«‹åˆ»çœ‹åˆ°çµæœï¼Œæˆ‘å€‘éœ€è¦é‡æ–°æ•´ç†è¦–çª—å…§å®¹
		// é›–ç„¶ addOperation æœƒè§¸ç™¼ renderUIï¼Œä½†ä¸æœƒé‡ç¹ª modal å…§å®¹ï¼Œæ‰€ä»¥è¦æ‰‹å‹•å‘¼å«
		const zoneId = document.getElementById('modal-title').getAttribute('data-zone-id');
		if (zoneId) {
			// ç¨å¾®å»¶é²ä¸€ä¸‹ç¢ºä¿ State æ›´æ–°å¾Œå†é‡ç¹ª
			setTimeout(() => {
				openSelectorModal(zoneId);
				
				// æ¢å¾©é¸å–ç‹€æ…‹ (UX å„ªåŒ–ï¼šæ—‹è½‰å®Œä¸è¦å–æ¶ˆé¸å–ï¼Œæ–¹ä¾¿é€£çºŒè½‰)
				// æ³¨æ„ï¼šopenSelectorModal æœƒæ¸…ç©º selectedCardsInModalï¼Œæ‰€ä»¥æˆ‘å€‘è¦é‡æ–°é¸ä¸Š
				// é€™è£¡éœ€è¦å…¨åŸŸè®Šæ•¸é…åˆï¼Œä½†ç°¡å–®çš„åšæ³•æ˜¯è®“ä½¿ç”¨è€…é‡é¸ï¼Œæˆ–è€…
				// æˆ‘å€‘å¯ä»¥è®“ openSelectorModal æ”¯æ´å‚³å…¥ã€Œé é¸IDã€ï¼Œä½†ç‚ºäº†ä¸æ”¹å‹•å¤ªå¤šæ¶æ§‹ï¼Œé€™è£¡å…ˆè®“ä½¿ç”¨è€…çœ‹åˆ°çµæœå³å¯ã€‚
			}, 50);
		}
	}

    function closeSelectorModal() { document.getElementById('card-selector-modal').style.display = 'none'; }
    function prepareMove(shuffle) {
        if(selectedCardsInModal.length===0) return;
        pendingMove = { cardIds: [...selectedCardsInModal], shuffle };
        closeSelectorModal();
        updateSelectionUI();
    }

	function openPositionSelector(zoneId, moveData) {
		const modal = document.getElementById('position-selector-modal');
		const list = document.getElementById('position-list');
		const gui = document.getElementById('stack-gui');
		
		document.getElementById('pos-modal-title').innerText = t('msg_insert_pos_title');
		gui.style.display = 'none';
		list.style.display = 'flex'; 
		list.innerHTML = ''; 
		
		const state = getCurrentDisplayState();
		const cards = getCardsInZone(state, zoneId);

		// [ä¿®æ”¹] åå‘æ’åˆ—é‚è¼¯ï¼šè®“è¦–è¦ºä¸Šæ–¹ = ç‰Œåº«é ‚ (Array Last)

		// 1. å…ˆæ”¾ã€Œæœ€é ‚ç«¯ã€çš„æ’æ§½ (ç´¢å¼• = length)ï¼Œé€™ä»£è¡¨æ’åœ¨æ•´å‰¯ç‰Œçš„æœ€ä¸Šé¢
		// æˆ‘å€‘çµ¦å®ƒæ¨™ç¤º "Top" (è‹¥æ‚¨çš„ç¿»è­¯æª”æœ‰ val_top å¯æ”¹ç”¨ t('val_top'))
		list.appendChild(createSlotElement(cards.length, "Top", zoneId, true));
		
		// 2. å€’åºæ”¾å…¥å¡ç‰‡èˆ‡å…¶ä¸‹æ–¹çš„æ’æ§½
		for (let i = cards.length - 1; i >= 0; i--) {
			const card = cards[i];
			
			// å¡ç‰‡æœ¬é«” (åƒè€ƒç”¨)
			const refCard = document.createElement('div');
			refCard.className = 'position-card-ref';
			
			if (card.image && (globalImageRegistry[card.imageKey] || globalImageRegistry[card.backImageKey])) {
				const imgKey = card.imageKey || card.backImageKey;
				refCard.style.backgroundImage = `url(${globalImageRegistry[imgKey]})`;
				refCard.classList.add('has-image-icon');
				refCard.innerHTML = `<span style="display:none;">${card.text}</span>`;
			} else {
				refCard.innerHTML = `<span style="padding:2px; word-break:break-all; line-height:1;">${card.text}</span>`;
			}
			
			const idxBadge = document.createElement('div');
			idxBadge.style.cssText = "position:absolute; top:0; left:0; background:rgba(0,0,0,0.6); color:white; font-size:8px; padding:1px 3px; border-bottom-right-radius:3px;";
			idxBadge.innerText = i + 1;
			refCard.appendChild(idxBadge);
			
			list.appendChild(refCard);

			// 3. æ”¾å…¥è©²å¡ç‰‡ä¸‹æ–¹çš„æ’æ§½ (ç´¢å¼• = i)
			// å¦‚æœ i=0ï¼Œä»£è¡¨é€™æ˜¯æœ€åº•éƒ¨çš„æ’æ§½ï¼Œæ¨™ç¤º "Bottom"
			const isBottom = (i === 0);
			list.appendChild(createSlotElement(i, isBottom ? "Bottom" : "", zoneId, isBottom));
		}

		modal.style.display = 'flex';
	}

    // å»ºç«‹æ’æ§½çš„è¼”åŠ©å‡½å¼
    function createSlotElement(index, text, zoneId, isTop) {
        const div = document.createElement('div');
        div.className = 'position-slot';
        
        // å¦‚æœæœ‰å‚³å…¥æ–‡å­—(åº•/é ‚)å°±é¡¯ç¤ºæ–‡å­—ï¼Œå¦å‰‡é¡¯ç¤ºä¸€å€‹ '+'
        if (text) {
            div.innerHTML = `<span style="font-weight:bold; ${isTop ? 'color:#e74c3c;' : ''}">${text}</span>`;
        } else {
            div.innerHTML = `<span style="opacity:0.3; font-size:1.2rem;">+</span>`;
        }
        
        div.title = `æ’å…¥è‡³ç¬¬ ${index} å¼µç‰Œçš„ä½ç½®`;
        div.onclick = () => finishMove(zoneId, index);
        return div;
    }

    function closePositionModal() {
        document.getElementById('position-selector-modal').style.display = 'none';
    }

    window.addEventListener('beforeunload', (e) => {
        if (storageQuotaExceeded) {
            e.preventDefault();
            e.returnValue = 'å„²å­˜ç©ºé–“å·²æ»¿ï¼Œæ‚¨çš„è³‡æ–™å¯èƒ½å°šæœªå„²å­˜ã€‚å»ºè­°å…ˆåŒ¯å‡ºè³‡æ–™ã€‚';
            return e.returnValue;
        }
    });

	// --- [æ–°å¢] æ‰‹æ©Ÿç‰ˆåŠ‡æœ¬é¸æ“‡å™¨é‚è¼¯ ---
    // --- [ä¿®æ­£] æ‰‹æ©Ÿç‰ˆåŠ‡æœ¬é¸æ“‡å™¨é‚è¼¯ (å«é é¸ä¿®å¾©) ---
    let selectedMobileScript = null;

    function showMobileScriptSelector(defaultFilename) {
        const modal = document.getElementById('mobile-script-selector');
        const listBody = document.getElementById('script-list-body');
        const startBtn = document.getElementById('btn-mobile-start');
        
        listBody.innerHTML = '';
        selectedMobileScript = null;
        startBtn.disabled = true;

        // 1. è™•ç†å‚³å…¥çš„é è¨­å€¼ (ç§»é™¤è·¯å¾‘å‰ç¶´ï¼Œåªç•™æª”åï¼Œä»¥é˜²åƒæ•¸å¸¶æœ‰ scripts/)
        const cleanDefault = defaultFilename ? defaultFilename.replace(/^scripts\//, '') : '';

        // 2. æ¸²æŸ“æ¸…å–® (ä¿®æ”¹ï¼šä½¿ç”¨ [...].reverse() å€’åºå‘ˆç¾ï¼Œè®“æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
        [...AVAILABLE_SCRIPTS].reverse().forEach(script => {
            const el = document.createElement('div');
            el.className = 'script-item';
			
			// [æ–°å¢] å–å¾—èªè¨€ä»£ç¢¼ï¼Œé è¨­ç‚º ZH
            const langCode = script.lang || 'zh';
            
            // [ä¿®æ”¹] æ’å…¥ .script-item-lang
            el.innerHTML = `
                <div class="script-item-title">${script.title}</div>
                <div class="script-item-desc">${script.description}</div>
                <div class="script-item-lang">${langCode}</div>
            `;
            
            // é»æ“Šäº‹ä»¶
            el.onclick = () => {
                document.querySelectorAll('.script-item').forEach(i => i.classList.remove('selected'));
                el.classList.add('selected');
                selectedMobileScript = script.filename;
                startBtn.disabled = false;
            };

            // 3. [ä¿®æ­£] é é¸é‚è¼¯ (æ¯”å°ç´”æª”å)
            const cleanScript = script.filename.replace(/^scripts\//, '');
            
            if (cleanDefault && cleanScript === cleanDefault) {
                // åŠ æ¨£å¼
                el.classList.add('selected');
                // è¨­å®šå€¼
                selectedMobileScript = script.filename;
                // é–‹æŒ‰éˆ•
                startBtn.disabled = false;
                
                // [æ–°å¢] è‡ªå‹•æ²å‹•åˆ°è©²é …ç›® (å»¶é²ä¸€ä¸‹ç¢ºä¿ DOM æ¸²æŸ“å®Œç•¢)
                setTimeout(() => {
                    el.scrollIntoView({ block: 'center', behavior: 'smooth' });
                }, 100);
            }

            listBody.appendChild(el);
        });

        // é¡¯ç¤ºä»‹é¢
        modal.style.display = 'flex';
    }

	// --- [ä¿®æ”¹] é€šç”¨è¨ˆæ•¸å™¨è¼‰å…¥å‡½å¼ (åœ–ç‰‡ç‰ˆ) ---
    function updateVisitorCounter(targetUrl) {
        const counterDiv = document.getElementById('visitor-counter');
        
        // 1. å¦‚æœæ²’æœ‰ç¶²å€ï¼Œå°±éš±è—è¨ˆæ•¸å™¨ä¸¦é›¢é–‹
        if (!targetUrl) {
            counterDiv.style.display = 'none';
            counterDiv.innerHTML = '';
            return;
        }

        // 2. æ¸…ç©ºèˆŠçš„ï¼Œé¡¯ç¤ºå®¹å™¨
        counterDiv.innerHTML = '';
        counterDiv.style.display = 'block';

        // 3. å»ºç«‹ Iframe
        const iframe = document.createElement('iframe');
        iframe.style.width = "120px";
        iframe.style.height = "25px";
        iframe.style.border = "none";
        iframe.style.overflow = "hidden";
        iframe.scrolling = "no";
        
        counterDiv.appendChild(iframe);

        // 4. [é—œéµä¿®æ”¹] æ”¹ç”¨ img æ¨™ç±¤ä¾†è¼‰å…¥
        const doc = iframe.contentWindow.document;
        doc.open();
        // è¨­å®š body æ¨£å¼è®“åœ–ç‰‡å‚ç›´ç½®ä¸­
        doc.write(`<body style="margin:0; padding:0; background:transparent; display:flex; align-items:center;">`);
        
        // èˆŠçš„å¯«æ³• (éŒ¯èª¤åŸå› )ï¼š doc.write(`<script src="${targetUrl}"><\/script>`);
        // æ–°çš„å¯«æ³• (æ­£ç¢º)ï¼šç•¶ä½œåœ–ç‰‡è¼‰å…¥
        doc.write(`<img src="${targetUrl}" alt="counter" border="0" style="display:block;">`);
        
        doc.write(`</body>`);
        doc.close();
    }
	
    function confirmMobileScript() {
		if (!selectedMobileScript) return;
		document.getElementById('mobile-script-selector').style.display = 'none';
		const timestamp = Date.now();
		const fullPath = 'scripts/' + selectedMobileScript + '?v=' + timestamp;
		initMobileMode(fullPath);
		
		const scriptData = AVAILABLE_SCRIPTS.find(s => s.filename === selectedMobileScript);
		currentScriptConfig = scriptData;

		// --- èªè¨€è¨­å®šé‚è¼¯ ---
		const urlLang = getUrlParameter('lang');
		const scriptLang = (scriptData && scriptData.lang) ? scriptData.lang : 'zh';

		let targetLang = 'zh';
		// [ä¿®æ”¹] å…è¨±ç¶²å€åƒæ•¸å¸¶å…¥ 'tw'
		if (urlLang && ['zh', 'en', 'jp', 'tw'].includes(urlLang)) {
			targetLang = urlLang;
		} else {
			targetLang = scriptLang;
		}

		// [æ–°å¢] é—œéµæ””æˆªï¼šå¦‚æœæ˜¯ 'tw'ï¼Œå¼·åˆ¶è½‰å› 'zh' è®“ç³»çµ±é‹ä½œæ­£å¸¸
		if (targetLang === 'tw') {
			targetLang = 'zh';
		}

		changeLanguage(targetLang);
		// -------------------

		const langSelect = document.getElementById('lang-select');
		if (langSelect) langSelect.value = targetLang;

		let targetSpeed = 1.0;
		if (scriptData && scriptData.speed !== undefined) {
			targetSpeed = scriptData.speed;
		}
		changePlaybackSpeed(targetSpeed);

		globalAudioPlayer.muted = true;
		globalAudioPlayer.play().catch(e => { console.log("Audio context unlocked (muted)"); });

		let urlToLoad = (scriptData && scriptData.counter_url) ? scriptData.counter_url : null;
		updateVisitorCounter(urlToLoad);
		
		updateMuteButtonUI();
	}
	
	// --- [æ–°å¢] åŒ¯å…¥é¸æ“‡å™¨é‚è¼¯ ---

    // 1. é–‹å•Ÿè¦–çª—ä¸¦æ¸²æŸ“æ¸…å–®
    function openImportModal() {
        const modal = document.getElementById('import-selector-modal');
        const listEl = document.getElementById('import-script-list');
        
        listEl.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹

        // ä½¿ç”¨ [...].reverse() è¤‡è£½ä¸¦å€’åºï¼Œè®“æœ€æ–°çš„åŠ‡æœ¬åœ¨æœ€ä¸Šé¢
        const reversedScripts = [...AVAILABLE_SCRIPTS].reverse();

        if (reversedScripts.length === 0) {
            listEl.innerHTML = `<div style="padding:20px; text-align:center; color:#999;">${t('lbl_no_script')}</div>`;
        } else {
            reversedScripts.forEach(script => {
                const item = document.createElement('div');
                item.className = 'import-script-item';
                
                // èªè¨€æ¨™ç±¤
                const lang = script.lang || 'zh';
                
                item.innerHTML = `
                    <div class="import-script-title">${script.title}</div>
                    <div class="import-script-desc">${script.description}</div>
                    <div class="import-script-lang">${lang}</div>
                `;
                
                // é»æ“Šè¼‰å…¥
                item.onclick = () => loadInternalScript(script);
                
                listEl.appendChild(item);
            });
        }

        modal.style.display = 'flex';
    }

    // 2. è§¸ç™¼æœ¬åœ°æª”æ¡ˆé¸æ“‡ (æ¨¡æ“¬é»æ“ŠåŸæœ¬çš„ input)
    function triggerLocalImport() {
        document.getElementById('import-selector-modal').style.display = 'none';
        document.getElementById('import-input').click();
    }

    // 3. è¼‰å…¥å…§å»ºåŠ‡æœ¬ (Fetch & Load)
    function loadInternalScript(scriptData) {
		if (!confirm(t('msg_confirm_load_script').replace('{title}', scriptData.title))) return;
		
		currentScriptConfig = scriptData;
		document.getElementById('import-selector-modal').style.display = 'none';
		const path = 'scripts/' + scriptData.filename + '?v=' + Date.now();

		console.log("Loading script:", path);
		fetch(path, { cache: "no-store" })
			.then(res => {
				if(!res.ok) throw new Error(`HTTP ${res.status}`);
				return res.json();
			})
			.then(data => {
				if(!data.history || !data.initialState) throw new Error("Invalid script format");
				processGameData(data, true);

				// [ä¿®æ”¹] èªè¨€è¨­å®šèˆ‡æ””æˆª
				if (scriptData.lang) {
					let lang = scriptData.lang;
					// â˜… é—œéµä¿®æ­£ï¼šå¦‚æœæ˜¯ 'tw'ï¼Œé¨™ç³»çµ±èªªæ˜¯ 'zh'
					// é€™æ¨£æ¥ä¸‹ä¾†çš„ changeLanguage('zh') æœƒè¼‰å…¥ç¹ä¸­å­—å…¸
					// ä¸‹é¢çš„ alert(t('msg_import_success')) å°±èƒ½æ­£ç¢ºé¡¯ç¤ºä¸­æ–‡
					if (lang === 'tw') lang = 'zh'; 
					
					changeLanguage(lang);
				}

				if (scriptData.speed) changePlaybackSpeed(scriptData.speed);
				if (scriptData.counter_url) updateVisitorCounter(scriptData.counter_url);
				
				alert(t('msg_import_success'));
			})
			.catch(err => {
				console.error(err);
				alert(t('msg_import_fail') + ": " + err.message);
			});
	}

// --- æ–°å¢çš„æ‰‹æ©Ÿç«¯é‚è¼¯ ---

    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

	function initMobileMode(scriptUrl) {
		// document.body.classList.add('mobile-mode'); // é€™è¡Œ onload å·²ç¶“åŠ éäº†ï¼Œé€™è£¡å¯ä»¥è¨»è§£æˆ–ä¿ç•™çš†å¯
		
		if (isMobileDevice()) {
			globalAudioPlayer.muted = true;
		} 

        let finalUrl = scriptUrl;
        if (!finalUrl.includes('?')) {
             finalUrl += '?v=' + Date.now();
        }

		fetch(finalUrl, { cache: "no-store", headers: { 'Cache-Control': 'no-cache' } })
			.then(res => { if(!res.ok) throw new Error(res.status); return res.json(); })
			.then(data => {
				if(!data.history || !data.initialState) throw new Error("Invalid script");
				processGameData(data, true);
				
				// [ä¿®æ­£] é€™è£¡ä¸éœ€è¦å† addEventListener äº†ï¼Œå› ç‚º onload å·²ç¶“åšé
				// window.addEventListener('resize', handleOrientation);
				// window.addEventListener('orientationchange', handleOrientation);
				
				// è³‡æ–™è¼‰å…¥å®Œæˆï¼Œæ‰‹å‹•è§¸ç™¼ä¸€æ¬¡åˆ¤æ–·ï¼Œé€™æœƒå•Ÿå‹•è‡ªå‹•æ’­æ”¾ (å› ç‚ºæ­¤æ™‚ isGameActive ç‚º true)
				handleOrientation();
			})
			.catch(e => {
				alert("ç„¡æ³•è¼‰å…¥åŠ‡æœ¬: " + e.message);
			});
	}

	function handleOrientation() {
        const overlay = document.getElementById('orientation-overlay');
		const controls = document.getElementById('mobile-controls');
		const selector = document.getElementById('mobile-script-selector');
        
        // [ä¿®æ­£] ä½¿ç”¨æ›´å¯é çš„éŠæˆ²ç‹€æ…‹æª¢æŸ¥ï¼šåŠ‡æœ¬æ˜¯å¦å·²è¼‰å…¥ (history æ˜¯å¦æœ‰å…§å®¹)
        // å¿…é ˆç¢ºä¿ history è®Šæ•¸åœ¨å…¨å±€ç¯„åœå…§æ˜¯å¯è¨ªå•çš„
        const isGameLoaded = (typeof history !== 'undefined' && history.length > 0);
        
		const isLandscape = window.innerWidth > window.innerHeight;
        
        if (isLandscape) {
            // --- æ©«å‘æ¨¡å¼ ---
			overlay.style.display = 'none'; // éš±è—æ—‹è½‰æç¤º
            
            // åªæœ‰ç•¶åŠ‡æœ¬å·²è¼‰å…¥æ™‚ï¼Œæ‰é¡¯ç¤ºæ§åˆ¶åˆ—ä¸¦åŸ·è¡Œæ’­æ”¾é‚è¼¯
			if (controls && isGameLoaded) {
                controls.style.display = 'flex'; 
                
                // [ä¿®æ­£] å¼·åˆ¶éš±è—é¸æ“‡å™¨ï¼Œå› ç‚ºéŠæˆ²å·²è¼‰å…¥ï¼Œé¸æ“‡å™¨ä¸æ‡‰å†å‡ºç¾
                if (selector) selector.style.display = 'none'; 

                // --- æ¢å¾©è‡ªå‹•æ’­æ”¾åŠŸèƒ½ ---
                // [éœ€æ±‚2] ç¬¬ä¸€æ¬¡é€²å…¥æ©«å‘ -> è‡ªå‹•æ’­æ”¾
                if (!hasEnteredLandscapeOnce) {
                    hasEnteredLandscapeOnce = true;
                    if (!playTimeout) togglePlay(); 
                } 
                // [éœ€æ±‚2] éç¬¬ä¸€æ¬¡ï¼Œæª¢æŸ¥ã€Œè½‰ç›´å‰ã€æ˜¯å¦ç‚ºæ’­æ”¾ç‹€æ…‹
                else if (wasPlayingBeforePortrait) {
                    if (!playTimeout) togglePlay(); // æ¢å¾©æ’­æ”¾
                    wasPlayingBeforePortrait = false; // é‡ç½®ç‹€æ…‹
                }
                // --- çµæŸè‡ªå‹•æ’­æ”¾åŠŸèƒ½ ---
            } else {
                 // éŠæˆ²å°šæœªè¼‰å…¥ï¼Œç¢ºä¿ controls éš±è—
                 if (controls) controls.style.display = 'none';
            }
            
            // å»¶é²å¾ŒåŸ·è¡Œç¸®æ”¾ï¼Œè®“ä½ˆå±€ç©©å®š
            setTimeout(autoScaleBoard, 100); 

        } else {
            // --- ç›´å‘æ¨¡å¼ (æš«åœ/é¸æ“‡åŠ‡æœ¬) ---
            if (isGameLoaded) {
                // éŠæˆ²å·²ç¶“é–‹å§‹ï¼Œå¼·åˆ¶é¡¯ç¤ºæç¤ºä¸¦æš«åœ
			    overlay.style.display = 'flex'; 
			    if (controls) controls.style.display = 'none';
                
                // [éœ€æ±‚1] è½‰ç›´å°±æš«åœï¼Œä¸¦è¨˜éŒ„ç‹€æ…‹
			    if (playTimeout) {
                    wasPlayingBeforePortrait = true; 
				    togglePlay(); 
			    } else {
				    wasPlayingBeforePortrait = false; 
			    }
            } else {
                // éŠæˆ²å°šæœªé–‹å§‹ (æ­£åœ¨é¸æ“‡åŠ‡æœ¬)ï¼Œé¡¯ç¤ºé¸æ“‡å™¨
                overlay.style.display = 'none';
                if (selector) selector.style.display = 'flex'; // ç¢ºä¿ç›´å‘æ™‚é¸æ“‡å™¨é¡¯ç¤º
                if (controls) controls.style.display = 'none';
            }
        }
    }
	
	// --- [ä¿®æ­£ç‰ˆ] æ‰‹æ©Ÿç‰ˆéŸ³æ¨‚é–‹é—œ (å¼·åˆ¶åŒæ­¥ç‹€æ…‹) ---
	function toggleMobileMusic() {
		const btn = document.getElementById('mob-music-btn');
		
		// 1. åˆ‡æ›éœéŸ³ç‹€æ…‹
		globalAudioPlayer.muted = !globalAudioPlayer.muted;
		
		// 2. å¦‚æœæ˜¯ã€Œè§£é™¤éœéŸ³ã€(è¦è½éŸ³æ¨‚)
		if (!globalAudioPlayer.muted) {
			
			// A. å–å¾—ç•¶å‰ç›¤é¢ç‹€æ…‹
			const state = getCurrentDisplayState();
			const currentBgm = state ? state.bgm : null;

			if (currentBgm) {
				// B. æª¢æŸ¥æ’­æ”¾å™¨æ˜¯å¦å·²ç¶“è¼‰å…¥é€™é¦–æ­Œ
				// æ³¨æ„ï¼šBGM_FOLDER è®Šæ•¸å¿…é ˆå­˜åœ¨ (é è¨­æ˜¯ 'bgm/')
				const targetSrc = BGM_FOLDER + currentBgm;
				
				// å¦‚æœé‚„æ²’è¨­å®š srcï¼Œæˆ–è€… src ä¸å°ï¼Œå°±å¼·åˆ¶è¨­å®š
				// encodeURI æ˜¯ç‚ºäº†è™•ç†æª”åå¯èƒ½æœ‰ç©ºç™½æˆ–ç‰¹æ®Šå­—å…ƒ
				if (!globalAudioPlayer.src || !globalAudioPlayer.src.includes(encodeURI(currentBgm))) {
					console.log(`[MobileMusic] åˆå§‹åŒ–è¼‰å…¥éŸ³æ¨‚: ${currentBgm}`);
					globalAudioPlayer.src = targetSrc;
				}

				// C. å¼·åˆ¶æ’­æ”¾ (å› ç‚ºé€™æ˜¯åœ¨ click äº‹ä»¶ä¸­ï¼Œç€è¦½å™¨æœƒå…è¨±)
				const playPromise = globalAudioPlayer.play();
				
				if (playPromise !== undefined) {
					playPromise.then(() => {
						console.log("[MobileMusic] æ’­æ”¾æˆåŠŸ");
					})
					.catch(error => {
						console.error("[MobileMusic] æ’­æ”¾å¤±æ•— (å¯èƒ½æ˜¯æª”æ¡ˆè·¯å¾‘éŒ¯èª¤æˆ–ç€è¦½å™¨é˜»æ“‹):", error);
						// å¦‚æœå¤±æ•—ï¼Œå¯èƒ½æ˜¯æª”æ¡ˆæ‰¾ä¸åˆ°ï¼Œç‚ºé¿å…æŒ‰éˆ•ç‹€æ…‹é¡¯ç¤ºç‚ºæ’­æ”¾ä½†æ²’è²éŸ³ï¼Œå¯è¦–æƒ…æ³è™•ç†
					});
				}
			} else {
				console.log("[MobileMusic] ç•¶å‰åŠ‡æœ¬æ­¥é©Ÿæ²’æœ‰è¨­å®š BGM");
			}
		} else {
			// å¦‚æœæ˜¯ã€Œè¨­ç‚ºéœéŸ³ã€ï¼Œå°±ä¸ç”¨æš«åœï¼Œåªè¦ mute å³å¯ï¼Œä¿æŒé€²åº¦
			// ä½†å¦‚æœæ‚¨å¸Œæœ›éœéŸ³å°±æš«åœçœé›»ï¼Œä¹Ÿå¯ä»¥åŠ ä¸Š globalAudioPlayer.pause();
		}

		// 3. æ›´æ–°æŒ‰éˆ• UI
		updateMobileMusicUI();
	}

	// æ›´æ–°éŸ³æ¨‚æŒ‰éˆ•çš„å¤–è§€ (ç´…/ç¶ /åœ–ç¤º)
	function updateMobileMusicUI() {
		const btn = document.getElementById('mob-music-btn');
		if (!btn) return;

		if (globalAudioPlayer.muted) {
			btn.innerText = "ğŸ”‡";
			btn.classList.remove('active'); // æ²’äº®ç‡ˆä»£è¡¨éœéŸ³
		} else {
			btn.innerText = "ğŸ”Š";
			btn.classList.add('active'); // äº®ç‡ˆä»£è¡¨æ’­æ”¾ä¸­
		}
	}

    function autoScaleBoard() {
        const workspace = document.getElementById('workspace');
        if (!workspace) return;

        // 1. è¨­å®šè™›æ“¬ç•«å¸ƒå°ºå¯¸ (é…åˆ CSS ä¿®æ”¹ç‚º 1600)
        const VIRTUAL_WIDTH = 1600; 
        const VIRTUAL_HEIGHT = 800;

        // 2. å–å¾—è¢å¹•å°ºå¯¸
        const screenW = window.innerWidth;
        const screenH = window.innerHeight;

        // 3. è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹
        const scaleW = screenW / VIRTUAL_WIDTH;
        const scaleH = screenH / VIRTUAL_HEIGHT;
        let scale = Math.min(scaleW, scaleH);
        
        scale = scale * 0.98; // ç•™ä¸€é»é‚Šè·

        // 4. è¨ˆç®—ç½®ä¸­åç§»
        const offsetX = (screenW - VIRTUAL_WIDTH * scale) / 2;
        const offsetY = (screenH - VIRTUAL_HEIGHT * scale) / 2;

        // 5. æ‡‰ç”¨æ¨£å¼
        workspace.style.transform = `scale(${scale})`;
        workspace.style.left = `${offsetX}px`;
        workspace.style.top = `${offsetY}px`;
        
        // é‡ç¹ª SVG
        const svg = document.getElementById('svg-layer');
        if(svg) {
            svg.style.display = 'none';
            svg.offsetHeight; 
            svg.style.display = 'block';
        }
    }

    // ç›£è½è½‰å‘èˆ‡è¦–çª—è®ŠåŒ–
    window.addEventListener('resize', () => {
        if(document.body.classList.contains('mobile-mode')) {
             requestAnimationFrame(() => {
                 const isLandscape = window.innerWidth > window.innerHeight;
                 if(isLandscape) autoScaleBoard();
             });
        }
    });
	
	// --- [æ–°å¢] é–‹å•Ÿé—œæ–¼è¦–çª— ---
    function openAboutModal() {
        document.getElementById('about-modal').style.display = 'flex';
    }

	/*
    // æ”¹å¯« togglePlay ä»¥åŒæ­¥æ›´æ–°æ‰‹æ©Ÿç‰ˆæŒ‰éˆ•æ–‡å­—
    const originalTogglePlay = togglePlay;
    togglePlay = function() {
        // å‘¼å«åŸæœ¬çš„é‚è¼¯
        originalTogglePlay();
        
        // æ›´æ–°æ‰‹æ©Ÿç‰ˆæŒ‰éˆ•
        const mobBtn = document.getElementById('mob-play-btn');
        const deskBtn = document.getElementById('btn-play');
        
        // [Bug åŸå› ] é€™è£¡é‚„åœ¨ç”¨èˆŠè®Šæ•¸ playIntervalï¼Œå°è‡´åˆ¤æ–·éŒ¯èª¤
        const icon = playInterval ? "â¸" : "â–¶"; 
        if(mobBtn) mobBtn.innerText = icon;
    };
	*/
	
	// --- [æ–°å¢] å°ç™½åŒ¯å‡º/åŒ¯å…¥ç³»çµ± ---

    // 1. åŒ¯å‡ºå°ç™½ç‚º JSON
    function exportDialogueJson() {
        const exports = [];
        
        history.forEach((step, index) => {
            if (!step.action || !step.action.operations) return;
            
            // æ‰¾å‡ºè©²æ­¥é©Ÿæ˜¯å¦åŒ…å« DIALOGUE æ“ä½œ
            const op = step.action.operations.find(o => o.type === 'DIALOGUE');
            if (op && op.data) {
                const item = {
                    id: index, // è¨˜ä½åŸæœ¬çš„æ­¥é©Ÿç´¢å¼•
                    // åªæå–éœ€è¦çš„æ¬„ä½
                    p1: op.data.p1.active ? { name: op.data.p1.name, text: op.data.p1.dataText } : null,
                    p2: op.data.p2.active ? { name: op.data.p2.name, text: op.data.p2.dataText } : null
                };
                exports.push(item);
            }
        });

        if (exports.length === 0) {
            alert(t('msg_no_dialog'));
            return;
        }

        const jsonStr = JSON.stringify(exports, null, 2);
        const blob = new Blob([jsonStr], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `dialogue_export_${Date.now()}.json`;
        a.click();
    }

    // 2. åŒ¯å…¥ä¸¦æ›¿æ›å°ç™½
    function importDialogueJson(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imports = JSON.parse(e.target.result);
                if (!Array.isArray(imports)) throw new Error("æ ¼å¼éŒ¯èª¤ï¼šæ ¹ç›®éŒ„å¿…é ˆæ˜¯é™£åˆ—");

                let updateCount = 0;

                imports.forEach(item => {
                    // 1. æª¢æŸ¥ç´¢å¼•æ˜¯å¦æœ‰æ•ˆ
                    if (item.id === undefined || item.id >= history.length) return;

                    const step = history[item.id];
                    const op = step.action.operations.find(o => o.type === 'DIALOGUE');

                    // 2. ç¢ºä¿ç›®æ¨™æ­¥é©ŸçœŸçš„æ˜¯å°è©± (é˜²å‘†)
                    if (!op || !op.data) return;

                    let hasChange = false;

                    // 3. æ›´æ–° P1
                    if (item.p1 && op.data.p1 && op.data.p1.active) {
                        op.data.p1.name = item.p1.name;
                        op.data.p1.dataText = item.p1.text;
                        // åŒæ­¥æ›´æ–°ç•¶å‰ç‹€æ…‹å¿«ç…§ (è®“ç•«é¢ç«‹åˆ»è®Šæ›´ï¼Œä¸ç”¨é‡è·‘)
                        if (step.state.dialogueData && step.state.dialogueData.p1) {
                            step.state.dialogueData.p1.name = item.p1.name;
                            step.state.dialogueData.p1.dataText = item.p1.text;
                        }
                        hasChange = true;
                    }

                    // 4. æ›´æ–° P2
                    if (item.p2 && op.data.p2 && op.data.p2.active) {
                        op.data.p2.name = item.p2.name;
                        op.data.p2.dataText = item.p2.text;
                        if (step.state.dialogueData && step.state.dialogueData.p2) {
                            step.state.dialogueData.p2.name = item.p2.name;
                            step.state.dialogueData.p2.dataText = item.p2.text;
                        }
                        hasChange = true;
                    }

                    // 5. æ›´æ–° Action Log çš„æè¿°æ–‡å­— (Description)
                    if (hasChange) {
                        let newDesc = "[å°è©±] "; // é€™è£¡å¯ä»¥æ ¹æ“šç•¶å‰èªè¨€è®Šæ•¸èª¿æ•´ï¼Œæˆ–ä¿æŒå›ºå®š
                        // ç‚ºäº†è®“ log ç°¡æ½”ï¼Œæˆ‘å€‘åªæŠ“å‰8å€‹å­—
                        if (op.data.p2.active) newDesc += `${op.data.p2.name}: ${op.data.p2.dataText.substr(0,8)}... `;
                        if (op.data.p1.active) newDesc += `${op.data.p1.name}: ${op.data.p1.dataText.substr(0,8)}...`;
                        
                        step.action.description = newDesc;
                        updateCount++;
                    }
                });

                // 6. å®Œæˆå¾Œåˆ·æ–°ä»‹é¢
                renderTimeline(); // æ›´æ–°å·¦å´åˆ—è¡¨æ–‡å­—
                renderUI();       // æ›´æ–°ä¸­å¤®ç•«é¢æ–‡å­—
                saveToStorage();  // å­˜æª”
                
                alert(t('msg_trans_result').replace('{n}', updateCount));
                document.getElementById('trans-modal').style.display = 'none';

            } catch (err) {
                console.error(err);
                alert(t('msg_trans_fail_fmt'));
            }
            input.value = ''; // æ¸…ç©º input æ–¹ä¾¿ä¸‹æ¬¡é¸åŒä¸€æª”
        };
        reader.readAsText(file);
    }
	
	// --- [æ ¸å¿ƒ] è¨ˆç®—æ‰€æœ‰å·²è¦‹éçš„å¡ç‰‡ ---
	// è§¸ç™¼æ™‚æ©Ÿï¼šLoad, Setup, SaveDraft, DeleteAction
	function calculateSeenCards() {
		console.time("CheckSeen");
		globalSeenCardIds.clear();

		// å®šç¾©å“ªäº›å€åŸŸæ˜¯ã€Œçµ•å°å…¬é–‹ã€çš„
		// æ³¨æ„ï¼šæ‰‹ç‰Œ(Hand)ã€ç‰Œåº«(Deck)ã€è­·ç›¾(Shield) é è¨­ç‚ºéš±è—ï¼Œé™¤é faceUp
		const publicZones = [
			'p1-battle', 'p2-battle', 'p1-mana', 'p2-mana', 
			'p1-grave', 'p2-grave', 'p1-hyper', 'p2-hyper', 
			'p1-abyss', 'p2-abyss', // åŠ å…¥é€™å…©å€‹
			'reveal-zone'
		];

		// è¼”åŠ©æª¢æŸ¥å‡½å¼
		const checkCard = (card) => {
			if (globalSeenCardIds.has(card.id)) return; // å·²ç¶“æ¨™è¨˜éå°±ä¸é‡è¤‡æª¢æŸ¥

			// æ¢ä»¶ 1: ä½æ–¼å…¬é–‹å€åŸŸ
			// æ¢ä»¶ 2: ä½æ–¼éš±è—å€åŸŸ (Shield/Deck) ä½† faceUp ç‚º true
			// æ³¨æ„ï¼šæ‰‹ç‰Œå³ä½¿ faceUp ç‚º true (å°è‡ªå·±å¯è¦‹)ï¼Œå°è§€çœ¾ä»æ˜¯éš±è—ï¼Œé™¤éé€é reveal-zone å±•ç¤º
			// ä½†ç‚ºäº†åš´è¬¹ï¼Œå¦‚æœåŠ‡æœ¬ä¸­æœ‰æ“ä½œè®“æ‰‹ç‰Œ faceUp ä¸”éè‡ªå·±å›åˆï¼Œç†è«–ä¸Šä¹Ÿæ˜¯ Seen? 
			// é€™è£¡ä¾ç…§æ‚¨çš„å®šç¾©ï¼š[æ²’æœ‰è¢«ä½¿ç”¨éæˆ–é€²å…¥å±•ç¤ºçš„æ‰‹ç‰Œ] = æœªè¦‹ã€‚
			// æ‰€ä»¥æ‰‹ç‰Œå€æˆ‘å€‘ä¸€å¾‹è¦–ç‚º UNSEENï¼Œé™¤éå®ƒæœ‰ç‰¹æ®Š flag (æš«ä¸è€ƒæ…®)ã€‚
			
			if (publicZones.includes(card.zone)) {
				// å…¬é–‹å€åŸŸé€šå¸¸é è¨­å°±æ˜¯ faceUpï¼Œä½†ä¿éšªèµ·è¦‹æˆ‘å€‘åªæª¢æŸ¥å€åŸŸ
				globalSeenCardIds.add(card.id);
			} 
			else if (card.faceUp) {
				// ä½æ–¼ è­·ç›¾ æˆ– ç‰Œåº« ä¸” è¡¨å´
				if (card.zone.includes('shield') || card.zone.includes('deck')) {
					globalSeenCardIds.add(card.id);
				}
			}
		};

		// 1. éæ­·æ­·å²ç´€éŒ„ (History)
		history.forEach(step => {
			if (step.state && step.state.cards) {
				step.state.cards.forEach(checkCard);
			}
		});

		// 2. éæ­·ç•¶å‰ç·¨è¼¯ä¸­çš„ç‹€æ…‹ (Draft)
		// é€™æ˜¯ç‚ºäº†é˜²æ­¢ä½ åœ¨ç·¨è¼¯æ¨¡å¼æŠŠç‰Œä¸Ÿå‡ºå»ï¼Œå»é‚„é¡¯ç¤ºå®ƒæ˜¯æœªè¦‹çš„
		if (isDrafting && tempState && tempState.cards) {
			tempState.cards.forEach(checkCard);
		}

		console.timeEnd("CheckSeen");
		console.log(`[UnseenCheck] Total Seen Cards: ${globalSeenCardIds.size}`);
	}

	// [å„ªåŒ–] é¡¯ç¤ºæœªè¦‹é«˜äº®ï¼šå…¨åŸŸåˆ‡æ› Class
	function toggleUnseenHighlight() {
		isUnseenHighlightOn = !isUnseenHighlightOn;
		
		// æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
		document.querySelectorAll('.unseen-check-btn').forEach(btn => {
			if (isUnseenHighlightOn) btn.classList.add('active');
			else btn.classList.remove('active');
		});

		// éæ­·æ‰€æœ‰å¡ç‰‡ DOMï¼Œæ ¹æ“šå…¨åŸŸ Seen Set é€²è¡Œåˆ‡æ›
		const allCards = document.querySelectorAll('.card');
		allCards.forEach(el => {
			const id = parseInt(el.dataset.id);
			if (isUnseenHighlightOn) {
				if (!globalSeenCardIds.has(id)) {
					el.classList.add('glow-unseen');
				} else {
					el.classList.remove('glow-unseen');
				}
			} else {
				el.classList.remove('glow-unseen');
			}
		});
		// ä¸å‘¼å« renderUI()
	}
	
	window.addEventListener('resize', () => {
		applyBattleZoneScaling();
	});
	
	// è¨­å®šæ•¸é‡ (é»æ“Š 1-6 æŒ‰éˆ•)
    function setMoveQty(n) {
        const input = document.getElementById('dm-qty');
        input.value = n;
        updateQtyBtnState(n);
    }

    // æ›´æ–°æ•¸é‡æŒ‰éˆ•çš„æ¨£å¼ (è®“å°æ‡‰æ•¸å­—è®Šè‰²)
    function updateQtyBtnState(val) {
        val = parseInt(val);
        const btns = document.querySelectorAll('.qty-btn');
        btns.forEach((btn, index) => {
            // index 0 æ˜¯æ•¸å­—1, index 5 æ˜¯æ•¸å­—6
            if ((index + 1) === val) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }
	
	// [æ–°å¢] åˆ‡æ›è“‹ç‰ŒæŒ‰éˆ• (é»æ“Šæ™‚åˆ‡æ›æ¨£å¼) - é‚è¼¯åŒ toggleTapModifier
	function toggleFaceDownModifier(e, el) {
		e.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé¿å…è§¸ç™¼é¸å–å€åŸŸ
		el.classList.toggle('active');
		const icon = el.querySelector('span');
		if (el.classList.contains('active')) {
			// [ON] å•Ÿç”¨ç‹€æ…‹
			el.style.backgroundColor = 'rgba(231, 76, 60, 0.3)'; // ç”¨ç´…è‰²ç³»å€åˆ¥
			if (icon) {
				icon.style.filter = 'none';
				icon.style.opacity = '1';
			}
		} else {
			// [OFF] åœç”¨ç‹€æ…‹
			el.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
			if (icon) {
				icon.style.filter = 'grayscale(100%)';
				icon.style.opacity = '0.5';
			}
		}
	}

	// [æ–°å¢] é‡ç½®è“‹ç‰ŒæŒ‰éˆ• (é–‹é¸å–®æ™‚å‘¼å«)
	function resetFaceDownModifier() {
		const btn = document.getElementById('btn-facedown-modifier');
		if (btn) {
			btn.classList.remove('active');
			btn.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
			const icon = btn.querySelector('span');
			if (icon) {
				icon.style.filter = 'grayscale(100%)';
				icon.style.opacity = '0.5';
			}
		}
	}
	
	// [æ–°å¢] åˆ‡æ›æ©«ç½®æŒ‰éˆ•çš„ç‹€æ…‹
	// [ä¿®æ­£] åˆ‡æ›æ©«ç½®æŒ‰éˆ• (é»æ“Šæ™‚åˆ‡æ›æ¨£å¼)
	function toggleTapModifier(e, el) {
		e.stopPropagation(); // é˜»æ­¢å†’æ³¡
		el.classList.toggle('active');
		const icon = el.querySelector('span');

		if (el.classList.contains('active')) {
			// [ON] å•Ÿç”¨ç‹€æ…‹ï¼šäº®é»ƒè‰²èƒŒæ™¯ + å½©è‰²åœ–ç¤º
			el.style.backgroundColor = 'rgba(255, 215, 0, 0.3)'; 
			if (icon) {
				icon.style.filter = 'none';
				icon.style.opacity = '1';
			}
		} else {
			// [OFF] åœç”¨ç‹€æ…‹ï¼šæ·±é»‘èƒŒæ™¯ + ç°éšåœ–ç¤º
			el.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
			if (icon) {
				icon.style.filter = 'grayscale(100%)';
				icon.style.opacity = '0.5';
			}
		}
	}

	// [æ–°å¢] é‡ç½®æ©«ç½®æŒ‰éˆ• (æ¯æ¬¡é–‹é¸å–®æ™‚å‘¼å«)
	// [ä¿®æ­£] é‡ç½®æŒ‰éˆ•ç‹€æ…‹ (é–‹é¸å–®æ™‚å‘¼å«)
	function resetTapModifier() {
		const btn = document.getElementById('btn-tap-modifier');
		if (btn) {
			// 1. ç§»é™¤é‚è¼¯æ¨™è¨˜
			btn.classList.remove('active');
			
			// 2. [é—œéµ] å¼·åˆ¶é‡ç½®è¦–è¦ºæ¨£å¼ (å›åˆ°æ·±è‰²èƒŒæ™¯)
			btn.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
			
			// 3. é‡ç½®åœ–ç¤ºç‚ºç°è‰²
			const icon = btn.querySelector('span');
			if (icon) {
				icon.style.filter = 'grayscale(100%)';
				icon.style.opacity = '0.5';
			}
		}
	}

    // è¨­å®šç›®æ¨™ (é»æ“Šå€åŸŸæŒ‰éˆ•)
    function setMoveDest(targetVal, btnEl) {
        // æ›´æ–°éš±è—æ¬„ä½
        document.getElementById('dm-target-val').value = targetVal;
        
        // æ›´æ–°è¦–è¦ºæ¨£å¼
        const allBtns = document.querySelectorAll('.dest-btn');
        allBtns.forEach(b => b.classList.remove('active'));
        btnEl.classList.add('active');
    }
	
	// =========================================
    //  DECK CONTEXT MENU LOGIC
    // =========================================
    let contextMenuTargetZone = null; // ç´€éŒ„ç›®å‰æ˜¯å°å“ªå€‹ç‰Œåº«æ“ä½œ ('p1-deck' æˆ– 'p2-deck')

    // 1. é¡¯ç¤ºå³éµé¸å–®
    // 1. é¡¯ç¤ºå³éµé¸å–®
    function showDeckContextMenu(e, zoneId) {
        e.preventDefault(); // é˜»æ­¢ç€è¦½å™¨é è¨­é¸å–®
        contextMenuTargetZone = zoneId;
        
        const menu = document.getElementById('deck-context-menu');
        menu.style.display = 'block';
        
        // è¨­å®šæ°´å¹³ä½ç½® (Xè»¸)
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';

        // åˆ¤æ–·æ–¹å‘ï¼šå¦‚æœæ˜¯ P1 (ä¸‹æ–¹ç©å®¶)ï¼Œé¸å–®å¾€ä¸Šé•·ï¼›å¦‚æœæ˜¯ P2 (ä¸Šæ–¹ç©å®¶)ï¼Œé¸å–®å¾€ä¸‹é•·
        if (zoneId.startsWith('p1')) {
            // translateY(-100%) æœƒæŠŠå…ƒç´ æœ¬èº«çš„ 100% é«˜åº¦å¾€ä¸Šæ¨ï¼Œ
            // è®“å…ƒç´ çš„ã€Œåº•éƒ¨ã€å°é½Šæ»‘é¼ æ¸¸æ¨™
            menu.style.transform = 'translateY(-100%)';
        } else {
            // P2 ç¶­æŒé è¨­ (none)ï¼Œå…ƒç´ çš„ã€Œé ‚éƒ¨ã€å°é½Šæ»‘é¼ æ¸¸æ¨™
            menu.style.transform = 'none';
        }
    }

    // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰é¸å–®
    document.addEventListener('click', function(e) {
        const menu = document.getElementById('deck-context-menu');
        if (menu) menu.style.display = 'none';
    });

    // 2. åŸ·è¡Œé¸å–®å‹•ä½œ
    function runDeckContextAction(action) {
        if (!contextMenuTargetZone) return;

        // éš±è—é¸å–®
        document.getElementById('deck-context-menu').style.display = 'none';

        if (action === 'shuffle') {
            // ç¢ºä¿è™•æ–¼ç·¨è¼¯æ¨¡å¼
            if (!isDrafting) startDraftAtEnd();
            
            // å»ºç«‹æ“ä½œæŒ‡ä»¤
            const op = { type: 'SHUFFLE', zoneId: contextMenuTargetZone };
            
            // 1. åŠ å…¥ç·¨è¼¯ä½‡åˆ—
            addOperation(op);
            
            // 2. ç«‹å³æ‡‰ç”¨åˆ°ç•¶å‰ç•«é¢ (è®“ä½¿ç”¨è€…çœ‹åˆ°çµæœï¼Œä½†ä¸å­˜æª”)
            applyOperation(getCurrentDisplayState(), op);
            
            // 3. é‡æ–°æ¸²æŸ“ç•«é¢
            renderUI();
            
            // è¦–è¦ºç‰¹æ•ˆ (é¸ç”¨)
            triggerShuffleAnimation(10, contextMenuTargetZone);
        } 
        else if (action === 'move') {
			// é‡ç½®æ•¸é‡ç‚º 1
			setMoveQty(1); 
			
			// é‡ç½®ç›®æ¨™ç‚ºæ‰‹ç‰Œ (Hand) - æ¨¡æ“¬é»æ“Šç¬¬ä¸€å€‹æŒ‰éˆ•
			const handBtn = document.querySelector('.dest-btn'); // å‡è¨­ç¬¬ä¸€å€‹æ˜¯ Hand
			if(handBtn) setMoveDest('hand', handBtn);
			
			document.getElementById('deck-move-modal').style.display = 'flex';     
			resetTapModifier();	
			resetFaceDownModifier();	
		}
        else if (action === 'recall') {
            recallAllCards();
        }
    }

    function confirmDeckMove() {
		const qtyInput = document.getElementById('dm-qty-input') || document.getElementById('dm-qty') || document.querySelector('#deck-move-modal input[type="number"]'); 
		const qty = parseInt(qtyInput.value) || 1;
		const targetType = document.getElementById('dm-target-val').value;
		
		if (!contextMenuTargetZone || !targetType) return;

		const state = getCurrentDisplayState();
		const cards = state.cards.filter(c => c.zone === contextMenuTargetZone);
		
		if (cards.length === 0) {
			document.getElementById('deck-move-modal').style.display = 'none';
			return;
		}

		// å–å¾—è¦ç§»å‹•çš„å¡ç‰‡ (å¾é™£åˆ—æœ«ç«¯/ç‰Œåº«é ‚é–‹å§‹æŠ“)
		const cardsToMove = cards.slice(-qty); 
		const cardIds = cardsToMove.map(c => c.id);

		// è§£æç›®æ¨™å€åŸŸ
		const playerPrefix = contextMenuTargetZone.split('-')[0];
		let targetZoneId;
		if (targetType === 'reveal') {
			targetZoneId = 'reveal-zone';
		} else {
			targetZoneId = `${playerPrefix}-${targetType}`;
		}

		// è‹¥éç·¨è¼¯ä¸­ï¼Œé–‹å•Ÿæ–°æ­¥é©Ÿ
		if (!isDrafting) startDraftAtEnd();

		// è¨­å®šå¡ç‰‡ç‹€æ…‹
		let faceUp = true;
		if (targetType === 'shield' || targetType === 'deck') faceUp = false;
		
		// [æ–°å¢] æª¢æŸ¥æˆ°é¬¥å ´æ˜¯å¦é–‹å•Ÿäº†ã€Œè“‹ç‰Œé€²å…¥ã€
		if (targetType === 'battle') {
			const fdBtn = document.getElementById('btn-facedown-modifier');
			if (fdBtn && fdBtn.classList.contains('active')) {
				faceUp = false; // å¼·åˆ¶æ”¹ç‚ºè“‹ç‰Œ
			}
		}
		
		// 1. åŸ·è¡Œç§»å‹•æŒ‡ä»¤ (addOperation æœƒè‡ªå‹•è™•ç†è³‡æ–™æ›´æ–°èˆ‡ renderUI)
		addOperation({ 
			type: 'MOVE', 
			cardIds: cardIds, 
			toZone: targetZoneId, 
			faceUp: faceUp, 
			shuffleSelection: false 
		});

		// 2. é­”åŠ›å€ç‰¹æ®Šè™•ç† (æ©«ç½®/å€’ç½®)
		if (targetType === 'mana') {
			const tapBtn = document.getElementById('btn-tap-modifier');
			const isTapActive = tapBtn && tapBtn.classList.contains('active');
			
			// æ ¹æ“šæŒ‰éˆ•ç‹€æ…‹æ±ºå®šè§’åº¦ (äº®èµ·=270åº¦ï¼Œæ²’äº®=180åº¦)
			const rotationDeg = isTapActive ? 270 : 180;

			addOperation({ 
				type: 'ROTATE_CARD', 
				cardIds: cardIds, 
				deg: rotationDeg 
			});
		}

		// 3. é—œé–‰è¦–çª—èˆ‡é¸å–®
		document.getElementById('deck-move-modal').style.display = 'none';
		document.getElementById('deck-context-menu').style.display = 'none';
		
		// 4. [Fix] ç§»é™¤è‡ªå‹•å­˜æª”ï¼Œæ”¹ç‚ºæ›´æ–°ä»‹é¢
		// é€™æ¨£å±•ç¤ºå€ (Reveal Zone) å°±æœƒå› ç‚º renderUI è¢«å‘¼å«è€Œæ­£ç¢ºé¡¯ç¤º
		renderUI(); 
		updateDraftBar();
		
		// (é¸ç”¨) é å¡«æè¿°åˆ°è¼¸å…¥æ¡†
		const descInput = document.getElementById('step-desc-input'); // å‡è¨­æ‚¨çš„è¼¸å…¥æ¡† ID
		if (descInput) {
			descInput.value = `${t('log_blind_move')} ${qty} -> ${t('dest_' + targetType)}`;
		}
	}
	
	// å…¨éƒ¨æ”¶å›åŠŸèƒ½
    function recallAllCards() {
        if (!contextMenuTargetZone) return;
        
        const playerPrefix = contextMenuTargetZone.split('-')[0]; 
        const ownerId = (playerPrefix === 'p1') ? 1 : 2;
        
        const msg = t('msg_confirm_recall').replace('{player}', playerPrefix.toUpperCase());
        if (!confirm(msg)) return;

        const state = getCurrentDisplayState();
        
        const targetZones = [
            `${playerPrefix}-hand`, `${playerPrefix}-mana`, `${playerPrefix}-shield`,
            `${playerPrefix}-battle`, `${playerPrefix}-grave`, `${playerPrefix}-hyper`,
            `${playerPrefix}-abyss`, 'reveal-zone'
        ];

        const cardsToRecall = state.cards.filter(c => 
            c.ownerId === ownerId && targetZones.includes(c.zone)
        );

        if (cardsToRecall.length === 0) {
            alert(t('msg_no_recall_cards'));
            return;
        }

        const ids = cardsToRecall.map(c => c.id);

        if (!isDrafting) startDraftAtEnd();

        // ä¾åºåŸ·è¡Œæ“ä½œï¼šç§»å‹• -> è½‰æ­£ -> æ´—ç‰Œ
        
        // 1. ç§»å‹•
        const moveOp = { type: 'MOVE', cardIds: ids, toZone: contextMenuTargetZone, faceUp: false, shuffleSelection: false };
        addOperation(moveOp);
        applyOperation(state, moveOp);

        // 2. è½‰æ­£
        const rotateOp = { type: 'ROTATE_CARD', cardIds: ids, finalRotation: 0 };
        addOperation(rotateOp);
        applyOperation(state, rotateOp);

        // 3. æ´—ç‰Œ
        const shuffleOp = { type: 'SHUFFLE', zoneId: contextMenuTargetZone };
        addOperation(shuffleOp);
        applyOperation(state, shuffleOp);

        // é‡æ–°æ¸²æŸ“
        renderUI();
        triggerShuffleAnimation(20, contextMenuTargetZone);
    }

    // --- Main Entry Point ---
    window.onload = function() {
	
		// [æ–°å¢] é è¨­å¥—ç”¨ä¸€æ¬¡é¡è‰² (é¿å…ç•«é¢é–ƒçˆ)
        applyThemeVariables();
		
        // 1. åŸºæœ¬åˆå§‹åŒ–
        const urlParams = new URLSearchParams(window.location.search);
        let scriptUrl = urlParams.get('scriptUrl');
        if (scriptUrl) {
            scriptUrl = 'scripts/' + scriptUrl;
        }
        const isMobile = isMobileDevice();

        // ç”Ÿæˆé è¨­é ­åƒ
        generateDefaultPortraits();
		generateRpsPlaceholders(); // <--- åŠ å…¥é€™è¡Œï¼Œç¢ºä¿æœ‰åœ–

        // å•Ÿå‹•é¢æ¿æ‹–æ›³åŠŸèƒ½ (é›»è…¦ç‰ˆ/æ‰‹æ©Ÿç‰ˆçš†åˆå§‹åŒ–ï¼Œé›–ç„¶æ‰‹æ©Ÿç‰ˆä¸»è¦éš±è—é¢æ¿ï¼Œä½†é˜²æ­¢å ±éŒ¯)
        initDraggablePanel();

        // ----------------------------------------------------
        // [ä¿®æ”¹] 2. å„ªå…ˆè™•ç† URL åƒæ•¸ (lang & speed) - é€šç”¨é‚è¼¯
        // é€™æ¨£ç„¡è«–æ˜¯æ‰‹æ©Ÿé‚„æ˜¯é›»è…¦ï¼Œéƒ½æœƒåƒåˆ°è¨­å®š
        // ----------------------------------------------------

        // A. è™•ç†èªè¨€ (lang)
        const pLang = getUrlParameter('lang');
        if (pLang && ['zh', 'en', 'jp'].includes(pLang)) {
            // åŒæ­¥ä¸‹æ‹‰é¸å–® (é›»è…¦ç‰ˆæœ‰é¸å–®ï¼Œæ‰‹æ©Ÿç‰ˆé›–éš±è—ä½† DOM å­˜åœ¨)
            const langSelect = document.getElementById('lang-select');
            if (langSelect) langSelect.value = pLang;
            
            // å¥—ç”¨èªè¨€è¨­å®š (æ›´æ–°å…¨åŸŸè®Šæ•¸ currentLang ä¸¦åˆ·æ–° UI æ–‡å­—)
            changeLanguage(pLang);
        }

        // ----------------------------------------------------


        // 3. æ ¹æ“šè£ç½®è¼‰å…¥è³‡æ–™
        if (isMobile) {
            // --- [ä¿®æ­£] æ‰‹æ©Ÿç‰ˆé‚è¼¯ ---
            
            // [æ–°å¢] ç«‹å³åŠ å…¥ mobile-mode class èˆ‡åµæ¸¬ç›£è½å™¨
            document.body.classList.add('mobile-mode');
            window.addEventListener('resize', handleOrientation);
            window.addEventListener('orientationchange', handleOrientation);
            
            // ç«‹å³åŸ·è¡Œä¸€æ¬¡æª¢æŸ¥ (ç¢ºä¿ç›´å¼é€²å…¥æ™‚é¦¬ä¸Šè·³æç¤º)
            //handleOrientation();

            // åˆ¤æ–· URL åƒæ•¸
            const rawScriptParam = urlParams.get('scriptUrl');

            if (!rawScriptParam) {
                showMobileScriptSelector(null);
            } else {
                showMobileScriptSelector(rawScriptParam);
            }
            
            updateMuteButtonUI();
            
        } else {
		
			// [æ–°å¢] è¼‰å…¥é è¨­è¨ˆæ•¸å™¨ (æ¡Œæ©Ÿç‰ˆå°ˆç”¨)
            updateVisitorCounter(DEFAULT_COUNTER_URL);
			
            // --- é›»è…¦ç‰ˆé‚è¼¯ ---
            const hasLocalData = loadFromStorage();

            if (scriptUrl) {
                console.log("Found scriptUrl:", scriptUrl);
				// [ä¿®æ”¹] åŠ ä¸Šæ™‚é–“æˆ³è¨˜åƒæ•¸ï¼Œå¼·åˆ¶ç€è¦½å™¨æŠ“å–æœ€æ–°ç‰ˆ
                const noCacheUrl = scriptUrl + '?v=' + Date.now();
                fetch(noCacheUrl, { cache: 'no-cache' })
                    .then(res => { if(!res.ok) throw new Error(res.status); return res.json(); })
                    .then(data => {
                        if(!data.history || !data.initialState) throw new Error("Invalid script");
                        if (hasLocalData) {
                            pendingImportData = data;
                            document.getElementById('import-conflict-modal').style.display = 'flex';
                        } else {
                            processGameData(data, true);
                        }
                        // æ¸…é™¤ URL é¿å…é‡æ–°æ•´ç†é‡è¤‡è§¸ç™¼ (é›»è…¦ç‰ˆè¡Œç‚º)
                        window.history.replaceState({}, document.title, window.location.pathname);
                    })
                    .catch(e => {
                        alert(t('msg_load_script_fail') + e.message);
                        if(!hasLocalData) openSetupModal();
                    });
            } else {
                if (!hasLocalData) openSetupModal();
            }
        }
    };
	
	// --- é€²åº¦æ¢æ§åˆ¶å‡½å¼ ---

    function handleSliderChange(val) {
        const step = parseInt(val);
        // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œå…ˆæš«åœä»¥å…è¡çªï¼Œæˆ–è€…ä¿æŒæ’­æ”¾ä½†è·³è½‰
        // é€™è£¡é¸æ“‡ç›´æ¥è·³è½‰ä¸¦æ›´æ–°ç•«é¢
        currentIndex = step;
        renderUI();
        
        // åªæœ‰åœ¨éæ‰‹æ©Ÿæ¨¡å¼æ‰å­˜æª”ï¼Œé¿å…è¦†è“‹
        if(!document.body.classList.contains('mobile-mode')) {
            saveToStorage();
        }
    }

    function updateSliderUI() {
        const slider = document.getElementById('playback-slider');
        const tooltip = document.getElementById('slider-tooltip');
        
        if (slider && history.length > 0) {
            // è¨­å®šæœ€å¤§å€¼ç‚ºæ­·å²ç´€éŒ„é•·åº¦
            slider.max = history.length - 1;
            
            // è¨­å®šç•¶å‰å€¼
            slider.value = currentIndex;
            
            // æ›´æ–°æ–‡å­—æç¤º (ä¾‹å¦‚: 5/120)
            tooltip.innerText = `${currentIndex}/${history.length - 1}`;
            
            // è¦–è¦ºå„ªåŒ–ï¼šæ ¹æ“šé€²åº¦æ”¹è®Šè»Œé“èƒŒæ™¯é¡è‰² (å·²è®€éƒ¨åˆ†äº®ï¼Œæœªè®€éƒ¨åˆ†æš—)
            const percent = (currentIndex / (history.length - 1)) * 100;
            slider.style.background = `linear-gradient(to right, #3498db ${percent}%, rgba(255,255,255,0.3) ${percent}%)`;
        }
    }
	
	function scrollToActiveStep() {
		// 1. æ‰¾åˆ°ç›®å‰è¢«æ¨™è¨˜ç‚º active æˆ– editing çš„æ­¥é©Ÿé …ç›®
		// (ä¿®æ­£ï¼šç›®å‰çš„æ¸²æŸ“é‚è¼¯ä¸»è¦ä½¿ç”¨ .editing ä¾†æ¨™ç¤ºç•¶å‰æ­¥é©Ÿ)
		const activeItem = document.querySelector('.action-item.active, .action-item.editing');
		const listContainer = document.getElementById('action-list');
		
		if (activeItem && listContainer) {
			// 2. è¨ˆç®—æ²å‹•ä½ç½®ï¼Œè®“è©²é …ç›®å‡ºç¾åœ¨åˆ—è¡¨è¦–çª—çš„ä¸­é–“
			// block: 'center' æœƒç›¡é‡å°‡è©²å…ƒç´ ç½®ä¸­
			activeItem.scrollIntoView({ block: 'center', behavior: 'auto' });
		}
	}
	
	// --- Dialogue Editor Logic ---
    let lastDiagSettings = { 
        p1: { name: 'Player', emotion: 'normal' }, 
        p2: { name: 'Rival', emotion: 'normal' } 
    };
	
	// [æ–°å¢] ç”¨ä¾†è¨˜éŒ„æœ€å¾Œé»æ“Šçš„æ˜¯å“ªä¸€é‚Š (p1 æˆ– p2)
    let lastFocusPid = 'p1';

    function openDialogueModal() {
        // 1. æª¢æŸ¥æ˜¯å¦æ­£åœ¨ç·¨è¼¯éå°è©±çš„å‹•ä½œ
        if (isDrafting && draftOperations.length > 0 && !draftOperations.some(o => o.type === 'DIALOGUE')) {
            alert("ç›®å‰æ­£åœ¨ç·¨è¼¯å…¶ä»–å‹•ä½œï¼Œè«‹å…ˆ [å„²å­˜] æˆ– [å–æ¶ˆ] å¾Œå†æ’å…¥å°è©±ã€‚");
            return;
        }

        // 2. æ™ºæ…§æ’å…¥é»ï¼šå¦‚æœæ²’åœ¨ç·¨è¼¯ï¼Œé è¨­æ’å…¥åœ¨ã€Œç•¶å‰æ­¥é©Ÿä¹‹å¾Œã€
        if (!isDrafting) {
            // currentIndex æ˜¯ç•¶å‰çœ‹åˆ°çš„æ­¥é©Ÿï¼Œ+1 ä»£è¡¨æ’åœ¨å®ƒå¾Œé¢ (å³ #12 å’Œ #13 ä¹‹é–“ï¼Œè‹¥ç•¶å‰æ˜¯ #12)
            // å¦‚æœæ˜¯åˆå§‹ç‹€æ…‹ (-1)ï¼Œå‰‡æ’åœ¨ 0
            const nextIndex = currentIndex + 1;
            startDraft(nextIndex);
        }

        generateDefaultPortraits();
        renderEmotionGrid('p1');
        renderEmotionGrid('p2');
        
        // 3. è®€å–è³‡æ–™æˆ–é è¨­å€¼
        let found = false;
        // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ä¸”å·²ç¶“æœ‰å°è©±è³‡æ–™ï¼Œè¼‰å…¥å®ƒ
        if (draftOperations.length > 0 && draftOperations[0].type === 'DIALOGUE') {
             loadDiagToForm(draftOperations[0].data);
             found = true;
        } else {
            // å¦å‰‡å¾€å›æ‰¾æœ€è¿‘çš„è¨­å®šç•¶ä½œé è¨­
            for(let i=currentIndex; i>=0; i--) {
                const op = history[i].action.operations.find(o => o.type === 'DIALOGUE');
                if (op) {
                    loadDiagToForm(op.data); // ç¹¼æ‰¿ä¸Šæ¬¡çš„è¨­å®š (åŒ…å«é ­åƒã€ç‰¹æ•ˆ)
                    found = true;
                    break;
                }
            }
        }

        if (!found) {
            // å…¨æ–°é è¨­
            document.getElementById('edit-p1-emotion').value = lastDiagSettings.p1.emotion;
            document.getElementById('edit-p2-emotion').value = lastDiagSettings.p2.emotion;
            selectEmotion('p1', lastDiagSettings.p1.emotion);
            selectEmotion('p2', lastDiagSettings.p2.emotion);
        }

        document.getElementById('dialogue-modal').style.display = 'flex';
    }
	
	// --- [æ–°å¢] P1/P2 åœ–ç‰‡å…¨äº¤æ›èˆ‡ç¿»è½‰é‚è¼¯ ---

    // 1. è¼”åŠ©å‡½å¼ï¼šç”¢ç”Ÿé è¨­é ­åƒçš„ Base64 (ç”¨æ–¼æ¯”å°æ˜¯å¦ç‚ºé è¨­åœ–)
    function getFaceData(pid, emotion) {
        const color = pid === 'p1' ? '#3498db' : '#c0392b';
        const canvas = document.createElement('canvas');
        canvas.width = 160; canvas.height = 160;
        const ctx = canvas.getContext('2d');
        
        // ç¹ªè£½é‚è¼¯ (èˆ‡ generateDefaultPortraits ä¿æŒä¸€è‡´)
        ctx.fillStyle = '#222'; ctx.fillRect(0,0,160,160);
        ctx.lineWidth = 4; ctx.strokeStyle = color; ctx.strokeRect(5,5,150,150);
        ctx.beginPath(); ctx.arc(80, 80, 50, 0, Math.PI*2); ctx.stroke();
        
        // çœ¼ç›
        ctx.beginPath();
        if(emotion==='blank') { ctx.arc(65, 70, 3, 0, Math.PI*2); ctx.arc(95, 70, 3, 0, Math.PI*2); }
        else if(emotion==='serious') { ctx.moveTo(55,65); ctx.lineTo(75,75); ctx.moveTo(105,65); ctx.lineTo(85,75); }
        else if(emotion==='furious') { ctx.moveTo(55,60); ctx.lineTo(75,80); ctx.moveTo(105,60); ctx.lineTo(85,80); }
        else if(emotion==='terrified') { ctx.arc(65, 70, 8, 0, Math.PI*2); ctx.arc(95, 70, 8, 0, Math.PI*2); }
        else { ctx.arc(65, 70, 5, 0, Math.PI*2); ctx.arc(95, 70, 5, 0, Math.PI*2); }
        ctx.stroke();

        // å˜´å·´
        ctx.beginPath();
        if(emotion==='smug') { ctx.arc(80, 90, 10, 0, Math.PI, false); }
        else if(emotion==='furious') { ctx.moveTo(70,105); ctx.lineTo(90,105); ctx.rect(70,100,20,10); }
        else if(emotion==='terrified') { ctx.ellipse(80, 110, 10, 15, 0, 0, Math.PI*2); }
        else if(emotion==='serious') { ctx.moveTo(70,105); ctx.lineTo(90,105); }
        else { ctx.arc(80, 90, 15, 0, Math.PI, false); }
        ctx.stroke();

        return canvas.toDataURL();
    }

    // 2. è¼”åŠ©å‡½å¼ï¼šæ°´å¹³ç¿»è½‰åœ–ç‰‡
    function flipImage(base64) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                // æ°´å¹³ç¿»è½‰
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(img, 0, 0);
                resolve(canvas.toDataURL('image/jpeg', 0.85));
            };
            img.src = base64;
        });
    }

    // 3. ä¸»åŸ·è¡Œå‡½å¼
    async function swapAndFlipAllPortraits() {
        if (!confirm(t('msg_confirm_swap'))) return;

        const emotions = ['normal', 'blank', 'serious', 'smug', 'furious', 'terrified'];
        
        // ç‚ºäº†é¿å…è®€å–åˆ°å‰›å¯«å…¥çš„è³‡æ–™ï¼Œæˆ‘å€‘å…ˆæŠŠæ‰€æœ‰æ–°åœ–ç‰‡ç®—å¥½ï¼Œå†ä¸€æ¬¡å¯«å…¥
        const newImages = {};

        for (let emo of emotions) {
            // å–å¾—ç›®å‰çš„ Key
            const p1Key = `avatar_p1_${emo}`;
            const p2Key = `avatar_p2_${emo}`;
            
            const p1Current = globalImageRegistry[p1Key];
            const p2Current = globalImageRegistry[p2Key];
            
            // ç”¢ç”Ÿè©²è¡¨æƒ…çš„ã€Œé è¨­åœ–ã€å­—ä¸²ï¼Œç”¨ä¾†æ¯”å°
            const p1Default = getFaceData('p1', emo);
            const p2Default = getFaceData('p2', emo);

            // --- è™•ç† P1 çš„æ–°åœ–ç‰‡ (ä¾†æºæ˜¯ P2) ---
            if (p2Current === p2Default) {
                // å¦‚æœ P2 åŸæœ¬æ˜¯ç”¨é è¨­åœ–ï¼Œé‚£ P1 å°±æ”¹ç”¨ P1 è‡ªå·±çš„é è¨­åœ– (ä¸ç¿»è½‰)
                newImages[p1Key] = p1Default;
            } else {
                // å¦‚æœ P2 æ˜¯è‡ªè¨‚åœ–ï¼Œå‰‡ç¿»è½‰å¾Œçµ¦ P1
                newImages[p1Key] = await flipImage(p2Current);
            }

            // --- è™•ç† P2 çš„æ–°åœ–ç‰‡ (ä¾†æºæ˜¯ P1) ---
            if (p1Current === p1Default) {
                // å¦‚æœ P1 åŸæœ¬æ˜¯ç”¨é è¨­åœ–ï¼Œé‚£ P2 å°±æ”¹ç”¨ P2 è‡ªå·±çš„é è¨­åœ– (ä¸ç¿»è½‰)
                newImages[p2Key] = p2Default;
            } else {
                // å¦‚æœ P1 æ˜¯è‡ªè¨‚åœ–ï¼Œå‰‡ç¿»è½‰å¾Œçµ¦ P2
                newImages[p2Key] = await flipImage(p1Current);
            }
        }

        // å…¨éƒ¨è¨ˆç®—å®Œç•¢å¾Œï¼Œå¯«å…¥å…¨åŸŸè¨»å†Šè¡¨
        Object.assign(globalImageRegistry, newImages);

        // æ›´æ–°ä»‹é¢
        renderEmotionGrid('p1');
        renderEmotionGrid('p2');
        
        // å¦‚æœç›®å‰æ­£åœ¨é¡¯ç¤ºé è¦½åœ–ï¼Œä¹Ÿè¦æ›´æ–°
        ['p1', 'p2'].forEach(id => {
            const currentEmo = document.getElementById(`edit-${id}-emotion`).value;
            selectEmotion(id, currentEmo);
        });

        saveToStorage();
        alert(t('msg_swap_done'));
    }

    function renderEmotionGrid(pid) {
        const grid = document.getElementById(`emotion-grid-${pid}`);
        grid.innerHTML = '';
        EMOTIONS.forEach(emo => {
            const div = document.createElement('div');
            div.className = 'emotion-opt';
            div.title = EMOTION_LABELS[emo];
            div.dataset.emo = emo;
            div.onclick = () => selectEmotion(pid, emo);
            
            const key = `avatar_${pid}_${emo}`;
            const imgSrc = globalImageRegistry[key]; // å–å¾—åœ–ç‰‡ä¾†æº
            div.style.backgroundImage = `url(${imgSrc})`;
            
            // --- [æ–°å¢] æ»‘é¼ æ‡¸åœé è¦½åŠŸèƒ½ ---
            // ä½¿ç”¨ onmousemove è®“é è¦½æ¡†è·Ÿè‘—æ»‘é¼ ç§»å‹•
            div.onmousemove = (e) => showEmotionPreview(e, imgSrc);
            // æ»‘é¼ é›¢é–‹æ™‚éš±è—
            div.onmouseleave = () => hideEmotionPreview();
            // -----------------------------

            grid.appendChild(div);
        });
    }

    // --- [æ–°å¢] é è¦½è¦–çª—æ§åˆ¶å‡½å¼ ---
    function showEmotionPreview(e, src) {
        const tooltip = document.getElementById('emotion-preview-tooltip');
        if (!tooltip || !src) return;
        
        tooltip.style.backgroundImage = `url(${src})`;
        tooltip.style.display = 'block';
        
        // è¨­å®šåç§»é‡ï¼Œé¿å…æ“‹ä½æ»‘é¼ 
        const offset = 15;
        let x = e.clientX + offset;
        let y = e.clientY + offset;
        
        // ç°¡å–®çš„é‚Šç•Œæª¢æŸ¥ï¼šå¦‚æœå¤ªé å³/ä¸‹ï¼Œå°±å¾€å·¦/ä¸Šé¡¯ç¤º
        const tipSize = 205; // å¯¬åº¦ + border
        if (x + tipSize > window.innerWidth) x = e.clientX - tipSize;
        if (y + tipSize > window.innerHeight) y = e.clientY - tipSize;

        tooltip.style.left = x + 'px';
        tooltip.style.top = y + 'px';
    }

    function hideEmotionPreview() {
        const tooltip = document.getElementById('emotion-preview-tooltip');
        if (tooltip) tooltip.style.display = 'none';
    }

    function selectEmotion(pid, emo) {
        // [æ–°å¢] è¨˜éŒ„ç›®å‰ç„¦é»
        lastFocusPid = pid;
        
        document.getElementById(`edit-${pid}-emotion`).value = emo;
        document.querySelectorAll(`#emotion-grid-${pid} .emotion-opt`).forEach(el => {
            el.classList.toggle('active', el.dataset.emo === emo);
        });
    }

    function loadDiagToForm(data) {
        ['p1', 'p2'].forEach(id => {
            const d = data[id];
            document.getElementById(`edit-${id}-active`).checked = d.active;
            if(d.active) {
                document.getElementById(`edit-${id}-name`).value = d.name;
                document.getElementById(`edit-${id}-text`).value = d.dataText;
                document.getElementById(`edit-${id}-size`).value = d.size;
                document.getElementById(`edit-${id}-effect`).value = d.effect;
                // [æ–°å¢] è¼‰å…¥é€€å ´ç‰¹æ•ˆï¼Œå¦‚æœèˆŠå­˜æª”æ²’æœ‰é€™å€‹æ¬„ä½ï¼Œé è¨­ç‚º direct
                document.getElementById(`edit-${id}-exit`).value = d.exit || 'direct';
                
                selectEmotion(id, d.emotion);
            }
            toggleDiagEdit(id);
        });
    }

    function toggleDiagEdit(id) {
        const active = document.getElementById(`edit-${id}-active`).checked;
        // ç°¡å–®çš„è¦–è¦ºå›é¥‹ï¼šè®Šç°
        const els = document.querySelectorAll(`#edit-${id}-name, #edit-${id}-text, #edit-${id}-size, #edit-${id}-effect`);
        els.forEach(el => el.disabled = !active);
    }

    function confirmDialogue() {
        // [ä¿®æ”¹] å¢åŠ è®€å– exit æ¬„ä½
        const getData = (id) => ({
            active: document.getElementById(`edit-${id}-active`).checked,
            name: document.getElementById(`edit-${id}-name`).value,
            dataText: document.getElementById(`edit-${id}-text`).value,
            size: document.getElementById(`edit-${id}-size`).value,
            effect: document.getElementById(`edit-${id}-effect`).value,
            exit: document.getElementById(`edit-${id}-exit`).value, // æ–°å¢é€™è¡Œ
            emotion: document.getElementById(`edit-${id}-emotion`).value
        });

        const p1Data = getData('p1');
        const p2Data = getData('p2');
        
        if(p1Data.active) lastDiagSettings.p1 = { name: p1Data.name, emotion: p1Data.emotion };
        if(p2Data.active) lastDiagSettings.p2 = { name: p2Data.name, emotion: p2Data.emotion };

        // æ³¨æ„ï¼šé€™è£¡ä¸éœ€è¦å†å‘¼å« startDraftï¼Œå› ç‚º openDialogueModal å·²ç¶“å¹«æˆ‘å€‘åšå¥½äº†
        
        // è‹¥ draftOperations å·²æœ‰å°è©± (ç·¨è¼¯æ¨¡å¼)ï¼Œå…ˆæ¸…ç©ºé¿å…é‡è¤‡ push
        if (draftOperations.length > 0 && draftOperations[0].type === 'DIALOGUE') {
            draftOperations = [];
        }

        addOperation({
            type: 'DIALOGUE',
            data: { p1: p1Data, p2: p2Data }
        });

        let desc = t('desc_dialogue') + " ";
        if (p2Data.active) desc += `${p2Data.name}: ${p2Data.dataText.substr(0,8)}... `;
        if (p1Data.active) desc += `${p1Data.name}: ${p1Data.dataText.substr(0,8)}...`;
        
        saveDraft(desc);
        document.getElementById('dialogue-modal').style.display = 'none';
        
        document.getElementById('edit-p1-text').value = '';
        document.getElementById('edit-p2-text').value = '';
    }

    // --- çµ±ä¸€çš„è²¼ä¸Šç›£è½å™¨ (Unified Paste Handler) ---
	// --- [ä¿®æ”¹] çµ±ä¸€çš„è²¼ä¸Šç›£è½å™¨ (æ”¯æ´ åœ–ç‰‡æª” èˆ‡ åœ–ç‰‡ç¶²å€) ---
	document.addEventListener('paste', (e) => {
        // 1. å–å¾—å‰ªè²¼ç°¿è³‡æ–™
		const clipboardData = (e.clipboardData || e.originalEvent.clipboardData);
		const items = clipboardData.items;
		let blob = null;

        // 2. å„ªå…ˆæª¢æŸ¥æ˜¯å¦æœ‰åœ–ç‰‡æª”æ¡ˆ (Blob)
		for (let item of items) {
			if (item.kind === 'file' && item.type.startsWith('image/')) {
				blob = item.getAsFile();
				break;
			}
		}

        // -------------------------------------------------------------
        // åˆ†æ”¯ A: è²¼ä¸Šçš„æ˜¯åœ–ç‰‡æª”æ¡ˆ -> èµ°åŸæœ¬çš„å£“ç¸® Base64 æµç¨‹
        // -------------------------------------------------------------
		if (blob) {
            // [æƒ…å¢ƒ D] æ¬¡å…ƒç ´è£‚ç·¨è¼¯å™¨
            if (rbEditorState && rbEditorState.active) {
                handleRbPaste(blob);
                e.preventDefault();
                return;
            }
            
            // [æƒ…å¢ƒ A] å°è©±é ­åƒ (ç¶­æŒ Base64ï¼Œå› ç‚ºéœ€è¦è£åˆ‡)
            const diagModal = document.getElementById('dialogue-modal');
            if (diagModal && diagModal.style.display === 'flex') {
                // ... (ä¿ç•™åŸæœ¬å°è©±é ­åƒçš„è²¼ä¸Šé‚è¼¯ï¼Œå› ç‚ºå®ƒéœ€è¦ canvas è£åˆ‡) ...
                // ç‚ºäº†ç¯€çœç¯‡å¹…ï¼Œé€™è£¡å‘¼å«åŸæœ¬çš„é‚è¼¯ï¼Œæˆ–è«‹æ‚¨ä¿ç•™åŸæœ¬é‚£æ®µ Canvas è™•ç†ä»£ç¢¼
                // å»ºè­°ï¼šç›´æ¥è¤‡è£½æ‚¨åŸæœ¬ç¨‹å¼ç¢¼ä¸­è™•ç† diagModal çš„é‚£ä¸€æ®µè²¼å›ä¾†é€™è£¡
                const url = URL.createObjectURL(blob);
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const size = 200; 
                    canvas.width = size; canvas.height = size;
                    ctx.fillStyle = "#222"; ctx.fillRect(0, 0, size, size);
                    let sWidth = img.width; let sHeight = img.height;
                    const ratio = Math.max(size / sWidth, size / sHeight);
                    const newWidth = sWidth * ratio; const newHeight = sHeight * ratio;
                    const dx = (size - newWidth) / 2; const dy = (size - newHeight) / 2;
                    ctx.drawImage(img, dx, dy, newWidth, newHeight);
                    const base64 = canvas.toDataURL('image/jpeg', 0.85);
                    const currentEmo = document.getElementById(`edit-${lastFocusPid}-emotion`).value;
                    const key = `avatar_${lastFocusPid}_${currentEmo}`;
                    globalImageRegistry[key] = base64;
                    const activeOpt = document.querySelector(`#emotion-grid-${lastFocusPid} .emotion-opt[data-emo="${currentEmo}"]`);
                    if (activeOpt) activeOpt.style.backgroundImage = `url(${base64})`;
                    URL.revokeObjectURL(url);
                    saveToStorage();
                };
                img.src = url;
                e.preventDefault();
                return;
            }

            // [æƒ…å¢ƒ C] å¡ç‰‡æ¸…å–®è¦–çª— (å–®é¸)
            const selectorModal = document.getElementById('card-selector-modal');
            if (selectorModal && selectorModal.style.display === 'flex') {
                if (selectedCardsInModal.length === 1) {
                    const reader = new FileReader();
                    reader.onload = (ev) => processImage(ev.target.result, selectedCardsInModal[0]);
                    reader.readAsDataURL(blob);
                    e.preventDefault();
                    return;
                }
            }

            // [æƒ…å¢ƒ B] æ¡Œé¢å–®é¸
            if (pendingMove && pendingMove.cardIds.length === 1) {
                const reader = new FileReader();
                reader.onload = (ev) => processImage(ev.target.result);
                reader.readAsDataURL(blob);
                e.preventDefault();
                return;
            }
            return; // æœ‰æª”æ¡ˆä½†ç„¡è™•å¯è²¼ï¼ŒçµæŸ
        }

        // -------------------------------------------------------------
        // åˆ†æ”¯ B: æ²’æœ‰æª”æ¡ˆ -> æª¢æŸ¥æ˜¯å¦ç‚ºã€Œæ–‡å­—ç¶²å€ã€
        // -------------------------------------------------------------
        const pastedText = clipboardData.getData('text');
        
        // ç°¡å–®çš„æ­£å‰‡è¡¨é”å¼æª¢æŸ¥æ˜¯å¦ç‚º http/https é–‹é ­
        if (pastedText && pastedText.match(/^https?:\/\/.+/i)) {
            
            // [æƒ…å¢ƒ D] æ¬¡å…ƒç ´è£‚ç·¨è¼¯å™¨ (ç›´æ¥è¼‰å…¥ URL)
            if (rbEditorState && rbEditorState.active) {
                loadRbUrl(pastedText); // å‘¼å«æ—¢æœ‰çš„è¼‰å…¥å‡½å¼
                e.preventDefault();
                return;
            }

            // åˆ¤æ–·ç›®æ¨™å¡ç‰‡ ID
            let targetCardId = null;

            // [æƒ…å¢ƒ C] Modal å–®é¸
            const selectorModal = document.getElementById('card-selector-modal');
            if (selectorModal && selectorModal.style.display === 'flex') {
                if (selectedCardsInModal.length === 1) {
                    targetCardId = selectedCardsInModal[0];
                }
            }
            // [æƒ…å¢ƒ B] æ¡Œé¢å–®é¸
            else if (pendingMove && pendingMove.cardIds.length === 1) {
                targetCardId = pendingMove.cardIds[0];
            }

            // å¦‚æœæœ‰ç›®æ¨™å¡ç‰‡ï¼ŒåŸ·è¡Œç¶²å€è™•ç†
            if (targetCardId) {
                processPastedUrl(pastedText, targetCardId);
                e.preventDefault();
            }
        }
	});
	
	// --- [æ–°å¢] è™•ç†è²¼ä¸Šçš„ç¶²å€ (ä¸å£“ç¸®ï¼Œç›´æ¥å„²å­˜) ---
    function processPastedUrl(url, targetId) {
        // 1. é¡¯ç¤ºç°¡æ˜“ Loading (å¯é¸)
        const cardEl = document.querySelector(`.card[data-id="${targetId}"]`);
        if (cardEl) cardEl.style.opacity = '0.5';

        // 2. é©—è­‰ç¶²å€æ˜¯å¦ç‚ºæœ‰æ•ˆåœ–ç‰‡
        const img = new Image();
        img.crossOrigin = "Anonymous"; // å˜—è©¦è·¨åŸŸï¼Œé›–ç„¶å­˜ç¶²å€ä¸éœ€è¦ï¼Œä½†æœ‰äº›åœ–æºéœ€è¦
        
        img.onload = () => {
            // è¼‰å…¥æˆåŠŸï¼
            if (cardEl) cardEl.style.opacity = '1';
            
            console.log("ç¶²å€åœ–ç‰‡é©—è­‰æˆåŠŸï¼Œç›´æ¥å„²å­˜ URL:", url);
            
            // [æ ¸å¿ƒ] ç›´æ¥å‘¼å« updateCardImageGlobal
            // è©²å‡½å¼æœƒå°‡æ­¤ URL è¦–ç‚º key å°æ‡‰çš„ value å­˜å…¥ globalImageRegistry
            // CSS çš„ background-image: url('...') å¯ä»¥å®Œç¾æ”¯æ´ http ç¶²å€
            updateCardImageGlobal(targetId, url);
        };
        
        img.onerror = () => {
            // è¼‰å…¥å¤±æ•— (å¯èƒ½ä¸æ˜¯åœ–ç‰‡ï¼Œæˆ–æ˜¯ç”± CORS é˜»æ“‹å°è‡´ç„¡æ³• Image onload)
            // ä½†å³ä½¿ CORS é˜»æ“‹ï¼Œå¦‚æœç€è¦½å™¨èƒ½é¡¯ç¤ºï¼Œæˆ‘å€‘é‚„æ˜¯å¯ä»¥å­˜å­˜çœ‹ï¼Œä½†ç‚ºäº†å®‰å…¨é€šå¸¸å»ºè­°å¤±æ•—å°±ä¸å­˜
            // é€™è£¡æ¡å–å¯¬å®¹ç­–ç•¥ï¼šå¦‚æœæ˜¯ 404 å°±çœŸçš„å¤±æ•—ï¼Œå¦‚æœæ˜¯ CORS é‚„æ˜¯å¯ä»¥è©¦è‘—é¡¯ç¤º
            
            if (cardEl) cardEl.style.opacity = '1';
            
            // ç°¡å–®æç¤º
            if (confirm("ç„¡æ³•é©—è­‰æ­¤ç¶²å€ç‚ºæœ‰æ•ˆåœ–ç‰‡ (æˆ–å­˜å–è¢«æ‹’)ã€‚\næ˜¯å¦ä»è¦å¼·åˆ¶è¨­ç‚ºå¡åœ–ï¼Ÿ")) {
                updateCardImageGlobal(targetId, url);
            }
        };
        
        img.src = url;
    }
	
	// --- [æ–°å¢] æ¬¡å…ƒç ´è£‚ (Reality Break) ç³»çµ± ---

    let rbEditorState = {
        active: false,
        imgData: null, // Base64
        x: 50, // %
        y: 50, // %
        scale: 1.0,
        pattern: 'random'
    };

    // 1. é–‹å•Ÿç‰¹æ•ˆç·¨è¼¯å™¨
    function openRealityBreakEditor() {
        // å¦‚æœæ­£åœ¨ç·¨è¼¯å…¶ä»–å‹•ä½œï¼Œå…ˆé˜»æ“‹
        if (isDrafting && draftOperations.length > 0 && !draftOperations.some(o => o.type === 'REALITY_BREAK')) {
            alert(t('msg_finish_edit_first'));
            return;
        }

        const overlay = document.getElementById('rb-overlay');
        const layer = document.getElementById('rb-inner-layer');
        const patternSel = document.getElementById('rb-pattern-select');
        const hint = document.getElementById('rb-edit-hint');
		const urlInput = document.getElementById('rb-url-input'); // å–å¾—è¼¸å…¥æ¡†

        let existingData = null;
        let targetIdx = -1; // [é—œéµè®Šæ•¸] -1 ä»£è¡¨æ–°å¢ï¼Œå…¶ä»–æ•¸å­—ä»£è¡¨ç·¨è¼¯è©²æ­¥é©Ÿ

        // A. å¦‚æœæ­£åœ¨ Draft æ¨¡å¼ï¼Œå„ªå…ˆæª¢æŸ¥ Draft å…§å®¹
        if (isDrafting) {
            const op = draftOperations.find(o => o.type === 'REALITY_BREAK');
            if (op) {
                existingData = op.data;
                targetIdx = insertIndex; // é–å®šç•¶å‰çš„æ’å…¥é»ç´¢å¼•
            }
        } 
        // B. å¦‚æœä¸åœ¨ Draftï¼Œæª¢æŸ¥ç•¶å‰æ‰€åœ¨çš„æ­·å²æ­¥é©Ÿ
        else if (currentIndex >= 0 && history[currentIndex]) {
            const op = history[currentIndex].action.operations.find(o => o.type === 'REALITY_BREAK');
            if (op) {
                existingData = op.data;
                targetIdx = currentIndex; // é–å®šç•¶å‰æ­¥é©Ÿç´¢å¼•
            }
        }
		
		// åˆå§‹åŒ–ç‹€æ…‹
		rbEditorState = {
			active: true,
			imgData: null,
			imgUrl: null,
			sourceType: 'base64', // é è¨­
			x: 50, y: 50, scale: 1.0, pattern: 'random',
			editingIndex: targetIdx
		};

		if (existingData) {
			// [è¼‰å…¥èˆŠè³‡æ–™]
			rbEditorState.x = existingData.style.x;
			rbEditorState.y = existingData.style.y;
			rbEditorState.scale = existingData.style.scale;
			rbEditorState.pattern = existingData.pattern;

			// --- [æ–°å¢] åˆ¤æ–·ä¾†æºé¡å‹ ---
			if (existingData.imgUrl) {
				// æƒ…æ³ A: æ˜¯ URL
				rbEditorState.sourceType = 'url';
				rbEditorState.imgUrl = existingData.imgUrl;
				urlInput.value = existingData.imgUrl; // å¡«å…¥è¼¸å…¥æ¡†
				
				layer.style.backgroundImage = `url(${existingData.imgUrl})`;
				layer.style.backgroundColor = 'transparent';
				if(hint) hint.style.display = 'none';

			} else {
				// æƒ…æ³ B: æ˜¯ Base64 (Key or Data)
				rbEditorState.sourceType = 'base64';
				urlInput.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†

				let finalImgData = existingData.imgData;
				if (!finalImgData && existingData.imgKey) {
					finalImgData = globalImageRegistry[existingData.imgKey];
				}
				rbEditorState.imgData = finalImgData;

				if (finalImgData) {
					layer.style.backgroundImage = `url(${finalImgData})`;
					layer.style.backgroundColor = 'transparent';
					if(hint) hint.style.display = 'none';
				} else {
					// æœ‰è³‡æ–™ä½†åœ–ä¸è¦‹äº†
					layer.style.backgroundImage = 'none';
					layer.style.backgroundColor = '#222';
					if(hint) hint.style.display = 'block';
				}
			}
			
			// è¼‰å…¥å…¶ä»–åƒæ•¸ (éœ‡å‹•ã€è£‚åº¦)
			const sIn = (existingData.shakeInner !== undefined) ? existingData.shakeInner : true;
			const sOut = (existingData.shakeOuter !== undefined) ? existingData.shakeOuter : false;
			const intensity = (existingData.tearScale !== undefined) ? existingData.tearScale : 0.7;
			
			document.getElementById('rb-shake-inner').checked = sIn;
			document.getElementById('rb-shake-outer').checked = sOut;
			document.getElementById('rb-intensity').value = intensity;
			document.getElementById('rb-intensity-val').innerText = intensity;
			
		} else {
			// [æ–°å¢æ¨¡å¼]
			urlInput.value = ''; // æ¸…ç©º
			layer.style.backgroundImage = 'none';
			layer.style.backgroundColor = '#222';
			if(hint) hint.style.display = 'block';
			
			// é‡ç½®åƒæ•¸
			document.getElementById('rb-shake-inner').checked = true;
			document.getElementById('rb-shake-outer').checked = false;
			document.getElementById('rb-intensity').value = 0.7;
			document.getElementById('rb-intensity-val').innerText = '0.7';
		}

		layer.style.backgroundPosition = `${rbEditorState.x}% ${rbEditorState.y}%`;
		layer.style.backgroundSize = `${rbEditorState.scale * 100}%`;
		patternSel.value = rbEditorState.pattern || 'random';

		// éš±è—ç´™å¼µå±¤
		const paperLayer = document.getElementById('rb-paper-layer');
		if (paperLayer) paperLayer.style.display = 'none';

		overlay.style.display = 'block';
		overlay.classList.add('editing');
		initRbInteraction(layer);
	}

    // 2. ç·¨è¼¯å™¨äº’å‹•é‚è¼¯ (æ‹–æ›³èˆ‡æ»¾è¼ª)
    function initRbInteraction(el) {
        let isDragging = false;
        let startX, startY;

        el.onmousedown = (e) => {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            el.style.cursor = 'grabbing';
        };

        window.onmousemove = (e) => {
            if (!isDragging || !rbEditorState.active) return;
            e.preventDefault();
            
            // è¨ˆç®—ä½ç§» (ç°¡å–®çš„ç™¾åˆ†æ¯”ç§»å‹•)
            const dx = (e.clientX - startX) / window.innerWidth * 100;
            const dy = (e.clientY - startY) / window.innerHeight * 100;
            
            rbEditorState.x += dx;
            rbEditorState.y += dy;
            
            el.style.backgroundPosition = `${rbEditorState.x}% ${rbEditorState.y}%`;
            
            startX = e.clientX;
            startY = e.clientY;
        };

        window.onmouseup = () => {
            isDragging = false;
            el.style.cursor = 'move';
        };

        el.onwheel = (e) => {
            if (!rbEditorState.active) return;
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            rbEditorState.scale = Math.max(0.1, rbEditorState.scale + delta);
            
            // cover æ¨¡å¼ä¸‹ï¼Œscale 1 = 100%
            // å¦‚æœè¦æ”¾å¤§ï¼Œå°±è¨­å¤§æ–¼ 100%
            // é€™è£¡ç°¡å–®è™•ç†ï¼šå¦‚æœæ˜¯ coverï¼Œscale å±¬æ€§å…¶å¯¦è¼ƒé›£ç›´æ¥å°æ‡‰ background-size
            // æˆ‘å€‘æ”¹ç”¨ç™¾åˆ†æ¯”é¡¯ç¤º
            el.style.backgroundSize = `${rbEditorState.scale * 100}%`;
        };
    }

    // 3. è™•ç†è²¼ä¸Šåœ–ç‰‡ (Paste)
    // æ³¨æ„ï¼šéœ€ä¿®æ”¹å…¨åŸŸçš„ paste event listener ä¾†å‘¼å«æ­¤å‡½å¼
    function handleRbPaste(blob) {
		const reader = new FileReader();
		reader.onload = (e) => {
			const base64 = e.target.result;
			
			// æ›´æ–°ç‹€æ…‹
			rbEditorState.imgData = base64;
			rbEditorState.imgUrl = null;     // æ¸…ç©º URL
			rbEditorState.sourceType = 'base64'; // æ¨™è¨˜ä¾†æºç‚º Base64
			
			// æ¸…ç©ºè¼¸å…¥æ¡† (é¿å…æ··æ·†)
			document.getElementById('rb-url-input').value = '';

			// æ›´æ–°é è¦½
			const layer = document.getElementById('rb-inner-layer');
			layer.style.backgroundImage = `url(${base64})`;
			layer.style.backgroundColor = 'transparent';
			
			const hint = document.getElementById('rb-edit-hint');
			if(hint) hint.style.display = 'none';
		};
		reader.readAsDataURL(blob);
	}

    // 4. é è¦½ç‰¹æ•ˆ
    function previewRbEffect() {
	
		const pattern = document.getElementById('rb-pattern-select').value;
			
		// --- [æ–°å¢] å¾ UI è®€å–åƒæ•¸ ---
		const sIn = document.getElementById('rb-shake-inner').checked;
		const sOut = document.getElementById('rb-shake-outer').checked;
		const intensity = parseFloat(document.getElementById('rb-intensity').value);
		
		const config = {
			imgUrl: (rbEditorState.sourceType === 'url') ? rbEditorState.imgUrl : null,
			imgData: (rbEditorState.sourceType === 'base64') ? rbEditorState.imgData : null,
			style: { x: rbEditorState.x, y: rbEditorState.y, scale: rbEditorState.scale },
			pattern: pattern,
			// å‚³å…¥é è¦½åƒæ•¸
			shakeInner: sIn,
			shakeOuter: sOut,
			tearScale: intensity
		};
        
        // æš«æ™‚éš±è— UI
        document.getElementById('rb-overlay').classList.remove('editing');
        
        playRealityBreak(config, () => {
            // Callback: å‹•ç•«çµæŸå¾Œæ¢å¾©ç·¨è¼¯ç‹€æ…‹
            document.getElementById('rb-overlay').classList.add('editing');
            // æ¢å¾©åŸæœ¬çš„ style (å› ç‚ºæ’­æ”¾æ™‚æœƒäº‚æ”¹ clip-path)
            const layer = document.getElementById('rb-inner-layer');
            layer.style.clipPath = 'none'; 
            layer.style.opacity = '1';
        });
    }

    // 5. ç¢ºèªå„²å­˜
    function confirmRbEffect() {
        // è®€å–å‰›å‰›å­˜ä¸‹ä¾†çš„ç´¢å¼•
        const targetIdx = rbEditorState.editingIndex;
        const isEditingExisting = (targetIdx !== -1);

        // å¦‚æœç›®å‰ä¸åœ¨ Draft æ¨¡å¼ï¼Œæˆ‘å€‘éœ€è¦æ‰‹å‹•å•Ÿå‹•æ­£ç¢ºçš„æ¨¡å¼
        if (!isDrafting) {
            if (isEditingExisting) {
                // æ˜ç¢ºå‘Šè¨´ç³»çµ±ï¼šæˆ‘è¦ç·¨è¼¯ targetIdx é€™ä¸€æ­¥
                // é€™æœƒè¨­å®š editModeType = 'EDIT'ï¼ŒsaveDraft å°±æœƒåŸ·è¡Œã€Œå–ä»£ã€
                editAction(targetIdx); 
            } else {
                // é€™æ˜¯æ–°è³‡æ–™ -> é–‹å•Ÿæ–°æ­¥é©Ÿ
                startDraftAtEnd();
            }
        }
        // å¼·åˆ¶æ¸…ç©º draftOperations (ç¢ºä¿é€™ä¸€æ­¥åªæœ‰é€™ä¸€å€‹ç‰¹æ•ˆå‹•ä½œ)
        draftOperations = [];

        const pattern = document.getElementById('rb-pattern-select').value;
        
        // --- [æ–°å¢] å¾ UI è®€å–åƒæ•¸ä¸¦å¯«å…¥ data ---
		const sIn = document.getElementById('rb-shake-inner').checked;
		const sOut = document.getElementById('rb-shake-outer').checked;
		const intensity = parseFloat(document.getElementById('rb-intensity').value);

		// æº–å‚™è³‡æ–™ç‰©ä»¶
		const dataObj = {
			style: { x: rbEditorState.x, y: rbEditorState.y, scale: rbEditorState.scale },
			pattern: pattern,
			shakeInner: sIn,
			shakeOuter: sOut,
			tearScale: intensity
		};

		// --- [æ–°å¢] åˆ¤æ–·ä¸¦å„²å­˜å°æ‡‰çš„åœ–ç‰‡ä¾†æº ---
		if (rbEditorState.sourceType === 'url') {
			// æ¨¡å¼ A: å„²å­˜ URL
			dataObj.imgUrl = rbEditorState.imgUrl;
			dataObj.imgKey = null; // æ¸…é™¤ Key å¼•ç”¨
		} else {
			// æ¨¡å¼ B: å„²å­˜ Base64 Key
			// åªæœ‰ç•¶çœŸçš„æœ‰è³‡æ–™æ™‚æ‰è¨»å†Š
			if (rbEditorState.imgData) {
				const imgKey = registerImageToGlobal(rbEditorState.imgData);
				dataObj.imgKey = imgKey;
			}
			dataObj.imgUrl = null; // æ¸…é™¤ URL
		}
		// ------------------------------------

		addOperation({
			type: 'REALITY_BREAK',
			data: dataObj
		});

		saveDraft(t('desc_rb'));
		closeRbEditor();
    }

    function closeRbEditor() {
        rbEditorState.active = false;
        
        // 1. é—œé–‰ç‰¹æ•ˆå±¤
        const overlay = document.getElementById('rb-overlay');
        overlay.style.display = 'none';
        overlay.classList.remove('editing');
        
        // 2. æ¸…ç†å…§å®¹
        document.getElementById('rb-inner-layer').style.backgroundImage = 'none';
        const hint = document.getElementById('rb-edit-hint');
        if(hint) hint.style.display = 'block';

		// [æ–°å¢] éš±è—ç´™å¼µå±¤
        const paperLayer = document.getElementById('rb-paper-layer');
        if(paperLayer) paperLayer.style.display = 'none';
		
        // --- [æ–°å¢] 3. æ¢å¾© Action Log ä»‹é¢ç‹€æ…‹ ---
        const list = document.getElementById('action-list');
        if (list) {
            // è§£é–æ²è»¸ (ç§»é™¤ overflow: hidden)
            list.classList.remove('locked'); 
        }

        // --- [æ–°å¢] 4. è‡ªå‹•æ²å‹•å›ç•¶å‰æ­¥é©Ÿ ---
        // ä½¿ç”¨ setTimeout ç¢ºä¿ DOM ç‹€æ…‹ (å¦‚ display:none) æ›´æ–°å®Œç•¢å¾Œæ‰æ²å‹•
        setTimeout(() => {
            scrollToActiveStep();
        }, 100);
    }

    // 6. æ’­æ”¾ç‰¹æ•ˆ (æ ¸å¿ƒå‹•ç•«é‚è¼¯)
    function playRealityBreak(data, onComplete) {
        // [æ–°å¢] é–å®šæ²è»¸ï¼Œé˜²æ­¢éœ‡å‹•æ™‚å‡ºç¾ Scrollbar
        document.body.style.overflow = 'hidden';

        // å„ªå…ˆè®€å– data ä¸­çš„è¨­å®šï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨é è¨­å€¼
        const ENABLE_OUTER_SHAKE = (data.shakeOuter !== undefined) ? data.shakeOuter : false;
        const ENABLE_INNER_SHAKE = (data.shakeInner !== undefined) ? data.shakeInner : true;
        const TEAR_INTENSITY = (data.tearScale !== undefined) ? data.tearScale : 0.7;

        const overlay = document.getElementById('rb-overlay');
        const imgLayer = document.getElementById('rb-inner-layer');
        const paperLayer = document.getElementById('rb-paper-layer');
        const body = document.body;

        // è§£æåœ–ç‰‡ä¾†æº
        let srcImage = null;
        if (data.imgUrl) {
            srcImage = data.imgUrl;
        } else if (data.imgKey) {
            srcImage = globalImageRegistry[data.imgKey];
        } else if (data.imgData) {
            srcImage = data.imgData;
        }

        const hint = document.getElementById('rb-edit-hint');
        
        // A. åˆå§‹åŒ–é¡¯ç¤º
        overlay.style.display = 'block';
        overlay.classList.remove('editing');
        if (hint) hint.style.display = 'none';

        // å–å¾—åŸºæœ¬ä½ç½®è¨­å®š
        const st = data.style || {x:50, y:50, scale:1};
        let pattern = data.pattern;
        if (!pattern || pattern === 'random') {
            const opts = ['center', 'corner-tl', 'corner-br'];
            pattern = opts[Math.floor(Math.random() * opts.length)];
        }

        // ===============================================
        // [æ–°å¢] ç¬¬å››ç¨®æ•ˆæœï¼šç·©ç·©ä¸Šå‡ (Pan Up) å°ˆç”¨é‚è¼¯
        // ===============================================
        if (pattern === 'pan_up' || pattern === 'pan_down') {
            // 1. éš±è—ä¸éœ€è¦çš„æ’•è£‚å±¤
            paperLayer.style.display = 'none';
            
            // 2. è¨­å®šå…§å±¤åœ–ç‰‡åˆå§‹ç‹€æ…‹
            if (srcImage) {
                imgLayer.style.backgroundImage = `url(${srcImage})`;
                imgLayer.style.backgroundColor = 'transparent';
            }
            imgLayer.style.clipPath = 'none'; // ä¸è£åˆ‡
            
            // åˆ¤æ–·é‹é¡æ–¹å‘
            // Pan Up (é¡é ­å‘ä¸Š): å…§å®¹å¾ä½è™•(Start +) å¾€ é«˜è™•(End -) ç§»å‹•
            // Pan Down (é¡é ­å‘ä¸‹): å…§å®¹å¾é«˜è™•(Start -) å¾€ ä½è™•(End +) ç§»å‹•
            let startOffset = 15;
            let endOffset = -15;

            if (pattern === 'pan_down') {
                startOffset = -15;
                endOffset = 15;
            }

            const startY = st.y + startOffset;
            const endY = st.y + endOffset;
            
            imgLayer.style.backgroundPosition = `${st.x}% ${startY}%`;
            imgLayer.style.backgroundSize = `${st.scale * 100}%`;
            imgLayer.style.opacity = '0';      // åˆå§‹é€æ˜
            imgLayer.style.transition = 'none'; // ç¬é–“é‡ç½®

            // å¼·åˆ¶é‡ç¹ª
            void imgLayer.offsetWidth;

            // 3. åŸ·è¡Œåºåˆ—å‹•ç•«
            setTimeout(() => {
                // éšæ®µä¸€ï¼šæµ®ç¾ + é–‹å§‹é‹é¡ (ç¸½é•· 4ç§’)
                imgLayer.style.transition = 'opacity 0.8s ease-out, background-position 4s linear';
                
                imgLayer.style.opacity = '1';
                imgLayer.style.backgroundPosition = `${st.x}% ${endY}%`;

                // éšæ®µäºŒï¼šå¿«é€Ÿæ¶ˆé€€ (3.5ç§’è™•)
                setTimeout(() => {
                    imgLayer.style.transition = 'opacity 0.5s ease-in'; 
                    imgLayer.style.opacity = '0';
                }, 3500);

            }, 50);

            // çµæŸå›èª¿
            if (onComplete) setTimeout(onComplete, 4000);
            return;
        }

        // ===============================================
        // ä»¥ä¸‹ç‚ºåŸæœ¬çš„æ’•è£‚ (Tearing) é‚è¼¯
        // ===============================================

        const setLayerStyle = (el, isPaper) => {
            if (!isPaper && srcImage) {
                el.style.backgroundImage = `url(${srcImage})`;
                el.style.backgroundColor = 'transparent';
            } else if (isPaper) {
                el.style.backgroundImage = '';
                el.style.backgroundColor = '';
            } else {
                el.style.backgroundImage = 'none';
                el.style.backgroundColor = 'white';
            }
            
            // [æ’•è£‚ç‰ˆ] é¡é ­ä¸Šç§»ç‰¹æ•ˆï¼šåˆå§‹ä½ç½®è¨­å®š
            // ç‚ºäº†ç‡Ÿé€ é¡é ­æ„Ÿï¼Œæ’•è£‚ç‰ˆæˆ‘å€‘ä¹Ÿä¿ç•™ä¸€é»é»ä½ç§» (+5%)
            let startY = st.y;
            if (!isPaper) startY = st.y + 5; 

            el.style.backgroundPosition = `${st.x}% ${startY}%`;
            el.style.backgroundSize = `${st.scale * 100}%`;
            el.style.opacity = '1';
            el.style.transition = 'none';
        };
        setLayerStyle(imgLayer, false);
        setLayerStyle(paperLayer, true);
        paperLayer.style.display = 'block';

        // B. æº–å‚™éš¨æ©Ÿé‹¸é½’ç¨®å­
        const seedImg = Array.from({length: 100}, () => (Math.random() - 0.5));
        const seedPaper = Array.from({length: 100}, () => (Math.random() - 0.5));

        // C. è¨­å®šåˆå§‹ç‹€æ…‹ (é–‰åˆ)
        const startPolyImg = generateJaggedPoly(0, pattern, seedImg, 'image');
        const startPolyPaper = generateJaggedPoly(0, pattern, seedPaper, 'paper');
        
        imgLayer.style.clipPath = startPolyImg;
        paperLayer.style.clipPath = startPolyPaper;

        // D. é–‹å§‹å‹•ç•«åºåˆ—
        // 1. å¥—ç”¨éœ‡å‹•
        if (ENABLE_OUTER_SHAKE) body.classList.add('shaking-outer');
        if (ENABLE_INNER_SHAKE) body.classList.add('shaking-inner');
        void imgLayer.offsetWidth; // å¼·åˆ¶é‡ç¹ª

        // 2. æ’•è£‚éç¨‹ & é¡é ­ç§»å‹•
        setTimeout(() => {
            // åœ¨ transition ä¸­åŠ å…¥ background-position çš„å¹³æ»‘éæ¸¡
            const transitionCSS = 'clip-path 2.0s cubic-bezier(0.2, 1, 0.3, 1), background-position 2.5s ease-out';
            imgLayer.style.transition = transitionCSS;
            paperLayer.style.transition = transitionCSS;
            
            const endPolyImg = generateJaggedPoly(TEAR_INTENSITY, pattern, seedImg, 'image');
            const endPolyPaper = generateJaggedPoly(TEAR_INTENSITY, pattern, seedPaper, 'paper');
            
            imgLayer.style.clipPath = endPolyImg;
            paperLayer.style.clipPath = endPolyPaper;

            // è¨­å®šé¡é ­ç§»å‹•çš„ç›®æ¨™ä½ç½® (å¾€ä¸Š 5%)
            imgLayer.style.backgroundPosition = `${st.x}% ${st.y - 5}%`;

        }, 100);

        // 3. çµæŸéœ‡å‹•
        setTimeout(() => {
            body.classList.remove('shaking-outer');
            body.classList.remove('shaking-inner');
            if (onComplete) onComplete();
        }, 500);

        // 4. é€€å ´ (æ’•è£‚ç‰ˆé€šå¸¸ä¸è‡ªå‹•æ¶ˆé€€ï¼Œå› ç‚ºå¯èƒ½æœƒé€£çºŒæ’­æ”¾ï¼Œé€™è£¡ç¶­æŒåŸæ¨£)
        setTimeout(() => {
            document.body.style.overflow = ''; // è§£é–æ²è»¸
        }, 2500);
    }
	
	// --- [ä¿®æ­£ç‰ˆ] æ´—ç‰Œå‹•ç•«ç‰¹æ•ˆ (éš±è—åŸå¡ç‰ˆ) ---
    // --- [å„ªåŒ–ç‰ˆ] æ´—ç‰Œå‹•ç•«ç‰¹æ•ˆ (å…¨åºåˆ—åŒ– + éš±è—åŸå¡) ---
    function triggerShuffleAnimation(count, targetZoneId, onComplete) {
        // 1. å–å¾—ç›®æ¨™å€åŸŸ
        const zoneEl = document.querySelector(`.zone[data-zone="${targetZoneId}"]`);
        if (!zoneEl) {
            if (onComplete) onComplete();
            return;
        }
        
        const rect = zoneEl.getBoundingClientRect();
        const destX = rect.left + rect.width / 2 - 25; 
        const destY = rect.top + rect.height / 2 - 35; 

        // [éš±è—åŸå¡]
        const originalCards = zoneEl.querySelectorAll('.card');
        originalCards.forEach(c => c.style.opacity = '0');

        // 2. æº–å‚™å‡å¡ç‰‡
        const visualCount = Math.min(count || 10, 15);
        const flyingCards = [];

        for (let i = 0; i < visualCount; i++) {
            const el = document.createElement('div');
            el.className = 'flying-card';
            
            // åˆå§‹ä½ç½®
            el.style.left = `${destX}px`;
            el.style.top = `${destY}px`;
            el.style.transform = `scale(0.5) rotate(0deg)`; 
            el.style.opacity = '1'; 
            
            document.body.appendChild(el);
            flyingCards.push(el);
        }

        // ------------------------------------------------
        // å‹•ç•«æ™‚é–“åƒæ•¸ (ç§’)
        // ------------------------------------------------
        const STAGGER = 0.03; // æ¯å¼µç‰Œçš„é–“éš”æ™‚é–“
        const DURATION_P1 = 0.4; // å™´ç™¼é£›è¡Œæ™‚é–“
        const DELAY_P2 = 500;    // é€²å…¥äº‚èˆå‰çš„ç­‰å¾… (æ¯«ç§’)
        const DELAY_P3 = 1100;   // é€²å…¥æ”¶æ–‚å‰çš„ç­‰å¾… (æ¯«ç§’)
        const END_TIME = 1900;   // çµæŸæ¸…ç†æ™‚é–“ (æ¯«ç§’)

        // 4. [Phase 1: åºåˆ—å™´ç™¼] 
        requestAnimationFrame(() => {
            flyingCards.forEach((el, i) => {
                // [é—œéµä¿®æ”¹] åŠ å…¥ delay: ${i * STAGGER}sï¼Œè®“ç‰Œä¸€å¼µä¸€å¼µå™´å‡ºä¾†
                el.style.transition = `all ${DURATION_P1}s cubic-bezier(0.175, 0.885, 0.32, 1.275) ${i * STAGGER}s`;
                
                const scatterX = (Math.random() - 0.5) * window.innerWidth * 0.4;
                const scatterY = (Math.random() - 0.5) * window.innerHeight * 0.4;
                const randRot = (Math.random() - 0.5) * 360; 
                
                el.style.transform = `translate(${scatterX}px, ${scatterY}px) rotate(${randRot}deg) scale(1.1)`;
            });
        });

        // 5. [Phase 2: äº‚èˆ] (ç¨å¾®å»¶å¾Œä»¥é…åˆå™´ç™¼çš„å»¶é²)
        setTimeout(() => {
            flyingCards.forEach((el, i) => {
                // é€™é‚Šä¸éœ€è¦å¤ªå¤šå»¶é²ï¼Œè®“å®ƒå€‘ä¸€èµ·äº‚å‹•æ¯”è¼ƒæœ‰æ··æ²Œæ„Ÿï¼Œæˆ–æ˜¯ç¨å¾®éŒ¯é–‹ä¹Ÿå¯ä»¥
                el.style.transition = `all 0.5s ease-in-out ${i * 0.01}s`;
                
                const chaosX = (Math.random() - 0.5) * window.innerWidth * 0.5;
                const chaosY = (Math.random() - 0.5) * window.innerHeight * 0.5;
                const chaosRot = (Math.random() - 0.5) * 720; 
                
                el.style.transform = `translate(${chaosX}px, ${chaosY}px) rotate(${chaosRot}deg) scale(1.1)`;
            });
        }, DELAY_P2);

        // 6. [Phase 3: åºåˆ—æ”¶æ–‚]
        setTimeout(() => {
            flyingCards.forEach((el, i) => {
                // æ”¶å›æ™‚ä¹Ÿä¿æŒé †åºï¼Œçœ‹èµ·ä¾†åƒæ˜¯ä¸€ç–Šä¸€ç–Šæ”¶å›ä¾†
                el.style.transition = `all 0.5s cubic-bezier(0.6, -0.28, 0.735, 0.045) ${i * STAGGER}s`;
                
                el.style.transform = `translate(0px, 0px) rotate(0deg) scale(0.5)`;
                el.style.opacity = '0'; 
            });
        }, DELAY_P3);

        // 7. æ¸…ç†
        setTimeout(() => {
            flyingCards.forEach(el => el.remove());
            
            // [æ¢å¾©åŸå¡]
            originalCards.forEach(c => c.style.opacity = '1');

            if (onComplete) onComplete();
        }, END_TIME); 
    }
	
	// --- [ä¿®æ­£ç‰ˆ] Ending ç‰¹æ•ˆå‡½å¼ (æ‰‹æ©Ÿå­—é«”å„ªåŒ– + å¼·åˆ¶éœéŸ³) ---
	// --- [ä¿®æ­£ç‰ˆ] Ending ç‰¹æ•ˆå‡½å¼ (å‹•æ…‹åå–® + è‡ªå‹•æ²å‹•) ---
	function triggerEnding() {
		console.log("ğŸ“º è§¸ç™¼ CRT é—œæ©Ÿç‰¹æ•ˆ...");

		// 2. åŠ ä¸Š class è§¸ç™¼ CSS å‹•ç•«
		document.body.classList.add('shutdown-mode');

		// 3. é¡¯ç¤º FIN å­—å¹•ä¸¦å‹•æ…‹ç”Ÿæˆåå–®
		setTimeout(() => {
			const overlay = document.getElementById('ending-overlay');
			if (overlay) {
				overlay.style.display = 'flex';
				overlay.style.pointerEvents = 'auto';
				void overlay.offsetWidth; 
				overlay.style.opacity = 1; 

				// --- [æ ¸å¿ƒä¿®æ”¹é–‹å§‹] å‹•æ…‹ç”Ÿæˆ Credit ---
				const creditsContainer = overlay.querySelector('.end-credits');
				if (creditsContainer) {
					// (A) å®šç¾©å›ºå®šçš„åŸºç¤åå–® (å‰ä¸‰å€‹ Block)
					let html = `
						<div class="credit-group">
							<div class="credit-role">Project Lead & Design</div>
							<div class="credit-name">Ether</div>
						</div>
						<div class="credit-group">
							<div class="credit-role">Coding & Implementation</div>
							<div class="credit-name">Google Gemini</div>
						</div>
						<div class="credit-group">
							<div class="credit-role">Music / BGM Assets</div>
							<div class="credit-name">é­”ç‹é­‚ (MaouDamashii)</div>
						</div>
					`;

					// (B) è®€å–å‹•æ…‹åå–®ä¸¦åŠ å…¥
					if (currentScriptConfig && currentScriptConfig.credits) {
						currentScriptConfig.credits.forEach(c => {
							html += `
								<div class="credit-group">
									<div class="credit-role">${c.role}</div>
									<div class="credit-name">${c.name}</div>
								</div>
							`;
						});
					}

					creditsContainer.innerHTML = html;

					// (C) å•Ÿå‹•è‡ªå‹•æ…¢æ²é‚è¼¯ (Auto Scroll)
					// å»¶é² 2.5ç§’ (ç­‰å¾… slideUp å‹•ç•«è·‘å®Œèˆ‡è§€çœ¾é–±è®€é–‹é ­) å¾Œé–‹å§‹æ²å‹•
					setTimeout(() => {
						autoScrollCredits(creditsContainer);
					}, 2500);
				}
				// --- [æ ¸å¿ƒä¿®æ”¹çµæŸ] ---
			}

			// è£ç½®åˆ¤æ–·é‚è¼¯ (ä¿æŒåŸæ¨£ï¼Œæˆ–è¦–éœ€æ±‚èª¿æ•´åœç•™æ™‚é–“)
			const isMobile = document.body.classList.contains('mobile-mode');
			if (!isMobile) {
				// [æ¡Œæ©Ÿç‰ˆ]ï¼šçµ¦äºˆæ›´é•·çš„é–±è®€æ™‚é–“ï¼Œå› ç‚ºç¾åœ¨æœ‰æ²å‹•
				// å»ºè­°æ”¹ç‚ºç”±é»æ“Šè§¸ç™¼é‡ç½®ï¼Œæˆ–æ˜¯è¨­å®šä¸€å€‹è¼ƒé•·çš„ timeout (ä¾‹å¦‚ 10ç§’)
				// é€™è£¡ç¤ºç¯„æ”¹ç‚º 15ç§’å¾Œè‡ªå‹•é‡ç½®
				setTimeout(() => {
					globalAudioPlayer.pause();
					resetEnding();
				}, 7000); 
			} else {
				setTimeout(() => {
					globalAudioPlayer.pause();
				}, 7000); 
			}

		}, 500); 
	}

	// [æ–°å¢] è‡ªå‹•æ²å‹•è¼”åŠ©å‡½å¼
	function autoScrollCredits(element) {
		// å¦‚æœå…§å®¹æ²’æœ‰æº¢å‡ºï¼Œå°±ä¸æ²å‹•
		if (element.scrollHeight <= element.clientHeight) return;

		let scrollAmount = 0;
		const speed = 0.5; // æ²å‹•é€Ÿåº¦ (åƒç´ /frame)ï¼Œè¶Šå°è¶Šæ…¢

		function step() {
			// å¦‚æœ Ending ç•«é¢è¢«é—œé–‰äº†ï¼Œåœæ­¢æ²å‹•
			if (document.getElementById('ending-overlay').style.display === 'none') return;

			scrollAmount += speed;
			element.scrollTop = scrollAmount;

			// å¦‚æœé‚„æ²’æ²åˆ°åº•ï¼Œç¹¼çºŒæ²
			if (scrollAmount < (element.scrollHeight - element.clientHeight + 50)) { // +50 æ˜¯ç·©è¡
				requestAnimationFrame(step);
			}
		}
		
		requestAnimationFrame(step);
	}

	// æ¸¬è©¦ç”¨ï¼šé›™æ“Šè¢å¹•å·¦ä¸Šè§’å¯é‡ç½® (éš±è— Ending å›åˆ°ç·¨è¼¯å™¨)
	// é€™æ–¹ä¾¿ä½ åœ¨ç·¨è¼¯æ™‚å¦‚æœä¸å°å¿ƒè§¸ç™¼äº†ï¼Œå¯ä»¥é»å›ä¾†
	document.addEventListener('dblclick', (e) => {
		if (e.clientX < 50 && e.clientY < 50) {
			resetEnding();
		}
	});

	function resetEnding() {
	
		// ç§»é™¤å‹•ç•« Class
		document.body.classList.remove('shutdown-mode');
		
		// éš±è—é®ç½©
		const overlay = document.getElementById('ending-overlay');
		if (overlay) {
			overlay.style.opacity = 0;
			overlay.style.pointerEvents = 'none';
			setTimeout(() => { overlay.style.display = 'none'; }, 1000);
		}

		// [æ¡Œæ©Ÿç‰ˆé—œéµ]ï¼šç§»é™¤ is-playingï¼Œé€™æœƒè®“ç·¨è¼¯å™¨ä»‹é¢ (Toolbar, Timeline) é‡æ–°å‡ºç¾
		// ä½¿ç”¨è€…æ­¤æ™‚æœƒåœåœ¨æœ€å¾Œä¸€å€‹æ­¥é©Ÿï¼Œå¯ä»¥ç›´æ¥é–‹å§‹æ–°å¢ Action Log
		document.body.classList.remove('is-playing');
		updatePlayButtonUI();
	}
	
	async function exportReversedWithMirror() {
		console.log("ğŸš€ é–‹å§‹ç”Ÿæˆã€å®Œå…¨ç¿»è½‰+é ­åƒé¡å°„ã€‘åŠ‡æœ¬...");

		// 1. åŸºç¤å·¥å…·ï¼šåè½‰ ID èˆ‡ å€åŸŸå­—ä¸²
		const flipId = (id) => (id === 1 ? 2 : (id === 2 ? 1 : id));
		const flipZone = (zone) => {
			if (!zone || typeof zone !== 'string') return zone;
			if (zone.includes('p1')) return zone.replace('p1', 'p2');
			if (zone.includes('p2')) return zone.replace('p2', 'p1');
			return zone;
		};

		// 2. åœ–ç‰‡è™•ç†å·¥å…·ï¼šæ°´å¹³ç¿»è½‰
		const flipImageBitmap = (base64) => {
			return new Promise((resolve) => {
				const img = new Image();
				img.onload = () => {
					const canvas = document.createElement('canvas');
					canvas.width = img.width;
					canvas.height = img.height;
					const ctx = canvas.getContext('2d');
					// æ°´å¹³ç¿»è½‰çŸ©é™£
					ctx.translate(canvas.width, 0);
					ctx.scale(-1, 1);
					ctx.drawImage(img, 0, 0);
					resolve(canvas.toDataURL('image/jpeg', 0.85));
				};
				img.onerror = () => resolve(base64); // å¤±æ•—å‰‡å›å‚³åŸåœ–
				img.src = base64;
			});
		};

		// 3. ç¿»è½‰ State (å¡ç‰‡æ­¸å±¬ã€å€åŸŸ)
		const flipState = (state) => {
			if (!state) return null;
			const newState = JSON.parse(JSON.stringify(state));

			if (newState.turnPlayer) newState.turnPlayer = flipId(newState.turnPlayer);
			if (newState.winner) newState.winner = flipId(newState.winner);

			if (newState.cards) {
				newState.cards.forEach(c => {
					c.ownerId = flipId(c.ownerId);
					c.zone = flipZone(c.zone);
				});
			}

			// å°è©±èˆ‡çŒœæ‹³è³‡æ–™åè½‰
			if (newState.dialogueData) {
				const temp = newState.dialogueData.p1;
				newState.dialogueData.p1 = newState.dialogueData.p2;
				newState.dialogueData.p2 = temp;
			}
			if (newState.rpsResult) {
				const temp = newState.rpsResult.p1;
				newState.rpsResult.p1 = newState.rpsResult.p2;
				newState.rpsResult.p2 = temp;
				if (newState.rpsResult.winner) newState.rpsResult.winner = flipId(newState.rpsResult.winner);
			}
			return newState;
		};

		// 4. ç¿»è½‰ History (å«æŒ‡å‘ä¿®æ­£)
		const reversedHistory = history.map((step, index) => {
			const newStep = { action: JSON.parse(JSON.stringify(step.action)) };

			if (newStep.action.operations) {
				newStep.action.operations.forEach(op => {
					// åŸºæœ¬å€åŸŸåè½‰
					if (op.toZone) op.toZone = flipZone(op.toZone);
					if (op.zoneId) op.zoneId = flipZone(op.zoneId);
					if (op.targetZone) op.targetZone = flipZone(op.targetZone);
					if (op.playerId) op.playerId = flipId(op.playerId);
					if (op.winnerId) op.winnerId = flipId(op.winnerId);

					// å°è©±/çŒœæ‹³
					if (op.type === 'DIALOGUE' && op.data) {
						const temp = op.data.p1;
						op.data.p1 = op.data.p2;
						op.data.p2 = temp;
					}
					if (op.type === 'RPS' && op.data) {
						const temp = op.data.p1;
						op.data.p1 = op.data.p2;
						op.data.p2 = temp;
						if (op.data.winner) op.data.winner = flipId(op.data.winner);
					}

					// [é‡é» 1] æŒ‡å‘æ“ä½œä¿®æ­£ (POINT)
					if (op.type === 'POINT' || op.type === 'ATTACK') {
						// å¦‚æœæ˜¯æŒ‡å‘ã€Œå€åŸŸã€(ZONE) æˆ–ã€Œç©å®¶ã€(PLAYER - é€šå¸¸æŒ‡ç‰Œåº«)ï¼Œå­—ä¸²ä¹Ÿè¦ç¿»è½‰
						// ä¾‹å¦‚: p1 æŒ‡å‘ 'p2-deck'ï¼Œç¿»è½‰å¾Œè®Š p2 æŒ‡å‘ 'p1-deck'
						if (op.targetType === 'ZONE' && Array.isArray(op.targetIds)) {
							op.targetIds = op.targetIds.map(zid => flipZone(zid));
						}
						
						// å¦‚æœæ˜¯æŒ‡å‘ Card ID (æ•¸å­—)ï¼Œä¸éœ€è¦æ”¹ ID
						// å› ç‚ºå¡ç‰‡æœ¬èº«å·²ç¶“é€é flipState æ›äº†ä¸»äººï¼ŒID æ²’è®Šä½†å±¬æ€§è®Šäº†ï¼ŒæŒ‡å‘é—œä¿‚è‡ªç„¶æˆç«‹
					}
				});
			}

			if (index === 0) newStep.state = flipState(initialState);
			if (step.detachedStartState) newStep.detachedStartState = flipState(step.detachedStartState);

			return newStep;
		});

		// 5. [é‡é» 2] åœ–ç‰‡è™•ç†ï¼šKey äº¤æ› + åœ–åƒé¡å°„
		const newImageRegistry = {};
		
		// å…ˆè¤‡è£½ä¸€èˆ¬å¡ç‰‡åœ– (ä¸éœ€è®Šå‹•)
		Object.keys(globalImageRegistry).forEach(key => {
			if (!key.startsWith('avatar_')) {
				newImageRegistry[key] = globalImageRegistry[key];
			}
		});

		// è™•ç†é ­åƒ (Avatar)
		const avatarKeys = Object.keys(globalImageRegistry).filter(k => k.startsWith('avatar_'));
		
		for (let key of avatarKeys) {
			let newKey = key;
			// Key äº¤æ›ï¼šP1 -> P2, P2 -> P1
			if (key.includes('_p1_')) newKey = key.replace('_p1_', '_p2_');
			else if (key.includes('_p2_')) newKey = key.replace('_p2_', '_p1_');

			// åœ–åƒé¡å°„ (Mirroring)
			const originalBase64 = globalImageRegistry[key];
			if (originalBase64) {
				// ç­‰å¾…åœ–ç‰‡è™•ç†å®Œæˆ
				const flippedBase64 = await flipImageBitmap(originalBase64);
				newImageRegistry[newKey] = flippedBase64;
				console.log(`[Img] Swapped & Mirrored: ${key} -> ${newKey}`);
			}
		}

		// 6. ä¸»é¡Œé¡è‰²äº¤æ›
		let newThemeSettings = { p1: 'blue', p2: 'red' };
		if (typeof globalThemeSettings !== 'undefined') {
			newThemeSettings = JSON.parse(JSON.stringify(globalThemeSettings));
			const tempColor = newThemeSettings.p1;
			newThemeSettings.p1 = newThemeSettings.p2;
			newThemeSettings.p2 = tempColor;
		}

		// 7. æ‰“åŒ…èˆ‡ä¸‹è¼‰
		const exportData = {
			history: reversedHistory,
			initialState: flipState(initialState),
			currentIndex: currentIndex,
			timestamp: Date.now(),
			imageRegistry: newImageRegistry,
			abilityRegistry: globalAbilityStyleRegistry,
			lastUsedStyles: globalLastUsedStyles,
			lastDiagSettings: null, 
			aceRegistry: globalAceRegistry, 
			themeSettings: newThemeSettings
		};

		const blob = new Blob([JSON.stringify(exportData, null, 2)], {type:"text/plain"});
		const a = document.createElement('a');
		a.href = URL.createObjectURL(blob);
		a.download = `dm-script-reversed-mirror-${Date.now()}.txt`;
		document.body.appendChild(a);
		a.click();
		document.body.removeChild(a);

		console.log("âœ… åŒ¯å‡ºå®Œæˆï¼");
	}
	
	// --- [æ–°å¢] è¼‰å…¥å¤–éƒ¨åœ–ç‰‡ URL ---
	function loadRbUrl(url) {
		if (!url) return;
		
		// é¡¯ç¤ºè¼‰å…¥ä¸­æç¤º (å¯é¸)
		const layer = document.getElementById('rb-inner-layer');
		layer.style.opacity = 0.5;

		const img = new Image();
		img.crossOrigin = "Anonymous"; // å˜—è©¦è·¨åŸŸï¼Œé›–ç„¶å° CSS background å½±éŸ¿ä¸å¤§ï¼Œä½†å¥½ç¿’æ…£
		
		img.onload = () => {
			// è¼‰å…¥æˆåŠŸ
			rbEditorState.imgData = null; // æ¸…ç©º Base64
			rbEditorState.imgUrl = url;   // è¨˜éŒ„ URL
			rbEditorState.sourceType = 'url'; // æ¨™è¨˜ä¾†æºç‚º URL
			
			// æ›´æ–° UI
			layer.style.backgroundImage = `url(${url})`;
			layer.style.backgroundColor = 'transparent';
			layer.style.opacity = 1;
			
			// éš±è—æç¤ºæ–‡å­—
			const hint = document.getElementById('rb-edit-hint');
			if(hint) hint.style.display = 'none';
			
			console.log("å¤–éƒ¨åœ–ç‰‡è¼‰å…¥æˆåŠŸ");
		};
		
		img.onerror = () => {
			alert("ç„¡æ³•è®€å–åœ–ç‰‡ç¶²å€ (å¯èƒ½é€£çµç„¡æ•ˆæˆ–å­˜å–è¢«æ‹’)ã€‚");
			layer.style.opacity = 1;
			// æ¸…ç©ºè¼¸å…¥æ¡†ä»¥ç¤ºå¤±æ•—
			document.getElementById('rb-url-input').value = '';
		};
		
		img.src = url;
	}
	
</script>
<div id="visitor-counter" style="display:none"></div>
<div id="ace-flash-layer"></div>
<div id="mobile-card-viewer" onclick="hideMobileCardZoom()"></div>
<div id="mobile-script-selector">
    <h2 style="color:white; margin:0 0 10px 0;" data-i18n="title_select_script">é¸æ“‡åŠ‡æœ¬ (Select Script)</h2>
    <div class="script-list-container" id="script-list-body">
        </div>
    <button id="btn-mobile-start" onclick="confirmMobileScript()" disabled>â–¶ START</button>
</div>
<div id="ending-overlay">
    <div class="end-title">FIN.</div>
    <div class="end-sub">Thanks for Watching</div>
    
    <div class="end-credits">
        <div class="credit-group">
            <div class="credit-role">Project Lead & Design</div>
            <div class="credit-name">Ether</div>
        </div>
        <div class="credit-group">
            <div class="credit-role">Coding & Implementation</div>
            <div class="credit-name">Google Gemini</div>
        </div>
        <div class="credit-group">
            <div class="credit-role">Music / BGM Assets</div>
            <div class="credit-name">é­”ç‹é­‚ (MaouDamashii)</div>
        </div>
    </div>
</div>
<div id="rps-overlay"></div>
<div id="emotion-preview-tooltip"></div>
<div id="rb-overlay">
    <div id="rb-paper-layer"></div>
    
    <div id="rb-inner-layer"></div>
    
    <div id="rb-edit-hint" data-i18n="msg_rb_hint">
        é»æ“Šæ­¤è™•ä¸¦æŒ‰ä¸‹ Ctrl+V è²¼ä¸Šåœ–ç‰‡<br>
        (æ‹–æ›³å¯ç§»å‹•ï¼Œæ»¾è¼ªå¯ç¸®æ”¾)
    </div>
    <div id="rb-flash-layer"></div>
    
    <div id="rb-controls">
		<div style="background:rgba(0,0,0,0.85); padding:8px 20px; border-radius:40px; color:white; display:flex; gap:12px; align-items:center;">
			<div style="display:flex; flex-direction:column; gap:2px;">
				<span data-i18n="lbl_rb_style" style="font-size:0.75rem; color:#aaa;">ç‰¹æ•ˆæ¨£å¼:</span>
				<select id="rb-pattern-select" style="background:#333; color:white; border:1px solid #555; padding:2px; width:100px;">
					<option value="random" data-i18n="opt_rb_random">ğŸ² éš¨æ©Ÿ (Random)</option>
					<option value="center" data-i18n="opt_rb_center">âš¡ ä¸­é–“æ’•è£‚ (Center)</option>
					<option value="corner-tl" data-i18n="opt_rb_tl">ğŸ“ å·¦ä¸Šæ’•è£‚ (Top-Left)</option>
					<option value="corner-br" data-i18n="opt_rb_br">ğŸ“ å³ä¸‹æ’•è£‚ (Btm-Right)</option>
					<option value="pan_up" data-i18n="opt_rb_pan_up">ğŸ”¼ ç·©ç·©ä¸Šå‡ (Pan Up)</option>
					<option value="pan_down" data-i18n="opt_rb_pan_down">ğŸ”½ ç·©ç·©ä¸‹é™ (Pan Down)</option>
				</select>
			</div>
			<div style="display:flex; flex-direction:column; gap:2px;">
				<span style="font-size:0.75rem; color:#aaa;">Image URL / Paste:</span>
				<input type="text" id="rb-url-input" placeholder="https://..." onchange="loadRbUrl(this.value)" onkeydown="if(event.key==='Enter') loadRbUrl(this.value)">
			</div>
			<div style="width:1px; height:30px; background:#555;"></div>

			<div style="display:flex; flex-direction:column; gap:4px; font-size:0.8rem;">
				<label style="cursor:pointer; display:flex; align-items:center;"><input type="checkbox" id="rb-shake-inner" checked> <span data-i18n="lbl_rb_shake_in" style="margin-left:4px;">å…§éœ‡</span></label>
				<label style="cursor:pointer; display:flex; align-items:center;"><input type="checkbox" id="rb-shake-outer"> <span data-i18n="lbl_rb_shake_out" style="margin-left:4px;">å¤–éœ‡</span></label>
			</div>

			<div style="display:flex; flex-direction:column; align-items:center; width:80px;">
				<div style="display:flex; justify-content:space-between; width:100%; font-size:0.7rem; color:#aaa;">
					<span data-i18n="lbl_rb_intensity">è£‚åº¦:</span>
					<span id="rb-intensity-val">0.7</span>
				</div>
				<input type="range" id="rb-intensity" min="0.1" max="1.5" step="0.1" value="0.7" style="width:100%; cursor:pointer;" oninput="document.getElementById('rb-intensity-val').innerText=this.value">
			</div>

			<div style="width:1px; height:30px; background:#555;"></div>

			<button onclick="previewRbEffect()" style="background:#3498db; border:none; border-radius:4px; color:white; cursor:pointer; padding:5px 10px;" data-i18n="btn_preview">â–¶ é è¦½</button>
			<button onclick="confirmRbEffect()" style="background:#2ecc71; border:none; border-radius:4px; color:white; cursor:pointer; font-weight:bold; padding:5px 15px;" data-i18n="btn_save">ğŸ’¾ å„²å­˜</button>
			<button onclick="closeRbEditor()" style="background:#e74c3c; border:none; border-radius:4px; color:white; cursor:pointer; padding:5px 10px;" data-i18n="btn_cancel">âœ•</button>
		</div>
	</div>
</div>
<div id="import-selector-modal" class="modal">
    <div class="modal-content" style="width: 500px; max-height: 80vh; display:flex; flex-direction:column;">
        <h3 style="margin-top:0; text-align:center;" data-i18n="title_import_source">é¸æ“‡åŒ¯å…¥ä¾†æº (Import Source)</h3>
        
        <div style="padding: 15px; background: #f0f4f7; border-radius: 8px; text-align: center; margin-bottom: 15px;">
            <button onclick="triggerLocalImport()" style="font-size:1rem; padding:10px 20px; width:100%; background:#3498db; border-color:#2980b9;" data-i18n="btn_local_file">
                ğŸ“‚ é¸æ“‡æœ¬åœ°æª”æ¡ˆ (.txt/.json)
            </button>
        </div>

        <div style="text-align: center; font-weight: bold; color: #7f8c8d; margin-bottom: 10px;" data-i18n="lbl_or_examples">
            â–¼ æˆ–é¸æ“‡ç¯„ä¾‹åŠ‡æœ¬ (Built-in Scripts) â–¼
        </div>

        <div id="import-script-list" style="flex:1; overflow-y:auto; border:1px solid #ddd; border-radius:4px; background:#fff;">
            </div>

        <div style="text-align:right; margin-top:15px;">
            <button class="danger" onclick="document.getElementById('import-selector-modal').style.display='none'" data-i18n="btn_cancel">å–æ¶ˆ (Cancel)</button>
        </div>
    </div>
</div>
<div id="turn-transition-overlay">
    <div id="tto-content">
        <span id="tto-text">TURN START</span>
    </div>
</div>
<div id="deck-context-menu">
    <ul>
        <li onclick="runDeckContextAction('shuffle')" data-i18n="ctx_shuffle">ğŸ”„ æ´—ç‰Œ</li>
        <li onclick="runDeckContextAction('move')" data-i18n="ctx_move">â¡ï¸ ç§»å‹•å¡ç‰‡...</li>
        <li onclick="runDeckContextAction('recall')" data-i18n="ctx_recall">ğŸ”™ å…¨éƒ¨æ”¶å›</li>
        
        <li class="separator" style="height:1px; background:#eee; margin:5px 0; cursor:default;"></li>
        <li onclick="document.getElementById('deck-context-menu').style.display='none'" style="color:#e74c3c;" data-i18n="ctx_close">âœ– é—œé–‰é¸å–®</li>
    </ul>
</div>

<div id="deck-move-modal" class="modal">
    <div class="zone-close-btn" onclick="document.getElementById('deck-move-modal').style.display='none'">âœ•</div>
    
    <div class="modal-content">
        <h3 style="margin-top:0; color:#2c3e50; text-align:center;" data-i18n="title_move_modal">å¾ç‰Œåº«é ‚ç§»å‹•</h3>
        
        <label style="display:block; margin-bottom:5px; font-weight:bold; color:#7f8c8d;" data-i18n="lbl_qty">æ•¸é‡:</label>
        <div class="qty-group">
            <button class="qty-btn active" onclick="setMoveQty(1)">1</button>
            <button class="qty-btn" onclick="setMoveQty(2)">2</button>
            <button class="qty-btn" onclick="setMoveQty(3)">3</button>
            <button class="qty-btn" onclick="setMoveQty(4)">4</button>
            <button class="qty-btn" onclick="setMoveQty(5)">5</button>
            <button class="qty-btn" onclick="setMoveQty(6)">6</button>
            <input type="number" id="dm-qty" value="1" min="1" max="40" oninput="updateQtyBtnState(this.value)">
        </div>
        
        <label style="display:block; margin-bottom:5px; font-weight:bold; color:#7f8c8d;" data-i18n="lbl_dest">ç§»å‹•åˆ°:</label>
        
        <input type="hidden" id="dm-target-val" value="hand">

        <div class="dest-grid">
            <div class="dest-btn active" onclick="setMoveDest('hand', this)">
                <i>âœ‹</i> <span data-i18n="dest_hand">æ‰‹ç‰Œ</span>
            </div>
            <div style="display: flex; width: 100%; margin-bottom: 5px;"> 
    
				<div class="dest-btn" onclick="setMoveDest('mana', this)" 
					 style="flex-grow: 1; margin: 0; border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: none; display: flex; align-items: center; justify-content: flex-start; padding-left: 10px; gap: 6px;">
					<i>ğŸ’§</i> <span data-i18n="dest_mana">é­”åŠ›å€</span>
				</div>

				<div id="btn-tap-modifier" onclick="toggleTapModifier(event, this)" 
					 style="width: 40px; min-width: 40px; border: 1px solid #444; border-left: 1px solid rgba(255,255,255,0.2); border-top-right-radius: 4px; border-bottom-right-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: rgba(0,0,0,0.3);"
					 title="åˆ‡æ›æ˜¯å¦æ©«ç½® (é è¨­: å€’ç½®)">
					<span style="font-size: 1.2em; filter: grayscale(100%); opacity: 0.5;">â¤µï¸</span>
				</div>

			</div>
            <div class="dest-btn" onclick="setMoveDest('shield', this)">
                <i>ğŸ›¡ï¸</i> <span data-i18n="dest_shield">è­·ç›¾å€</span>
            </div>
            <div class="dest-btn" onclick="setMoveDest('grave', this)">
                <i>ğŸ’€</i> <span data-i18n="dest_grave">å¢“åœ°</span>
            </div>
            <div style="display: flex; width: 100%; margin-bottom: 5px;"> 
    
				<div class="dest-btn" onclick="setMoveDest('battle', this)" 
					 style="flex-grow: 1; margin: 0; border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: none; display: flex; align-items: center; justify-content: flex-start; padding-left: 10px; gap: 6px;">
					<i>âš”ï¸</i> <span data-i18n="dest_battle">æˆ°é¬¥å ´</span>
				</div>

				<div id="btn-facedown-modifier" onclick="toggleFaceDownModifier(event, this)" 
					 style="width: 40px; min-width: 40px; border: 1px solid #444; border-left: 1px solid rgba(255,255,255,0.2); border-top-right-radius: 4px; border-bottom-right-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: rgba(0,0,0,0.3);"
					 title="åˆ‡æ›æ˜¯å¦è“‹ç‰Œ (Face Down)">
					<span style="font-size: 1.2em; filter: grayscale(100%); opacity: 0.5;">â¬›ï¸</span>
				</div>

			</div>
            <div class="dest-btn" onclick="setMoveDest('reveal', this)">
                <i>ğŸ‘ï¸</i> <span data-i18n="dest_reveal">å±•ç¤ºå€</span>
            </div>
            <div class="dest-btn" onclick="setMoveDest('hyper', this)">
                <i>ğŸŒ€</i> <span data-i18n="dest_hyper">è¶…æ¬¡å…ƒ</span>
            </div>
            <div class="dest-btn" onclick="setMoveDest('abyss', this)">
                <i>ğŸŒ‘</i> <span data-i18n="dest_abyss">æ·±æ·µ</span>
            </div>
        </div>
        
        <div class="dm-btns">
            <button class="danger" onclick="document.getElementById('deck-move-modal').style.display='none'" data-i18n="btn_cancel">å–æ¶ˆ</button>
            <button class="primary" onclick="confirmDeckMove()" data-i18n="btn_do_move">ç¢ºèªç§»å‹•</button>
        </div>
    </div>
</div>
</body>
</html>