<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Animated Journey Script Editor</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- å¼•å…¥ Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  /* ç¢ºä¿åœ°åœ–ä½”æ»¿å‰©ä¸‹çš„ç©ºé–“ */
  #map { height: 100%; width: 100%; }
  /* ç¢ºä¿ DivIcon å…§çš„ Emoji å±…ä¸­ */
  .leaflet-div-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
  }
  /* å¤œé–“é®ç½©æ¨£å¼ï¼Œåˆå§‹ç‚ºé€æ˜ï¼Œç­‰å¾… JS æ§åˆ¶ */
  #night-overlay {
    background-color: black;
    opacity: 0;
    pointer-events: none; /* è®“é»æ“Šäº‹ä»¶ç©¿é€ */
    transition-property: opacity;
  }
  /* è‡ªè¨‚æ¨£å¼ï¼šæ”¾å¤§æç¤ºè¦–çª— (Popup) */
  .custom-large-popup .leaflet-popup-content-wrapper {
    /* æ¡Œé¢é è¨­å¤§å° (~3x) */
    font-size: 1.5rem; 
    line-height: 2rem;
    padding: 1.5rem;
    border-radius: 1rem;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    background-color: #fefcbf; /* æŸ”å’Œé»ƒè‰²èƒŒæ™¯ */
    color: #444;
  }
  .custom-large-popup .leaflet-popup-tip {
    background-color: #fefcbf;
    width: 20px;
    height: 10px;
  }
  .custom-large-popup .leaflet-popup-content {
      /* ç¢ºä¿å…§å®¹å¯ä»¥æ’é–‹ */
      width: 100%; 
      max-width: 300px;
      text-align: center;
      font-weight: bold;
  }
  /* æ¨¡æ…‹æ¡†å…§å®¹çš„éæ¸¡æ•ˆæœ */
  .modal-transition {
      transition: opacity 0.3s, transform 0.3s;
  }
  /* --- éŒ¨é»æ’å…¥ UI (ä¿®æ­£: çµ±ä¸€ä½¿ç”¨ CSS è™•ç†æ‡¸åœ) --- */
  .insert-anchor {
      min-height: 10px; /* ç¢ºä¿æœ€å°é»æ“Šç›®æ¨™ */
      margin: 8px 0;
      transition: all 0.2s ease-in-out;
      cursor: pointer;
      background-color: #f9fafb; /* bg-gray-50 */
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #e5e7eb; /* é è¨­é‚Šæ¡† */
  }
  /* æ‡¸åœæ™‚çš„ç‹€æ…‹: å¢åŠ é«˜åº¦ï¼Œé¡¯ç¤ºè™›ç·šæ¡†å’Œæ–‡å­— */
  .insert-anchor:hover {
      min-height: 80px; /* å¢åŠ é«˜åº¦ï¼Œæ¥è¿‘ä¸€å€‹æ­¥é©Ÿå¡ç‰‡ */
      opacity: 1; 
      border: 3px dashed #6366f1; /* indigo-500 */
      background-color: #eef2ff; /* indigo-50 */
  }
  /* æ‡¸åœæ™‚æ‰é¡¯ç¤ºæ–‡å­— */
  .insert-anchor:hover .insert-anchor-text {
      opacity: 1;
  }
  .insert-anchor-text {
      opacity: 0;
      font-weight: bold;
      color: #6366f1;
      transition: opacity 0.2s;
      pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ° anchor */
  }

  /* æ­¥é©Ÿå¡ç‰‡åŸºç¤æ¨£å¼ï¼Œå…è¨±é»æ“Š (ç§»é™¤ Focus ç›¸é—œæ¨£å¼) */
  .step-card {
      transition: background-color 0.1s, box-shadow 0.2s;
  }
  .step-card:hover {
      background-color: #f3f4f6; /* bg-gray-100 */
  }

  /* éŸ¿æ‡‰å¼ï¼šå¼·åˆ¶ç¸±å‘ä½ˆå±€ */
  @media (max-width: 767px) {
    .mobile-h-half {
        height: 50%;
    }
    /* ä¿®æ­£ 2: è¡Œå‹•è£ç½® ICON ç¸®å°åˆ° 40px */
    .leaflet-div-icon div {
        font-size: 40px !important;
    }
    /* ä¿®æ­£ 1: è¡Œå‹•è£ç½® POPUP ç¸®å°åˆ° 1/3 */
    .custom-large-popup .leaflet-popup-content-wrapper {
        font-size: 0.85rem; /* ç´„ 1/3 */
        line-height: 1.25rem; 
        padding: 0.75rem; /* é‚Šè·ç¸®å° */
    }
  }

  /* ä¿®æ­£ 1: è®“æ‹‰åˆ°åº•éƒ¨æŒ‰éˆ•åœ¨ controls å®¹å™¨å…§æ­£å¸¸æµ®å‹• */
  #scroll-to-bottom-container {
      position: sticky;
      bottom: 0;
      z-index: 10;
      /* ç§»é™¤çµ•å°å®šä½ï¼Œä½¿ç”¨ sticky */
  }
</style>
<!-- å¼•å…¥ Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// =================================================================
// 1. å…¨åŸŸå¸¸æ•¸èˆ‡è®Šæ•¸è²æ˜ (æœ€é ‚å±¤)
// =================================================================
const STORAGE_KEY = 'animatedJourneyScript';
const EXPIRY_MS = 2 * 24 * 60 * 60 * 1000; // 2 å¤© (æ¯«ç§’)
const FILE_EXTENSION = '.txt'; // ä¿®æ”¹ç‚ºæ›´é€šç”¨çš„ .txt ä»¥æé«˜ iOS å…¼å®¹æ€§
const ARC_HEIGHT_DEG = 0.5; // é£›æ©Ÿå¼§ç·šè·¯å¾‘çš„æœ€é«˜é»æŠ¬å‡ç·¯åº¦ (ç´„ 55 å…¬é‡Œ)
const ARC_SEGMENTS = 25; // é£›æ©Ÿå¼§ç·šè·¯å¾‘åˆ†æ®µæ•¸ï¼Œè¶Šå¤šè¶Šå¹³æ»‘
const MAX_IMAGE_WIDTH = 200; // åœ–ç‰‡å£“ç¸®å¾Œçš„å¯¬åº¦ä¸Šé™
const PHOTO_STANDALONE_DURATION = 2.5; // ç§»å‹•å’Œè¨Šæ¯æ­¥é©Ÿç…§ç‰‡ç¨ç«‹æ’­æ”¾æ™‚é•· (ç§’)

const iconSize = 75; // æ¡Œé¢é è¨­å¤§å°
// èª¿æ•´ 2: icon ä¸‹æ‹‰é¸å–®çš„é¸é …å‘ˆç¾æ”¹ç‚º emoji
const ICON_NAMES = [
    { name: 'train', emoji: 'ğŸš†' },
    { name: 'walk', emoji: 'ğŸš¶â€â™‚ï¸' },
    { name: 'dine', emoji: 'ğŸ½ï¸' },
    { name: 'sleep', emoji: 'ğŸ˜´' },
    { name: 'bus', emoji: 'ğŸšŒ' },
    { name: 'motorcycle', emoji: 'ğŸï¸' },
    { name: 'car', emoji: 'ğŸš—' },
    { name: 'view', emoji: 'ğŸï¸' },
    { name: 'shopping', emoji: 'ğŸ›ï¸' },
    { name: 'airplane', emoji: 'âœˆï¸' }
];

// æ ¹æ“š ICON_NAMES å»ºç«‹ icons ç‰©ä»¶ï¼Œæ–¹ä¾¿æŸ¥æ‰¾
const icons = ICON_NAMES.reduce((acc, item) => {
    acc[item.name] = L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">${item.emoji}</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] });
    return acc;
}, {});

const INITIAL_GPS = [26.20178415387677, 127.64689003446617];
const START_STEP_DEFINITION = { 
    type: 'start', 
    lat: INITIAL_GPS[0], 
    lng: INITIAL_GPS[1], 
    label: 'é‚£éœ¸æ©Ÿå ´ (åˆå§‹ä½ç½®)' 
};

// ä½¿ç”¨ let è²æ˜ï¼Œä»¥ä¾¿åœ¨ DOMContentLoaded ä¸­è³¦å€¼ (è§£æ±º Map container not found)
let mapInstance = null;
let marker = null;
let polyline = null;
let popup = null;
let imageModal = null; // åœ–ç‰‡é¡¯ç¤ºæ¨¡æ…‹æ¡†
let currentAnimation = false;
let isScriptRunning = false;
let isPaused = false;
let pauseResolve = null; 
let currentWaitTimeoutId = null;
let currentWaitRemainingTime = 0;
let currentWaitStartTime = 0;
let currentWaitResolve = null; 
let clearScriptTimeoutId = null; 
let hoverTimeoutId = null; // ç”¨æ–¼éŒ¨é»æç¤ºçš„è¨ˆæ™‚å™¨
let insertAnchorIndex = -1; // å„²å­˜è¦æ’å…¥æ­¥é©Ÿçš„ç´¢å¼•ä½ç½® (-1 è¡¨ç¤ºæ²’æœ‰éŒ¨é»)


// åˆå§‹åŠ‡æœ¬
let scriptSteps = [
    START_STEP_DEFINITION,
];


// =================================================================
// 3. Local Storage å„²å­˜èˆ‡è¼‰å…¥é‚è¼¯
// =================================================================

/**
 * è¼”åŠ©å‡½å¼ï¼šå„²å­˜è³‡æ–™åˆ° LocalStorageï¼ŒåŒ…å«åˆ°æœŸæ™‚é–“
 */
function setLocalStorage(key, data, expiryMs) {
    const item = {
        data: data,
        expiry: new Date().getTime() + expiryMs,
    }
    try {
        localStorage.setItem(key, JSON.stringify(item));
    } catch (e) {
        console.warn("LocalStorage set failed, possibly due to quota limits.");
    }
}

/**
 * è¼”åŠ©å‡½å¼ï¼šå¾ LocalStorage ç²å–è³‡æ–™ï¼Œä¸¦æª¢æŸ¥æ˜¯å¦åˆ°æœŸ
 */
function getLocalStorage(key) {
    let itemStr;
    try {
        itemStr = localStorage.getItem(key);
    } catch (e) {
        console.warn("LocalStorage get failed.");
        return null;
    }
    
    if (!itemStr) {
        return null;
    }
    
const item = JSON.parse(itemStr);
    const now = new Date().getTime();
    
    // æª¢æŸ¥æ˜¯å¦åˆ°æœŸ
    if (now > item.expiry) {
        localStorage.removeItem(key);
        return null;
    }
    return item.data;
}

/**
 * å°‡ç•¶å‰åŠ‡æœ¬å„²å­˜åˆ° LocalStorage
 */
function saveScriptToLocalStorage() {
    try {
        const jsonString = JSON.stringify(scriptSteps);
        // ç›´æ¥å„²å­˜ JSON å­—ä¸²ï¼ŒLocal Storage æ”¯æ´ UTF-8
        setLocalStorage(STORAGE_KEY, jsonString, EXPIRY_MS);
    } catch (e) {
        console.error('Failed to save script to LocalStorage:', e);
    }
}

// =================================================================
// 4. æ•¸æ“šè¼‰å…¥èˆ‡è§£æ
// =================================================================

/**
 * è¼”åŠ©å‡½å¼ï¼šå„ªåŒ–è¼‰å…¥çš„åŠ‡æœ¬ï¼Œåˆä½µç‰¹å®šçš„é€£çºŒæ­¥é©Ÿã€‚
 * é‚è¼¯ï¼šå°‡ 'goto' (ç„¡åœ–) å¾Œæ¥ 'activity' (æœ‰åœ–) åˆä½µç‚ºå–®ä¸€çš„ 'goto' (æœ‰åœ–)ã€‚
 * @param {Array<Object>} steps - å®Œæ•´çš„åŠ‡æœ¬æ­¥é©Ÿé™£åˆ— (æœƒè¢« in-place ä¿®æ”¹)
 * @returns {Array<Object>} - å„ªåŒ–å¾Œçš„åŠ‡æœ¬æ­¥é©Ÿé™£åˆ—
 */
function optimizeLoadedScript(steps) {
    if (!Array.isArray(steps) || steps.length < 2) {
        return steps;
    }
    
    for (let i = 0; i < steps.length; i++) {
        const currentStep = steps[i];
        
        // æª¢æŸ¥ç•¶å‰æ­¥é©Ÿæ˜¯å¦ç‚º goto ä¸”æ²’æœ‰åœ–ç‰‡
        if (currentStep.type === 'goto' && !currentStep.image) {
            const nextStep = steps[i + 1];
            
            // æª¢æŸ¥ä¸‹ä¸€å€‹æ­¥é©Ÿæ˜¯å¦ç‚º activity ä¸”æœ‰åœ–ç‰‡
            // é€™è£¡é‚„éœ€è¦æª¢æŸ¥ activity çš„ç­‰å¾…æ™‚é–“æ˜¯å¦ç‚º 0/nullï¼Œå› ç‚º activity çš„ç­‰å¾…æ™‚é–“æ˜¯æœƒè¢«æ¨æ£„çš„
            // ç‚ºäº†ç°¡åŒ–ï¼Œåªè¦ activity æœ‰åœ–å°±åˆä½µï¼Œä½†æé†’ç”¨æˆ¶æ´»å‹•æ™‚é–“æœƒè¢«å¿½ç•¥
            if (nextStep && nextStep.type === 'activity' && nextStep.image) {
                
                // --- åŸ·è¡Œåˆä½µ ---
                
                // 1. è½‰ç§»åœ–ç‰‡ï¼šå°‡ activity çš„åœ–ç‰‡è½‰ç§»çµ¦ goto (é€™æ˜¯ä¸»è¦ç›®çš„)
                currentStep.image = nextStep.image;
                
                // 2. è½‰ç§» Icon (å¦‚æœ goto å°šæœªæŒ‡å®š icon)
                if (!currentStep.icon && nextStep.icon) {
                    currentStep.icon = nextStep.icon;
                }
                
                // 3. è½‰ç§» Label (å¦‚æœ goto å°šæœªæŒ‡å®š label ä¸” activity æœ‰ label)
                if (!currentStep.label && nextStep.label) {
                    currentStep.label = nextStep.label;
                }
                
                // 4. ç§»é™¤ä¸‹ä¸€å€‹æ­¥é©Ÿ (activity)
                steps.splice(i + 1, 1);
                
                // 5. èª¿æ•´ç´¢å¼•ï¼šå› ç‚ºç§»é™¤äº†å…ƒç´ ï¼Œi å¿…é ˆæ¸› 1ï¼Œä»¥ä¾¿åœ¨ä¸‹ä¸€æ¬¡è¿´åœˆä¸­é‡æ–°æª¢æŸ¥ç•¶å‰ä½ç½® (å³æ–°çš„ nextStep)
                i--; 
            }
        }
    }
    
    return steps; // ç”±æ–¼æ˜¯ in-place ä¿®æ”¹ï¼Œç›´æ¥è¿”å›
}


/**
 * å°‡ç°¡åŒ–çš„æ•¸æ“šå­—ä¸²è§£æ§‹ä¸¦è¼‰å…¥åˆ° scriptSteps
 * @param {string} rawJsonString - åŒ¯å…¥çš„ JSON å­—ä¸² (å·²URIè§£ç¢¼)
 * @returns {boolean} - æˆåŠŸè¼‰å…¥è¿”å› true
 */
function loadImportedData(rawJsonString) {
    // Helper to map icon letter back to full name
    const ICON_MAP = ICON_NAMES.reduce((map, item) => {
        map[item.name.charAt(0)] = item.name;
        return map;
    }, {});
    
    // Helper to uncompact the script format (å¾ compactArray è½‰æ›å› fullScript)
    function uncompactScript(compactArray) {
        const fullScript = [];
        
        // å¤–å±¤è¿´åœˆæ‡‰éæ­·æ¯ä¸€å€‹æ­¥é©Ÿé™£åˆ—
        for (const compactStep of compactArray) {
            let i = 0; // å…§éƒ¨ç´¢å¼•
            
            // æª¢æŸ¥ compactStep æ˜¯å¦çœŸçš„æ˜¯ä¸€å€‹æ•¸çµ„ï¼Œä¸¦ä¸”ç¬¬ä¸€å€‹å…ƒç´ æ˜¯é¡å‹å­—ç¬¦
            if (!Array.isArray(compactStep) || compactStep.length === 0) {
                 console.warn('Skipping invalid compact step:', compactStep);
                 continue;
            }

            const typeChar = compactStep[i++];
            let step = { label: '' }; // é è¨­ label
            
            switch (typeChar) {
                case 's': // start: s, lat, lng, [label], [image]
                    step.type = 'start';
                    step.lat = compactStep[i++];
                    step.lng = compactStep[i++];
                    step.label = 'é‚£éœ¸æ©Ÿå ´ (åˆå§‹ä½ç½®)'; 
                    
                    // æª¢æŸ¥å¯é¸çš„ label
                    if (compactStep.length > i && typeof compactStep[i] === 'string' && !compactStep[i].startsWith('data:image/')) {
                         step.label = compactStep[i++];
                    }
                    // æª¢æŸ¥å¯é¸çš„ image (Base64)
                    if (compactStep.length > i && typeof compactStep[i] === 'string' && compactStep[i].startsWith('data:image/')) {
                        // åœ–ç‰‡å­—ä¸²åœ¨åŒ¯å‡ºæ™‚æœ‰ URI å…§å±¤ç·¨ç¢¼ï¼Œæ•…åœ¨æ­¤è§£ç¢¼
                        step.image = decodeURIComponent(compactStep[i++]);
                    }
                    break;
                case 'g': // goto: g, lat, lng, iconChar, words, [image]
                    step.type = 'goto';
                    step.lat = compactStep[i++];
                    step.lng = compactStep[i++];
                    const iconCharG = compactStep[i++];
                    step.icon = iconCharG ? ICON_MAP[iconCharG] || iconCharG : '';
                    step.words = compactStep[i++];
                    step.label = 'è¼‰å…¥çš„ç§»å‹•æ­¥é©Ÿ';
                    
                    // æª¢æŸ¥å¯é¸çš„ image (Base64)
                    if (compactStep.length > i) {
                        step.image = decodeURIComponent(compactStep[i++]);
                    }
                    break;
                case 'a': // activity: a, sec, [iconChar], [image]
                    step.type = 'activity';
                    step.sec = compactStep[i++];
                    const activityIconChar = compactStep[i];
                    step.icon = activityIconChar ? (ICON_MAP[activityIconChar] || activityIconChar) : '';
                    if (step.icon) i++;
                    step.label = 'è¼‰å…¥çš„æ´»å‹•';
                    
                    // æª¢æŸ¥å¯é¸çš„ image (Base64)
                    if (compactStep.length > i) {
                        step.image = decodeURIComponent(compactStep[i++]);
                    }
                    break;
                case 'h': // show: h, words, [image]
                    step.type = 'show';
                    step.words = compactStep[i++];
                    step.label = 'è¼‰å…¥çš„è¨Šæ¯';
                    
                    // æª¢æŸ¥å¯é¸çš„ image (Base64)
                    if (compactStep.length > i) {
                        step.image = decodeURIComponent(compactStep[i++]);
                    }
                    break;
                case 'd': // dayoff: d, sec, [image]
                    step.type = 'dayoff';
                    step.sec = compactStep[i++];
                    step.label = 'è¼‰å…¥çš„ä¼‘æ¯éå¤œ';
                    
                    // æª¢æŸ¥å¯é¸çš„ image (Base64)
                    if (compactStep.length > i) {
                        step.image = decodeURIComponent(compactStep[i++]);
                    }
                    break;
                default:
                    console.warn('Unknown compact step type:', typeChar);
                    return null; // åœæ­¢è§£æ
            }
            fullScript.push(step);
        }
        return fullScript;
    }

    // 1. è§£æ JSON å­—ä¸²
    let compactArray;
    try {
        compactArray = JSON.parse(rawJsonString);
        // é©—è­‰æœ€å¤–å±¤æ˜¯å¦ç‚ºæ•¸çµ„
        if (!Array.isArray(compactArray)) {
            console.error('Parsed data is not an array.');
            return false;
        }
    } catch (e) {
        console.error('JSON parse error after URI decoding:', e);
        return false;
    }

    // 2. è½‰æ›å›å®Œæ•´åŠ‡æœ¬çµæ§‹
    let loadedSteps = uncompactScript(compactArray);
    
    if (!loadedSteps) return false;

    // 2.5. æ–°å¢ï¼šåŸ·è¡ŒåŠ‡æœ¬å„ªåŒ–åˆä½µ (è™•ç† [goto, activity(photo)] åˆä½µ)
    const optimizedSteps = optimizeLoadedScript(loadedSteps);

    // 3. é©—è­‰ä¸¦è¼‰å…¥
    if (Array.isArray(optimizedSteps) && optimizedSteps.length > 0 && optimizedSteps[0].type === 'start') {
        scriptSteps = optimizedSteps; // ä½¿ç”¨å„ªåŒ–å¾Œçš„æ­¥é©Ÿ
        return true;
    }
    return false;
}

/**
 * æª¢æŸ¥ä¸¦å¾ Local Storage è¼‰å…¥åŠ‡æœ¬ã€‚
 */
function checkAndLoadScriptFromURL() {
    // 1. å¾ Local Storage è¼‰å…¥
    const storedJson = getLocalStorage(STORAGE_KEY);
    const loadSource = 'æœ¬æ©Ÿå„²å­˜';

    if (storedJson) {
        try {
            // Local Storage å„²å­˜çš„æ˜¯ç´” JSON å­—ä¸²ï¼Œç›´æ¥è§£æ
            const loadedSteps = JSON.parse(storedJson); 

            if (Array.isArray(loadedSteps) && loadedSteps.length > 0 && loadedSteps[0].type === 'start') {
                
                // è¼‰å…¥æ™‚ä¹ŸåŸ·è¡Œä¸€æ¬¡å„ªåŒ–ï¼Œä»¥é˜²æœ¬åœ°å­˜å„²çš„æ˜¯æœªå„ªåŒ–æ ¼å¼
                const optimizedSteps = optimizeLoadedScript(loadedSteps);
                
                scriptSteps = optimizedSteps;
                document.getElementById('status-message').textContent = `ğŸ“¥ åŠ‡æœ¬å·²å¾ ${loadSource} è¼‰å…¥ã€‚`;
                return; 
            }
        } catch (error) {
            console.error('è§£ææœ¬åœ°å„²å­˜åŠ‡æœ¬å¤±æ•—:', error);
        }
    }

    // å¦‚æœ Local Storage ä¸­æ²’æœ‰æœ‰æ•ˆåŠ‡æœ¬ï¼Œå‰‡ä½¿ç”¨åˆå§‹é è¨­åŠ‡æœ¬
}


// =================================================================
// 5. åŠ‡æœ¬ç·¨è¼¯/æ“ä½œè¼”åŠ©å‡½æ•¸ (Focus é‚è¼¯å·²ç§»é™¤)
// =================================================================

/**
 * è¼”åŠ©å‡½å¼ï¼šæ‰¾åˆ°ä¸Šä¸€å€‹è¨­å®šä½ç½®çš„æ­¥é©Ÿçš„ä½ç½®
 */
function getPreviousPosition(currentIndex) {
    if (currentIndex <= 0) {
        return { lat: null, lng: null };
    }
    
    for (let i = currentIndex - 1; i >= 0; i--) {
        const step = scriptSteps[i];
        if (step.type === 'start' || step.type === 'goto') {
            return { lat: step.lat, lng: step.lng };
        }
    }
    return { lat: scriptSteps[0].lat, lng: scriptSteps[0].lng };
}

/**
 * è¼”åŠ©å‡½å¼ï¼šæ‰¾åˆ°ä¸Šä¸€å€‹è¨­å®šä½ç½®çš„æ­¥é©Ÿçš„ icon
 * @param {number} insertionIndex - è¦æ’å…¥çš„ç´¢å¼•ä½ç½®
 * @returns {string} - ä¸Šä¸€å€‹ goto æ­¥é©Ÿçš„ icon åç¨±ï¼Œæˆ–é è¨­å€¼ 'walk'
 */
function getLastGotoIcon(insertionIndex) {
    // Search backward from the step immediately preceding the insertion point
    for (let i = insertionIndex - 1; i >= 0; i--) {
        const step = scriptSteps[i];
        if (step.type === 'goto' && step.icon) {
            return step.icon;
        }
    }
    // Fallback: If no preceding goto step with an icon is found, use 'walk' 
    return 'walk'; 
}

/**
 * åˆªé™¤æ­¥é©Ÿ (ä¸èƒ½åˆªé™¤ç¬¬ä¸€å€‹ 'start' æ­¥é©Ÿ)
 */
function deleteStep(index) { // <-- HTML onclick èª¿ç”¨
    if (index === 0) return; // ä¿è­·ç¬¬ä¸€å€‹æ­¥é©Ÿ
    scriptSteps.splice(index, 1);
    
    // ç§»é™¤ Focus é‚è¼¯ï¼Œåƒ…é‡æ–°æ¸²æŸ“
    renderScript(); 
    saveScriptToLocalStorage(); // <--- å„²å­˜
}

/**
 * ç§»å‹•æ­¥é©Ÿä½ç½®
 */
function moveStep(index, direction) { // <-- HTML onclick èª¿ç”¨
    if (index === 0) return; // ä¿è­·ç¬¬ä¸€å€‹æ­¥é©Ÿ
    const newIndex = index + direction;
    if (newIndex < 1 || newIndex >= scriptSteps.length) return; // ä¸èƒ½ç§»å‡ºç¯„åœ (ç‰¹åˆ¥æ˜¯ä¸èƒ½ç§»åˆ° index 0)
    
    // é€²è¡Œäº¤æ›
    [scriptSteps[index], scriptSteps[newIndex]] = [scriptSteps[newIndex], scriptSteps[index]];
    
    // ç§»é™¤ Focus é‚è¼¯ï¼Œåƒ…é‡æ–°æ¸²æŸ“
    renderScript();
    saveScriptToLocalStorage(); // <--- å„²å­˜
}

/**
 * æ›´æ–°æ­¥é©Ÿè³‡æ–™
 */
function updateStep(index, field, value) { // <-- HTML onchange èª¿ç”¨
    
    let needsRender = false; // è¿½è¹¤æ˜¯å¦éœ€è¦å®Œæ•´é‡å»º

    if (field === 'coords') {
        // è™•ç† 'coords' (ç·¯åº¦, ç¶“åº¦) è¯åˆè¼¸å…¥, é©ç”¨æ–¼ 'start' å’Œ 'goto'
        const parts = String(value).split(',').map(s => s.trim());
        const lat = parseFloat(parts[0]);
        const lng = parseFloat(parts[1]);

        if (!isNaN(lat) && !isNaN(lng) && parts.length === 2) {
            
            // --- GPS Comparison/Validation ---
            // åƒ…å° goto æ­¥é©Ÿé€²è¡Œæª¢æŸ¥ (index > 0)
            if (index > 0 && scriptSteps[index].type === 'goto') {
                const prevPos = getPreviousPosition(index);
                
                // ä½¿ç”¨ä¸€å€‹å°å®¹å¿å€¼é€²è¡Œæµ®é»æ•¸æ¯”è¼ƒ
                const EPSILON = 0.000001; 
                const isSameLat = Math.abs(lat - prevPos.lat) < EPSILON;
                const isSameLng = Math.abs(lng - prevPos.lng) < EPSILON;
                
                if (isSameLat && isSameLng) {
                    console.error("GPS Error: New position is the same as the previous known position. Aborting update.");
                    document.getElementById('status-message').textContent = 'âš ï¸ éŒ¯èª¤: æ–°ä½ç½®èˆ‡å‰ä¸€æ­¥é©Ÿçš„ä½ç½®ç›¸åŒï¼Œç§»å‹•å°‡è¢«å¿½ç•¥ã€‚';
                    setTimeout(() => { document.getElementById('status-message').textContent = 'æº–å‚™å°±ç·’'; }, 3000);
                    return; 
                }
            }
            // --- End Validation ---

            scriptSteps[index].lat = lat;
            scriptSteps[index].lng = lng;
        } else {
            console.error("Invalid coordinate format. Please use 'lat, lng'.");
        }
    } else if (field === 'lat' || field === 'lng' || field === 'sec') {
        // è™•ç†å–®ç¨çš„æ•¸å­—æ¬„ä½ (æ­¤é‚è¼¯ç¾åœ¨ä¸»è¦ç”¨æ–¼ 'sec')
        scriptSteps[index][field] = parseFloat(value) || 0;
    } else {
        // è™•ç†æ–‡å­—æ¬„ä½ (label, words, icon)
        scriptSteps[index][field] = value;
    }
    
    saveScriptToLocalStorage(); // <--- å„²å­˜

    // å¦‚æœæ˜¯ icon æ”¹è®Šæˆ– Dayoff ç›¸é—œï¼Œéœ€è¦é‡å»ºä»¥æ›´æ–°æ­¥é©Ÿåœ–æ¨™å’Œæ—¥æ•¸
    if (field === 'icon' || scriptSteps[index].type === 'dayoff') {
        needsRender = true;
    }

    if (needsRender) {
         // ç§»é™¤ Focus é‚è¼¯ï¼Œåƒ…é‡æ–°æ¸²æŸ“
         renderScript(); 
    }
    // å°æ–¼ç°¡å–®çš„è³‡æ–™æ”¹è®Š (éçµæ§‹æ€§æˆ–éè¦–è¦ºç›¸é—œ)ï¼Œç„¡éœ€ä»»ä½•é¡å¤–æ“ä½œ
}

/**
 * æ–°å¢æ­¥é©Ÿåˆ°åŠ‡æœ¬
 * @param {string} type - æ­¥é©Ÿé¡å‹
 * @param {number} targetIndex - è¦æ’å…¥çš„ç´¢å¼•ä½ç½® (å¯é¸ï¼Œé è¨­ -1 è¡¨ç¤ºé™„åŠ åˆ°æœ«å°¾)
 */
function addStep(type, targetIndex = -1) { // <-- HTML onclick èª¿ç”¨
    // æ­¥é©Ÿ 1: å°‡ label é è¨­ç‚ºç©ºå­—ä¸²ï¼Œä»¥ä¾¿é¡¯ç¤º placeholder
    const newStep = { label: '' }; 

    // è™•ç†æ’å…¥ç´¢å¼•
    let insertionIndex = parseInt(targetIndex, 10);
    
    // å¦‚æœ targetIndex ç„¡æ•ˆæˆ–æœªæä¾›ï¼Œå‰‡é™„åŠ åˆ°æœ«å°¾
    if (insertionIndex === -1 || isNaN(insertionIndex)) {
        insertionIndex = scriptSteps.length;
    }

    switch (type) {
        case 'goto':
            // ç²å–ä¸Šä¸€å€‹ goto æ­¥é©Ÿçš„ icon
            const defaultIcon = getLastGotoIcon(insertionIndex); 
            // GPS åº§æ¨™é è¨­ç‚º nullï¼Œä»¥ä¾¿åœ¨æ¸²æŸ“æ™‚é¡¯ç¤º placeholder
            Object.assign(newStep, { 
                type: 'goto', 
                lat: null, 
                lng: null, 
                icon: defaultIcon, // <-- ä½¿ç”¨ä¸Šä¸€å€‹ icon ä½œç‚ºé è¨­å€¼
                words: '' 
            });
            break;
        case 'activity':
            // æ–°å¢ Activity å‹•ä½œï¼Œé è¨­ç„¡ icon ä¸”ç­‰å¾… 1 ç§’
            Object.assign(newStep, { type: 'activity', icon: '', sec: 1 });
            break;
        case 'show':
            Object.assign(newStep, { type: 'show', words: '' }); // è¨Šæ¯å…§å®¹ä¹Ÿé è¨­ç‚ºç©ºå­—ä¸²
            break;
        case 'dayoff':
            Object.assign(newStep, { type: 'dayoff', sec: 5 }); // é è¨­ä¼‘æ¯ 5 ç§’
            break;
    }
    
    
    scriptSteps.splice(insertionIndex, 0, newStep);

    // è™•ç†æ’å…¥å¾Œçš„ç‹€æ…‹å’Œæ»¾å‹•
    if (targetIndex !== -1) {
        // é€™æ˜¯è¡Œå…§æ’å…¥ï¼Œå¿…é ˆæ¸…é™¤éŒ¨é»ç‹€æ…‹
        insertAnchorIndex = -1; // ç›´æ¥æ¸…é™¤ï¼Œé¿å…å¤šé¤˜çš„ clearInsertAnchor() æ¸²æŸ“
    } 

    // ç§»é™¤ Focus é‚è¼¯ï¼Œåƒ…é‡æ–°æ¸²æŸ“
    renderScript();
    saveScriptToLocalStorage(); // <--- å„²å­˜
}


/**
 * è¨­å®šæ’å…¥éŒ¨é» (é»æ“Šè™›ç·šæ¡†)
 */
function setInsertAnchor(index) {
    // ç¢ºä¿ index æ˜¯æ•¸å­—
    const targetIndex = parseInt(index, 10); 
    // è¨­å®šè¦é¡¯ç¤º action buttons çš„ç´¢å¼•
    insertAnchorIndex = targetIndex;
    renderScript();
    
    // æ»¾å‹•åˆ° action panel è‡ªèº« (ä½¿ç”¨ timeout ç¢ºä¿ DOM æ¸²æŸ“å®Œæˆ)
    setTimeout(() => {
        const anchorElement = document.querySelector(`.insert-anchor-panel[data-index="${targetIndex}"]`);
        if (anchorElement) {
            // ä½¿ç”¨ scrollIntoView ç¢ºä¿ action panel å¯è¦‹
            anchorElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); 
        }
    }, 50);
}

/**
 * å–æ¶ˆæ’å…¥éŒ¨é» (é»æ“Šå–æ¶ˆæŒ‰éˆ•)
 */
function clearInsertAnchor() {
    insertAnchorIndex = -1;
    renderScript();
}

/**
 * è™•ç†æª”æ¡ˆä¸Šå‚³äº‹ä»¶ï¼Œå£“ç¸®åœ–ç‰‡ä¸¦è½‰æ›ç‚º Base64
 * @param {Event} event - change event
 * @param {number} index - åŠ‡æœ¬æ­¥é©Ÿç´¢å¼•
 */
function handleImageUpload(event, index) {
    const statusMessage = document.getElementById('status-message');
    const file = event.target.files[0];

    // æ¸…ç©º inputï¼Œä»¥ä¾¿å¯ä»¥é€£çºŒä¸Šå‚³åŒä¸€å€‹æª”æ¡ˆ
    event.target.value = null; 

    if (!file || !file.type.startsWith('image/')) {
        statusMessage.textContent = 'âš ï¸ è«‹é¸æ“‡æœ‰æ•ˆçš„åœ–ç‰‡æª”æ¡ˆã€‚';
        return;
    }

    statusMessage.textContent = 'åœ–ç‰‡ä¸Šå‚³ä¸­ï¼Œæ­£åœ¨é€²è¡Œå£“ç¸®...';

    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            // å£“ç¸®å¯¬åº¦
            if (width > MAX_IMAGE_WIDTH) {
                height = Math.round(height * (MAX_IMAGE_WIDTH / width));
                width = MAX_IMAGE_WIDTH;
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // å£“ç¸®æˆ JPEG æ ¼å¼ (å¯ä»¥æ¸›å°‘ Base64 å­—ä¸²é•·åº¦)
            const base64String = canvas.toDataURL('image/jpeg', 0.8); 

            // æ›´æ–°æ­¥é©Ÿè³‡æ–™
            scriptSteps[index].image = base64String;
            saveScriptToLocalStorage();
            renderScript();
            
            statusMessage.textContent = 'âœ… ç…§ç‰‡å·²å£“ç¸®ä¸¦æ–°å¢åˆ°æ­¥é©Ÿã€‚';
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

/**
 * åˆªé™¤æ­¥é©Ÿä¸­çš„ç…§ç‰‡
 * @param {number} index - åŠ‡æœ¬æ­¥é©Ÿç´¢å¼•
 */
function removeImage(index) {
    scriptSteps[index].image = undefined;
    saveScriptToLocalStorage();
    renderScript();
    document.getElementById('status-message').textContent = 'ğŸ—‘ï¸ ç…§ç‰‡å·²ç§»é™¤ã€‚';
}


// =================================================================
// 6. æ ¸å¿ƒå‹•ç•«èˆ‡æµç¨‹æ§åˆ¶å‡½æ•¸
// =================================================================

// è·é›¢è¨ˆç®— (Haversine å…¬å¼ï¼Œå›å‚³å…¬å°º)
function distance(p1,p2){
  const R=6371000; const toRad=x=>x*Math.PI/180;
  const dLat=toRad(p2[0]-p1[0]); const dLon=toRad(p2[1]-p1[1]);
  const lat1=toRad(p1[0]),lat2=toRad(p2[0]);
  const a=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

function start(gps){ marker.setLatLng(gps); }
function setIcon(name){ marker.setIcon(icons[name]); }

/**
 * é¡¯ç¤ºè¨Šæ¯å½ˆå‡ºè¦–çª— (Popup)
 */
function show(words){
  if(popup) mapInstance.closePopup(popup);
  
  // å‹•æ…‹èª¿æ•´ popupAnchor (ç¶­æŒä¸Š/ä¸‹å½ˆçš„é‚è¼¯ï¼Œä½† Leaflet æœƒè‡ªå‹•å¹³ç§»ä»¥é¿å…åˆ‡é‚Š)
  const isMobileVertical = window.innerWidth <= 767;
  let anchor = [0, -iconSize / 2]; // é è¨­ (å¾€ä¸Šå½ˆ)
  
  if (isMobileVertical) {
      // åœ¨ Leaflet å®Œæˆæ¸²æŸ“å¾Œæ‰èƒ½æ­£ç¢ºè¨ˆç®—é»åº§æ¨™
      // æ­¤è™•çš„é‚è¼¯åƒ…ç”¨æ–¼æ±ºå®šåˆå§‹å½ˆå‡ºæ–¹å‘ï¼ŒLeaflet çš„ autoPan æœƒè™•ç†æœ€çµ‚ä½ç½®
      try {
        const mapContainerRect = document.getElementById('map').getBoundingClientRect();
        const markerPoint = mapInstance.latLngToContainerPoint(marker.getLatLng());
        
        // å¦‚æœæ¨™è¨˜çš„ Y åº§æ¨™åœ¨åœ°åœ–å®¹å™¨çš„ 40% é«˜åº¦ä»¥å…§ï¼Œå°±å‘ä¸‹å½ˆå‡º
        if (markerPoint.y < mapContainerRect.height * 0.4) {
            // å¼·åˆ¶å¾€ä¸‹å½ˆå‡º (Y åº§æ¨™ç‚ºæ­£å€¼ + é¡å¤–ç·©è¡ 25px)
            anchor = [0, iconSize / 2 + 25]; 
        }
      } catch (e) {
          // å®¹éŒ¯è™•ç†ï¼Œä½¿ç”¨é è¨­ anchor
          anchor = [0, -iconSize / 2]; 
      }
  }
  
  popup = L.popup({
      closeButton:false, 
      autoClose:true, 
      className: 'custom-large-popup',
      // è¨­å®šè¶³å¤ çš„é‚Šè·ï¼Œé˜²æ­¢ Pop-up è¢«é‚Šç·£åˆ‡åˆ°
      autoPanPadding: L.point(50, 50), 
      offset: anchor // ä½¿ç”¨è¨ˆç®—å‡ºçš„éŒ¨é»
    })
    .setLatLng(marker.getLatLng())
    .setContent(words)
    .openOn(mapInstance);
    
  setTimeout(()=>{ mapInstance.closePopup(popup); popup=null; }, 1000);
}

/**
 * é–‹å•Ÿç…§ç‰‡çš„æ¨¡æ…‹æ¡† (éé˜»å¡)
 * @param {string} base64Image - Base64 åœ–ç‰‡å­—ä¸²
 */
function openImageModal(base64Image) {
    if (!base64Image) return;
    
    // ç¢ºä¿åªå‰µå»ºä¸€æ¬¡æ¨¡æ…‹æ¡†çµæ§‹
    if (!imageModal) {
        imageModal = document.createElement('div');
        imageModal.id = 'image-modal';
        imageModal.className = 'fixed inset-0 bg-black bg-opacity-75 z-[2000] flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none';
        imageModal.innerHTML = `
            <div id="image-modal-content" class="bg-white p-4 rounded-lg shadow-2xl max-w-sm mx-4 transform scale-90 transition-transform duration-300">
                <!-- ç¢ºä¿åœ–ç‰‡å¯¬åº¦æœ€å¤§åŒ–ï¼Œé«˜åº¦è‡ªé©æ‡‰ï¼Œä¸¦ä½¿ç”¨å£“ç¸®å¾Œçš„åœ–ç‰‡å¤§å° -->
                <img id="modal-image" class="w-full h-auto rounded-lg mb-2 max-w-[${MAX_IMAGE_WIDTH}px] mx-auto" alt="Journey Photo">
                <p class="text-center text-sm text-gray-600 font-semibold">ğŸ“¸ è¡Œç¨‹ç…§ç‰‡</p>
            </div>
        `;
        document.body.appendChild(imageModal);
    }
    
    const imageElement = document.getElementById('modal-image');
    const modalContent = document.getElementById('image-modal-content');

    // è¨­ç½®åœ–ç‰‡æº
    imageElement.src = base64Image;
    
    // é¡¯ç¤ºæ¨¡æ…‹æ¡† (å¸¶æœ‰å‹•ç•«)
    imageModal.classList.remove('opacity-0', 'pointer-events-none');
    modalContent.classList.remove('scale-90');
    
    // é€™è£¡æ²’æœ‰ resolveï¼Œå› ç‚ºæ˜¯å³æ™‚é–‹å•Ÿ (éé˜»å¡)
}


/**
 * é—œé–‰ç…§ç‰‡çš„æ¨¡æ…‹æ¡†
 */
function closeImageModal() {
    if (!imageModal) return;
    
    const modalContent = document.getElementById('image-modal-content');
    
    // éš±è—æ¨¡æ…‹æ¡† (å¸¶æœ‰å‹•ç•«)
    modalContent.classList.add('scale-90');
    imageModal.classList.add('opacity-0');
    
    // ç¢ºä¿å‹•ç•«çµæŸå¾Œæ‰ç§»é™¤äº‹ä»¶
    setTimeout(() => {
        imageModal.classList.add('pointer-events-none');
    }, 300); // åŒ¹é… CSS transition duration
}

/**
 * æ’­æ”¾ç¨ç«‹ç…§ç‰‡ä¸¦ç­‰å¾… 2.5 ç§’
 * @param {string} base64Image - Base64 åœ–ç‰‡å­—ä¸²
 * @returns {Promise<void>} - ç­‰å¾… PHOTO_STANDALONE_DURATION ç§’å¾Œé—œé–‰
 */
function playStepMedia(base64Image) {
    if (!base64Image) return Promise.resolve();
    
    return new Promise(async (resolve) => {
        // 1. é–‹å•Ÿæ¨¡æ…‹æ¡†
        openImageModal(base64Image); 
        
        // 2. ç­‰å¾… 2.5 ç§’ (æ”¯æ´æš«åœ)
        await wait(PHOTO_STANDALONE_DURATION); 
        await getPausePromise(); 
        
        // 3. é—œé–‰æ¨¡æ…‹æ¡†
        closeImageModal();
        
        resolve();
    });
}


/**
 * ç²å–æš«åœ Promiseã€‚å¦‚æœå·²æš«åœï¼Œå‰‡é˜»å¡åŸ·è¡Œã€‚
 */
function getPausePromise() {
    if (isPaused) {
        return new Promise(resolve => {
            pauseResolve = resolve;
        });
    }
    return Promise.resolve();
}

/**
 * æš«åœ/ç¹¼çºŒ æ’­æ”¾
 */
function pauseToggle() { // <-- HTML onclick èª¿ç”¨
    const btn = document.getElementById('pause-resume-button');
    if (!isScriptRunning) return;

    isPaused = !isPaused;
    btn.title = isPaused ? 'ç¹¼çºŒæ’­æ”¾' : 'æš«åœæ’­æ”¾';
    
    // æ ¹æ“šç‹€æ…‹æ›´æ–°æŒ‰éˆ•æ–‡å­—
    btn.querySelector('span').textContent = isPaused ? 'â–¶ï¸ ç¹¼çºŒæ’­æ”¾' : 'â¸ï¸ æš«åœæ’­æ”¾';
    
    // Resume Logic: å¾æš«åœåˆ‡æ›åˆ°ç¹¼çºŒ
    if (!isPaused && pauseResolve) {
        pauseResolve(); // ç¹¼çºŒ executeScript loop
        pauseResolve = null;

        // Resume current WAIT animation
        if (currentWaitResolve && currentWaitRemainingTime > 0) {
            currentWaitStartTime = Date.now();
            currentWaitTimeoutId = setTimeout(currentWaitResolve, currentWaitRemainingTime);
        }
    } 
    // Pause Logic: å¾é‹è¡Œåˆ‡æ›åˆ°æš«åœ
    else if (isPaused) {
        // Pause current WAIT animation (ç«‹å³åœæ­¢è¨ˆæ™‚å™¨)
        if (currentWaitTimeoutId) {
            clearTimeout(currentWaitTimeoutId);
            currentWaitRemainingTime -= (Date.now() - currentWaitStartTime);
            currentWaitTimeoutId = null;
        }
        
        // Note: 'goto' animation is NOT paused, it will run to completion and then stop due to `getPausePromise()` check in the loop.
    }
}

/**
 * åœæ­¢æ’­æ”¾
 */
function stopScript() {
    if (!isScriptRunning) return;

    isScriptRunning = false;
    isPaused = false;
    
    // åœæ­¢æ‰€æœ‰ç­‰å¾…/æš«åœ
    if (pauseResolve) pauseResolve();
    if (currentWaitTimeoutId) clearTimeout(currentWaitTimeoutId);
    
    // æ¸…é™¤ç‹€æ…‹å’ŒUI
    document.getElementById('play-button').disabled = false;
    document.getElementById('pause-resume-button').disabled = true;
    document.getElementById('stop-button').disabled = true;

    document.getElementById('play-button').classList.add('bg-indigo-500', 'hover:bg-indigo-700');
    document.getElementById('play-button').classList.remove('bg-gray-400');
    
    document.getElementById('pause-resume-button').querySelector('span').textContent = 'â¸ï¸ æš«åœ/ç¹¼çºŒ';
    document.getElementById('status-message').textContent = 'â—¼ï¸ æ’­æ”¾å·²åœæ­¢ã€‚';
    
    // æ¸…é™¤æ‰€æœ‰æ­¥é©Ÿé«˜äº® (focused-step å·²ç§»é™¤)
    document.querySelectorAll('[id^="step-"]').forEach(el => el.classList.remove('ring-2', 'ring-indigo-500', 'shadow-md'));

    // é—œé–‰åœ–ç‰‡æ¨¡æ…‹æ¡†
    closeImageModal();
}


// å‡½å¼: ç­‰å¾… (Promise ç‰ˆæœ¬, æ”¯æ´æš«åœ)
function wait(sec){
    return new Promise(resolve => {
        // æ¸…é™¤ä¸Šä¸€å€‹ wait çš„ç‹€æ…‹
        currentWaitResolve = resolve;
        currentWaitStartTime = Date.now();
        currentWaitRemainingTime = sec * 1000;

        function resolveAndClear() {
             currentWaitResolve = null;
             currentWaitTimeoutId = null;
             resolve();
        }

        currentWaitTimeoutId = setTimeout(resolveAndClear, currentWaitRemainingTime);
    });
}

/**
 * ç•«é¢è®Šæš—è®Šäº®å‹•ç•« (æ¨¡æ“¬éå¤œæ•ˆæœ)
 * @param {number} sec - ç­‰å¾…ç§’æ•¸
 * @returns {Promise<void>}
 */
function animateNight(sec) {
    const overlay = document.getElementById('night-overlay');
    const fadeDuration = 1000; // 1 ç§’è®Šæš—ï¼Œ1 ç§’è®Šäº®
    
    return new Promise(async (resolve) => {
        // è¨­å®š transition duration
        overlay.style.transitionDuration = `${fadeDuration}ms`;
        
        // å¼·åˆ¶ç€è¦½å™¨é‡ç¹ª (Reflow)
        overlay.offsetHeight; 

        // --- 1. è®Šæš— (Fade In) ---
        overlay.style.opacity = '1';
        
        // ç­‰å¾…è®Šæš—å‹•ç•«å®Œæˆ
        await wait(fadeDuration / 1000); 
        await getPausePromise(); 

        // --- 2. ä¿æŒé»‘æš— (Dark Hold) ---
        const holdDuration = Math.max(0.01, sec - (2 * fadeDuration) / 1000); 
        await wait(holdDuration);
        await getPausePromise(); 

        // --- 3. è®Šäº® (Fade Out) ---
        overlay.style.opacity = '0';
        
        // ç­‰å¾…è®Šäº®å‹•ç•«å®Œæˆ
        await wait(fadeDuration / 1000); 
        await getPausePromise(); 
        
        // æ¸…ç†æ¨£å¼
        overlay.style.transitionDuration = `0ms`; 
        resolve();
    });
}

/**
 * è¼”åŠ©å‡½æ•¸ï¼šç”Ÿæˆå¼§ç·šè·¯å¾‘çš„é»
 * @param {Array<number>} start [lat, lng]
 * @param {Array<number>} end [lat, lng]
 * @returns {Array<Array<number>>} åŒ…å«èµ·é»ã€ä¸­é–“å¼§é ‚é»ã€çµ‚é»çš„å¤šå€‹é»
 */
function createArcPath(start, end) {
    const latDiff = end[0] - start[0];
    const lngDiff = end[1] - start[1];
    const distanceInDegrees = Math.sqrt(latDiff * latDiff + lngDiff * lngDiff);

    // è·é›¢å¤ªçŸ­æ™‚ï¼Œé€€åŒ–ç‚ºç›´ç·š
    if (distanceInDegrees < 0.01) {
        return [start, end];
    }
    
    // å¼§åº¦é«˜åº¦ï¼šåŸºæ–¼è·é›¢æŒ‰æ¯”ä¾‹ç¸®æ”¾ï¼Œä½†ä¸è¶…éæœ€å¤§å€¼
    // è®“å¼§ç·šé«˜åº¦éš¨è·é›¢å¢é•·ï¼Œçœ‹èµ·ä¾†æ›´è‡ªç„¶
    const arcHeight = Math.min(ARC_HEIGHT_DEG, distanceInDegrees * 0.5); 

    const arcPoints = [];
    for (let i = 0; i <= ARC_SEGMENTS; i++) {
        const t = i / ARC_SEGMENTS; // 0 åˆ° 1 çš„é€²åº¦
        
        // ç›´ç·šæ’å€¼ (åŸºç¤åœ°ç†ä½ç½®)
        const currentLat = start[0] + latDiff * t;
        const currentLng = start[1] + lngDiff * t;
        
        // å¼§ç·šé«˜åº¦èª¿æ•´ (ä½¿ç”¨äºŒæ¬¡å‡½æ•¸æ¨¡æ“¬æ‹‹ç‰©ç·šå¼§åº¦ï¼Œt=0.5 æ™‚é”åˆ°æœ€å¤§)
        // heightFactor = 4 * t * (1 - t)
        const heightFactor = 4 * t * (1 - t); 
        
        // ç·¯åº¦æŠ¬å‡ (æ¨¡æ“¬å¼§ç·š)
        // é€™è£¡ç°¡å–®åœ°å°‡ç·¯åº¦æŠ¬é«˜ï¼Œåœ¨å¹³é¢åœ°åœ–ä¸Šæœƒå‘ˆç¾å¼§ç·šæ•ˆæœ
        const liftedLat = currentLat + arcHeight * heightFactor; 
        
        arcPoints.push([liftedLat, currentLng]);
    }

    return arcPoints;
}


// å‡½å¼: ç§»å‹• (Promise ç‰ˆæœ¬)
function goto(gps){
  return new Promise(resolve => {
    if(currentAnimation) return;
    currentAnimation=true;
    const startPos=marker.getLatLng();
    if(polyline) mapInstance.removeLayer(polyline);
    
    const currentIconName = Object.keys(icons).find(k=>icons[k]===marker.options.icon);
    const isAirplane = currentIconName === 'airplane'; // æª¢æŸ¥æ˜¯å¦ç‚ºé£›æ©Ÿ

    let pathPoints;
    let finalPathDistance;

    if (isAirplane) {
        // é£›æ©Ÿï¼šä½¿ç”¨å¼§ç·šè·¯å¾‘
        pathPoints = createArcPath([startPos.lat, startPos.lng], gps);
        // ç‚ºäº†å‹•ç•«å¹³æ»‘ï¼Œæˆ‘å€‘éœ€è¦çŸ¥é“è·¯å¾‘ä¸­æœ‰å¤šå°‘å€‹é»
        finalPathDistance = pathPoints.length; 
    } else {
        // å…¶ä»–äº¤é€šå·¥å…·ï¼šä½¿ç”¨ç›´ç·š
        pathPoints = [
            [startPos.lat, startPos.lng],
            gps
        ];
        finalPathDistance = distance([startPos.lat,startPos.lng],gps);
    }

    // ç¹ªè£½è·¯å¾‘
    polyline = L.polyline(pathPoints,{
        color: isAirplane ? '#93c5fd' : 'blue', // é£›æ©Ÿç”¨æ·¡è—è‰²
        opacity: 0.8, 
        weight: isAirplane ? 3 : 5,
        dashArray: isAirplane ? '10, 10' : null // é£›æ©Ÿç”¨è™›ç·š
    }).addTo(mapInstance);

    const bounds=L.latLngBounds([startPos,gps]);
    
    const MAX_DURATION = 4000; // æœ€é•·ç§»å‹•æ™‚é–“ 4 ç§’
    
    // å·²èª¿æ•´ï¼šå°‡ padding è¨­ç½®ç‚º [40, 40]
    mapInstance.flyToBounds(bounds, {duration: 1.5, padding: [40, 40]}); 
    
    // ç­‰å¾…åœ°åœ–å¹³ç§»å¾Œé–‹å§‹æ¨™è¨˜å‹•ç•«
    setTimeout(()=>{
      // æŠ˜ç·šæ·¡å…¥å‹•ç•« (ç°¡åŒ–ï¼šç›´æ¥è¨­ç½®ä¸æ·¡å…¥ï¼Œé¿å…èˆ‡æ·¡å‡ºå‹•ç•«è¡çª)
      polyline.setStyle({opacity: isAirplane ? 1 : 0.8});

      let dist; // ç¸½è·é›¢ (å…¬å°º)
      if (isAirplane) {
          // å°é£›æ©Ÿè€Œè¨€ï¼Œè·é›¢è¨­ç‚ºç›´ç·šè·é›¢ï¼Œå‹•ç•«æ™‚é•·åŸºæ–¼ç›´ç·šè·é›¢è¨ˆç®—
          dist = distance([startPos.lat,startPos.lng],gps); 
      } else {
          dist = finalPathDistance;
      }
      
      let duration; // å‹•ç•«æ™‚é•· (æ¯«ç§’)
      
      let speed; // é€Ÿåº¦ (m/s)
      
      // æ ¹æ“šåœ–æ¨™åç¨±è¨­å®šé€Ÿåº¦
      if (currentIconName === 'walk' || currentIconName === 'dine' || currentIconName === 'view' || currentIconName === 'shopping') { 
        speed = 100; // æ­¥è¡Œå’Œéœæ…‹å‹•ä½œé€Ÿåº¦
      } else if (currentIconName === 'bus' || currentIconName === 'car') {
        speed = 400; // èª¿æ•´ç‚º 400 m/s
      } else if (currentIconName === 'airplane') {
        speed = 800; // é£›æ©Ÿé€Ÿåº¦æœ€å¿«
      } else {
        speed = 700; // é è¨­é€Ÿåº¦ (ç«è»Š/æ©Ÿè»Š)
      }
      
      duration = dist / speed * 1000;
      duration = Math.min(duration, MAX_DURATION); // å¼·åˆ¶è¨­å®šæœ€é•·æ™‚é•·ç‚º 4 ç§’

      let startTime=null;

      function animateMarker(ts){
        if(!startTime) startTime=ts;
        const progress=(ts-startTime)/duration;
        
        if(progress>=1){
          // å‹•ç•«çµæŸ
          marker.setLatLng(gps);
          
          let removeProgress=1;
          // æŠ˜ç·šæ·¡å‡ºå’Œç§»é™¤
          function removeLine(){
            removeProgress-=0.02;
            polyline.setStyle({opacity:Math.max(removeProgress,0)});
            if(removeProgress>0) requestAnimationFrame(removeLine);
            else { 
              mapInstance.removeLayer(polyline);
              currentAnimation=false; 
              resolve(); // è§£æ±º Promise
            }
          }
          requestAnimationFrame(removeLine);

        }else{
            // æ¨™è¨˜ç§»å‹•
            let lat, lng;

            if (isAirplane) {
                // é£›æ©Ÿï¼šæ²¿è‘—å¼§ç·šè·¯å¾‘ç§»å‹•
                const pathIndex = Math.min(Math.floor(progress * ARC_SEGMENTS), ARC_SEGMENTS - 1);
                const segmentProgress = (progress * ARC_SEGMENTS) - pathIndex;
                
                const p1 = pathPoints[pathIndex];
                const p2 = pathPoints[pathIndex + 1] || pathPoints[ARC_SEGMENTS];

                lat = p1[0] + (p2[0] - p1[0]) * segmentProgress;
                lng = p1[1] + (p2[1] - p1[1]) * segmentProgress;

            } else {
                // å…¶ä»–äº¤é€šå·¥å…·ï¼šç›´ç·šç§»å‹•
                lat=startPos.lat+(gps[0]-startPos.lat)*progress;
                lng=startPos.lng+(gps[1]-startPos.lng)*progress;
            }

            marker.setLatLng([lat,lng]);
            requestAnimationFrame(animateMarker);
        }
      }
      requestAnimationFrame(animateMarker);
    },1500); // ç­‰å¾… mapInstance.flyToBounds çµæŸ
  });
}

/**
 * åŸ·è¡ŒåŠ‡æœ¬
 * @param {number} startIndex - å¾å“ªå€‹æ­¥é©Ÿç´¢å¼•é–‹å§‹åŸ·è¡Œ (0ç‚ºSTARTï¼Œ1ç‚ºç¬¬ä¸€å€‹å¯åŸ·è¡Œæ­¥é©Ÿ)
 */
function executeScript(startIndex = 1) { // <-- HTML onclick èª¿ç”¨
    if (isScriptRunning) return;

    const playButton = document.getElementById('play-button');
    const statusMessage = document.getElementById('status-message');
    const pauseButton = document.getElementById('pause-resume-button');
    const stopButton = document.getElementById('stop-button'); // æ–°å¢åœæ­¢æŒ‰éˆ•

    // è¨­ç½®é‹è¡Œç‹€æ…‹
    isScriptRunning = true;
    isPaused = false; // é‡è¨­æš«åœç‹€æ…‹
    
    playButton.disabled = true;
    pauseButton.disabled = false;
    stopButton.disabled = false; // å•Ÿç”¨åœæ­¢æŒ‰éˆ•
    pauseButton.title = 'æš«åœæ’­æ”¾';
    // æ›´æ–°æŒ‰éˆ•æ–‡å­—
    pauseButton.querySelector('span').textContent = 'â¸ï¸ æš«åœæ’­æ”¾';

    playButton.classList.remove('bg-indigo-500', 'hover:bg-indigo-700');
    playButton.classList.add('bg-gray-400');
    statusMessage.textContent = 'â–¶ï¸ åŠ‡æœ¬é–‹å§‹åŸ·è¡Œ...';
    
    // æ¸…é™¤æ‰€æœ‰æ­¥é©Ÿé«˜äº® (focused-step å·²ç§»é™¤)
    document.querySelectorAll('[id^="step-"]').forEach(el => el.classList.remove('ring-2', 'ring-indigo-500', 'shadow-md'));

    // --- 1. ç‹€æ…‹é‡å»ºï¼šç¢ºä¿æ¨™è¨˜å¾æ­£ç¢ºçš„ä½ç½®å’Œåœ–æ¨™é–‹å§‹ ---
    let currentLat = scriptSteps[0].lat;
    let currentLng = scriptSteps[0].lng;
    let currentIcon = 'motorcycle'; // é è¨­åœ–æ¨™ (æ©Ÿè»Šåœ–æ¨™)

    for (let j = 0; j < startIndex; j++) {
        const step = scriptSteps[j];
        if (step.type === 'start') {
            currentLat = step.lat;
            currentLng = step.lng;
            // Start step doesn't have an icon property. The icon is set below.
        } else if (step.type === 'goto') {
            currentLat = step.lat;
            currentLng = step.lng;
            if (step.icon) {
                currentIcon = step.icon;
            }
        } else if (step.type === 'activity') { 
            if (step.icon) {
                currentIcon = step.icon;
            }
        } else if (step.type === 'dayoff') {
            // Dayoff ä¸æ”¹è®Šä½ç½®ï¼Œä½†æœƒå¼·åˆ¶è¨­ç‚º sleep
            currentIcon = 'sleep';
        }
    }
    
    // åˆå§‹ç‹€æ…‹åœ–æ¨™å¿…é ˆè¨­ç‚º 'train' (åœ¨ DOMContentLoaded è¨­ç½®)
    if (startIndex === 0 || scriptSteps[startIndex-1].type === 'start') {
         currentIcon = 'train'; // ç¢ºä¿å¦‚æœå¾ start é–‹å§‹ï¼Œåœ–æ¨™æ˜¯ train
    }

    // æ‡‰ç”¨é‡å»ºçš„ç‹€æ…‹
    start([currentLat, currentLng]);
    setIcon(currentIcon);
    mapInstance.setView([currentLat, currentLng], 13);
    // ----------------------------------------------------


    // 2. æŒ‰ç…§æ­¥é©Ÿé †åºåŸ·è¡Œ
    async function runSteps() { // ä½¿ç”¨ä¸€å€‹ async å…§éƒ¨å‡½æ•¸ä¾†è™•ç† await
        for (let i = startIndex; i < scriptSteps.length; i++) {
            
            if (!isScriptRunning) break; // æª¢æŸ¥æ˜¯å¦è¢« stopScript åœæ­¢

            // æª¢æŸ¥æš«åœç‹€æ…‹ (å¦‚æœå·²æš«åœï¼Œç¨‹å¼æœƒåœ¨æ­¤è™•ç­‰å¾…)
            await getPausePromise(); 
            
            if (!isScriptRunning) break; // å†æ¬¡æª¢æŸ¥ï¼Œé˜²æ­¢åœ¨å¾æš«åœæ¢å¾©å¾Œç«‹å³åœæ­¢

            const step = scriptSteps[i];
            
            // æ›´æ–°ç•¶å‰åŸ·è¡Œç‹€æ…‹
            statusMessage.textContent = `åŸ·è¡Œä¸­: æ­¥é©Ÿ ${i}. ${step.label || step.type}`;
            // æ’­æ”¾æ™‚ä½¿ç”¨è—è‰²é«˜äº®
            document.getElementById(`step-${i}`).classList.add('ring-2', 'ring-indigo-500', 'shadow-md');
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºç¨ç«‹æ’­æ”¾ç…§ç‰‡çš„æ­¥é©Ÿé¡å‹ (goto, show)
            const isStandalonePhotoStep = step.type === 'goto' || step.type === 'show';
            
            // ç”¨æ–¼æŒçºŒé¡¯ç¤ºç…§ç‰‡çš„æ­¥é©Ÿé¡å‹ (activity, dayoff)
            const isContinuousPhotoStep = step.type === 'activity' || step.type === 'dayoff';


            try {
                // --- æ­¥é©Ÿé–‹å§‹æ™‚çš„é‚è¼¯ ---
                if (isContinuousPhotoStep && step.image) {
                    // æŒçºŒé¡¯ç¤ºé¡å‹çš„ï¼Œå‹•ä½œé–‹å§‹æ™‚é–‹å•Ÿç…§ç‰‡
                    openImageModal(step.image); 
                }

                // --- åŸ·è¡Œä¸»è¦æ­¥é©Ÿå‹•ä½œ ---
                switch (step.type) {
                    case 'activity':
                        // **Activity = setIcon (å¯é¸) + wait (å¯é¸)**
                        if (step.icon) { setIcon(step.icon); }
                        if (step.sec && step.sec > 0) { await wait(step.sec); }
                        break;
                    case 'show':
                        // ä¿æŒ show ç¨ç«‹åŠŸèƒ½
                        show(step.words);
                        await wait(1); // é¡¯ç¤ºè¨Šæ¯å¾ŒçŸ­æš«ç­‰å¾…ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°
                        break;
                    case 'goto':
                        // **å¦‚æœ goto å¸¶æœ‰ iconï¼Œå‰‡å…ˆæ›åœ–æ¨™**
                        if (step.icon) { setIcon(step.icon); }
                        await goto([step.lat, step.lng]);
                        
                        // **å¦‚æœ goto å¸¶æœ‰ words (ä¸”éç©º)ï¼Œå‰‡æ¥è‘—é¡¯ç¤ºè¨Šæ¯**
                        if (step.words && step.words.trim() !== '') {
                            show(step.words);
                            await wait(1); // é¡¯ç¤ºè¨Šæ¯å¾ŒçŸ­æš«ç­‰å¾…ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°
                        }
                        break;
                    case 'dayoff':
                        // **Dayoff æ­¥é©Ÿ**
                        setIcon('sleep');
                        await animateNight(step.sec);
                        break;
                }
                
                // --- æ­¥é©ŸçµæŸæ™‚çš„é‚è¼¯ ---
                if (isContinuousPhotoStep && step.image) {
                    // æŒçºŒé¡¯ç¤ºé¡å‹çš„ï¼Œå‹•ä½œçµæŸæ™‚é—œé–‰ç…§ç‰‡
                    closeImageModal();
                } else if (isStandalonePhotoStep && step.image) {
                    // ç¨ç«‹æ’­æ”¾é¡å‹çš„ï¼Œå‹•ä½œçµæŸå¾Œæ’­æ”¾ç…§ç‰‡ 2.5 ç§’
                    await playStepMedia(step.image);
                }

            } catch (error) {
                console.error(`æ­¥é©Ÿ ${i} åŸ·è¡ŒéŒ¯èª¤:`, error);
                // é‡åˆ°éŒ¯èª¤ï¼Œèª¿ç”¨ stopScript æ¸…ç†ç‹€æ…‹
                stopScript();
                statusMessage.textContent = `âŒ éŒ¯èª¤: æ­¥é©Ÿ ${i} åŸ·è¡Œå¤±æ•—ï¼Œå·²ä¸­æ–·ã€‚`;
                return; 
            }
            
            // æ¸…é™¤ç•¶å‰æ­¥é©Ÿé«˜äº®
            document.getElementById(`step-${i}`).classList.remove('ring-2', 'ring-indigo-500', 'shadow-md');
        }

        // 3. åŸ·è¡ŒçµæŸ
        if (isScriptRunning) { // åªæœ‰åœ¨æ²’æœ‰è¢«æ‰‹å‹•åœæ­¢æ™‚æ‰é¡¯ç¤ºå®Œæˆ
            stopScript(); // ä½¿ç”¨ stopScript åŸ·è¡Œæ¨™æº–çµæŸæ¸…ç†
            statusMessage.textContent = 'âœ… åŠ‡æœ¬åŸ·è¡Œå®Œç•¢ï¼';
        }
    }
    
    // å•Ÿå‹•åŸ·è¡Œ
    runSteps();
}

/**
 * æç¤ºä¸¦åŸ·è¡Œæ¸…é™¤åŠ‡æœ¬å‹•ä½œ (å…©æ­¥é©Ÿç¢ºèª)
 */
function promptClearScript() { // <-- HTML onclick èª¿ç”¨
    const btn = document.getElementById('delete-all-button');
    const originalText = 'ğŸ—‘ï¸ å…¨éƒ¨åˆªé™¤';
    const confirmText = 'âš ï¸ ç¢ºèªå…¨éƒ¨åˆªé™¤? (5s)';

    // æª¢æŸ¥æ˜¯å¦è™•æ–¼ç¢ºèªç‹€æ…‹
    if (btn.textContent.includes('ç¢ºèª')) {
        clearScript();
        return;
    }
    
    // é€²å…¥ç¢ºèªç‹€æ…‹
    btn.textContent = confirmText;
    btn.classList.remove('bg-red-400', 'hover:bg-red-600');
    btn.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');

    // è¨­ç½® 5 ç§’å¾Œé‡ç½®æŒ‰éˆ•
    clearTimeout(clearScriptTimeoutId);
    clearScriptTimeoutId = setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.add('bg-red-400', 'hover:bg-red-600');
        btn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');
    }, 5000);
}

/**
 * æ¸…é™¤æ‰€æœ‰åŠ‡æœ¬æ­¥é©Ÿï¼Œåªä¿ç•™ç¬¬ä¸€å€‹ 'start' æ­¥é©Ÿ
 */
function clearScript() {
    const btn = document.getElementById('delete-all-button');
    const statusMessage = document.getElementById('status-message');

    // æ¸…é™¤ç¢ºèªç‹€æ…‹è¨ˆæ™‚å™¨
    clearTimeout(clearScriptTimeoutId);

    // é‡è¨­åŠ‡æœ¬ç‚ºåªæœ‰ç¬¬ä¸€å€‹ 'start' æ­¥é©Ÿ (ä½¿ç”¨ START_STEP_DEFINITION ä¾†é‡è¨­)
    scriptSteps = [
        { 
            type: START_STEP_DEFINITION.type, 
            lat: START_STEP_DEFINITION.lat, 
            lng: START_STEP_DEFINITION.lng, 
            label: START_STEP_DEFINITION.label 
        }
    ];

    clearInsertAnchor(); // æ¸…é™¤éŒ¨é»ç‹€æ…‹
    renderScript(); // é‡æ–°æ¸²æŸ“
    saveScriptToLocalStorage();

    // æ¢å¾©æŒ‰éˆ•å’Œç‹€æ…‹è¨Šæ¯
    btn.textContent = 'ğŸ—‘ï¸ å…¨éƒ¨åˆªé™¤';
    btn.classList.add('bg-red-400', 'hover:bg-red-600');
    btn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');
    statusMessage.textContent = 'ğŸ—‘ï¸ åŠ‡æœ¬å·²æ¸…é™¤ï¼Œå·²æ¢å¾©åˆå§‹æ­¥é©Ÿã€‚';
}


/**
 * æ²å‹•è…³æœ¬åˆ—è¡¨åˆ°æœ€åº•éƒ¨
 */
function scrollToBottom() { // <-- HTML onclick èª¿ç”¨
    const controlsContainer = document.getElementById('controls');
    // æ²å‹•åˆ° controls å®¹å™¨çš„æœ€åº•éƒ¨
    controlsContainer.scrollTop = controlsContainer.scrollHeight;
}


/**
 * åŒ¯å‡ºåŠ‡æœ¬ï¼šå°‡å„ªåŒ–å¾Œçš„ JSON å­—ä¸²ç”Ÿæˆç‚ºæª”æ¡ˆä¸¦ä¸‹è¼‰ã€‚
 */
async function exportScript() { // <-- HTML onclick èª¿ç”¨
    const statusMessage = document.getElementById('status-message');
    let dataString = ''; 
    
    try {
        // --- 1. æ•¸æ“šå„ªåŒ–èˆ‡è½‰æ› (å£“ç¸®çµæ§‹) ---
        
        const compactScript = scriptSteps.map(step => {
            const compact = [];
            switch (step.type) {
                case 'start': // s, lat, lng, [label], [image]
                    compact.push('s', step.lat, step.lng);
                    if (step.label) compact.push(step.label);
                    // æ–°å¢ï¼šå¦‚æœå­˜åœ¨åœ–ç‰‡ï¼Œé€²è¡Œ URI ç·¨ç¢¼å¾ŒåŠ å…¥
                    if (step.image) compact.push(encodeURIComponent(step.image)); 
                    return compact;
                case 'goto': // g, lat, lng, iconChar, words, [image]
                    compact.push('g', step.lat, step.lng);
                    if (step.icon) compact.push(step.icon.charAt(0)); 
                    else compact.push('');
                    if (step.words) compact.push(step.words);
                    // æ–°å¢ï¼šå¦‚æœå­˜åœ¨åœ–ç‰‡ï¼Œé€²è¡Œ URI ç·¨ç¢¼å¾ŒåŠ å…¥
                    if (step.image) compact.push(encodeURIComponent(step.image)); 
                    return compact;
                case 'activity': // a, sec, [iconChar], [image]
                    compact.push('a', step.sec);
                    if (step.icon) compact.push(step.icon.charAt(0)); 
                    // æ–°å¢ï¼šå¦‚æœå­˜åœ¨åœ–ç‰‡ï¼Œé€²è¡Œ URI ç·¨ç¢¼å¾ŒåŠ å…¥
                    if (step.image) compact.push(encodeURIComponent(step.image)); 
                    return compact;
                case 'show': // h, words, [image]
                    compact.push('h', step.words);
                    // æ–°å¢ï¼šå¦‚æœå­˜åœ¨åœ–ç‰‡ï¼Œé€²è¡Œ URI ç·¨ç¢¼å¾ŒåŠ å…¥
                    if (step.image) compact.push(encodeURIComponent(step.image)); 
                    return compact;
                case 'dayoff': // d, sec, [image]
                    compact.push('d', step.sec);
                    // æ–°å¢ï¼šå¦‚æœå­˜åœ¨åœ–ç‰‡ï¼Œé€²è¡Œ URI ç·¨ç¢¼å¾ŒåŠ å…¥
                    if (step.image) compact.push(encodeURIComponent(step.image)); 
                    return compact;
            }
            return compact;
        });

        // 2. JSON.stringify è½‰æ›ç‚ºå­—ä¸²
        const rawJsonString = JSON.stringify(compactScript);
        
        // 3. é—œéµä¿®æ­£ï¼šURI ç·¨ç¢¼ä»¥ç¢ºä¿é ASCII å­—ç¬¦çš„å®‰å…¨å‚³è¼¸ (åŒ…æ‹¬ Base64 å­—ä¸²)
        dataString = encodeURIComponent(rawJsonString);
        
    } catch (error) {
        statusMessage.textContent = 'âŒ åŠ‡æœ¬æ•¸æ“šè½‰æ›å¤±æ•—ã€‚';
        console.error('æ•¸æ“šè½‰æ›å¤±æ•—:', error);
        return; 
    }
    
    // --- 4. ä¸‹è¼‰ç‚º .txt æª”æ¡ˆ (æ–°å‰¯æª”å) ---
    try {
        // å‰µå»º Blobï¼ŒMIME type è¨­ç‚º text/plain
        const blob = new Blob([dataString], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        a.href = url;
        // ä½¿ç”¨æ–°çš„ .txt å‰¯æª”å
        a.download = `journey_script${FILE_EXTENSION}`; 
        document.body.appendChild(a);
        a.click();
        
        // æ¸…ç†
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        statusMessage.textContent = `âœ… æª”æ¡ˆå·²æˆåŠŸä¸‹è¼‰ç‚º journey_script${FILE_EXTENSION}ï¼`;
        setTimeout(() => {
            statusMessage.textContent = 'æº–å‚™å°±ç·’';
        }, 3000);

    } catch (error) {
        statusMessage.textContent = 'âŒ æª”æ¡ˆä¸‹è¼‰å¤±æ•—ã€‚';
        console.error('æª”æ¡ˆä¸‹è¼‰å¤±æ•—:', error);
    }
}


/**
 * è™•ç†æª”æ¡ˆä¸Šå‚³äº‹ä»¶ï¼Œè®€å–æª”æ¡ˆå…§å®¹ä¸¦è¼‰å…¥åŠ‡æœ¬ã€‚
 */
function handleFileUpload(event) {
    const statusMessage = document.getElementById('status-message');
    const file = event.target.files[0];

    // é‡è¨­æª”æ¡ˆè¼¸å…¥ï¼Œä»¥ä¾¿å¯ä»¥é€£çºŒä¸Šå‚³åŒä¸€å€‹æª”æ¡ˆ
    event.target.value = null; 

    if (!file) {
        statusMessage.textContent = 'æº–å‚™å°±ç·’';
        return;
    }

    // æ¥å— .txt (æ–°çš„) æˆ– .trip (èˆŠçš„) æª”æ¡ˆ
    const acceptedExtensions = ['.txt', '.trip'];
    const isAcceptedFile = acceptedExtensions.some(ext => file.name.toLowerCase().endsWith(ext));

    if (!isAcceptedFile && file.type !== 'text/plain') {
        statusMessage.textContent = `âš ï¸ æª”æ¡ˆé¡å‹éŒ¯èª¤ã€‚è«‹ä¸Šå‚³ .txt æˆ– .trip æ ¼å¼çš„ç´”æ–‡å­—æª”æ¡ˆã€‚`;
        return;
    }

    const reader = new FileReader();

    reader.onload = (e) => {
        const fileContent = e.target.result;
        
        try {
            // æª”æ¡ˆå…§å®¹é æœŸæ˜¯ URI-encoded compact JSON stringï¼Œéœ€è¦å…ˆè§£ç¢¼
            const rawJsonString = decodeURIComponent(fileContent);
            
            const result = loadImportedData(rawJsonString);
            if (result) {
                statusMessage.textContent = 'âœ… åŠ‡æœ¬æª”æ¡ˆå·²æˆåŠŸè¼‰å…¥ï¼';
                saveScriptToLocalStorage();
                renderScript(); // é‡æ–°æ¸²æŸ“
            } else {
                statusMessage.textContent = 'âŒ æª”æ¡ˆå…§å®¹æ ¼å¼ç„¡æ•ˆæˆ–å·²æå£ã€‚';
            }
        } catch (error) {
            statusMessage.textContent = 'âŒ æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹æª¢æŸ¥å…§å®¹æ ¼å¼ã€‚';
            console.error('File parsing failed:', error);
        }
    };

    reader.onerror = () => {
        statusMessage.textContent = 'âŒ è®€å–æª”æ¡ˆå¤±æ•—ã€‚';
        console.error('FileReader error:', reader.error);
    };

    // è®€å–æª”æ¡ˆç‚ºç´”æ–‡å­—
    reader.readAsText(file);
    statusMessage.textContent = `è®€å–æª”æ¡ˆ ${file.name} ä¸­...`;
}


/**
 * æ¸²æŸ“åŠ‡æœ¬åˆ—è¡¨
 */
function renderScript() {
    const listContainer = document.getElementById('script-list');
    listContainer.innerHTML = '';
    
    // --- æ—¥æ•¸èˆ‡è¡Œç¨‹è¨ˆæ•¸é‚è¼¯ (Day-Step Numbering) ---
    let currentDay = 1;         // ç•¶å‰æ—¥æ•¸
    let dayStepCount = 0;       // ç•¶å‰æ—¥æ•¸ä¸­çš„è¡Œç¨‹è¨ˆæ•¸ (å¾ 1 é–‹å§‹)
    
    // --- é¡è‰²äº¤æ›¿é‚è¼¯çš„è®Šæ•¸ (æ—¥åˆ†çµ„) ---
    const DAY_COLORS = ['bg-indigo-100', 'bg-pink-100']; 
    const BORDER_COLORS = ['border-indigo-400', 'border-pink-400'];
    let dayIndex = 0; // 0 æˆ– 1ï¼Œç”¨æ–¼é¡è‰²äº¤æ›¿
    // ---------------------------------

    scriptSteps.forEach((step, index) => {
        
        let displayIndex; // é¡¯ç¤ºçš„ Day-Step å­—ä¸²

        
        // --- éŒ¨é»æ¸²æŸ“ (åœ¨ç•¶å‰æ­¥é©Ÿä¸Šæ–¹) ---
        if (index > 0) {
            // è¨ˆç®—æ’å…¥é»çš„ Day-Step è™Ÿç¢¼ (é€™æ˜¯æ­¥é©Ÿ X æ’å…¥å¾Œæ‡‰æœ‰çš„è™Ÿç¢¼)
            let anchorDay = currentDay;
            let anchorStep = dayStepCount + 1;
            
            if (scriptSteps[index - 1].type === 'dayoff') {
                anchorDay++;
                anchorStep = 1;
            }
            
            const anchorDisplay = `${anchorDay}-${anchorStep}`;


            if (index === insertAnchorIndex) {
                // RENDER INLINE ACTION PANEL
                const actionPanel = document.createElement('div');
                actionPanel.className = 'insert-anchor-panel p-3 my-2 bg-indigo-100 rounded-lg border-2 border-indigo-500 shadow-md';
                actionPanel.dataset.index = index;
                actionPanel.innerHTML = `
                    <p class="font-bold text-sm text-indigo-700 mb-2 text-center">ğŸ“Œ åœ¨ ${anchorDisplay} æ’å…¥å‹•ä½œï¼š</p>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <button onclick="addStep('goto', ${index})" class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition duration-150 font-semibold">â¡ï¸ ç§»å‹•</button>
                        <button onclick="addStep('activity', ${index})" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition duration-150 font-semibold">ğŸƒ æ´»å‹•/ç‹€æ…‹</button>
                        <button onclick="addStep('show', ${index})" class="bg-yellow-500 text-gray-800 p-2 rounded-lg hover:bg-yellow-600 transition duration-150 font-semibold">ğŸ’¬ é¡¯ç¤ºè¨Šæ¯</button>
                        <button onclick="addStep('dayoff', ${index})" class="bg-pink-500 text-white p-2 rounded-lg hover:bg-pink-600 transition duration-150 font-semibold">ğŸ›Œ ä¼‘æ¯éå¤œ</button>
                    </div>
                    <button onclick="clearInsertAnchor()" class="w-full mt-3 text-xs text-indigo-700 hover:text-red-600 font-semibold">âŒ å–æ¶ˆæ’å…¥</button>
                `;
                listContainer.appendChild(actionPanel);

            } else {
                // RENDER STANDARD ANCHOR
                const anchorElement = document.createElement('div');
                anchorElement.className = 'insert-anchor transition-all duration-300'; 
                anchorElement.dataset.index = index;
                
                // é»æ“Šæ™‚ï¼Œé¡¯ç¤ºå‹•ä½œé¸é …
                anchorElement.onclick = () => { setInsertAnchor(index); }; 
                
                anchorElement.innerHTML = `<span class="insert-anchor-text">åœ¨æ­¤è™•æ·»åŠ è¡Œç¨‹ (${anchorDisplay})</span>`;
                listContainer.appendChild(anchorElement);
            }
        }

        
        // --- æ­¥é©Ÿè™Ÿç¢¼èˆ‡æ—¥æ•¸è¨ˆæ•¸æ›´æ–° ---
        if (index === 0) {
            displayIndex = '0'; // èµ·å§‹æ­¥é©Ÿç‚º 0
        } else {
            // æ ¹æ“šå‰ä¸€æ­¥é©Ÿé¡å‹æ›´æ–° Day å’Œ Step Count
            if (scriptSteps[index - 1].type === 'dayoff') {
                currentDay++;
                dayStepCount = 1;
            } else {
                dayStepCount++;
            }
            displayIndex = `${currentDay}-${dayStepCount}`;
        }
        
        // --- æ­¥é©Ÿé¡è‰²é‚è¼¯ (å¿…é ˆä½¿ç”¨å‰ä¸€æ­¥é©Ÿé¡å‹) ---
        if (index > 0 && scriptSteps[index - 1].type === 'dayoff') {
            dayIndex = 1 - dayIndex; // ç¿»è½‰ 0 <-> 1
        }


        const stepElement = document.createElement('div');
        stepElement.id = `step-${index}`;
        // æ­¥é©Ÿå…ƒç´ çš„åŸºæœ¬æ¨£å¼ï¼šåœ“è§’ã€é™°å½±ã€éæ¸¡æ•ˆæœ
        stepElement.className = 'p-3 rounded-lg shadow-sm transition-all duration-200 border border-opacity-50 step-card'; 
        
        // ç§»é™¤ Focus æ¨£å¼æ‡‰ç”¨é‚è¼¯
        
        let contentHtml = '';
        let stepColor = 'text-gray-700';
        let stepIcon = 'ğŸ”¹';

        const isStartStep = index === 0;
        const buttonAction = `executeScript(${isStartStep ? 1 : index})`;
        const startIcon = isStartStep ? 'ğŸ ' : 'â–¶ï¸';
        const startButtonTitle = isStartStep ? 'å¾é ­æ’¥æ”¾' : 'å¾é€™é‚Šé–‹å§‹æ’¥æ”¾';

        
        // æ‡‰ç”¨ç•¶å‰æ—¥çš„åŸºç¤è‰² (é™¤äº† Dayoff æ­¥é©Ÿ)
        if (step.type === 'dayoff') {
            // Dayoff æ­¥é©Ÿï¼šä½¿ç”¨ä¸­æ€§è‰²çªé¡¯ï¼Œä¸¦ä¿ç•™ç²‰è‰²çš„æ–‡å­—é¡è‰²
            stepElement.classList.add('bg-gray-200', 'border-gray-400');
            stepColor = 'text-pink-700'; 
        } else {
            // Start å’Œæ‰€æœ‰å…¶ä»–æ­¥é©Ÿï¼šæ‡‰ç”¨ Day N çš„é¡è‰²
            stepElement.classList.add(DAY_COLORS[dayIndex]); // æ‡‰ç”¨æ·¡ç´«æˆ–æ·¡ç²‰ç´…
            stepElement.classList.add(BORDER_COLORS[dayIndex]); // æ‡‰ç”¨å°æ‡‰çš„é‚Šæ¡†è‰²
        }

        if (step.type === 'start') {
            // Start Step: å¼·åˆ¶ä½¿ç”¨ Day 1 çš„æ·±è‰²é‚Šæ¡†å’Œçªé¡¯æ–‡å­—è‰²
            stepElement.classList.remove('border-opacity-50');
            stepElement.classList.add('border-indigo-500');
            stepColor = 'text-purple-700';
            // Start æ­¥é©Ÿä¸éœ€è¦ hover é¡è‰²ï¼Œå› ç‚ºå®ƒä¸èƒ½è¢«åˆªé™¤/ç§»å‹•
            stepElement.classList.remove('step-card:hover');
        }
        // ------------------
        
        // --- ç…§ç‰‡ä¸Šå‚³/é¡¯ç¤º UI (åœ¨ stepElement å…§) ---
        const fileInputId = `image-upload-${index}`;
        
        const hasImage = !!step.image;
        // èµ·å§‹é» (index 0) ä¸å…è¨±ä¸Šå‚³ç…§ç‰‡
        const imageHtml = !isStartStep ? `
            <!-- éš±è—çš„æª”æ¡ˆè¼¸å…¥å…ƒä»¶ -->
            <input type="file" id="${fileInputId}" style="display:none;" accept="image/*" onchange="handleImageUpload(event, ${index})">
            
            <div class="flex items-center space-x-2 mt-2 pt-2 border-t border-gray-200">
                ${hasImage ? 
                    // Image Preview and Delete Button
                    `<div class="flex items-center space-x-2 p-2 bg-white rounded-lg border shadow-sm">
                        <img src="${step.image}" alt="Uploaded Photo" class="h-8 w-auto rounded object-cover">
                        <span class="text-xs text-gray-600 font-medium whitespace-nowrap">ç…§ç‰‡å·²ä¸Šå‚³</span>
                        <button onclick="removeImage(${index})" 
                                class="text-red-500 hover:text-red-700 p-1 rounded transition duration-150"
                                title="åˆªé™¤ç…§ç‰‡">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>`
                    :
                    // Upload Button
                    `<button onclick="document.getElementById('${fileInputId}').click()" 
                            class="flex items-center bg-gray-100 text-gray-700 text-xs font-semibold px-3 py-2 rounded-lg hover:bg-gray-200 transition duration-150 whitespace-nowrap">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        ä¸Šå‚³ç…§ç‰‡ (${MAX_IMAGE_WIDTH}px)
                    </button>`
                }
            </div>
        ` : '';


        switch (step.type) {
            case 'start':
                // (Start stepColor/Iconå·²åœ¨ä¸Šé¢è¨­å®š)
                stepIcon = 'ğŸ“';
                
                // çµ„åˆç‚ºå–®ä¸€åº§æ¨™å­—ä¸²
                const startCoordValue = (step.lat && step.lng) ? `${step.lat}, ${step.lng}` : '';

                contentHtml = `
                    <p class="text-xs text-red-500 font-semibold mb-2">âš ï¸ é€™æ˜¯æ—…ç¨‹çš„**å¼·åˆ¶**åˆå§‹é»ï¼Œä¸èƒ½åˆªé™¤æˆ–ç§»å‹•ã€‚</p>
                    <span class="font-bold">åˆå§‹ä½ç½®</span><br>
                    <small>GPS åº§æ¨™ (ç·¯åº¦, ç¶“åº¦, ä¾‹å¦‚: 26.2173, 127.6924):</small>
                    <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                    <input type="text" 
                           class="w-full text-sm border rounded px-2 mt-1" 
                           placeholder="ç·¯åº¦, ç¶“åº¦" 
                           value="${startCoordValue}" 
                           onchange="updateStep(${index}, 'coords', this.value)">
                `;
                break;
            case 'goto':
                // çµ„åˆç‚ºå–®ä¸€åº§æ¨™å­—ä¸²
                const coordValue = (step.lat && step.lng) ? `${step.lat}, ${step.lng}` : '';
                stepColor = 'text-blue-700';
                stepIcon = 'â¡ï¸';
                contentHtml = `
                    <span class="font-bold">ç§»å‹•åˆ°</span>
                    <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="æ­¥é©Ÿæ¨™ç±¤ (ex: åˆ°é”ç‰§å¿—ç«™)" value="${step.label || ''}" 
                        onchange="updateStep(${index}, 'label', this.value)">

                    <small>GPS åº§æ¨™ (ç·¯åº¦, ç¶“åº¦, ä¾‹å¦‚: 26.2173, 127.6924):</small>
                    <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                    <input type="text" 
                           class="w-full text-sm border rounded px-2 mt-1" 
                           placeholder="ç·¯åº¦, ç¶“åº¦" 
                           value="${coordValue}" 
                           onchange="updateStep(${index}, 'coords', this.value)">
                    
                    <small class="mt-2 block">ç§»å‹•åœ–æ¨™ (å¯é¸):</small>
                    <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                    <select class="w-full text-sm border rounded px-2 mt-1" 
                        onchange="updateStep(${index}, 'icon', this.value)">
                        <option value="">(ä¿æŒä¸è®Š)</option>
                        ${ICON_NAMES.map(item => `<option value="${item.name}" ${step.icon === item.name ? 'selected' : ''}>${item.emoji} ${item.name}</option>`).join('')}
                    </select>
                    
                    <small class="mt-2 block">æŠµé”æ™‚é¡¯ç¤ºè¨Šæ¯ (å¯é¸):</small>
                    <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                    <input type="text" 
                           class="w-full text-sm border rounded px-2 mt-1" 
                           placeholder="æŠµé”æ™‚å½ˆå‡ºè¨Šæ¯ (ç•™ç©ºå‰‡ä¸é¡¯ç¤º)" 
                           value="${step.words || ''}" 
                           onchange="updateStep(${index}, 'words', this.value)">
                `;
                break;
            case 'activity':
                // **æ–°é‚è¼¯ï¼šActivity = setIcon (å¯é¸) + wait (å¯é¸)**
                stepColor = 'text-green-700';
                stepIcon = 'ğŸƒ';
                contentHtml = `
                    <span class="font-bold">æ´»å‹•/ç‹€æ…‹ (è®Šæ›´åœ–æ¨™æˆ–ç­‰å¾…)</span>
                    <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="æ­¥é©Ÿæ¨™ç±¤ (ex: æ­£åœ¨æ‹ç…§)" value="${step.label || ''}" 
                        onchange="updateStep(${index}, 'label', this.value)">
                    
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div>
                            <small class="block">åœ–æ¨™ (å¯é¸):</small>
                            <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                            <select class="w-full text-sm border rounded px-2 mt-1" 
                                onchange="updateStep(${index}, 'icon', this.value)">
                                <option value="">(ä¿æŒä¸è®Š)</option>
                                ${ICON_NAMES.map(item => `<option value="${item.name}" ${step.icon === item.name ? 'selected' : ''}>${item.emoji} ${item.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <small class="block">æŒçºŒæ™‚é–“ (ç§’æ•¸, å¯é¸):</small>
                            <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                            <input type="number" 
                                   class="w-full text-sm border rounded px-2 mt-1" 
                                   placeholder="0" 
                                   value="${step.sec || ''}" 
                                   onchange="updateStep(${index}, 'sec', parseFloat(this.value))">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">è‹¥ç§’æ•¸ç‚º 0 æˆ–ç•™ç©ºï¼Œå‰‡åªåŸ·è¡Œåœ–æ¨™è®Šæ›´ã€‚</p>
                `;
                break;
            case 'show':
                stepColor = 'text-yellow-700';
                stepIcon = 'ğŸ’¬';
                contentHtml = `
                    <span class="font-bold">é¡¯ç¤ºè¨Šæ¯</span>
                    <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="æ­¥é©Ÿæ¨™ç±¤ (ex: é¡¯ç¤ºï¼šç‰§å¿—ç«™)" value="${step.label || ''}" 
                        onchange="updateStep(${index}, 'label', this.value)">
                    <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="è¨Šæ¯å…§å®¹" value="${step.words || ''}" 
                        onchange="updateStep(${index}, 'words', this.value)">
                `;
                break;
            case 'dayoff':
                // (Dayoff stepColorå·²åœ¨ä¸Šé¢è¨­å®š)
                stepIcon = 'ğŸ›Œ';
                contentHtml = `
                    <span class="font-bold">ä¼‘æ¯éå¤œ</span>
                    <p class="text-xs text-gray-500 mt-1 mb-2">åŸ·è¡Œ setIcon='sleep' ä¸¦æ’­æ”¾å¤œé–“å‹•ç•«ã€‚</p>
                    <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="æ­¥é©Ÿæ¨™ç±¤ (ex: å…¥ä½ä¼‘æ¯)" value="${step.label || ''}" 
                        onchange="updateStep(${index}, 'label', this.value)">

                    <small>æŒçºŒæ™‚é–“ (ç§’æ•¸): 
                        <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                        <input type="number" class="w-20 text-xs border rounded px-1" value="${step.sec}" 
                            onchange="updateStep(${index}, 'sec', parseFloat(this.value))">
                    </small>
                `;
                break;
        }

        stepElement.innerHTML = `
            <div class="flex justify-between items-start mb-1">
                <div class="flex items-center">
                    <span class="${stepColor} font-semibold">${stepIcon} ${displayIndex}. ${step.type.toUpperCase()}</span>
                    <!-- è®Šæ›´ç‚ºåœ–ç¤ºæŒ‰éˆ• -->
                    <button class="ml-2 text-base text-indigo-500 hover:text-indigo-700 transition"
                            onclick="${buttonAction}"
                            title="${startButtonTitle}">
                            ${startIcon}
                    </button>
                </div>
                
                <div class="space-x-1">
                    <!-- Move Up (Disabled if isStartStep or is the second step) -->
                    <button class="text-gray-400 text-sm ${isStartStep || index === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:text-gray-700'}" 
                            onclick="moveStep(${index}, -1)" 
                            ${isStartStep || index === 1 ? 'disabled' : ''}>â¬†ï¸</button>
                    <!-- Move Down (Disabled if isStartStep or is the last step) -->
                    <button class="text-gray-400 text-sm ${isStartStep || index === scriptSteps.length - 1 ? 'opacity-50 cursor-not-allowed' : 'hover:text-gray-700'}" 
                            onclick="moveStep(${index}, 1)" 
                            ${isStartStep || index === scriptSteps.length - 1 ? 'disabled' : ''}>â¬‡ï¸</button>
                    <!-- Delete (Disabled if isStartStep) -->
                    <button class="text-red-400 text-sm ${isStartStep ? 'opacity-50 cursor-not-allowed' : 'hover:text-red-700'}" 
                            onclick="deleteStep(${index})" 
                            ${isStartStep ? 'disabled' : ''}>âŒ</button>
                </div>
            </div>
            ${contentHtml}
            ${imageHtml} <!-- æ’å…¥ç…§ç‰‡ä¸Šå‚³/é¡¯ç¤ºå€å¡Š -->
        `;
        listContainer.appendChild(stepElement);
    });

    // --- FINAL ANCHOR RENDERING ---
    
    // é‡æ–°è¨ˆç®—æœ€å¾Œä¸€å€‹éŒ¨é»çš„ Day-Step è™Ÿç¢¼
    let finalAnchorDay = currentDay;
    let finalAnchorStep = dayStepCount;
    
    if (scriptSteps.length > 0) {
        const lastStep = scriptSteps[scriptSteps.length - 1];
        if (lastStep.type === 'dayoff') {
            finalAnchorDay++;
            finalAnchorStep = 1;
        } else {
            finalAnchorStep++;
        }
    } else {
        // åƒ…åŒ…å«èµ·å§‹æ­¥é©Ÿæ™‚ (Day 1, Step 1)
        finalAnchorDay = 1;
        finalAnchorStep = 1;
    }
    const finalAnchorDisplay = `${finalAnchorDay}-${finalAnchorStep}`;


    // æœ€å¾Œä¸€å€‹éŒ¨é» (åœ¨æœ€å¾Œä¸€å€‹æ­¥é©Ÿä¸‹æ–¹)
    if (scriptSteps.length === insertAnchorIndex) {
        // RENDER FINAL INLINE ACTION PANEL
        const actionPanel = document.createElement('div');
        actionPanel.className = 'insert-anchor-panel p-3 my-2 bg-indigo-100 rounded-lg border-2 border-indigo-500 shadow-md';
        actionPanel.dataset.index = scriptSteps.length;
        actionPanel.innerHTML = `
            <p class="font-bold text-sm text-indigo-700 mb-2 text-center">ğŸ“Œ åœ¨ ${finalAnchorDisplay} (æœ«å°¾) æ’å…¥å‹•ä½œï¼š</p>
            <div class="grid grid-cols-2 gap-2 text-sm">
                <button onclick="addStep('goto', ${scriptSteps.length})" class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition duration-150 font-semibold">â¡ï¸ ç§»å‹•</button>
                <button onclick="addStep('activity', ${scriptSteps.length})" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition duration-150 font-semibold">ğŸƒ æ´»å‹•/ç‹€æ…‹</button>
                <button onclick="addStep('show', ${scriptSteps.length})" class="bg-yellow-500 text-gray-800 p-2 rounded-lg hover:bg-yellow-600 transition duration-150 font-semibold">ğŸ’¬ é¡¯ç¤ºè¨Šæ¯</button>
                <button onclick="addStep('dayoff', ${scriptSteps.length})" class="bg-pink-500 text-white p-2 rounded-lg hover:bg-pink-600 transition duration-150 font-semibold">ğŸ›Œ ä¼‘æ¯éå¤œ</button>
            </div>
            <button onclick="clearInsertAnchor()" class="w-full mt-3 text-xs text-indigo-700 hover:text-red-600 font-semibold">âŒ å–æ¶ˆæ’å…¥</button>
        `;
        listContainer.appendChild(actionPanel);
    } else {
        // RENDER FINAL STANDARD ANCHOR
        const finalAnchorElement = document.createElement('div');
        finalAnchorElement.className = 'insert-anchor my-2 transition-all duration-300';
        finalAnchorElement.dataset.index = scriptSteps.length;
        finalAnchorElement.onclick = () => { setInsertAnchor(scriptSteps.length); };
        finalAnchorElement.innerHTML = `<span class="insert-anchor-text">åœ¨æ­¤è™•æ·»åŠ è¡Œç¨‹ (${finalAnchorDisplay})</span>`;
        listContainer.appendChild(finalAnchorElement);
    }
    
    // ç§»é™¤æ‰€æœ‰çš„ Focus/Scroll é‚è¼¯
    
    // è™•ç† [æ‹‰åˆ°æœ€ä¸‹é¢] æŒ‰éˆ•çš„é¡¯ç¤º/éš±è—
    const controlsContainer = document.getElementById('controls');
    const scrollToBottomContainer = document.getElementById('scroll-to-bottom-container');
    
    // åªæœ‰ç•¶å…§å®¹é«˜åº¦å¤§æ–¼å¯è¦–å€åŸŸæ™‚æ‰é¡¯ç¤ºæŒ‰éˆ•
    setTimeout(() => {
        if (controlsContainer.scrollHeight > controlsContainer.clientHeight) {
            scrollToBottomContainer.classList.remove('hidden');
        } else {
            scrollToBottomContainer.classList.add('hidden');
        }
    }, 100);
}
</script>
</head>
<body class="bg-gray-50">
<!-- éŸ¿æ‡‰å¼ä½ˆå±€èª¿æ•´ -->
<div class="flex flex-col md:flex-row h-screen overflow-hidden">
  
  <!-- å³å´åœ°åœ–é¡¯ç¤ºå€ (åœ¨è¡Œå‹•è£ç½®ä¸Šåœ¨ä¸ŠåŠéƒ¨) -->
  <div id="map-container" class="w-full md:w-2/3 relative mobile-h-half h-full">
    <div id="map"></div>
    <!-- æ–°å¢ï¼šå¤œé–“å‹•ç•«é®ç½©ã€‚çµ•å°å®šä½è¦†è“‹åœ°åœ– -->
    <div id="night-overlay" class="absolute inset-0 z-[1000]"></div>
  </div>

  <!-- å·¦å´æ§åˆ¶é¢æ¿ (åœ¨è¡Œå‹•è£ç½®ä¸Šåœ¨ä¸‹åŠéƒ¨) -->
  <div id="controls" class="w-full md:w-1/3 p-4 bg-white shadow-xl overflow-y-auto flex flex-col relative mobile-h-half h-full">
    <h1 class="text-2xl font-bold text-indigo-600 mb-4 border-b pb-2">ğŸ—ºï¸ æ—…ç¨‹åŠ‡æœ¬è¨­è¨ˆå™¨</h1>

    <!-- è…³æœ¬æ­¥é©Ÿåˆ—è¡¨ - é€™æ˜¯æ²å‹•çš„å…§å®¹ -->
    <!-- ç§»é™¤äº†åŸå…ˆçš„ Action æŒ‰éˆ•é¢æ¿ï¼Œè®“æ’å…¥å‹•ä½œæ”¹ç‚ºè¡Œå…§è™•ç† -->
    <div id="script-list" class="space-y-3 flex-grow mb-4">
      <!-- æ­¥é©Ÿå°‡åœ¨æ­¤è™•æ¸²æŸ“ -->
    </div>
    
    <!-- æ’­æ”¾æ§åˆ¶æŒ‰éˆ• -->
    <div class="flex space-x-2 mb-2">
        <!-- æš«åœ/ç¹¼çºŒæŒ‰éˆ• -->
        <button id="pause-resume-button" onclick="pauseToggle()" 
            class="w-1/2 bg-yellow-500 text-gray-800 font-bold py-3 rounded-xl shadow-lg hover:bg-yellow-600 transition duration-300 transform hover:scale-[1.01] text-lg disabled:opacity-50 disabled:cursor-not-allowed" 
            disabled 
            title="æš«åœæ’­æ”¾">
            <span class="text-lg">â¸ï¸ æš«åœ/ç¹¼çºŒ</span>
        </button>
         <!-- åœæ­¢æ’­æ”¾æŒ‰éˆ• (æ–°å¢) -->
        <button id="stop-button" onclick="stopScript()" 
            class="w-1/2 bg-gray-500 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-gray-600 transition duration-300 transform hover:scale-[1.01] text-lg disabled:opacity-50 disabled:cursor-not-allowed" 
            disabled 
            title="åœæ­¢æ’­æ”¾">
            <span class="text-lg">â—¼ï¸ åœæ­¢æ’­æ”¾</span>
        </button>
    </div>


    <!-- æ’­æ”¾æŒ‰éˆ• -->
    <button id="play-button" onclick="executeScript(1)" class="w-full bg-indigo-500 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-[1.01] text-lg mb-2">
      â–¶ï¸ å¾é ­é–‹å§‹æ’­æ”¾ (PLAY)
    </button>
    
    <!-- åŒ¯å‡ºèˆ‡åˆªé™¤æŒ‰éˆ• (æ–°ä½ˆå±€) -->
    <div class="flex space-x-2 mb-2">
        <!-- åŒ¯å‡ºæŒ‰éˆ•ï¼šç¾åœ¨æ˜¯ä¸‹è¼‰æª”æ¡ˆ -->
        <button id="export-button" onclick="exportScript()" class="w-1/3 bg-gray-200 text-gray-800 font-bold py-3 rounded-xl shadow-lg hover:bg-gray-300 transition duration-300 transform hover:scale-[1.01] text-lg">
          ğŸ’¾ åŒ¯å‡ºæª”æ¡ˆ
        </button>
        <!-- åŒ¯å…¥æŒ‰éˆ•ï¼šç¾åœ¨æ˜¯ä¸Šå‚³æª”æ¡ˆï¼Œé»æ“Šæœƒè§¸ç™¼éš±è—çš„ file input -->
        <button id="import-file-button" onclick="document.getElementById('file-input').click()" class="w-1/3 bg-gray-400 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-gray-500 transition duration-300 transform hover:scale-[1.01] text-lg">
          ğŸ“¤ åŒ¯å…¥æª”æ¡ˆ
        </button>
        <!-- åˆªé™¤æŒ‰éˆ• -->
        <button id="delete-all-button" onclick="promptClearScript()" class="w-1/3 bg-red-400 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-red-600 transition duration-300 transform hover:scale-[1.01] text-lg">
          ğŸ—‘ï¸ å…¨éƒ¨åˆªé™¤
        </button>
    </div>

    <div id="status-message" class="mt-2 text-center text-sm font-medium text-gray-600">æº–å‚™å°±ç·’</div>

    <!-- éŒ¯èª¤æ™‚é¡¯ç¤ºçš„æ‰‹å‹•è¤‡è£½å€åŸŸæœƒå‹•æ…‹æ’å…¥æ­¤è™• -->

    <!-- æ–°å¢ï¼šæ‹‰åˆ°æœ€ä¸‹é¢æŒ‰éˆ• (STICKY/å›ºå®šåœ¨å…§å®¹åº•éƒ¨) -->
    <div id="scroll-to-bottom-container" class="w-full p-2 -mx-4 bg-white shadow-md border-t border-gray-200 z-10 hidden">
        <button onclick="scrollToBottom()" class="w-full bg-gray-100 text-gray-700 font-semibold py-2 rounded-lg hover:bg-gray-200 transition duration-150 text-sm">
            ğŸ‘‡ æ‹‰åˆ°æœ€ä¸‹é¢
        </button>
    </div>

  </div> <!-- End #controls -->
</div>

<!-- éš±è—çš„æª”æ¡ˆè¼¸å…¥å…ƒä»¶ -->
<!-- accept="text/plain" æ˜¯è§£æ±º iOS ç›¸å®¹æ€§çš„é—œéµ -->
<input type="file" id="file-input" style="display:none;" accept="text/plain" onchange="handleFileUpload(event)">

<script>
// --------------------------------------------------------
// åˆå§‹åŒ–ï¼š Leaflet/DOM ä¾è³´çš„ç¨‹å¼ç¢¼ç§»å…¥ DOMContentLoaded
// --------------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
    // ç¢ºä¿ #map å…ƒç´ å­˜åœ¨å¾Œæ‰é€²è¡Œåˆå§‹åŒ–
    mapInstance = L.map('map').setView(INITIAL_GPS, 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(mapInstance);
    marker = L.marker(INITIAL_GPS, { icon: icons.train }).addTo(mapInstance);
    
    checkAndLoadScriptFromURL(); 
    renderScript();
});
</script>
</body>
</html>