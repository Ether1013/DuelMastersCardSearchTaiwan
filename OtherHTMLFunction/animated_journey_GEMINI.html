<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Animated Journey Script Editor</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- å¼•å…¥ Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  /* ç¢ºä¿åœ°åœ–ä½”æ»¿å‰©ä¸‹çš„ç©ºé–“ */
  #map { height: 100%; width: 100%; }
  /* ç¢ºä¿ DivIcon å…§çš„ Emoji å±…ä¸­ */
  .leaflet-div-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
  }
  /* è‡ªè¨‚æ¨£å¼ï¼šç›®æ¨™æ˜Ÿè™Ÿ (Target Marker) */
  /* æ–°å¢ï¼šç”¨æ–¼ç›®æ¨™æ˜Ÿè™Ÿï¼Œç¢ºä¿æ²’æœ‰èƒŒæ™¯ä¸” Z-index è¼ƒä½ */
  .target-star-icon {
    /* ç¢ºä¿æ²’æœ‰èƒŒæ™¯ */
    background: none !important;
    /* æ–°å¢ï¼šç¢ºä¿ç§»é™¤ DIV çš„é‚Šæ¡† */
    border: none !important; 
    /* é è¨­ Leaflet marker Z-index æ˜¯ 200ï¼Œé€™è£¡è¨­ç‚º 100 */
    z-index: 100 !important; 
  }
  .target-star-icon div {
      /* ç¸®å°åˆ°ç´„ 1/3 (å¾ 75px ç¸®å°åˆ° 25px æˆ– 30px) */
      font-size: 30px !important; 
  }

  /* å¤œé–“é®ç½©æ¨£å¼ï¼Œåˆå§‹ç‚ºé€æ˜ï¼Œç­‰å¾… JS æ§åˆ¶ */
  #night-overlay {
    background-color: black;
    opacity: 0;
    pointer-events: none; /* è®“é»æ“Šäº‹ä»¶ç©¿é€ */
    transition-property: opacity;
  }
  /* è‡ªè¨‚æ¨£å¼ï¼šæ”¾å¤§æç¤ºè¦–çª— (Popup) */
  .custom-large-popup .leaflet-popup-content-wrapper {
    /* æ¡Œé¢é è¨­å¤§å° (~3x) */
    font-size: 1.5rem; 
    line-height: 2rem;
    padding: 1.5rem;
    border-radius: 1rem;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    background-color: #fefcbf; /* æŸ”å’Œé»ƒè‰²èƒŒæ™¯ */
    color: #444;
  }
  .custom-large-popup .leaflet-popup-tip {
    background-color: #fefcbf;
    width: 20px;
    height: 10px;
  }
  .custom-large-popup .leaflet-popup-content {
      /* ç¢ºä¿å…§å®¹å¯ä»¥æ’é–‹ */
      width: 100%; 
      max-width: 300px;
      text-align: center;
      font-weight: bold;
  }
  /* æ¨¡æ…‹æ¡†å…§å®¹çš„éæ¸¡æ•ˆæœ */
  .modal-transition {
      transition: opacity 0.3s, transform 0.3s;
  }
  /* --- éŒ¨é»æ’å…¥ UI (ä¿®æ­£: çµ±ä¸€ä½¿ç”¨ CSS è™•ç†æ‡¸åœ) --- */
  .insert-anchor {
      min-height: 10px; /* ç¢ºä¿æœ€å°é»æ“Šç›®æ¨™ */
      margin: 8px 0;
      transition: all 0.2s ease-in-out;
      cursor: pointer;
      background-color: #f9fafb; /* bg-gray-50 */
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #e5e7eb; /* é è¨­é‚Šæ¡† */
  }
  /* æ‡¸åœæ™‚çš„ç‹€æ…‹: å¢åŠ é«˜åº¦ï¼Œé¡¯ç¤ºè™›ç·šæ¡†å’Œæ–‡å­— */
  .insert-anchor:hover {
      min-height: 80px; /* å¢åŠ é«˜åº¦ï¼Œæ¥è¿‘ä¸€å€‹æ­¥é©Ÿå¡ç‰‡ */
      opacity: 1; 
      border: 3px dashed #6366f1; /* indigo-500 */
      background-color: #eef2ff; /* indigo-50 */
  }
  /* æ‡¸åœæ™‚æ‰é¡¯ç¤ºæ–‡å­— */
  .insert-anchor:hover .insert-anchor-text {
      opacity: 1;
  }
  .insert-anchor-text {
      opacity: 0;
      font-weight: bold;
      color: #6366f1;
      transition: opacity 0.2s;
      pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ° anchor */
  }

  /* æ­¥é©Ÿå¡ç‰‡åŸºç¤æ¨£å¼ï¼Œå…è¨±é»æ“Š (ç§»é™¤ Focus ç›¸é—œæ¨£å¼) */
  .step-card {
      transition: background-color 0.1s, box-shadow 0.2s;
  }
  .step-card:hover {
      background-color: #f3f4f6; /* bg-gray-100 */
  }

  /* éŸ¿æ‡‰å¼ï¼šå¼·åˆ¶ç¸±å‘ä½ˆå±€ */
  @media (max-width: 767px) {
    /* ä¿®æ­£ 2: è¡Œå‹•è£ç½® ICON ç¸®å°åˆ° 40px */
    .leaflet-div-icon div {
        font-size: 40px !important;
    }
    /* ä¿®æ­£ 1: è¡Œå‹•è£ç½® POPUP ç¸®å°åˆ° 1/3 */
    .custom-large-popup .leaflet-popup-content-wrapper {
        font-size: 0.85rem; /* ç´„ 1/3 */
        line-height: 1.25rem; 
        padding: 0.75rem; /* é‚Šè·ç¸®å° */
    }

    /* --- è¡Œå‹•è£ç½®ä½ˆå±€é‚è¼¯ (æ ¹æ“š body ä¸Šçš„ class åˆ‡æ›) --- */

    /* 1. ç·¨è¼¯æ¨¡å¼ (mobile-controls-only): éš±è—åœ°åœ–ï¼Œé¡¯ç¤ºæ•´å€‹ #controls (æ»¿é«˜) */
    .mobile-controls-only #map-container {
        display: none !important;
    }
    .mobile-controls-only #controls {
        height: 100vh !important;
        flex: 1 1 100% !important; 
        display: flex;
        flex-direction: column;
    }
    /* åœ¨æ‰‹æ©Ÿç·¨è¼¯æ¨¡å¼ä¸‹ï¼Œè®“åˆ—è¡¨ä½”æ»¿ç©ºé–“ä¸”å¯æ²å‹• */
    .mobile-controls-only #top-area-wrapper {
        flex-grow: 1;
        /* è¡Œå‹•è£ç½®ä¸Šä¹Ÿè¦ä¿ç•™æ©™è‰²å€å¡Šï¼Œæ‰€ä»¥é€™è£¡æ”¹ç‚ºæ°´å¹³ flex */
        flex-direction: row; /* ä¿æŒæ°´å¹³åˆ†å‰² */
        min-height: 0; /* ç¢ºä¿åœ¨ flex å®¹å™¨å…§èƒ½æ­£ç¢ºè¨ˆç®—é«˜åº¦ */
    }
    
    /* ç¢ºä¿æ©™è‰²å€å¡Šåœ¨æ‰‹æ©Ÿç·¨è¼¯æ¨¡å¼ä¸‹å¯è¦‹ */
    .mobile-controls-only #day-progress-bar { /* æ”¹åå¾Œçš„ ID */
        display: block !important; /* è¦†è“‹ hidden md:block */
        flex-shrink: 0;
    }
    
    .mobile-controls-only #script-list-wrapper {
        flex-grow: 1; 
        overflow-y: auto; 
    }
    .mobile-controls-only #bottom-controls {
        flex-shrink: 0; /* ä¸å£“ç¸®åº•éƒ¨é¢æ¿ */
    }
    
    /* 2. æ’­æ”¾æ¨¡å¼ (mobile-playing): éš±è—è¡Œç¨‹åˆ—è¡¨ï¼Œåœ°åœ–ä½”å‰©é¤˜ç©ºé–“ï¼Œæ§åˆ¶é¢æ¿è²¼åº• (ä¿®æ­£ç•™ç™½å•é¡Œ) */
    .mobile-playing #script-list {
        display: none !important;
    }

    .mobile-playing #top-area-wrapper { /* éš±è—ç´…ã€æ©™å€å¡Šçš„çˆ¶å®¹å™¨ */
        display: none !important;
    }
    
    .mobile-playing #map-container {
        /* è®“åœ°åœ–ä½”æ»¿æ‰€æœ‰å‰©é¤˜ç©ºé–“ */
        height: auto !important; 
        flex: 1 1 auto !important; 
    }
    .mobile-playing #controls {
        /* åªä½”æ“šå…§å®¹æ‰€éœ€çš„é«˜åº¦ */
        height: auto !important;
        flex: 0 0 auto !important; 
        
        /* ç¢ºä¿å…§éƒ¨å…§å®¹æ˜¯å‚ç›´å †ç–Š */
        display: flex;
        flex-direction: column; 
    }
    
    .mobile-playing #bottom-controls {
        /* ç§»é™¤å¼·åˆ¶ 100% é«˜åº¦ï¼Œè®“å®ƒä½¿ç”¨ h-[190px] çš„å¯¦éš›å…§å®¹é«˜åº¦ */
        height: auto !important; 
        flex-shrink: 0 !important;
    }
  }

</style>
<!-- å¼•å…¥ Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// =================================================================
// 1. å…¨åŸŸå¸¸æ•¸èˆ‡è®Šæ•¸è²æ˜ (æœ€é ‚å±¤)
// =================================================================
const STORAGE_KEY = 'animatedJourneyScript';
const EXPIRY_MS = 2 * 24 * 60 * 60 * 1000; // 2 å¤© (æ¯«ç§’)
const FILE_EXTENSION = '.txt'; // ä¿®æ”¹ç‚ºæ›´é€šç”¨çš„ .txt ä»¥æé«˜ iOS å…¼å®¹æ€§
const ARC_HEIGHT_DEG = 0.5; // é£›æ©Ÿå¼§ç·šè·¯å¾‘çš„æœ€é«˜é»æŠ¬å‡ç·¯åº¦ (ç´„ 55 å…¬é‡Œ)
const ARC_SEGMENTS = 25; // é£›æ©Ÿå¼§ç·šè·¯å¾‘åˆ†æ®µæ•¸ï¼Œè¶Šå¤šè¶Šå¹³æ»‘
// åœ–ç‰‡å£“ç¸®å¾Œçš„é•·é‚Šä¸Šé™ (å¯¬æˆ–é«˜)
const MAX_LONG_SIDE = 400; 
const PHOTO_STANDALONE_DURATION = 2.5; // ç§»å‹•å’Œè¨Šæ¯æ­¥é©Ÿç…§ç‰‡ç¨ç«‹æ’­æ”¾æ™‚é•· (ç§’)
const FREEZE_TIMEOUT_SEC = 15; // å‡çµåµæ¸¬è¶…æ™‚æ™‚é–“ (ç§’)

// å®šç¾© 2 ç¨®é¡è‰² (ä½é£½å’Œåº¦: æ·¡éŠ˜é»ƒ/ç¥ç€è‰² å’Œ æ·¡ç´«/ç´«è‰²) ä¾› Day-Step è¼ªæ›¿ä½¿ç”¨
const DAY_COLORS_PALETTE = [
    // æ·ºæ©˜é»ƒè‰² (æ·¡éŠ˜é»ƒ)
    { bg: 'bg-amber-100', border: 'border-amber-400', text: 'text-amber-700' },
    // æ·ºç´«è‰² (æ·¡ç´«)
    { bg: 'bg-purple-100', border: 'border-purple-400', text: 'text-purple-700' },
];

const iconSize = 75; // æ¡Œé¢é è¨­å¤§å°
// ä¿®æ­£ BUGï¼šç‚ºæœ‰è¡çªçš„åœ–ç¤ºæŒ‡å®šå”¯ä¸€çš„ `char` å±¬æ€§ç”¨æ–¼åŒ¯å‡ºä»£è™Ÿ
const ICON_NAMES = [
    // äº¤é€š (Traffic) - char: a, t, c, x, b, o
    { name: 'airplane', emoji: 'âœˆï¸', char: 'a' },   // é£›æ©Ÿ (a)
    { name: 'train', emoji: 'ğŸš†', char: 't' },        // ç«è»Š (t)
    { name: 'car', emoji: 'ğŸš—', char: 'c' },          // æ±½è»Š (c)
    { name: 'taxi', emoji: 'ğŸš•', char: 'x' },         // è¨ˆç¨‹è»Š (x) - é¿å…èˆ‡ t è¡çª
    { name: 'bus', emoji: 'ğŸšŒ', char: 'b' },          // å·´å£« (b)
    { name: 'motorcycle', emoji: 'ğŸï¸', char: 'o' },   // æ©Ÿè»Š (o) - é¿å…èˆ‡ m è¡çª
    
    // æ´»å‹•/ç‹€æ…‹ (Activity/Status) - char: w, v, m, s, d
    { name: 'walk', emoji: 'ğŸš¶â€â™‚ï¸', char: 'w' },         // æ­¥è¡Œ (w)
    { name: 'view', emoji: 'ğŸï¸', char: 'v' },         // æ™¯é» (v)
    { name: 'amusement', emoji: 'ğŸ¡', char: 'm' },    // éŠæ¨‚ (m) - é¿å…èˆ‡ a è¡çª
    { name: 'shopping', emoji: 'ğŸ›ï¸', char: 's' },     // è³¼ç‰© (s)
    { name: 'dine', emoji: 'ğŸ½ï¸', char: 'd' },         // ç”¨é¤ (d)
    
    // ä¼‘æ¯ (Sleep) - char: z
    { name: 'sleep', emoji: 'ğŸ˜´', char: 'z' }        // ç¡çœ  (z) - é¿å…èˆ‡ s è¡çª
];

// æ ¹æ“š ICON_NAMES å»ºç«‹ icons ç‰©ä»¶ï¼Œæ–¹ä¾¿æŸ¥æ‰¾
const icons = ICON_NAMES.reduce((acc, item) => {
    acc[item.name] = L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">${item.emoji}</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] });
    return acc;
}, {});

// é è¨­è¡Œç¨‹çš„èµ·å§‹ GPS åº§æ¨™ (ç”±ç”¨æˆ¶æŒ‡å®š: 25.08100786985067, 121.23348442971395)
const INITIAL_GPS = [25.08100786985067, 121.23348442971395];
const START_STEP_DEFINITION = { 
    type: 'start', 
    lat: INITIAL_GPS[0], 
    lng: INITIAL_GPS[1], 
    label: 'æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ (TPE, åˆå§‹ä½ç½®)' 
};

// ä½¿ç”¨ let è²æ˜ï¼Œä»¥ä¾¿åœ¨ DOMContentLoaded ä¸­è³¦å€¼ (è§£æ±º Map container not found)
let mapInstance = null;
let marker = null;
let polyline = null;
let popup = null;
let imageModal = null; // åœ–ç‰‡é¡¯ç¤ºæ¨¡æ…‹æ¡†
let currentAnimation = false;
let isScriptRunning = false;
let isPaused = false;
let pauseResolve = null; 
let currentWaitTimeoutId = null;
let currentWaitRemainingTime = 0;
let currentWaitStartTime = 0;
let currentWaitResolve = null; 
let clearScriptTimeoutId = null; 
let hoverTimeoutId = null; // ç”¨æ–¼éŒ¨é»æç¤ºçš„è¨ˆæ™‚å™¨
let insertAnchorIndex = -1; // å„²å­˜è¦æ’å…¥æ­¥é©Ÿçš„ç´¢å¼•ä½ç½® (-1 è¡¨ç¤ºæ²’æœ‰éŒ¨é»)
let freezeTimeoutId = null; // å‡çµåµæ¸¬è¨ˆæ™‚å™¨ ID (æ–°å¢)
let skipPhotoResolve = null; // è·³éç…§ç‰‡ç­‰å¾…çš„ Promise Resolver (æ–°å¢)
let isMobile = false; // æ–°å¢ï¼šæ˜¯å¦ç‚ºè¡Œå‹•è£ç½®
let conflictScriptUrl = null; // ç”¨æ–¼å„²å­˜è¡çªçš„ URL
let targetMarker = null; // ç”¨æ–¼GoToç›®æ¨™ä½ç½®çš„æ˜Ÿè™Ÿæ¨™è¨˜ (éœ€æ±‚ 3)

// æ–°å¢ï¼šå„²å­˜ Day-Start æ­¥é©Ÿçš„ç´¢å¼•
// [ { day: 1, stepIndex: 1, colorIndex: 0 }, { day: 2, stepIndex: 5, colorIndex: 1 }, ... ]
let dayStartIndices = [];


// åˆå§‹åŠ‡æœ¬
let scriptSteps = [
    START_STEP_DEFINITION,
];


// =================================================================
// 3. Local Storage å„²å­˜èˆ‡è¼‰å…¥é‚è¼¯
// =================================================================

/**
 * è¼”åŠ©å‡½å¼ï¼šå„²å­˜è³‡æ–™åˆ° LocalStorageï¼ŒåŒ…å«åˆ°æœŸæ™‚é–“
 */
function setLocalStorage(key, data, expiryMs) {
    const item = {
        data: data,
        expiry: new Date().getTime() + expiryMs,
    }
    try {
        localStorage.setItem(key, JSON.stringify(item));
    } catch (e) {
        console.warn("LocalStorage set failed, possibly due to quota limits.");
    }
}

/**
 * è¼”åŠ©å‡½å¼ï¼šå¾ LocalStorage ç²å–è³‡æ–™ï¼Œä¸¦æª¢æŸ¥æ˜¯å¦åˆ°æœŸ
 */
function getLocalStorage(key) {
    let itemStr;
    try {
        itemStr = localStorage.getItem(key);
    } catch (e) {
        console.warn("LocalStorage get failed.");
        return null;
    }
    
    if (!itemStr) {
        return null;
    }
    
const item = JSON.parse(itemStr);
    const now = new Date().getTime();
    
    // æª¢æŸ¥æ˜¯å¦åˆ°æœŸ
    if (now > item.expiry) {
        localStorage.removeItem(key);
        return null;
    }
    return item.data;
}

/**
 * å°‡ç•¶å‰åŠ‡æœ¬å„²å­˜åˆ° LocalStorage
 */
function saveScriptToLocalStorage() {
    try {
        const jsonString = JSON.stringify(scriptSteps);
        // ç›´æ¥å„²å­˜ JSON å­—ä¸²ï¼ŒLocal Storage æ”¯æ´ UTF-8
        setLocalStorage(STORAGE_KEY, jsonString, EXPIRY_MS);
    } catch (e) {
        console.error('Failed to save script to LocalStorage:', e);
    }
}

// =================================================================
// 4. æ•¸æ“šè¼‰å…¥èˆ‡è§£æ
// =================================================================

/**
 * è¼”åŠ©å‡½å¼ï¼šå„ªåŒ–è¼‰å…¥çš„åŠ‡æœ¬ï¼Œåˆä½µç‰¹å®šçš„é€£çºŒæ­¥é©Ÿã€‚
 * é‚è¼¯ï¼šå°‡ 'goto' (ç„¡åœ–) å¾Œæ¥ 'activity' (æœ‰åœ–) åˆä½µç‚ºå–®ä¸€çš„ 'goto' (æœ‰åœ–)ã€‚
 * @param {Array<Object>} steps - å®Œæ•´çš„åŠ‡æœ¬æ­¥é©Ÿé™£åˆ— (æœƒè¢« in-place ä¿®æ”¹)
 * @returns {Array<Object>} - å„ªåŒ–å¾Œçš„åŠ‡æœ¬æ­¥é©Ÿé™£åˆ—
 */
function optimizeLoadedScript(steps) {
    if (!Array.isArray(steps) || steps.length < 2) {
        return steps;
    }
    
    for (let i = 0; i < steps.length; i++) {
        const currentStep = steps[i];
        
        // æª¢æŸ¥ç•¶å‰æ­¥é©Ÿæ˜¯å¦ç‚º goto å°ä¸”æ²’æœ‰åœ–ç‰‡
        if (currentStep.type === 'goto' && !currentStep.image) {
            const nextStep = steps[i + 1];
            
            // æª¢æŸ¥ä¸‹ä¸€å€‹æ­¥é©Ÿæ˜¯å¦ç‚º activity ä¸”æœ‰åœ–ç‰‡
            // ç‚ºäº†ç°¡åŒ–ï¼Œåªè¦ activity æœ‰åœ–å°±åˆä½µï¼Œä½†æé†’ç”¨æˆ¶æ´»å‹•æ™‚é–“æœƒè¢«å¿½ç•¥
            if (nextStep && nextStep.type === 'activity' && nextStep.image) {
                
                // --- åŸ·è¡Œåˆä½µ ---
                
                // 1. è½‰ç§»åœ–ç‰‡ï¼šå°‡ activity çš„åœ–ç‰‡è½‰ç§»çµ¦ goto (é€™æ˜¯ä¸»è¦ç›®çš„)
                currentStep.image = nextStep.image;
                
                // 2. è½‰ç§» Icon (å¦‚æœ goto å°šæœªæŒ‡å®š icon)
                if (!currentStep.icon && nextStep.icon) {
                    currentStep.icon = nextStep.icon;
                }
                
                // 3. è½‰ç§» Label (å¦‚æœ goto å°šæœªæŒ‡å®š label ä¸” activity æœ‰ label)
                if (!currentStep.label && nextStep.label) {
                    currentStep.label = nextStep.label;
                }
                
                // 4. ç§»é™¤ä¸‹ä¸€å€‹æ­¥é©Ÿ (activity)
                steps.splice(i + 1, 1);
                
                // 5. èª¿æ•´ç´¢å¼•ï¼šå› ç‚ºç§»é™¤äº†å…ƒç´ ï¼Œi å¿…é ˆæ¸› 1ï¼Œä»¥ä¾¿åœ¨ä¸‹ä¸€æ¬¡è¿´åœˆä¸­é‡æ–°æª¢æŸ¥ç•¶å‰ä½ç½® (å³æ–°çš„ nextStep)
                i--; 
            }
        }
    }
    
    return steps; // ç”±æ–¼æ˜¯ in-place ä¿®æ”¹ï¼Œç›´æ¥è¿”å›
}

/**
 * å°‡ç°¡åŒ–çš„æ•¸æ“šå­—ä¸²è§£æ§‹ä¸¦è¼‰å…¥åˆ° scriptSteps
 * @param {string} rawJsonString - åŒ¯å…¥çš„ JSON å­—ä¸² (å·² URI è§£ç¢¼ï¼Œå¦‚æœåŒ¯å‡ºæ™‚æœ‰ç·¨ç¢¼çš„è©±)
 * @returns {boolean} - æˆåŠŸè¼‰å…¥è¿”å› true
 */
function loadImportedData(rawJsonString) {
    // Helper to map icon char back to full name
    const ICON_CHAR_MAP = ICON_NAMES.reduce((map, item) => {
        // ä½¿ç”¨ char å±¬æ€§ä½œç‚º keyï¼Œname å±¬æ€§ä½œç‚º value
        map[item.char] = item.name; 
        return map;
    }, {});
    
    // Helper to uncompact the script format (å¾ compactArray è½‰æ›å› fullScript)
    function uncompactScript(compactArray) {
        const fullScript = [];
        
        // å¤–å±¤è¿´åœˆæ‡‰éæ­·æ¯ä¸€å€‹æ­¥é©Ÿé™£åˆ—
        for (const compactStep of compactArray) {
            let i = 0; // å…§éƒ¨ç´¢å¼•
            
            // æª¢æŸ¥ compactStep æ˜¯å¦çœŸçš„æ˜¯ä¸€å€‹æ•¸çµ„ï¼Œä¸¦ä¸”ç¬¬ä¸€å€‹å…ƒç´ æ˜¯é¡å‹å­—ç¬¦
            if (!Array.isArray(compactStep) || compactStep.length === 0) {
                 console.warn('Skipping invalid compact step:', compactStep);
                 continue;
            }

            const typeChar = compactStep[i++];
            let step = { label: '' }; // é è¨­ label
            
            switch (typeChar) {
                case 's': // start: s, lat, lng, [label], [image]
                    step.type = 'start';
                    step.lat = compactStep[i++];
                    step.lng = compactStep[i++];
                    step.label = 'æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ (TPE, åˆå§‹ä½ç½®)'; 
                    
                    // æª¢æŸ¥å¯é¸çš„ label
                    if (compactStep.length > i && typeof compactStep[i] === 'string' && !compactStep[i].startsWith('data:image/')) {
                         step.label = compactStep[i++];
                    }
                    // æª¢æŸ¥å¯é¸çš„ image (Base64)
                    if (compactStep.length > i && typeof compactStep[i] === 'string' && compactStep[i].startsWith('data:image/')) {
                        // FIX: ç§»é™¤ decodeURIComponent()ï¼Œå› ç‚ºç¾åœ¨åŒ¯å‡ºæ™‚åªåœ¨å–®ä¸€åœ–ç‰‡å±¤ç´šé€²è¡Œç·¨ç¢¼ï¼Œå¤–å±¤ JSON å·²åœ¨ handleFileUpload/loadScriptFromUrl è§£ç¢¼
                        step.image = compactStep[i++];
                    }
                    break;
                case 'g': // goto: g, lat, lng, iconChar, words, [image]
                    step.type = 'goto';
                    step.lat = compactStep[i++];
                    step.lng = compactStep[i++];
                    const iconCharG = compactStep[i++];
                    // ä¿®æ­£ï¼šä½¿ç”¨ ICON_CHAR_MAP é€²è¡Œè½‰æ›
                    step.icon = iconCharG ? ICON_CHAR_MAP[iconCharG] || iconCharG : '';
                    step.words = compactStep[i++];
                    step.label = 'è¼‰å…¥çš„ç§»å‹•æ­¥é©Ÿ';
                    
                    // æª¢æŸ¥å¯é¸çš„ image (Base64)
                    if (compactStep.length > i) {
                        // FIX: ç§»é™¤ decodeURIComponent()
                        step.image = compactStep[i++];
                    }
                    break;
                case 'a': // activity: a, sec, [iconChar], [image]
                    step.type = 'activity';
                    step.sec = compactStep[i++];
                    const activityIconChar = compactStep[i];
                    // ä¿®æ­£ï¼šä½¿ç”¨ ICON_CHAR_MAP é€²è¡Œè½‰æ›
                    step.icon = activityIconChar ? (ICON_CHAR_MAP[activityIconChar] || activityIconChar) : '';
                    if (step.icon) i++;
                    step.label = 'è¼‰å…¥çš„æ´»å‹•';
                    
                    // æª¢æŸ¥å¯é¸çš„ image (Base64)
                    if (compactStep.length > i) {
                        // FIX: ç§»é™¤ decodeURIComponent()
                        step.image = compactStep[i++];
                    }
                    break;
                case 'h': // show: h, words, [image], [sec]
                    step.type = 'show';
                    step.label = 'è¼‰å…¥çš„è¨Šæ¯';
                    
                    // i = 1 (æŒ‡å‘ words, image, or sec)
                    let potentialWords = compactStep[i];
                    
                    // --- é—œéµä¿®å¾©é‚è¼¯ ---
                    // 1. æª¢æŸ¥ç•¶å‰å…ƒç´ æ˜¯å¦æ˜¯ Base64 åœ–ç‰‡ (é€™æ˜¯èˆŠç‰ˆ Bug æª”æ¡ˆçš„ç‰¹å¾µ: words è¢«çœç•¥)
                    if (compactStep.length > i && typeof compactStep[i] === 'string' && compactStep[i].startsWith('data:image/')) {
                        // èˆŠç‰ˆ Bug æª”æ¡ˆï¼šwords è¢«çœç•¥ã€‚è·³é words è®€å–ï¼Œwords è¨­ç‚ºç©º
                        step.words = '';
                        // i ä¸éå¢ï¼Œç¹¼çºŒæŒ‡å‘åœ–ç‰‡ Base64 (è®“å¾Œé¢çš„åœ–ç‰‡æª¢æŸ¥è®€å–å®ƒ)
                    }
                    // 2. æª¢æŸ¥ç•¶å‰å…ƒç´ æ˜¯å¦æ˜¯ words (æ–°ç‰ˆæˆ–èˆŠç‰ˆé Bug æª”æ¡ˆ: words å­˜åœ¨)
                    else if (compactStep.length > i && typeof compactStep[i] === 'string') {
                        // è®€å– wordsï¼Œi éå¢
                        step.words = compactStep[i++]; 
                    }
                    else {
                        // Words æ¬„ä½ç¼ºå¤± (ä¸æ‡‰è©²ç™¼ç”Ÿ)
                        step.words = '';
                    }
                    
                    // 3. æª¢æŸ¥å¯é¸çš„ image (Base64)
                    // i ç¾åœ¨æŒ‡å‘åœ–ç‰‡æˆ– sec
                    if (compactStep.length > i && typeof compactStep[i] === 'string' && compactStep[i].startsWith('data:image/')) {
                        // FIX: ç§»é™¤ decodeURIComponent()
                        step.image = compactStep[i++];
                    }

                    // 4. æª¢æŸ¥å¯é¸çš„ sec (æŒçºŒæ™‚é–“)
                    // i ç¾åœ¨æŒ‡å‘ sec æˆ–çµæŸ
                    if (compactStep.length > i && typeof compactStep[i] === 'number') {
                        step.sec = compactStep[i++];
                    }
                    break;
                case 'd': // dayoff: d, sec, [image]
                    step.type = 'dayoff';
                    step.sec = compactStep[i++];
                    step.label = 'è¼‰å…¥çš„ä¼‘æ¯éå¤œ';
                    
                    // æª¢æŸ¥å¯é¸çš„ image (Base64)
                    if (compactStep.length > i) {
                        // FIX: ç§»é™¤ decodeURIComponent()
                        step.image = compactStep[i++];
                    }
                    break;
                default:
                    console.warn('Unknown compact step type:', typeChar);
                    return null; // åœæ­¢è§£æ
            }
            fullScript.push(step);
        }
        return fullScript;
    }

    // 1. è§£æ JSON å­—ä¸²
    let compactArray;
    try {
        compactArray = JSON.parse(rawJsonString);
        // é©—è­‰æœ€å¤–å±¤æ˜¯å¦ç‚ºæ•¸çµ„
        if (!Array.isArray(compactArray)) {
            console.error('Parsed data is not an array.');
            return false;
        }
    } catch (e) {
        console.error('JSON parse error after URI decoding:', e);
        return false;
    }

    // 2. è½‰æ›å›å®Œæ•´åŠ‡æœ¬çµæ§‹
    let loadedSteps = uncompactScript(compactArray);
    
    if (!loadedSteps) return false;

    // 2.5. æ–°å¢ï¼šåŸ·è¡ŒåŠ‡æœ¬å„ªåŒ–åˆä½µ (è™•ç† [goto, activity(photo)] åˆä½µ)
    const optimizedSteps = optimizeLoadedScript(loadedSteps);

    // 3. é©—è­‰ä¸¦è¼‰å…¥
    if (Array.isArray(optimizedSteps) && optimizedSteps.length > 0 && optimizedSteps[0].type === 'start') {
        scriptSteps = optimizedSteps; // ä½¿ç”¨å„ªåŒ–å¾Œçš„æ­¥é©Ÿ
        return true;
    }
    return false;
}

/**
 * å¾æŒ‡å®šçš„ URL è¼‰å…¥åŠ‡æœ¬æª”æ¡ˆå…§å®¹ã€‚
 * æ”¯æ´æŒ‡æ•¸é€€é¿é‡è©¦æ©Ÿåˆ¶ã€‚
 * @param {string} url - åŠ‡æœ¬æª”æ¡ˆçš„ URL (é æœŸç‚º URI-encoded JSON string)
 * @returns {Promise<string|null>} - æˆåŠŸæ™‚è¿”å›æª”æ¡ˆå…§å®¹å­—ä¸²ï¼Œå¤±æ•—æ™‚è¿”å› null
 */
async function fetchWithRetry(url, maxRetries = 3) {
    const statusMessage = document.getElementById('status-message');
    for (let attempt = 0; attempt < maxRetries; attempt++) {
        try {
            // å˜—è©¦è¼‰å…¥ç¶²è·¯è³‡æºæ™‚ï¼Œä¸è¦åœ¨æ§åˆ¶å°è¨˜éŒ„éŒ¯èª¤
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
            }

            const text = await response.text();
            return text;

        } catch (error) {
            // åœ¨æ§åˆ¶å°è¼¸å‡ºéŒ¯èª¤
            console.error(`å˜—è©¦å¾ URL è¼‰å…¥åŠ‡æœ¬å¤±æ•— (å˜—è©¦ ${attempt + 1}/${maxRetries}):`, error);
            if (attempt < maxRetries - 1) {
                const delay = Math.pow(2, attempt) * 1000; // 1s, 2s, 4s
                statusMessage.textContent = `âš ï¸ Load failed, retrying in ${delay / 1000}s...`;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }
    statusMessage.textContent = 'âŒ Failed to load script from URL. Max retries reached.';
    return null;
}

/**
 * è™•ç†å¾æŒ‡å®šçš„ URL è¼‰å…¥åŠ‡æœ¬ï¼Œæ›´æ–°ç‹€æ…‹ï¼Œä¸¦å„²å­˜åˆ°æœ¬åœ°ã€‚
 * @param {string} url - åŠ‡æœ¬æª”æ¡ˆçš„ URL
 */
async function loadScriptFromUrl(url) {
    const statusMessage = document.getElementById('status-message');
    statusMessage.textContent = `ğŸŒ Loading script from URL: ${url.substring(0, 40)}...`;
    
    const fileContent = await fetchWithRetry(url);

    if (!fileContent) {
        return false;
    }
    
    try {
        // FIX: å› ç‚º exportScript ç§»é™¤äº†å°æ•´å€‹ JSON çš„ç·¨ç¢¼ï¼Œä½†èˆŠæª”æ¡ˆå¯èƒ½ä»å­˜åœ¨ç·¨ç¢¼ï¼Œ
        // ç‚ºäº†å…¼å®¹æ€§ï¼Œæˆ‘å€‘åœ¨æ­¤ä»å˜—è©¦è§£ç¢¼ã€‚
        let rawJsonString;
        try {
            // å˜—è©¦è§£ç¢¼ (æ‡‰å°èˆŠç‰ˆæˆ–æŸäº› URL ç·¨ç¢¼)
            rawJsonString = decodeURIComponent(fileContent);
        } catch (e) {
            // å¦‚æœè§£ç¢¼å¤±æ•—ï¼Œå‰‡å‡è¨­å…§å®¹æœªç·¨ç¢¼
            rawJsonString = fileContent;
        }

        const result = loadImportedData(rawJsonString);
        if (result) {
            statusMessage.textContent = 'âœ… Script file successfully loaded from URL!';
            saveScriptToLocalStorage();
            renderScript(); // é‡æ–°æ¸²æŸ“
            return true;
        } else {
            statusMessage.textContent = 'âŒ URL file content is invalid or corrupted.';
            return false;
        }
    } catch (error) {
        statusMessage.textContent = 'âŒ URL file parsing failed, please check the format.';
            console.error('URL æª”æ¡ˆè§£æå¤±æ•—:', error);
        return false;
    }
}

/**
 * è¼”åŠ©å‡½å¼ï¼šæª¢æŸ¥çµ¦å®šçš„æ­¥é©Ÿé™£åˆ—æ˜¯å¦èˆ‡é è¨­çš„åˆå§‹æ­¥é©Ÿç›¸åŒï¼ˆå³åˆ¤æ–·æ˜¯å¦æœ‰ç·¨è¼¯éï¼‰ã€‚
 * @param {Array<Object>} steps - è¦æª¢æŸ¥çš„åŠ‡æœ¬æ­¥é©Ÿé™£åˆ—
 * @returns {boolean} - å¦‚æœåªæœ‰åˆå§‹æ­¥é©Ÿä¸”æœªè¢«ä¿®æ”¹ï¼Œå‰‡è¿”å› trueã€‚
 */
function isScriptDefault(steps) {
    if (!Array.isArray(steps) || steps.length !== 1) {
        return false;
    }
    const step = steps[0];
    const defaultStep = START_STEP_DEFINITION;
    
    // æª¢æŸ¥é¡å‹å’Œé—œéµåº§æ¨™æ˜¯å¦èˆ‡é è¨­å€¼åŒ¹é…
    return step.type === defaultStep.type &&
           step.lat === defaultStep.lat &&
           step.lng === defaultStep.lng &&
           !step.image && // ç¢ºä¿æ²’æœ‰åœ–ç‰‡
           !step.label; // ç¢ºä¿æ²’æœ‰é¡å¤–çš„æ¨™ç±¤
}

/**
 * é¡¯ç¤ºè¡Œç¨‹è¡çªæ¨¡æ…‹æ¡†
 */
function showConflictModal(scriptUrl) {
    conflictScriptUrl = scriptUrl;
    const overlay = document.getElementById('conflict-modal-overlay');
    const modal = document.getElementById('conflict-modal');
    
    // è¨­ç½®ç‹€æ…‹è¨Šæ¯
    document.getElementById('status-message').textContent = 'âš ï¸ Import conflict detected, please choose resolution.';

    overlay.classList.remove('opacity-0', 'pointer-events-none');
    modal.classList.remove('scale-90');
}

/**
 * éš±è—è¡Œç¨‹è¡çªæ¨¡æ…‹æ¡†
 */
function hideConflictModal() {
    const overlay = document.getElementById('conflict-modal-overlay');
    const modal = document.getElementById('conflict-modal');
    
    modal.classList.add('scale-90');
    overlay.classList.add('opacity-0');
    
    setTimeout(() => {
        overlay.classList.add('pointer-events-none');
        conflictScriptUrl = null;
    }, 300); 
}

/**
 * è™•ç†è¡çªè§£æ±ºæ–¹æ¡ˆ
 * @param {string} resolution - 'cancel', 'save_and_import', or 'overwrite'
 */
async function handleConflictResolution(resolution) { // <-- HTML onclick èª¿ç”¨
    hideConflictModal();
    const url = conflictScriptUrl;
    
    let needsRedirect = true; // é è¨­éœ€è¦é‡æ–°å°å‘

    switch (resolution) {
        case 'cancel':
            // 1. å–æ¶ˆåŒ¯å…¥ï¼Œç¹¼çºŒç·¨è¼¯æœ¬åœ°è¡Œç¨‹ (æœ¬åœ°è¡Œç¨‹å·²è¼‰å…¥ï¼Œä½†éœ€è¦æ¸²æŸ“)
            document.getElementById('status-message').textContent = 'Operation cancelled. Continuing with local script.';
            renderScript();
            // åœ¨ 'cancel' æƒ…æ³ä¸‹ï¼Œæœ¬åœ°è³‡æ–™å·²ç¶“åœ¨ checkAndLoadScriptFromURL è¼‰å…¥ï¼Œ
            // ä¸¦ä¸”å·²ç¶“ renderScript() æ¸²æŸ“å®Œæˆï¼Œæˆ‘å€‘åªéœ€ç§»é™¤ URL åƒæ•¸å³å¯ï¼Œ
            // ä¸éœ€è¦é‡æ–°è¼‰å…¥é é¢ (replaceState å³å¯)ã€‚
            needsRedirect = false; 
            break;
            
        case 'save_and_import':
            // 2. å„²å­˜ç·¨è¼¯ä¸­è¡Œç¨‹å¾Œå†åŒ¯å…¥æ–°è¡Œç¨‹
            document.getElementById('status-message').textContent = 'ğŸ’¾ Saving local script...';
            // éœé»˜åŒ¯å‡ºç•¶å‰æœ¬åœ°è…³æœ¬ (é€™æœƒè§¸ç™¼ä¸‹è¼‰)
            await exportScript(true); 
            
            // å»¶é²ä¸€ä¸‹ï¼Œç¢ºä¿ä¸‹è¼‰è§¸ç™¼ (ç€è¦½å™¨å¯èƒ½éœ€è¦ä¸€é»æ™‚é–“ä¾†è™•ç†ä¸‹è¼‰)
            await new Promise(resolve => setTimeout(resolve, 500));
            
            document.getElementById('status-message').textContent = 'ğŸŒ Importing new script...';
            await loadScriptFromUrl(url); // åŒ¯å…¥ URL è…³æœ¬ä¸¦è¦†è“‹æœ¬åœ°å„²å­˜
            // æ¥ä¸‹ä¾†å°‡åŸ·è¡Œé‡æ–°å°å‘
            break;
            
        case 'overwrite':
            // 3. è¦†è“‹æ‰ç·¨è¼¯ä¸­çš„è¡Œç¨‹ (ç›´æ¥åŒ¯å…¥æ–°è¡Œç¨‹)
            document.getElementById('status-message').textContent = 'ğŸŒ Overwriting local script, importing new script...';
            await loadScriptFromUrl(url); // åŒ¯å…¥ URL è…³æœ¬ä¸¦è¦†è“‹æœ¬åœ°å„²å­˜
            // æ¥ä¸‹ä¾†å°‡åŸ·è¡Œé‡æ–°å°å‘
            break;
    }
    
    // --- æ–°å¢ï¼šè™•ç† URL åƒæ•¸ç§»é™¤ ---
    // ç²å–ç•¶å‰ URL çš„æ‰€æœ‰åƒæ•¸
    const currentUrl = new URL(window.location.href);
    
    // æª¢æŸ¥æ˜¯å¦æœ‰ scriptUrl åƒæ•¸å­˜åœ¨
    if (currentUrl.searchParams.has('scriptUrl')) {
        // å¦‚æœé¸æ“‡äº† 'cancel'ï¼Œåªéœ€è¦æ›¿æ› URL ç‹€æ…‹ï¼Œä¸éœ€è¦é‡æ–°è¼‰å…¥é é¢
        if (resolution === 'cancel' && !needsRedirect) {
             currentUrl.searchParams.delete('scriptUrl');
             window.history.replaceState({}, document.title, currentUrl.toString());
             document.getElementById('status-message').textContent = 'Operation cancelled. URL parameter cleared.';
        } 
        // å¦å‰‡ï¼ˆ'save_and_import' æˆ– 'overwrite'ï¼‰ï¼Œéœ€è¦é‡æ–°å°å‘
        else if (needsRedirect) {
             currentUrl.searchParams.delete('scriptUrl');
             // ä½¿ç”¨ replace é¿å…æ­·å²ç´€éŒ„ä¸­ç•™ä¸‹å¸¶æœ‰åƒæ•¸çš„é é¢
             window.location.replace(currentUrl.toString()); 
             // é€™è£¡ä¸æœƒåŸ·è¡Œåˆ°
        }
    }
}


/**
 * æª¢æŸ¥ä¸¦å¾ URL åƒæ•¸æˆ– Local Storage è¼‰å…¥åŠ‡æœ¬ã€‚
 */
function checkAndLoadScriptFromURL() {
    const statusMessage = document.getElementById('status-message');
    
    // 1. æª¢æŸ¥ Local Storage ä¸¦è¼‰å…¥ (ç„¡è«–æ˜¯å¦ç‚º default)
    const storedJson = getLocalStorage(STORAGE_KEY);
    let hasLocalNonDefaultScript = false;
    
    if (storedJson) {
        try {
            const loadedSteps = JSON.parse(storedJson); 
            
            if (Array.isArray(loadedSteps) && loadedSteps.length > 0) {
                // è¼‰å…¥æœ¬åœ°æ­¥é©Ÿåˆ° scriptSteps
                scriptSteps = optimizeLoadedScript(loadedSteps);
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºéé è¨­è…³æœ¬
                if (!isScriptDefault(scriptSteps)) {
                    hasLocalNonDefaultScript = true;
                    document.getElementById('status-message').textContent = `ğŸ“¥ Script loaded from local storage.`;
                }
            }
        } catch (error) {
            console.error('Failed to parse local stored script:', error);
        }
    }

    // 2. æª¢æŸ¥ URL åƒæ•¸
    const urlParams = new URLSearchParams(window.location.search);
    const scriptUrl = urlParams.get('scriptUrl');

    if (scriptUrl) {
        // ç™¼ç¾ URL åƒæ•¸
        if (hasLocalNonDefaultScript) {
            // 2.1. è¡çªï¼šæœ‰ URL ä¸”æœ¬åœ°éé è¨­
            statusMessage.textContent = 'ğŸ” Conflict detected...';
            showConflictModal(scriptUrl);
            return; 
        } else {
            // 2.2. ç„¡è¡çªï¼šæœ‰ URLï¼Œæœ¬åœ°æ˜¯é è¨­æˆ–ç©º
            statusMessage.textContent = 'ğŸ” URL script parameter found, attempting to load...';
            // ç”±æ–¼ DOMContentLoaded å·²ç¶“å®Œæˆï¼Œæˆ‘å€‘å¯ä»¥ç›´æ¥å‘¼å« async å‡½å¼ä¸¦å¿½ç•¥å…¶çµæœ
            loadScriptFromUrl(scriptUrl)
                .then(() => {
                    // ç¢ºä¿éåŒæ­¥è¼‰å…¥å®Œæˆå¾Œï¼Œç§»é™¤ URL åƒæ•¸
                    const currentUrl = new URL(window.location.href);
                    if (currentUrl.searchParams.has('scriptUrl')) {
                         currentUrl.searchParams.delete('scriptUrl');
                         // ä½¿ç”¨ replace é¿å…æ­·å²ç´€éŒ„ä¸­ç•™ä¸‹å¸¶æœ‰åƒæ•¸çš„é é¢
                         window.location.replace(currentUrl.toString()); 
                    }
                });
            return; // çµæŸï¼Œè®“ URL è¼‰å…¥å»è™•ç†å¾ŒçºŒçš„æ¸²æŸ“å’Œå„²å­˜
        }
    }
    
    // 3. æ—¢ç„¡ URL åƒæ•¸ï¼Œæœ¬åœ°è…³æœ¬ä¹Ÿå·²è™•ç†
    if (!hasLocalNonDefaultScript) {
         // å¦‚æœæœ¬åœ°è…³æœ¬æ˜¯ defaultï¼Œä¸”æ²’æœ‰ URL åƒæ•¸ï¼Œå‰‡è¨­ç½®åˆå§‹æç¤º
        document.getElementById('status-message').textContent = 'ğŸ’¡ Welcome! Start adding your first step.';
    }

    // æœ€å¾Œç¢ºä¿æ¸²æŸ“ (éåŒæ­¥è¼‰å…¥è·¯å¾‘æœƒè‡ªå·±å‘¼å« renderScript)
    // é€™è£¡çš„ renderScript ç¢ºä¿äº†åœ¨æ²’æœ‰ URL ä¸”è¼‰å…¥æœ¬åœ°/ä½¿ç”¨é è¨­æ™‚ï¼ŒUI æ˜¯æœ€æ–°çš„
    renderScript(); 
}


// =================================================================
// 5. åŠ‡æœ¬ç·¨è¼¯/æ“ä½œè¼”åŠ©å‡½æ•¸ (Focus é‚è¼¯å·²ç§»é™¤)
// =================================================================

/**
 * è¼”åŠ©å‡½å¼ï¼šæ‰¾åˆ°ä¸Šä¸€å€‹è¨­å®šä½ç½®çš„æ­¥é©Ÿçš„ä½ç½®
 */
function getPreviousPosition(currentIndex) {
    if (currentIndex <= 0) {
        return { lat: null, lng: null };
    }
    
    for (let i = currentIndex - 1; i >= 0; i--) {
        const step = scriptSteps[i];
        if (step.type === 'start' || step.type === 'goto') {
            return { lat: step.lat, lng: step.lng };
        }
    }
    return { lat: scriptSteps[0].lat, lng: scriptSteps[0].lng };
}

/**
 * è¼”åŠ©å‡½å¼ï¼šæ‰¾åˆ°ä¸Šä¸€å€‹è¨­å®šä½ç½®çš„æ­¥é©Ÿçš„ icon
 * @param {number} insertionIndex - è¦æ’å…¥çš„ç´¢å¼•ä½ç½®
 * @returns {string} - ä¸Šä¸€å€‹ goto æ­¥é©Ÿçš„ icon åç¨±ï¼Œæˆ–é è¨­å€¼ 'walk'
 */
function getLastGotoIcon(insertionIndex) {
    // Search backward from the step immediately preceding the insertion point
    for (let i = insertionIndex - 1; i >= 0; i--) {
        const step = scriptSteps[i];
        if (step.type === 'goto' && step.icon) {
            return step.icon;
        }
    }
    // Fallback: If no preceding goto step with an icon is found, use 'walk' 
    return 'walk'; 
}

/**
 * åˆªé™¤æ­¥é©Ÿ (ä¸èƒ½åˆªé™¤ç¬¬ä¸€å€‹ 'start' æ­¥é©Ÿ)
 */
function deleteStep(index) { // <-- HTML onclick èª¿ç”¨
    if (index === 0) return; // ä¿è­·ç¬¬ä¸€å€‹æ­¥é©Ÿ
    scriptSteps.splice(index, 1);
    
    // ç§»é™¤ Focus é‚è¼¯ï¼Œåƒ…é‡æ–°æ¸²æŸ“
    renderScript(); 
    saveScriptToLocalStorage(); // <--- å„²å­˜
}

/**
 * ç§»å‹•æ­¥é©Ÿä½ç½®
 */
function moveStep(index, direction) { // <-- HTML onclick èª¿ç”¨
    if (index === 0) return; // ä¿è­·ç¬¬ä¸€å€‹æ­¥é©Ÿ
    const newIndex = index + direction;
    if (newIndex < 1 || newIndex >= scriptSteps.length) return; // ä¸èƒ½ç§»å‡ºç¯„åœ (ç‰¹åˆ¥æ˜¯ä¸èƒ½ç§»åˆ° index 0)
    
    // é€²è¡Œäº¤æ›
    [scriptSteps[index], scriptSteps[newIndex]] = [scriptSteps[newIndex], scriptSteps[index]];
    
    // ç§»é™¤ Focus é‚è¼¯ï¼Œåƒ…é‡æ–°æ¸²æŸ“
    renderScript();
    saveScriptToLocalStorage(); // <--- å„²å­˜
}

/**
 * æ›´æ–°æ­¥é©Ÿè³‡æ–™
 */
function updateStep(index, field, value) { // <-- HTML onchange èª¿ç”¨
    
    let needsRender = false; // è¿½è¹¤æ˜¯å¦éœ€è¦å®Œæ•´é‡å»º

    if (field === 'coords') {
        // è™•ç† 'coords' (ç·¯åº¦, ç¶“åº¦) è¯åˆè¼¸å…¥, é©ç”¨æ–¼ 'start' å’Œ 'goto'
        const parts = String(value).split(',').map(s => s.trim());
        const lat = parseFloat(parts[0]);
        const lng = parseFloat(parts[1]);

        if (!isNaN(lat) && !isNaN(lng) && parts.length === 2) {
            
            // --- GPS Comparison/Validation ---
            // åƒ…å° goto æ­¥é©Ÿé€²è¡Œæª¢æŸ¥ (index > 0)
            if (index > 0 && scriptSteps[index].type === 'goto') {
                const prevPos = getPreviousPosition(index);
                
                // ä½¿ç”¨ä¸€å€‹å°å®¹å¿å€¼é€²è¡Œæµ®é»æ•¸æ¯”è¼ƒ
                const EPSILON = 0.000001; 
                const isSameLat = Math.abs(lat - prevPos.lat) < EPSILON;
                const isSameLng = Math.abs(lng - prevPos.lng) < EPSILON;
                
                if (isSameLat && isSameLng) {
                    console.error("GPS Error: New position is the same as the previous known position. Aborting update.");
                    document.getElementById('status-message').textContent = 'âš ï¸ Error: New position is the same as the previous known position. Move will be ignored.';
                    setTimeout(() => { document.getElementById('status-message').textContent = 'Ready'; }, 3000);
                    return; 
                }
            }
            // --- End Validation ---

            scriptSteps[index].lat = lat;
            scriptSteps[index].lng = lng;
        } else {
            console.error("Invalid coordinate format. Please use 'lat, lng'.");
        }
    } else if (field === 'lat' || field === 'lng' || field === 'sec') {
        // è™•ç†å–®ç¨çš„æ•¸å­—æ¬„ä½ (æ­¤é‚è¼¯ç¾åœ¨ä¸»è¦ç”¨æ–¼ 'sec')
        scriptSteps[index][field] = parseFloat(value) || 0;
    } else {
        // è™•ç†æ–‡å­—æ¬„ä½ (label, words, icon)
        scriptSteps[index][field] = value;
    }
    
    saveScriptToLocalStorage(); // <--- å„²å­˜

    // å¦‚æœæ˜¯ icon æ”¹è®Šæˆ– Dayoff ç›¸é—œï¼Œéœ€è¦é‡å»ºä»¥æ›´æ–°æ­¥é©Ÿåœ–æ¨™å’Œæ—¥æ•¸
    if (field === 'icon' || scriptSteps[index].type === 'dayoff') {
        needsRender = true;
    }

    if (needsRender) {
         // ç§»é™¤ Focus é‚è¼¯ï¼Œåƒ…é‡æ–°æ¸²æŸ“
         renderScript(); 
    }
    // å°æ–¼ç°¡å–®çš„è³‡æ–™æ”¹è®Š (éçµæ§‹æ€§æˆ–éè¦–è¦ºç›¸é—œ)ï¼Œç„¡éœ€ä»»ä½•é¡å¤–æ“ä½œ
}

/**
 * æ–°å¢æ­¥é©Ÿåˆ°åŠ‡æœ¬
 * @param {string} type - æ­¥é©Ÿé¡å‹
 * @param {number} targetIndex - è¦æ’å…¥çš„ç´¢å¼•ä½ç½® (å¯é¸ï¼Œé è¨­ -1 è¡¨ç¤ºé™„åŠ åˆ°æœ«å°¾)
 */
function addStep(type, targetIndex = -1) { // <-- HTML onclick èª¿ç”¨
    // æ­¥é©Ÿ 1: å°‡ label é è¨­ç‚ºç©ºå­—ä¸²ï¼Œä»¥ä¾¿é¡¯ç¤º placeholder
    const newStep = { label: '' }; 

    // è™•ç†æ’å…¥ç´¢å¼•
    let insertionIndex = parseInt(targetIndex, 10);
    
    // å¦‚æœ targetIndex ç„¡æ•ˆæˆ–æœªæä¾›ï¼Œå‰‡é™„åŠ åˆ°æœ«å°¾
    if (insertionIndex === -1 || isNaN(insertionIndex)) {
        insertionIndex = scriptSteps.length;
    }

    switch (type) {
        case 'goto':
            // ç²å–ä¸Šä¸€å€‹ goto æ­¥é©Ÿçš„ icon
            const defaultIcon = getLastGotoIcon(insertionIndex); 
            // GPS åº§æ¨™é è¨­ç‚º nullï¼Œä»¥ä¾¿åœ¨æ¸²æŸ“æ™‚é¡¯ç¤º placeholder
            Object.assign(newStep, { 
                type: 'goto', 
                lat: null, 
                lng: null, 
                icon: defaultIcon, // <-- ä½¿ç”¨ä¸Šä¸€å€‹ icon ä½œç‚ºé è¨­å€¼
                words: '' 
            });
            break;
        case 'activity':
            // æ–°å¢ Activity å‹•ä½œï¼Œé è¨­ç„¡ icon ä¸”ç­‰å¾… 1 ç§’
            Object.assign(newStep, { type: 'activity', icon: '', sec: 1 });
            break;
        case 'show':
            // ä¿®æ­£: æ–°å¢ sec æ¬„ä½ï¼Œé è¨­ä½¿ç”¨ç¨ç«‹ç…§ç‰‡æ™‚é•· 2.5 ç§’
            Object.assign(newStep, { type: 'show', words: '', sec: PHOTO_STANDALONE_DURATION }); 
            break;
        case 'dayoff':
            Object.assign(newStep, { type: 'dayoff', sec: 5 }); // é è¨­ä¼‘æ¯ 5 ç§’
            break;
    }
    
    
    scriptSteps.splice(insertionIndex, 0, newStep);

    // è™•ç†æ’å…¥å¾Œçš„ç‹€æ…‹å’Œæ»¾å‹•
    if (targetIndex !== -1) {
        // é€™æ˜¯è¡Œå…§æ’å…¥ï¼Œå¿…é ˆæ¸…é™¤éŒ¨é»ç‹€æ…‹
        insertAnchorIndex = -1; // ç›´æ¥æ¸…é™¤ï¼Œé¿å…å¤šé¤˜çš„ clearInsertAnchor() æ¸²æŸ“
    } 

    // ç§»é™¤ Focus é‚è¼¯ï¼Œåƒ…é‡æ–°æ¸²æŸ“
    renderScript();
    saveScriptToLocalStorage(); // <--- å„²å­˜
}


/**
 * è¨­å®šæ’å…¥éŒ¨é» (é»æ“Šè™›ç·šæ¡†)
 */
function setInsertAnchor(index) {
    // ç¢ºä¿ index æ˜¯æ•¸å­—
    const targetIndex = parseInt(index, 10); 
    // è¨­å®šè¦é¡¯ç¤º action buttons çš„ç´¢å¼•
    insertAnchorIndex = targetIndex;
    renderScript();
    
    // æ»¾å‹•åˆ° action panel è‡ªèº« (ä½¿ç”¨ timeout ç¢ºä¿ DOM æ¸²æŸ“å®Œæˆ)
    setTimeout(() => {
        const anchorElement = document.querySelector(`.insert-anchor-panel[data-index="${targetIndex}"]`);
        if (anchorElement) {
            // ä½¿ç”¨ scrollIntoView ç¢ºä¿ action panel å¯è¦‹
            anchorElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); 
        }
    }, 50);
}

/**
 * å–æ¶ˆæ’å…¥éŒ¨é» (é»æ“Šå–æ¶ˆæŒ‰éˆ•)
 */
function clearInsertAnchor() {
    insertAnchorIndex = -1;
    renderScript();
}

/**
 * è™•ç†æª”æ¡ˆä¸Šå‚³äº‹ä»¶ï¼Œå£“ç¸®åœ–ç‰‡ä¸¦è½‰æ›ç‚º Base64
 * @param {Event} event - change event
 * @param {number} index - åŠ‡æœ¬æ­¥é©Ÿç´¢å¼•
 */
function handleImageUpload(event, index) {
    const statusMessage = document.getElementById('status-message');
    const file = event.target.files[0];

    // æ¸…ç©º inputï¼Œä»¥ä¾¿å¯ä»¥é€£çºŒä¸Šå‚³åŒä¸€å€‹æª”æ¡ˆ
    event.target.value = null; 

    if (!file || !file.type.startsWith('image/')) {
        statusMessage.textContent = 'âš ï¸ Please select a valid image file.';
        return;
    }

    statusMessage.textContent = 'Uploading image, compressing...';

    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            const maxDimension = MAX_LONG_SIDE; // ä½¿ç”¨æ–°çš„é•·é‚Šä¸Šé™å¸¸æ•¸

            // --- æ–°çš„å£“ç¸®é‚è¼¯: å°‡é•·é‚Šå£“ç¸®åˆ° maxDimension ---
            if (width > maxDimension || height > maxDimension) {
                if (width > height) {
                    // æ©«å‘åœ–ç‰‡æˆ–æ­£æ–¹å½¢åœ–ç‰‡ (å¯¬åº¦è¼ƒé•·æˆ–ç›¸ç­‰)
                    const ratio = maxDimension / width;
                    width = maxDimension;
                    height = Math.round(height * ratio);
                } else {
                    // ç¸±å‘åœ–ç‰‡ (é«˜åº¦è¼ƒé•·)
                    const ratio = maxDimension / height;
                    height = maxDimension;
                    width = Math.round(width * ratio);
                }
            }
            // --- çµæŸæ–°çš„å£“ç¸®é‚è¼¯ ---

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // å£“ç¸®æˆ JPEG æ ¼å¼ (å¯ä»¥æ¸›å°‘ Base64 å­—ä¸²é•·åº¦)
            const base64String = canvas.toDataURL('image/jpeg', 0.8); 

            // æ›´æ–°æ­¥é©Ÿè³‡æ–™
            scriptSteps[index].image = base64String;
            saveScriptToLocalStorage();
            renderScript();
            
            statusMessage.textContent = 'âœ… Photo compressed and added to step.';
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

/**
 * åˆªé™¤æ­¥é©Ÿä¸­çš„ç…§ç‰‡
 * @param {number} index - åŠ‡æœ¬æ­¥é©Ÿç´¢å¼•
 */
function removeImage(index) {
    scriptSteps[index].image = undefined;
    saveScriptToLocalStorage();
    renderScript();
    document.getElementById('status-message').textContent = 'ğŸ—‘ï¸ Photo removed.';
}


// =================================================================
// 6. å‡çµåµæ¸¬èˆ‡æ’­æ”¾æ§åˆ¶è¼”åŠ©å‡½æ•¸ (æ–°å¢)
// =================================================================

/**
 * é–‹å§‹å‡çµåµæ¸¬è¨ˆæ™‚å™¨
 * @param {number} stepIndex - ç•¶å‰æ­¥é©Ÿçš„ç´¢å¼•
 * @param {number} timeoutSec - è¶…æ™‚æ™‚é–“ï¼ˆç§’ï¼‰
 */
function startFreezeDetection(stepIndex, timeoutSec) {
    clearFreezeDetection(); // ç¢ºä¿æ²’æœ‰èˆŠçš„è¨ˆæ™‚å™¨
    
    freezeTimeoutId = setTimeout(() => {
        // è¶…æ™‚è§¸ç™¼
        const statusMessage = document.getElementById('status-message');
        console.error(`Freeze Detected: Step ${stepIndex} exceeded ${timeoutSec} seconds.`);
        // Note: stopScript() will clear the freezeTimeoutId.
        stopScript(); 
        statusMessage.textContent = `âŒ Error: Step ${stepIndex} execution exceeded ${timeoutSec}s, automatically stopped.`;
    }, timeoutSec * 1000);
}

/**
 * æ¸…é™¤å‡çµåµæ¸¬è¨ˆæ™‚å™¨
 */
function clearFreezeDetection() {
    if (freezeTimeoutId) {
        clearTimeout(freezeTimeoutId);
        freezeTimeoutId = null;
    }
}


// =================================================================
// 7. æ ¸å¿ƒå‹•ç•«èˆ‡æµç¨‹æ§åˆ¶å‡½æ•¸ (åŸæœ‰ä»£ç¢¼)
// =================================================================

// è·é›¢è¨ˆç®— (Haversine å…¬å¼ï¼Œå›å‚³å…¬å°º)
function distance(p1,p2){
  const R=6371000; const toRad=x=>x*Math.PI/180;
  const dLat=toRad(p2[0]-p1[0]); const dLon=toRad(p2[1]-p1[1]);
  const lat1=toRad(p1[0]),lat2=toRad(p2[0]);
  const a=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

function start(gps){ marker.setLatLng(gps); }
function setIcon(name){ marker.setIcon(icons[name]); }

/**
 * è¼”åŠ©å‡½å¼ï¼šæ ¹æ“šå­—ä¸²é•·åº¦è¨ˆç®—æ™‚é–“ä¹˜æ•¸
 * ä¸­æ–‡å­—ç¬¦ (UTF-8) é€šå¸¸ä½” 3 bytesã€‚
 * æ¯ 16 bytes (ç´„ 5-6 å€‹ä¸­æ–‡å­—) å¢åŠ  1.0 ç§’ã€‚
 * @param {string} text - å¾…è¨ˆç®—çš„æ–‡å­—
 * @returns {number} - é¡å¤–ç­‰å¾…æ™‚é–“ (ç§’)
 */
function getDurationMultiplier(text) { // <-- éœ€æ±‚ 4: æ–°å¢
    if (!text || text.trim() === '') return 0;
    
    // 1. è¨ˆç®—æ–‡å­—çš„ UTF-8 bytes é•·åº¦
    const encoder = new TextEncoder();
    const byteLength = encoder.encode(text).length;
    
    // 2. åŸºç¤é–±è®€æ™‚é–“ç‚º 1.0 ç§’ï¼Œæ¯è¶…é 16 bytes å¢åŠ  1.0 ç§’ã€‚
    // Math.floor(byteLength / 16) = è¶…é 16 bytes çš„å¡Šæ•¸
    const multiplier = Math.floor(byteLength / 16);
    
    // Base 1.0s + multiplier * 1.0s
    return 1.0 + multiplier; 
}


/**
 * é¡¯ç¤ºè¨Šæ¯å½ˆå‡ºè¦–çª— (Popup)
 * ä¿®æ­£ï¼šç§»é™¤å…§å»ºçš„ 1 ç§’é—œé–‰è¨ˆæ™‚å™¨ï¼Œè®“èª¿ç”¨è€…æ§åˆ¶é—œé–‰æ™‚é–“ã€‚
 */
function show(words){
  // ç¢ºä¿åœ¨æ‰“é–‹æ–°çš„ä¹‹å‰é—œé–‰ç¾æœ‰çš„
  if(popup) mapInstance.closePopup(popup); 
  
  // å‹•æ…‹èª¿æ•´ popupAnchor (ç¶­æŒä¸Š/ä¸‹å½ˆçš„é‚è¼¯ï¼Œä½† Leaflet æœƒè‡ªå‹•å¹³ç§»ä»¥é¿å…åˆ‡é‚Š)
  const isMobileVertical = window.innerWidth <= 767;
  let anchor = [0, -iconSize / 2]; // é è¨­ (å¾€ä¸Šå½ˆ)
  
  if (isMobileVertical) {
      try {
        const mapContainerRect = document.getElementById('map').getBoundingClientRect();
        const markerPoint = mapInstance.latLngToContainerPoint(marker.getLatLng());
        
        // å¦‚æœæ¨™è¨˜çš„ Y åº§æ¨™åœ¨åœ°åœ–å®¹å™¨çš„ 40% é«˜åº¦ä»¥å…§ï¼Œå°±å‘ä¸‹å½ˆå‡º
        if (markerPoint.y < mapContainerRect.height * 0.4) {
            // å¼·åˆ¶å¾€ä¸‹å½ˆå‡º (Y åº§æ¨™ç‚ºæ­£å€¼ + é¡å¤–ç·©è¡ 25px)
            anchor = [0, iconSize / 2 + 25]; 
        }
      } catch (e) {
          // å®¹éŒ¯è™•ç†ï¼Œä½¿ç”¨é è¨­ anchor
          anchor = [0, -iconSize / 2]; 
      }
  }
  
  popup = L.popup({
      closeButton:false, 
      autoClose:false, // ä¿®æ­£: è¨­ç‚º falseï¼Œç”±ç¨‹å¼ç¢¼æ‰‹å‹•é—œé–‰
      className: 'custom-large-popup',
      // è¨­å®šè¶³å¤ çš„é‚Šè·ï¼Œé˜²æ­¢ Pop-up è¢«é‚Šç·£åˆ‡åˆ°
      autoPanPadding: L.point(50, 50), 
      offset: anchor // ä½¿ç”¨è¨ˆç®—å‡ºçš„éŒ¨é»
    })
    .setLatLng(marker.getLatLng())
    .setContent(words)
    .openOn(mapInstance);
    
  // ä¿®æ­£: ç§»é™¤é€™è¡Œï¼Œç”± executeScript è² è²¬è¨ˆæ™‚å¾Œé—œé–‰
  // setTimeout(()=>{ mapInstance.closePopup(popup); popup=null; }, 1000); 
}

/**
 * è¼”åŠ©å‡½å¼ï¼šæ‰‹å‹•éš±è—å½ˆå‡ºè¦–çª—
 */
function hidePopup() {
    if (popup) {
        mapInstance.closePopup(popup);
        popup = null;
    }
}


/**
 * é–‹å•Ÿç…§ç‰‡çš„æ¨¡æ…‹æ¡† (éé˜»å¡)
 * @param {string} base64Image - Base64 åœ–ç‰‡å­—ä¸²
 * @param {string} [message=null] - é¡å¤–é¡¯ç¤ºåœ¨åœ–ç‰‡ä¸Šçš„è¨Šæ¯ (NEW: æ–°å¢åƒæ•¸)
 */
function openImageModal(base64Image, message = null) { // <-- ä¿®æ­£ 1: æ–°å¢ message åƒæ•¸
    if (!base64Image) return;
    
    // ç¢ºä¿åªå‰µå»ºä¸€æ¬¡æ¨¡æ…‹æ¡†çµæ§‹
    if (!imageModal) {
        imageModal = document.createElement('div');
        imageModal.id = 'image-modal';
        // å…è¨±é»æ“ŠèƒŒæ™¯è·³é
        imageModal.className = 'fixed inset-0 bg-black bg-opacity-75 z-[2000] flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none';
        imageModal.innerHTML = `
            <!-- ä½¿ç”¨ custom max-width ç¢ºä¿èƒ½å®¹ç´ 400px é•·é‚Šåœ–ç‰‡ + padding -->
            <div id="image-modal-content" class="bg-white p-4 rounded-lg shadow-2xl max-w-[450px] mx-4 transform scale-90 transition-transform duration-300" 
                 onclick="event.stopPropagation()">
                <!-- ä¿®æ­£ 2: è¨Šæ¯é¡¯ç¤ºå€ -->
                <div id="modal-message" class="text-xl font-bold text-gray-800 text-center mb-3 p-2 bg-gray-100 rounded-lg hidden"></div>
                <!-- ç¢ºä¿åœ–ç‰‡å¯¬åº¦æœ€å¤§åŒ–ï¼Œé«˜åº¦è‡ªé©æ‡‰ï¼Œä¸¦ä½¿ç”¨å£“ç¸®å¾Œçš„åœ–ç‰‡å¤§å° -->
                <img id="modal-image" class="w-full h-auto rounded-lg mb-2 max-w-[${MAX_LONG_SIDE}px] mx-auto" alt="Journey Photo">
                <p class="text-center text-sm text-gray-600 font-semibold mb-2">ğŸ“¸ Journey Photo</p>
                <!-- æ–°å¢ SKIP æŒ‰éˆ• -->
                <button onclick="skipPhoto()" id="skip-photo-button" class="w-full bg-red-500 text-white font-bold py-2 rounded-lg hover:bg-red-600 transition duration-150">
                    SKIP
                </button>
            </div>
        `;
        document.body.appendChild(imageModal);
        
        // è®“é»æ“ŠèƒŒæ™¯ä¹Ÿèƒ½è·³é
        imageModal.onclick = skipPhoto; 
    }
    
    const imageElement = document.getElementById('modal-image');
    const modalContent = document.getElementById('image-modal-content');
    const messageElement = document.getElementById('modal-message'); // <-- å–å¾—è¨Šæ¯å…ƒç´ 

    // è¨­ç½®åœ–ç‰‡æº
    imageElement.src = base64Image;
    
    // è¨­ç½®è¨Šæ¯å…§å®¹ (NEW: è™•ç†è¨Šæ¯é¡¯ç¤º)
    if (message && message.trim() !== '') {
        messageElement.textContent = message;
        messageElement.classList.remove('hidden');
    } else {
        messageElement.textContent = '';
        messageElement.classList.add('hidden');
    }
    
    // é¡¯ç¤ºæ¨¡æ…‹æ¡† (å¸¶æœ‰å‹•ç•«)
    imageModal.classList.remove('opacity-0', 'pointer-events-none');
    modalContent.classList.remove('scale-90');
    
    // é€™è£¡æ²’æœ‰ resolveï¼Œå› ç‚ºæ˜¯å³æ™‚é–‹å•Ÿ (éé˜»å¡)
}


/**
 * é—œé–‰ç…§ç‰‡çš„æ¨¡æ…‹æ¡†
 */
function closeImageModal() {
    if (!imageModal) return;
    
    const modalContent = document.getElementById('image-modal-content');
    
    // éš±è—æ¨¡æ…‹æ¡† (å¸¶æœ‰å‹•ç•«)
    modalContent.classList.add('scale-90');
    imageModal.classList.add('opacity-0');
    
    // ä¿®æ­£: é—œé–‰æ™‚ä¹Ÿæ¸…ç©º messageï¼Œé¿å…ä¸‹æ¬¡é–ƒçˆ
    const messageElement = document.getElementById('modal-message');
    if (messageElement) {
        messageElement.textContent = '';
        messageElement.classList.add('hidden');
    }
    
    setTimeout(() => {
        imageModal.classList.add('pointer-events-none');
    }, 300); // åŒ¹é… CSS transition duration
}

/**
 * é»æ“Šè·³éæŒ‰éˆ•ï¼Œå¼·åˆ¶çµæŸç…§ç‰‡æ’­æ”¾çš„ç­‰å¾…ã€‚
 */
function skipPhoto() {
    if (skipPhotoResolve) {
        // 1. é—œé–‰æ¨¡æ…‹æ¡†
        closeImageModal();
        // 2. åœæ­¢ç•¶å‰ wait/pause
        if (currentWaitTimeoutId) {
            clearTimeout(currentWaitTimeoutId);
            currentWaitRemainingTime = 0;
            currentWaitTimeoutId = null;
        }
        // 3. è§£æ±º playStepMedia ä¸­çš„ wait Promise
        if (currentWaitResolve) {
            currentWaitResolve();
        }
        // 4. è§£æ±º playStepMedia ä¸­çš„ä¸»è¦ Pause Promise (å¦‚æœ still paused)
        if (pauseResolve) {
            pauseResolve();
        }

        const resolveFn = skipPhotoResolve;
        skipPhotoResolve = null; // æ¸…é™¤ç‹€æ…‹
        document.getElementById('status-message').textContent = 'ğŸ“¸ Photo skipped.';
        resolveFn(); // è§£æ±º playStepMedia çš„ä¸» Promise
    }
}

/**
 * æ’­æ”¾ç¨ç«‹ç…§ç‰‡ä¸¦ç­‰å¾… N ç§’
 * @param {string} base64Image - Base64 åœ–ç‰‡å­—ä¸²
 * @param {number} [duration=PHOTO_STANDALONE_DURATION] - é¡¯ç¤ºç§’æ•¸
 * @param {string} [message=null] - é¡å¤–é¡¯ç¤ºåœ¨åœ–ç‰‡ä¸Šçš„è¨Šæ¯ (NEW: æ–°å¢åƒæ•¸)
 * @returns {Promise<void>} - ç­‰å¾… duration ç§’å¾Œé—œé–‰
 */
function playStepMedia(base64Image, duration = PHOTO_STANDALONE_DURATION, message = null) { // <-- ä¿®æ­£ 3: æ–°å¢ message åƒæ•¸
    if (!base64Image) return Promise.resolve();
    
    return new Promise(async (resolve) => {
        // è¨­å®šä¸» Promise Resolver
        skipPhotoResolve = resolve; 

        // 1. é–‹å•Ÿæ¨¡æ…‹æ¡† (å‚³å…¥è¨Šæ¯)
        openImageModal(base64Image, message); 
        
        // 2. ç­‰å¾… N ç§’ (æ”¯æ´æš«åœ)
        await wait(duration); // <--- ä½¿ç”¨å‚³å…¥çš„ duration
        await getPausePromise(); 
        
        // 3. é—œé–‰æ¨¡æ…‹æ¡† (å¦‚æœä¸æ˜¯è¢« skipPhoto é—œé–‰)
        if (skipPhotoResolve) {
            closeImageModal();
            skipPhotoResolve = null; // æ¸…é™¤ç‹€æ…‹
            resolve();
        }
    });
}


/**
 * ç²å–æš«åœ Promiseã€‚å¦‚æœå·²æš«åœï¼Œå‰‡é˜»å¡åŸ·è¡Œã€‚
 */
function getPausePromise() {
    if (isPaused) {
        return new Promise(resolve => {
            pauseResolve = resolve;
        });
    }
    return Promise.resolve();
}

/**
 * æš«åœ/ç¹¼çºŒ æ’­æ”¾
 */
function pauseToggle() { // <-- HTML onclick èª¿ç”¨
    const btn = document.getElementById('pause-resume-button');
    if (!isScriptRunning) return;

    isPaused = !isPaused;
    btn.title = isPaused ? 'Resume Playback' : 'Pause Playback';
    
    // æ ¹æ“šç‹€æ…‹æ›´æ–°æŒ‰éˆ•æ–‡å­—
    btn.querySelector('span').textContent = isPaused ? 'â–¶ï¸ RESUME' : 'â¸ï¸ PAUSE';
    
    // Resume Logic: å¾æš«åœåˆ‡æ›åˆ°ç¹¼çºŒ
    if (!isPaused && pauseResolve) {
        pauseResolve(); // ç¹¼çºŒ executeScript loop
        pauseResolve = null;

        // Resume current WAIT animation
        if (currentWaitResolve && currentWaitRemainingTime > 0) {
            currentWaitStartTime = Date.now();
            currentWaitTimeoutId = setTimeout(currentWaitResolve, currentWaitRemainingTime);
        }
    } 
    // Pause Logic: å¾é‹è¡Œåˆ‡æ›åˆ°æš«åœ
    else if (isPaused) {
        // Pause current WAIT animation (ç«‹å³åœæ­¢è¨ˆæ™‚å™¨)
        if (currentWaitTimeoutId) {
            clearTimeout(currentWaitTimeoutId);
            currentWaitRemainingTime -= (Date.now() - currentWaitStartTime);
            currentWaitTimeoutId = null;
        }
        
        // Note: 'goto' animation is NOT paused, it will run to completion and then stop due to `getPausePromise()` check in the loop.
    }
}

/**
 * åœæ­¢æ’­æ”¾
 */
function stopScript() {
    if (!isScriptRunning) return;

    isScriptRunning = false;
    isPaused = false;
    
    // åœæ­¢æ‰€æœ‰ç­‰å¾…/æš«åœ
    if (pauseResolve) pauseResolve();
    if (currentWaitTimeoutId) clearTimeout(currentWaitTimeoutId);
    clearFreezeDetection(); // <-- æ¸…é™¤å‡çµåµæ¸¬è¨ˆæ™‚å™¨
    
    // æ¸…é™¤æ˜Ÿè™Ÿæ¨™è¨˜ (éœ€æ±‚ 3)
    if (targetMarker) {
        mapInstance.removeLayer(targetMarker);
        targetMarker = null;
    }
    
    // æ¸…é™¤ç‹€æ…‹å’ŒUI
    document.getElementById('play-button').disabled = false;
    document.getElementById('pause-resume-button').disabled = true;
    document.getElementById('stop-button').disabled = true;

    document.getElementById('play-button').classList.add('bg-indigo-500', 'hover:bg-indigo-700');
    document.getElementById('play-button').classList.remove('bg-gray-400');
    
    document.getElementById('pause-resume-button').querySelector('span').textContent = 'â¸ï¸ PAUSE/RESUME';
    document.getElementById('status-message').textContent = 'â—¼ï¸ Playback stopped.';
    
    // æ¸…é™¤æ‰€æœ‰æ­¥é©Ÿé«˜äº® (focused-step å·²ç§»é™¤)
    document.querySelectorAll('[id^="step-"]').forEach(el => el.classList.remove('ring-2', 'ring-indigo-500', 'shadow-md'));

    // é—œé–‰åœ–ç‰‡æ¨¡æ…‹æ¡†
    closeImageModal();
    // ä¿®æ­£ï¼šåœæ­¢æ™‚ä¹Ÿè¦é—œé–‰å½ˆå‡ºè¦–çª—
    hidePopup(); 
    
    // NEW: Update layout back to editing mode
    updateMobileLayout();
}


// å‡½å¼: ç­‰å¾… (Promise ç‰ˆæœ¬, æ”¯æ´æš«åœ)
function wait(sec){
    return new Promise(resolve => {
        // æ¸…é™¤ä¸Šä¸€å€‹ wait çš„ç‹€æ…‹
        currentWaitResolve = resolve;
        currentWaitStartTime = Date.now();
        currentWaitRemainingTime = sec * 1000;

        function resolveAndClear() {
             currentWaitResolve = null;
             currentWaitTimeoutId = null;
             resolve();
        }

        currentWaitTimeoutId = setTimeout(resolveAndClear, currentWaitRemainingTime);
    });
}

/**
 * ç•«é¢è®Šæš—è®Šäº®å‹•ç•« (æ¨¡æ“¬éå¤œæ•ˆæœ)
 * @param {number} sec - ç­‰å¾…ç§’æ•¸
 * @returns {Promise<void>}
 */
function animateNight(sec) {
    const overlay = document.getElementById('night-overlay');
    const fadeDuration = 1000; // 1 ç§’è®Šæš—ï¼Œ1 ç§’è®Šäº®
    
    return new Promise(async (resolve) => {
        // è¨­å®š transition duration
        overlay.style.transitionDuration = `${fadeDuration}ms`;
        
        // å¼·åˆ¶ç€è¦½å™¨é‡ç¹ª (Reflow)
        overlay.offsetHeight; 

        // --- 1. è®Šæš— (Fade In) ---
        overlay.style.opacity = '1';
        
        // ç­‰å¾…è®Šæš—å‹•ç•«å®Œæˆ
        await wait(fadeDuration / 1000); 
        await getPausePromise(); 

        // --- 2. ä¿æŒé»‘æš— (Dark Hold) ---
        const holdDuration = Math.max(0.01, sec - (2 * fadeDuration) / 1000); 
        await wait(holdDuration);
        await getPausePromise(); 

        // --- 3. è®Šäº® (Fade Out) ---
        overlay.style.opacity = '0';
        
        // ç­‰å¾…è®Šäº®å‹•ç•«å®Œæˆ
        await wait(fadeDuration / 1000); 
        await getPausePromise(); 
        
        // æ¸…ç†æ¨£å¼
        overlay.style.transitionDuration = `0ms`; 
        resolve();
    });
}

/**
 * è¼”åŠ©å‡½æ•¸ï¼šç”Ÿæˆå¼§ç·šè·¯å¾‘çš„é»
 * @param {Array<number>} start [lat, lng]
 * @param {Array<number>} end [lat, lng]
 * @returns {Array<Array<number>>} åŒ…å«èµ·é»ã€ä¸­é–“å¼§é ‚é»ã€çµ‚é»çš„å¤šå€‹é»
 */
function createArcPath(start, end) {
    const latDiff = end[0] - start[0];
    const lngDiff = end[1] - start[1];
    const distanceInDegrees = Math.sqrt(latDiff * latDiff + lngDiff * lngDiff);

    // è·é›¢å¤ªçŸ­æ™‚ï¼Œé€€åŒ–ç‚ºç›´ç·š
    if (distanceInDegrees < 0.01) {
        return [start, end];
    }
    
    // å¼§åº¦é«˜åº¦ï¼šåŸºæ–¼è·é›¢æŒ‰æ¯”ä¾‹ç¸®æ”¾ï¼Œä½†ä¸è¶…éæœ€å¤§å€¼
    // è®“å¼§ç·šé«˜åº¦éš¨è·é›¢å¢é•·ï¼Œçœ‹èµ·ä¾†æ›´è‡ªç„¶
    const arcHeight = Math.min(ARC_HEIGHT_DEG, distanceInDegrees * 0.5); 

    const arcPoints = [];
    for (let i = 0; i <= ARC_SEGMENTS; i++) {
        const t = i / ARC_SEGMENTS; // 0 åˆ° 1 çš„é€²åº¦
        
        // ç›´ç·šæ’å€¼ (åŸºç¤åœ°ç†ä½ç½®)
        const currentLat = start[0] + latDiff * t;
        const currentLng = start[1] + lngDiff * t;
        
        // å¼§ç·šé«˜åº¦èª¿æ•´ (ä½¿ç”¨äºŒæ¬¡å‡½æ•¸æ¨¡æ“¬æ‹‹ç‰©ç·šå¼§åº¦ï¼Œt=0.5 æ™‚é”åˆ°æœ€å¤§)
        // heightFactor = 4 * t * (1 - t)
        const heightFactor = 4 * t * (1 - t); 
        
        // ç·¯åº¦æŠ¬å‡ (æ¨¡æ“¬å¼§ç·š)
        const liftedLat = currentLat + arcHeight * heightFactor; 
        
        arcPoints.push([liftedLat, currentLng]);
    }

    return arcPoints;
}


// å‡½å¼: ç§»å‹• (Promise ç‰ˆæœ¬)
/**
 * * @param {Array<number>} gps - [lat, lng]
 * @param {Object} step - ç•¶å‰çš„æ­¥é©Ÿç‰©ä»¶ (ç”¨æ–¼åˆ¤æ–·æ˜¯å¦éœ€è¦æ˜Ÿè™Ÿ)
 * @returns {Promise<void>}
 */
function goto(gps, step){ // <-- èª¿æ•´ 2: æ–°å¢ step åƒæ•¸
  return new Promise(resolve => {
    if(currentAnimation) return;
    currentAnimation=true;
    const startPos=marker.getLatLng();
    if(polyline) mapInstance.removeLayer(polyline);
    
    const currentIconName = Object.keys(icons).find(k=>icons[k]===marker.options.icon);
    const isAirplane = currentIconName === 'airplane'; // æª¢æŸ¥æ˜¯å¦ç‚ºé£›æ©Ÿ

    let pathPoints;
    let finalPathDistance;

    // --- èª¿æ•´ 2: æ¢ä»¶å¼æ˜Ÿè™Ÿé‚è¼¯ ---
    const wordsPresent = step.words && step.words.trim() !== '';
    const imagePresent = !!step.image;
    const shouldShowStar = wordsPresent || imagePresent; // åƒ…ç•¶æœ‰è¨Šæ¯æˆ–åœ–ç‰‡æ™‚æ‰é¡¯ç¤ºæ˜Ÿè™Ÿ
    
    // ------------------------------------------------------------------
    // éœ€æ±‚ 3. START: åœ¨ç›®æ¨™ä½ç½®æ¨™ä¸Šå¤§æ˜Ÿè™Ÿ (ç¾åœ¨æ˜¯æ¢ä»¶å¼)
    // ------------------------------------------------------------------
    
    if (shouldShowStar) {
        // èª¿æ•´ï¼šä½¿ç”¨ CSS é¡åˆ¥ `target-star-icon` æ§åˆ¶å¤§å°ã€èƒŒæ™¯å’Œ Z-index
        const starIcon = L.divIcon({ 
            html: '<div style="font-size: 30px; color: red; line-height:1;">â­</div>', // å…§è¯æ¨£å¼åƒ…ç¢ºä¿åœ–æ¨™æ˜¯æ˜Ÿè™Ÿä¸”ç´…è‰²
            className: 'leaflet-div-icon target-star-icon', 
            iconSize: [30, 30], // ç¢ºä¿å®¹å™¨å¤§å°åŒ¹é…
            iconAnchor: [15, 15] // éŒ¨é»èª¿æ•´ç‚ºä¸­å¿ƒ
        });

        // ç§»é™¤èˆŠçš„æ˜Ÿè™Ÿ (å¦‚æœå­˜åœ¨)
        if (targetMarker) {
            mapInstance.removeLayer(targetMarker);
        }
        
        targetMarker = L.marker(gps, { icon: starIcon }).addTo(mapInstance);
    }
    // ------------------------------------------------------------------


    if (isAirplane) {
        // é£›æ©Ÿï¼šä½¿ç”¨å¼§ç·šè·¯å¾‘
        pathPoints = createArcPath([startPos.lat, startPos.lng], gps);
        // ç‚ºäº†å‹•ç•«å¹³æ»‘ï¼Œæˆ‘å€‘éœ€è¦çŸ¥é“è·¯å¾‘ä¸­æœ‰å¤šå°‘å€‹é»
        finalPathDistance = pathPoints.length; 
    } else {
        // å…¶ä»–äº¤é€šå·¥å…·ï¼šä½¿ç”¨ç›´ç·š
        pathPoints = [
            [startPos.lat, startPos.lng],
            gps
        ];
        finalPathDistance = distance([startPos.lat,startPos.lng],gps);
    }

    // ç¹ªè£½è·¯å¾‘
    polyline = L.polyline(pathPoints,{
        // --- ä¿®æ­£é–‹å§‹ï¼šè¨­ç½® opacity ç‚º 0 ä»¥éš±è—è·¯ç·š ---
        color: isAirplane ? '#93c5fd' : 'blue', 
        opacity: 0, // <--- éš±è—è·¯ç·šè»Œè·¡
        weight: isAirplane ? 3 : 5,
        dashArray: isAirplane ? '10, 10' : null 
        // --- ä¿®æ­£çµæŸ ---
    }).addTo(mapInstance);

    const bounds=L.latLngBounds([startPos,gps]);
    
    const MAX_DURATION = 4000; // æœ€é•·ç§»å‹•æ™‚é–“ 4 ç§’
    
    // NEW: å‹•æ…‹è¨ˆç®— padding (BUG 2 ä¿®æ­£)
    let paddingOptions = { duration: 1.5 };
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºè¡Œå‹•è£ç½®ä¸”è™•æ–¼æ’­æ”¾æ¨¡å¼
    if (isMobile && document.body.classList.contains('mobile-playing')) {
        // åº•éƒ¨æ§åˆ¶é¢æ¿ h-[190px] + é¡å¤–å®‰å…¨é‚Šè· 20px = 210px
        const bottomControlHeight = 210; 
        // Leaflet padding é™£åˆ—: [top, right, bottom, left]
        // ç¢ºä¿åœ°åœ–çš„ç›®æ¨™å€åŸŸä¸æœƒè¢«åº•éƒ¨çš„æ§åˆ¶é¢æ¿é®æ“‹
        paddingOptions.padding = [40, 40, bottomControlHeight, 40]; 
    } else {
        // æ¡Œé¢ç‰ˆæˆ–ç·¨è¼¯æ¨¡å¼ï¼šä½¿ç”¨æ¨™æº–çš„ [å‚ç›´, æ°´å¹³] é‚Šè·
        // ç”±æ–¼ flyToBounds æ¥å— L.Point(vertical, horizontal)ï¼Œæˆ‘å€‘åœ¨é€™è£¡æ˜ç¢ºå‚³é
        paddingOptions.padding = L.point(40, 40); 
    }

    mapInstance.flyToBounds(bounds, paddingOptions); 
    
    // ç­‰å¾…åœ°åœ–å¹³ç§»å¾Œé–‹å§‹æ¨™è¨˜å‹•ç•«
    setTimeout(()=>{
      
      // --- ä¿®æ­£ï¼šç§»é™¤æŠ˜ç·šæ·¡å…¥é‚è¼¯ (å› è·¯ç·šå·²éš±è—) ---
      // polyline.setStyle({opacity: isAirplane ? 1 : 0.8}); 
      // ---------------------------------------------

      let dist; // ç¸½è·é›¢ (å…¬å°º)
      if (isAirplane) {
          // å°é£›æ©Ÿè€Œè¨€ï¼Œè·é›¢è¨­ç‚ºç›´ç·šè·é›¢ï¼Œå‹•ç•«æ™‚é•·åŸºæ–¼ç›´ç·šè·é›¢è¨ˆç®—
          dist = distance([startPos.lat,startPos.lng],gps); 
      } else {
          dist = finalPathDistance;
      }
      
      let duration; // å‹•ç•«æ™‚é•· (æ¯«ç§’)
      
      let speed; // é€Ÿåº¦ (m/s)
      
      // æ ¹æ“šåœ–æ¨™åç¨±è¨­å®šé€Ÿåº¦
      if (currentIconName === 'walk' || currentIconName === 'dine' || currentIconName === 'view' || currentIconName === 'shopping') { 
        speed = 100; // æ­¥è¡Œå’Œéœæ…‹å‹•ä½œé€Ÿåº¦
      } else if (currentIconName === 'bus' || currentIconName === 'car' || currentIconName === 'taxi') { // æ–°å¢ taxi
        speed = 400; // èª¿æ•´ç‚º 400 m/s
      } else if (currentIconName === 'airplane') {
        speed = 800; // é£›æ©Ÿé€Ÿåº¦æœ€å¿«
      } else {
        speed = 700; // é è¨­é€Ÿåº¦ (ç«è»Š/æ©Ÿè»Š)
      }
      
      duration = dist / speed * 1000;
      duration = Math.min(duration, MAX_DURATION); // å¼·åˆ¶è¨­å®šæœ€é•·æ™‚é•·ç‚º 4 ç§’

      let startTime=null;

      function animateMarker(ts){
        if(!startTime) startTime=ts;
        const progress=(ts-startTime)/duration;
        
        if(progress>=1){
          // å‹•ç•«çµæŸ
          marker.setLatLng(gps);
          
          // ------------------------------------------------------------------
          // éœ€æ±‚ 3. END: ç§»é™¤ç›®æ¨™ä½ç½®çš„æ˜Ÿè™Ÿ (ç¾åœ¨æ˜¯æ¢ä»¶å¼)
          // ------------------------------------------------------------------
          // åªæœ‰ç•¶åˆæœ‰æ–°å¢æ˜Ÿè™Ÿæ™‚æ‰ç§»é™¤
          if (targetMarker) { 
              mapInstance.removeLayer(targetMarker);
              targetMarker = null;
          }
          // ------------------------------------------------------------------

          // --- ä¿®æ­£ï¼šç›´æ¥ç§»é™¤æŠ˜ç·šï¼Œä¸å†åŸ·è¡Œæ·¡å‡ºå‹•ç•« ---
          mapInstance.removeLayer(polyline);
          currentAnimation=false; 
          resolve(); // è§£æ±º Promise
          // ---------------------------------------------
        }else{
            // æ¨™è¨˜ç§»å‹•
            let lat, lng;

            if (isAirplane) {
                // é£›æ©Ÿï¼šæ²¿è‘—å¼§ç·šè·¯å¾‘ç§»å‹•
                const pathIndex = Math.min(Math.floor(progress * ARC_SEGMENTS), ARC_SEGMENTS - 1);
                const segmentProgress = (progress * ARC_SEGMENTS) - pathIndex;
                
                const p1 = pathPoints[pathIndex];
                const p2 = pathPoints[pathIndex + 1] || pathPoints[ARC_SEGMENTS];

                lat = p1[0] + (p2[0] - p1[0]) * segmentProgress;
                lng = p1[1] + (p2[1] - p1[1]) * segmentProgress;

            } else {
                // å…¶ä»–äº¤é€šå·¥å…·ï¼šç›´ç·šç§»å‹•
                lat=startPos.lat+(gps[0]-startPos.lat)*progress;
                lng=startPos.lng+(gps[1]-startPos.lng)*progress;
            }

            marker.setLatLng([lat,lng]);
            requestAnimationFrame(animateMarker);
        }
      }
      requestAnimationFrame(animateMarker);
    },1500); // ç­‰å¾… mapInstance.flyToBounds çµæŸ
  });
}

/**
 * æ ¹æ“šè¢å¹•å¤§å°å’Œæ’­æ”¾ç‹€æ…‹æ›´æ–°è¡Œå‹•è£ç½®ä½ˆå±€
 */
function updateMobileLayout() {
    const BODY_CONTAINER = document.body;
    // æª¢æŸ¥æ˜¯å¦ç‚ºè¡Œå‹•è£ç½® (å°äº 768px)
    isMobile = window.innerWidth <= 767; 
    
    // å¦‚æœæ˜¯ PC (å¤§æ–¼ 767px)ï¼Œæ¸…é™¤æ‰€æœ‰ mobile ç›¸é—œ class
    if (!isMobile) {
        BODY_CONTAINER.classList.remove('mobile-controls-only', 'mobile-playing');
    } else {
        // è¡Œå‹•è£ç½®ä½ˆå±€
        if (isScriptRunning) {
            // æ’­æ”¾æ¨¡å¼ (æ‰‹æ©Ÿ): åœ°åœ–å’Œåº•éƒ¨æ§åˆ¶é¢æ¿ä½”ç”¨æ‰€éœ€ç©ºé–“
            BODY_CONTAINER.classList.add('mobile-playing');
            BODY_CONTAINER.classList.remove('mobile-controls-only');
        } else {
            // ç·¨è¼¯æ¨¡å¼ (æ‰‹æ©Ÿ): éš±è—åœ°åœ–ï¼Œé¡¯ç¤ºæ•´å€‹æ§åˆ¶é¢æ¿
            BODY_CONTAINER.classList.add('mobile-controls-only');
            BODY_CONTAINER.classList.remove('mobile-playing');
        }
    }
    
    // Leaflet ä¿®æ­£ (BUG 1 ä¿®æ­£): åœ¨ä½ˆå±€æ”¹è®Šå¾Œé€šçŸ¥åœ°åœ–é‡æ–°è¨ˆç®—å¤§å°ï¼Œé˜²æ­¢åœ°åœ–å€ç©ºç™½ã€‚
    if (mapInstance) {
         mapInstance.invalidateSize(true);
    }
}


/**
 * åŸ·è¡ŒåŠ‡æœ¬
 * @param {number} startIndex - å¾å“ªå€‹æ­¥é©Ÿç´¢å¼•é–‹å§‹åŸ·è¡Œ (0ç‚ºSTARTï¼Œ1ç‚ºç¬¬ä¸€å€‹å¯åŸ·è¡Œæ­¥é©Ÿ)
 */
function executeScript(startIndex = 1) { // <-- HTML onclick èª¿ç”¨
    if (isScriptRunning) return;

    const playButton = document.getElementById('play-button');
    const statusMessage = document.getElementById('status-message');
    const pauseButton = document.getElementById('pause-resume-button');
    const stopButton = document.getElementById('stop-button'); // æ–°å¢åœæ­¢æŒ‰éˆ•

    // è¨­ç½®é‹è¡Œç‹€æ…‹
    isScriptRunning = true;
    isPaused = false; // é‡è¨­æš«åœç‹€æ…‹
    
    playButton.disabled = true;
    pauseButton.disabled = false;
    stopButton.disabled = false; // å•Ÿç”¨åœæ­¢æŒ‰éˆ•
    pauseButton.title = 'Pause Playback';
    // æ›´æ–°æŒ‰éˆ•æ–‡å­—
    pauseButton.querySelector('span').textContent = 'â¸ï¸ PAUSE';

    playButton.classList.remove('bg-indigo-500', 'hover:bg-indigo-700');
    playButton.classList.add('bg-gray-400');
    statusMessage.textContent = 'â–¶ï¸ Script execution started...';
    
    // NEW: Update layout to playing mode (é€™è£¡ä¹Ÿæœƒæ›´æ–° isMobile ä¸¦å‘¼å« invalidateSize)
    updateMobileLayout();
    
    // æ¸…é™¤æ‰€æœ‰æ­¥é©Ÿé«˜äº® (focused-step å·²ç§»é™¤)
    document.querySelectorAll('[id^="step-"]').forEach(el => el.classList.remove('ring-2', 'ring-indigo-500', 'shadow-md'));

    // --- 1. ç‹€æ…‹é‡å»ºï¼šç¢ºä¿æ¨™è¨˜å¾æ­£ç¢ºçš„ä½ç½®å’Œåœ–æ¨™é–‹å§‹ ---
    let currentLat = scriptSteps[0].lat;
    let currentLng = scriptSteps[0].lng;
    let currentIcon = 'motorcycle'; // é è¨­åœ–æ¨™ (æ©Ÿè»Šåœ–æ¨™)

    for (let j = 0; j < startIndex; j++) {
        const step = scriptSteps[j];
        if (step.type === 'start') {
            currentLat = step.lat;
            currentLng = step.lng;
            // Start step doesn't have an icon property. The icon is set below.
        } else if (step.type === 'goto') {
            currentLat = step.lat;
            currentLng = step.lng;
            if (step.icon) {
                currentIcon = step.icon;
            }
        } else if (step.type === 'activity') { 
            if (step.icon) {
                currentIcon = step.icon;
            }
        } else if (step.type === 'dayoff') {
            // Dayoff ä¸æ”¹è®Šä½ç½®ï¼Œä½†æœƒå¼·åˆ¶è¨­ç‚º sleep
            currentIcon = 'sleep';
        }
    }
    
    // åˆå§‹ç‹€æ…‹åœ–æ¨™å¿…é ˆè¨­ç‚º 'train' (åœ¨ DOMContentLoaded è¨­ç½®)
    if (startIndex === 0 || scriptSteps[startIndex-1].type === 'start') {
         currentIcon = 'train'; // ç¢ºä¿å¦‚æœå¾ start é–‹å§‹ï¼Œåœ–æ¨™æ˜¯ train
    }

    // æ‡‰ç”¨é‡å»ºçš„ç‹€æ…‹
    start([currentLat, currentLng]);
    setIcon(currentIcon);
    mapInstance.setView([currentLat, currentLng], 13);
    // ----------------------------------------------------


    // 2. æŒ‰ç…§æ­¥é©Ÿé †åºåŸ·è¡Œ
    async function runSteps() { // ä½¿ç”¨ä¸€å€‹ async å…§éƒ¨å‡½æ•¸ä¾†è™•ç† await
        let currentDay = 1; // è¿½è¹¤ Day æ•¸
        
        // --- é å…ˆè¨ˆç®— DAY æ•¸åˆ° startIndex ä¹‹å‰ (ä¿®æ­£: å¿…é ˆæ­£ç¢ºè¨ˆç®—åˆ°å‰ä¸€æ­¥é©Ÿçš„ Day æ•¸) ---
        currentDay = 1; 
        
        for (let j = 1; j < startIndex; j++) { // å¾æ­¥é©Ÿ 1 é–‹å§‹æª¢æŸ¥
             // åªæœ‰åœ¨ Dayoff ä¹‹å¾Œæ‰å¢åŠ  Day æ•¸
            if (scriptSteps[j - 1].type === 'dayoff') { 
                currentDay++;
            }
        }
        // ----------------------------------------

        for (let i = startIndex; i < scriptSteps.length; i++) {
            
            if (!isScriptRunning) {
                clearFreezeDetection(); // ç¢ºä¿åœæ­¢æ™‚æ¸…é™¤è¨ˆæ™‚å™¨
                break; 
            }

            // --- 1. è‡ªå‹•ç”¢ç”Ÿ DAY X START è¨Šæ¯ (ä¿®å¾© BUG 1) ---
            let isDayStartStep = false;
            
            // Day æ•¸æ›´æ–°é‚è¼¯ (å¿…é ˆåœ¨ Dayoff å¾Œçš„ç¬¬ä¸€å€‹æ­¥é©Ÿæ™‚æ‰æ›´æ–°)
            if (i > 1 && scriptSteps[i - 1].type === 'dayoff') { 
                 currentDay++; // åªæœ‰åœ¨ Dayoff ä¹‹å¾Œæ‰å¢åŠ  Day æ•¸
                 isDayStartStep = true;
            } 
            // åˆ¤æ–·æ˜¯å¦ç‚º Day 1 çš„é–‹å§‹ (i=1, startIndex=1)
            else if (i === 1 && startIndex === 1) {
                isDayStartStep = true;
            } 
            
            if (isDayStartStep) {
                // ç¢ºä¿è¨Šæ¯é¡¯ç¤ºä¸æœƒè¢« Pause é˜»å¡
                show(`ğŸŒ DAY ${currentDay} Start!`);
                await wait(1); 
                await getPausePromise(); 
                // ä¿®æ­£ï¼šæ‰‹å‹•é—œé–‰å½ˆå‡ºè¦–çª—
                hidePopup(); 
            }
            // ------------------------------------
            
            // æª¢æŸ¥æš«åœç‹€æ…‹ (å¿…é ˆåœ¨åŸ·è¡Œä»»ä½•å‹•ä½œå‰æª¢æŸ¥)
            await getPausePromise(); 
            
            if (!isScriptRunning) {
                 clearFreezeDetection(); // ç¢ºä¿æ¢å¾©å¾Œç«‹å³åœæ­¢æ™‚æ¸…é™¤è¨ˆæ™‚å™¨
                 break; 
            } 
            
            // ----------------------------------------------------
            // å•Ÿå‹•å‡çµåµæ¸¬ï¼šç¢ºä¿å–®ä¸€æ­¥é©Ÿï¼ˆä¸å«ç”¨æˆ¶ä¸»å‹•æš«åœæ™‚é–“ï¼‰ä¸æœƒè¶…æ™‚
            // ----------------------------------------------------
            startFreezeDetection(i, FREEZE_TIMEOUT_SEC);

            const step = scriptSteps[i];
            
            // æ›´æ–°ç•¶å‰åŸ·è¡Œç‹€æ…‹
            statusMessage.textContent = `Executing: Step ${i}. ${step.label || step.type}...`;
            // æ’­æ”¾æ™‚ä½¿ç”¨è—è‰²é«˜äº®
            document.getElementById(`step-${i}`).classList.add('ring-2', 'ring-indigo-500', 'shadow-md');
            
            // æ–°å¢è®Šé‡ä¾†æ§åˆ¶æµç¨‹
            const wordsPresent = step.words && step.words.trim() !== '';
            const imagePresent = !!step.image;
            const stepDuration = step.sec || PHOTO_STANDALONE_DURATION; 
            
            // ç¨ç«‹åª’é«”æ’­æ”¾æ§åˆ¶ (ç”¨æ–¼æ­¥é©ŸçµæŸæ™‚)
            let runStandaloneModal = false;
            let modalMessage = null; // è¨Šæ¯å‚³éçµ¦ modal
            let modalDuration = PHOTO_STANDALONE_DURATION;

            try {
                // --- æ­¥é©Ÿé–‹å§‹æ™‚çš„é‚è¼¯ ---
                // åªæœ‰ Activity/Dayoffï¼ˆæŒçºŒé¡¯ç¤ºé¡å‹ï¼‰æ‰åœ¨é–‹å§‹æ™‚æ‰“é–‹ç…§ç‰‡
                if ((step.type === 'activity' || step.type === 'dayoff') && imagePresent) {
                    openImageModal(step.image); 
                }
                
                // --- åŸ·è¡Œä¸»è¦æ­¥é©Ÿå‹•ä½œ ---
                switch (step.type) {
                    case 'activity':
                        if (step.icon) { setIcon(step.icon); }
                        if (step.sec && step.sec > 0) { await wait(step.sec); }
                        break;
                        
                    case 'show':
                        if (wordsPresent && imagePresent) {
                            // **æ–°éœ€æ±‚: è¨Šæ¯+åœ–ç‰‡ -> è¨Šæ¯æ”¾å…¥åœ–ç‰‡æ¨¡æ…‹æ¡†**
                            runStandaloneModal = true;
                            modalMessage = step.words; // å‚³éè¨Šæ¯
                            modalDuration = stepDuration; // ä½¿ç”¨è¨­å®šçš„ç§’æ•¸
                            // ä¸åŸ·è¡Œç­‰å¾…ï¼Œè®“ playStepMedia è™•ç†
                        } else if (wordsPresent && !imagePresent) {
                            // åªæœ‰è¨Šæ¯ (ç„¡åœ–) -> Leaflet Popup
                            // ä¿®æ­£ï¼šç¾åœ¨ calculatedDuration çœŸæ­£æ±ºå®šäº†é¡¯ç¤ºæ™‚é–“
                            const calculatedDuration = getDurationMultiplier(step.words); 
                            show(step.words);
                            await wait(calculatedDuration); // <-- ä½¿ç”¨è¨ˆç®—çš„æ™‚é–“
                            hidePopup(); // ä¿®æ­£ï¼šæ‰‹å‹•é—œé–‰å½ˆå‡ºè¦–çª—
                        } else if (!wordsPresent && imagePresent) {
                            // åªæœ‰åœ–ç‰‡ (ç„¡è¨Šæ¯) -> ç¨ç«‹æ¨¡æ…‹æ¡†
                            runStandaloneModal = true;
                            modalDuration = stepDuration; // ä½¿ç”¨è¨­å®šçš„ç§’æ•¸
                            // modalMessage ä¿æŒ null
                        } else {
                            // ç„¡è¨Šæ¯ï¼Œç„¡åœ–ç‰‡ -> ç´”ç­‰å¾…
                            await wait(stepDuration); 
                        }
                        break;
                        
                    case 'goto':
                        if (step.icon) { setIcon(step.icon); }
                        await goto([step.lat, step.lng], step); // <-- èª¿æ•´ 2: å‚³å…¥ step ç‰©ä»¶
                        
                        if (wordsPresent) {
                            // Goto è¨Šæ¯ä»ç„¶ä½¿ç”¨ Leaflet Popup
                            // ä¿®æ­£ï¼šç¾åœ¨ calculatedDuration çœŸæ­£æ±ºå®šäº†é¡¯ç¤ºæ™‚é–“
                            const calculatedDuration = getDurationMultiplier(step.words); 
                            show(step.words);
                            await wait(calculatedDuration); // <-- ä½¿ç”¨è¨ˆç®—çš„æ™‚é–“
                            hidePopup(); // ä¿®æ­£ï¼šæ‰‹å‹•é—œé–‰å½ˆå‡ºè¦–çª—
                        }
                        
                        if (imagePresent) {
                            // Goto åœ–ç‰‡åœ¨ç§»å‹•å’Œè¨Šæ¯å¾Œæ’­æ”¾ (ç¨ç«‹ï¼Œç„¡è¨Šæ¯)
                            runStandaloneModal = true;
                            // Goto åœ–ç‰‡ä½¿ç”¨é è¨­æ™‚é•· 2.5s
                            modalDuration = PHOTO_STANDALONE_DURATION;
                            // modalMessage ä¿æŒ null
                        }
                        break;
                        
                    case 'dayoff':
                        setIcon('sleep');
                        await animateNight(step.sec);
                        break;
                }
                
                // æ¸…é™¤å‡çµåµæ¸¬
                clearFreezeDetection();
                
                // --- æ­¥é©ŸçµæŸæ™‚çš„é‚è¼¯ ---
                // 1. è™•ç† Activity/Dayoff çš„é—œé–‰
                if ((step.type === 'activity' || step.type === 'dayoff') && imagePresent) {
                    closeImageModal();
                } 
                
                // 2. è™•ç† SHOW æˆ– GOTO çš„ç¨ç«‹æ¨¡æ…‹æ¡†æ’­æ”¾
                else if (runStandaloneModal) {
                    // æ³¨æ„ï¼šæ­¤è™•å·²åŒ…å«äº† SHOW + è¨Šæ¯ + åœ–ç‰‡çš„çµ„åˆï¼Œä¸¦å°‡è¨Šæ¯å‚³å…¥
                    await playStepMedia(step.image, modalDuration, modalMessage); 
                }


            } catch (error) {
                console.error(`Step ${i} execution error:`, error);
                // é‡åˆ°éŒ¯èª¤ï¼Œèª¿ç”¨ stopScript æ¸…ç†ç‹€æ…‹
                clearFreezeDetection();
                stopScript();
                statusMessage.textContent = `âŒ Error: Step ${i} execution failed, aborted.`;
                return; 
            }
            
            // æ¸…é™¤ç•¶å‰æ­¥é©Ÿé«˜äº®
            document.getElementById(`step-${i}`).classList.remove('ring-2', 'ring-indigo-500', 'shadow-md');
        }

        // 3. åŸ·è¡ŒçµæŸ
        if (isScriptRunning) { 
            stopScript(); // ä½¿ç”¨ stopScript åŸ·è¡Œæ¨™æº–çµæŸæ¸…ç†
            statusMessage.textContent = 'âœ… Script execution completed!';
        }
    }
    
    // å•Ÿå‹•åŸ·è¡Œ
    runSteps();
}

/**
 * æç¤ºä¸¦åŸ·è¡Œæ¸…é™¤åŠ‡æœ¬å‹•ä½œ (å…©æ­¥é©Ÿç¢ºèª)
 */
function promptClearScript() { // <-- HTML onclick èª¿ç”¨
    const btn = document.getElementById('delete-all-button');
    const originalText = 'ğŸ—‘ï¸ DELETE ALL';
    const confirmText = 'âš ï¸ CONFIRM DELETE ALL? (5s)';

    // æª¢æŸ¥æ˜¯å¦è™•æ–¼ç¢ºèªç‹€æ…‹
    if (btn.textContent.includes('CONFIRM')) {
        clearScript();
        return;
    }
    
    // é€²å…¥ç¢ºèªç‹€æ…‹
    btn.textContent = confirmText;
    btn.classList.remove('bg-red-400', 'hover:bg-red-600');
    btn.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');

    // è¨­ç½® 5 ç§’å¾Œé‡ç½®æŒ‰éˆ•
    clearTimeout(clearScriptTimeoutId);
    clearScriptTimeoutId = setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.add('bg-red-400', 'hover:bg-red-600');
        btn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');
    }, 5000);
}

/**
 * æ¸…é™¤æ‰€æœ‰åŠ‡æœ¬æ­¥é©Ÿï¼Œåªä¿ç•™ç¬¬ä¸€å€‹ 'start' æ­¥é©Ÿ
 */
function clearScript() {
    const btn = document.getElementById('delete-all-button');
    const statusMessage = document.getElementById('status-message');

    // æ¸…é™¤ç¢ºèªç‹€æ…‹è¨ˆæ™‚å™¨
    clearTimeout(clearScriptTimeoutId);

    // é‡è¨­åŠ‡æœ¬ç‚ºåªæœ‰ç¬¬ä¸€å€‹ 'start' æ­¥é©Ÿ (ä½¿ç”¨ START_STEP_DEFINITION ä¾†é‡è¨­)
    scriptSteps = [
        { 
            type: START_STEP_DEFINITION.type, 
            lat: START_STEP_DEFINITION.lat, 
            lng: START_STEP_DEFINITION.lng, 
            label: START_STEP_DEFINITION.label 
        }
    ];

    clearInsertAnchor(); // æ¸…é™¤éŒ¨é»ç‹€æ…‹
    renderScript(); // é‡æ–°æ¸²æŸ“
    saveScriptToLocalStorage();

    // æ¢å¾©æŒ‰éˆ•å’Œç‹€æ…‹è¨Šæ¯
    btn.textContent = 'ğŸ—‘ï¸ DELETE ALL';
    btn.classList.add('bg-red-400', 'hover:bg-red-600');
    btn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');
    statusMessage.textContent = 'ğŸ—‘ï¸ Script cleared, restored to initial step.';
}


/**
 * æ²å‹•è…³æœ¬åˆ—è¡¨åˆ°æœ€åº•éƒ¨
 */
function scrollToBottom() { // <-- HTML onclick èª¿ç”¨
    // æ²å‹•ç›®æ¨™è®Šæ›´ç‚ºæ–°çš„åˆ—è¡¨å®¹å™¨
    const listWrapper = document.getElementById('script-list-wrapper');
    // æ²å‹•åˆ° listWrapper å®¹å™¨çš„æœ€åº•éƒ¨
    if (listWrapper) {
        listWrapper.scrollTop = listWrapper.scrollHeight;
    }
}

/**
 * æ²å‹•è¡Œç¨‹åˆ—è¡¨åˆ°æŒ‡å®šå¤©æ•¸çš„ç¬¬ä¸€å€‹è¡Œç¨‹ã€‚
 * @param {number} dayNumber - è¦æ²å‹•åˆ°çš„ç›®æ¨™å¤©æ•¸ (1, 2, 3...)
 */
function scrollToDayStart(dayNumber) {
    const targetDay = dayStartIndices.find(item => item.day === dayNumber);
    if (!targetDay) {
        console.warn(`Could not find start step for Day ${dayNumber}.`);
        return;
    }
    
    // æ­¥é©Ÿ 0 (start) æ²’æœ‰å¡ç‰‡ï¼Œæ‰€ä»¥å¾æ­¥é©Ÿ 1 é–‹å§‹ã€‚
    const stepElement = document.getElementById(`step-${targetDay.stepIndex}`);
    const listWrapper = document.getElementById('script-list-wrapper');

    if (stepElement && listWrapper) {
        // ä½¿ç”¨ scrollIntoView é…åˆ 'start' ç¢ºä¿å…ƒç´ å°é½Šåˆ°çˆ¶å®¹å™¨é ‚éƒ¨
        stepElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}


/**
 * åŒ¯å‡ºåŠ‡æœ¬ï¼šå°‡å„ªåŒ–å¾Œçš„ JSON å­—ä¸²ç”Ÿæˆç‚ºæª”æ¡ˆä¸¦ä¸‹è¼‰ã€‚
 * @param {boolean} [isSilent=false] - å¦‚æœç‚º trueï¼Œå‰‡ä¸æ›´æ–°ç‹€æ…‹è¨Šæ¯ï¼Œç”¨æ–¼è¡çªè§£æ±ºã€‚
 */
async function exportScript(isSilent = false) { // <-- HTML onclick èª¿ç”¨
    const statusMessage = document.getElementById('status-message');
    let rawJsonString = ''; 
    
    try {
        // --- 1. æ•¸æ“šå„ªåŒ–èˆ‡è½‰æ› (å£“ç¸®çµæ§‹) ---
        
        const compactScript = scriptSteps.map(step => {
            // æ‰¾å‡ºç•¶å‰ icon å°æ‡‰çš„ char
            const iconItem = ICON_NAMES.find(item => item.name === step.icon);
            const iconChar = iconItem ? iconItem.char : ''; // å¦‚æœæ²’æœ‰æ‰¾åˆ°ï¼Œå‰‡ç‚ºç©ºå­—ä¸²

            const compact = [];
            switch (step.type) {
                case 'start': // s, lat, lng, [label], [image]
                    compact.push('s', step.lat, step.lng);
                    if (step.label) compact.push(step.label);
                    // é—œéµä¿®æ­£ï¼šåœ–ç‰‡ Base64 å­—ä¸²åœ¨æ­¤è™•é€²è¡Œ URI ç·¨ç¢¼ï¼Œç¢ºä¿å­—ä¸²å®‰å…¨
                    if (step.image) compact.push(encodeURIComponent(step.image)); 
                    return compact;
				case 'goto': // g, lat, lng, iconChar, words, [image]
					compact.push('g', step.lat, step.lng);
					// ä¿®æ­£ï¼šä½¿ç”¨å”¯ä¸€ char
					compact.push(iconChar); 
					compact.push(step.words || '');
					// é—œéµä¿®æ­£ï¼šåœ–ç‰‡ Base64 å­—ä¸²åœ¨æ­¤è™•é€²è¡Œ URI ç·¨ç¢¼ï¼Œç¢ºä¿å­—ä¸²å®‰å…¨
					if (step.image) compact.push(encodeURIComponent(step.image));
					return compact;
			
                case 'activity': // a, sec, [iconChar], [image]
                    compact.push('a', step.sec);
                    // ä¿®æ­£ï¼šä½¿ç”¨å”¯ä¸€ char
                    if (iconChar) compact.push(iconChar); 
                    // é—œéµä¿®æ­£ï¼šåœ–ç‰‡ Base64 å­—ä¸²åœ¨æ­¤è™•é€²è¡Œ URI ç·¨ç¢¼ï¼Œç¢ºä¿å­—ä¸²å®‰å…¨
                    if (step.image) compact.push(encodeURIComponent(step.image)); 
                    return compact;
                case 'show': // h, words, [image], [sec]
                    compact.push('h'); 
                    // 1. WORDS: å¿…é ˆæ¨é€ï¼Œå³ä½¿ç‚ºç©ºå­—ä¸²ï¼Œä»¥ä¿æŒçµæ§‹ç©©å®šæ€§
                    compact.push(step.words || ''); 
                    // 2. åœ–ç‰‡ (å¯é¸) - å¼·åŒ–æª¢æŸ¥ï¼Œç¢ºä¿åœ–ç‰‡å­—ä¸²æœ‰æ•ˆä¸”éç©º
                    if (step.image && typeof step.image === 'string' && step.image.length > 10) {
                         // é—œéµä¿®æ­£ï¼šåœ–ç‰‡ Base64 å­—ä¸²åœ¨æ­¤è™•é€²è¡Œ URI ç·¨ç¢¼ï¼Œç¢ºä¿å­—ä¸²å®‰å…¨
                         compact.push(encodeURIComponent(step.image)); 
                    }
                    // 3. æŒçºŒæ™‚é–“ (å¯é¸)
                    if (step.sec) compact.push(step.sec); 
                    return compact;
                case 'dayoff': // d, sec, [image]
                    compact.push('d', step.sec);
                    // é—œéµä¿®æ­£ï¼šåœ–ç‰‡ Base64 å­—ä¸²åœ¨æ­¤è™•é€²è¡Œ URI ç·¨ç¢¼ï¼Œç¢ºä¿å­—ä¸²å®‰å…¨
                    if (step.image) compact.push(encodeURIComponent(step.image)); 
                    return compact;
            }
            return compact;
        });

        // 2. JSON.stringify è½‰æ›ç‚ºå­—ä¸²
        rawJsonString = JSON.stringify(compactScript);
        
        // 3. é—œéµä¿®æ­£ï¼šç§»é™¤å°æ•´å€‹ JSON å­—ä¸²çš„ URI ç·¨ç¢¼ï¼Œè®“æª”æ¡ˆå…§å®¹ä¿æŒç‚ºç´” JSON (Base64 å·²åœ¨æ­¥é©Ÿä¸­ç·¨ç¢¼)
        const dataString = rawJsonString; 
        
    } catch (error) {
        if (!isSilent) {
            statusMessage.textContent = 'âŒ Script data conversion failed.';
        }
        console.error('æ•¸æ“šè½‰æ›å¤±æ•—:', error);
        return false; 
    }
    
    // --- 4. ä¸‹è¼‰ç‚º .txt æª”æ¡ˆ (æ–°å‰¯æª”å) ---
    try {
        // å‰µå»º Blobï¼ŒMIME type è¨­ç‚º text/plain
        const blob = new Blob([rawJsonString], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        a.href = url;
        // ä½¿ç”¨æ–°çš„ .txt å‰¯æª”å
        a.download = `journey_script${FILE_EXTENSION}`; 
        document.body.appendChild(a);
        a.click();
        
        // æ¸…ç†
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        if (!isSilent) {
            statusMessage.textContent = `âœ… File successfully downloaded as journey_script${FILE_EXTENSION}!`;
            setTimeout(() => {
                statusMessage.textContent = 'Ready';
            }, 3000);
        }
        return true;

    } catch (error) {
        if (!isSilent) {
            statusMessage.textContent = 'âŒ File download failed.';
        }
        console.error('File download failed:', error);
        return false;
    }
}


/**
 * è™•ç†æª”æ¡ˆä¸Šå‚³äº‹ä»¶ï¼Œè®€å–æª”æ¡ˆå…§å®¹ä¸¦è¼‰å…¥åŠ‡æœ¬ã€‚
 */
function handleFileUpload(event) {
    const statusMessage = document.getElementById('status-message');
    const file = event.target.files[0];

    // é‡è¨­æª”æ¡ˆè¼¸å…¥ï¼Œä»¥ä¾¿å¯ä»¥é€£çºŒä¸Šå‚³åŒä¸€å€‹æª”æ¡ˆ
    event.target.value = null; 

    if (!file) {
        statusMessage.textContent = 'Ready';
        return;
    }

    // æ¥å— .txt (æ–°çš„) æˆ– .trip (èˆŠçš„) æª”æ¡ˆ
    const acceptedExtensions = ['.txt', '.trip'];
    const isAcceptedFile = acceptedExtensions.some(ext => file.name.toLowerCase().endsWith(ext));

    if (!isAcceptedFile && file.type !== 'text/plain') {
        statusMessage.textContent = `âš ï¸ Invalid file type. Please upload a plain text file in .txt or .trip format.`;
        return;
    }

    const reader = new FileReader();

    reader.onload = (e) => {
        const fileContent = e.target.result;
        
        try {
            // FIX: ç‚ºäº†å…¼å®¹èˆŠç‰ˆé›™é‡ç·¨ç¢¼çš„æª”æ¡ˆï¼Œé€™è£¡å…ˆå˜—è©¦é€²è¡Œä¸€æ¬¡ URI è§£ç¢¼
            let rawJsonString;
            try {
                // å˜—è©¦è§£ç¢¼ (æ‡‰å°èˆŠç‰ˆé›™é‡ç·¨ç¢¼ä¸­çš„å¤–å±¤ç·¨ç¢¼)
                rawJsonString = decodeURIComponent(fileContent);
            } catch (e) {
                // å¦‚æœè§£ç¢¼å¤±æ•—ï¼Œå‰‡å‡è¨­å…§å®¹æœªç·¨ç¢¼ (æ–°ç‰ˆæ ¼å¼)
                rawJsonString = fileContent;
            }
            
            const result = loadImportedData(rawJsonString);
            if (result) {
                statusMessage.textContent = 'âœ… Script file successfully loaded!';
                saveScriptToLocalStorage();
                renderScript(); // é‡æ–°æ¸²æŸ“
            } else {
                statusMessage.textContent = 'âŒ File content is invalid or corrupted.';
            }
        } catch (error) {
            statusMessage.textContent = 'âŒ File parsing failed, please check the content format.';
            console.error('æª”æ¡ˆè§£æå¤±æ•—:', error);
        }
    };

    reader.onerror = () => {
        statusMessage.textContent = 'âŒ Failed to read file.';
        console.error('FileReader error:', reader.error);
    };

    // è®€å–æª”æ¡ˆç‚ºç´”æ–‡å­—
    reader.readAsText(file);
    statusMessage.textContent = `Reading file ${file.name}...`;
}


/**
 * æ¸²æŸ“æ—¥é€²åº¦æ¢ (Day Progress Bar)
 * 1. è¨ˆç®—æ¯å¤©çš„æ­¥é©Ÿæ•¸é‡ã€‚
 * 2. æ ¹æ“šæ¯”ä¾‹æ¸²æŸ“å‚ç›´çš„æ¢æ£’ã€‚
 */
function renderDayProgressBar() {
    const progressBarContainer = document.getElementById('day-progress-bar');
    if (!progressBarContainer) return;

    // æ¸…ç©ºèˆŠå…§å®¹
    progressBarContainer.innerHTML = '';
    
    // ç¢ºä¿ bar å®¹å™¨æ˜¯å‚ç›´å †ç–Šçš„ flex
    progressBarContainer.classList.add('flex', 'flex-col');
    
    // 1. è¨ˆç®—æ¯å¤©çš„æ­¥é©Ÿæ•¸é‡ (å¿½ç•¥ START æ­¥é©Ÿ)
    const dayStepCounts = []; // [Day1_Count, Day2_Count, ...]
    dayStartIndices = [];     // é‡ç½® Day Start Index åˆ—è¡¨
    
    let totalStepsForBar = 0; // ç¸½æ­¥é©Ÿæ•¸ (ä¸å« START)
    let currentDayStepCount = 0;
    let currentDay = 1;
    let dayColorIndex = 0; // 0, 1, 2, ...
    
    // è™•ç† Day 1 çš„é–‹å§‹ (Step 1)
    if (scriptSteps.length > 1) {
        dayStartIndices.push({ day: 1, stepIndex: 1, colorIndex: 0 });
    }

    for (let i = 1; i < scriptSteps.length; i++) {
        const step = scriptSteps[i];
        
        // é‡åˆ° Dayoff æ­¥é©Ÿæ™‚ï¼Œä»£è¡¨å‰ä¸€å¤©è¡Œç¨‹çµæŸ
        if (step.type === 'dayoff') {
            if (currentDayStepCount > 0) {
                dayStepCounts.push(currentDayStepCount);
                totalStepsForBar += currentDayStepCount;
            }
            
            // é€²å…¥ä¸‹ä¸€å¤©
            currentDay++;
            // FIX: ä½¿ç”¨ (currentDay - 1) ç¢ºä¿ç´¢å¼•æ­£ç¢ºè¼ªæ›¿ (1 -> 0, 2 -> 1, 3 -> 0)
            dayColorIndex = (currentDay - 1) % DAY_COLORS_PALETTE.length;
            
            // æª¢æŸ¥ä¸‹ä¸€å¤©æ˜¯å¦æœ‰è¡Œç¨‹ (i + 1 < scriptSteps.length)
            if (i + 1 < scriptSteps.length) {
                dayStartIndices.push({ day: currentDay, stepIndex: i + 1, colorIndex: dayColorIndex });
            }
            
            currentDayStepCount = 0; 
        } else {
            // è¨ˆç®—æ­¥é©Ÿ (goto, activity, show)
            currentDayStepCount++;
        }
    }
    // åŠ ä¸Šæœ€å¾Œä¸€å¤©çš„æ­¥é©Ÿæ•¸ (å¦‚æœå­˜åœ¨)
    if (currentDayStepCount > 0) {
        dayStepCounts.push(currentDayStepCount);
        totalStepsForBar += currentDayStepCount;
    }
    
    // å¦‚æœç¸½æ­¥é©Ÿæ•¸ç‚º 0 (åªæœ‰ START)ï¼Œå‰‡ä½¿ç”¨ä¸€å€‹ä¸­æ€§èƒŒæ™¯
    if (totalStepsForBar === 0) {
        progressBarContainer.classList.add('bg-gray-100');
        return; 
    }

    // 2. æ ¹æ“šæ¯”ä¾‹æ¸²æŸ“æ¢æ£’
    
    // æ¢æ£’èƒŒæ™¯é¡è‰²ä½¿ç”¨ PALETTE ä¸­ä½é£½å’Œåº¦çš„ BG é¡è‰²
    const BAR_COLORS_PALETTE = DAY_COLORS_PALETTE.map(c => c.bg); // bg-X-100
    // æ¢æ£’æ–‡å­—é¡è‰²ä½¿ç”¨ PALETTE ä¸­æ·±è‰²çš„ TEXT é¡è‰²
    const BAR_TEXT_COLORS = DAY_COLORS_PALETTE.map(c => c.text); // text-X-700

    dayStepCounts.forEach((dayCount, index) => {
        const heightPercent = (dayCount / totalStepsForBar) * 100;
        const colorClass = BAR_COLORS_PALETTE[index % BAR_COLORS_PALETTE.length];
        const textColorClass = BAR_TEXT_COLORS[index % BAR_COLORS_PALETTE.length];
        const dayNumber = index + 1; // Day 1, Day 2, ...
        
        const dayBar = document.createElement('div');
        dayBar.id = `day-bar-${dayNumber}`;
        // ä½¿ç”¨ä½é£½å’Œåº¦é¡è‰² (colorClass)
        dayBar.className = `w-full flex-shrink-0 ${colorClass} transition-all duration-500 cursor-pointer hover:bg-opacity-80`;
        dayBar.onclick = () => scrollToDayStart(dayNumber);
        
        // è¨­ç½®é«˜åº¦ (ä½¿ç”¨ style ç¢ºä¿ç²¾ç¢ºçš„ç™¾åˆ†æ¯”)
        dayBar.style.height = `${heightPercent}%`;
        
        // è¦–è¦ºèª¿æ•´ï¼šå¢åŠ  Day X æç¤º (ä½¿ç”¨æ·±è‰²æ–‡å­—)
        dayBar.innerHTML = `<span class="text-xs ${textColorClass} font-bold opacity-80 transition-opacity duration-300">${dayNumber}</span>`;
        dayBar.style.display = 'flex';
        dayBar.style.justifyContent = 'center';
        dayBar.style.alignItems = 'center';
        
        // åƒ…åœ¨æ¢æ£’è¼ƒé«˜æ™‚é¡¯ç¤ºæ•¸å­— (ä¾‹å¦‚ > 5%)
        if (heightPercent < 5) {
            dayBar.querySelector('span').classList.add('hidden');
        }

        progressBarContainer.appendChild(dayBar);
    });
}


/**
 * æ¸²æŸ“åŠ‡æœ¬åˆ—è¡¨
 */
function renderScript() {
    // æ›´æ”¹ç›®æ¨™å®¹å™¨
    const listContainer = document.getElementById('script-list');
    listContainer.innerHTML = '';
    
    // é å…ˆæ¸²æŸ“å¤©æ•¸é€²åº¦æ¢
    renderDayProgressBar(); 
    
    // --- æ—¥æ•¸èˆ‡è¡Œç¨‹è¨ˆæ•¸é‚è¼¯ (Day-Step Numbering) ---
    let currentDay = 1;         // ç•¶å‰æ—¥æ•¸
    let dayStepCount = 0;       // ç•¶å‰æ—¥æ•¸ä¸­çš„è¡Œç¨‹è¨ˆæ•¸ (å¾ 1 é–‹å§‹)
    
    // --- é¡è‰²äº¤æ›¿é‚è¼¯çš„è®Šæ•¸ (æ—¥åˆ†çµ„) ---
    let dayIndex = 0; // 0, 1, 2ï¼Œç”¨æ–¼é¡è‰²è¼ªæ›¿
    
    // ç¢ºä¿ START æ­¥é©Ÿæ˜¯ Day 1 çš„ç¬¬ä¸€éƒ¨åˆ†
    const startStepColor = DAY_COLORS_PALETTE[0]; 


    scriptSteps.forEach((step, index) => {
        
        let displayIndex; // é¡¯ç¤ºçš„ Day-Step å­—ä¸²

        
        // --- éŒ¨é»æ¸²æŸ“ (åœ¨ç•¶å‰æ­¥é©Ÿä¸Šæ–¹) ---
        if (index > 0) {
            // è¨ˆç®—æ’å…¥é»çš„ Day-Step è™Ÿç¢¼ (é€™æ˜¯æ­¥é©Ÿ X æ’å…¥å¾Œæ‡‰æœ‰çš„è™Ÿç¢¼)
            let anchorDay = currentDay;
            let anchorStep = dayStepCount + 1;
            
            if (scriptSteps[index - 1].type === 'dayoff') {
                // å¦‚æœå‰ä¸€å€‹æ˜¯ Dayoffï¼Œå‰‡ Day+1ï¼ŒStep å¾ 1 é–‹å§‹
                anchorDay++;
                anchorStep = 1;
            }
            
            const anchorDisplay = `${anchorDay}-${anchorStep}`;

            // éŒ¨é»ä½¿ç”¨ä¸‹ä¸€å€‹ Day çš„é¡è‰²
            const nextDayIndex = anchorDay % DAY_COLORS_PALETTE.length;
            const anchorColor = DAY_COLORS_PALETTE[nextDayIndex];

            if (index === insertAnchorIndex) {
                // RENDER INLINE ACTION PANEL
                const actionPanel = document.createElement('div');
                // ä½¿ç”¨ä¸‹ä¸€å€‹ Day çš„é¡è‰²
                actionPanel.className = `insert-anchor-panel p-3 my-2 ${anchorColor.bg} rounded-lg border-2 ${anchorColor.border} shadow-md`;
                actionPanel.dataset.index = index;
                // èª¿æ•´ 1: ä¸­æ–‡åŒ–è¡Œç¨‹æ’å…¥é¢æ¿
                actionPanel.innerHTML = `
                    <p class="font-bold text-sm ${anchorColor.text} mb-2 text-center">ğŸ“Œ åœ¨ ${anchorDisplay} æ’å…¥å‹•ä½œ:</p>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <button onclick="addStep('goto', ${index})" class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition duration-150 font-semibold">â¡ï¸ ç§»å‹•</button>
                        <button onclick="addStep('activity', ${index})" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition duration-150 font-semibold">ğŸƒ æ´»å‹•/ç‹€æ…‹</button>
                        <button onclick="addStep('show', ${index})" class="bg-yellow-500 text-gray-800 p-2 rounded-lg hover:bg-yellow-600 transition duration-150 font-semibold">ğŸ’¬ é¡¯ç¤ºè¨Šæ¯</button>
                        <button onclick="addStep('dayoff', ${index})" class="bg-pink-500 text-white p-2 rounded-lg hover:bg-pink-600 transition duration-150 font-semibold">ğŸ›Œ éå¤œä¼‘æ¯</button>
                    </div>
                    <button onclick="clearInsertAnchor()" class="w-full mt-3 text-xs ${anchorColor.text} hover:text-red-600 font-semibold">âŒ å–æ¶ˆæ’å…¥</button>
                `;
                listContainer.appendChild(actionPanel);

            } else {
                // RENDER STANDARD ANCHOR
                const anchorElement = document.createElement('div');
                anchorElement.className = 'insert-anchor transition-all duration-300'; 
                anchorElement.dataset.index = index;
                
                // é»æ“Šæ™‚ï¼Œé¡¯ç¤ºå‹•ä½œé¸é …
                anchorElement.onclick = () => { setInsertAnchor(index); }; 
                
                // èª¿æ•´ 1: ä¸­æ–‡åŒ–éŒ¨é»æ–‡å­—
                anchorElement.innerHTML = `<span class="insert-anchor-text">åœ¨æ­¤æ–°å¢æ­¥é©Ÿ (${anchorDisplay})</span>`;
                listContainer.appendChild(anchorElement);
            }
        }

        
        // --- æ­¥é©Ÿè™Ÿç¢¼èˆ‡æ—¥æ•¸è¨ˆæ•¸æ›´æ–° ---
        if (index === 0) {
            displayIndex = '0'; // èµ·å§‹æ­¥é©Ÿç‚º 0
        } else {
            // æ ¹æ“šå‰ä¸€æ­¥é©Ÿé¡å‹æ›´æ–° Day å’Œ Step Count
            if (scriptSteps[index - 1].type === 'dayoff') {
                currentDay++;
                dayStepCount = 1;
                // FIX: ä½¿ç”¨ (currentDay - 1) ç¢ºä¿ç´¢å¼•æ­£ç¢ºè¼ªæ›¿
                dayIndex = (currentDay - 1) % DAY_COLORS_PALETTE.length; 
            } else {
                dayStepCount++;
            }
            displayIndex = `${currentDay}-${dayStepCount}`;
        }
        
        // --- æ­¥é©Ÿé¡è‰²é‚è¼¯ ---
        let currentDayColor = DAY_COLORS_PALETTE[dayIndex];
        
        const stepElement = document.createElement('div');
        stepElement.id = `step-${index}`;
        // æ­¥é©Ÿå…ƒç´ çš„åŸºæœ¬æ¨£å¼ï¼šåœ“è§’ã€é™°å½±ã€éæ¸¡æ•ˆæœ
        stepElement.className = `p-3 rounded-lg shadow-sm transition-all duration-200 border border-opacity-50 step-card ${currentDayColor.bg} ${currentDayColor.border}`; 
        
        let contentHtml = '';
        let stepColor = currentDayColor.text; // é è¨­ä½¿ç”¨ç•¶å¤©çš„æ–‡å­—é¡è‰²
        let stepIcon = 'ğŸ”¹';

        const isStartStep = index === 0;
        const buttonAction = `executeScript(${isStartStep ? 1 : index})`;
        const startIcon = isStartStep ? 'ğŸ ' : 'â–¶ï¸';
        // èª¿æ•´ 1: ä¸­æ–‡åŒ–æ’­æ”¾æŒ‰éˆ•æ¨™é¡Œ
        const startButtonTitle = isStartStep ? 'å¾é ­é–‹å§‹æ’­æ”¾' : 'å¾æ­¤è™•é–‹å§‹æ’­æ”¾'; 

        
        if (step.type === 'start') {
            // Start Step: å¼·åˆ¶ä½¿ç”¨ Day 1 çš„æ·±è‰²é‚Šæ¡†å’Œçªé¡¯æ–‡å­—è‰² (Day 1 çš„é¡è‰²)
            stepElement.classList.add(startStepColor.border, startStepColor.bg);
            stepElement.classList.remove('border-opacity-50');
            stepColor = startStepColor.text; // ç¢ºä¿æ–‡å­—é¡è‰²ä¸€è‡´
            stepIcon = 'ğŸ“';
            stepElement.classList.remove('step-card:hover');
        } else if (step.type === 'dayoff') {
             // Dayoff æ­¥é©Ÿï¼šä½¿ç”¨ä¸­æ€§è‰²çªé¡¯
            stepElement.classList.remove(currentDayColor.bg, currentDayColor.border);
            stepElement.classList.add('bg-gray-200', 'border-gray-400');
            stepColor = DAY_COLORS_PALETTE[0].text; // ä¿æŒä½¿ç”¨ç¬¬ä¸€çµ„é¡è‰²æ–‡å­—
            stepIcon = 'ğŸ›Œ';
        }
        
        // --- ç…§ç‰‡ä¸Šå‚³/é¡¯ç¤º UI (åœ¨ stepElement å…§) ---
        const fileInputId = `image-upload-${index}`;
        
        const hasImage = !!step.image;
        // èµ·å§‹é» (index 0) ä¸å…è¨±ä¸Šå‚³ç…§ç‰‡
        const imageHtml = !isStartStep ? `
            <!-- éš±è—çš„æª”æ¡ˆè¼¸å…¥å…ƒä»¶ -->
            <input type="file" id="${fileInputId}" style="display:none;" accept="image/*" onchange="handleImageUpload(event, ${index})">
            
            <div class="flex items-center space-x-2 mt-2 pt-2 border-t border-gray-200">
                ${hasImage ? 
                    // Image Preview and Delete Button
                    `<div class="flex items-center space-x-2 p-2 bg-white rounded-lg border shadow-sm">
                        <img src="${step.image}" alt="Uploaded Photo" class="h-8 w-auto rounded object-cover">
                        <span class="text-xs text-gray-600 font-medium whitespace-nowrap">ç…§ç‰‡å·²ä¸Šå‚³</span>
                        <button onclick="removeImage(${index})" 
                                class="text-red-500 hover:text-red-700 p-1 rounded transition duration-150"
                                title="åˆªé™¤ç…§ç‰‡">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>`
                    :
                    // Upload Button
                    `<button onclick="document.getElementById('${fileInputId}').click()" 
                            class="flex items-center bg-gray-100 text-gray-700 text-xs font-semibold px-3 py-2 rounded-lg hover:bg-gray-200 transition duration-150 whitespace-nowrap">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        ä¸Šå‚³ç…§ç‰‡ (é•·é‚Š ${MAX_LONG_SIDE}px)
                    </button>`
                }
            </div>
        ` : '';


        switch (step.type) {
            case 'start':
                // (Start stepColor/Iconå·²åœ¨ä¸Šé¢è¨­å®š)
                
                // çµ„åˆç‚ºå–®ä¸€åº§æ¨™å­—ä¸²
                const startCoordValue = (step.lat && step.lng) ? `${step.lat}, ${step.lng}` : '';

                // èª¿æ•´ 1: ä¸­æ–‡åŒ–èµ·å§‹æ­¥é©Ÿå…§å®¹
                contentHtml = `
                    <p class="text-xs text-red-500 font-semibold mb-2">âš ï¸ é€™æ˜¯**å¼·åˆ¶**çš„æ—…ç¨‹èµ·é»ï¼Œç„¡æ³•åˆªé™¤æˆ–ç§»å‹•ã€‚</p>
                    <span class="font-bold">èµ·å§‹ä½ç½®</span><br>
                    <small>GPS åº§æ¨™ (ç·¯åº¦, ç¶“åº¦, ä¾‹å¦‚: 26.2173, 127.6924):</small>
                    <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                    <input type="text" 
                           class="w-full text-sm border rounded px-2 mt-1" 
                           placeholder="ç·¯åº¦, ç¶“åº¦" 
                           value="${startCoordValue}" 
                           onchange="updateStep(${index}, 'coords', this.value)">
                `;
                break;
            case 'goto':
                // çµ„åˆç‚ºå–®ä¸€åº§æ¨™å­—ä¸²
                const coordValue = (step.lat && step.lng) ? `${step.lat}, ${step.lng}` : '';
                stepIcon = 'â¡ï¸';
                // èª¿æ•´ 1: ä¸­æ–‡åŒ–ç§»å‹•æ­¥é©Ÿå…§å®¹
                contentHtml = `
                    <span class="font-bold">ç§»å‹•è‡³</span>
                    <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="æ­¥é©Ÿæ¨™ç±¤ (ä¾‹å¦‚: æŠµé”ç‰§å¿—è»Šç«™)" value="${step.label || ''}" 
                        onchange="updateStep(${index}, 'label', this.value)">

                    <small>GPS åº§æ¨™ (ç·¯åº¦, ç¶“åº¦, ä¾‹å¦‚: 26.2173, 127.6924):</small>
                    <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                    <input type="text" 
                           class="w-full text-sm border rounded px-2 mt-1" 
                           placeholder="ç·¯åº¦, ç¶“åº¦" 
                           value="${coordValue}" 
                           onchange="updateStep(${index}, 'coords', this.value)">
                    
                    <small class="mt-2 block">ç§»å‹•åœ–ç¤º (é¸å¡«):</small>
                    <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                    <select class="w-full text-sm border rounded px-2 mt-1" 
                        onchange="updateStep(${index}, 'icon', this.value)">
                        <option value="">(ä¿æŒç›®å‰åœ–ç¤º)</option>
                        ${ICON_NAMES.map(item => `<option value="${item.name}" ${step.icon === item.name ? 'selected' : ''}>${item.emoji} ${item.name}</option>`).join('')}
                    </select>
                    
                    <small class="mt-2 block">æŠµé”æ™‚çš„è¨Šæ¯ (é¸å¡«):</small>
                    <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                    <input type="text" 
                           class="w-full text-sm border rounded px-2 mt-1" 
                           placeholder="æŠµé”æ™‚çš„å½ˆå‡ºè¨Šæ¯ (ç•™ç©ºå‰‡ç„¡è¨Šæ¯)" 
                           value="${step.words || ''}" 
                           onchange="updateStep(${index}, 'words', this.value)">
                `;
                break;
            case 'activity':
                // **æ–°é‚è¼¯ï¼šActivity = setIcon (å¯é¸) + wait (å¯é¸)**
                stepIcon = 'ğŸƒ';
                // èª¿æ•´ 1: ä¸­æ–‡åŒ–æ´»å‹•æ­¥é©Ÿå…§å®¹
                contentHtml = `
                    <span class="font-bold">æ´»å‹•/ç‹€æ…‹ (è®Šæ›´åœ–ç¤ºæˆ–ç­‰å¾…)</span>
                    <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="æ­¥é©Ÿæ¨™ç±¤ (ä¾‹å¦‚: æ‹ç…§ç•™å¿µ)" value="${step.label || ''}" 
                        onchange="updateStep(${index}, 'label', this.value)">
                    
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div>
                            <small class="block">åœ–ç¤º (é¸å¡«):</small>
                            <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                            <select class="w-full text-sm border rounded px-2 mt-1" 
                                onchange="updateStep(${index}, 'icon', this.value)">
                                <option value="">(ä¿æŒç›®å‰åœ–ç¤º)</option>
                                ${ICON_NAMES.map(item => `<option value="${item.name}" ${step.icon === item.name ? 'selected' : ''}>${item.emoji} ${item.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <small class="block">æŒçºŒæ™‚é–“ (ç§’, é¸å¡«):</small>
                            <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                            <input type="number" 
                                   class="w-full text-sm border rounded px-2 mt-1" 
                                   placeholder="0" 
                                   value="${step.sec || ''}" 
                                   onchange="updateStep(${index}, 'sec', parseFloat(this.value))">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">å¦‚æœç§’æ•¸ç‚º 0 æˆ–ç©ºç™½ï¼Œå‰‡åªæœƒåŸ·è¡Œåœ–ç¤ºè®Šæ›´ã€‚</p>
                `;
                break;
            case 'show':
                stepIcon = 'ğŸ’¬';
                // ç¢ºä¿ sec æœ‰é»˜èªå€¼ï¼Œä»¥ä¾¿åœ¨æ¸²æŸ“æ™‚é¡¯ç¤º
                const currentSec = step.sec || PHOTO_STANDALONE_DURATION;
                // èª¿æ•´ 1: ä¸­æ–‡åŒ–é¡¯ç¤ºè¨Šæ¯æ­¥é©Ÿå…§å®¹
                contentHtml = `
                    <span class="font-bold">é¡¯ç¤ºè¨Šæ¯/æš«åœ</span>
                    <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="æ­¥é©Ÿæ¨™ç±¤ (ä¾‹å¦‚: è¨Šæ¯: ç‰§å¿—è»Šç«™)" value="${step.label || ''}" 
                        onchange="updateStep(${index}, 'label', this.value)">
                    <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="è¨Šæ¯å…§å®¹ (ç•™ç©ºå‰‡ç„¡å½ˆå‡ºè¦–çª—)" value="${step.words || ''}" 
                        onchange="updateStep(${index}, 'words', this.value)">
                    
                    <small class="mt-2 block">æŒçºŒæ™‚é–“ (ç§’):</small>
                    <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                    <input type="number" 
                           class="w-full text-sm border rounded px-2 mt-1" 
                           placeholder="2.5" 
                           value="${currentSec}" 
                           onchange="updateStep(${index}, 'sec', parseFloat(this.value))">
                    <p class="text-xs text-gray-500 mt-2">
                        å¦‚æœ**æ²’æœ‰**è¨Šæ¯å…§å®¹ï¼šæ­¤æŒçºŒæ™‚é–“ç‚ºåœ°åœ–ä¸Šçš„**æš«åœæ™‚é–“**ã€‚
                        <br>å¦‚æœ**æœ‰**è¨Šæ¯å…§å®¹ï¼šæœ‰ç…§ç‰‡æ™‚ï¼Œå®ƒæœƒèˆ‡ç…§ç‰‡ä¸€èµ·é¡¯ç¤ºï¼›æ²’æœ‰ç…§ç‰‡æ™‚ï¼Œæ­¤æŒçºŒæ™‚é–“ç‚º**å½ˆå‡ºè¦–çª—é¡¯ç¤ºæ™‚é–“**ã€‚
                    </p>
                `;
                break;
            case 'dayoff':
                // (Dayoff stepColorå·²åœ¨ä¸Šé¢è¨­å®š)
                stepIcon = 'ğŸ›Œ';
                // èª¿æ•´ 1: ä¸­æ–‡åŒ–éå¤œä¼‘æ¯æ­¥é©Ÿå…§å®¹
                contentHtml = `
                    <span class="font-bold">éå¤œä¼‘æ¯</span>
                    <p class="text-xs text-gray-500 mt-1 mb-2">åŸ·è¡Œ setIcon='sleep' ä¸¦æ’­æ”¾å¤œé–“å‹•ç•«ã€‚</p>
                    <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="æ­¥é©Ÿæ¨™ç±¤ (ä¾‹å¦‚: è¾¦ç†å…¥ä½å’Œä¼‘æ¯)" value="${step.label || ''}" 
                        onchange="updateStep(${index}, 'label', this.value)">

                    <small>æŒçºŒæ™‚é–“ (ç§’): 
                        <!-- ç§»é™¤ onfocus è§¸ç™¼ Focus -->
                        <input type="number" class="w-20 text-xs border rounded px-1" value="${step.sec}" 
                            onchange="updateStep(${index}, 'sec', parseFloat(this.value))">
                    </small>
                `;
                break;
        }

        stepElement.innerHTML = `
            <div class="flex justify-between items-start mb-1">
                <div class="flex items-center">
                    <span class="${stepColor} font-semibold">${stepIcon} ${displayIndex}. ${step.type.toUpperCase()}</span>
                    <!-- è®Šæ›´ç‚ºåœ–ç¤ºæŒ‰éˆ• -->
                    <button class="ml-2 text-base text-indigo-500 hover:text-indigo-700 transition"
                            onclick="${buttonAction}"
                            title="${startButtonTitle}">
                            ${startIcon}
                    </button>
                </div>
                
                <div class="space-x-1">
                    <!-- Move Up (Disabled if isStartStep or is the second step) -->
                    <button class="text-gray-400 text-sm ${isStartStep || index === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:text-gray-700'}" 
                            onclick="moveStep(${index}, -1)" 
                            ${isStartStep || index === 1 ? 'disabled' : ''}>â¬†ï¸</button>
                    <!-- Move Down (Disabled if isStartStep or is the last step) -->
                    <button class="text-gray-400 text-sm ${isStartStep || index === scriptSteps.length - 1 ? 'opacity-50 cursor-not-allowed' : 'hover:text-gray-700'}" 
                            onclick="moveStep(${index}, 1)" 
                            ${isStartStep || index === scriptSteps.length - 1 ? 'disabled' : ''}>â¬‡ï¸</button>
                    <!-- Delete (Disabled if isStartStep) -->
                    <button class="text-red-400 text-sm ${isStartStep ? 'opacity-50 cursor-not-allowed' : 'hover:text-red-700'}" 
                            onclick="deleteStep(${index})" 
                            ${isStartStep ? 'disabled' : ''}>âŒ</button>
                </div>
            </div>
            ${contentHtml}
            ${imageHtml} <!-- æ’å…¥ç…§ç‰‡ä¸Šå‚³/é¡¯ç¤ºå€å¡Š -->
        `;
        listContainer.appendChild(stepElement);
    });

    // --- FINAL ANCHOR RENDERING ---
    
    // é‡æ–°è¨ˆç®—æœ€å¾Œä¸€å€‹éŒ¨é»çš„ Day-Step è™Ÿç¢¼
    let finalAnchorDay = currentDay;
    let finalAnchorStep = dayStepCount;
    
    if (scriptSteps.length > 0) {
        const lastStep = scriptSteps[scriptSteps.length - 1];
        if (lastStep.type === 'dayoff') {
            finalAnchorDay++;
            finalAnchorStep = 1;
        } else {
            finalAnchorStep++;
        }
    } else {
        // åƒ…åŒ…å«èµ·å§‹æ­¥é©Ÿæ™‚ (Day 1, Step 1)
        finalAnchorDay = 1;
        finalAnchorStep = 1;
    }
    const finalAnchorDisplay = `${finalAnchorDay}-${finalAnchorStep}`;

    // è¨ˆç®—æœ€å¾ŒéŒ¨é»çš„é¡è‰²ç´¢å¼• (ä¸‹ä¸€å€‹ Day çš„é¡è‰²)
    const finalAnchorColor = DAY_COLORS_PALETTE[finalAnchorDay % DAY_COLORS_PALETTE.length];


    // æœ€å¾Œä¸€å€‹éŒ¨é» (åœ¨æœ€å¾Œä¸€å€‹æ­¥é©Ÿä¸‹æ–¹)
    if (scriptSteps.length === insertAnchorIndex) {
        // RENDER FINAL INLINE ACTION PANEL
        const actionPanel = document.createElement('div');
        // ä½¿ç”¨ä¸‹ä¸€å€‹ Day çš„é¡è‰²
        actionPanel.className = `insert-anchor-panel p-3 my-2 ${finalAnchorColor.bg} rounded-lg border-2 ${finalAnchorColor.border} shadow-md`;
        actionPanel.dataset.index = scriptSteps.length;
        // èª¿æ•´ 1: ä¸­æ–‡åŒ–è¡Œç¨‹æ’å…¥é¢æ¿
        actionPanel.innerHTML = `
            <p class="font-bold text-sm ${finalAnchorColor.text} mb-2 text-center">ğŸ“Œ åœ¨ ${finalAnchorDisplay} æ’å…¥å‹•ä½œ (çµæŸ):</p>
            <div class="grid grid-cols-2 gap-2 text-sm">
                <button onclick="addStep('goto', ${scriptSteps.length})" class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition duration-150 font-semibold">â¡ï¸ ç§»å‹•</button>
                <button onclick="addStep('activity', ${scriptSteps.length})" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition duration-150 font-semibold">ğŸƒ æ´»å‹•/ç‹€æ…‹</button>
                <button onclick="addStep('show', ${scriptSteps.length})" class="bg-yellow-500 text-gray-800 p-2 rounded-lg hover:bg-yellow-600 transition duration-150 font-semibold">ğŸ’¬ é¡¯ç¤ºè¨Šæ¯</button>
                <button onclick="addStep('dayoff', ${scriptSteps.length})" class="bg-pink-500 text-white font-bold py-2 rounded-lg hover:bg-pink-600 transition duration-150">ğŸ›Œ éå¤œä¼‘æ¯</button>
            </div>
            <button onclick="clearInsertAnchor()" class="w-full mt-3 text-xs ${finalAnchorColor.text} hover:text-red-600 font-semibold">âŒ å–æ¶ˆæ’å…¥</button>
        `;
        listContainer.appendChild(actionPanel);
    } else {
        // RENDER FINAL STANDARD ANCHOR
        const finalAnchorElement = document.createElement('div');
        finalAnchorElement.className = 'insert-anchor my-2 transition-all duration-300';
        finalAnchorElement.dataset.index = scriptSteps.length;
        finalAnchorElement.onclick = () => { setInsertAnchor(scriptSteps.length); };
        // èª¿æ•´ 1: ä¸­æ–‡åŒ–éŒ¨é»æ–‡å­—
        finalAnchorElement.innerHTML = `<span class="insert-anchor-text">åœ¨æ­¤æ–°å¢æ­¥é©Ÿ (${finalAnchorDisplay})</span>`;
        listContainer.appendChild(finalAnchorElement);
    }
    
    // ç§»é™¤æ‰€æœ‰çš„ Focus/Scroll é‚è¼¯
    
    // è™•ç† [æ‹‰åˆ°æœ€ä¸‹é¢] æŒ‰éˆ•çš„é¡¯ç¤º/éš±è—: ç”±æ–¼æŒ‰éˆ•å·²ç§»é™¤ï¼Œæ­¤è™•ç„¡éœ€å‹•ä½œ
    
    // NEW: æ¸²æŸ“å®Œæˆå¾Œæ›´æ–°ä¸€æ¬¡ä½ˆå±€
    updateMobileLayout();
}
</script>
</head>
<body class="bg-gray-50">
<!-- éŸ¿æ‡‰å¼ä½ˆå±€èª¿æ•´ -->
<div class="flex flex-col md:flex-row h-screen overflow-hidden">
  
  <!-- å³å´åœ°åœ–é¡¯ç¤ºå€ (åœ¨è¡Œå‹•è£ç½®ä¸Šåœ¨ä¸ŠåŠéƒ¨) -->
  <div id="map-container" class="w-full md:w-2/3 relative h-full">
    <div id="map"></div>
    <!-- æ–°å¢ï¼šå¤œé–“å‹•ç•«é®ç½©ã€‚çµ•å°å®šä½è¦†è“‹åœ°åœ– -->
    <div id="night-overlay" class="absolute inset-0 z-[1000]"></div>
  </div>

  <!-- å·¦å´æ§åˆ¶é¢æ¿ (åœ¨è¡Œå‹•è£ç½®ä¸Šåœ¨ä¸‹åŠéƒ¨) -->
  <!-- è®Šæ›´: è¨­ç½®ç‚º Flex Column å®¹å™¨ -->
  <div id="controls" class="w-full md:w-1/3 bg-white shadow-xl relative h-full flex flex-col">
    
    <!-- A. ä¸Šæ–¹å€åŸŸ (ç´… + æ©™) - ä½”æ»¿å‰©é¤˜ç©ºé–“ï¼ŒFlex Row ä½ˆå±€ -->
    <div id="top-area-wrapper" class="flex flex-row flex-grow min-h-0">
        
        <!-- A.1 æ©™è‰²å€å¡Š (å·¦å´é•·æ¢) - å›ºå®šå¯¬åº¦ 16pxï¼Œä½”æ»¿é«˜åº¦ -->
        <!-- ä½¿ç”¨ w-4 (16px)ã€‚å°‡ ID æ”¹ç‚º #day-progress-bar -->
        <div id="day-progress-bar" class="h-full w-4 flex-shrink-0 hidden md:block">
          <!-- æ¯”ä¾‹æ¢æ£’å°‡åœ¨æ­¤è™•æ¸²æŸ“ -->
        </div>

        <!-- A.2 ç´…è‰²å€å¡Šï¼šè¡Œç¨‹åˆ—è¡¨å®¹å™¨ (å³å´ï¼Œå¯æ²å‹•) - ä½”æ»¿å‰©é¤˜å¯¬åº¦ï¼Œè¨­ç½®æ»¾å‹• -->
        <div id="script-list-wrapper" class="flex-grow h-full overflow-y-auto p-4 min-h-0">
          <h1 class="text-2xl font-bold text-indigo-600 mb-4 border-b pb-2 sticky top-0 bg-white z-10">ğŸ—ºï¸ Journey Script Editor (è¡Œç¨‹è…³æœ¬ç·¨è¼¯å™¨)</h1>
          <!-- è…³æœ¬æ­¥é©Ÿåˆ—è¡¨ - é€™æ˜¯æ²å‹•çš„å…§å®¹ -->
          <div id="script-list" class="space-y-3">
            <!-- æ­¥é©Ÿå°‡åœ¨æ­¤è™•æ¸²æŸ“ -->
          </div>
        </div>
    </div> <!-- End #top-area-wrapper -->
    
    <!-- B. ç¶ è‰²/è—è‰²å€å¡Šï¼šå›ºå®šæ“ä½œé¢æ¿ (åº•éƒ¨) - å›ºå®šé«˜åº¦ 190pxï¼Œä¸è¢«å£“ç¸® -->
    <div id="bottom-controls" class="flex-shrink-0 h-[190px] bg-white shadow-2xl p-4 border-t border-gray-200">
      
      <!-- æ’­æ”¾æ§åˆ¶æŒ‰éˆ• -->
      <div class="flex space-x-2 mb-2">
          <!-- æš«åœ/ç¹¼çºŒæŒ‰éˆ• (èª¿æ•´ 1: ä¿æŒè‹±æ–‡) -->
          <button id="pause-resume-button" onclick="pauseToggle()" 
              class="w-1/2 bg-yellow-500 text-gray-800 font-bold py-3 rounded-xl shadow-lg hover:bg-yellow-600 transition duration-300 transform hover:scale-[1.01] text-lg disabled:opacity-50 disabled:cursor-not-allowed" 
              disabled 
              title="Pause Playback">
              <span class="text-lg">â¸ï¸ PAUSE/RESUME</span>
          </button>
           <!-- åœæ­¢æ’­æ”¾æŒ‰éˆ• (èª¿æ•´ 1: ä¿æŒè‹±æ–‡) -->
          <button id="stop-button" onclick="stopScript()" 
              class="w-1/2 bg-gray-500 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-gray-600 transition duration-300 transform hover:scale-[1.01] text-lg disabled:opacity-50 disabled:cursor-not-allowed" 
              disabled 
              title="Stop Playback">
              <span class="text-lg">â—¼ï¸ STOP</span>
          </button>
      </div>

      <!-- æ’­æ”¾æŒ‰éˆ• (èª¿æ•´ 1: ä¿æŒè‹±æ–‡) -->
      <button id="play-button" onclick="executeScript(1)" class="w-full bg-indigo-500 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-[1.01] text-lg mb-2">
        â–¶ï¸ Start Playback (PLAY)
      </button>
      
      <!-- åŒ¯å‡ºèˆ‡åˆªé™¤æŒ‰éˆ• (èª¿æ•´ 1: ä¿æŒè‹±æ–‡) -->
      <div class="flex space-x-2 mb-2">
          <!-- åŒ¯å‡ºæŒ‰éˆ•ï¼šç¾åœ¨æ˜¯ä¸‹è¼‰æª”æ¡ˆ -->
          <button id="export-button" onclick="exportScript()" class="w-1/3 bg-gray-200 text-gray-800 font-bold py-3 rounded-xl shadow-lg hover:bg-gray-300 transition duration-300 transform hover:scale-[1.01] text-lg">
            ğŸ’¾ Export File
          </button>
          <!-- åŒ¯å…¥æŒ‰éˆ•ï¼šç¾åœ¨æ˜¯ä¸Šå‚³æª”æ¡ˆï¼Œé»æ“Šæœƒè§¸ç™¼éš±è—çš„ file input -->
          <button id="import-file-button" onclick="document.getElementById('file-input').click()" class="w-1/3 bg-gray-400 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-gray-500 transition duration-300 transform hover:scale-[1.01] text-lg">
            ğŸ“¤ Import File
          </button>
          <!-- åˆªé™¤æŒ‰éˆ• -->
          <button id="delete-all-button" onclick="promptClearScript()" class="w-1/3 bg-red-400 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-red-600 transition duration-300 transform hover:scale-[1.01] text-lg">
            ğŸ—‘ï¸ DELETE ALL
          </button>
      </div>

      <div id="status-message" class="mt-2 text-center text-sm font-medium text-gray-600">Ready</div>

    </div> <!-- End #bottom-controls -->

  </div> <!-- End #controls -->
</div>

<!-- éš±è—çš„æª”æ¡ˆè¼¸å…¥å…ƒä»¶ -->
<!-- accept="text/plain" æ˜¯è§£æ±º iOS ç›¸å®¹æ€§çš„é—œéµ -->
<input type="file" id="file-input" style="display:none;" accept="text/plain" onchange="handleFileUpload(event)">

<!-- Conflict Modal Structure (è¡Œç¨‹è¡çªæ¨¡æ…‹æ¡†) (èª¿æ•´ 1: ä¿æŒè‹±æ–‡) -->
<div id="conflict-modal-overlay" class="fixed inset-0 bg-black bg-opacity-75 z-[3000] flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none">
    <div id="conflict-modal" class="bg-white p-6 rounded-xl shadow-2xl max-w-lg mx-4 transform scale-90 transition-transform duration-300">
        <h2 class="text-xl font-bold text-indigo-600 mb-4">Script Import Conflict</h2>
        <p class="text-gray-700 mb-6">
            We detected both a script parameter in the URL and non-default script records in your local editing session.
            How would you like to proceed?
        </p>
        <div class="space-y-3">
            <button onclick="handleConflictResolution('cancel')" class="w-full bg-gray-200 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-300 transition">
                1. Cancel Import, Continue Editing Local Script
            </button>
            <button onclick="handleConflictResolution('save_and_import')" class="w-full bg-yellow-500 text-gray-800 font-bold py-3 rounded-lg hover:bg-yellow-600 transition">
                2. ğŸ’¾ Save Local Script THEN Import New Script
            </button>
            <button onclick="handleConflictResolution('overwrite')" class="w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition">
                3. Overwrite Local Script (Import New Script Directly)
            </button>
        </div>
    </div>
</div>

<script>
// --------------------------------------------------------
// åˆå§‹åŒ–ï¼š Leaflet/DOM ä¾è³´çš„ç¨‹å¼ç¢¼ç§»å…¥ DOMContentLoaded
// --------------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
    // ç¢ºä¿ #map å…ƒç´ å­˜åœ¨å¾Œæ‰é€²è¡Œåˆå§‹åŒ–
    mapInstance = L.map('map').setView(INITIAL_GPS, 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(mapInstance);
    marker = L.marker(INITIAL_GPS, { icon: icons.train }).addTo(mapInstance);
    
    // å„ªå…ˆåŸ·è¡Œè¼‰å…¥é‚è¼¯ï¼ˆåŒ…å«è¡çªè™•ç†ï¼‰
    checkAndLoadScriptFromURL(); 
    
    // NEW: Initial layout setup and resize listener
    // åœ¨åˆå§‹åŒ–å¾Œç«‹å³è¨­ç½®ä½ˆå±€å’Œ Leaflet å¤§å°
    updateMobileLayout(); 
    window.addEventListener('resize', updateMobileLayout);
});
</script>
</body>
</html>