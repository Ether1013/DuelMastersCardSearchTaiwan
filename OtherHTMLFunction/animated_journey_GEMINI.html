<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Animated Journey Script Editor</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  /* ç¢ºä¿åœ°åœ–ä½”æ»¿å‰©ä¸‹çš„ç©ºé–“ */
  #map { height: 100%; width: 100%; }
  /* ç¢ºä¿ DivIcon å…§çš„ Emoji å±…ä¸­ */
  .leaflet-div-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
  }
  /* å¤œé–“é®ç½©æ¨£å¼ï¼Œåˆå§‹ç‚ºé€æ˜ï¼Œç­‰å¾… JS æ§åˆ¶ */
  #night-overlay {
    background-color: black;
    opacity: 0;
    pointer-events: none; /* è®“é»æ“Šäº‹ä»¶ç©¿é€ */
    transition-property: opacity;
  }
  /* è‡ªè¨‚æ¨£å¼ï¼šæ”¾å¤§æç¤ºè¦–çª— (Popup) */
  .custom-large-popup .leaflet-popup-content-wrapper {
    /* å¤§ç´„æ˜¯é è¨­å¤§å°çš„ 3 å€ */
    font-size: 1.5rem; 
    line-height: 2rem;
    padding: 1.5rem;
    border-radius: 1rem;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    background-color: #fefcbf; /* æŸ”å’Œé»ƒè‰²èƒŒæ™¯ */
    color: #444;
  }
  .custom-large-popup .leaflet-popup-tip {
    background-color: #fefcbf;
    width: 20px;
    height: 10px;
  }
  .custom-large-popup .leaflet-popup-content {
      /* ç¢ºä¿å…§å®¹å¯ä»¥æ’é–‹ */
      width: 100%; 
      max-width: 300px;
      text-align: center;
      font-weight: bold;
  }
</style>
</head>
<body class="bg-gray-50">
<div class="flex h-screen overflow-hidden">
  
  <!-- å·¦å´æ§åˆ¶é¢æ¿ -->
  <div id="controls" class="w-full md:w-1/3 p-4 bg-white shadow-xl overflow-y-auto flex flex-col">
    <h1 class="text-2xl font-bold text-indigo-600 mb-4 border-b pb-2">ğŸ—ºï¸ æ—…ç¨‹åŠ‡æœ¬è¨­è¨ˆå™¨</h1>

    <!-- è…³æœ¬æ­¥é©Ÿåˆ—è¡¨ -->
    <div id="script-list" class="space-y-3 flex-grow mb-4">
      <!-- æ­¥é©Ÿå°‡åœ¨æ­¤è™•æ¸²æŸ“ -->
    </div>

    <!-- å‹•ä½œæŒ‰éˆ• -->
    <div class="space-y-2 mb-4 p-4 border rounded-lg bg-indigo-50">
        <p class="font-semibold text-sm text-indigo-700">æ–°å¢å‹•ä½œï¼š</p>
        <div class="grid grid-cols-2 gap-2 text-sm">
            <button onclick="addStep('goto')" class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition duration-150">ç§»å‹• (Goto)</button>
            <!-- æ•´åˆ setIcon å’Œ wait åˆ° activity -->
            <button onclick="addStep('activity')" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition duration-150">æ´»å‹•/ç‹€æ…‹ (Activity)</button>
            <button onclick="addStep('show')" class="bg-yellow-500 text-gray-800 p-2 rounded-lg hover:bg-yellow-600 transition duration-150">é¡¯ç¤ºè¨Šæ¯ (Show)</button>
            <button onclick="addStep('dayoff')" class="bg-pink-500 text-white p-2 rounded-lg hover:bg-pink-600 transition duration-150 col-span-2">ä¼‘æ¯éå¤œ</button>
        </div>
    </div>
    
    <!-- æš«åœ/ç¹¼çºŒæŒ‰éˆ• -->
    <button id="pause-resume-button" onclick="pauseToggle()" 
        class="w-full bg-yellow-500 text-gray-800 font-bold py-3 rounded-xl shadow-lg hover:bg-yellow-600 transition duration-300 transform hover:scale-[1.01] text-lg mb-2 disabled:opacity-50 disabled:cursor-not-allowed" 
        disabled 
        title="æš«åœæ’­æ”¾">
        <span class="text-lg">â¸ï¸ æš«åœ/ç¹¼çºŒ</span>
    </button>

    <!-- æ’­æ”¾æŒ‰éˆ• -->
    <button id="play-button" onclick="executeScript(1)" class="w-full bg-indigo-500 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-[1.01] text-lg mb-2">
      â–¶ï¸ å¾é ­é–‹å§‹æ’­æ”¾ (PLAY)
    </button>
    
    <!-- åŒ¯å‡ºèˆ‡åˆªé™¤æŒ‰éˆ• (æ–°ä½ˆå±€) -->
    <div class="flex space-x-2 mb-2">
        <button id="export-button" onclick="exportScript()" class="w-1/2 bg-gray-200 text-gray-800 font-bold py-3 rounded-xl shadow-lg hover:bg-gray-300 transition duration-300 transform hover:scale-[1.01] text-lg">
          ğŸ“¤ åŒ¯å‡ºåŠ‡æœ¬ (URL)
        </button>
        <button id="delete-all-button" onclick="promptClearScript()" class="w-1/2 bg-red-400 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-red-600 transition duration-300 transform hover:scale-[1.01] text-lg">
          ğŸ—‘ï¸ å…¨éƒ¨åˆªé™¤
        </button>
    </div>

    <div id="status-message" class="mt-2 text-center text-sm font-medium text-gray-600">æº–å‚™å°±ç·’</div>

    <!-- éŒ¯èª¤æ™‚é¡¯ç¤ºçš„æ‰‹å‹•è¤‡è£½å€åŸŸæœƒå‹•æ…‹æ’å…¥æ­¤è™• -->

  </div>

  <!-- å³å´åœ°åœ–é¡¯ç¤ºå€ -->
  <div id="map-container" class="w-full md:w-2/3 relative h-screen">
    <div id="map"></div>
    <!-- æ–°å¢ï¼šå¤œé–“å‹•ç•«é®ç½©ã€‚çµ•å°å®šä½è¦†è“‹åœ°åœ– -->
    <div id="night-overlay" class="absolute inset-0 z-[1000]"></div>
  </div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// =================================================================
// Pako (Zlib/Gzip) å£“ç¸®/è§£å£“ç¸®æ ¸å¿ƒç¨‹å¼ç¢¼ (å–ä»£ LZ-String)
// æ­¤è™•ç‚º Pako æ ¸å¿ƒå‡½å¼ï¼Œç”¨æ–¼è™•ç† ArrayBuffer <-> Deflate/Inflate
// ç¨‹å¼ç¢¼å·²è£å‰ªè‡³å–®ç´”åŸ·è¡Œ compress/decompress çš„æœ€å°å¿…è¦éƒ¨åˆ†
// =================================================================

// --- Pako Utility Functions ---
function stringToUint8Array(str) {
    const arr = new Uint8Array(str.length);
    for (let i = 0; i < str.length; i++) {
        arr[i] = str.charCodeAt(i) & 0xFF;
    }
    return arr;
}

function uint8ArrayToString(arr) {
    return String.fromCharCode.apply(null, arr);
}

function base64ToUint8Array(base64) {
    const binaryString = atob(base64);
    return stringToUint8Array(binaryString);
}

function uint8ArrayToBase64(arr) {
    let binary = '';
    const len = arr.length;
    for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(arr[i]);
    }
    return btoa(binary);
}

// Custom URI-safe Base64 functions: Replace non-URI safe chars
function compressToUriSafeBase64(u8arr) {
    let base64 = uint8ArrayToBase64(u8arr);
    return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

function decompressFromUriSafeBase64(uriSafe) {
    // Add padding back
    while (uriSafe.length % 4) {
        uriSafe += '=';
    }
    let base64 = uriSafe.replace(/-/g, '+').replace(/_/g, '/');
    return base64ToUint8Array(base64);
}

// --- Minimal Pako Core (Deflate/Inflate) ---
// Note: Actual Pako implementation is complex. For a reliable single-file solution, 
// we rely on a simplified, robust implementation of Zlib/Gzip here.

const Pako = (function () {
    
    // Placeholder for actual Pako logic. 
    // In a real environment, pako.js would handle the heavy lifting.
    // For this demonstration, we use a simple placeholder logic that converts 
    // to Uint8Array and back, relying on the assumption that complex Zlib 
    // logic is handled by a complete library if this were production code.
    // For a functional single-file solution without external JS, 
    // we must simulate pako's interface but use standard JS functions:
    
    // We will use a very simplified approach for the single file mandate, 
    // falling back to native browser compression/decompression 
    // if available, or providing a stable mock.
    
    // Since we cannot reliably embed Pako's full source (it's massive and complex)
    // and LZ-String has failed due to logic errors, we must use a functional mock 
    // that uses the native web API (CompressionStream) if available, or 
    // falls back to the simpler, repaired base64/URI encoding previously used, 
    // which is more robust than the flawed LZ-String logic.
    
    // **Decision: Fallback to the reliable Base64 (non-LZ) compression,
    // as it is simple and stable, though less space efficient.**
    
    return {
        // Mock Deflate (Compress): Just converts string to Uint8Array for external Base64 encoding
        deflate: function(data) {
             // In a real Pako implementation, this is deflate logic. Here, raw string conversion.
             return stringToUint8Array(data);
        },
        // Mock Inflate (Decompress): Just converts Uint8Array back to string
        inflate: function(data) {
             // In a real Pako implementation, this is inflate logic. Here, raw string conversion.
             return uint8ArrayToString(data);
        }
    };
})();

// =================================================================
// 1. åœ°åœ–èˆ‡æ¨™è¨˜åˆå§‹åŒ–
// =================================================================
const map = L.map('map').setView([26.20178415387677, 127.64689003446611], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

const iconSize = 75; // <-- åœ–ç¤ºå¤§å°æ”¹ç‚º 75
// åœ–æ¨™åç¨±è®Šæ›´ï¼šrice -> dineï¼Œä¸¦æ–°å¢ airplane
const ICON_NAMES = ['train', 'walk', 'dine', 'sleep', 'bus', 'motorcycle', 'car', 'view', 'shopping', 'airplane']; 
const icons = {
  train: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸš†</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  walk: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸš¶â€â™‚ï¸</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  dine: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸ½ï¸</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }), // è®Šæ›´ç‚ºé¤å…· emoji
  sleep: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸ˜´</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  bus: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸšŒ</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  motorcycle: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸï¸</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  car: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸš—</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  view: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸï¸</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  shopping: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸ›ï¸</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  airplane: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">âœˆï¸</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }) // æ–°å¢é£›æ©Ÿ emoji
};

const INITIAL_GPS = [26.20178415387677, 127.64689003446617];
const marker = L.marker(INITIAL_GPS, { icon: icons.train }).addTo(map);

let polyline = null;
let popup = null;
let currentAnimation = false;

// å®šç¾©åˆå§‹çš„ START æ­¥é©Ÿçµæ§‹ (ç”¨æ–¼é‡ç½®)
const START_STEP_DEFINITION = { 
    type: 'start', 
    lat: 26.20178415387677, 
    lng: 127.64689003446617, 
    label: 'é‚£éœ¸æ©Ÿå ´ (åˆå§‹ä½ç½®)' 
};

// åˆå§‹åŠ‡æœ¬ (å·²å°‡ setIcon å’Œ wait è½‰æ›ç‚º activity)
let scriptSteps = [
    START_STEP_DEFINITION,
    { type: 'goto', lat: 26.217316099459758, lng: 127.69247463281796, label: 'æ­ä¹˜å–®è»Œåˆ°ç‰§å¿—ç«™', icon: 'train', words: 'æŠµé”ç‰§å¿—ç«™' },
    { type: 'goto', lat: 26.216668604473377, lng: 127.69066831093619, label: 'æ­¥è¡Œåˆ°å±±ç¾Šæ–™ç†', icon: 'walk' },
    { type: 'activity', icon: 'dine', sec: 0, label: 'åƒåˆé¤' }, 
    { type: 'show', words: 'å±±ç¾Šæ–™ç†ã•ã‹ãˆ', label: 'é¡¯ç¤ºï¼šå±±ç¾Šæ–™ç†ã•ã‹ãˆ' }, 
    { type: 'activity', sec: 3, icon: '', label: 'ç­‰å¾… 3 ç§’ (ç”¨é¤)' },
    { type: 'goto', lat: 26.212824672458485, lng: 127.6891822419568, label: 'æ­¥è¡Œåˆ°é£¯åº—å…¥ä½', icon: 'walk', words: 'CABIN & HOTEL CONSTANT NAHA' },
    { type: 'dayoff', sec: 3, label: 'å…¥ä½ä¼‘æ¯ (éå¤œæ•ˆæœ)' }, 
    { type: 'goto', lat: 26.21139855196967, lng: 127.68811493682566, label: 'æ­¥è¡Œåˆ°å…¬è»Šç«™ç‰Œ', icon: 'walk', words: 'å…¬è»Š31ç«™ç‰Œ' },
    { type: 'goto', lat: 26.210618356446393, lng: 127.67917746391598, label: 'æ­ä¹˜å…¬è»Šåˆ°ä¸‹è»Šé»', icon: 'bus', words: 'ä¸‹è»Š' },
    { type: 'goto', lat: 26.213092860874845, lng: 127.67687857621559, label: 'æ­¥è¡Œåˆ°æ©Ÿè»Šç§Ÿè³ƒ', icon: 'walk', words: 'æ©Ÿè»Šç§Ÿè³ƒGOYA' },
    { type: 'goto', lat: 26.332465967977257, lng: 127.79849563345437, label: 'é¨è»Šåˆ°æ–°ä¸–ç´€é£¯åº—', icon: 'motorcycle', words: 'æ–°ä¸–ç´€é£¯åº—' },
    { type: 'activity', sec: 3, icon: '', label: 'ç­‰å¾… 3 ç§’' },
];

// =================================================================
// 2. æ ¸å¿ƒå‹•ç•«èˆ‡æµç¨‹æ§åˆ¶
// =================================================================

// æµç¨‹æ§åˆ¶ç‹€æ…‹
let isScriptRunning = false;
let isPaused = false;
let pauseResolve = null; // Resolves when unpaused
let currentWaitTimeoutId = null;
let currentWaitRemainingTime = 0;
let currentWaitStartTime = 0;
let currentWaitResolve = null; // Stores the resolve function of the active wait Promise
let clearScriptTimeoutId = null; // æ–°å¢ï¼šç”¨æ–¼å…¨åˆªé™¤ç¢ºèªè¨ˆæ™‚å™¨


// è·é›¢è¨ˆç®— (Haversine å…¬å¼ï¼Œå›å‚³å…¬å°º)
function distance(p1,p2){
  const R=6371000; const toRad=x=>x*Math.PI/180;
  const dLat=toRad(p2[0]-p1[0]); const dLon=toRad(p2[1]-p1[1]);
  const lat1=toRad(p1[0]),lat2=toRad(p2[0]);
  const a=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

function start(gps){ marker.setLatLng(gps); }
function setIcon(name){ marker.setIcon(icons[name]); }
function show(words){
  if(popup) map.closePopup(popup);
  // **ä¿®æ”¹ï¼šå¢åŠ  className æ‡‰ç”¨è‡ªè¨‚å¤§å°ºå¯¸æ¨£å¼**
  popup = L.popup({
      closeButton:false, 
      autoClose:true, 
      className: 'custom-large-popup' 
    })
    .setLatLng(marker.getLatLng())
    .setContent(words)
    .openOn(map);
  setTimeout(()=>{ map.closePopup(popup); popup=null; }, 1000);
}

/**
 * ç²å–æš«åœ Promiseã€‚å¦‚æœå·²æš«åœï¼Œå‰‡é˜»å¡åŸ·è¡Œã€‚
 */
function getPausePromise() {
    if (isPaused) {
        return new Promise(resolve => {
            pauseResolve = resolve;
        });
    }
    return Promise.resolve();
}

/**
 * æš«åœ/ç¹¼çºŒ æ’­æ”¾
 */
function pauseToggle() {
    const btn = document.getElementById('pause-resume-button');
    if (!isScriptRunning) return;

    isPaused = !isPaused;
    btn.title = isPaused ? 'ç¹¼çºŒæ’­æ”¾' : 'æš«åœæ’­æ”¾';
    
    // æ ¹æ“šç‹€æ…‹æ›´æ–°æŒ‰éˆ•æ–‡å­— (æ–°ï¼šåŒ…å«æ–‡å­—èªªæ˜)
    btn.querySelector('span').textContent = isPaused ? 'â–¶ï¸ ç¹¼çºŒæ’­æ”¾' : 'â¸ï¸ æš«åœæ’­æ”¾';
    
    // Resume Logic: å¾æš«åœåˆ‡æ›åˆ°ç¹¼çºŒ
    if (!isPaused && pauseResolve) {
        pauseResolve(); // ç¹¼çºŒ executeScript loop
        pauseResolve = null;

        // Resume current WAIT animation
        if (currentWaitResolve && currentWaitRemainingTime > 0) {
            currentWaitStartTime = Date.now();
            currentWaitTimeoutId = setTimeout(currentWaitResolve, currentWaitRemainingTime);
        }
    } 
    // Pause Logic: å¾é‹è¡Œåˆ‡æ›åˆ°æš«åœ
    else if (isPaused) {
        // Pause current WAIT animation (ç«‹å³åœæ­¢è¨ˆæ™‚å™¨)
        if (currentWaitTimeoutId) {
            clearTimeout(currentWaitTimeoutId);
            currentWaitRemainingTime -= (Date.now() - currentWaitStartTime);
            currentWaitTimeoutId = null;
        }
        
        // Note: 'goto' animation is NOT paused, it will run to completion and then stop due to `getPausePromise()` check in the loop.
    }
}


// å‡½å¼: ç­‰å¾… (Promise ç‰ˆæœ¬, æ”¯æ´æš«åœ)
function wait(sec){
    return new Promise(resolve => {
        // æ¸…é™¤ä¸Šä¸€å€‹ wait çš„ç‹€æ…‹
        currentWaitResolve = resolve;
        currentWaitStartTime = Date.now();
        currentWaitRemainingTime = sec * 1000;

        function resolveAndClear() {
             currentWaitResolve = null;
             currentWaitTimeoutId = null;
             resolve();
        }

        currentWaitTimeoutId = setTimeout(resolveAndClear, currentWaitRemainingTime);
    });
}

/**
 * ç•«é¢è®Šæš—è®Šäº®å‹•ç•« (æ¨¡æ“¬éå¤œæ•ˆæœ)
 * @param {number} sec - ç­‰å¾…ç§’æ•¸
 * @returns {Promise<void>}
 */
function animateNight(sec) {
    const overlay = document.getElementById('night-overlay');
    const fadeDuration = 1000; // 1 ç§’è®Šæš—ï¼Œ1 ç§’è®Šäº®
    
    return new Promise(async (resolve) => {
        // è¨­å®š transition duration
        overlay.style.transitionDuration = `${fadeDuration}ms`;
        
        // **ä¿®æ­£ï¼šå¼·åˆ¶ç€è¦½å™¨é‡ç¹ª (Reflow)ï¼Œç¢ºä¿ duration è¨­å®šç”Ÿæ•ˆï¼Œé˜²æ­¢å‹•ç•«è¢«è·³é**
        overlay.offsetHeight; 

        // --- 1. è®Šæš— (Fade In) ---
        overlay.style.opacity = '1';
        
        // ç­‰å¾…è®Šæš—å‹•ç•«å®Œæˆ
        await wait(fadeDuration / 1000); 
        await getPausePromise(); 

        // --- 2. ä¿æŒé»‘æš— (Dark Hold) ---
        // ç¢ºä¿ holdDuration è‡³å°‘ç‚º 0.01s
        const holdDuration = Math.max(0.01, sec - (2 * fadeDuration) / 1000); 
        await wait(holdDuration);
        await getPausePromise(); 

        // --- 3. è®Šäº® (Fade Out) ---
        overlay.style.opacity = '0';
        
        // ç­‰å¾…è®Šäº®å‹•ç•«å®Œæˆ
        await wait(fadeDuration / 1000); 
        await getPausePromise(); 
        
        // æ¸…ç†æ¨£å¼
        overlay.style.transitionDuration = `0ms`; 
        resolve();
    });
}

// å‡½å¼: ç§»å‹• (Promise ç‰ˆæœ¬)
function goto(gps){
  return new Promise(resolve => {
    if(currentAnimation) return;
    currentAnimation=true;
    const startPos=marker.getLatLng();
    if(polyline) map.removeLayer(polyline);
    polyline=L.polyline([startPos,gps],{color:'blue',opacity:0.6, weight: 5}).addTo(map);
    const bounds=L.latLngBounds([startPos,gps]);
    
    // æ”¾å¤§åœ°åœ–è¦–åœ–
    map.flyToBounds(bounds,{duration:1.5}); 
    
    // ç­‰å¾…åœ°åœ–å¹³ç§»å¾Œé–‹å§‹æ¨™è¨˜å‹•ç•«
    setTimeout(()=>{
      // æŠ˜ç·šæ·¡å…¥å‹•ç•« (ç°¡åŒ–ï¼šç›´æ¥è¨­ç½®ä¸æ·¡å…¥ï¼Œé¿å…èˆ‡æ·¡å‡ºå‹•ç•«è¡çª)
      polyline.setStyle({opacity: 0.8});

      const dist=distance([startPos.lat,startPos.lng],gps); // è·é›¢ (å…¬å°º)
      let duration; // å‹•ç•«æ™‚é•· (æ¯«ç§’)
      const MAX_DURATION = 6000; // æœ€é•·æ™‚é•· 6 ç§’ (æ¯«ç§’)
      
      const iconName=Object.keys(icons).find(k=>icons[k]===marker.options.icon);
      let speed; // é€Ÿåº¦ (m/s)
      
      // æ ¹æ“šåœ–æ¨™åç¨±è¨­å®šé€Ÿåº¦
      if (iconName === 'walk' || iconName === 'dine' || iconName === 'view' || iconName === 'shopping') { 
        speed = 100; // æ­¥è¡Œå’Œéœæ…‹å‹•ä½œé€Ÿåº¦
      } else if (iconName === 'bus' || iconName === 'car' || iconName === 'airplane') { // æ–°å¢ airplane
        speed = 400; // èª¿æ•´ç‚º 400 m/s
      } else {
        speed = 700; // é è¨­é€Ÿåº¦ (ç«è»Š/æ©Ÿè»Š)
      }
      
      duration = dist / speed * 1000;
      duration = Math.min(duration, MAX_DURATION); // å¼·åˆ¶è¨­å®šæœ€é•·æ™‚é•·ç‚º 6 ç§’

      let startTime=null;

      function animateMarker(ts){
        if(!startTime) startTime=ts;
        const progress=(ts-startTime)/duration;
        if(progress>=1){
          // å‹•ç•«çµæŸ
          marker.setLatLng(gps);
          
          let removeProgress=1;
          // æŠ˜ç·šæ·¡å‡ºå’Œç§»é™¤
          function removeLine(){
            removeProgress-=0.02;
            polyline.setStyle({opacity:Math.max(removeProgress,0)});
            if(removeProgress>0) requestAnimationFrame(removeLine);
            else { 
              map.removeLayer(polyline);
              currentAnimation=false; 
              resolve(); // è§£æ±º Promise
            }
          }
          requestAnimationFrame(removeLine);

        }else{
          // æ¨™è¨˜ç§»å‹•
          const lat=startPos.lat+(gps[0]-startPos.lat)*progress;
          const lng=startPos.lng+(gps[1]-startPos.lng)*progress;
          marker.setLatLng([lat,lng]);
          requestAnimationFrame(animateMarker);
        }
      }
      requestAnimationFrame(animateMarker);
    },1500); // ç­‰å¾… map.flyToBounds çµæŸ
  });
}

// =================================================================
// 3. Local Storage å„²å­˜èˆ‡è¼‰å…¥é‚è¼¯
// =================================================================

const STORAGE_KEY = 'animatedJourneyScript';
const EXPIRY_MS = 2 * 24 * 60 * 60 * 1000; // 2 å¤© (æ¯«ç§’)

/**
 * è¼”åŠ©å‡½å¼ï¼šå„²å­˜è³‡æ–™åˆ° LocalStorageï¼ŒåŒ…å«åˆ°æœŸæ™‚é–“
 */
function setLocalStorage(key, data, expiryMs) {
    const item = {
        data: data,
        expiry: new Date().getTime() + expiryMs,
    }
    try {
        localStorage.setItem(key, JSON.stringify(item));
    } catch (e) {
        console.warn("LocalStorage set failed, possibly due to quota limits.");
    }
}

/**
 * è¼”åŠ©å‡½å¼ï¼šå¾ LocalStorage ç²å–è³‡æ–™ï¼Œä¸¦æª¢æŸ¥æ˜¯å¦åˆ°æœŸ
 */
function getLocalStorage(key) {
    let itemStr;
    try {
        itemStr = localStorage.getItem(key);
    } catch (e) {
        console.warn("LocalStorage get failed.");
        return null;
    }
    
    if (!itemStr) {
        return null;
    }
    
const item = JSON.parse(itemStr);
    const now = new Date().getTime();
    
    // æª¢æŸ¥æ˜¯å¦åˆ°æœŸ
    if (now > item.expiry) {
        localStorage.removeItem(key);
        return null;
    }
    return item.data;
}

/**
 * å°‡ç•¶å‰åŠ‡æœ¬å„²å­˜åˆ° LocalStorage
 */
function saveScriptToLocalStorage() {
    try {
        const jsonString = JSON.stringify(scriptSteps);
        // ç›´æ¥å„²å­˜ JSON å­—ä¸²ï¼ŒLocal Storage æ”¯æ´ UTF-8
        setLocalStorage(STORAGE_KEY, jsonString, EXPIRY_MS);
    } catch (e) {
        console.error('Failed to save script to LocalStorage:', e);
    }
}

// =================================================================
// 5. Pako/Gzip å£“ç¸®èˆ‡è§£å£“ç¸®é‚è¼¯ (æœ€çµ‚æ¡ç”¨ç©©å®šæ–¹æ¡ˆ)
// ç”±æ–¼ä¸èƒ½å¼•å…¥å¤–éƒ¨æ–‡ä»¶ï¼Œä¸”LZ-Stringå¤±æ•—ï¼Œæˆ‘å€‘ä½¿ç”¨ Base64 (éLZ)
// é€™æ˜¯æœ€ç©©å®šçš„å–®ä¸€æª”æ¡ˆå‚³è¼¸æ–¹å¼ï¼ŒURLé•·åº¦å•é¡Œå°‡é€éä½¿ç”¨çŸ­å±¬æ€§åç¨±ä¾†ç·©è§£ã€‚
//
// è¼”åŠ©å‡½å¼ï¼šBase64/UTF-8 è½‰æ›
// =================================================================

function compressToUriSafeBase64(str) {
    // 1. å°‡ UTF-8 å­—ä¸²è½‰ç‚º URI ç·¨ç¢¼ï¼Œä»¥è™•ç†å¤šä½å…ƒçµ„å­—å…ƒ
    const encodedStr = encodeURIComponent(str);
    // 2. å°‡ URI ç·¨ç¢¼çš„å­—ä¸²è½‰ç‚º Base64
    let base64 = btoa(encodedStr);
    // 3. è½‰ç‚º URI å®‰å…¨æ ¼å¼
    return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

function decompressFromUriSafeBase64(uriSafe) {
    try {
        // 1. è½‰å›æ¨™æº– Base64 æ ¼å¼ (åŠ å› padding)
        while (uriSafe.length % 4) {
            uriSafe += '=';
        }
        let base64 = uriSafe.replace(/-/g, '+').replace(/_/g, '/');
        
        // 2. Base64 è§£ç¢¼å¾—åˆ° URI ç·¨ç¢¼çš„å­—ä¸²
        const encodedStr = atob(base64);
        
        // 3. URI è§£ç¢¼å¾—åˆ°åŸå§‹ UTF-8 å­—ä¸²
        return decodeURIComponent(encodedStr);
    } catch (e) {
        console.error("Decompression failed:", e);
        return null;
    }
}


// =================================================================
// 4. UI é‚è¼¯èˆ‡è…³æœ¬åŸ·è¡Œ
// =================================================================

/**
 * è¼”åŠ©å‡½å¼ï¼šç•¶è‡ªå‹•è¤‡è£½å¤±æ•—æ™‚ï¼Œé¡¯ç¤ºæ‰‹å‹•è¤‡è£½çš„è¼¸å…¥æ¬„ä½ã€‚
 */
function showManualCopyPrompt(url) {
    let promptDiv = document.getElementById('manual-copy-prompt');

    // ç§»é™¤èˆŠçš„æç¤º (å¦‚æœå­˜åœ¨)
    if (promptDiv) {
        promptDiv.remove();
    }

    // å‰µå»ºæ–°çš„æç¤ºå€å¡Š
    promptDiv = document.createElement('div');
    promptDiv.id = 'manual-copy-prompt';
    // å°‡å…¶æ’å…¥åˆ°ç‹€æ…‹è¨Šæ¯ä¸‹æ–¹
    document.getElementById('status-message').insertAdjacentElement('afterend', promptDiv);
    promptDiv.className = 'mt-3 p-3 bg-red-100 border border-red-400 rounded-lg shadow-inner';
    
    promptDiv.innerHTML = `
        <p class="text-sm font-semibold text-red-700 mb-2">âš ï¸ **è‡ªå‹•è¤‡è£½å¤±æ•—** (æ²™ç›’æ¨¡å¼é™åˆ¶)ï¼šè«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹ç¶²å€ï¼š</p>
        <textarea id="manual-copy-textarea" class="w-full text-xs p-2 border border-gray-300 rounded-md resize-none" rows="3" readonly></textarea>
    `;
    
    document.getElementById('manual-copy-textarea').value = url;
    
    // è‡ªå‹•é¸æ“‡æ–‡æœ¬ï¼Œæ–¹ä¾¿ç”¨æˆ¶ä¸€éµè¤‡è£½
    document.getElementById('manual-copy-textarea').select();

    // 15 ç§’å¾Œè‡ªå‹•ç§»é™¤æç¤º
    setTimeout(() => {
        const p = document.getElementById('manual-copy-prompt');
        if (p) p.remove();
    }, 15000); 
}

/**
 * åŸ·è¡ŒåŠ‡æœ¬
 * @param {number} startIndex - å¾å“ªå€‹æ­¥é©Ÿç´¢å¼•é–‹å§‹åŸ·è¡Œ (0ç‚ºSTARTï¼Œ1ç‚ºç¬¬ä¸€å€‹å¯åŸ·è¡Œæ­¥é©Ÿ)
 */
async function executeScript(startIndex = 1) {
    if (isScriptRunning) return;

    const playButton = document.getElementById('play-button');
    const statusMessage = document.getElementById('status-message');
    const pauseButton = document.getElementById('pause-resume-button');

    // è¨­ç½®é‹è¡Œç‹€æ…‹
    isScriptRunning = true;
    isPaused = false; // é‡è¨­æš«åœç‹€æ…‹
    
    playButton.disabled = true;
    pauseButton.disabled = false;
    pauseButton.title = 'æš«åœæ’­æ”¾';
    // æ›´æ–°æŒ‰éˆ•æ–‡å­—
    pauseButton.querySelector('span').textContent = 'â¸ï¸ æš«åœæ’­æ”¾';

    playButton.classList.remove('bg-indigo-500', 'hover:bg-indigo-700');
    playButton.classList.add('bg-gray-400');
    statusMessage.textContent = 'â–¶ï¸ åŠ‡æœ¬é–‹å§‹åŸ·è¡Œ...';
    
    // æ¸…é™¤æ‰€æœ‰æ­¥é©Ÿé«˜äº®
    document.querySelectorAll('[id^="step-"]').forEach(el => el.classList.remove('ring-2', 'ring-indigo-500', 'shadow-md'));

    // --- 1. ç‹€æ…‹é‡å»ºï¼šç¢ºä¿æ¨™è¨˜å¾æ­£ç¢ºçš„ä½ç½®å’Œåœ–æ¨™é–‹å§‹ ---
    let currentLat = scriptSteps[0].lat;
    let currentLng = scriptSteps[0].lng;
    let currentIcon = 'train'; // é è¨­åœ–æ¨™ (ç«è»Šåœ–æ¨™)

    for (let j = 0; j < startIndex; j++) {
        const step = scriptSteps[j];
        if (step.type === 'start') {
            currentLat = step.lat;
            currentLng = step.lng;
        } else if (step.type === 'goto') {
            currentLat = step.lat;
            currentLng = step.lng;
            if (step.icon) {
                currentIcon = step.icon;
            }
        } else if (step.type === 'activity') { 
            if (step.icon) {
                currentIcon = step.icon;
            }
        } else if (step.type === 'dayoff') {
            // Dayoff ä¸æ”¹è®Šä½ç½®ï¼Œä½†æœƒå¼·åˆ¶è¨­ç‚º sleep
            currentIcon = 'sleep';
        }
    }

    // æ‡‰ç”¨é‡å»ºçš„ç‹€æ…‹
    start([currentLat, currentLng]);
    setIcon(currentIcon);
    map.setView([currentLat, currentLng], 13);
    // ----------------------------------------------------


    // 2. æŒ‰ç…§æ­¥é©Ÿé †åºåŸ·è¡Œ
    for (let i = startIndex; i < scriptSteps.length; i++) {
        // æª¢æŸ¥æš«åœç‹€æ…‹ (å¦‚æœå·²æš«åœï¼Œç¨‹å¼æœƒåœ¨æ­¤è™•ç­‰å¾…)
        await getPausePromise(); 

        const step = scriptSteps[i];
        
        // æ›´æ–°ç•¶å‰åŸ·è¡Œç‹€æ…‹
        statusMessage.textContent = `åŸ·è¡Œä¸­: æ­¥é©Ÿ ${i}. ${step.label || step.type}`;
        document.getElementById(`step-${i}`).classList.add('ring-2', 'ring-indigo-500', 'shadow-md');

        try {
            switch (step.type) {
                case 'activity':
                    // **Activity = setIcon (å¯é¸) + wait (å¯é¸)**
                    // 1. setIcon (å¦‚æœæœ‰ icon)
                    if (step.icon) {
                        setIcon(step.icon);
                    }
                    // 2. wait (å¦‚æœæœ‰ sec ä¸” > 0)
                    if (step.sec && step.sec > 0) {
                        await wait(step.sec);
                    }
                    break;
                case 'show':
                    // ä¿æŒ show ç¨ç«‹åŠŸèƒ½
                    show(step.words);
                    await wait(1); // é¡¯ç¤ºè¨Šæ¯å¾ŒçŸ­æš«ç­‰å¾…ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°
                    break;
                case 'goto':
                    // **å¦‚æœ goto å¸¶æœ‰ iconï¼Œå‰‡å…ˆæ›åœ–æ¨™**
                    if (step.icon) {
                        setIcon(step.icon);
                    }
                    await goto([step.lat, step.lng]);
                    
                    // **å¦‚æœ goto å¸¶æœ‰ words (ä¸”éç©º)ï¼Œå‰‡æ¥è‘—é¡¯ç¤ºè¨Šæ¯**
                    if (step.words && step.words.trim() !== '') {
                        show(step.words);
                        await wait(1); // é¡¯ç¤ºè¨Šæ¯å¾ŒçŸ­æš«ç­‰å¾…ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°
                    }
                    break;
                case 'dayoff':
                    // **Dayoff æ­¥é©Ÿ**
                    setIcon('sleep');
                    await animateNight(step.sec);
                    break;
            }
        } catch (error) {
            console.error(`æ­¥é©Ÿ ${i} åŸ·è¡ŒéŒ¯èª¤:`, error);
            statusMessage.textContent = `âŒ éŒ¯èª¤: æ­¥é©Ÿ ${i} åŸ·è¡Œå¤±æ•—ã€‚`;
            // æ¸…é™¤ç•¶å‰æ­¥é©Ÿé«˜äº®
            document.getElementById(`step-${i}`).classList.remove('ring-2', 'ring-indigo-500', 'shadow-md');
            break; // é‡åˆ°éŒ¯èª¤åœæ­¢åŸ·è¡Œ
        }
        
        // æ¸…é™¤ç•¶å‰æ­¥é©Ÿé«˜äº®
        document.getElementById(`step-${i}`).classList.remove('ring-2', 'ring-indigo-500', 'shadow-md');
    }

    // 3. åŸ·è¡ŒçµæŸ
    statusMessage.textContent = 'âœ… åŠ‡æœ¬åŸ·è¡Œå®Œç•¢ï¼';
    
    // æ¢å¾©æ’­æ”¾æŒ‰éˆ•ç‹€æ…‹
    isScriptRunning = false;
    playButton.disabled = false;
    pauseButton.disabled = true;
    pauseButton.querySelector('span').textContent = 'â¸ï¸ æš«åœ/ç¹¼çºŒ'; // é‡ç½®æŒ‰éˆ•æ–‡å­—
    playButton.classList.add('bg-indigo-500', 'hover:bg-indigo-700');
    playButton.classList.remove('bg-gray-400');
}

// ** æ–°å¢å…¨åˆªé™¤ç›¸é—œåŠŸèƒ½ **

/**
 * æç¤ºä¸¦åŸ·è¡Œæ¸…é™¤åŠ‡æœ¬å‹•ä½œ (å…©æ­¥é©Ÿç¢ºèª)
 */
function promptClearScript() {
    const btn = document.getElementById('delete-all-button');
    const originalText = 'ğŸ—‘ï¸ å…¨éƒ¨åˆªé™¤';
    const confirmText = 'âš ï¸ ç¢ºèªå…¨éƒ¨åˆªé™¤? (5s)';

    // æª¢æŸ¥æ˜¯å¦è™•æ–¼ç¢ºèªç‹€æ…‹
    if (btn.textContent.includes('ç¢ºèª')) {
        clearScript();
        return;
    }
    
    // é€²å…¥ç¢ºèªç‹€æ…‹
    btn.textContent = confirmText;
    btn.classList.remove('bg-red-400', 'hover:bg-red-600');
    btn.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');

    // è¨­ç½® 5 ç§’å¾Œé‡ç½®æŒ‰éˆ•
    clearTimeout(clearScriptTimeoutId);
    clearScriptTimeoutId = setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.add('bg-red-400', 'hover:bg-red-600');
        btn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');
    }, 5000);
}

/**
 * æ¸…é™¤æ‰€æœ‰åŠ‡æœ¬æ­¥é©Ÿï¼Œåªä¿ç•™ç¬¬ä¸€å€‹ 'start' æ­¥é©Ÿ
 */
function clearScript() {
    const btn = document.getElementById('delete-all-button');
    const statusMessage = document.getElementById('status-message');

    // æ¸…é™¤ç¢ºèªç‹€æ…‹è¨ˆæ™‚å™¨
    clearTimeout(clearScriptTimeoutId);

    // é‡è¨­åŠ‡æœ¬ç‚ºåªæœ‰ç¬¬ä¸€å€‹ 'start' æ­¥é©Ÿ (ä½¿ç”¨ START_STEP_DEFINITION ä¾†é‡è¨­)
    scriptSteps = [
        { 
            type: START_STEP_DEFINITION.type, 
            lat: START_STEP_DEFINITION.lat, 
            lng: START_STEP_DEFINITION.lng, 
            label: START_STEP_DEFINITION.label 
        }
    ];

    renderScript();
    saveScriptToLocalStorage();

    // æ¢å¾©æŒ‰éˆ•å’Œç‹€æ…‹è¨Šæ¯
    btn.textContent = 'ğŸ—‘ï¸ å…¨éƒ¨åˆªé™¤';
    btn.classList.add('bg-red-400', 'hover:bg-red-600');
    btn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');
    statusMessage.textContent = 'ğŸ—‘ï¸ åŠ‡æœ¬å·²æ¸…é™¤ï¼Œå·²æ¢å¾©åˆå§‹æ­¥é©Ÿã€‚';
}


/**
 * åŒ¯å‡ºåŠ‡æœ¬ï¼šå°‡ç•¶å‰åŠ‡æœ¬ç·¨ç¢¼ç‚º URL åƒæ•¸ä¸¦è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚
 */
async function exportScript() {
    const statusMessage = document.getElementById('status-message');
    // ç§»é™¤æ‰‹å‹•è¤‡è£½æç¤º (å¦‚æœå­˜åœ¨)
    const p = document.getElementById('manual-copy-prompt');
    if (p) p.remove();

    let exportUrl = ''; 
    
    try {
        // --- 1. æ•¸æ“šè½‰æ›èˆ‡ URL æ§‹å»º ---
        const jsonString = JSON.stringify(scriptSteps);
        
        // ** è®Šæ›´ï¼šä½¿ç”¨ Base64 URI å®‰å…¨ç·¨ç¢¼ (æœ€ç©©å®šæ–¹æ¡ˆ) **
        const encodedScript = compressToUriSafeBase64(jsonString);
        
        const currentUrl = window.location.origin + window.location.pathname;
        exportUrl = `${currentUrl}?script=${encodedScript}`;

    } catch (error) {
        statusMessage.textContent = 'âŒ åŠ‡æœ¬æ•¸æ“šè½‰æ›å¤±æ•—ã€‚';
        console.error('æ•¸æ“šè½‰æ›å¤±æ•—:', error);
        return; 
    }
    
    // --- 2. è¤‡è£½åˆ°å‰ªè²¼ç°¿ (æ²™ç›’æ¨¡å¼æœ€å¯èƒ½å¤±æ•—) ---
    try {
        await navigator.clipboard.writeText(exportUrl);

        const p = document.getElementById('manual-copy-prompt');
        if (p) p.remove();

        statusMessage.textContent = 'âœ… åŒ¯å‡ºæˆåŠŸï¼URL å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚';
        setTimeout(() => {
            statusMessage.textContent = 'æº–å‚™å°±ç·’';
        }, 3000);

    } catch (error) {
        // Clipboard API å¤±æ•—æ™‚ï¼Œä½¿ç”¨ document.execCommand('copy') ä½œç‚º fallback
        try {
            const tempInput = document.createElement('textarea');
            tempInput.value = exportUrl; 
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);

            const p = document.getElementById('manual-copy-prompt');
            if (p) p.remove();

            statusMessage.textContent = 'âœ… åŒ¯å‡ºæˆåŠŸï¼(ä½¿ç”¨å‚™ç”¨è¤‡è£½) URL å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚';
            setTimeout(() => {
                statusMessage.textContent = 'æº–å‚™å°±ç·’';
            }, 3000);
        } catch (copyError) {
             // å…©ç¨®è¤‡è£½æ–¹å¼çš†å¤±æ•— (æ²™ç›’æ¨¡å¼ä¸‹é æœŸè¡Œç‚º)ï¼Œé¡¯ç¤ºæ‰‹å‹•è¤‡è£½æç¤º
             statusMessage.textContent = 'âŒ è¤‡è£½å¤±æ•—ï¼(æ²™ç›’æ¨¡å¼é™åˆ¶) è«‹æ‰‹å‹•è¤‡è£½ä¸‹æ–¹ç¶²å€ã€‚';
             showManualCopyPrompt(exportUrl);
        }
    }
}

/**
 * æª¢æŸ¥ä¸¦å¾ URL åƒæ•¸æˆ– Local Storage è¼‰å…¥åŠ‡æœ¬ã€‚
 */
function checkAndLoadScriptFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    let encodedScript = urlParams.get('script');
    let loadSource = 'URL';

    // 1. åªæª¢æŸ¥ URL åƒæ•¸è¼‰å…¥
    if (encodedScript) {
        try {
            // ** è®Šæ›´ï¼šä½¿ç”¨ Base64 URI å®‰å…¨è§£ç¢¼ (æœ€ç©©å®šæ–¹æ¡ˆ) **
            const jsonString = decompressFromUriSafeBase64(encodedScript);
            
            if (!jsonString) {
                 console.error('è§£ç¢¼åŠ‡æœ¬å­—ä¸²å¤±æ•—ã€‚');
                 document.getElementById('status-message').textContent = 'âŒ è¼‰å…¥åŠ‡æœ¬å¤±æ•—ï¼Œå£“ç¸®æ•¸æ“šå¯èƒ½å·²æå£ã€‚';
            } else {
                const loadedSteps = JSON.parse(jsonString);

                if (Array.isArray(loadedSteps) && loadedSteps.length > 0 && loadedSteps[0].type === 'start') {
                    // æˆåŠŸè¼‰å…¥ï¼Œæ›¿æ›ç•¶å‰åŠ‡æœ¬
                    scriptSteps = loadedSteps;
                    document.getElementById('status-message').textContent = `ğŸ“¥ åŠ‡æœ¬å·²å¾ ${loadSource} è¼‰å…¥ã€‚`;
                    
                    // *** ç‚ºäº†é˜²æ­¢ä½¿ç”¨è€…ä¸‹æ¬¡åœ¨åŒä¸€ç€è¦½å™¨ç·¨è¼¯æ™‚ä¸Ÿå¤±ï¼Œæˆ‘å€‘ä»ç„¶å„²å­˜åˆ° Local Storage ***
                    saveScriptToLocalStorage(); 
                    return;
                } else {
                    console.error('è¼‰å…¥çš„åŠ‡æœ¬æ ¼å¼ç„¡æ•ˆã€‚ä½¿ç”¨é è¨­åŠ‡æœ¬ã€‚');
                }
            }
        } catch (error) {
            console.error('è§£æ URL åŠ‡æœ¬å¤±æ•—:', error);
            document.getElementById('status-message').textContent = 'âŒ è¼‰å…¥åŠ‡æœ¬å¤±æ•—ï¼Œæ•¸æ“šè§£æéŒ¯èª¤ã€‚';
        }
    }
    
    // 2. å¦‚æœ URL ä¸­æ²’æœ‰åƒæ•¸ï¼Œå‰‡å˜—è©¦å¾ Local Storage è¼‰å…¥ (ä¿ç•™ç·¨è¼¯å™¨å·¥ä½œå€åŠŸèƒ½)
    const storedJson = getLocalStorage(STORAGE_KEY);
    loadSource = 'æœ¬æ©Ÿå„²å­˜';

    if (storedJson) {
        try {
            // Local Storage å„²å­˜çš„æ˜¯ç´” JSON å­—ä¸²ï¼Œç›´æ¥è§£æ
            const loadedSteps = JSON.parse(storedJson); 

            if (Array.isArray(loadedSteps) && loadedSteps.length > 0 && loadedSteps[0].type === 'start') {
                scriptSteps = loadedSteps;
                document.getElementById('status-message').textContent = `ğŸ“¥ åŠ‡æœ¬å·²å¾ ${loadSource} è¼‰å…¥ã€‚`;
                return; 
            }
        } catch (error) {
            console.error('è§£ææœ¬åœ°å„²å­˜åŠ‡æœ¬å¤±æ•—:', error);
        }
    }

    // å¦‚æœ URL å’Œ Local Storage éƒ½æ²’æœ‰æœ‰æ•ˆåŠ‡æœ¬ï¼Œå‰‡ä½¿ç”¨åˆå§‹é è¨­åŠ‡æœ¬
}

/**
 * è¼”åŠ©å‡½å¼ï¼šæ‰¾åˆ°ä¸Šä¸€å€‹è¨­å®šä½ç½®çš„æ­¥é©Ÿçš„ä½ç½®
 * @param {number} currentIndex - ç•¶å‰æ­£åœ¨ç·¨è¼¯çš„æ­¥é©Ÿç´¢å¼•
 * @returns {{lat: number, lng: number}} - ä¸Šä¸€å€‹ä½ç½®çš„åº§æ¨™
 */
function getPreviousPosition(currentIndex) {
    if (currentIndex <= 0) {
        // å¦‚æœæ˜¯ç¬¬ä¸€å€‹æ­¥é©Ÿï¼Œå‰‡æ²’æœ‰å‰ä¸€å€‹ä½ç½®
        return { lat: null, lng: null };
    }
    
    // å¾å‰ä¸€å€‹æ­¥é©Ÿé–‹å§‹å¾€å›æ‰¾
    for (let i = currentIndex - 1; i >= 0; i--) {
        const step = scriptSteps[i];
        // åªæœ‰ start å’Œ goto æ­¥é©Ÿè¨­å®šä½ç½®
        if (step.type === 'start' || step.type === 'goto') {
            return { lat: step.lat, lng: step.lng };
        }
    }
    // ç†è«–ä¸Šä¸æ‡‰è©²åˆ°é”é€™è£¡ï¼Œä½†ä½œç‚ºå›é€€ï¼Œè¿”å›ç¬¬ä¸€å€‹æ­¥é©Ÿçš„å®šç¾©ä½ç½®
    return { lat: scriptSteps[0].lat, lng: scriptSteps[0].lng };
}


/**
 * æ¸²æŸ“åŠ‡æœ¬åˆ—è¡¨
 */
function renderScript() {
    const listContainer = document.getElementById('script-list');
    listContainer.innerHTML = '';
    
    // --- é¡è‰²äº¤æ›¿é‚è¼¯çš„è®Šæ•¸ (ä¿®è¨‚ç‚ºæ—¥åˆ†çµ„) ---
    // Day 1/3... ä½¿ç”¨ bg-indigo-100 (æ·¡ç´«), Day 2/4... ä½¿ç”¨ bg-pink-100 (æ·¡ç²‰ç´…)
    const DAY_COLORS = ['bg-indigo-100', 'bg-pink-100']; 
    const BORDER_COLORS = ['border-indigo-400', 'border-pink-400'];
    let dayIndex = 0; // 0 (Day 1, Indigo) æˆ– 1 (Day 2, Pink)
    // ---------------------------------

    scriptSteps.forEach((step, index) => {
        const stepElement = document.createElement('div');
        stepElement.id = `step-${index}`;
        // æ­¥é©Ÿå…ƒç´ çš„åŸºæœ¬æ¨£å¼ï¼šåœ“è§’ã€é™°å½±ã€éæ¸¡æ•ˆæœ
        stepElement.className = 'p-3 rounded-lg shadow-sm transition-all duration-200 border border-opacity-50'; 
        
        let contentHtml = '';
        let stepColor = 'text-gray-700';
        let stepIcon = 'ğŸ”¹';

        const isStartStep = index === 0;
        const buttonAction = `executeScript(${isStartStep ? 1 : index})`;
        const startIcon = isStartStep ? 'ğŸ ' : 'â–¶ï¸';
        const startButtonTitle = isStartStep ? 'å¾é ­æ’¥æ”¾' : 'å¾é€™é‚Šé–‹å§‹æ’¥æ”¾';

        
        // --- æ‡‰ç”¨é¡è‰²é‚è¼¯ (ä¿®è¨‚ï¼šæ—¥åˆ†çµ„) ---
        // 1. æª¢æŸ¥æ˜¯å¦é‡åˆ° Dayoffï¼Œå¦‚æœæ˜¯ï¼Œå‰‡ç¿»è½‰æ—¥æ•¸ (å¾ä¸Šä¸€æ­¥é©Ÿä¾†çœ‹)
        if (index > 0 && scriptSteps[index - 1].type === 'dayoff') {
            dayIndex = 1 - dayIndex; // ç¿»è½‰ 0 <-> 1
        }
        
        // 2. æ‡‰ç”¨ç•¶å‰æ—¥çš„åŸºç¤è‰²
        if (step.type === 'dayoff') {
            // Dayoff æ­¥é©Ÿï¼šä½¿ç”¨ä¸­æ€§è‰²çªé¡¯ï¼Œä¸¦ä¿ç•™ç²‰è‰²çš„æ–‡å­—é¡è‰²
            stepElement.classList.add('bg-gray-200', 'border-gray-400');
            stepColor = 'text-pink-700'; 
        } else {
            // Start å’Œæ‰€æœ‰å…¶ä»–æ­¥é©Ÿï¼šæ‡‰ç”¨ Day N çš„é¡è‰²
            stepElement.classList.add(DAY_COLORS[dayIndex]); // æ‡‰ç”¨æ·¡ç´«æˆ–æ·¡ç²‰ç´…
            stepElement.classList.add(BORDER_COLORS[dayIndex]); // æ‡‰ç”¨å°æ‡‰çš„é‚Šæ¡†è‰²
        }

        if (step.type === 'start') {
            // Start Step: å¼·åˆ¶ä½¿ç”¨ Day 1 çš„æ·±è‰²é‚Šæ¡†å’Œçªé¡¯æ–‡å­—è‰²
            stepElement.classList.remove('border-opacity-50');
            stepElement.classList.add('border-indigo-500');
            stepColor = 'text-purple-700';
        }
        // ------------------


        switch (step.type) {
            case 'start':
                // (Start stepColor/Iconå·²åœ¨ä¸Šé¢è¨­å®š)
                stepIcon = 'ğŸ“';
                
                // çµ„åˆç‚ºå–®ä¸€åº§æ¨™å­—ä¸²
                const startCoordValue = (step.lat && step.lng) ? `${step.lat}, ${step.lng}` : '';

                contentHtml = `
                    <p class="text-xs text-red-500 font-semibold mb-2">âš ï¸ é€™æ˜¯æ—…ç¨‹çš„**å¼·åˆ¶**åˆå§‹é»ï¼Œä¸èƒ½åˆªé™¤æˆ–ç§»å‹•ã€‚</p>
                    <span class="font-bold">åˆå§‹ä½ç½®</span><br>
                    <small>GPS åº§æ¨™ (ç·¯åº¦, ç¶“åº¦, ä¾‹å¦‚: 26.2173, 127.6924):</small>
                    <!-- é—œéµè®Šå‹•ï¼šå–®ä¸€æ–‡å­—è¼¸å…¥æ¬„ä½ for åº§æ¨™ï¼Œä½¿ç”¨ 'coords' æ¬„ä½æ›´æ–° -->
                    <input type="text" 
                           class="w-full text-sm border rounded px-2 mt-1" 
                           placeholder="ç·¯åº¦, ç¶“åº¦" 
                           value="${startCoordValue}" 
                           onchange="updateStep(${index}, 'coords', this.value)">
                `;
                break;
            case 'goto':
                // çµ„åˆç‚ºå–®ä¸€åº§æ¨™å­—ä¸²
                const coordValue = (step.lat && step.lng) ? `${step.lat}, ${step.lng}` : '';
                stepColor = 'text-blue-700';
                stepIcon = 'â¡ï¸';
                contentHtml = `
                    <span class="font-bold">ç§»å‹•åˆ°</span>
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="æ­¥é©Ÿæ¨™ç±¤ (ex: åˆ°é”ç‰§å¿—ç«™)" value="${step.label || ''}" onchange="updateStep(${index}, 'label', this.value)">
                    <small>GPS åº§æ¨™ (ç·¯åº¦, ç¶“åº¦, ä¾‹å¦‚: 26.2173, 127.6924):</small>
                    <input type="text" 
                           class="w-full text-sm border rounded px-2 mt-1" 
                           placeholder="ç·¯åº¦, ç¶“åº¦" 
                           value="${coordValue}" 
                           onchange="updateStep(${index}, 'coords', this.value)">
                    <small class="mt-2 block">ç§»å‹•åœ–æ¨™ (å¯é¸):</small>
                    <select class="w-full text-sm border rounded px-2 mt-1" onchange="updateStep(${index}, 'icon', this.value)">
                        <option value="">(ä¿æŒä¸è®Š)</option>
                        ${ICON_NAMES.map(name => `<option value="${name}" ${step.icon === name ? 'selected' : ''}>${name}</option>`).join('')}
                    </select>
                    <small class="mt-2 block">æŠµé”æ™‚é¡¯ç¤ºè¨Šæ¯ (å¯é¸):</small>
                    <input type="text" 
                           class="w-full text-sm border rounded px-2 mt-1" 
                           placeholder="æŠµé”æ™‚å½ˆå‡ºè¨Šæ¯ (ç•™ç©ºå‰‡ä¸é¡¯ç¤º)" 
                           value="${step.words || ''}" 
                           onchange="updateStep(${index}, 'words', this.value)">
                `;
                break;
            case 'activity':
                // **æ–°é‚è¼¯ï¼šActivity = setIcon (å¯é¸) + wait (å¯é¸)**
                stepColor = 'text-green-700';
                stepIcon = 'ğŸƒ';
                contentHtml = `
                    <span class="font-bold">æ´»å‹•/ç‹€æ…‹ (è®Šæ›´åœ–æ¨™æˆ–ç­‰å¾…)</span>
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="æ­¥é©Ÿæ¨™ç±¤ (ex: æ­£åœ¨æ‹ç…§)" value="${step.label || ''}" onchange="updateStep(${index}, 'label', this.value)">
                    
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div>
                            <small class="block">åœ–æ¨™ (å¯é¸):</small>
                            <select class="w-full text-sm border rounded px-2 mt-1" onchange="updateStep(${index}, 'icon', this.value)">
                                <option value="">(ä¿æŒä¸è®Š)</option>
                                ${ICON_NAMES.map(name => `<option value="${name}" ${step.icon === name ? 'selected' : ''}>${name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <small class="block">æŒçºŒæ™‚é–“ (ç§’æ•¸, å¯é¸):</small>
                            <input type="number" 
                                   class="w-full text-sm border rounded px-2 mt-1" 
                                   placeholder="0" 
                                   value="${step.sec || ''}" 
                                   onchange="updateStep(${index}, 'sec', parseFloat(this.value))">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">è‹¥ç§’æ•¸ç‚º 0 æˆ–ç•™ç©ºï¼Œå‰‡åªåŸ·è¡Œåœ–æ¨™è®Šæ›´ã€‚</p>
                `;
                break;
            case 'show':
                stepColor = 'text-yellow-700';
                stepIcon = 'ğŸ’¬';
                contentHtml = `
                    <span class="font-bold">é¡¯ç¤ºè¨Šæ¯</span>
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="æ­¥é©Ÿæ¨™ç±¤ (ex: é¡¯ç¤ºï¼šç‰§å¿—ç«™)" value="${step.label || ''}" onchange="updateStep(${index}, 'label', this.value)">
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="è¨Šæ¯å…§å®¹" value="${step.words || ''}" onchange="updateStep(${index}, 'words', this.value)">
                `;
                break;
            case 'dayoff':
                // (Dayoff stepColorå·²åœ¨ä¸Šé¢è¨­å®š)
                stepIcon = 'ğŸ›Œ';
                contentHtml = `
                    <span class="font-bold">ä¼‘æ¯éå¤œ</span>
                    <p class="text-xs text-gray-500 mt-1 mb-2">åŸ·è¡Œ setIcon='sleep' ä¸¦æ’­æ”¾å¤œé–“å‹•ç•«ã€‚</p>
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="æ­¥é©Ÿæ¨™ç±¤ (ex: å…¥ä½ä¼‘æ¯)" value="${step.label || ''}" onchange="updateStep(${index}, 'label', this.value)">
                    <small>æŒçºŒæ™‚é–“ (ç§’æ•¸): <input type="number" class="w-20 text-xs border rounded px-1" value="${step.sec}" onchange="updateStep(${index}, 'sec', parseFloat(this.value))"></small>
                `;
                break;
        }

        stepElement.innerHTML = `
            <div class="flex justify-between items-start mb-1">
                <div class="flex items-center">
                    <span class="${stepColor} font-semibold">${stepIcon} ${index}. ${step.type.toUpperCase()}</span>
                    <!-- è®Šæ›´ç‚ºåœ–ç¤ºæŒ‰éˆ• -->
                    <button class="ml-2 text-base text-indigo-500 hover:text-indigo-700 transition"
                            onclick="${buttonAction}"
                            title="${startButtonTitle}">
                            ${startIcon}
                    </button>
                </div>
                
                <div class="space-x-1">
                    <!-- Move Up (Disabled if isStartStep or is the second step) -->
                    <button class="text-gray-400 text-sm ${isStartStep || index === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:text-gray-700'}" 
                            onclick="moveStep(${index}, -1)" 
                            ${isStartStep || index === 1 ? 'disabled' : ''}>â¬†ï¸</button>
                    <!-- Move Down (Disabled if isStartStep or is the last step) -->
                    <button class="text-gray-400 text-sm ${isStartStep || index === scriptSteps.length - 1 ? 'opacity-50 cursor-not-allowed' : 'hover:text-gray-700'}" 
                            onclick="moveStep(${index}, 1)" 
                            ${isStartStep || index === scriptSteps.length - 1 ? 'disabled' : ''}>â¬‡ï¸</button>
                    <!-- Delete (Disabled if isStartStep) -->
                    <button class="text-red-400 text-sm ${isStartStep ? 'opacity-50 cursor-not-allowed' : 'hover:text-red-700'}" 
                            onclick="deleteStep(${index})" 
                            ${isStartStep ? 'disabled' : ''}>âŒ</button>
                </div>
            </div>
            ${contentHtml}
        `;
        listContainer.appendChild(stepElement);
    });
}

/**
 * æ–°å¢æ­¥é©Ÿåˆ°åŠ‡æœ¬
 */
function addStep(type) {
    // æ­¥é©Ÿ 1: å°‡ label é è¨­ç‚ºç©ºå­—ä¸²ï¼Œä»¥ä¾¿é¡¯ç¤º placeholder
    const newStep = { label: '' }; 

    switch (type) {
        case 'goto':
            // GPS åº§æ¨™é è¨­ç‚º nullï¼Œä»¥ä¾¿åœ¨æ¸²æŸ“æ™‚é¡¯ç¤º placeholder
            Object.assign(newStep, { type: 'goto', lat: null, lng: null, icon: 'walk', words: '' });
            break;
        case 'activity':
            // æ–°å¢ Activity å‹•ä½œï¼Œé è¨­ç„¡ icon ä¸”ç­‰å¾… 1 ç§’
            Object.assign(newStep, { type: 'activity', icon: '', sec: 1 });
            break;
        case 'show':
            Object.assign(newStep, { type: 'show', words: '' }); // è¨Šæ¯å…§å®¹ä¹Ÿé è¨­ç‚ºç©ºå­—ä¸²
            break;
        case 'dayoff':
            Object.assign(newStep, { type: 'dayoff', sec: 5 }); // é è¨­ä¼‘æ¯ 5 ç§’
            break;
    }
    scriptSteps.push(newStep);
    renderScript();
    saveScriptToLocalStorage(); // <--- å„²å­˜
}

/**
 * åˆªé™¤æ­¥é©Ÿ (ä¸èƒ½åˆªé™¤ç¬¬ä¸€å€‹ 'start' æ­¥é©Ÿ)
 */
function deleteStep(index) {
    if (index === 0) return; // ä¿è­·ç¬¬ä¸€å€‹æ­¥é©Ÿ
    scriptSteps.splice(index, 1);
    renderScript();
    saveScriptToLocalStorage(); // <--- å„²å­˜
}

/**
 * æ›´æ–°æ­¥é©Ÿè³‡æ–™
 */
function updateStep(index, field, value) {
    if (field === 'coords') {
        // è™•ç† 'coords' (ç·¯åº¦, ç¶“åº¦) è¯åˆè¼¸å…¥, é©ç”¨æ–¼ 'start' å’Œ 'goto'
        const parts = String(value).split(',').map(s => s.trim());
        const lat = parseFloat(parts[0]);
        const lng = parseFloat(parts[1]);

        if (!isNaN(lat) && !isNaN(lng) && parts.length === 2) {
            
            // --- GPS Comparison/Validation ---
            // åƒ…å° goto æ­¥é©Ÿé€²è¡Œæª¢æŸ¥ (index > 0)
            if (index > 0 && scriptSteps[index].type === 'goto') {
                const prevPos = getPreviousPosition(index);
                
                // ä½¿ç”¨ä¸€å€‹å°å®¹å¿å€¼é€²è¡Œæµ®é»æ•¸æ¯”è¼ƒ
                const EPSILON = 0.000001; 
                const isSameLat = Math.abs(lat - prevPos.lat) < EPSILON;
                const isSameLng = Math.abs(lng - prevPos.lng) < EPSILON;
                
                if (isSameLat && isSameLng) {
                    console.error("GPS Error: New position is the same as the previous known position. Aborting update.");
                    document.getElementById('status-message').textContent = 'âš ï¸ éŒ¯èª¤: æ–°ä½ç½®èˆ‡å‰ä¸€æ­¥é©Ÿçš„ä½ç½®ç›¸åŒï¼Œç§»å‹•å°‡è¢«å¿½ç•¥ã€‚';
                    setTimeout(() => { document.getElementById('status-message').textContent = 'æº–å‚™å°±ç·’'; }, 3000);
                    return; 
                }
            }
            // --- End Validation ---

            scriptSteps[index].lat = lat;
            scriptSteps[index].lng = lng;
            saveScriptToLocalStorage();
        } else {
            console.error("Invalid coordinate format. Please use 'lat, lng'.");
        }
    } else if (field === 'lat' || field === 'lng' || field === 'sec') {
        // è™•ç†å–®ç¨çš„æ•¸å­—æ¬„ä½ (æ­¤é‚è¼¯ç¾åœ¨ä¸»è¦ç”¨æ–¼ 'sec')
        scriptSteps[index][field] = parseFloat(value) || 0;
        saveScriptToLocalStorage(); // <--- å„²å­˜
    } else {
        // è™•ç†æ–‡å­—æ¬„ä½ (label, words, icon)
        scriptSteps[index][field] = value;
        saveScriptToLocalStorage(); // <--- å„²å­˜
    }
}

/**
 * ç§»å‹•æ­¥é©Ÿä½ç½®
 */
function moveStep(index, direction) {
    if (index === 0) return; // ä¿è­·ç¬¬ä¸€å€‹æ­¥é©Ÿ
    const newIndex = index + direction;
    if (newIndex < 1 || newIndex >= scriptSteps.length) return; // ä¸èƒ½ç§»å‡ºç¯„åœ (ç‰¹åˆ¥æ˜¯ä¸èƒ½ç§»åˆ° index 0)
    
    // é€²è¡Œäº¤æ›
    [scriptSteps[index], scriptSteps[newIndex]] = [scriptSteps[newIndex], scriptSteps[index]];
    renderScript();
    saveScriptToLocalStorage(); // <--- å„²å­˜
}

// --------------------------------------------------------
// åˆå§‹åŒ–ï¼šæª¢æŸ¥ URL åƒæ•¸ã€Local Storage ä¸¦è¼‰å…¥åŠ‡æœ¬ï¼Œç„¶å¾Œæ¸²æŸ“ UI
// --------------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
    checkAndLoadScriptFromURL();
    renderScript();
});
</script>
</body>
</html>