<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Animated Journey Script Editor</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- å¼•å…¥ Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  /* ç¢ºä¿åœ°åœ–ä½”æ»¿å‰©ä¸‹çš„ç©ºé–“ */
  #map { height: 100%; width: 100%; }
  /* ç¢ºä¿ DivIcon å…§çš„ Emoji å±…ä¸­ */
  .leaflet-div-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
  }
  /* å¤œé–“é®ç½©æ¨£å¼ï¼Œåˆå§‹ç‚ºé€æ˜ï¼Œç­‰å¾… JS æ§åˆ¶ */
  #night-overlay {
    background-color: black;
    opacity: 0;
    pointer-events: none; /* è®“é»æ“Šäº‹ä»¶ç©¿é€ */
    transition-property: opacity;
  }
  /* è‡ªè¨‚æ¨£å¼ï¼šæ”¾å¤§æç¤ºè¦–çª— (Popup) */
  .custom-large-popup .leaflet-popup-content-wrapper {
    /* æ¡Œé¢é è¨­å¤§å° (~3x) */
    font-size: 1.5rem; 
    line-height: 2rem;
    padding: 1.5rem;
    border-radius: 1rem;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    background-color: #fefcbf; /* æŸ”å’Œé»ƒè‰²èƒŒæ™¯ */
    color: #444;
  }
  .custom-large-popup .leaflet-popup-tip {
    background-color: #fefcbf;
    width: 20px;
    height: 10px;
  }
  .custom-large-popup .leaflet-popup-content {
      /* ç¢ºä¿å…§å®¹å¯ä»¥æ’é–‹ */
      width: 100%; 
      max-width: 300px;
      text-align: center;
      font-weight: bold;
  }
  /* æ¨¡æ…‹æ¡†å…§å®¹çš„éæ¸¡æ•ˆæœ */
  .modal-transition {
      transition: opacity 0.3s, transform 0.3s;
  }
  /* --- éŒ¨é»æ’å…¥ UI (ä¿®æ­£: çµ±ä¸€ä½¿ç”¨ CSS è™•ç†æ‡¸åœ) --- */
  .insert-anchor {
      min-height: 10px; /* ç¢ºä¿æœ€å°é»æ“Šç›®æ¨™ */
      margin: 8px 0;
      transition: all 0.2s ease-in-out;
      cursor: pointer;
      background-color: #f9fafb; /* bg-gray-50 */
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #e5e7eb; /* é è¨­é‚Šæ¡† */
  }
  /* æ‡¸åœæ™‚çš„ç‹€æ…‹: å¢åŠ é«˜åº¦ï¼Œé¡¯ç¤ºè™›ç·šæ¡†å’Œæ–‡å­— */
  .insert-anchor:hover {
      min-height: 80px; /* å¢åŠ é«˜åº¦ï¼Œæ¥è¿‘ä¸€å€‹æ­¥é©Ÿå¡ç‰‡ */
      opacity: 1; 
      border: 3px dashed #6366f1; /* indigo-500 */
      background-color: #eef2ff; /* indigo-50 */
  }
  /* æ‡¸åœæ™‚æ‰é¡¯ç¤ºæ–‡å­— */
  .insert-anchor:hover .insert-anchor-text {
      opacity: 1;
  }
  .insert-anchor-text {
      opacity: 0;
      font-weight: bold;
      color: #6366f1;
      transition: opacity 0.2s;
      pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ° anchor */
  }

  /* éŸ¿æ‡‰å¼ï¼šå¼·åˆ¶ç¸±å‘ä½ˆå±€ */
  @media (max-width: 767px) {
    .mobile-h-half {
        height: 50%;
    }
    /* ä¿®æ­£ 2: è¡Œå‹•è£ç½® ICON ç¸®å°åˆ° 40px */
    .leaflet-div-icon div {
        font-size: 40px !important;
    }
    /* ä¿®æ­£ 1: è¡Œå‹•è£ç½® POPUP ç¸®å°åˆ° 1/3 */
    .custom-large-popup .leaflet-popup-content-wrapper {
        font-size: 0.85rem; /* ç´„ 1/3 */
        line-height: 1.25rem; 
        padding: 0.75rem; /* é‚Šè·ç¸®å° */
    }

    /* ä¿®æ­£ 2: è¡Œå‹•è£ç½®ä¸‹ï¼ŒåŒ¯å…¥æ¨¡æ…‹æ¡†åªè¦†è“‹ä¸‹åŠéƒ¨ (controls å€) */
    #import-modal {
        top: 50%;       /* å¾è¢å¹•ä¸­é–“é–‹å§‹ */
        height: 50%;    /* åªä½”æ“šä¸‹åŠéƒ¨ */
        bottom: 0;
        /* å–æ¶ˆ flex items-center justify-centerï¼Œè®“å…§å®¹å¾é ‚éƒ¨é–‹å§‹ */
        align-items: flex-start;
        justify-content: flex-start;
        padding-top: 1rem; /* æ¨¡æ“¬ p-4 */
    }
    #import-modal-content {
        margin-top: 0;
        max-height: 100%;
        overflow-y: auto;
    }
  }

  /* ä¿®æ­£ 1: è®“æ‹‰åˆ°åº•éƒ¨æŒ‰éˆ•åœ¨ controls å®¹å™¨å…§æ­£å¸¸æµ®å‹• */
  #scroll-to-bottom-container {
      position: sticky;
      bottom: 0;
      z-index: 10;
      /* ç§»é™¤çµ•å°å®šä½ï¼Œä½¿ç”¨ sticky */
  }
</style>
<!-- å¼•å…¥ Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// =================================================================
// 1. å…¨åŸŸå¸¸æ•¸èˆ‡è®Šæ•¸è²æ˜ (æœ€é ‚å±¤)
// =================================================================
const STORAGE_KEY = 'animatedJourneyScript';
const EXPIRY_MS = 2 * 24 * 60 * 60 * 1000; // 2 å¤© (æ¯«ç§’)
const iconSize = 75; // æ¡Œé¢é è¨­å¤§å°
const ICON_NAMES = ['train', 'walk', 'dine', 'sleep', 'bus', 'motorcycle', 'car', 'view', 'shopping', 'airplane']; 
const icons = {
  train: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸš†</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  walk: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸš¶â€â™‚ï¸</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  dine: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸ½ï¸</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }), 
  sleep: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸ˜´</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  bus: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸšŒ</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  motorcycle: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸï¸</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  car: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸš—</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  view: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸï¸</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  shopping: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸ›ï¸</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  airplane: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">âœˆï¸</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }) 
};
const INITIAL_GPS = [26.20178415387677, 127.64689003446617];
const START_STEP_DEFINITION = { 
    type: 'start', 
    lat: INITIAL_GPS[0], 
    lng: INITIAL_GPS[1], 
    label: 'é‚£éœ¸æ©Ÿå ´ (åˆå§‹ä½ç½®)' 
};

// ä½¿ç”¨ let è²æ˜ï¼Œä»¥ä¾¿åœ¨ DOMContentLoaded ä¸­è³¦å€¼ (è§£æ±º Map container not found)
let mapInstance = null;
let marker = null;
let polyline = null;
let popup = null;
let currentAnimation = false;
let isScriptRunning = false;
let isPaused = false;
let pauseResolve = null; 
let currentWaitTimeoutId = null;
let currentWaitRemainingTime = 0;
let currentWaitStartTime = 0;
let currentWaitResolve = null; 
let clearScriptTimeoutId = null; 
let hoverTimeoutId = null; // æ–°å¢ï¼šç”¨æ–¼éŒ¨é»æç¤ºçš„è¨ˆæ™‚å™¨
let insertAnchorIndex = -1; // æ–°å¢ï¼šå„²å­˜è¦æ’å…¥æ­¥é©Ÿçš„ç´¢å¼•ä½ç½® (-1 è¡¨ç¤ºæ²’æœ‰éŒ¨é»)


// åˆå§‹åŠ‡æœ¬
let scriptSteps = [
    START_STEP_DEFINITION,
    { type: 'goto', lat: 26.217316099459758, lng: 127.69247463281796, label: 'æ­ä¹˜å–®è»Œåˆ°ç‰§å¿—ç«™', icon: 'train', words: 'æŠµé”ç‰§å¿—ç«™' },
    { type: 'goto', lat: 26.216668604473377, lng: 127.69066831093619, label: 'æ­¥è¡Œåˆ°å±±ç¾Šæ–™ç†', icon: 'walk' },
    { type: 'activity', icon: 'dine', sec: 0, label: 'åƒåˆé¤' }, 
    { type: 'show', words: 'å±±ç¾Šæ–™ç†ã•ã‹ãˆ', label: 'é¡¯ç¤ºï¼šå±±ç¾Šæ–™ç†ã•ã‹ãˆ' }, 
    { type: 'activity', sec: 3, icon: '', label: 'ç­‰å¾… 3 ç§’ (ç”¨é¤)' },
    { type: 'goto', lat: 26.212824672458485, lng: 127.6891822419568, label: 'æ­¥è¡Œåˆ°é£¯åº—å…¥ä½', icon: 'walk', words: 'CABIN & HOTEL CONSTANT NAHA' },
    { type: 'dayoff', sec: 3, label: 'å…¥ä½ä¼‘æ¯ (éå¤œæ•ˆæœ)' }, 
    { type: 'goto', lat: 26.21139855196967, lng: 127.68811493682566, label: 'æ­¥è¡Œåˆ°å…¬è»Šç«™ç‰Œ', icon: 'walk', words: 'å…¬è»Š31ç«™ç‰Œ' },
    { type: 'goto', lat: 26.210618356446393, lng: 127.67917746391598, label: 'æ­ä¹˜å…¬è»Šåˆ°ä¸‹è»Šé»', icon: 'bus', words: 'ä¸‹è»Š' },
    { type: 'goto', lat: 26.213092860874845, lng: 127.67687857621559, label: 'æ­¥è¡Œåˆ°æ©Ÿè»Šç§Ÿè³ƒ', icon: 'walk', words: 'æ©Ÿè»Šç§Ÿè³ƒGOYA' },
    { type: 'goto', lat: 26.332465967977257, lng: 127.79849563345437, label: 'é¨è»Šåˆ°æ–°ä¸–ç´€é£¯åº—', icon: 'motorcycle', words: 'æ–°ä¸–ç´€é£¯åº—' },
    { type: 'activity', sec: 3, icon: '', label: 'ç­‰å¾… 3 ç§’' },
];


// =================================================================
// 3. Local Storage å„²å­˜èˆ‡è¼‰å…¥é‚è¼¯ (å·²æå‰å®šç¾©ï¼Œä¿®å¾© ReferenceError)
// =================================================================

/**
 * è¼”åŠ©å‡½å¼ï¼šå„²å­˜è³‡æ–™åˆ° LocalStorageï¼ŒåŒ…å«åˆ°æœŸæ™‚é–“
 */
function setLocalStorage(key, data, expiryMs) {
    const item = {
        data: data,
        expiry: new Date().getTime() + expiryMs,
    }
    try {
        localStorage.setItem(key, JSON.stringify(item));
    } catch (e) {
        console.warn("LocalStorage set failed, possibly due to quota limits.");
    }
}

/**
 * è¼”åŠ©å‡½å¼ï¼šå¾ LocalStorage ç²å–è³‡æ–™ï¼Œä¸¦æª¢æŸ¥æ˜¯å¦åˆ°æœŸ
 */
function getLocalStorage(key) {
    let itemStr;
    try {
        itemStr = localStorage.getItem(key);
    } catch (e) {
        console.warn("LocalStorage get failed.");
        return null;
    }
    
    if (!itemStr) {
        return null;
    }
    
const item = JSON.parse(itemStr);
    const now = new Date().getTime();
    
    // æª¢æŸ¥æ˜¯å¦åˆ°æœŸ
    if (now > item.expiry) {
        localStorage.removeItem(key);
        return null;
    }
    return item.data;
}

/**
 * å°‡ç•¶å‰åŠ‡æœ¬å„²å­˜åˆ° LocalStorage
 */
function saveScriptToLocalStorage() {
    try {
        const jsonString = JSON.stringify(scriptSteps);
        // ç›´æ¥å„²å­˜ JSON å­—ä¸²ï¼ŒLocal Storage æ”¯æ´ UTF-8
        setLocalStorage(STORAGE_KEY, jsonString, EXPIRY_MS);
    } catch (e) {
        console.error('Failed to save script to LocalStorage:', e);
    }
}

// =================================================================
// 4. æ•¸æ“šè¼‰å…¥èˆ‡è§£æ (å¿…é ˆåœ¨ DOMContentLoaded å‘¼å«å‰å®šç¾©)
// =================================================================

/**
 * å°‡ç°¡åŒ–çš„æ•¸æ“šå­—ä¸²è§£æ§‹ä¸¦è¼‰å…¥åˆ° scriptSteps
 * @param {string} rawJsonString - åŒ¯å…¥çš„ JSON å­—ä¸² (å·²URIè§£ç¢¼)
 * @returns {boolean} - æˆåŠŸè¼‰å…¥è¿”å› true
 */
function loadImportedData(rawJsonString) {
    // Helper to map icon letter back to full name
    const ICON_MAP = {
        't': 'train', 'w': 'walk', 'd': 'dine', 's': 'sleep', 'b': 'bus', 
        'm': 'motorcycle', 'c': 'car', 'v': 'view', 'p': 'shopping', 'a': 'airplane'
    };

    // Helper to uncompact the script format (å¾ compactArray è½‰æ›å› fullScript)
    function uncompactScript(compactArray) {
        const fullScript = [];
        
        // ** ä¿®æ­£: å¤–å±¤è¿´åœˆæ‡‰éæ­·æ¯ä¸€å€‹æ­¥é©Ÿé™£åˆ— **
        for (const compactStep of compactArray) {
            let i = 0; // å…§éƒ¨ç´¢å¼•
            
            // æª¢æŸ¥ compactStep æ˜¯å¦çœŸçš„æ˜¯ä¸€å€‹æ•¸çµ„ï¼Œä¸¦ä¸”ç¬¬ä¸€å€‹å…ƒç´ æ˜¯é¡å‹å­—ç¬¦
            if (!Array.isArray(compactStep) || compactStep.length === 0) {
                 console.warn('Skipping invalid compact step:', compactStep);
                 continue;
            }

            const typeChar = compactStep[i++];
            let step = { label: '' }; // é è¨­ label
            
            switch (typeChar) {
                case 's': // start: s, lat, lng, [label]
                    step.type = 'start';
                    step.lat = compactStep[i++];
                    step.lng = compactStep[i++];
                    // Label is optional for start step in export, but we keep it simple here
                    step.label = 'é‚£éœ¸æ©Ÿå ´ (åˆå§‹ä½ç½®)'; // Use default label for start for simplicity
                    // Skip label if present
                    if (typeof compactStep[i] === 'string') {
                         step.label = compactStep[i++];
                    }
                    break;
                case 'g': // goto: g, lat, lng, iconChar, words
                    step.type = 'goto';
                    step.lat = compactStep[i++];
                    step.lng = compactStep[i++];
                    const iconChar = compactStep[i++];
                    step.icon = iconChar ? ICON_MAP[iconChar] || iconChar : '';
                    step.words = compactStep[i++];
                    step.label = 'è¼‰å…¥çš„ç§»å‹•æ­¥é©Ÿ';
                    break;
                case 'a': // activity: a, sec, [iconChar]
                    step.type = 'activity';
                    step.sec = compactStep[i++];
                    const activityIconChar = compactStep[i];
                    step.icon = activityIconChar ? (ICON_MAP[activityIconChar] || activityIconChar) : '';
                    if (step.icon) i++;
                    step.label = 'è¼‰å…¥çš„æ´»å‹•';
                    break;
                case 'h': // show: h, words
                    step.type = 'show';
                    step.words = compactStep[i++];
                    step.label = 'è¼‰å…¥çš„è¨Šæ¯';
                    break;
                case 'd': // dayoff: d, sec
                    step.type = 'dayoff';
                    step.sec = compactStep[i++];
                    step.label = 'è¼‰å…¥çš„ä¼‘æ¯éå¤œ';
                    break;
                default:
                    console.warn('Unknown compact step type:', typeChar);
                    return null; // åœæ­¢è§£æ (é€™æ˜¯å°è‡´éŒ¯èª¤è¨Šæ¯çš„åŸå› )
            }
            fullScript.push(step);
        }
        return fullScript;
    }

    // 1. è§£æ JSON å­—ä¸²
    let compactArray;
    try {
        compactArray = JSON.parse(rawJsonString);
        // é©—è­‰æœ€å¤–å±¤æ˜¯å¦ç‚ºæ•¸çµ„
        if (!Array.isArray(compactArray)) {
            console.error('Parsed data is not an array.');
            return false;
        }
    } catch (e) {
        console.error('JSON parse error after URI decoding:', e);
        return false;
    }

    // 2. è½‰æ›å›å®Œæ•´åŠ‡æœ¬çµæ§‹
    const loadedSteps = uncompactScript(compactArray);

    // 3. é©—è­‰ä¸¦è¼‰å…¥
    if (Array.isArray(loadedSteps) && loadedSteps.length > 0 && loadedSteps[0].type === 'start') {
        scriptSteps = loadedSteps;
        return true;
    }
    return false;
}

/**
 * æª¢æŸ¥ä¸¦å¾ URL åƒæ•¸æˆ– Local Storage è¼‰å…¥åŠ‡æœ¬ã€‚
 */
function checkAndLoadScriptFromURL() {
    // 1. å¾ Local Storage è¼‰å…¥
    const storedJson = getLocalStorage(STORAGE_KEY);
    const loadSource = 'æœ¬æ©Ÿå„²å­˜';

    if (storedJson) {
        try {
            // Local Storage å„²å­˜çš„æ˜¯ç´” JSON å­—ä¸²ï¼Œç›´æ¥è§£æ
            const loadedSteps = JSON.parse(storedJson); 

            if (Array.isArray(loadedSteps) && loadedSteps.length > 0 && loadedSteps[0].type === 'start') {
                scriptSteps = loadedSteps;
                document.getElementById('status-message').textContent = `ğŸ“¥ åŠ‡æœ¬å·²å¾ ${loadSource} è¼‰å…¥ã€‚`;
                return; 
            }
        } catch (error) {
            console.error('è§£ææœ¬åœ°å„²å­˜åŠ‡æœ¬å¤±æ•—:', error);
        }
    }

    // å¦‚æœ Local Storage ä¸­æ²’æœ‰æœ‰æ•ˆåŠ‡æœ¬ï¼Œå‰‡ä½¿ç”¨åˆå§‹é è¨­åŠ‡æœ¬
}


// =================================================================
// 5. åŠ‡æœ¬ç·¨è¼¯/æ“ä½œè¼”åŠ©å‡½æ•¸ (ç¢ºä¿åœ¨æ¸²æŸ“å’ŒæŒ‰éˆ•èª¿ç”¨å‰å®šç¾©)
// =================================================================

/**
 * è¼”åŠ©å‡½å¼ï¼šæ‰¾åˆ°ä¸Šä¸€å€‹è¨­å®šä½ç½®çš„æ­¥é©Ÿçš„ä½ç½®
 */
function getPreviousPosition(currentIndex) {
    if (currentIndex <= 0) {
        return { lat: null, lng: null };
    }
    
    for (let i = currentIndex - 1; i >= 0; i--) {
        const step = scriptSteps[i];
        if (step.type === 'start' || step.type === 'goto') {
            return { lat: step.lat, lng: step.lng };
        }
    }
    return { lat: scriptSteps[0].lat, lng: scriptSteps[0].lng };
}

/**
 * åˆªé™¤æ­¥é©Ÿ (ä¸èƒ½åˆªé™¤ç¬¬ä¸€å€‹ 'start' æ­¥é©Ÿ)
 */
function deleteStep(index) { // <-- HTML onclick èª¿ç”¨
    if (index === 0) return; // ä¿è­·ç¬¬ä¸€å€‹æ­¥é©Ÿ
    scriptSteps.splice(index, 1);
    renderScript();
    saveScriptToLocalStorage(); // <--- å„²å­˜
}

/**
 * ç§»å‹•æ­¥é©Ÿä½ç½®
 */
function moveStep(index, direction) { // <-- HTML onclick èª¿ç”¨
    if (index === 0) return; // ä¿è­·ç¬¬ä¸€å€‹æ­¥é©Ÿ
    const newIndex = index + direction;
    if (newIndex < 1 || newIndex >= scriptSteps.length) return; // ä¸èƒ½ç§»å‡ºç¯„åœ (ç‰¹åˆ¥æ˜¯ä¸èƒ½ç§»åˆ° index 0)
    
    // é€²è¡Œäº¤æ›
    [scriptSteps[index], scriptSteps[newIndex]] = [scriptSteps[newIndex], scriptSteps[index]];
    renderScript();
    saveScriptToLocalStorage(); // <--- å„²å­˜
}

/**
 * æ›´æ–°æ­¥é©Ÿè³‡æ–™
 */
function updateStep(index, field, value) { // <-- HTML onchange èª¿ç”¨
    if (field === 'coords') {
        // è™•ç† 'coords' (ç·¯åº¦, ç¶“åº¦) è¯åˆè¼¸å…¥, é©ç”¨æ–¼ 'start' å’Œ 'goto'
        const parts = String(value).split(',').map(s => s.trim());
        const lat = parseFloat(parts[0]);
        const lng = parseFloat(parts[1]);

        if (!isNaN(lat) && !isNaN(lng) && parts.length === 2) {
            
            // --- GPS Comparison/Validation ---
            // åƒ…å° goto æ­¥é©Ÿé€²è¡Œæª¢æŸ¥ (index > 0)
            if (index > 0 && scriptSteps[index].type === 'goto') {
                const prevPos = getPreviousPosition(index);
                
                // ä½¿ç”¨ä¸€å€‹å°å®¹å¿å€¼é€²è¡Œæµ®é»æ•¸æ¯”è¼ƒ
                const EPSILON = 0.000001; 
                const isSameLat = Math.abs(lat - prevPos.lat) < EPSILON;
                const isSameLng = Math.abs(lng - prevPos.lng) < EPSILON;
                
                if (isSameLat && isSameLng) {
                    console.error("GPS Error: New position is the same as the previous known position. Aborting update.");
                    document.getElementById('status-message').textContent = 'âš ï¸ éŒ¯èª¤: æ–°ä½ç½®èˆ‡å‰ä¸€æ­¥é©Ÿçš„ä½ç½®ç›¸åŒï¼Œç§»å‹•å°‡è¢«å¿½ç•¥ã€‚';
                    setTimeout(() => { document.getElementById('status-message').textContent = 'æº–å‚™å°±ç·’'; }, 3000);
                    return; 
                }
            }
            // --- End Validation ---

            scriptSteps[index].lat = lat;
            scriptSteps[index].lng = lng;
            saveScriptToLocalStorage();
        } else {
            console.error("Invalid coordinate format. Please use 'lat, lng'.");
        }
    } else if (field === 'lat' || field === 'lng' || field === 'sec') {
        // è™•ç†å–®ç¨çš„æ•¸å­—æ¬„ä½ (æ­¤é‚è¼¯ç¾åœ¨ä¸»è¦ç”¨æ–¼ 'sec')
        scriptSteps[index][field] = parseFloat(value) || 0;
        saveScriptToLocalStorage(); // <--- å„²å­˜
    } else {
        // è™•ç†æ–‡å­—æ¬„ä½ (label, words, icon)
        scriptSteps[index][field] = value;
        saveScriptToLocalStorage(); // <--- å„²å­˜
    }
}

/**
 * æ–°å¢æ­¥é©Ÿåˆ°åŠ‡æœ¬
 */
function addStep(type) { // <-- HTML onclick èª¿ç”¨
    // æ­¥é©Ÿ 1: å°‡ label é è¨­ç‚ºç©ºå­—ä¸²ï¼Œä»¥ä¾¿é¡¯ç¤º placeholder
    const newStep = { label: '' }; 

    switch (type) {
        case 'goto':
            // GPS åº§æ¨™é è¨­ç‚º nullï¼Œä»¥ä¾¿åœ¨æ¸²æŸ“æ™‚é¡¯ç¤º placeholder
            Object.assign(newStep, { type: 'goto', lat: null, lng: null, icon: 'walk', words: '' });
            break;
        case 'activity':
            // æ–°å¢ Activity å‹•ä½œï¼Œé è¨­ç„¡ icon ä¸”ç­‰å¾… 1 ç§’
            Object.assign(newStep, { type: 'activity', icon: '', sec: 1 });
            break;
        case 'show':
            Object.assign(newStep, { type: 'show', words: '' }); // è¨Šæ¯å…§å®¹ä¹Ÿé è¨­ç‚ºç©ºå­—ä¸²
            break;
        case 'dayoff':
            Object.assign(newStep, { type: 'dayoff', sec: 5 }); // é è¨­ä¼‘æ¯ 5 ç§’
            break;
    }
    
    // ** æ’å…¥é‚è¼¯ï¼šæª¢æŸ¥æ˜¯å¦æœ‰éŒ¨é» **
    if (insertAnchorIndex !== -1) {
        scriptSteps.splice(insertAnchorIndex, 0, newStep);
        // æ’å…¥å¾Œæ¸…é™¤éŒ¨é»ç‹€æ…‹ï¼Œä¸¦è‡ªå‹•æ²å‹•åˆ°æ–°æ’å…¥çš„æ­¥é©Ÿé™„è¿‘
        clearInsertAnchor(); 
        // Note: æ¸²æŸ“å¾Œæœƒè‡ªå‹•æ¸…é™¤æ‰€æœ‰éŒ¨é»æç¤º
        // é€™è£¡ä¸éœ€è¦é¡å¤–æ²å‹•ï¼Œå› ç‚º renderScript æœƒè§¸ç™¼ renderï¼Œæˆ‘å€‘åªéœ€è¦ç¢ºä¿ç‹€æ…‹è¢«æ¸…é™¤
    } else {
        // é è¨­è¡Œç‚ºï¼šæ·»åŠ åˆ°æœ«å°¾
        scriptSteps.push(newStep);
        // æ–°å¢åœ¨æœ«å°¾æ™‚ï¼Œè‡ªå‹•æ²å‹•åˆ°åº•éƒ¨ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°æ–°æ­¥é©Ÿ
        setTimeout(scrollToBottom, 50); 
    }

    renderScript();
    saveScriptToLocalStorage(); // <--- å„²å­˜
}

/**
 * è¨­å®šæ’å…¥éŒ¨é» (é»æ“Šè™›ç·šæ¡†)
 */
function setInsertAnchor(index) {
    insertAnchorIndex = index;
    renderScript();
    // æ»¾å‹•åˆ°è…³æœ¬åˆ—è¡¨çš„åº•éƒ¨ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°æ“ä½œé¢æ¿
    scrollToBottom();
}

/**
 * å–æ¶ˆæ’å…¥éŒ¨é» (é»æ“Šå–æ¶ˆæŒ‰éˆ•)
 */
function clearInsertAnchor() {
    insertAnchorIndex = -1;
    renderScript();
}

// =================================================================
// 6. æ ¸å¿ƒå‹•ç•«èˆ‡æµç¨‹æ§åˆ¶å‡½æ•¸
// =================================================================

// è·é›¢è¨ˆç®— (Haversine å…¬å¼ï¼Œå›å‚³å…¬å°º)
function distance(p1,p2){
  const R=6371000; const toRad=x=>x*Math.PI/180;
  const dLat=toRad(p2[0]-p1[0]); const dLon=toRad(p2[1]-p1[1]);
  const lat1=toRad(p1[0]),lat2=toRad(p2[0]);
  const a=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

function start(gps){ marker.setLatLng(gps); }
function setIcon(name){ marker.setIcon(icons[name]); }
function show(words){
  if(popup) mapInstance.closePopup(popup);
  
  // *** ä¿®æ­£æ–¹æ¡ˆï¼šå‹•æ…‹èª¿æ•´ popupAnchor ***
  const isMobileVertical = window.innerWidth <= 767;
  let anchor = [0, -iconSize / 2]; // é è¨­ (å¾€ä¸Šå½ˆ)
  
  if (isMobileVertical) {
      // åœ¨æ‰‹æ©Ÿç¸±å‘æ¨¡å¼ä¸‹ï¼Œå¦‚æœåœ°åœ–é»é è¿‘é ‚éƒ¨ï¼ˆä¾‹å¦‚ç·¯åº¦é«˜ï¼Œå¾€åŒ—èµ°ï¼‰ï¼Œå‰‡å‘ä¸‹å½ˆ
      // ç°¡å–®åˆ¤æ–·ï¼šå¦‚æœåœ°åœ–ä¸Šçš„æ¨™è¨˜åœ¨å®¹å™¨çš„ä¸ŠåŠéƒ¨åˆ† (å‡è¨­ y < 50%)
      const mapContainerRect = document.getElementById('map').getBoundingClientRect();
      const markerPoint = mapInstance.latLngToContainerPoint(marker.getLatLng());
      
      // å¦‚æœæ¨™è¨˜çš„ Y åº§æ¨™åœ¨åœ°åœ–å®¹å™¨çš„ 40% é«˜åº¦ä»¥å…§ï¼Œå°±å‘ä¸‹å½ˆå‡º
      if (markerPoint.y < mapContainerRect.height * 0.4) {
           // å¼·åˆ¶å¾€ä¸‹å½ˆå‡º (Y åº§æ¨™ç‚ºæ­£å€¼ + é¡å¤–ç·©è¡ 15px)
           // é¡å¤–å¢åŠ  10 åƒç´ ç·©è¡ï¼Œç¢ºä¿å®Œå…¨é¿é–‹è£åˆ‡
           anchor = [0, iconSize / 2 + 25]; 
      }
      
  }
  
  popup = L.popup({
      closeButton:false, 
      autoClose:true, 
      className: 'custom-large-popup',
      autoPan: false, // é˜»æ­¢åœ°åœ–ç§»å‹•
      offset: anchor // ä½¿ç”¨è¨ˆç®—å‡ºçš„éŒ¨é»
    })
    .setLatLng(marker.getLatLng())
    .setContent(words)
    .openOn(mapInstance);
  setTimeout(()=>{ mapInstance.closePopup(popup); popup=null; }, 1000);
}

/**
 * ç²å–æš«åœ Promiseã€‚å¦‚æœå·²æš«åœï¼Œå‰‡é˜»å¡åŸ·è¡Œã€‚
 */
function getPausePromise() {
    if (isPaused) {
        return new Promise(resolve => {
            pauseResolve = resolve;
        });
    }
    return Promise.resolve();
}

/**
 * æš«åœ/ç¹¼çºŒ æ’­æ”¾
 */
function pauseToggle() { // <-- HTML onclick èª¿ç”¨
    const btn = document.getElementById('pause-resume-button');
    if (!isScriptRunning) return;

    isPaused = !isPaused;
    btn.title = isPaused ? 'ç¹¼çºŒæ’­æ”¾' : 'æš«åœæ’­æ”¾';
    
    // æ ¹æ“šç‹€æ…‹æ›´æ–°æŒ‰éˆ•æ–‡å­— (æ–°ï¼šåŒ…å«æ–‡å­—èªªæ˜)
    btn.querySelector('span').textContent = isPaused ? 'â–¶ï¸ ç¹¼çºŒæ’­æ”¾' : 'â¸ï¸ æš«åœæ’­æ”¾';
    
    // Resume Logic: å¾æš«åœåˆ‡æ›åˆ°ç¹¼çºŒ
    if (!isPaused && pauseResolve) {
        pauseResolve(); // ç¹¼çºŒ executeScript loop
        pauseResolve = null;

        // Resume current WAIT animation
        if (currentWaitResolve && currentWaitRemainingTime > 0) {
            currentWaitStartTime = Date.now();
            currentWaitTimeoutId = setTimeout(currentWaitResolve, currentWaitRemainingTime);
        }
    } 
    // Pause Logic: å¾é‹è¡Œåˆ‡æ›åˆ°æš«åœ
    else if (isPaused) {
        // Pause current WAIT animation (ç«‹å³åœæ­¢è¨ˆæ™‚å™¨)
        if (currentWaitTimeoutId) {
            clearTimeout(currentWaitTimeoutId);
            currentWaitRemainingTime -= (Date.now() - currentWaitStartTime);
            currentWaitTimeoutId = null;
        }
        
        // Note: 'goto' animation is NOT paused, it will run to completion and then stop due to `getPausePromise()` check in the loop.
    }
}

/**
 * åœæ­¢æ’­æ”¾ (æ–°å¢åŠŸèƒ½)
 */
function stopScript() {
    if (!isScriptRunning) return;

    isScriptRunning = false;
    isPaused = false;
    
    // åœæ­¢æ‰€æœ‰ç­‰å¾…/æš«åœ
    if (pauseResolve) pauseResolve();
    if (currentWaitTimeoutId) clearTimeout(currentWaitTimeoutId);
    
    // æ¸…é™¤ç‹€æ…‹å’ŒUI
    document.getElementById('play-button').disabled = false;
    document.getElementById('pause-resume-button').disabled = true;
    document.getElementById('stop-button').disabled = true;

    document.getElementById('play-button').classList.add('bg-indigo-500', 'hover:bg-indigo-700');
    document.getElementById('play-button').classList.remove('bg-gray-400');
    
    document.getElementById('pause-resume-button').querySelector('span').textContent = 'â¸ï¸ æš«åœ/ç¹¼çºŒ';
    document.getElementById('status-message').textContent = 'â—¼ï¸ æ’­æ”¾å·²åœæ­¢ã€‚';
    
    // æ¸…é™¤æ‰€æœ‰æ­¥é©Ÿé«˜äº®
    document.querySelectorAll('[id^="step-"]').forEach(el => el.classList.remove('ring-2', 'ring-indigo-500', 'shadow-md'));
}


// å‡½å¼: ç­‰å¾… (Promise ç‰ˆæœ¬, æ”¯æ´æš«åœ)
function wait(sec){
    return new Promise(resolve => {
        // æ¸…é™¤ä¸Šä¸€å€‹ wait çš„ç‹€æ…‹
        currentWaitResolve = resolve;
        currentWaitStartTime = Date.now();
        currentWaitRemainingTime = sec * 1000;

        function resolveAndClear() {
             currentWaitResolve = null;
             currentWaitTimeoutId = null;
             resolve();
        }

        currentWaitTimeoutId = setTimeout(resolveAndClear, currentWaitRemainingTime);
    });
}

/**
 * ç•«é¢è®Šæš—è®Šäº®å‹•ç•« (æ¨¡æ“¬éå¤œæ•ˆæœ)
 * @param {number} sec - ç­‰å¾…ç§’æ•¸
 * @returns {Promise<void>}
 */
function animateNight(sec) {
    const overlay = document.getElementById('night-overlay');
    const fadeDuration = 1000; // 1 ç§’è®Šæš—ï¼Œ1 ç§’è®Šäº®
    
    return new Promise(async (resolve) => {
        // è¨­å®š transition duration
        overlay.style.transitionDuration = `${fadeDuration}ms`;
        
        // **ä¿®æ­£ï¼šå¼·åˆ¶ç€è¦½å™¨é‡ç¹ª (Reflow)ï¼Œç¢ºä¿ duration è¨­å®šç”Ÿæ•ˆï¼Œé˜²æ­¢å‹•ç•«è¢«è·³é**
        overlay.offsetHeight; 

        // --- 1. è®Šæš— (Fade In) ---
        overlay.style.opacity = '1';
        
        // ç­‰å¾…è®Šæš—å‹•ç•«å®Œæˆ
        await wait(fadeDuration / 1000); 
        await getPausePromise(); 

        // --- 2. ä¿æŒé»‘æš— (Dark Hold) ---
        // ç¢ºä¿ holdDuration è‡³å°‘ç‚º 0.01s
        const holdDuration = Math.max(0.01, sec - (2 * fadeDuration) / 1000); 
        await wait(holdDuration);
        await getPausePromise(); 

        // --- 3. è®Šäº® (Fade Out) ---
        overlay.style.opacity = '0';
        
        // ç­‰å¾…è®Šäº®å‹•ç•«å®Œæˆ
        await wait(fadeDuration / 1000); 
        await getPausePromise(); 
        
        // æ¸…ç†æ¨£å¼
        overlay.style.transitionDuration = `0ms`; 
        resolve();
    });
}

// å‡½å¼: ç§»å‹• (Promise ç‰ˆæœ¬)
function goto(gps){
  return new Promise(resolve => {
    if(currentAnimation) return;
    currentAnimation=true;
    const startPos=marker.getLatLng();
    if(polyline) mapInstance.removeLayer(polyline);
    polyline=L.polyline([startPos,gps],{color:'blue',opacity:0.6, weight: 5}).addTo(mapInstance);
    const bounds=L.latLngBounds([startPos,gps]);
    
    // **ä¿®æ­£ï¼šåœ¨ç¸®æ”¾æ™‚åŠ å…¥ padding ç·©è¡ï¼Œç¢ºä¿èµ·è¨–é»ä¸æœƒè²¼é‚Š**
    // 80px ç·©è¡åœ¨æ¡Œæ©Ÿå’Œæ‰‹æ©Ÿä¸Šéƒ½èƒ½æä¾›è‰¯å¥½çš„é‚Šè·
    mapInstance.flyToBounds(bounds, {duration: 1.5, padding: [80, 80]}); 
    
    // ç­‰å¾…åœ°åœ–å¹³ç§»å¾Œé–‹å§‹æ¨™è¨˜å‹•ç•«
    setTimeout(()=>{
      // æŠ˜ç·šæ·¡å…¥å‹•ç•« (ç°¡åŒ–ï¼šç›´æ¥è¨­ç½®ä¸æ·¡å…¥ï¼Œé¿å…èˆ‡æ·¡å‡ºå‹•ç•«è¡çª)
      polyline.setStyle({opacity: 0.8});

      const dist=distance([startPos.lat,startPos.lng],gps); // è·é›¢ (å…¬å°º)
      let duration; // å‹•ç•«æ™‚é•· (æ¯«ç§’)
      const MAX_DURATION = 6000; // æœ€é•·æ™‚é•· 6 ç§’ (æ¯«ç§’)
      
      const iconName=Object.keys(icons).find(k=>icons[k]===marker.options.icon);
      let speed; // é€Ÿåº¦ (m/s)
      
      // æ ¹æ“šåœ–æ¨™åç¨±è¨­å®šé€Ÿåº¦
      if (iconName === 'walk' || iconName === 'dine' || iconName === 'view' || iconName === 'shopping') { 
        speed = 100; // æ­¥è¡Œå’Œéœæ…‹å‹•ä½œé€Ÿåº¦
      } else if (iconName === 'bus' || iconName === 'car' || iconName === 'airplane') { // æ–°å¢ airplane
        speed = 400; // èª¿æ•´ç‚º 400 m/s
      } else {
        speed = 700; // é è¨­é€Ÿåº¦ (ç«è»Š/æ©Ÿè»Š)
      }
      
      duration = dist / speed * 1000;
      duration = Math.min(duration, MAX_DURATION); // å¼·åˆ¶è¨­å®šæœ€é•·æ™‚é•·ç‚º 6 ç§’

      let startTime=null;

      function animateMarker(ts){
        if(!startTime) startTime=ts;
        const progress=(ts-startTime)/duration;
        if(progress>=1){
          // å‹•ç•«çµæŸ
          marker.setLatLng(gps);
          
          let removeProgress=1;
          // æŠ˜ç·šæ·¡å‡ºå’Œç§»é™¤
          function removeLine(){
            removeProgress-=0.02;
            polyline.setStyle({opacity:Math.max(removeProgress,0)});
            if(removeProgress>0) requestAnimationFrame(removeLine);
            else { 
              mapInstance.removeLayer(polyline);
              currentAnimation=false; 
              resolve(); // è§£æ±º Promise
            }
          }
          requestAnimationFrame(removeLine);

        }else{
          // æ¨™è¨˜ç§»å‹•
          const lat=startPos.lat+(gps[0]-startPos.lat)*progress;
          const lng=startPos.lng+(gps[1]-startPos.lng)*progress;
          marker.setLatLng([lat,lng]);
          requestAnimationFrame(animateMarker);
        }
      }
      requestAnimationFrame(animateMarker);
    },1500); // ç­‰å¾… mapInstance.flyToBounds çµæŸ
  });
}

/**
 * åŸ·è¡ŒåŠ‡æœ¬
 * @param {number} startIndex - å¾å“ªå€‹æ­¥é©Ÿç´¢å¼•é–‹å§‹åŸ·è¡Œ (0ç‚ºSTARTï¼Œ1ç‚ºç¬¬ä¸€å€‹å¯åŸ·è¡Œæ­¥é©Ÿ)
 */
function executeScript(startIndex = 1) { // <-- HTML onclick èª¿ç”¨
    if (isScriptRunning) return;

    const playButton = document.getElementById('play-button');
    const statusMessage = document.getElementById('status-message');
    const pauseButton = document.getElementById('pause-resume-button');
    const stopButton = document.getElementById('stop-button'); // æ–°å¢åœæ­¢æŒ‰éˆ•

    // è¨­ç½®é‹è¡Œç‹€æ…‹
    isScriptRunning = true;
    isPaused = false; // é‡è¨­æš«åœç‹€æ…‹
    
    playButton.disabled = true;
    pauseButton.disabled = false;
    stopButton.disabled = false; // å•Ÿç”¨åœæ­¢æŒ‰éˆ•
    pauseButton.title = 'æš«åœæ’­æ”¾';
    // æ›´æ–°æŒ‰éˆ•æ–‡å­—
    pauseButton.querySelector('span').textContent = 'â¸ï¸ æš«åœæ’­æ”¾';

    playButton.classList.remove('bg-indigo-500', 'hover:bg-indigo-700');
    playButton.classList.add('bg-gray-400');
    statusMessage.textContent = 'â–¶ï¸ åŠ‡æœ¬é–‹å§‹åŸ·è¡Œ...';
    
    // æ¸…é™¤æ‰€æœ‰æ­¥é©Ÿé«˜äº®
    document.querySelectorAll('[id^="step-"]').forEach(el => el.classList.remove('ring-2', 'ring-indigo-500', 'shadow-md'));

    // --- 1. ç‹€æ…‹é‡å»ºï¼šç¢ºä¿æ¨™è¨˜å¾æ­£ç¢ºçš„ä½ç½®å’Œåœ–æ¨™é–‹å§‹ ---
    let currentLat = scriptSteps[0].lat;
    let currentLng = scriptSteps[0].lng;
    let currentIcon = 'motorcycle'; // é è¨­åœ–æ¨™ (æ©Ÿè»Šåœ–æ¨™)

    for (let j = 0; j < startIndex; j++) {
        const step = scriptSteps[j];
        if (step.type === 'start') {
            currentLat = step.lat;
            currentLng = step.lng;
            if (step.icon) {
                currentIcon = step.icon;
            }
        } else if (step.type === 'goto') {
            currentLat = step.lat;
            currentLng = step.lng;
            if (step.icon) {
                currentIcon = step.icon;
            }
        } else if (step.type === 'activity') { 
            if (step.icon) {
                currentIcon = step.icon;
            }
        } else if (step.type === 'dayoff') {
            // Dayoff ä¸æ”¹è®Šä½ç½®ï¼Œä½†æœƒå¼·åˆ¶è¨­ç‚º sleep
            currentIcon = 'sleep';
        }
    }

    // æ‡‰ç”¨é‡å»ºçš„ç‹€æ…‹
    start([currentLat, currentLng]);
    setIcon(currentIcon);
    mapInstance.setView([currentLat, currentLng], 13);
    // ----------------------------------------------------


    // 2. æŒ‰ç…§æ­¥é©Ÿé †åºåŸ·è¡Œ
    async function runSteps() { // ä½¿ç”¨ä¸€å€‹ async å…§éƒ¨å‡½æ•¸ä¾†è™•ç† await
        for (let i = startIndex; i < scriptSteps.length; i++) {
            
            if (!isScriptRunning) break; // æª¢æŸ¥æ˜¯å¦è¢« stopScript åœæ­¢

            // æª¢æŸ¥æš«åœç‹€æ…‹ (å¦‚æœå·²æš«åœï¼Œç¨‹å¼æœƒåœ¨æ­¤è™•ç­‰å¾…)
            await getPausePromise(); 
            
            if (!isScriptRunning) break; // å†æ¬¡æª¢æŸ¥ï¼Œé˜²æ­¢åœ¨å¾æš«åœæ¢å¾©å¾Œç«‹å³åœæ­¢

            const step = scriptSteps[i];
            
            // æ›´æ–°ç•¶å‰åŸ·è¡Œç‹€æ…‹
            statusMessage.textContent = `åŸ·è¡Œä¸­: æ­¥é©Ÿ ${i}. ${step.label || step.type}`;
            document.getElementById(`step-${i}`).classList.add('ring-2', 'ring-indigo-500', 'shadow-md');

            try {
                switch (step.type) {
                    case 'activity':
                        // **Activity = setIcon (å¯é¸) + wait (å¯é¸)**
                        // 1. setIcon (å¦‚æœæœ‰ icon)
                        if (step.icon) {
                            setIcon(step.icon);
                        }
                        // 2. wait (å¦‚æœæœ‰ sec è«– > 0)
                        if (step.sec && step.sec > 0) {
                            await wait(step.sec);
                        }
                        break;
                    case 'show':
                        // ä¿æŒ show ç¨ç«‹åŠŸèƒ½
                        show(step.words);
                        await wait(1); // é¡¯ç¤ºè¨Šæ¯å¾ŒçŸ­æš«ç­‰å¾…ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°
                        break;
                    case 'goto':
                        // **å¦‚æœ goto å¸¶æœ‰ iconï¼Œå‰‡å…ˆæ›åœ–æ¨™**
                        if (step.icon) {
                            setIcon(step.icon);
                        }
                        await goto([step.lat, step.lng]);
                        
                        // **å¦‚æœ goto å¸¶æœ‰ words (ä¸”éç©º)ï¼Œå‰‡æ¥è‘—é¡¯ç¤ºè¨Šæ¯**
                        if (step.words && step.words.trim() !== '') {
                            show(step.words);
                            await wait(1); // é¡¯ç¤ºè¨Šæ¯å¾ŒçŸ­æš«ç­‰å¾…ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°
                        }
                        break;
                    case 'dayoff':
                        // **Dayoff æ­¥é©Ÿ**
                        setIcon('sleep');
                        await animateNight(step.sec);
                        break;
                }
            } catch (error) {
                console.error(`æ­¥é©Ÿ ${i} åŸ·è¡ŒéŒ¯èª¤:`, error);
                // é‡åˆ°éŒ¯èª¤ï¼Œèª¿ç”¨ stopScript æ¸…ç†ç‹€æ…‹
                stopScript();
                statusMessage.textContent = `âŒ éŒ¯èª¤: æ­¥é©Ÿ ${i} åŸ·è¡Œå¤±æ•—ï¼Œå·²ä¸­æ–·ã€‚`;
                return; 
            }
            
            // æ¸…é™¤ç•¶å‰æ­¥é©Ÿé«˜äº®
            document.getElementById(`step-${i}`).classList.remove('ring-2', 'ring-indigo-500', 'shadow-md');
        }

        // 3. åŸ·è¡ŒçµæŸ
        if (isScriptRunning) { // åªæœ‰åœ¨æ²’æœ‰è¢«æ‰‹å‹•åœæ­¢æ™‚æ‰é¡¯ç¤ºå®Œæˆ
            stopScript(); // ä½¿ç”¨ stopScript åŸ·è¡Œæ¨™æº–çµæŸæ¸…ç†
            statusMessage.textContent = 'âœ… åŠ‡æœ¬åŸ·è¡Œå®Œç•¢ï¼';
        }
    }
    
    // å•Ÿå‹•åŸ·è¡Œ
    runSteps();
}


/**
 * å…¨åŸŸéµç›¤äº‹ä»¶è™•ç†å‡½å¼ 
 */
function handleKeydown(event) {
    const modal = document.getElementById('import-modal');
    const importTextarea = document.getElementById('import-data-textarea');
    
    // åªæœ‰åœ¨æ¨¡æ…‹æ¡†é¡¯ç¤ºæ™‚æ‰è™•ç†éµç›¤äº‹ä»¶
    if (!modal || modal.classList.contains('hidden')) { // æª¢æŸ¥ modal æ˜¯å¦å­˜åœ¨ä¸”æ˜¯å¦éš±è—
        return;
    }
    
    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…å½±éŸ¿å…¶ä»–è¼¸å…¥æ¡†
    event.stopPropagation();
    
    switch (event.key) {
        case 'Escape':
            closeImportModal();
            break;
        case 'Enter':
            // åªæœ‰ç•¶ç„¦é»ä¸åœ¨ textarea æˆ–æŒ‰äº† shift éµæ™‚ï¼Œæ‰å…è¨±æ›è¡Œ
            // å¦å‰‡ï¼ŒåŸ·è¡Œç¢ºèª
            if (document.activeElement === importTextarea && event.shiftKey) {
                 // æŒ‰ä¸‹ Shift + Enter å…è¨±æ›è¡Œ
                 return;
            } else if (document.activeElement === importTextarea && !event.shiftKey) {
                // åœ¨ textarea å…§ï¼Œå–®ç¨æŒ‰ Enterï¼ŒåŸ·è¡Œç¢ºèª
                event.preventDefault(); 
                handleImportConfirmation();
            }
            // å¦‚æœç„¦é»åœ¨å…¶ä»–åœ°æ–¹ (ä¾‹å¦‚ç¢ºèªæŒ‰éˆ•)ï¼Œå–®æŒ‰ Enter è§¸ç™¼ç¢ºèª (handleImportConfirmation())
            break;
    }
}

/**
 * æç¤ºä¸¦åŸ·è¡Œæ¸…é™¤åŠ‡æœ¬å‹•ä½œ (å…©æ­¥é©Ÿç¢ºèª)
 */
function promptClearScript() { // <-- HTML onclick èª¿ç”¨
    const btn = document.getElementById('delete-all-button');
    const originalText = 'ğŸ—‘ï¸ å…¨éƒ¨åˆªé™¤';
    const confirmText = 'âš ï¸ ç¢ºèªå…¨éƒ¨åˆªé™¤? (5s)';

    // æª¢æŸ¥æ˜¯å¦è™•æ–¼ç¢ºèªç‹€æ…‹
    if (btn.textContent.includes('ç¢ºèª')) {
        clearScript();
        return;
    }
    
    // é€²å…¥ç¢ºèªç‹€æ…‹
    btn.textContent = confirmText;
    btn.classList.remove('bg-red-400', 'hover:bg-red-600');
    btn.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');

    // è¨­ç½® 5 ç§’å¾Œé‡ç½®æŒ‰éˆ•
    clearTimeout(clearScriptTimeoutId);
    clearScriptTimeoutId = setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.add('bg-red-400', 'hover:bg-red-600');
        btn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');
    }, 5000);
}

/**
 * æ¸…é™¤æ‰€æœ‰åŠ‡æœ¬æ­¥é©Ÿï¼Œåªä¿ç•™ç¬¬ä¸€å€‹ 'start' æ­¥é©Ÿ
 */
function clearScript() {
    const btn = document.getElementById('delete-all-button');
    const statusMessage = document.getElementById('status-message');

    // æ¸…é™¤ç¢ºèªç‹€æ…‹è¨ˆæ™‚å™¨
    clearTimeout(clearScriptTimeoutId);

    // é‡è¨­åŠ‡æœ¬ç‚ºåªæœ‰ç¬¬ä¸€å€‹ 'start' æ­¥é©Ÿ (ä½¿ç”¨ START_STEP_DEFINITION ä¾†é‡è¨­)
    scriptSteps = [
        { 
            type: START_STEP_DEFINITION.type, 
            lat: START_STEP_DEFINITION.lat, 
            lng: START_STEP_DEFINITION.lng, 
            label: START_STEP_DEFINITION.label 
        }
    ];

    clearInsertAnchor(); // æ¸…é™¤éŒ¨é»ç‹€æ…‹
    renderScript();
    saveScriptToLocalStorage();

    // æ¢å¾©æŒ‰éˆ•å’Œç‹€æ…‹è¨Šæ¯
    btn.textContent = 'ğŸ—‘ï¸ å…¨éƒ¨åˆªé™¤';
    btn.classList.add('bg-red-400', 'hover:bg-red-600');
    btn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');
    statusMessage.textContent = 'ğŸ—‘ï¸ åŠ‡æœ¬å·²æ¸…é™¤ï¼Œå·²æ¢å¾©åˆå§‹æ­¥é©Ÿã€‚';
}


/**
 * 4. æ²å‹•è…³æœ¬åˆ—è¡¨åˆ°æœ€åº•éƒ¨
 */
function scrollToBottom() { // <-- HTML onclick èª¿ç”¨
    const controlsContainer = document.getElementById('controls');
    // æ²å‹•åˆ° controls å®¹å™¨çš„æœ€åº•éƒ¨
    controlsContainer.scrollTop = controlsContainer.scrollHeight;
}


/**
 * 2. é¡¯ç¤ºè‡ªè¨‚åŒ¯å…¥æ¨¡æ…‹æ¡† (å–ä»£åŸç”Ÿ prompt)
 */
function showImportModal() { // <-- HTML onclick èª¿ç”¨
    const modal = document.getElementById('import-modal');
    const modalContent = document.getElementById('import-modal-content');
    const importTextarea = document.getElementById('import-data-textarea');
    
    // æ¸…é™¤ä¸Šæ¬¡çš„è²¼ä¸Šå…§å®¹
    importTextarea.value = '';
    
    // é¡¯ç¤ºæ¨¡æ…‹æ¡†
    modal.classList.remove('hidden');
    // è®“ textarea å–å¾—ç„¦é» (å•Ÿç”¨ Enter æäº¤)
    importTextarea.focus(); 
    
    // è§¸ç™¼éæ¸¡å‹•ç•«
    setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);

    // æ¸…é™¤ç‹€æ…‹è¨Šæ¯
    document.getElementById('status-message').textContent = 'ç­‰å¾…è²¼ä¸Šæ•¸æ“š...';
}

/**
 * é—œé–‰è‡ªè¨‚åŒ¯å…¥æ¨¡æ…‹æ¡†
 */
function closeImportModal() { // <-- HTML onclick èª¿ç”¨
    const modal = document.getElementById('import-modal');
    const modalContent = document.getElementById('import-modal-content');

    // è§¸ç™¼é€€å‡ºå‹•ç•«
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');

    // éš±è—æ¨¡æ…‹æ¡†
    setTimeout(() => {
        modal.classList.add('hidden');
        document.getElementById('status-message').textContent = 'æº–å‚™å°±ç·’';
    }, 300); // é…åˆ CSS transition 300ms
}


/**
 * 3. è™•ç†æ¨¡æ…‹æ¡†ä¸­çš„ç¢ºèªåŒ¯å…¥æŒ‰éˆ•é»æ“Š
 */
function handleImportConfirmation() { // <-- HTML onclick èª¿ç”¨
    const dataString = document.getElementById('import-data-textarea').value;
    const statusMessage = document.getElementById('status-message');

    if (dataString.trim() === "") {
        statusMessage.textContent = 'âš ï¸ è«‹è²¼å…¥æ•¸æ“šå­—ä¸²ã€‚';
        return;
    }
    
    // åŸ·è¡ŒåŒ¯å…¥é‚è¼¯
    try {
        // ** é—œéµä¿®æ­£ï¼šå…ˆé€²è¡Œ URI è§£ç¢¼ **
        const rawJsonString = decodeURIComponent(dataString);
        
        const result = loadImportedData(rawJsonString);
        if (result) {
            statusMessage.textContent = 'âœ… åŠ‡æœ¬æ•¸æ“šå·²æˆåŠŸè²¼ä¸Šä¸¦è¼‰å…¥ï¼';
            saveScriptToLocalStorage(); // è¼‰å…¥æˆåŠŸå¾Œå„²å­˜åˆ° Local Storage
            renderScript();
            closeImportModal();
        } else {
            statusMessage.textContent = 'âŒ è²¼ä¸Šçš„æ•¸æ“šæ ¼å¼ç„¡æ•ˆæˆ–å·²æå£ã€‚';
        }
    } catch (e) {
        statusMessage.textContent = 'âŒ è²¼ä¸Šçš„æ•¸æ“šè§£æå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ ¼å¼ã€‚';
        console.error('Import failed:', e);
    }
}


/**
 * åŒ¯å‡ºåŠ‡æœ¬ï¼šå°‡å„ªåŒ–å¾Œçš„ JSON å­—ä¸²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚
 */
async function exportScript() { // <-- HTML onclick èª¿ç”¨
    const statusMessage = document.getElementById('status-message');
    // ç§»é™¤æ‰‹å‹•è¤‡è£½æç¤º (å¦‚æœå­˜åœ¨)
    const p = document.getElementById('manual-copy-prompt');
    if (p) p.remove();

    let dataString = ''; 
    
    try {
        // --- 1. æ•¸æ“šå„ªåŒ–èˆ‡è½‰æ› (å£“ç¸®çµæ§‹) ---
        
        const compactScript = scriptSteps.map(step => {
            const compact = [];
            switch (step.type) {
                case 'start':
                    compact.push('s', step.lat, step.lng);
                    if (step.label) compact.push(step.label);
                    return compact;
                case 'goto':
                    compact.push('g', step.lat, step.lng);
                    if (step.icon) compact.push(step.icon.charAt(0)); 
                    else compact.push('');
                    if (step.words) compact.push(step.words);
                    return compact;
                case 'activity':
                    compact.push('a', step.sec);
                    if (step.icon) compact.push(step.icon.charAt(0)); 
                    return compact;
                case 'show':
                    compact.push('h', step.words);
                    return compact;
                case 'dayoff':
                    compact.push('d', step.sec);
                    return compact;
            }
            return compact;
        });

        // 2. JSON.stringify è½‰æ›ç‚ºå­—ä¸²
        const rawJsonString = JSON.stringify(compactScript);
        
        // ** 3. é—œéµä¿®æ­£ï¼šURI ç·¨ç¢¼ä»¥ç¢ºä¿é ASCII å­—ç¬¦çš„å®‰å…¨å‚³è¼¸ **
        dataString = encodeURIComponent(rawJsonString);
        
    } catch (error) {
        statusMessage.textContent = 'âŒ åŠ‡æœ¬æ•¸æ“šè½‰æ›å¤±æ•—ã€‚';
        console.error('æ•¸æ“šè½‰æ›å¤±æ•—:', error);
        return; 
    }
    
    // --- 4. è¤‡è£½åˆ°å‰ªè²¼ç°¿ (URI ç·¨ç¢¼å¾Œçš„æ•¸æ“šå­—ä¸²) ---
    try {
        await navigator.clipboard.writeText(dataString);

        const p = document.getElementById('manual-copy-prompt');
        if (p) p.remove();

        statusMessage.textContent = 'âœ… æ•¸æ“šå·²è¤‡è£½ï¼è«‹è²¼ä¸Šä»¥åˆ†äº«ã€‚';
        setTimeout(() => {
            statusMessage.textContent = 'æº–å‚™å°±ç·’';
        }, 3000);

    } catch (error) {
        // Clipboard API å¤±æ•—æ™‚ï¼Œä½¿ç”¨ document.execCommand('copy') ä½œç‚º fallback
        try {
            const tempInput = document.createElement('textarea');
            tempInput.value = dataString; 
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);

            const p = document.getElementById('manual-copy-prompt');
            if (p) p.remove();

            statusMessage.textContent = 'âœ… æ•¸æ“šå·²è¤‡è£½ï¼(ä½¿ç”¨å‚™ç”¨è¤‡è£½) è«‹è²¼ä¸Šä»¥åˆ†äº«ã€‚';
            setTimeout(() => {
                statusMessage.textContent = 'æº–å‚™å°±ç·’';
            }, 3000);
        } catch (copyError) {
             // å…©ç¨®è¤‡è£½æ–¹å¼çš†å¤±æ•— (æ²™ç›’æ¨¡å¼ä¸‹é æœŸè¡Œç‚º)ï¼Œé¡¯ç¤ºæ‰‹å‹•è¤‡è£½æç¤º
             statusMessage.textContent = 'âŒ è¤‡è£½å¤±æ•—ï¼(æ²™ç›’æ¨¡å¼é™åˆ¶) è«‹æ‰‹å‹•è¤‡è£½ä¸‹æ–¹æ•¸æ“šã€‚';
             showManualCopyPrompt(dataString); // é¡¯ç¤º URI ç·¨ç¢¼å¾Œçš„æ•¸æ“šå­—ä¸²è®“ç”¨æˆ¶æ‰‹å‹•è¤‡è£½
        }
    }
}


/**
 * æ¸²æŸ“åŠ‡æœ¬åˆ—è¡¨
 */
function renderScript() {
    const listContainer = document.getElementById('script-list');
    listContainer.innerHTML = '';
    
    // --- é¡è‰²äº¤æ›¿é‚è¼¯çš„è®Šæ•¸ (ä¿®è¨‚ç‚ºæ—¥åˆ†çµ„) ---
    const DAY_COLORS = ['bg-indigo-100', 'bg-pink-100']; 
    const BORDER_COLORS = ['border-indigo-400', 'border-pink-400'];
    let dayIndex = 0; // 0 (Day 1, Indigo) æˆ– 1 (Day 2, Pink)
    // ---------------------------------

    // ** è™•ç†æ’å…¥æ¨¡å¼æç¤ºèˆ‡å–æ¶ˆæŒ‰éˆ• **
    const insertStatusPanel = document.getElementById('insert-status-panel');
    if(insertStatusPanel) insertStatusPanel.innerHTML = ''; // æª¢æŸ¥æ˜¯å¦å­˜åœ¨å¾Œå†æ¸…ç©º

    if (insertAnchorIndex !== -1) {
        // æ¸²æŸ“æ’å…¥æ¨¡å¼æç¤ºåˆ°æ–°çš„é¢æ¿ä¸­ (åŒ…å«å–æ¶ˆæŒ‰éˆ•)
        if(insertStatusPanel) insertStatusPanel.innerHTML = `
            <div class="p-3 mb-3 bg-yellow-200 rounded-lg border border-yellow-500 flex justify-between items-center shadow-md">
                <span class="font-bold text-yellow-800">ğŸ“Œ æ’å…¥æ¨¡å¼ä¸­ï¼šæ­¥é©Ÿå°‡æ’å…¥åˆ° #${insertAnchorIndex} ä½ç½®ã€‚</span>
                 <!-- æ¸²æŸ“å–æ¶ˆæŒ‰éˆ• -->
                 <button onclick="clearInsertAnchor()" class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-700 transition duration-150 text-sm">
                    âŒ å–æ¶ˆæ’å…¥
                </button>
            </div>
        `;
    }
    // ----------------------------------------------------


    scriptSteps.forEach((step, index) => {
        
        // æ’å…¥éŒ¨é» UI (åœ¨æ¯å€‹æ­¥é©Ÿä¸Šæ–¹æ’å…¥)
        if (index > 0) { // é™¤äº†ç¬¬ä¸€å€‹æ­¥é©Ÿ (0. START) ä¹‹å¤–
            const anchorElement = document.createElement('div');
            // ä¿®æ­£ï¼šç§»é™¤ opacity-0 å’Œ h-0ï¼Œåªåœ¨æ‡¸åœæ™‚æ”¹è®Šæ¨£å¼
            anchorElement.className = 'insert-anchor transition-all duration-300'; 
            anchorElement.dataset.index = index;
            
            anchorElement.onclick = () => { setInsertAnchor(index); }; // ç›´æ¥è¨­ç½®é»æ“Šäº‹ä»¶
            
            // ä¿®æ­£: é¡¯ç¤ºå¯é»æ“Šçš„æ–‡æœ¬ï¼Œæ‡¸åœæ™‚é€šé CSS è®Šæˆè™›ç·šæ¡†
            anchorElement.innerHTML = `<span class="insert-anchor-text">åœ¨æ­¤è™•æ·»åŠ è¡Œç¨‹ (#${index})</span>`;
            
            listContainer.appendChild(anchorElement);
        }

        const stepElement = document.createElement('div');
        stepElement.id = `step-${index}`;
        // æ­¥é©Ÿå…ƒç´ çš„åŸºæœ¬æ¨£å¼ï¼šåœ“è§’ã€é™°å½±ã€éæ¸¡æ•ˆæœ
        stepElement.className = 'p-3 rounded-lg shadow-sm transition-all duration-200 border border-opacity-50'; 
        
        let contentHtml = '';
        let stepColor = 'text-gray-700';
        let stepIcon = 'ğŸ”¹';

        const isStartStep = index === 0;
        const buttonAction = `executeScript(${isStartStep ? 1 : index})`;
        const startIcon = isStartStep ? 'ğŸ ' : 'â–¶ï¸';
        const startButtonTitle = isStartStep ? 'å¾é ­æ’¥æ”¾' : 'å¾é€™é‚Šé–‹å§‹æ’¥æ”¾';

        
        // --- æ‡‰ç”¨é¡è‰²é‚è¼¯ (ä¿®è¨‚ï¼šæ—¥åˆ†çµ„) ---
        // 1. æª¢æŸ¥æ˜¯å¦é‡åˆ° Dayoffï¼Œå¦‚æœæ˜¯ï¼Œå‰‡ç¿»è½‰æ—¥æ•¸ (å¾ä¸Šä¸€æ­¥é©Ÿä¾†çœ‹)
        if (index > 0 && scriptSteps[index - 1].type === 'dayoff') {
            dayIndex = 1 - dayIndex; // ç¿»è½‰ 0 <-> 1
        }
        
        // 2. æ‡‰ç”¨ç•¶å‰æ—¥çš„åŸºç¤è‰²
        if (step.type === 'dayoff') {
            // Dayoff æ­¥é©Ÿï¼šä½¿ç”¨ä¸­æ€§è‰²çªé¡¯ï¼Œä¸¦ä¿ç•™ç²‰è‰²çš„æ–‡å­—é¡è‰²
            stepElement.classList.add('bg-gray-200', 'border-gray-400');
            stepColor = 'text-pink-700'; 
        } else {
            // Start å’Œæ‰€æœ‰å…¶ä»–æ­¥é©Ÿï¼šæ‡‰ç”¨ Day N çš„é¡è‰²
            stepElement.classList.add(DAY_COLORS[dayIndex]); // æ‡‰ç”¨æ·¡ç´«æˆ–æ·¡ç²‰ç´…
            stepElement.classList.add(BORDER_COLORS[dayIndex]); // æ‡‰ç”¨å°æ‡‰çš„é‚Šæ¡†è‰²
        }

        if (step.type === 'start') {
            // Start Step: å¼·åˆ¶ä½¿ç”¨ Day 1 çš„æ·±è‰²é‚Šæ¡†å’Œçªé¡¯æ–‡å­—è‰²
            stepElement.classList.remove('border-opacity-50');
            stepElement.classList.add('border-indigo-500');
            stepColor = 'text-purple-700';
        }
        // ------------------


        switch (step.type) {
            case 'start':
                // (Start stepColor/Iconå·²åœ¨ä¸Šé¢è¨­å®š)
                stepIcon = 'ğŸ“';
                
                // çµ„åˆç‚ºå–®ä¸€åº§æ¨™å­—ä¸²
                const startCoordValue = (step.lat && step.lng) ? `${step.lat}, ${step.lng}` : '';

                contentHtml = `
                    <p class="text-xs text-red-500 font-semibold mb-2">âš ï¸ é€™æ˜¯æ—…ç¨‹çš„**å¼·åˆ¶**åˆå§‹é»ï¼Œä¸èƒ½åˆªé™¤æˆ–ç§»å‹•ã€‚</p>
                    <span class="font-bold">åˆå§‹ä½ç½®</span><br>
                    <small>GPS åº§æ¨™ (ç·¯åº¦, ç¶“åº¦, ä¾‹å¦‚: 26.2173, 127.6924):</small>
                    <!-- é—œéµè®Šå‹•ï¼šå–®ä¸€æ–‡å­—è¼¸å…¥æ¬„ä½ for åº§æ¨™ï¼Œä½¿ç”¨ 'coords' æ¬„ä½æ›´æ–° -->
                    <input type="text" 
                           class="w-full text-sm border rounded px-2 mt-1" 
                           placeholder="ç·¯åº¦, ç¶“åº¦" 
                           value="${startCoordValue}" 
                           onchange="updateStep(${index}, 'coords', this.value)">
                `;
                break;
            case 'goto':
                // çµ„åˆç‚ºå–®ä¸€åº§æ¨™å­—ä¸²
                const coordValue = (step.lat && step.lng) ? `${step.lat}, ${step.lng}` : '';
                stepColor = 'text-blue-700';
                stepIcon = 'â¡ï¸';
                contentHtml = `
                    <span class="font-bold">ç§»å‹•åˆ°</span>
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="æ­¥é©Ÿæ¨™ç±¤ (ex: åˆ°é”ç‰§å¿—ç«™)" value="${step.label || ''}" onchange="updateStep(${index}, 'label', this.value)">
                    <small>GPS åº§æ¨™ (ç·¯åº¦, ç¶“åº¦, ä¾‹å¦‚: 26.2173, 127.6924):</small>
                    <input type="text" 
                           class="w-full text-sm border rounded px-2 mt-1" 
                           placeholder="ç·¯åº¦, ç¶“åº¦" 
                           value="${coordValue}" 
                           onchange="updateStep(${index}, 'coords', this.value)">
                    <small class="mt-2 block">ç§»å‹•åœ–æ¨™ (å¯é¸):</small>
                    <select class="w-full text-sm border rounded px-2 mt-1" onchange="updateStep(${index}, 'icon', this.value)">
                        <option value="">(ä¿æŒä¸è®Š)</option>
                        ${ICON_NAMES.map(name => `<option value="${name}" ${step.icon === name ? 'selected' : ''}>${name}</option>`).join('')}
                    </select>
                    <small class="mt-2 block">æŠµé”æ™‚é¡¯ç¤ºè¨Šæ¯ (å¯é¸):</small>
                    <input type="text" 
                           class="w-full text-sm border rounded px-2 mt-1" 
                           placeholder="æŠµé”æ™‚å½ˆå‡ºè¨Šæ¯ (ç•™ç©ºå‰‡ä¸é¡¯ç¤º)" 
                           value="${step.words || ''}" 
                           onchange="updateStep(${index}, 'words', this.value)">
                `;
                break;
            case 'activity':
                // **æ–°é‚è¼¯ï¼šActivity = setIcon (å¯é¸) + wait (å¯é¸)**
                stepColor = 'text-green-700';
                stepIcon = 'ğŸƒ';
                contentHtml = `
                    <span class="font-bold">æ´»å‹•/ç‹€æ…‹ (è®Šæ›´åœ–æ¨™æˆ–ç­‰å¾…)</span>
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="æ­¥é©Ÿæ¨™ç±¤ (ex: æ­£åœ¨æ‹ç…§)" value="${step.label || ''}" onchange="updateStep(${index}, 'label', this.value)">
                    
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div>
                            <small class="block">åœ–æ¨™ (å¯é¸):</small>
                            <select class="w-full text-sm border rounded px-2 mt-1" onchange="updateStep(${index}, 'icon', this.value)">
                                <option value="">(ä¿æŒä¸è®Š)</option>
                                ${ICON_NAMES.map(name => `<option value="${name}" ${step.icon === name ? 'selected' : ''}>${name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <small class="block">æŒçºŒæ™‚é–“ (ç§’æ•¸, å¯é¸):</small>
                            <input type="number" 
                                   class="w-full text-sm border rounded px-2 mt-1" 
                                   placeholder="0" 
                                   value="${step.sec || ''}" 
                                   onchange="updateStep(${index}, 'sec', parseFloat(this.value))">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">è‹¥ç§’æ•¸ç‚º 0 æˆ–ç•™ç©ºï¼Œå‰‡åªåŸ·è¡Œåœ–æ¨™è®Šæ›´ã€‚</p>
                `;
                break;
            case 'show':
                stepColor = 'text-yellow-700';
                stepIcon = 'ğŸ’¬';
                contentHtml = `
                    <span class="font-bold">é¡¯ç¤ºè¨Šæ¯</span>
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="æ­¥é©Ÿæ¨™ç±¤ (ex: é¡¯ç¤ºï¼šç‰§å¿—ç«™)" value="${step.label || ''}" onchange="updateStep(${index}, 'label', this.value)">
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="è¨Šæ¯å…§å®¹" value="${step.words || ''}" onchange="updateStep(${index}, 'words', this.value)">
                `;
                break;
            case 'dayoff':
                // (Dayoff stepColorå·²åœ¨ä¸Šé¢è¨­å®š)
                stepIcon = 'ğŸ›Œ';
                contentHtml = `
                    <span class="font-bold">ä¼‘æ¯éå¤œ</span>
                    <p class="text-xs text-gray-500 mt-1 mb-2">åŸ·è¡Œ setIcon='sleep' ä¸¦æ’­æ”¾å¤œé–“å‹•ç•«ã€‚</p>
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="æ­¥é©Ÿæ¨™ç±¤ (ex: å…¥ä½ä¼‘æ¯)" value="${step.label || ''}" onchange="updateStep(${index}, 'label', this.value)">
                    <small>æŒçºŒæ™‚é–“ (ç§’æ•¸): <input type="number" class="w-20 text-xs border rounded px-1" value="${step.sec}" onchange="updateStep(${index}, 'sec', parseFloat(this.value))"></small>
                `;
                break;
        }

        stepElement.innerHTML = `
            <div class="flex justify-between items-start mb-1">
                <div class="flex items-center">
                    <span class="${stepColor} font-semibold">${stepIcon} ${index}. ${step.type.toUpperCase()}</span>
                    <!-- è®Šæ›´ç‚ºåœ–ç¤ºæŒ‰éˆ• -->
                    <button class="ml-2 text-base text-indigo-500 hover:text-indigo-700 transition"
                            onclick="${buttonAction}"
                            title="${startButtonTitle}">
                            ${startIcon}
                    </button>
                </div>
                
                <div class="space-x-1">
                    <!-- Move Up (Disabled if isStartStep or is the second step) -->
                    <button class="text-gray-400 text-sm ${isStartStep || index === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:text-gray-700'}" 
                            onclick="moveStep(${index}, -1)" 
                            ${isStartStep || index === 1 ? 'disabled' : ''}>â¬†ï¸</button>
                    <!-- Move Down (Disabled if isStartStep or is the last step) -->
                    <button class="text-gray-400 text-sm ${isStartStep || index === scriptSteps.length - 1 ? 'opacity-50 cursor-not-allowed' : 'hover:text-gray-700'}" 
                            onclick="moveStep(${index}, 1)" 
                            ${isStartStep || index === scriptSteps.length - 1 ? 'disabled' : ''}>â¬‡ï¸</button>
                    <!-- Delete (Disabled if isStartStep) -->
                    <button class="text-red-400 text-sm ${isStartStep ? 'opacity-50 cursor-not-allowed' : 'hover:text-red-700'}" 
                            onclick="deleteStep(${index})" 
                            ${isStartStep ? 'disabled' : ''}>âŒ</button>
                </div>
            </div>
            ${contentHtml}
        `;
        listContainer.appendChild(stepElement);
    });

    // æœ€å¾Œä¸€å€‹éŒ¨é» (åœ¨æœ€å¾Œä¸€å€‹æ­¥é©Ÿä¸‹æ–¹)
    const finalAnchorElement = document.createElement('div');
    finalAnchorElement.className = 'insert-anchor my-2 transition-all duration-300';
    finalAnchorElement.dataset.index = scriptSteps.length;
    finalAnchorElement.onclick = () => { setInsertAnchor(scriptSteps.length); };
    // ä¿®æ­£: é¡¯ç¤ºå¯é»æ“Šçš„æ–‡æœ¬ï¼Œæ‡¸åœæ™‚é€šé CSS è®Šæˆè™›ç·šæ¡†
    finalAnchorElement.innerHTML = `<span class="insert-anchor-text">åœ¨æ­¤è™•æ·»åŠ è¡Œç¨‹ (#${scriptSteps.length})</span>`;
    listContainer.appendChild(finalAnchorElement);

    // ** ä¿®æ­£ 1: è™•ç† [æ‹‰åˆ°æœ€ä¸‹é¢] æŒ‰éˆ•çš„é¡¯ç¤º/éš±è— **
    const controlsContainer = document.getElementById('controls');
    const scrollToBottomContainer = document.getElementById('scroll-to-bottom-container');
    
    // åªæœ‰ç•¶å…§å®¹é«˜åº¦å¤§æ–¼å¯è¦–å€åŸŸæ™‚æ‰é¡¯ç¤ºæŒ‰éˆ•
    // ä½¿ç”¨ setTimeout ç¢ºä¿ DOM æ¸²æŸ“å®Œæˆå¾Œå†è¨ˆç®—é«˜åº¦
    setTimeout(() => {
        if (controlsContainer.scrollHeight > controlsContainer.clientHeight) {
            scrollToBottomContainer.classList.remove('hidden');
        } else {
            scrollToBottomContainer.classList.add('hidden');
        }
    }, 100);
}
</script>
</head>
<body class="bg-gray-50">
<!-- ä¿®æ­£ 1 & 3: éŸ¿æ‡‰å¼ä½ˆå±€èª¿æ•´ -->
<div class="flex flex-col md:flex-row h-screen overflow-hidden">
  
  <!-- å³å´åœ°åœ–é¡¯ç¤ºå€ (åœ¨è¡Œå‹•è£ç½®ä¸Šåœ¨ä¸ŠåŠéƒ¨) -->
  <div id="map-container" class="w-full md:w-2/3 relative mobile-h-half h-full">
    <div id="map"></div>
    <!-- æ–°å¢ï¼šå¤œé–“å‹•ç•«é®ç½©ã€‚çµ•å°å®šä½è¦†è“‹åœ°åœ– -->
    <div id="night-overlay" class="absolute inset-0 z-[1000]"></div>
  </div>

  <!-- å·¦å´æ§åˆ¶é¢æ¿ (åœ¨è¡Œå‹•è£ç½®ä¸Šåœ¨ä¸‹åŠéƒ¨) -->
  <div id="controls" class="w-full md:w-1/3 p-4 bg-white shadow-xl overflow-y-auto flex flex-col relative mobile-h-half h-full">
    <h1 class="text-2xl font-bold text-indigo-600 mb-4 border-b pb-2">ğŸ—ºï¸ æ—…ç¨‹åŠ‡æœ¬è¨­è¨ˆå™¨</h1>

    <!-- è…³æœ¬æ­¥é©Ÿåˆ—è¡¨ - é€™æ˜¯æ²å‹•çš„å…§å®¹ -->
    <div id="script-list" class="space-y-3 flex-grow mb-4">
      <!-- æ­¥é©Ÿå°‡åœ¨æ­¤è™•æ¸²æŸ“ -->
    </div>
    
    <!-- å‹•ä½œæŒ‰éˆ• -->
    <div class="space-y-2 mb-4 p-4 border rounded-lg bg-indigo-50">
        <p class="font-semibold text-sm text-indigo-700">æ–°å¢å‹•ä½œï¼š</p>
        <div class="grid grid-cols-2 gap-2 text-sm">
            <button onclick="addStep('goto')" class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition duration-150">ç§»å‹• (Goto)</button>
            <button onclick="addStep('activity')" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition duration-150">æ´»å‹•/ç‹€æ…‹ (Activity)</button>
            <button onclick="addStep('show')" class="bg-yellow-500 text-gray-800 p-2 rounded-lg hover:bg-yellow-600 transition duration-150">é¡¯ç¤ºè¨Šæ¯ (Show)</button>
            <button onclick="addStep('dayoff')" class="bg-pink-500 text-white p-2 rounded-lg hover:bg-pink-600 transition duration-150 col-span-2">ä¼‘æ¯éå¤œ</button>
        </div>
        <p class="text-xs text-indigo-500 mt-2 font-semibold">é»æ“Šæ­¥é©Ÿé–“çš„è™›ç·šæ¡†ä»¥è¨­å®šæ’å…¥é»ã€‚</p>
    </div>
    
    <!-- æ–°å¢ï¼šæ’å…¥æ¨¡å¼ç‹€æ…‹èˆ‡å–æ¶ˆæŒ‰éˆ• (ä½æ–¼åŠŸèƒ½å¢ä¸­) -->
    <div id="insert-status-panel" class="mb-4">
        <!-- å…§å®¹ç”± renderScript æ¸²æŸ“ (åŒ…å«å–æ¶ˆæŒ‰éˆ•) -->
    </div>

    <!-- æ’­æ”¾æ§åˆ¶æŒ‰éˆ• -->
    <div class="flex space-x-2 mb-2">
        <!-- æš«åœ/ç¹¼çºŒæŒ‰éˆ• -->
        <button id="pause-resume-button" onclick="pauseToggle()" 
            class="w-1/2 bg-yellow-500 text-gray-800 font-bold py-3 rounded-xl shadow-lg hover:bg-yellow-600 transition duration-300 transform hover:scale-[1.01] text-lg disabled:opacity-50 disabled:cursor-not-allowed" 
            disabled 
            title="æš«åœæ’­æ”¾">
            <span class="text-lg">â¸ï¸ æš«åœ/ç¹¼çºŒ</span>
        </button>
         <!-- åœæ­¢æ’­æ”¾æŒ‰éˆ• (æ–°å¢) -->
        <button id="stop-button" onclick="stopScript()" 
            class="w-1/2 bg-gray-500 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-gray-600 transition duration-300 transform hover:scale-[1.01] text-lg disabled:opacity-50 disabled:cursor-not-allowed" 
            disabled 
            title="åœæ­¢æ’­æ”¾">
            <span class="text-lg">â—¼ï¸ åœæ­¢æ’­æ”¾</span>
        </button>
    </div>


    <!-- æ’­æ”¾æŒ‰éˆ• -->
    <button id="play-button" onclick="executeScript(1)" class="w-full bg-indigo-500 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-[1.01] text-lg mb-2">
      â–¶ï¸ å¾é ­é–‹å§‹æ’­æ”¾ (PLAY)
    </button>
    
    <!-- åŒ¯å‡ºèˆ‡åˆªé™¤æŒ‰éˆ• (æ–°ä½ˆå±€) -->
    <div class="flex space-x-2 mb-2">
        <!-- åŒ¯å‡ºæŒ‰éˆ•ï¼šåªè¤‡è£½è³‡æ–™å­—ä¸² -->
        <button id="export-button" onclick="exportScript()" class="w-1/3 bg-gray-200 text-gray-800 font-bold py-3 rounded-xl shadow-lg hover:bg-gray-300 transition duration-300 transform hover:scale-[1.01] text-lg">
          ğŸ“„ è¤‡è£½æ•¸æ“š
        </button>
        <!-- æ–°å¢ï¼šåŒ¯å…¥æŒ‰éˆ• -->
        <button id="import-button" onclick="showImportModal()" class="w-1/3 bg-gray-400 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-gray-500 transition duration-300 transform hover:scale-[1.01] text-lg">
          ğŸ“¥ è²¼ä¸Šæ•¸æ“š
        </button>
        <!-- åˆªé™¤æŒ‰éˆ• -->
        <button id="delete-all-button" onclick="promptClearScript()" class="w-1/3 bg-red-400 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-red-600 transition duration-300 transform hover:scale-[1.01] text-lg">
          ğŸ—‘ï¸ å…¨éƒ¨åˆªé™¤
        </button>
    </div>

    <div id="status-message" class="mt-2 text-center text-sm font-medium text-gray-600">æº–å‚™å°±ç·’</div>

    <!-- éŒ¯èª¤æ™‚é¡¯ç¤ºçš„æ‰‹å‹•è¤‡è£½å€åŸŸæœƒå‹•æ…‹æ’å…¥æ­¤è™• -->

    <!-- æ–°å¢ï¼šæ‹‰åˆ°æœ€ä¸‹é¢æŒ‰éˆ• (STICKY/å›ºå®šåœ¨å…§å®¹åº•éƒ¨) -->
    <div id="scroll-to-bottom-container" class="w-full p-2 -mx-4 bg-white shadow-md border-t border-gray-200 z-10 hidden">
        <button onclick="scrollToBottom()" class="w-full bg-gray-100 text-gray-700 font-semibold py-2 rounded-lg hover:bg-gray-200 transition duration-150 text-sm">
            ğŸ‘‡ æ‹‰åˆ°æœ€ä¸‹é¢
        </button>
    </div>

  </div> <!-- End #controls -->
</div>

<!-- 1. è‡ªè¨‚åŒ¯å…¥æ•¸æ“šæ¨¡æ…‹æ¡† (Modal UI) -->
<!-- ä¿®æ­£ 1 & 2: Z-index æå‡åˆ°æœ€é«˜ï¼Œä¸¦ä¿®æ­£æ‰‹æ©Ÿå®šä½ -->
<div id="import-modal" class="fixed top-0 bottom-0 left-0 w-full md:w-1/3 bg-black bg-opacity-50 z-[9999] flex items-center justify-center hidden">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg modal-transition scale-95 opacity-0" id="import-modal-content">
        <h2 class="text-xl font-bold text-indigo-600 mb-4 border-b pb-2">ğŸ“¥ è²¼ä¸ŠåŠ‡æœ¬æ•¸æ“š</h2>
        <p class="text-sm text-gray-600 mb-4">è«‹å°‡è¤‡è£½çš„æ•¸æ“šå­—ä¸²è²¼å…¥ä¸‹æ–¹çš„æ–‡å­—å€åŸŸï¼Œå®ƒæœƒè¦†è“‹æ‚¨ç›®å‰çš„åŠ‡æœ¬ã€‚</p>
        <textarea id="import-data-textarea" 
                  class="w-full h-40 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm resize-none" 
                  placeholder="è«‹è²¼ä¸Šå·² URI ç·¨ç¢¼çš„åŠ‡æœ¬æ•¸æ“š..."></textarea>
        <div class="flex justify-end space-x-3 mt-4">
            <button onclick="closeImportModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                å–æ¶ˆ
            </button>
            <button onclick="handleImportConfirmation()" id="confirm-import-button" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition">
                ç¢ºèªåŒ¯å…¥
            </button>
        </div>
    </div>
</div>

<script>
// --------------------------------------------------------
// åˆå§‹åŒ–ï¼š Leaflet/DOM ä¾è³´çš„ç¨‹å¼ç¢¼ç§»å…¥ DOMContentLoaded
// --------------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
    // ä¿®æ­£ Error 1: Map container not found.
    // ç¢ºä¿ #map å…ƒç´ å­˜åœ¨å¾Œæ‰é€²è¡Œåˆå§‹åŒ–
    mapInstance = L.map('map').setView(INITIAL_GPS, 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(mapInstance);
    marker = L.marker(INITIAL_GPS, { icon: icons.train }).addTo(mapInstance);
    
    checkAndLoadScriptFromURL(); 
    renderScript();
    
    // å…¨åŸŸç›£è½éµç›¤äº‹ä»¶
    document.addEventListener('keydown', handleKeydown); 
});
</script>
</body>
</html>