<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Animated Journey Script Editor</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- å¼•å…¥ Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  /* ç¢ºä¿åœ°åœ–ä½”æ»¿å‰©ä¸‹çš„ç©ºé–“ */
  #map { height: 100%; width: 100%; }
  /* ç¢ºä¿ DivIcon å…§çš„ Emoji å±…ä¸­ */
  .leaflet-div-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
  }
  /* å¤œé–“é®ç½©æ¨£å¼ï¼Œåˆå§‹ç‚ºé€æ˜ï¼Œç­‰å¾… JS æ§åˆ¶ */
  #night-overlay {
    background-color: black;
    opacity: 0;
    pointer-events: none; /* è®“é»æ“Šäº‹ä»¶ç©¿é€ */
    transition-property: opacity;
  }
  /* è‡ªè¨‚æ¨£å¼ï¼šæ”¾å¤§æç¤ºè¦–çª— (Popup) */
  .custom-large-popup .leaflet-popup-content-wrapper {
    /* å¤§ç´„æ˜¯é è¨­å¤§å°çš„ 3 å€ */
    font-size: 1.5rem; 
    line-height: 2rem;
    padding: 1.5rem;
    border-radius: 1rem;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    background-color: #fefcbf; /* æŸ”å’Œé»ƒè‰²èƒŒæ™¯ */
    color: #444;
  }
  .custom-large-popup .leaflet-popup-tip {
    background-color: #fefcbf;
    width: 20px;
    height: 10px;
  }
  .custom-large-popup .leaflet-popup-content {
      /* ç¢ºä¿å…§å®¹å¯ä»¥æ’é–‹ */
      width: 100%; 
      max-width: 300px;
      text-align: center;
      font-weight: bold;
  }
  /* æ¨¡æ…‹æ¡†å…§å®¹çš„éæ¸¡æ•ˆæœ */
  .modal-transition {
      transition: opacity 0.3s, transform 0.3s;
  }
</style>
</head>
<body class="bg-gray-50">
<div class="flex h-screen overflow-hidden">
  
  <!-- å·¦å´æ§åˆ¶é¢æ¿ (å¯æ²å‹•å€åŸŸ) -->
  <div id="controls" class="w-full md:w-1/3 p-4 bg-white shadow-xl overflow-y-auto flex flex-col relative">
    <h1 class="text-2xl font-bold text-indigo-600 mb-4 border-b pb-2">ğŸ—ºï¸ æ—…ç¨‹åŠ‡æœ¬è¨­è¨ˆå™¨</h1>

    <!-- è…³æœ¬æ­¥é©Ÿåˆ—è¡¨ - é€™æ˜¯æ²å‹•çš„å…§å®¹ -->
    <div id="script-list" class="space-y-3 flex-grow mb-4">
      <!-- æ­¥é©Ÿå°‡åœ¨æ­¤è™•æ¸²æŸ“ -->
    </div>
    
    <!-- æ–°å¢ï¼šæ‹‰åˆ°æœ€ä¸‹é¢æŒ‰éˆ• (STICKY/å›ºå®šä½ç½®) -->
    <!-- ä½¿ç”¨ sticky é…åˆ bottom-0 z-10 å°‡æŒ‰éˆ•å›ºå®šåœ¨æ§åˆ¶é¢æ¿å¯è¦–ç¯„åœçš„åº•éƒ¨ -->
    <div class="sticky bottom-0 left-0 right-0 p-2 -mx-4 bg-white shadow-md border-t border-gray-200 z-10">
        <button onclick="scrollToBottom()" class="w-full bg-gray-100 text-gray-700 font-semibold py-2 rounded-lg hover:bg-gray-200 transition duration-150 text-sm">
            ğŸ‘‡ æ‹‰åˆ°æœ€ä¸‹é¢
        </button>
    </div>

    <!-- å‹•ä½œæŒ‰éˆ• -->
    <div class="space-y-2 mb-4 p-4 border rounded-lg bg-indigo-50">
        <p class="font-semibold text-sm text-indigo-700">æ–°å¢å‹•ä½œï¼š</p>
        <div class="grid grid-cols-2 gap-2 text-sm">
            <button onclick="addStep('goto')" class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition duration-150">ç§»å‹• (Goto)</button>
            <button onclick="addStep('activity')" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition duration-150">æ´»å‹•/ç‹€æ…‹ (Activity)</button>
            <button onclick="addStep('show')" class="bg-yellow-500 text-gray-800 p-2 rounded-lg hover:bg-yellow-600 transition duration-150">é¡¯ç¤ºè¨Šæ¯ (Show)</button>
            <button onclick="addStep('dayoff')" class="bg-pink-500 text-white p-2 rounded-lg hover:bg-pink-600 transition duration-150 col-span-2">ä¼‘æ¯éå¤œ</button>
        </div>
    </div>
    
    <!-- æš«åœ/ç¹¼çºŒæŒ‰éˆ• -->
    <button id="pause-resume-button" onclick="pauseToggle()" 
        class="w-full bg-yellow-500 text-gray-800 font-bold py-3 rounded-xl shadow-lg hover:bg-yellow-600 transition duration-300 transform hover:scale-[1.01] text-lg mb-2 disabled:opacity-50 disabled:cursor-not-allowed" 
        disabled 
        title="æš«åœæ’­æ”¾">
        <span class="text-lg">â¸ï¸ æš«åœ/ç¹¼çºŒ</span>
    </button>

    <!-- æ’­æ”¾æŒ‰éˆ• -->
    <button id="play-button" onclick="executeScript(1)" class="w-full bg-indigo-500 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-[1.01] text-lg mb-2">
      â–¶ï¸ å¾é ­é–‹å§‹æ’­æ”¾ (PLAY)
    </button>
    
    <!-- åŒ¯å‡ºèˆ‡åˆªé™¤æŒ‰éˆ• (æ–°ä½ˆå±€) -->
    <div class="flex space-x-2 mb-2">
        <!-- åŒ¯å‡ºæŒ‰éˆ•ï¼šåªè¤‡è£½è³‡æ–™å­—ä¸² -->
        <button id="export-button" onclick="exportScript()" class="w-1/3 bg-gray-200 text-gray-800 font-bold py-3 rounded-xl shadow-lg hover:bg-gray-300 transition duration-300 transform hover:scale-[1.01] text-lg">
          ğŸ“„ è¤‡è£½æ•¸æ“š
        </button>
        <!-- æ–°å¢ï¼šåŒ¯å…¥æŒ‰éˆ• -->
        <button id="import-button" onclick="showImportModal()" class="w-1/3 bg-gray-400 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-gray-500 transition duration-300 transform hover:scale-[1.01] text-lg">
          ğŸ“¥ è²¼ä¸Šæ•¸æ“š
        </button>
        <!-- åˆªé™¤æŒ‰éˆ• -->
        <button id="delete-all-button" onclick="promptClearScript()" class="w-1/3 bg-red-400 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-red-600 transition duration-300 transform hover:scale-[1.01] text-lg">
          ğŸ—‘ï¸ å…¨éƒ¨åˆªé™¤
        </button>
    </div>

    <div id="status-message" class="mt-2 text-center text-sm font-medium text-gray-600">æº–å‚™å°±ç·’</div>

    <!-- éŒ¯èª¤æ™‚é¡¯ç¤ºçš„æ‰‹å‹•è¤‡è£½å€åŸŸæœƒå‹•æ…‹æ’å…¥æ­¤è™• -->

  </div> <!-- End #controls -->

  <!-- å³å´åœ°åœ–é¡¯ç¤ºå€ -->
  <div id="map-container" class="w-full md:w-2/3 relative h-screen">
    <div id="map"></div>
    <!-- æ–°å¢ï¼šå¤œé–“å‹•ç•«é®ç½©ã€‚çµ•å°å®šä½è¦†è“‹åœ°åœ– -->
    <div id="night-overlay" class="absolute inset-0 z-[1000]"></div>
  </div>

</div>

<!-- 1. è‡ªè¨‚åŒ¯å…¥æ•¸æ“šæ¨¡æ…‹æ¡† (Modal UI) -->
<!-- è®Šæ›´: å¾ absolute æ”¹ç‚º fixed top-0 bottom-0 left-0 w-1/3ï¼Œä½¿å…¶ä¸éš¨ #controls æ²å‹• -->
<div id="import-modal" class="fixed top-0 bottom-0 left-0 w-full md:w-1/3 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg modal-transition scale-95 opacity-0" id="import-modal-content">
        <h2 class="text-xl font-bold text-indigo-600 mb-4 border-b pb-2">ğŸ“¥ è²¼ä¸ŠåŠ‡æœ¬æ•¸æ“š</h2>
        <p class="text-sm text-gray-600 mb-4">è«‹å°‡è¤‡è£½çš„æ•¸æ“šå­—ä¸²è²¼å…¥ä¸‹æ–¹çš„æ–‡å­—å€åŸŸï¼Œå®ƒæœƒè¦†è“‹æ‚¨ç›®å‰çš„åŠ‡æœ¬ã€‚</p>
        <!-- æ–°å¢ id="import-data-textarea" ä»¥ä¾¿åœ¨ JS ä¸­ç²å–å’Œç›£è½ -->
        <textarea id="import-data-textarea" 
                  class="w-full h-40 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm resize-none" 
                  placeholder="è«‹è²¼ä¸Šå·² URI ç·¨ç¢¼çš„åŠ‡æœ¬æ•¸æ“š..."></textarea>
        <div class="flex justify-end space-x-3 mt-4">
            <button onclick="closeImportModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                å–æ¶ˆ
            </button>
            <button onclick="handleImportConfirmation()" id="confirm-import-button" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition">
                ç¢ºèªåŒ¯å…¥
            </button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// =================================================================
// 1. åœ°åœ–èˆ‡æ¨™è¨˜åˆå§‹åŒ–
// =================================================================
const map = L.map('map').setView([26.20178415387677, 127.64689003446611], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

const iconSize = 75; // <-- åœ–ç¤ºå¤§å°æ”¹ç‚º 75
// åœ–æ¨™åç¨±è®Šæ›´ï¼šrice -> dineï¼Œä¸¦æ–°å¢ airplane
const ICON_NAMES = ['train', 'walk', 'dine', 'sleep', 'bus', 'motorcycle', 'car', 'view', 'shopping', 'airplane']; 
const icons = {
  train: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸš†</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  walk: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸš¶â€â™‚ï¸</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  dine: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸ½ï¸</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }), // è®Šæ›´ç‚ºé¤å…· emoji
  sleep: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸ˜´</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  bus: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸšŒ</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  motorcycle: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸï¸</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  car: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸš—</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  view: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸï¸</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  shopping: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">ğŸ›ï¸</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }),
  airplane: L.divIcon({ html: `<div style="font-size:${iconSize}px; line-height:1;">âœˆï¸</div>`, className:'', iconSize:[iconSize,iconSize], iconAnchor:[iconSize/2,iconSize/2] }) // æ–°å¢é£›æ©Ÿ emoji
};

const INITIAL_GPS = [26.20178415387677, 127.64689003446617];
const marker = L.marker(INITIAL_GPS, { icon: icons.train }).addTo(map);

let polyline = null;
let popup = null;
let currentAnimation = false;

// å®šç¾©åˆå§‹çš„ START æ­¥é©Ÿçµæ§‹ (ç”¨æ–¼é‡ç½®)
const START_STEP_DEFINITION = { 
    type: 'start', 
    lat: 26.20178415387677, 
    lng: 127.64689003446617, 
    label: 'é‚£éœ¸æ©Ÿå ´ (åˆå§‹ä½ç½®)' 
};

// åˆå§‹åŠ‡æœ¬ (å·²å°‡ setIcon å’Œ wait è½‰æ›ç‚º activity)
let scriptSteps = [
    START_STEP_DEFINITION,
];

// =================================================================
// 2. æ ¸å¿ƒå‹•ç•«èˆ‡æµç¨‹æ§åˆ¶
// =================================================================

// æµç¨‹æ§åˆ¶ç‹€æ…‹
let isScriptRunning = false;
let isPaused = false;
let pauseResolve = null; // Resolves when unpaused
let currentWaitTimeoutId = null;
let currentWaitRemainingTime = 0;
let currentWaitStartTime = 0;
let currentWaitResolve = null; // Stores the resolve function of the active wait Promise
let clearScriptTimeoutId = null; // æ–°å¢ï¼šç”¨æ–¼å…¨åˆªé™¤ç¢ºèªè¨ˆæ™‚å™¨


// è·é›¢è¨ˆç®— (Haversine å…¬å¼ï¼Œå›å‚³å…¬å°º)
function distance(p1,p2){
  const R=6371000; const toRad=x=>x*Math.PI/180;
  const dLat=toRad(p2[0]-p1[0]); const dLon=toRad(p2[1]-p1[1]);
  const lat1=toRad(p1[0]),lat2=toRad(p2[0]);
  const a=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

function start(gps){ marker.setLatLng(gps); }
function setIcon(name){ marker.setIcon(icons[name]); }
function show(words){
  if(popup) map.closePopup(popup);
  // **ä¿®æ”¹ï¼šå¢åŠ  className æ‡‰ç”¨è‡ªè¨‚å¤§å°ºå¯¸æ¨£å¼**
  popup = L.popup({
      closeButton:false, 
      autoClose:true, 
      className: 'custom-large-popup' 
    })
    .setLatLng(marker.getLatLng())
    .setContent(words)
    .openOn(map);
  setTimeout(()=>{ map.closePopup(popup); popup=null; }, 1000);
}

/**
 * ç²å–æš«åœ Promiseã€‚å¦‚æœå·²æš«åœï¼Œå‰‡é˜»å¡åŸ·è¡Œã€‚
 */
function getPausePromise() {
    if (isPaused) {
        return new Promise(resolve => {
            pauseResolve = resolve;
        });
    }
    return Promise.resolve();
}

/**
 * æš«åœ/ç¹¼çºŒ æ’­æ”¾
 */
function pauseToggle() {
    const btn = document.getElementById('pause-resume-button');
    if (!isScriptRunning) return;

    isPaused = !isPaused;
    btn.title = isPaused ? 'ç¹¼çºŒæ’­æ”¾' : 'æš«åœæ’­æ”¾';
    
    // æ ¹æ“šç‹€æ…‹æ›´æ–°æŒ‰éˆ•æ–‡å­— (æ–°ï¼šåŒ…å«æ–‡å­—èªªæ˜)
    btn.querySelector('span').textContent = isPaused ? 'â–¶ï¸ ç¹¼çºŒæ’­æ”¾' : 'â¸ï¸ æš«åœæ’­æ”¾';
    
    // Resume Logic: å¾æš«åœåˆ‡æ›åˆ°ç¹¼çºŒ
    if (!isPaused && pauseResolve) {
        pauseResolve(); // ç¹¼çºŒ executeScript loop
        pauseResolve = null;

        // Resume current WAIT animation
        if (currentWaitResolve && currentWaitRemainingTime > 0) {
            currentWaitStartTime = Date.now();
            currentWaitTimeoutId = setTimeout(currentWaitResolve, currentWaitRemainingTime);
        }
    } 
    // Pause Logic: å¾é‹è¡Œåˆ‡æ›åˆ°æš«åœ
    else if (isPaused) {
        // Pause current WAIT animation (ç«‹å³åœæ­¢è¨ˆæ™‚å™¨)
        if (currentWaitTimeoutId) {
            clearTimeout(currentWaitTimeoutId);
            currentWaitRemainingTime -= (Date.now() - currentWaitStartTime);
            currentWaitTimeoutId = null;
        }
        
        // Note: 'goto' animation is NOT paused, it will run to completion and then stop due to `getPausePromise()` check in the loop.
    }
}


// å‡½å¼: ç­‰å¾… (Promise ç‰ˆæœ¬, æ”¯æ´æš«åœ)
function wait(sec){
    return new Promise(resolve => {
        // æ¸…é™¤ä¸Šä¸€å€‹ wait çš„ç‹€æ…‹
        currentWaitResolve = resolve;
        currentWaitStartTime = Date.now();
        currentWaitRemainingTime = sec * 1000;

        function resolveAndClear() {
             currentWaitResolve = null;
             currentWaitTimeoutId = null;
             resolve();
        }

        currentWaitTimeoutId = setTimeout(resolveAndClear, currentWaitRemainingTime);
    });
}

/**
 * ç•«é¢è®Šæš—è®Šäº®å‹•ç•« (æ¨¡æ“¬éå¤œæ•ˆæœ)
 * @param {number} sec - ç­‰å¾…ç§’æ•¸
 * @returns {Promise<void>}
 */
function animateNight(sec) {
    const overlay = document.getElementById('night-overlay');
    const fadeDuration = 1000; // 1 ç§’è®Šæš—ï¼Œ1 ç§’è®Šäº®
    
    return new Promise(async (resolve) => {
        // è¨­å®š transition duration
        overlay.style.transitionDuration = `${fadeDuration}ms`;
        
        // **ä¿®æ­£ï¼šå¼·åˆ¶ç€è¦½å™¨é‡ç¹ª (Reflow)ï¼Œç¢ºä¿ duration è¨­å®šç”Ÿæ•ˆï¼Œé˜²æ­¢å‹•ç•«è¢«è·³é**
        overlay.offsetHeight; 

        // --- 1. è®Šæš— (Fade In) ---
        overlay.style.opacity = '1';
        
        // ç­‰å¾…è®Šæš—å‹•ç•«å®Œæˆ
        await wait(fadeDuration / 1000); 
        await getPausePromise(); 

        // --- 2. ä¿æŒé»‘æš— (Dark Hold) ---
        // ç¢ºä¿ holdDuration è‡³å°‘ç‚º 0.01s
        const holdDuration = Math.max(0.01, sec - (2 * fadeDuration) / 1000); 
        await wait(holdDuration);
        await getPausePromise(); 

        // --- 3. è®Šäº® (Fade Out) ---
        overlay.style.opacity = '0';
        
        // ç­‰å¾…è®Šäº®å‹•ç•«å®Œæˆ
        await wait(fadeDuration / 1000); 
        await getPausePromise(); 
        
        // æ¸…ç†æ¨£å¼
        overlay.style.transitionDuration = `0ms`; 
        resolve();
    });
}

// å‡½å¼: ç§»å‹• (Promise ç‰ˆæœ¬)
function goto(gps){
  return new Promise(resolve => {
    if(currentAnimation) return;
    currentAnimation=true;
    const startPos=marker.getLatLng();
    if(polyline) map.removeLayer(polyline);
    polyline=L.polyline([startPos,gps],{color:'blue',opacity:0.6, weight: 5}).addTo(map);
    const bounds=L.latLngBounds([startPos,gps]);
    
    // æ”¾å¤§åœ°åœ–è¦–åœ–
    map.flyToBounds(bounds,{duration:1.5}); 
    
    // ç­‰å¾…åœ°åœ–å¹³ç§»å¾Œé–‹å§‹æ¨™è¨˜å‹•ç•«
    setTimeout(()=>{
      // æŠ˜ç·šæ·¡å…¥å‹•ç•« (ç°¡åŒ–ï¼šç›´æ¥è¨­ç½®ä¸æ·¡å…¥ï¼Œé¿å…èˆ‡æ·¡å‡ºå‹•ç•«è¡çª)
      polyline.setStyle({opacity: 0.8});

      const dist=distance([startPos.lat,startPos.lng],gps); // è·é›¢ (å…¬å°º)
      let duration; // å‹•ç•«æ™‚é•· (æ¯«ç§’)
      const MAX_DURATION = 6000; // æœ€é•·æ™‚é•· 6 ç§’ (æ¯«ç§’)
      
      const iconName=Object.keys(icons).find(k=>icons[k]===marker.options.icon);
      let speed; // é€Ÿåº¦ (m/s)
      
      // æ ¹æ“šåœ–æ¨™åç¨±è¨­å®šé€Ÿåº¦
      if (iconName === 'walk' || iconName === 'dine' || iconName === 'view' || iconName === 'shopping') { 
        speed = 100; // æ­¥è¡Œå’Œéœæ…‹å‹•ä½œé€Ÿåº¦
      } else if (iconName === 'bus' || iconName === 'car' || iconName === 'airplane') { // æ–°å¢ airplane
        speed = 400; // èª¿æ•´ç‚º 400 m/s
      } else {
        speed = 700; // é è¨­é€Ÿåº¦ (ç«è»Š/æ©Ÿè»Š)
      }
      
      duration = dist / speed * 1000;
      duration = Math.min(duration, MAX_DURATION); // å¼·åˆ¶è¨­å®šæœ€é•·æ™‚é•·ç‚º 6 ç§’

      let startTime=null;

      function animateMarker(ts){
        if(!startTime) startTime=ts;
        const progress=(ts-startTime)/duration;
        if(progress>=1){
          // å‹•ç•«çµæŸ
          marker.setLatLng(gps);
          
          let removeProgress=1;
          // æŠ˜ç·šæ·¡å‡ºå’Œç§»é™¤
          function removeLine(){
            removeProgress-=0.02;
            polyline.setStyle({opacity:Math.max(removeProgress,0)});
            if(removeProgress>0) requestAnimationFrame(removeLine);
            else { 
              map.removeLayer(polyline);
              currentAnimation=false; 
              resolve(); // è§£æ±º Promise
            }
          }
          requestAnimationFrame(removeLine);

        }else{
          // æ¨™è¨˜ç§»å‹•
          const lat=startPos.lat+(gps[0]-startPos.lat)*progress;
          const lng=startPos.lng+(gps[1]-startPos.lng)*progress;
          marker.setLatLng([lat,lng]);
          requestAnimationFrame(animateMarker);
        }
      }
      requestAnimationFrame(animateMarker);
    },1500); // ç­‰å¾… map.flyToBounds çµæŸ
  });
}

// =================================================================
// 3. Local Storage å„²å­˜èˆ‡è¼‰å…¥é‚è¼¯
// =================================================================

const STORAGE_KEY = 'animatedJourneyScript';
const EXPIRY_MS = 2 * 24 * 60 * 60 * 1000; // 2 å¤© (æ¯«ç§’)

/**
 * è¼”åŠ©å‡½å¼ï¼šå„²å­˜è³‡æ–™åˆ° LocalStorageï¼ŒåŒ…å«åˆ°æœŸæ™‚é–“
 */
function setLocalStorage(key, data, expiryMs) {
    const item = {
        data: data,
        expiry: new Date().getTime() + expiryMs,
    }
    try {
        localStorage.setItem(key, JSON.stringify(item));
    } catch (e) {
        console.warn("LocalStorage set failed, possibly due to quota limits.");
    }
}

/**
 * è¼”åŠ©å‡½å¼ï¼šå¾ LocalStorage ç²å–è³‡æ–™ï¼Œä¸¦æª¢æŸ¥æ˜¯å¦åˆ°æœŸ
 */
function getLocalStorage(key) {
    let itemStr;
    try {
        itemStr = localStorage.getItem(key);
    } catch (e) {
        console.warn("LocalStorage get failed.");
        return null;
    }
    
    if (!itemStr) {
        return null;
    }
    
const item = JSON.parse(itemStr);
    const now = new Date().getTime();
    
    // æª¢æŸ¥æ˜¯å¦åˆ°æœŸ
    if (now > item.expiry) {
        localStorage.removeItem(key);
        return null;
    }
    return item.data;
}

/**
 * å°‡ç•¶å‰åŠ‡æœ¬å„²å­˜åˆ° LocalStorage
 */
function saveScriptToLocalStorage() {
    try {
        const jsonString = JSON.stringify(scriptSteps);
        // ç›´æ¥å„²å­˜ JSON å­—ä¸²ï¼ŒLocal Storage æ”¯æ´ UTF-8
        setLocalStorage(STORAGE_KEY, jsonString, EXPIRY_MS);
    } catch (e) {
        console.error('Failed to save script to LocalStorage:', e);
    }
}


// =================================================================
// 5. è³‡æ–™å‚³è¼¸é‚è¼¯ (ä½¿ç”¨ JSON å­—ä¸²è¤‡è£½/è²¼ä¸Šï¼Œå¸¶ URI ç·¨ç¢¼)
// =================================================================

/**
 * è¼”åŠ©å‡½å¼ï¼šç•¶è‡ªå‹•è¤‡è£½å¤±æ•—æ™‚ï¼Œé¡¯ç¤ºæ‰‹å‹•è¤‡è£½çš„è¼¸å…¥æ¬„ä½ã€‚
 */
function showManualCopyPrompt(url) {
    let promptDiv = document.getElementById('manual-copy-prompt');

    // ç§»é™¤èˆŠçš„æç¤º (å¦‚æœå­˜åœ¨)
    if (promptDiv) {
        promptDiv.remove();
    }

    // å‰µå»ºæ–°çš„æç¤ºå€å¡Š
    promptDiv = document.createElement('div');
    promptDiv.id = 'manual-copy-prompt';
    // å°‡å…¶æ’å…¥åˆ°ç‹€æ…‹è¨Šæ¯ä¸‹æ–¹
    document.getElementById('status-message').insertAdjacentElement('afterend', promptDiv);
    promptDiv.className = 'mt-3 p-3 bg-red-100 border border-red-400 rounded-lg shadow-inner';
    
    promptDiv.innerHTML = `
        <p class="text-sm font-semibold text-red-700 mb-2">âš ï¸ **è‡ªå‹•è¤‡è£½å¤±æ•—** (æ²™ç›’æ¨¡å¼é™åˆ¶)ï¼šè«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹æ•¸æ“šï¼š</p>
        <textarea id="manual-copy-textarea" class="w-full text-xs p-2 border border-gray-300 rounded-md resize-none" rows="3" readonly></textarea>
    `;
    
    document.getElementById('manual-copy-textarea').value = url;
    
    // è‡ªå‹•é¸æ“‡æ–‡æœ¬ï¼Œæ–¹ä¾¿ç”¨æˆ¶ä¸€éµè¤‡è£½
    document.getElementById('manual-copy-textarea').select();

    // 15 ç§’å¾Œè‡ªå‹•ç§»é™¤æç¤º
    setTimeout(() => {
        const p = document.getElementById('manual-copy-prompt');
        if (p) p.remove();
    }, 15000); 
}


/**
 * åŒ¯å‡ºåŠ‡æœ¬ï¼šå°‡å„ªåŒ–å¾Œçš„ JSON å­—ä¸²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚
 */
async function exportScript() {
    const statusMessage = document.getElementById('status-message');
    // ç§»é™¤æ‰‹å‹•è¤‡è£½æç¤º (å¦‚æœå­˜åœ¨)
    const p = document.getElementById('manual-copy-prompt');
    if (p) p.remove();

    let dataString = ''; 
    
    try {
        // --- 1. æ•¸æ“šå„ªåŒ–èˆ‡è½‰æ› (å£“ç¸®çµæ§‹) ---
        
        const compactScript = scriptSteps.map(step => {
            const compact = [];
            switch (step.type) {
                case 'start':
                    compact.push('s', step.lat, step.lng);
                    if (step.label) compact.push(step.label);
                    return compact;
                case 'goto':
                    compact.push('g', step.lat, step.lng);
                    if (step.icon) compact.push(step.icon.charAt(0)); 
                    else compact.push('');
                    if (step.words) compact.push(step.words);
                    return compact;
                case 'activity':
                    compact.push('a', step.sec);
                    if (step.icon) compact.push(step.icon.charAt(0)); 
                    return compact;
                case 'show':
                    compact.push('h', step.words);
                    return compact;
                case 'dayoff':
                    compact.push('d', step.sec);
                    return compact;
            }
            return compact;
        });

        // 2. JSON.stringify è½‰æ›ç‚ºå­—ä¸²
        const rawJsonString = JSON.stringify(compactScript);
        
        // ** 3. é—œéµä¿®æ­£ï¼šURI ç·¨ç¢¼ä»¥ç¢ºä¿é ASCII å­—ç¬¦çš„å®‰å…¨å‚³è¼¸ **
        dataString = encodeURIComponent(rawJsonString);
        
    } catch (error) {
        statusMessage.textContent = 'âŒ åŠ‡æœ¬æ•¸æ“šè½‰æ›å¤±æ•—ã€‚';
        console.error('æ•¸æ“šè½‰æ›å¤±æ•—:', error);
        return; 
    }
    
    // --- 4. è¤‡è£½åˆ°å‰ªè²¼ç°¿ (URI ç·¨ç¢¼å¾Œçš„æ•¸æ“šå­—ä¸²) ---
    try {
        await navigator.clipboard.writeText(dataString);

        const p = document.getElementById('manual-copy-prompt');
        if (p) p.remove();

        statusMessage.textContent = 'âœ… æ•¸æ“šå·²è¤‡è£½ï¼è«‹è²¼ä¸Šä»¥åˆ†äº«ã€‚';
        setTimeout(() => {
            statusMessage.textContent = 'æº–å‚™å°±ç·’';
        }, 3000);

    } catch (error) {
        // Clipboard API å¤±æ•—æ™‚ï¼Œä½¿ç”¨ document.execCommand('copy') ä½œç‚º fallback
        try {
            const tempInput = document.createElement('textarea');
            tempInput.value = dataString; 
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);

            const p = document.getElementById('manual-copy-prompt');
            if (p) p.remove();

            statusMessage.textContent = 'âœ… æ•¸æ“šå·²è¤‡è£½ï¼(ä½¿ç”¨å‚™ç”¨è¤‡è£½) è«‹è²¼ä¸Šä»¥åˆ†äº«ã€‚';
            setTimeout(() => {
                statusMessage.textContent = 'æº–å‚™å°±ç·’';
            }, 3000);
        } catch (copyError) {
             // å…©ç¨®è¤‡è£½æ–¹å¼çš†å¤±æ•— (æ²™ç›’æ¨¡å¼ä¸‹é æœŸè¡Œç‚º)ï¼Œé¡¯ç¤ºæ‰‹å‹•è¤‡è£½æç¤º
             statusMessage.textContent = 'âŒ è¤‡è£½å¤±æ•—ï¼(æ²™ç›’æ¨¡å¼é™åˆ¶) è«‹æ‰‹å‹•è¤‡è£½ä¸‹æ–¹æ•¸æ“šã€‚';
             showManualCopyPrompt(dataString); // é¡¯ç¤º URI ç·¨ç¢¼å¾Œçš„æ•¸æ“šå­—ä¸²è®“ç”¨æˆ¶æ‰‹å‹•è¤‡è£½
        }
    }
}


/**
 * 2. é¡¯ç¤ºè‡ªè¨‚åŒ¯å…¥æ¨¡æ…‹æ¡† (å–ä»£åŸç”Ÿ prompt)
 */
function showImportModal() {
    const modal = document.getElementById('import-modal');
    const modalContent = document.getElementById('import-modal-content');
    const importTextarea = document.getElementById('import-data-textarea');
    
    // æ¸…é™¤ä¸Šæ¬¡çš„è²¼ä¸Šå…§å®¹
    importTextarea.value = '';
    
    // é¡¯ç¤ºæ¨¡æ…‹æ¡†
    modal.classList.remove('hidden');
    // è®“ textarea å–å¾—ç„¦é» (å•Ÿç”¨ Enter æäº¤)
    importTextarea.focus(); 
    
    // è§¸ç™¼éæ¸¡å‹•ç•«
    setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);

    // æ¸…é™¤ç‹€æ…‹è¨Šæ¯
    document.getElementById('status-message').textContent = 'ç­‰å¾…è²¼ä¸Šæ•¸æ“š...';
}

/**
 * é—œé–‰è‡ªè¨‚åŒ¯å…¥æ¨¡æ…‹æ¡†
 */
function closeImportModal() {
    const modal = document.getElementById('import-modal');
    const modalContent = document.getElementById('import-modal-content');

    // è§¸ç™¼é€€å‡ºå‹•ç•«
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');

    // éš±è—æ¨¡æ…‹æ¡†
    setTimeout(() => {
        modal.classList.add('hidden');
        document.getElementById('status-message').textContent = 'æº–å‚™å°±ç·’';
    }, 300); // é…åˆ CSS transition 300ms
}


/**
 * 3. è™•ç†æ¨¡æ…‹æ¡†ä¸­çš„ç¢ºèªåŒ¯å…¥æŒ‰éˆ•é»æ“Š
 */
function handleImportConfirmation() {
    const dataString = document.getElementById('import-data-textarea').value;
    const statusMessage = document.getElementById('status-message');

    if (dataString.trim() === "") {
        statusMessage.textContent = 'âš ï¸ è«‹è²¼å…¥æ•¸æ“šå­—ä¸²ã€‚';
        return;
    }
    
    // åŸ·è¡ŒåŒ¯å…¥é‚è¼¯
    try {
        // ** é—œéµä¿®æ­£ï¼šå…ˆé€²è¡Œ URI è§£ç¢¼ **
        const rawJsonString = decodeURIComponent(dataString);
        
        const result = loadImportedData(rawJsonString);
        if (result) {
            statusMessage.textContent = 'âœ… åŠ‡æœ¬æ•¸æ“šå·²æˆåŠŸè²¼ä¸Šä¸¦è¼‰å…¥ï¼';
            saveScriptToLocalStorage(); // è¼‰å…¥æˆåŠŸå¾Œå„²å­˜åˆ° Local Storage
            renderScript();
            closeImportModal();
        } else {
            statusMessage.textContent = 'âŒ è²¼ä¸Šçš„æ•¸æ“šæ ¼å¼ç„¡æ•ˆæˆ–å·²æå£ã€‚';
        }
    } catch (e) {
        statusMessage.textContent = 'âŒ è²¼ä¸Šçš„æ•¸æ“šè§£æå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ ¼å¼ã€‚';
        console.error('Import failed:', e);
    }
}


/**
 * 4. æ²å‹•è…³æœ¬åˆ—è¡¨åˆ°æœ€åº•éƒ¨
 */
function scrollToBottom() {
    const controlsContainer = document.getElementById('controls');
    // æ²å‹•åˆ° controls å®¹å™¨çš„æœ€åº•éƒ¨
    controlsContainer.scrollTop = controlsContainer.scrollHeight;
}


/**
 * å°‡ç°¡åŒ–çš„æ•¸æ“šå­—ä¸²è§£æ§‹ä¸¦è¼‰å…¥åˆ° scriptSteps
 * @param {string} rawJsonString - åŒ¯å…¥çš„ JSON å­—ä¸² (å·²URIè§£ç¢¼)
 * @returns {boolean} - æˆåŠŸè¼‰å…¥è¿”å› true
 */
function loadImportedData(rawJsonString) {
    // Helper to map icon letter back to full name
    const ICON_MAP = {
        't': 'train', 'w': 'walk', 'd': 'dine', 's': 'sleep', 'b': 'bus', 
        'm': 'motorcycle', 'c': 'car', 'v': 'view', 'p': 'shopping', 'a': 'airplane'
    };

    // Helper to uncompact the script format (å¾ compactArray è½‰æ›å› fullScript)
    function uncompactScript(compactArray) {
        const fullScript = [];
        
        // ** ä¿®æ­£: å¤–å±¤è¿´åœˆæ‡‰éæ­·æ¯ä¸€å€‹æ­¥é©Ÿé™£åˆ— **
        for (const compactStep of compactArray) {
            let i = 0; // å…§éƒ¨ç´¢å¼•
            
            // æª¢æŸ¥ compactStep æ˜¯å¦çœŸçš„æ˜¯ä¸€å€‹æ•¸çµ„ï¼Œä¸¦ä¸”ç¬¬ä¸€å€‹å…ƒç´ æ˜¯é¡å‹å­—ç¬¦
            if (!Array.isArray(compactStep) || compactStep.length === 0) {
                 console.warn('Skipping invalid compact step:', compactStep);
                 continue;
            }

            const typeChar = compactStep[i++];
            let step = { label: '' }; // é è¨­ label
            
            switch (typeChar) {
                case 's': // start: s, lat, lng, [label]
                    step.type = 'start';
                    step.lat = compactStep[i++];
                    step.lng = compactStep[i++];
                    // Label is optional for start step in export, but we keep it simple here
                    step.label = 'é‚£éœ¸æ©Ÿå ´ (åˆå§‹ä½ç½®)'; // Use default label for start for simplicity
                    // Skip label if present
                    if (typeof compactStep[i] === 'string') {
                         step.label = compactStep[i++];
                    }
                    break;
                case 'g': // goto: g, lat, lng, iconChar, words
                    step.type = 'goto';
                    step.lat = compactStep[i++];
                    step.lng = compactStep[i++];
                    const iconChar = compactStep[i++];
                    step.icon = iconChar ? ICON_MAP[iconChar] || iconChar : '';
                    step.words = compactStep[i++];
                    step.label = 'è¼‰å…¥çš„ç§»å‹•æ­¥é©Ÿ';
                    break;
                case 'a': // activity: a, sec, [iconChar]
                    step.type = 'activity';
                    step.sec = compactStep[i++];
                    const activityIconChar = compactStep[i];
                    step.icon = activityIconChar ? (ICON_MAP[activityIconChar] || activityIconChar) : '';
                    if (step.icon) i++;
                    step.label = 'è¼‰å…¥çš„æ´»å‹•';
                    break;
                case 'h': // show: h, words
                    step.type = 'show';
                    step.words = compactStep[i++];
                    step.label = 'è¼‰å…¥çš„è¨Šæ¯';
                    break;
                case 'd': // dayoff: d, sec
                    step.type = 'dayoff';
                    step.sec = compactStep[i++];
                    step.label = 'è¼‰å…¥çš„ä¼‘æ¯éå¤œ';
                    break;
                default:
                    console.warn('Unknown compact step type:', typeChar);
                    return null; // åœæ­¢è§£æ (é€™æ˜¯å°è‡´éŒ¯èª¤è¨Šæ¯çš„åŸå› )
            }
            fullScript.push(step);
        }
        return fullScript;
    }

    // 1. è§£æ JSON å­—ä¸²
    let compactArray;
    try {
        compactArray = JSON.parse(rawJsonString);
        // é©—è­‰æœ€å¤–å±¤æ˜¯å¦ç‚ºæ•¸çµ„
        if (!Array.isArray(compactArray)) {
            console.error('Parsed data is not an array.');
            return false;
        }
    } catch (e) {
        console.error('JSON parse error after URI decoding:', e);
        return false;
    }

    // 2. è½‰æ›å›å®Œæ•´åŠ‡æœ¬çµæ§‹
    const loadedSteps = uncompactScript(compactArray);

    // 3. é©—è­‰ä¸¦è¼‰å…¥
    if (Array.isArray(loadedSteps) && loadedSteps.length > 0 && loadedSteps[0].type === 'start') {
        scriptSteps = loadedSteps;
        return true;
    }
    return false;
}


/**
 * æª¢æŸ¥ä¸¦å¾ URL åƒæ•¸æˆ– Local Storage è¼‰å…¥åŠ‡æœ¬ã€‚
 */
function checkAndLoadScriptFromURL() {
    // ** ç§»é™¤ URL åƒæ•¸æª¢æŸ¥ï¼Œåªä¿ç•™ Local Storage æª¢æŸ¥ **
    
    // 1. å¾ Local Storage è¼‰å…¥
    const storedJson = getLocalStorage(STORAGE_KEY);
    const loadSource = 'æœ¬æ©Ÿå„²å­˜';

    if (storedJson) {
        try {
            // Local Storage å„²å­˜çš„æ˜¯ç´” JSON å­—ä¸²ï¼Œç›´æ¥è§£æ
            const loadedSteps = JSON.parse(storedJson); 

            if (Array.isArray(loadedSteps) && loadedSteps.length > 0 && loadedSteps[0].type === 'start') {
                scriptSteps = loadedSteps;
                document.getElementById('status-message').textContent = `ğŸ“¥ åŠ‡æœ¬å·²å¾ ${loadSource} è¼‰å…¥ã€‚`;
                return; 
            }
        } catch (error) {
            console.error('è§£ææœ¬åœ°å„²å­˜åŠ‡æœ¬å¤±æ•—:', error);
        }
    }

    // å¦‚æœ Local Storage ä¸­æ²’æœ‰æœ‰æ•ˆåŠ‡æœ¬ï¼Œå‰‡ä½¿ç”¨åˆå§‹é è¨­åŠ‡æœ¬
}

/**
 * è¼”åŠ©å‡½å¼ï¼šæ‰¾åˆ°ä¸Šä¸€å€‹è¨­å®šä½ç½®çš„æ­¥é©Ÿçš„ä½ç½®
 * @param {number} currentIndex - ç•¶å‰æ­£åœ¨ç·¨è¼¯çš„æ­¥é©Ÿç´¢å¼•
 * @returns {{lat: number, lng: number}} - ä¸Šä¸€å€‹ä½ç½®çš„åº§æ¨™
 */
function getPreviousPosition(currentIndex) {
    if (currentIndex <= 0) {
        // å¦‚æœæ˜¯ç¬¬ä¸€å€‹æ­¥é©Ÿï¼Œå‰‡æ²’æœ‰å‰ä¸€å€‹ä½ç½®
        return { lat: null, lng: null };
    }
    
    // å¾å‰ä¸€å€‹æ­¥é©Ÿé–‹å§‹å¾€å›æ‰¾
    for (let i = currentIndex - 1; i >= 0; i--) {
        const step = scriptSteps[i];
        // åªæœ‰ start å’Œ goto æ­¥é©Ÿè¨­å®šä½ç½®
        if (step.type === 'start' || step.type === 'goto') {
            return { lat: step.lat, lng: step.lng };
        }
    }
    // ç†è«–ä¸Šä¸æ‡‰è©²åˆ°é”é€™è£¡ï¼Œä½†ä½œç‚ºå›é€€ï¼Œè¿”å›ç¬¬ä¸€å€‹æ­¥é©Ÿçš„å®šç¾©ä½ç½®
    return { lat: scriptSteps[0].lat, lng: scriptSteps[0].lng };
}


/**
 * æ¸²æŸ“åŠ‡æœ¬åˆ—è¡¨
 */
function renderScript() {
    const listContainer = document.getElementById('script-list');
    listContainer.innerHTML = '';
    
    // --- é¡è‰²äº¤æ›¿é‚è¼¯çš„è®Šæ•¸ (ä¿®è¨‚ç‚ºæ—¥åˆ†çµ„) ---
    // Day 1/3... ä½¿ç”¨ bg-indigo-100 (æ·¡ç´«), Day 2/4... ä½¿ç”¨ bg-pink-100 (æ·¡ç²‰ç´…)
    const DAY_COLORS = ['bg-indigo-100', 'bg-pink-100']; 
    const BORDER_COLORS = ['border-indigo-400', 'border-pink-400'];
    let dayIndex = 0; // 0 (Day 1, Indigo) æˆ– 1 (Day 2, Pink)
    // ---------------------------------

    scriptSteps.forEach((step, index) => {
        const stepElement = document.createElement('div');
        stepElement.id = `step-${index}`;
        // æ­¥é©Ÿå…ƒç´ çš„åŸºæœ¬æ¨£å¼ï¼šåœ“è§’ã€é™°å½±ã€éæ¸¡æ•ˆæœ
        stepElement.className = 'p-3 rounded-lg shadow-sm transition-all duration-200 border border-opacity-50'; 
        
        let contentHtml = '';
        let stepColor = 'text-gray-700';
        let stepIcon = 'ğŸ”¹';

        const isStartStep = index === 0;
        const buttonAction = `executeScript(${isStartStep ? 1 : index})`;
        const startIcon = isStartStep ? 'ğŸ ' : 'â–¶ï¸';
        const startButtonTitle = isStartStep ? 'å¾é ­æ’¥æ”¾' : 'å¾é€™é‚Šé–‹å§‹æ’¥æ”¾';

        
        // --- æ‡‰ç”¨é¡è‰²é‚è¼¯ (ä¿®è¨‚ï¼šæ—¥åˆ†çµ„) ---
        // 1. æª¢æŸ¥æ˜¯å¦é‡åˆ° Dayoffï¼Œå¦‚æœæ˜¯ï¼Œå‰‡ç¿»è½‰æ—¥æ•¸ (å¾ä¸Šä¸€æ­¥é©Ÿä¾†çœ‹)
        if (index > 0 && scriptSteps[index - 1].type === 'dayoff') {
            dayIndex = 1 - dayIndex; // ç¿»è½‰ 0 <-> 1
        }
        
        // 2. æ‡‰ç”¨ç•¶å‰æ—¥çš„åŸºç¤è‰²
        if (step.type === 'dayoff') {
            // Dayoff æ­¥é©Ÿï¼šä½¿ç”¨ä¸­æ€§è‰²çªé¡¯ï¼Œä¸¦ä¿ç•™ç²‰è‰²çš„æ–‡å­—é¡è‰²
            stepElement.classList.add('bg-gray-200', 'border-gray-400');
            stepColor = 'text-pink-700'; 
        } else {
            // Start å’Œæ‰€æœ‰å…¶ä»–æ­¥é©Ÿï¼šæ‡‰ç”¨ Day N çš„é¡è‰²
            stepElement.classList.add(DAY_COLORS[dayIndex]); // æ‡‰ç”¨æ·¡ç´«æˆ–æ·¡ç²‰ç´…
            stepElement.classList.add(BORDER_COLORS[dayIndex]); // æ‡‰ç”¨å°æ‡‰çš„é‚Šæ¡†è‰²
        }

        if (step.type === 'start') {
            // Start Step: å¼·åˆ¶ä½¿ç”¨ Day 1 çš„æ·±è‰²é‚Šæ¡†å’Œçªé¡¯æ–‡å­—è‰²
            stepElement.classList.remove('border-opacity-50');
            stepElement.classList.add('border-indigo-500');
            stepColor = 'text-purple-700';
        }
        // ------------------


        switch (step.type) {
            case 'start':
                // (Start stepColor/Iconå·²åœ¨ä¸Šé¢è¨­å®š)
                stepIcon = 'ğŸ“';
                
                // çµ„åˆç‚ºå–®ä¸€åº§æ¨™å­—ä¸²
                const startCoordValue = (step.lat && step.lng) ? `${step.lat}, ${step.lng}` : '';

                contentHtml = `
                    <p class="text-xs text-red-500 font-semibold mb-2">âš ï¸ é€™æ˜¯æ—…ç¨‹çš„**å¼·åˆ¶**åˆå§‹é»ï¼Œä¸èƒ½åˆªé™¤æˆ–ç§»å‹•ã€‚</p>
                    <span class="font-bold">åˆå§‹ä½ç½®</span><br>
                    <small>GPS åº§æ¨™ (ç·¯åº¦, ç¶“åº¦, ä¾‹å¦‚: 26.2173, 127.6924):</small>
                    <!-- é—œéµè®Šå‹•ï¼šå–®ä¸€æ–‡å­—è¼¸å…¥æ¬„ä½ for åº§æ¨™ï¼Œä½¿ç”¨ 'coords' æ¬„ä½æ›´æ–° -->
                    <input type="text" 
                           class="w-full text-sm border rounded px-2 mt-1" 
                           placeholder="ç·¯åº¦, ç¶“åº¦" 
                           value="${startCoordValue}" 
                           onchange="updateStep(${index}, 'coords', this.value)">
                `;
                break;
            case 'goto':
                // çµ„åˆç‚ºå–®ä¸€åº§æ¨™å­—ä¸²
                const coordValue = (step.lat && step.lng) ? `${step.lat}, ${step.lng}` : '';
                stepColor = 'text-blue-700';
                stepIcon = 'â¡ï¸';
                contentHtml = `
                    <span class="font-bold">ç§»å‹•åˆ°</span>
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="æ­¥é©Ÿæ¨™ç±¤ (ex: åˆ°é”ç‰§å¿—ç«™)" value="${step.label || ''}" onchange="updateStep(${index}, 'label', this.value)">
                    <small>GPS åº§æ¨™ (ç·¯åº¦, ç¶“åº¦, ä¾‹å¦‚: 26.2173, 127.6924):</small>
                    <input type="text" 
                           class="w-full text-sm border rounded px-2 mt-1" 
                           placeholder="ç·¯åº¦, ç¶“åº¦" 
                           value="${coordValue}" 
                           onchange="updateStep(${index}, 'coords', this.value)">
                    <small class="mt-2 block">ç§»å‹•åœ–æ¨™ (å¯é¸):</small>
                    <select class="w-full text-sm border rounded px-2 mt-1" onchange="updateStep(${index}, 'icon', this.value)">
                        <option value="">(ä¿æŒä¸è®Š)</option>
                        ${ICON_NAMES.map(name => `<option value="${name}" ${step.icon === name ? 'selected' : ''}>${name}</option>`).join('')}
                    </select>
                    <small class="mt-2 block">æŠµé”æ™‚é¡¯ç¤ºè¨Šæ¯ (å¯é¸):</small>
                    <input type="text" 
                           class="w-full text-sm border rounded px-2 mt-1" 
                           placeholder="æŠµé”æ™‚å½ˆå‡ºè¨Šæ¯ (ç•™ç©ºå‰‡ä¸é¡¯ç¤º)" 
                           value="${step.words || ''}" 
                           onchange="updateStep(${index}, 'words', this.value)">
                `;
                break;
            case 'activity':
                // **æ–°é‚è¼¯ï¼šActivity = setIcon (å¯é¸) + wait (å¯é¸)**
                stepColor = 'text-green-700';
                stepIcon = 'ğŸƒ';
                contentHtml = `
                    <span class="font-bold">æ´»å‹•/ç‹€æ…‹ (è®Šæ›´åœ–æ¨™æˆ–ç­‰å¾…)</span>
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="æ­¥é©Ÿæ¨™ç±¤ (ex: æ­£åœ¨æ‹ç…§)" value="${step.label || ''}" onchange="updateStep(${index}, 'label', this.value)">
                    
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div>
                            <small class="block">åœ–æ¨™ (å¯é¸):</small>
                            <select class="w-full text-sm border rounded px-2 mt-1" onchange="updateStep(${index}, 'icon', this.value)">
                                <option value="">(ä¿æŒä¸è®Š)</option>
                                ${ICON_NAMES.map(name => `<option value="${name}" ${step.icon === name ? 'selected' : ''}>${name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <small class="block">æŒçºŒæ™‚é–“ (ç§’æ•¸, å¯é¸):</small>
                            <input type="number" 
                                   class="w-full text-sm border rounded px-2 mt-1" 
                                   placeholder="0" 
                                   value="${step.sec || ''}" 
                                   onchange="updateStep(${index}, 'sec', parseFloat(this.value))">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">è‹¥ç§’æ•¸ç‚º 0 æˆ–ç•™ç©ºï¼Œå‰‡åªåŸ·è¡Œåœ–æ¨™è®Šæ›´ã€‚</p>
                `;
                break;
            case 'show':
                stepColor = 'text-yellow-700';
                stepIcon = 'ğŸ’¬';
                contentHtml = `
                    <span class="font-bold">é¡¯ç¤ºè¨Šæ¯</span>
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="æ­¥é©Ÿæ¨™ç±¤ (ex: é¡¯ç¤ºï¼šç‰§å¿—ç«™)" value="${step.label || ''}" onchange="updateStep(${index}, 'label', this.value)">
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="è¨Šæ¯å…§å®¹" value="${step.words || ''}" onchange="updateStep(${index}, 'words', this.value)">
                `;
                break;
            case 'dayoff':
                // (Dayoff stepColorå·²åœ¨ä¸Šé¢è¨­å®š)
                stepIcon = 'ğŸ›Œ';
                contentHtml = `
                    <span class="font-bold">ä¼‘æ¯éå¤œ</span>
                    <p class="text-xs text-gray-500 mt-1 mb-2">åŸ·è¡Œ setIcon='sleep' ä¸¦æ’­æ”¾å¤œé–“å‹•ç•«ã€‚</p>
                    <input type="text" class="w-full text-sm border rounded px-2 mt-1" placeholder="æ­¥é©Ÿæ¨™ç±¤ (ex: å…¥ä½ä¼‘æ¯)" value="${step.label || ''}" onchange="updateStep(${index}, 'label', this.value)">
                    <small>æŒçºŒæ™‚é–“ (ç§’æ•¸): <input type="number" class="w-20 text-xs border rounded px-1" value="${step.sec}" onchange="updateStep(${index}, 'sec', parseFloat(this.value))"></small>
                `;
                break;
        }

        stepElement.innerHTML = `
            <div class="flex justify-between items-start mb-1">
                <div class="flex items-center">
                    <span class="${stepColor} font-semibold">${stepIcon} ${index}. ${step.type.toUpperCase()}</span>
                    <!-- è®Šæ›´ç‚ºåœ–ç¤ºæŒ‰éˆ• -->
                    <button class="ml-2 text-base text-indigo-500 hover:text-indigo-700 transition"
                            onclick="${buttonAction}"
                            title="${startButtonTitle}">
                            ${startIcon}
                    </button>
                </div>
                
                <div class="space-x-1">
                    <!-- Move Up (Disabled if isStartStep or is the second step) -->
                    <button class="text-gray-400 text-sm ${isStartStep || index === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:text-gray-700'}" 
                            onclick="moveStep(${index}, -1)" 
                            ${isStartStep || index === 1 ? 'disabled' : ''}>â¬†ï¸</button>
                    <!-- Move Down (Disabled if isStartStep or is the last step) -->
                    <button class="text-gray-400 text-sm ${isStartStep || index === scriptSteps.length - 1 ? 'opacity-50 cursor-not-allowed' : 'hover:text-gray-700'}" 
                            onclick="moveStep(${index}, 1)" 
                            ${isStartStep || index === scriptSteps.length - 1 ? 'disabled' : ''}>â¬‡ï¸</button>
                    <!-- Delete (Disabled if isStartStep) -->
                    <button class="text-red-400 text-sm ${isStartStep ? 'opacity-50 cursor-not-allowed' : 'hover:text-red-700'}" 
                            onclick="deleteStep(${index})" 
                            ${isStartStep ? 'disabled' : ''}>âŒ</button>
                </div>
            </div>
            ${contentHtml}
        `;
        listContainer.appendChild(stepElement);
    });
}

/**
 * æ–°å¢æ­¥é©Ÿåˆ°åŠ‡æœ¬
 */
function addStep(type) {
    // æ­¥é©Ÿ 1: å°‡ label é è¨­ç‚ºç©ºå­—ä¸²ï¼Œä»¥ä¾¿é¡¯ç¤º placeholder
    const newStep = { label: '' }; 

    switch (type) {
        case 'goto':
            // GPS åº§æ¨™é è¨­ç‚º nullï¼Œä»¥ä¾¿åœ¨æ¸²æŸ“æ™‚é¡¯ç¤º placeholder
            Object.assign(newStep, { type: 'goto', lat: null, lng: null, icon: 'walk', words: '' });
            break;
        case 'activity':
            // æ–°å¢ Activity å‹•ä½œï¼Œé è¨­ç„¡ icon ä¸”ç­‰å¾… 1 ç§’
            Object.assign(newStep, { type: 'activity', icon: '', sec: 1 });
            break;
        case 'show':
            Object.assign(newStep, { type: 'show', words: '' }); // è¨Šæ¯å…§å®¹ä¹Ÿé è¨­ç‚ºç©ºå­—ä¸²
            break;
        case 'dayoff':
            Object.assign(newStep, { type: 'dayoff', sec: 5 }); // é è¨­ä¼‘æ¯ 5 ç§’
            break;
    }
    scriptSteps.push(newStep);
    renderScript();
    saveScriptToLocalStorage(); // <--- å„²å­˜
}

/**
 * åˆªé™¤æ­¥é©Ÿ (ä¸èƒ½åˆªé™¤ç¬¬ä¸€å€‹ 'start' æ­¥é©Ÿ)
 */
function deleteStep(index) {
    if (index === 0) return; // ä¿è­·ç¬¬ä¸€å€‹æ­¥é©Ÿ
    scriptSteps.splice(index, 1);
    renderScript();
    saveScriptToLocalStorage(); // <--- å„²å­˜
}

/**
 * æ›´æ–°æ­¥é©Ÿè³‡æ–™
 */
function updateStep(index, field, value) {
    if (field === 'coords') {
        // è™•ç† 'coords' (ç·¯åº¦, ç¶“åº¦) è¯åˆè¼¸å…¥, é©ç”¨æ–¼ 'start' å’Œ 'goto'
        const parts = String(value).split(',').map(s => s.trim());
        const lat = parseFloat(parts[0]);
        const lng = parseFloat(parts[1]);

        if (!isNaN(lat) && !isNaN(lng) && parts.length === 2) {
            
            // --- GPS Comparison/Validation ---
            // åƒ…å° goto æ­¥é©Ÿé€²è¡Œæª¢æŸ¥ (index > 0)
            if (index > 0 && scriptSteps[index].type === 'goto') {
                const prevPos = getPreviousPosition(index);
                
                // ä½¿ç”¨ä¸€å€‹å°å®¹å¿å€¼é€²è¡Œæµ®é»æ•¸æ¯”è¼ƒ
                const EPSILON = 0.000001; 
                const isSameLat = Math.abs(lat - prevPos.lat) < EPSILON;
                const isSameLng = Math.abs(lng - prevPos.lng) < EPSILON;
                
                if (isSameLat && isSameLng) {
                    console.error("GPS Error: New position is the same as the previous known position. Aborting update.");
                    document.getElementById('status-message').textContent = 'âš ï¸ éŒ¯èª¤: æ–°ä½ç½®èˆ‡å‰ä¸€æ­¥é©Ÿçš„ä½ç½®ç›¸åŒï¼Œç§»å‹•å°‡è¢«å¿½ç•¥ã€‚';
                    setTimeout(() => { document.getElementById('status-message').textContent = 'æº–å‚™å°±ç·’'; }, 3000);
                    return; 
                }
            }
            // --- End Validation ---

            scriptSteps[index].lat = lat;
            scriptSteps[index].lng = lng;
            saveScriptToLocalStorage();
        } else {
            console.error("Invalid coordinate format. Please use 'lat, lng'.");
        }
    } else if (field === 'lat' || field === 'lng' || field === 'sec') {
        // è™•ç†å–®ç¨çš„æ•¸å­—æ¬„ä½ (æ­¤é‚è¼¯ç¾åœ¨ä¸»è¦ç”¨æ–¼ 'sec')
        scriptSteps[index][field] = parseFloat(value) || 0;
        saveScriptToLocalStorage(); // <--- å„²å­˜
    } else {
        // è™•ç†æ–‡å­—æ¬„ä½ (label, words, icon)
        scriptSteps[index][field] = value;
        saveScriptToLocalStorage(); // <--- å„²å­˜
    }
}

/**
 * ç§»å‹•æ­¥é©Ÿä½ç½®
 */
function moveStep(index, direction) {
    if (index === 0) return; // ä¿è­·ç¬¬ä¸€å€‹æ­¥é©Ÿ
    const newIndex = index + direction;
    if (newIndex < 1 || newIndex >= scriptSteps.length) return; // ä¸èƒ½ç§»å‡ºç¯„åœ (ç‰¹åˆ¥æ˜¯ä¸èƒ½ç§»åˆ° index 0)
    
    // é€²è¡Œäº¤æ›
    [scriptSteps[index], scriptSteps[newIndex]] = [scriptSteps[newIndex], scriptSteps[index]];
    renderScript();
    saveScriptToLocalStorage(); // <--- å„²å­˜
}

// --------------------------------------------------------
// åˆå§‹åŒ–ï¼šæª¢æŸ¥ URL åƒæ•¸ã€Local Storage ä¸¦è¼‰å…¥åŠ‡æœ¬ï¼Œç„¶å¾Œæ¸²æŸ“ UI
// --------------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
    checkAndLoadScriptFromURL();
    renderScript();
    
    // å…¨åŸŸç›£è½éµç›¤äº‹ä»¶
    document.addEventListener('keydown', handleKeydown); // <-- æ–°å¢éµç›¤ç›£è½
});


// --- éµç›¤äº‹ä»¶è™•ç†å‡½å¼ ---
function handleKeydown(event) {
    const modal = document.getElementById('import-modal');
    const importTextarea = document.getElementById('import-data-textarea');
    
    // åªæœ‰åœ¨æ¨¡æ…‹æ¡†é¡¯ç¤ºæ™‚æ‰è™•ç†éµç›¤äº‹ä»¶
    if (modal.classList.contains('hidden')) {
        return;
    }
    
    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…å½±éŸ¿å…¶ä»–è¼¸å…¥æ¡†
    event.stopPropagation();
    
    switch (event.key) {
        case 'Escape':
            closeImportModal();
            break;
        case 'Enter':
            // åªæœ‰ç•¶ç„¦é»ä¸åœ¨ textarea æ™‚æ‰è§¸ç™¼ (ä¾‹å¦‚åœ¨ç¢ºèªæŒ‰éˆ•ä¸Š)
            // å¦‚æœç„¦é»åœ¨ textarea å…§ï¼Œé™¤éåŒæ™‚æŒ‰äº† Ctrl/Cmd/Shiftï¼Œå¦å‰‡æŒ‰ Enter æ‡‰åŸ·è¡Œæäº¤
            if (document.activeElement === importTextarea && !event.shiftKey) {
                 // åœ¨ textarea å…§ï¼Œæ²’æœ‰æŒ‰ shiftï¼Œå…è¨±æ›è¡Œã€‚
                 return;
            } else {
                // åŸ·è¡Œç¢ºèª (é˜²æ­¢é»˜èªè¡Œç‚º)
                event.preventDefault(); 
                handleImportConfirmation();
            }
            break;
    }
}
</script>
</body>
</html>