<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025年度個人總結表格 (新增匯出)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 html2canvas 函式庫用於將 HTML 渲染成圖片 -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* 設定字體為 Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght=100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }

        /* 內容單元格的基本樣式 */
        .content-cell {
            position: relative;
            overflow: hidden;
            min-height: 120px;
            border: 1px solid #000;
            transition: all 0.2s;
            display: flex; /* 使用 flex 來居中模式選擇器或內容 */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 8px; /* 內邊距 */
            /* 讓 div 獲得焦點時有視覺回饋 */
            outline: none; 
        }

        .content-cell:focus {
            box-shadow: 0 0 0 2px #f97316, 0 0 0 4px rgba(249, 115, 22, 0.5); /* 聚焦時的橙色外框 */
        }

        .content-cell:hover {
            background-color: #eef;
        }
        
        /* 圖片容器：用於拖曳和縮放 */
        .image-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2; /* 確保高於文字輸入區(z-index: 1) */
            /* 修正 3: 強制創建堆疊上下文以改善 html2canvas 渲染 clip-path 的問題 */
            transform: translateZ(0); 
            /* 修正 1: 移除會與屬性選擇器衝突的 display: none; */
            overflow: hidden; /* 裁剪路徑(clip-path)的關鍵 */
            display: block; /* 讓它總是存在，由內層的 img 和 clip-path 控制顯示區域 */
        }
        
        /* 實際圖片樣式 */
        .image-wrapper img {
            width: 100%;
            height: auto;
            object-fit: contain;
            pointer-events: all;
            position: absolute;
            transform-origin: 0 0;
            transition: opacity 0.3s;
            /* 讓 img 元素預設隱藏，只在有 src 時才由 JS 或 CSS 顯示 */
            display: none; 
        }

        /* ------------------ Dual Image / Diagonal Split Styles ------------------ */

        /* 對角線分隔線: 左下到右上 (45度) - 在左右分割模式下保持隱藏 */
        .diagonal-line {
            position: absolute;
            /* 讓線段寬度足以覆蓋對角線 (sqrt(2)*100% 約 141.4%) */
            width: 142.8%; 
            height: 2px;
            background: #000;
            top: 50%;
            left: -21.4%; 
            transform: rotate(45deg); 
            transform-origin: 50% 50%;
            z-index: 10;
            pointer-events: none;
            display: none;
        }
        
        /* 單張圖片模式 (Count=1): Image 1 佔滿整個空間 */
        .content-cell[data-image-count='1'] .image-wrapper-1 {
            display: block !important; 
            clip-path: none;
            pointer-events: all;
        }
        .content-cell[data-image-count='1'] .image-wrapper-2,
        .content-cell[data-image-count='1'] .image-wrapper-3 {
            display: none !important;
        }

        /* 雙圖模式 (Count=2): Image 1 (左半邊矩形), Image 2 (右半邊矩形) */
        .content-cell[data-image-count='2'] .image-wrapper-1 {
            display: block !important;
            width: 50%; 
            height: 100%; /* 確保 Image 1 覆蓋整個左側 */
            left: 0;
            top: 0;
            clip-path: none;
            pointer-events: all; 
        }

        /* 雙圖模式 (Count=2): Image 2 覆蓋整個右側 */
        .content-cell[data-image-count='2'] .image-wrapper-2 {
            display: block !important;
            width: 50%; 
            height: 100%; 
            left: 50%;
            top: 0;
            clip-path: none; 
            pointer-events: all; 
        }
        .content-cell[data-image-count='2'] .image-wrapper-3 {
            display: none !important;
        }
        
        /* 三圖模式 (Count=3): 左(長), 右上(方), 右下(方) */
        /* 三圖模式: Image 1 (左側長方形) */
        .content-cell[data-image-count='3'] .image-wrapper-1 {
            display: block !important;
            width: 50%;
            height: 100%;
            top: 0;
            left: 0;
            clip-path: none;
            pointer-events: all;
        }

        /* 三圖模式: Image 2 (右上長方形) */
        .content-cell[data-image-count='3'] .image-wrapper-2 {
            display: block !important;
            width: 50%;
            height: 50%;
            top: 0;
            left: 50%;
            clip-path: none;
            pointer-events: all;
        }

        /* 三圖模式: Image 3 (右下長方形) */
        .content-cell[data-image-count='3'] .image-wrapper-3 {
            display: block !important;
            width: 50%;
            height: 50%;
            top: 50%;
            left: 50%;
            clip-path: none;
            pointer-events: all;
        }

        /* 內容文字區域樣式 */
        .cell-text-input {
            /* 讓文字輸入框佔滿單元格 */
            position: absolute; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            min-height: 104px; 
            outline: none;
            cursor: text;
            padding: 4px;
            overflow-y: auto;
            text-align: center; /* 讓文字居中顯示 */
            display: flex;
            /* 允許文字斷行 */
            white-space: normal; 
            word-break: break-all;
            justify-content: center;
            align-items: center;
            background-color: transparent; 
            z-index: 1; /* 修正: 明確設定 Z-index，低於圖片容器 */
            /* 啟用 CSS 過渡效果，讓文字大小變化更流暢 */
            transition: font-size 0.2s ease-out; 
        }
        .cell-text-input:focus {
            background-color: #fffbe6;
            border: 1px solid #f97316; /* 聚焦時的邊框 */
            padding: 3px;
        }

        /* 標題和可編輯文字樣式 */
        .editable-text {
            outline: none;
            cursor: text;
        }
        .editable-text:focus {
            background-color: #fffbe6;
        }

        /* 提示訊息和清除按鈕樣式 */
        .toast-message {
            z-index: 100;
        }
        .clear-button {
            z-index: 20;
        }
        /* 調整第三個清除按鈕的位置 */
        .clear-button-3 {
            right: 15px; /* 放在 clearButton2 (right-8) 旁邊 */
            background-color: #3b82f6 !important; /* Blue color for Image 3 clear */
        }
        .mode-selector-overlay {
            z-index: 5;
            padding: 10px;
            /* 確保選擇介面在最上層並居中 */
            position: absolute; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.9); /* 輕微透明背景 */
        }
        /* 按鈕容器樣式調整：從縱疊改成水平，並位於標題下方居中 */
        .default-buttons-container {
            /* 移除絕對定位，讓它佔據正常流空間 */
            position: static; 
            margin-top: 8px; /* 與標題 H1 隔開 */
            margin-bottom: 8px; /* 與表格隔開 */
            display: flex;
            flex-direction: row; /* 水平排列 */
            gap: 8px; /* 增加間距 */
            justify-content: center; /* 居中 */
            align-items: center;
            z-index: 30;
            
        }
        .default-buttons-container button {
             padding: 4px 8px;
             font-size: 0.75rem; /* text-xs */
             line-height: 1;
             white-space: nowrap;
        }
    </style>
    
    <!-- 主要應用程式邏輯 -->
    <script>
        const ZOOM_STEP = 0.1;
        const MIN_SCALE = 0.1;
        const MAX_SCALE = 5.0;
        
        // 記錄當前介面語言，初始化為 'zh'
        let currentLanguage = 'zh'; 

        // --- 新增：預設值定義 (包含介面翻譯) ---
        const DEFAULT_HEADERS = {
            zh: {
                mainTitle: "2025年度個人 決鬥王 總結",
                titles: [
                    "年初玩的牌組", "年底玩的牌組", "最常玩的牌組", "最喜歡的卡", "最喜歡的Combo",
                    "卡圖最好看的卡", "最想放寬限制的卡", "最想禁止的卡", "最不想上手的卡", "最不想遇上的卡",
                    "最被低估的卡", "最過譽的卡", "買過最貴的卡", "買了但沒用到的卡", "想買但沒買的卡",
                    "組過最奇葩的牌組", "最常遇上的牌組", "最離譜的牌組", "最不喜歡的牌組", "最喜歡的頻道"
                ],
                interface: {
                    btn_clear: "全清除 (標題)",
                    btn_export: "匯出 PNG",
                    footer_p1: "操作提示: 點擊內容格後，先選擇 **貼上圖片** 或 **輸入文字**。",
                    footer_p2: "圖片模式下：按 Ctrl+V 貼上圖片 (桌面) 或點擊按鈕選擇圖片 (行動裝置/最多三張)，滾輪縮放，拖曳調整位置。三圖模式下，圖片會呈現**左(長方形)/右上/右下**分割。",
                    footer_p3: "目前模式：頁面重新整理後，所有輸入的內容和狀態都將被清除。",
                    paste_image_desktop: "貼上圖片 (Ctrl+V)",
                    select_image_mobile: "從圖庫/檔案庫選擇 (最多3張)",
                    enter_text: "輸入文字"
                }
            },
            en: {
                mainTitle: "2025 Personal Duel Masters Summary",
                titles: [
                    "Deck Played Early Year", "Deck Played Late Year", "Most Played Deck", "Favorite Card", "Favorite Combo",
                    "Best Card Art", "Most Wanted Unbanned Card", "Most Wanted Banned Card", "Least Wanted Opening Hand", "Least Wanted Opponent Card",
                    "Most Underrated Card", "Most Overrated Card", "Most Expensive Card Purchased", "Purchased But Unused Card", "Wanted But Didn't Buy Card",
                    "Weirdest Deck Built", "Most Frequently Encountered Deck", "Most Absurd Deck", "Least Favorite Deck", "Favorite Channel"
                ],
                interface: {
                    btn_clear: "Clear All (Titles)",
                    btn_export: "Export PNG",
                    footer_p1: "Instructions: Click a content cell, then select **Paste Image** or **Enter Text**.",
                    footer_p2: "Image Mode: Press Ctrl+V to paste image (Desktop) or click button to select images (Mobile/Max 3). Use scroll to zoom, drag to adjust position. Triple image mode shows **Left (long) / Top-Right / Bottom-Right** split.",
                    footer_p3: "Current Mode: All entered content and state will be cleared upon page refresh.",
                    paste_image_desktop: "Paste Image (Ctrl+V)",
                    select_image_mobile: "Select from gallery/files (Max 3)",
                    enter_text: "Enter Text"
                }
            },
            jp: {
                mainTitle: "2025年度個人 デュエマ まとめ",
                titles: [
                    "年明け使ってたデッキ", "年末使ってたデッキ", "一番使ったデッキ", "一番好きなカード", "一番好きなコンボ",
                    "イラストが一番好きなカード", "緩和してほしいカード", "禁止にしてほしいカード", "一番手札に来てほしくないカード", "一番対面したくないカード",
                    "一番過小評価されてるカード", "一番過大評価されてるカード", "一番高かったカード", "買ったけど使わなかったカード", "欲しいけど買えなかったカード",
                    "一番奇抜なデッキ", "一番対面したデッキ", "一番理不尽なデッキ", "一番嫌いなデッキ", "一番好きなチャンネル"
                ],
                interface: {
                    btn_clear: "全てクリア (タイトル)",
                    btn_export: "PNGを出力",
                    footer_p1: "操作ヒント: コンテンツセルをクリックした後、**画像を貼る**または**文字を入力**を選択します。",
                    footer_p2: "画像モード: Ctrl+Vで画像を貼り付け (デスクトップ) またはボタンをクリックして画像を選択 (モバイル/最大3枚)。スクロールで拡大縮小、ドラッグで位置調整。三枚モードでは**左(縦長)/右上/右下**に分割されます。",
                    footer_p3: "現在のモード: ページ更新後、入力されたコンテンツと状態はすべてクリアされます。",
                    paste_image_desktop: "画像を貼る (Ctrl+V)",
                    select_image_mobile: "ギャラリー/ファイルから選択 (最大3枚)",
                    enter_text: "文字を入力"
                }
            }
        };
        // --- 預設值定義結束 ---

        /**
         * 簡單判斷是否為行動裝置環境（小螢幕或支援觸控）
         */
        function isMobileDevice() {
            return window.innerWidth < 768 || ('ontouchstart' in window);
        }

        // --- 輔助函式 ---
        
        /**
         * 根據模式切換單元格內元件的顯示狀態
         * @param {HTMLElement} cell - 內容單元格
         * @param {string} mode - 'select', 'image', or 'text'
         */
        function updateCellView(cell, mode) {
            cell.dataset.mode = mode;
            const count = parseInt(cell.dataset.imageCount || 0);
            
            const selectOverlay = cell.querySelector('.mode-selector-overlay');
            const wrapper1 = cell.querySelector('.image-wrapper-1');
            const wrapper2 = cell.querySelector('.image-wrapper-2');
            const wrapper3 = cell.querySelector('.image-wrapper-3'); // <--- 調整：新增 Image 3 Wrapper
            const textInput = cell.querySelector('.cell-text-input');
            const diagonalLine = cell.querySelector('.diagonal-line');
            
            // **修正核心: 1. 隱藏所有模式的專屬元素**
            // 預設隱藏模式選擇器、文字輸入和分隔線
            if (selectOverlay) selectOverlay.style.display = 'none';
            if (textInput) {
                textInput.style.display = 'none';
                // 確保在隱藏時明確禁用 contenteditable
                textInput.contentEditable = 'false'; 
            }
            if (diagonalLine) diagonalLine.style.display = 'none';
            
            // 隱藏圖片容器
            if (wrapper1) wrapper1.style.display = 'none'; 
            if (wrapper2) wrapper2.style.display = 'none';
            if (wrapper3) wrapper3.style.display = 'none'; // <--- 調整：隱藏 Image 3 Wrapper
            
            removeClearButton(cell);


            if (mode === 'select') {
                if (selectOverlay) selectOverlay.style.display = 'flex';
                cell.style.cursor = 'default';
            } else if (mode === 'image') {
                
                if (count >= 1) {
                    // 圖片顯示由 CSS 屬性選擇器控制 (根據 data-image-count)
                    if (count === 3) {
                        addClearButton(cell, 3); // 三圖顯示三個清除選項
                    } else if (count === 2) {
                        addClearButton(cell, 2); // 雙圖顯示兩個清除選項
                    } else {
                        addClearButton(cell, 1); // 單圖顯示一個清除選項
                    }
                }
                
                cell.style.cursor = 'move';
            } else if (mode === 'text') {
                if (textInput) {
                    textInput.style.display = 'flex';
                    // 確保在文字模式下明確啟用 contenteditable
                    textInput.contentEditable = 'true'; 
                }
                // 文字模式下，只要有文字就顯示清除按鈕
                if (textInput && textInput.textContent.trim()) {
                    addClearButton(cell, 0, true); 
                }
                cell.style.cursor = 'text';
            }
        }

        // --- 模式切換邏輯 ---
        
        function switchToImageMode(cell) {
            const count = parseInt(cell.dataset.imageCount || 0);
            
            // 強制設定為 image 模式，允許貼上事件被捕獲
            cell.dataset.mode = 'image';
            
            // 檢查如果已經有圖片，則不需要模式選擇器
            if (count > 0) {
                 updateCellView(cell, 'image');
                 // --- 調整：更新三圖模式的提示訊息 ---
                 let message;
                 if (count === 1) {
                    message = "請貼上第二張圖片 (Ctrl+V) 以啟用左右分割模式。";
                 } else if (count === 2) {
                    message = "請貼上第三張圖片 (Ctrl+V) 以啟用左(長)右(方)分割模式。";
                 } else { // count === 3
                    message = "已達最大圖片數量 (3張)。若要替換，請先清除。";
                 }
                 showToast(cell, message, count === 3 ? 'warning' : 'success');
                 if (cell) cell.focus();
                 return;
            }
            
            // 如果 count === 0，則正常切換到 image 模式並提示貼第一張圖
            updateCellView(cell, 'image');
            
            // 根據裝置顯示不同的提示
            if (isMobileDevice()) {
                showToast(cell, "已切換到圖片模式，請點擊按鈕選擇圖片。", 'success');
            } else {
                showToast(cell, "已切換到圖片模式，請貼上第一張圖片 (Ctrl+V)。", 'success');
            }
            
            if (cell) {
                cell.focus();
            }
        }

        function switchToTextMode(cell) {
            // 修正: 直接切換到 text 模式，並確保 textInput 顯示
            updateCellView(cell, 'text');
            showToast(cell, "已切換到文字模式，請直接輸入。", 'success');
            const textInput = cell.querySelector('.cell-text-input');
            if (textInput && document.activeElement !== textInput) {
                textInput.focus();
            }
        }

        // --- 圖片操作邏輯 ---
        
        /**
         * 處理貼上事件 (僅在 'image' 模式下有效 - 桌面專用)
         * @param {Event} e - 貼上事件
         */
        function handlePaste(e) {
            const cell = this;
            // 確保只有在非行動裝置模式下，且模式為 'image' 時才執行貼上
            if (isMobileDevice() || cell.dataset.mode !== 'image') return; 

            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            let imageFound = false;
            let targetImgElement, targetImageId, currentCount;
            
            for (const item of items) {
                if (item.type.indexOf('image') !== -1) {
                    e.preventDefault();
                    const blob = item.getAsFile();
                    const reader = new FileReader();

                    currentCount = parseInt(cell.dataset.imageCount || 0);

                    // 貼上只處理單張圖片，且不能超過 3 張
                    if (currentCount >= 3) {
                        showToast(cell, "已貼上三張圖片，請先清除其中一張。", 'warning');
                        imageFound = true; 
                        return;
                    }
                    
                    targetImageId = currentCount + 1;
                    cell.dataset.imageCount = targetImageId; // 設置新的圖片數量
                    
                    targetImgElement = cell.querySelector(`.image-wrapper-${targetImageId} img`);

                    reader.onload = (event) => {
                        const base64Data = event.target.result;
                        
                        targetImgElement.src = base64Data;
                        
                        // 確保圖片本身在有 src 時顯示
                        targetImgElement.style.display = 'block';

                        // 初始化狀態
                        cell.dataset[`scale${targetImageId}`] = 1.0;
                        cell.dataset[`offsetX${targetImageId}`] = 0;
                        cell.dataset[`offsetY${targetImageId}`] = 0;
                        updateImageTransform(cell, targetImageId); // 應用初始 transform
                        
                        // 更新視圖 (會觸發 CSS 根據 data-image-count 顯示正確的 wrapper)
                        updateCellView(cell, 'image');

                        showToast(cell, `圖片 ${targetImageId} 已貼上。`, 'success');
                    };
                    reader.readAsDataURL(blob);
                    imageFound = true;
                    break;
                }
            }
            
            if (!imageFound) {
                showToast(cell, "請貼上圖片檔案。", 'warning');
            }
        }

        /**
         * 處理從檔案輸入中選擇的多個圖片檔案 (行動裝置專用)
         * @param {FileList} files - 選擇的檔案列表
         * @param {HTMLElement} cell - 內容單元格
         */
        function handleFileSelect(files, cell) {
            if (!files || files.length === 0) return;
            
            let initialCount = parseInt(cell.dataset.imageCount || 0);
            let nextImageId = initialCount + 1;
            // 處理數量：最多 3 張，不能超過上限
            const maxFilesToProcess = Math.min(3 - initialCount, files.length);

            if (maxFilesToProcess === 0) {
                 showToast(cell, "已達最大圖片數量 (3張)。若要替換，請先清除。", 'warning');
                 return;
            }

            let filesProcessed = 0;
            const filesToProcess = [];

            // 準備要處理的檔案列表
            for (let i = 0; i < maxFilesToProcess; i++) {
                 filesToProcess.push({ 
                     file: files[i], 
                     id: nextImageId + i 
                 });
            }
            
            // 立即更新圖片計數器
            cell.dataset.imageCount = initialCount + maxFilesToProcess;
            updateCellView(cell, 'image');
            showToast(cell, `開始上傳 ${maxFilesToProcess} 張圖片...`, 'success');

            // 異步處理每個檔案
            filesToProcess.forEach(({ file, id }) => {
                // 確保是圖片格式
                if (file.type.indexOf('image') === -1) return;

                const reader = new FileReader();
                const targetImgElement = cell.querySelector(`.image-wrapper-${id} img`);

                reader.onload = (event) => {
                    const base64Data = event.target.result;
                    
                    targetImgElement.src = base64Data;
                    targetImgElement.style.display = 'block';

                    // 初始化狀態
                    cell.dataset[`scale${id}`] = 1.0;
                    cell.dataset[`offsetX${id}`] = 0;
                    cell.dataset[`offsetY${id}`] = 0;
                    updateImageTransform(cell, id);
                    
                    filesProcessed++;

                    // 所有檔案處理完成後給出最終提示
                    if (filesProcessed === maxFilesToProcess) {
                        showToast(cell, `${maxFilesToProcess} 張圖片已載入完成。`, 'success');
                    }
                };
                reader.readAsDataURL(file);
            });
        }


        // --- 拖曳和縮放邏輯 (現支援三圖) ---
        
        /**
         * 獲取當前互動的圖片 ID (1, 2 或 3)
         * @param {HTMLElement} target - 觸發事件的元素
         */
        function getActiveImageId(target) {
            // 只有在 mode='image' 且 wrapper 有顯示時才算有效
            const cell = target.closest('.content-cell');
            if (!cell || cell.dataset.mode !== 'image') return 0;
            
            const wrapper1 = target.closest('.image-wrapper-1');
            const wrapper2 = target.closest('.image-wrapper-2');
            const wrapper3 = target.closest('.image-wrapper-3'); // <--- 調整：新增 Image 3 Wrapper

            // 根據 data-image-count 判斷點擊是否有效
            const count = parseInt(cell.dataset.imageCount || 0);

            if (wrapper1 && count >= 1) return 1;
            if (wrapper2 && count >= 2) return 2;
            if (wrapper3 && count === 3) return 3; // <--- 調整：Image 3 僅在三圖模式下有效
            
            return 0;
        }

        /**
         * 處理滾輪縮放事件
         * @param {Event} e - 滾輪事件
         */
        function handleZoom(e) {
            const cell = this;
            if (cell.dataset.mode !== 'image') return;

            const activeId = getActiveImageId(e.target);
            if (activeId === 0) return;

            const img = cell.querySelector(`.image-wrapper-${activeId} img`);
            if (!img || !img.src) return;
            
            e.preventDefault();
            
            let currentScale = parseFloat(cell.dataset[`scale${activeId}`]) || 1.0;
            const delta = e.deltaY < 0 ? ZOOM_STEP : -ZOOM_STEP;
            let newScale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, currentScale + delta));
            
            cell.dataset[`scale${activeId}`] = newScale.toFixed(2);
            updateImageTransform(cell, activeId);
        }

        let isDragging = false;
        let startX, startY;
        let currentCell;
        let activeDragId = 0; // 新增：追蹤目前拖曳的是哪張圖片 (1, 2 或 3)


        /**
         * 處理拖曳開始
         * @param {Event} e - 滑鼠按下事件
         */
        function handleDragStart(e) {
            currentCell = this;
            if (currentCell.dataset.mode !== 'image') return;
            
            const targetWrapper = e.target.closest('.image-wrapper-1') || e.target.closest('.image-wrapper-2') || e.target.closest('.image-wrapper-3'); // <--- 調整：新增 Image 3 Wrapper
            if (!targetWrapper) return;
            
            activeDragId = getActiveImageId(targetWrapper);

            const imgElement = currentCell.querySelector(`.image-wrapper-${activeDragId} img`); 
            // 排除清除按鈕和無圖片
            if (!imgElement || e.target.closest('.clear-button') || !imgElement.src) {
                activeDragId = 0; 
                return;
            } 

            e.preventDefault(); 
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;

            let currentX = parseFloat(currentCell.dataset[`offsetX${activeDragId}`]) || 0;
            let currentY = parseFloat(currentCell.dataset[`offsetY${activeDragId}`]) || 0;
            currentCell.dataset.startX = currentX; // 使用通用的 startX/Y 暫存
            currentCell.dataset.startY = currentY;
            
            document.addEventListener('mousemove', handleDrag);
            document.addEventListener('mouseup', handleDragEnd);
            document.body.style.cursor = 'grabbing';
        }

        /**
         * 處理拖曳中
         * @param {Event} e - 滑鼠移動事件
         */
        function handleDrag(e) {
            // 檢查 activeDragId
            if (!isDragging || !currentCell || currentCell.dataset.mode !== 'image' || activeDragId === 0) return;

            const dx = e.clientX - startX;
            const dy = e.clientY - startY;

            let newX = parseFloat(currentCell.dataset.startX) + dx;
            let newY = parseFloat(currentCell.dataset.startY) + dy;

            currentCell.dataset[`offsetX${activeDragId}`] = newX;
            currentCell.dataset[`offsetY${activeDragId}`] = newY;

            updateImageTransform(currentCell, activeDragId);
        }

        /**
         * 處理拖曳結束
         */
        function handleDragEnd() {
            if (!isDragging) return;

            isDragging = false;
            activeDragId = 0; // 重置拖曳圖片 ID
            document.removeEventListener('mousemove', handleDrag);
            document.removeEventListener('mouseup', handleDragEnd);
            document.body.style.cursor = 'default';
            
            currentCell = null;
        }

        /**
         * 應用單元格的 scale/offset 數據到指定的圖片的 CSS transform 屬性
         * @param {HTMLElement} cell - 內容單元格元素
         * @param {number} id - 圖片 ID (1, 2 或 3)。若未指定則更新所有。
         */
        function updateImageTransform(cell, id = 0) {
            // 確定要更新的圖片 ID 列表
            const wrappers = id === 0 ? [1, 2, 3] : [id]; // <--- 調整：包含 Image 3

            wrappers.forEach(imgId => {
                const img = cell.querySelector(`.image-wrapper-${imgId} img`);
                if (!img) return;

                // 確保狀態值是存在的
                const scale = cell.dataset[`scale${imgId}`] || 1.0;
                const offsetX = cell.dataset[`offsetX${imgId}`] || 0;
                const offsetY = cell.dataset[`offsetY${imgId}`] || 0;

                img.style.transform = `scale(${scale}) translate(${offsetX}px, ${offsetY}px)`;
            });
        }
        
        // --- 文字操作邏輯 (不變) ---
        
        const MAX_FONT_SIZE = 1.2; 
        const MIN_FONT_SIZE = 0.6; 
        const THRESHOLD_CHARS_MIN = 10; 
        const THRESHOLD_CHARS_MAX = 100; 

        function adjustFontSize(textInput) {
            const text = textInput.textContent.trim();
            const length = text.length;
            let newSize;

            if (length <= THRESHOLD_CHARS_MIN) {
                newSize = MAX_FONT_SIZE;
            } else if (length >= THRESHOLD_CHARS_MAX) {
                newSize = MIN_FONT_SIZE;
            } else {
                const range = THRESHOLD_CHARS_MAX - THRESHOLD_CHARS_MIN;
                const position = length - THRESHOLD_CHARS_MIN;
                const scaleFactor = position / range; 
                const fontRange = MAX_FONT_SIZE - MIN_FONT_SIZE;
                newSize = MAX_FONT_SIZE - (fontRange * scaleFactor);
            }
            textInput.style.fontSize = `${newSize}em`;
        }

        function handleTextEdit(e) {
            const cell = e.target.closest('.content-cell');
            const textInput = e.target;
            if (cell.dataset.mode !== 'text') return;

            adjustFontSize(textInput);

            const textContent = textInput.textContent.trim();
            if (textContent) {
                 addClearButton(cell, 0, true);
            } else {
                 removeClearButton(cell);
            }
        }

        function handleHeaderEdit(e) {
            // 無需任何儲存邏輯，直接讓 contenteditable 處理
        }

        // --- 通用操作邏輯 ---
        
        /**
         * 創建並添加/顯示內容清除按鈕
         * @param {HTMLElement} cell - 單元格
         * @param {number} count - 當前圖片數量 (1, 2 或 3)。
         * @param {boolean} isTextMode - 是否為文字模式
         */
        function addClearButton(cell, count, isTextMode = false) {
            let clearButtonMain = cell.querySelector('.clear-button-main');
            let clearButton2 = cell.querySelector('.clear-button-2');
            let clearButton3 = cell.querySelector('.clear-button-3'); // <--- 調整：新增 Image 3 清除按鈕

            // 1. 主要清除按鈕 (清空所有 / 清除文字)
            if (!clearButtonMain) {
                clearButtonMain = document.createElement('button');
                clearButtonMain.className = 'clear-button clear-button-main absolute top-1 right-1 p-1 rounded-full bg-red-600 text-white hover:bg-red-700 transition-all shadow-lg z-20 w-5 h-5 flex items-center justify-center text-xs font-bold leading-none focus:outline-none';
                clearButtonMain.innerHTML = 'X';
                clearButtonMain.title = '清除所有內容並重選模式';
                clearButtonMain.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    clearCell(cell); // 完整清空
                });
                cell.appendChild(clearButtonMain);
            }
            clearButtonMain.title = isTextMode ? '清除文字內容並重選模式' : '清除所有內容並重選模式';
            clearButtonMain.style.display = 'flex';

            // 2. 第二圖片清除按鈕 (僅在雙圖或三圖模式下)
            if (count >= 2 && !isTextMode) {
                if (!clearButton2) {
                    clearButton2 = document.createElement('button');
                    // Positioning right-8
                    clearButton2.className = 'clear-button clear-button-2 absolute top-1 right-8 p-1 rounded-full bg-yellow-500 text-white hover:bg-yellow-600 transition-all shadow-lg z-20 w-5 h-5 flex items-center justify-center text-xs font-bold leading-none focus:outline-none';
                    clearButton2.innerHTML = '2'; // 標示清除第二張
                    clearButton2.title = '清除第二張圖片';
                    clearButton2.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        clearImage2(cell); // 清除第二張圖片 (含三圖模式下的特殊處理)
                    });
                    cell.appendChild(clearButton2);
                }
                clearButton2.style.display = 'flex';
                clearButton2.title = count === 3 ? '清除第二張圖片 (右上部)' : '清除第二張圖片 (右半部)';
            } else if (clearButton2) {
                clearButton2.style.display = 'none';
            }
            
            // 3. 第三圖片清除按鈕 (僅在三圖模式下)
            if (count === 3 && !isTextMode) {
                if (!clearButton3) {
                    clearButton3 = document.createElement('button');
                    // Positioning right-[3.5rem]
                    clearButton3.className = 'clear-button clear-button-3 absolute top-1 right-[3.5rem] p-1 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-all shadow-lg z-20 w-5 h-5 flex items-center justify-center text-xs font-bold leading-none focus:outline-none';
                    clearButton3.innerHTML = '3'; 
                    clearButton3.title = '清除第三張圖片 (右下部)';
                    clearButton3.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        clearImage3(cell); // 清除第三張圖片
                    });
                    cell.appendChild(clearButton3);
                }
                clearButton3.style.display = 'flex';
            } else if (clearButton3) {
                clearButton3.style.display = 'none';
            }
        }

        /**
         * 移除/隱藏所有內容清除按鈕 (不變)
         * @param {HTMLElement} cell - 單元格
         */
        function removeClearButton(cell) {
            const clearButtons = cell.querySelectorAll('.clear-button');
            clearButtons.forEach(btn => btn.style.display = 'none');
        }
        
        /**
         * 清除第三張圖片的內容和狀態
         * @param {HTMLElement} cell - 單元格
         */
        function clearImage3(cell) {
            const img3 = cell.querySelector('.image-wrapper-3 img');
            if (img3) {
                img3.src = '';
                img3.style.display = 'none'; // 隱藏圖片元素
            }
            
            // 清除狀態
            cell.dataset.scale3 = 1.0;
            cell.dataset.offsetX3 = 0;
            cell.dataset.offsetY3 = 0;
            cell.dataset.imageCount = 2; // 圖片數量變為 2 (雙圖模式)
            
            // 更新視圖，回到雙圖模式 (Image 2 會自動佔據整個右側)
            updateCellView(cell, 'image');
            showToast(cell, "第三張圖片 (右下部) 已清除，回到左右分割模式。", 'success');
        }

        /**
         * 清除第二張圖片的內容和狀態
         * @param {HTMLElement} cell - 單元格
         */
        function clearImage2(cell) {
            const currentCount = parseInt(cell.dataset.imageCount || 0);

            if (currentCount === 3) {
                // 如果是三圖模式，清除 Image 2 (右上) 時，Image 3 (右下) 需上移至 Image 2 的位置
                const img2 = cell.querySelector('.image-wrapper-2 img');
                const img3 = cell.querySelector('.image-wrapper-3 img');
                
                // 1. 將 Image 3 的內容和狀態轉移給 Image 2
                if (img3 && img3.src) {
                    img2.src = img3.src;
                    img2.style.display = 'block'; 
                    // 轉移狀態
                    cell.dataset.scale2 = cell.dataset.scale3 || 1.0;
                    cell.dataset.offsetX2 = cell.dataset.offsetX3 || 0;
                    cell.dataset.offsetY2 = cell.dataset.offsetY3 || 0;
                    updateImageTransform(cell, 2); // 應用新的 transform
                } else {
                    // 如果 Image 3 不存在或已經空了，就只是清空 Image 2
                    img2.src = '';
                    img2.style.display = 'none';
                    cell.dataset.scale2 = 1.0;
                    cell.dataset.offsetX2 = 0;
                    cell.dataset.offsetY2 = 0;
                }
                
                // 2. 清空 Image 3
                if (img3) {
                    img3.src = '';
                    img3.style.display = 'none';
                    cell.dataset.scale3 = 1.0;
                    cell.dataset.offsetX3 = 0;
                    cell.dataset.offsetY3 = 0;
                }
                
                cell.dataset.imageCount = 2; // 圖片數量變為 2 (雙圖模式)
                updateCellView(cell, 'image');
                showToast(cell, "第二張圖片 (右上部) 已清除，第三張圖片已上移並切換為左右分割模式。", 'success');

            } else if (currentCount === 2) {
                // 原有的雙圖模式 (Image 1 + Image 2)
                const img2 = cell.querySelector('.image-wrapper-2 img');
                if (img2) {
                    img2.src = '';
                    img2.style.display = 'none'; // 隱藏圖片元素
                }
                
                // 清除狀態
                cell.dataset.scale2 = 1.0;
                cell.dataset.offsetX2 = 0;
                cell.dataset.offsetY2 = 0;
                cell.dataset.imageCount = 1; // 圖片數量變為 1
                
                // 更新視圖，回到單圖模式
                updateCellView(cell, 'image');
                showToast(cell, "第二張圖片已清除，回到單圖模式。", 'success');
            } else {
                 // Nothing to clear (count is 1 or 0)
            }
        }


        /**
         * 清除單元格中的所有內容和狀態，並返回模式選擇介面
         * @param {HTMLElement} cell - 單元格
         */
        function clearCell(cell) {
            // 清除圖片 1 和 2
            const img1 = cell.querySelector('.image-wrapper-1 img');
            if (img1) {
                img1.src = '';
                img1.style.display = 'none';
            }
            const img2 = cell.querySelector('.image-wrapper-2 img');
            if (img2) {
                img2.src = '';
                img2.style.display = 'none';
            }
            
            // 清除圖片 3
            const img3 = cell.querySelector('.image-wrapper-3 img'); // <--- 調整：清除 Image 3
            if (img3) {
                img3.src = '';
                img3.style.display = 'none';
            }
            
            // 清除文字狀態
            const textInput = cell.querySelector('.cell-text-input');
            if (textInput) {
                // 確保文字輸入框失去焦點，避免潛在的狀態殘留
                textInput.blur(); 
                textInput.textContent = '';
                textInput.style.fontSize = ''; 
            }
            
            // 移除按鈕
            removeClearButton(cell);
            
            // 重設 dataset 狀態
            cell.dataset.scale1 = 1.0;
            cell.dataset.offsetX1 = 0;
            cell.dataset.offsetY1 = 0;
            cell.dataset.scale2 = 1.0;
            cell.dataset.offsetX2 = 0;
            cell.dataset.offsetY2 = 0;
            cell.dataset.scale3 = 1.0; // <--- 調整：重設 Image 3 狀態
            cell.dataset.offsetX3 = 0; // <--- 調整：重設 Image 3 狀態
            cell.dataset.offsetY3 = 0; // <--- 調整：重設 Image 3 狀態
            cell.dataset.imageCount = 0; // 圖片數量歸零

            // 重新切換回模式選擇
            updateCellView(cell, 'select');
            showToast(cell, "內容已清除，請選擇新的模式。", 'success');
            
            // 移除 cell.focus()，避免焦點衝突
        }

        /**
         * 完整清除所有標題格的內容。
         */
        function clearAllContentAndHeaders() {
            // 清除主標題
            const mainTitleElement = document.getElementById('title_main');
            if (mainTitleElement) {
                 mainTitleElement.textContent = "2025年度個人 DM 總結";
            }
            
            // 清除所有 20 個副標題
            document.querySelectorAll('.editable-text').forEach(header => {
                // 排除主標題，因為上面已處理
                if (header.id !== 'title_main') {
                    header.textContent = ''; 
                }
            });
            
            showToast(document.querySelector('.header-container'), "所有標題已清除。", 'warning'); // 使用 warning 提醒用戶內容未清除
        }

        /**
         * 根據指定的語言設定介面翻譯
         * @param {string} lang - 語言代碼 ('zh', 'en', 'jp')
         */
        function updateInterfaceLanguage(lang) {
            const ui = DEFAULT_HEADERS[lang].interface;
            const mobile = isMobileDevice();
            
            // 更新當前語言狀態
            currentLanguage = lang;

            // 1. 更新主功能按鈕 (語言按鈕固定，只需要更新清除和匯出按鈕)
            document.getElementById('btn-clear-all').textContent = ui.btn_clear;
            document.getElementById('export-button').querySelector('span').textContent = ui.btn_export;

            // 2. 更新底部提示 (footer)
            const footer = document.querySelector('.footer-info');
            if (footer) {
                const paragraphs = footer.querySelectorAll('p');
                if (paragraphs.length >= 3) {
                    // 提示文字 P1
                    paragraphs[0].innerHTML = `<strong>${ui.footer_p1.split(':')[0]}</strong>: ${ui.footer_p1.split(':')[1]}`;
                    
                    // 提示文字 P2 (圖片模式提示)
                    const p2Text = ui.footer_p2;
                    // 將 p2 中的關鍵詞用 span 包裝起來，並使用正確的顏色類別
                    const p2Html = p2Text
                        .replace(/圖片模式下：/, `<span class="text-red-500">圖片模式下：</span>`)
                        .replace(/Image Mode:/, `<span class="text-red-500">Image Mode:</span>`)
                        .replace(/画像モード:/, `<span class="text-red-500">画像モード:</span>`)
                        .replace(/Ctrl\+V/, 'Ctrl+V')
                        .replace(/最多三張/, '最多三張'); 
                    paragraphs[1].innerHTML = p2Html;
                    
                    // 提示文字 P3 (狀態提示)
                    paragraphs[2].innerHTML = `<strong>${ui.footer_p3.split(':')[0]}</strong>: ${ui.footer_p3.split(':')[1]}`;
                }
            }

            // 3. 更新所有模式選擇器按鈕 (.mode-selector-overlay)
            const modeButtons = document.querySelectorAll('.mode-selector-overlay');

            modeButtons.forEach(overlay => {
                const btnImage = overlay.querySelector('.btn-image');
                const btnText = overlay.querySelector('.btn-text');

                // Update Image Button Text
                if (btnImage) {
                    // 根據裝置類型設定不同的文字
                    btnImage.textContent = mobile ? ui.select_image_mobile : ui.paste_image_desktop;
                }
                
                // Update Text Button Text
                if (btnText) {
                    btnText.textContent = ui.enter_text;
                }
            });
        }

        /**
         * 根據指定的語言設定標題預設值
         * @param {string} lang - 語言代碼 ('zh', 'en', 'jp')
         */
        function setDefaults(lang) {
            const defaults = DEFAULT_HEADERS[lang];
            if (!defaults) return;
            
            // 優先更新介面語言
            updateInterfaceLanguage(lang);

            // 1. 設定主標題
            const mainTitleElement = document.getElementById('title_main');
            if (mainTitleElement) {
                 mainTitleElement.textContent = defaults.mainTitle;
            }

            // 2. 設定所有 20 個副標題 (header_rX_cY)
            const headerIds = [
                'header_r1_c1', 'header_r1_c2', 'header_r1_c3', 'header_r1_c4', 'header_r1_c5',
                'header_r3_c1', 'header_r3_c2', 'header_r3_c3', 'header_r3_c4', 'header_r3_c5',
                'header_r5_c1', 'header_r5_c2', 'header_r5_c3', 'header_r5_c4', 'header_r5_c5',
                'header_r7_c1', 'header_r7_c2', 'header_r7_c3', 'header_r7_c4', 'header_r7_c5'
            ];
            
            defaults.titles.forEach((title, index) => {
                const id = headerIds[index];
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = title;
                }
            });
            
            showToast(document.querySelector('.header-container'), `${lang.toUpperCase()} 預設標題和介面語言已設定完成。`, 'success');
        }


        /**
         * 初始化所有內容單元格的事件監聽器
         */
        function initListeners() {
            const contentCells = document.querySelectorAll('.content-cell');
            contentCells.forEach(cell => {
                if (cell.dataset.listenersInitialized) return;

                // 預設將 dataset 狀態設為初始值
                cell.dataset.scale1 = 1.0;
                cell.dataset.offsetX1 = 0;
                cell.dataset.offsetY1 = 0;
                cell.dataset.scale2 = 1.0;
                cell.dataset.offsetX2 = 0;
                cell.dataset.offsetY2 = 0;
                cell.dataset.scale3 = 1.0; // <--- 調整：初始化 Image 3 狀態
                cell.dataset.offsetX3 = 0; // <--- 調整：初始化 Image 3 狀態
                cell.dataset.offsetY3 = 0; // <--- 調整：初始化 Image 3 狀態
                cell.dataset.imageCount = 0; // 初始圖片數量

                // 圖片模式專用事件 (貼上、滾輪、拖曳)
                cell.addEventListener('paste', handlePaste);
                cell.addEventListener('wheel', handleZoom);
                cell.addEventListener('mousedown', handleDragStart);
                
                // 文字模式專用事件
                const textInput = cell.querySelector('.cell-text-input');
                if (textInput) {
                    textInput.addEventListener('input', handleTextEdit);
                }
                
                // 模式選擇按鈕事件
                const selectOverlay = cell.querySelector('.mode-selector-overlay');
                if (selectOverlay) {
                    const btnImage = selectOverlay.querySelector('.btn-image');
                    
                    // --- 行動裝置/桌面 UI 調整和邏輯綁定 ---
                    const mobile = isMobileDevice();
                    let fileInput = cell.querySelector('.file-upload-input');

                    if (mobile) {
                        // 1. 創建/確保檔案輸入欄位存在
                        if (!fileInput) {
                            fileInput = document.createElement('input');
                            fileInput.type = 'file';
                            fileInput.accept = 'image/*';
                            fileInput.multiple = true;
                            // 隱藏在 UI 上
                            fileInput.className = 'hidden file-upload-input absolute w-0 h-0 opacity-0'; 
                            cell.appendChild(fileInput);
                        }
                        
                        // 2. 綁定檔案變更事件來處理上傳
                        fileInput.addEventListener('change', (e) => {
                            // 檢查當前模式，防止在非圖片模式下觸發上傳
                            if (cell.dataset.mode === 'image') {
                                handleFileSelect(e.target.files, cell);
                            }
                            // 清空 file input 的值，以便用戶可以重複上傳相同的檔案
                            e.target.value = '';
                        });
                        
                        // 3. 修改圖片按鈕點擊行為: 點擊按鈕觸發檔案選擇
                        // 替換按鈕以確保沒有重複的事件監聽器，但這次不設定文字，文字由 updateInterfaceLanguage 處理
                        const cloneBtn = btnImage.cloneNode(true);
                        btnImage.parentNode.replaceChild(cloneBtn, btnImage);
                        
                        cloneBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            e.preventDefault(); 
                            switchToImageMode(cell); // 仍需切換模式
                            // 確保 fileInput 已經存在
                            const currentFileInput = cell.querySelector('.file-upload-input');
                            if (currentFileInput) {
                                currentFileInput.click(); // 打開檔案選擇器
                            }
                        });

                    } else {
                        // 桌面行為 (Ctrl+V 提示)
                        btnImage.addEventListener('click', (e) => {
                            e.stopPropagation();
                            e.preventDefault(); 
                            switchToImageMode(cell);
                        });
                    }

                    // 文字按鈕的事件保持不變
                    selectOverlay.querySelector('.btn-text').addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault(); // 確保點擊事件被可靠處理
                        switchToTextMode(cell);
                    });
                }

                // 初始化時，所有單元格都應處於 'select' 模式
                updateCellView(cell, 'select');
                
                cell.dataset.listenersInitialized = 'true';
            });
            
            // 標題文字編輯事件 (只綁定輸入事件，不執行儲存)
            document.querySelectorAll('.editable-text').forEach(cell => {
                cell.addEventListener('input', handleHeaderEdit);
            });
            
            // 首次加載時，應用初始 transform 
            document.querySelectorAll('.content-cell').forEach(cell => updateImageTransform(cell));
            
            // --- 新增：按鈕事件監聽器 ---
            document.getElementById('btn-default-zh').addEventListener('click', () => setDefaults('zh'));
            document.getElementById('btn-default-en').addEventListener('click', () => setDefaults('en'));
            document.getElementById('btn-default-jp').addEventListener('click', () => setDefaults('jp'));
            // 綁定清除標題功能
            document.getElementById('btn-clear-all').addEventListener('click', clearAllContentAndHeaders); 
            
            // 初始化時設定預設介面語言 (中文)
            updateInterfaceLanguage('zh'); 
            // --- 新增按鈕事件監聽器結束 ---
        }

        /**
         * 顯示短暫的提示訊息
         * @param {HTMLElement} element - 提示訊息要顯示的單元格
         * @param {string} message - 提示文字
         * @param {string} type - 類型 ('success', 'warning')
         */
        function showToast(element, message, type = 'success') {
            let toast = element.querySelector('.toast-message');
            if (!toast) {
                toast = document.createElement('div');
                // 修正 BUG: 使用 transition-opacity duration-300 使其與 JS 中的 300ms 延遲匹配
                toast.className = 'toast-message absolute bottom-1 left-1/2 transform -translate-x-1/2 px-2 py-1 text-xs rounded shadow-lg z-10 transition-opacity duration-300';
                element.appendChild(toast);
            }
            
            toast.textContent = message;
            // 每次顯示時，確保它是可見的
            toast.style.display = 'block'; 
            toast.style.opacity = 1;
            
            if (type === 'warning') {
                toast.classList.add('bg-yellow-100', 'text-yellow-800');
                toast.classList.remove('bg-green-100', 'text-green-800');
            } else {
                toast.classList.add('bg-green-100', 'text-green-800');
                toast.classList.remove('bg-yellow-100', 'text-yellow-800');
            }

            clearTimeout(toast.hideTimeout);
            toast.hideTimeout = setTimeout(() => {
                toast.style.opacity = 0;
                // 修正 BUG: 在過渡結束後，將 display 設為 none，使其不再阻擋點擊事件
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 300); // 300ms 應與 CSS transition duration 匹配
            }, 3000);
        }

        /**
         * 將指定的 HTML 元素內容渲染成 Canvas 並下載為 PNG (不變)
         */
        async function exportAsImage() {
            const container = document.getElementById('summary-container');
            const button = document.getElementById('export-button');
            
            // 隱藏匯出按鈕本身，以免被截圖
            button.style.display = 'none';

            // 隱藏所有額外按鈕
            const defaultButtonsContainer = document.querySelector('.default-buttons-container');
            if (defaultButtonsContainer) {
                defaultButtonsContainer.style.display = 'none';
            }


            // 鎖定使用者介面
            const originalBodyCursor = document.body.style.cursor;
            document.body.style.cursor = 'wait';
            
            try {
                // 暫時移除所有單元格的聚焦外框 (如果有)，以獲得更乾淨的截圖
                document.querySelectorAll('.content-cell:focus').forEach(cell => cell.blur());
                
                // 移除所有的清除按鈕，避免出現在截圖中
                const clearButtons = document.querySelectorAll('.clear-button');
                clearButtons.forEach(btn => btn.style.display = 'none');


                // 使用 html2canvas 進行渲染
                const canvas = await html2canvas(container, {
                    // 確保背景色能被正確捕獲
                    backgroundColor: '#ffffff', 
                    // 增加縮放比例以獲得高解析度圖片 (例如 2x)
                    scale: 2, 
                    // 忽略 mode-selector-overlay 和 hidden file inputs
                    ignoreElements: (element) => {
                        return element.classList.contains('mode-selector-overlay') || element.classList.contains('file-upload-input');
                    }
                });

                // 獲取圖片的 Data URL
                const image = canvas.toDataURL("image/png");
                
                // 創建一個虛擬連結進行下載
                const link = document.createElement('a');
                link.href = image;
                
                // 根據標題設定檔案名稱
                const titleText = document.getElementById('title_main').textContent.trim() || 'DM_Summary';
                link.download = `${titleText}.png`;
                
                // 觸發下載
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 顯示成功提示 (使用主容器的空間來顯示)
                const header = document.querySelector('.header-container');
                if(header) {
                     showToast(header, "表格已成功匯出為 PNG 圖片！", 'success');
                }

            } catch (error) {
                console.error("匯出圖片時發生錯誤:", error);
                const header = document.querySelector('.header-container');
                if(header) {
                    showToast(header, "匯出失敗，請檢查瀏覽器控制台。", 'warning');
                }
            } finally {
                // 恢復匯出按鈕和所有額外按鈕的顯示狀態
                button.style.display = 'inline-flex';
                if (defaultButtonsContainer) {
                    defaultButtonsContainer.style.display = 'flex';
                }
                
                // 恢復清除按鈕的顯示狀態 (基於當前狀態)
                document.querySelectorAll('.content-cell').forEach(cell => {
                    const mode = cell.dataset.mode;
                    const count = parseInt(cell.dataset.imageCount || 0);
                    const textInput = cell.querySelector('.cell-text-input');

                    if (mode === 'text' && textInput && textInput.textContent.trim()) {
                        addClearButton(cell, 0, true);
                    } else if (mode === 'image' && count > 0) {
                        addClearButton(cell, count, false);
                    } else {
                        removeClearButton(cell);
                    }
                });
                
                // 恢復鼠標
                document.body.style.cursor = originalBodyCursor;
                
                // 恢復介面語言
                updateInterfaceLanguage(currentLanguage);
            }
        }

        // --- 應用程式啟動 ---
        window.addEventListener('DOMContentLoaded', () => {
            initListeners();
        });
    </script>
</head>
<body class="p-6 md:p-12 min-h-screen">

    <!-- 主容器，用於 html2canvas 截圖 -->
    <div id="summary-container" class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl overflow-hidden">
        
        <!-- 標題和匯出按鈕區塊 -->
        <div class="header-container text-center py-4 border-b-2 border-black bg-gray-50 relative">
            <h1 id="title_main" contenteditable="true" class="editable-text text-2xl md:text-3xl font-bold leading-none p-2 tracking-wider">
                2025年度個人 DM 總結
            </h1>
            
            <!-- 調整：預設值按鈕和全清除按鈕容器 - 改為水平排列並居中 -->
            <div class="default-buttons-container">
                <!-- 語言按鈕固定為該語言的名稱 -->
                <button id="btn-default-zh" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-1 px-2 rounded-lg shadow-md transition-colors">
                    中文預設值
                </button>
                <button id="btn-default-en" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-1 px-2 rounded-lg shadow-md transition-colors">
                    English Defaults
                </button>
                <button id="btn-default-jp" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-1 px-2 rounded-lg shadow-md transition-colors">
                    日本語の初期値
                </button>
                <button id="btn-clear-all" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-2 rounded-lg shadow-md transition-colors">
                    全清除 (標題)
                </button>
            </div>


            <!-- 匯出按鈕：維持絕對定位靠右 -->
            <button id="export-button" onclick="exportAsImage()" 
                    class="absolute top-1/2 right-4 transform -translate-y-1/2 bg-green-500 hover:bg-green-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors flex items-center space-x-1 focus:outline-none focus:ring-2 focus:ring-green-400">
                <!-- SVG Icon for Download -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v7a1 1 0 11-2 0V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                <span>匯出 PNG</span>
            </button>
        </div>

        <!-- 表格主體，使用 Grid 佈局 -->
        <div class="grid grid-cols-5 border-l border-black">
            
            <!-- R1 (Title 1-5) -->
            <div id="header_r1_c1" contenteditable="true" class="editable-text text-center font-medium p-2 border-r border-b border-black bg-gray-100">年初玩的牌組</div>
            <div id="header_r1_c2" contenteditable="true" class="editable-text text-center font-medium p-2 border-r border-b border-black bg-gray-100">年底玩的牌組</div>
            <div id="header_r1_c3" contenteditable="true" class="editable-text text-center font-medium p-2 border-r border-b border-black bg-gray-100">最常玩的牌組</div>
            <div id="header_r1_c4" contenteditable="true" class="editable-text text-center font-medium p-2 border-r border-b border-black bg-gray-100">最喜歡的卡</div>
            <div id="header_r1_c5" contenteditable="true" class="editable-text text-center font-medium p-2 border-r border-b border-black bg-gray-100">最喜歡的Combo</div>

            <!-- 內容格 (Content Cells) - R2 -->
            
            <!-- Cell R2 C1 -->
            <div id="content_r2_c1" class="content-cell border-r border-b border-black" data-mode="select" tabindex="0" data-image-count="0">
                <div class="mode-selector-overlay flex flex-col space-y-2">
                    <!-- 按鈕文本將由 JS 動態切換 -->
                    <button class="btn-image bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">貼上圖片 (Ctrl+V)</button>
                    <button class="btn-text bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">輸入文字</button>
                </div>
                <div class="image-wrapper image-wrapper-1" data-image-id="1"><img alt="卡牌圖片 1"></div>
                <div class="image-wrapper image-wrapper-2" data-image-id="2"><img alt="卡牌圖片 2"></div>
                <div class="image-wrapper image-wrapper-3" data-image-id="3"><img alt="卡牌圖片 3"></div>
                <div class="diagonal-line"></div>
                <div class="cell-text-input break-words" contenteditable="true"></div>
            </div>

            <!-- Cell R2 C2 -->
            <div id="content_r2_c2" class="content-cell border-r border-b border-black" data-mode="select" tabindex="0" data-image-count="0">
                <div class="mode-selector-overlay flex flex-col space-y-2">
                    <button class="btn-image bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">貼上圖片 (Ctrl+V)</button>
                    <button class="btn-text bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">輸入文字</button>
                </div>
                <div class="image-wrapper image-wrapper-1" data-image-id="1"><img alt="卡牌圖片 1"></div>
                <div class="image-wrapper image-wrapper-2" data-image-id="2"><img alt="卡牌圖片 2"></div>
                <div class="image-wrapper image-wrapper-3" data-image-id="3"><img alt="卡牌圖片 3"></div>
                <div class="diagonal-line"></div>
                <div class="cell-text-input break-words" contenteditable="true"></div>
            </div>

            <!-- Cell R2 C3 -->
            <div id="content_r2_c3" class="content-cell border-r border-b border-black" data-mode="select" tabindex="0" data-image-count="0">
                <div class="mode-selector-overlay flex flex-col space-y-2">
                    <button class="btn-image bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">貼上圖片 (Ctrl+V)</button>
                    <button class="btn-text bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">輸入文字</button>
                </div>
                <div class="image-wrapper image-wrapper-1" data-image-id="1"><img alt="卡牌圖片 1"></div>
                <div class="image-wrapper image-wrapper-2" data-image-id="2"><img alt="卡牌圖片 2"></div>
                <div class="image-wrapper image-wrapper-3" data-image-id="3"><img alt="卡牌圖片 3"></div>
                <div class="diagonal-line"></div>
                <div class="cell-text-input break-words" contenteditable="true"></div>
            </div>

            <!-- Cell R2 C4 -->
            <div id="content_r2_c4" class="content-cell border-r border-b border-black" data-mode="select" tabindex="0" data-image-count="0">
                <div class="mode-selector-overlay flex flex-col space-y-2">
                    <button class="btn-image bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">貼上圖片 (Ctrl+V)</button>
                    <button class="btn-text bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">輸入文字</button>
                </div>
                <div class="image-wrapper image-wrapper-1" data-image-id="1"><img alt="卡牌圖片 1"></div>
                <div class="image-wrapper image-wrapper-2" data-image-id="2"><img alt="卡牌圖片 2"></div>
                <div class="image-wrapper image-wrapper-3" data-image-id="3"><img alt="卡牌圖片 3"></div>
                <div class="diagonal-line"></div>
                <div class="cell-text-input break-words" contenteditable="true"></div>
            </div>

            <!-- Cell R2 C5 -->
            <div id="content_r2_c5" class="content-cell border-r border-b border-black" data-mode="select" tabindex="0" data-image-count="0">
                <div class="mode-selector-overlay flex flex-col space-y-2">
                    <button class="btn-image bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">貼上圖片 (Ctrl+V)</button>
                    <button class="btn-text bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">輸入文字</button>
                </div>
                <div class="image-wrapper image-wrapper-1" data-image-id="1"><img alt="卡牌圖片 1"></div>
                <div class="image-wrapper image-wrapper-2" data-image-id="2"><img alt="卡牌圖片 2"></div>
                <div class="image-wrapper image-wrapper-3" data-image-id="3"><img alt="卡牌圖片 3"></div>
                <div class="diagonal-line"></div>
                <div class="cell-text-input break-words" contenteditable="true"></div>
            </div>

            <!-- R3 (Title 6-10) -->
            <div id="header_r3_c1" contenteditable="true" class="editable-text text-center font-medium p-2 border-r border-b border-black bg-gray-100">卡圖最好看的卡</div>
            <div id="header_r3_c2" contenteditable="true" class="editable-text text-center font-medium p-2 border-r border-b border-black bg-gray-100">最想放寬限制的卡</div>
            <div id="header_r3_c3" contenteditable="true" class="editable-text text-center font-medium p-2 border-r border-b border-black bg-gray-100">最想禁止的卡</div>
            <div id="header_r3_c4" contenteditable="true" class="editable-text text-center font-medium p-2 border-r border-b border-black bg-gray-100">最不想上手的卡</div>
            <div id="header_r3_c5" contenteditable="true" class="editable-text text-center font-medium p-2 border-r border-b border-black bg-gray-100">最不想遇上的卡</div>

            <!-- R4 (Content 6-10) -->
            <!-- Cell R4 C1 -->
            <div id="content_r4_c1" class="content-cell border-r border-b border-black" data-mode="select" tabindex="0" data-image-count="0">
                <div class="mode-selector-overlay flex flex-col space-y-2">
                    <button class="btn-image bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">貼上圖片 (Ctrl+V)</button>
                    <button class="btn-text bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">輸入文字</button>
                </div>
                <div class="image-wrapper image-wrapper-1" data-image-id="1"><img alt="卡牌圖片 1"></div>
                <div class="image-wrapper image-wrapper-2" data-image-id="2"><img alt="卡牌圖片 2"></div>
                <div class="image-wrapper image-wrapper-3" data-image-id="3"><img alt="卡牌圖片 3"></div>
                <div class="diagonal-line"></div>
                <div class="cell-text-input break-words" contenteditable="true"></div>
            </div>
            <!-- Cell R4 C2 -->
            <div id="content_r4_c2" class="content-cell border-r border-b border-black" data-mode="select" tabindex="0" data-image-count="0">
                <div class="mode-selector-overlay flex flex-col space-y-2">
                    <button class="btn-image bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">貼上圖片 (Ctrl+V)</button>
                    <button class="btn-text bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">輸入文字</button>
                </div>
                <div class="image-wrapper image-wrapper-1" data-image-id="1"><img alt="卡牌圖片 1"></div>
                <div class="image-wrapper image-wrapper-2" data-image-id="2"><img alt="卡牌圖片 2"></div>
                <div class="image-wrapper image-wrapper-3" data-image-id="3"><img alt="卡牌圖片 3"></div>
                <div class="diagonal-line"></div>
                <div class="cell-text-input break-words" contenteditable="true"></div>
            </div>
            <!-- Cell R4 C3 -->
            <div id="content_r4_c3" class="content-cell border-r border-b border-black" data-mode="select" tabindex="0" data-image-count="0">
                <div class="mode-selector-overlay flex flex-col space-y-2">
                    <button class="btn-image bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">貼上圖片 (Ctrl+V)</button>
                    <button class="btn-text bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">輸入文字</button>
                </div>
                <div class="image-wrapper image-wrapper-1" data-image-id="1"><img alt="卡牌圖片 1"></div>
                <div class="image-wrapper image-wrapper-2" data-image-id="2"><img alt="卡牌圖片 2"></div>
                <div class="image-wrapper image-wrapper-3" data-image-id="3"><img alt="卡牌圖片 3"></div>
                <div class="diagonal-line"></div>
                <div class="cell-text-input break-words" contenteditable="true"></div>
            </div>
            <!-- Cell R4 C4 -->
            <div id="content_r4_c4" class="content-cell border-r border-b border-black" data-mode="select" tabindex="0" data-image-count="0">
                <div class="mode-selector-overlay flex flex-col space-y-2">
                    <button class="btn-image bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">貼上圖片 (Ctrl+V)</button>
                    <button class="btn-text bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">輸入文字</button>
                </div>
                <div class="image-wrapper image-wrapper-1" data-image-id="1"><img alt="卡牌圖片 1"></div>
                <div class="image-wrapper image-wrapper-2" data-image-id="2"><img alt="卡牌圖片 2"></div>
                <div class="image-wrapper image-wrapper-3" data-image-id="3"><img alt="卡牌圖片 3"></div>
                <div class="diagonal-line"></div>
                <div class="cell-text-input break-words" contenteditable="true"></div>
            </div>
            <!-- Cell R4 C5 -->
            <div id="content_r4_c5" class="content-cell border-r border-b border-black" data-mode="select" tabindex="0" data-image-count="0">
                <div class="mode-selector-overlay flex flex-col space-y-2">
                    <button class="btn-image bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">貼上圖片 (Ctrl+V)</button>
                    <button class="btn-text bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">輸入文字</button>
                </div>
                <div class="image-wrapper image-wrapper-1" data-image-id="1"><img alt="卡牌圖片 1"></div>
                <div class="image-wrapper image-wrapper-2" data-image-id="2"><img alt="卡牌圖片 2"></div>
                <div class="image-wrapper image-wrapper-3" data-image-id="3"><img alt="卡牌圖片 3"></div>
                <div class="diagonal-line"></div>
                <div class="cell-text-input break-words" contenteditable="true"></div>
            </div>

            <!-- R5 (Title 11-15) -->
            <div id="header_r5_c1" contenteditable="true" class="editable-text text-center font-medium p-2 border-r border-b border-black bg-gray-100">最被低估的卡</div>
            <div id="header_r5_c2" contenteditable="true" class="editable-text text-center font-medium p-2 border-r border-b border-black bg-gray-100">最過譽的卡</div>
            <div id="header_r5_c3" contenteditable="true" class="editable-text text-center font-medium p-2 border-r border-b border-black bg-gray-100">買過最貴的卡</div>
            <div id="header_r5_c4" contenteditable="true" class="editable-text text-center font-medium p-2 border-r border-b border-black bg-gray-100">買了但沒用到的卡</div>
            <div id="header_r5_c5" contenteditable="true" class="editable-text text-center font-medium p-2 border-r border-b border-black bg-gray-100">想買但沒買的卡</div>

            <!-- R6 (Content 11-15) -->
            <!-- Cell R6 C1 -->
            <div id="content_r6_c1" class="content-cell border-r border-b border-black" data-mode="select" tabindex="0" data-image-count="0">
                <div class="mode-selector-overlay flex flex-col space-y-2">
                    <button class="btn-image bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">貼上圖片 (Ctrl+V)</button>
                    <button class="btn-text bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">輸入文字</button>
                </div>
                <div class="image-wrapper image-wrapper-1" data-image-id="1"><img alt="卡牌圖片 1"></div>
                <div class="image-wrapper image-wrapper-2" data-image-id="2"><img alt="卡牌圖片 2"></div>
                <div class="image-wrapper image-wrapper-3" data-image-id="3"><img alt="卡牌圖片 3"></div>
                <div class="diagonal-line"></div>
                <div class="cell-text-input break-words" contenteditable="true"></div>
            </div>
            <!-- Cell R6 C2 -->
            <div id="content_r6_c2" class="content-cell border-r border-b border-black" data-mode="select" tabindex="0" data-image-count="0">
                <div class="mode-selector-overlay flex flex-col space-y-2">
                    <button class="btn-image bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">貼上圖片 (Ctrl+V)</button>
                    <button class="btn-text bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">輸入文字</button>
                </div>
                <div class="image-wrapper image-wrapper-1" data-image-id="1"><img alt="卡牌圖片 1"></div>
                <div class="image-wrapper image-wrapper-2" data-image-id="2"><img alt="卡牌圖片 2"></div>
                <div class="image-wrapper image-wrapper-3" data-image-id="3"><img alt="卡牌圖片 3"></div>
                <div class="diagonal-line"></div>
                <div class="cell-text-input break-words" contenteditable="true"></div>
            </div>
            <!-- Cell R6 C3 -->
            <div id="content_r6_c3" class="content-cell border-r border-b border-black" data-mode="select" tabindex="0" data-image-count="0">
                <div class="mode-selector-overlay flex flex-col space-y-2">
                    <button class="btn-image bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">貼上圖片 (Ctrl+V)</button>
                    <button class="btn-text bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">輸入文字</button>
                </div>
                <div class="image-wrapper image-wrapper-1" data-image-id="1"><img alt="卡牌圖片 1"></div>
                <div class="image-wrapper image-wrapper-2" data-image-id="2"><img alt="卡牌圖片 2"></div>
                <div class="image-wrapper image-wrapper-3" data-image-id="3"><img alt="卡牌圖片 3"></div>
                <div class="diagonal-line"></div>
                <div class="cell-text-input break-words" contenteditable="true"></div>
            </div>
            <!-- Cell R6 C4 -->
            <div id="content_r6_c4" class="content-cell border-r border-b border-black" data-mode="select" tabindex="0" data-image-count="0">
                <div class="mode-selector-overlay flex flex-col space-y-2">
                    <button class="btn-image bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">貼上圖片 (Ctrl+V)</button>
                    <button class="btn-text bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">輸入文字</button>
                </div>
                <div class="image-wrapper image-wrapper-1" data-image-id="1"><img alt="卡牌圖片 1"></div>
                <div class="image-wrapper image-wrapper-2" data-image-id="2"><img alt="卡牌圖片 2"></div>
                <div class="image-wrapper image-wrapper-3" data-image-id="3"><img alt="卡牌圖片 3"></div>
                <div class="diagonal-line"></div>
                <div class="cell-text-input break-words" contenteditable="true"></div>
            </div>
            <!-- Cell R6 C5 -->
            <div id="content_r6_c5" class="content-cell border-r border-b border-black" data-mode="select" tabindex="0" data-image-count="0">
                <div class="mode-selector-overlay flex flex-col space-y-2">
                    <button class="btn-image bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">貼上圖片 (Ctrl+V)</button>
                    <button class="btn-text bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">輸入文字</button>
                </div>
                <div class="image-wrapper image-wrapper-1" data-image-id="1"><img alt="卡牌圖片 1"></div>
                <div class="image-wrapper image-wrapper-2" data-image-id="2"><img alt="卡牌圖片 2"></div>
                <div class="image-wrapper image-wrapper-3" data-image-id="3"><img alt="卡牌圖片 3"></div>
                <div class="diagonal-line"></div>
                <div class="cell-text-input break-words" contenteditable="true"></div>
            </div>

            <!-- R7 (Title 16-20) -->
            <div id="header_r7_c1" contenteditable="true" class="editable-text text-center font-medium p-2 border-r border-b border-black bg-gray-100">組過最奇葩的牌組</div>
            <div id="header_r7_c2" contenteditable="true" class="editable-text text-center font-medium p-2 border-r border-b border-black bg-gray-100">最常遇上的牌組</div>
            <div id="header_r7_c3" contenteditable="true" class="editable-text text-center font-medium p-2 border-r border-b border-black bg-gray-100">最離譜的牌組</div>
            <div id="header_r7_c4" contenteditable="true" class="editable-text text-center font-medium p-2 border-r border-b border-black bg-gray-100">最不喜歡的牌組</div>
            <div id="header_r7_c5" contenteditable="true" class="editable-text text-center font-medium p-2 border-r border-b border-black bg-gray-100">最喜歡的頻道</div>

            <!-- R8 (Content 16-20) -->
            <!-- Cell R8 C1 -->
            <div id="content_r8_c1" class="content-cell border-r border-b border-black" data-mode="select" tabindex="0" data-image-count="0">
                <div class="mode-selector-overlay flex flex-col space-y-2">
                    <button class="btn-image bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">貼上圖片 (Ctrl+V)</button>
                    <button class="btn-text bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">輸入文字</button>
                </div>
                <div class="image-wrapper image-wrapper-1" data-image-id="1"><img alt="卡牌圖片 1"></div>
                <div class="image-wrapper image-wrapper-2" data-image-id="2"><img alt="卡牌圖片 2"></div>
                <div class="image-wrapper image-wrapper-3" data-image-id="3"><img alt="卡牌圖片 3"></div>
                <div class="diagonal-line"></div>
                <div class="cell-text-input break-words" contenteditable="true"></div>
            </div>
            <!-- Cell R8 C2 -->
            <div id="content_r8_c2" class="content-cell border-r border-b border-black" data-mode="select" tabindex="0" data-image-count="0">
                <div class="mode-selector-overlay flex flex-col space-y-2">
                    <button class="btn-image bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">貼上圖片 (Ctrl+V)</button>
                    <button class="btn-text bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">輸入文字</button>
                </div>
                <div class="image-wrapper image-wrapper-1" data-image-id="1"><img alt="卡牌圖片 1"></div>
                <div class="image-wrapper image-wrapper-2" data-image-id="2"><img alt="卡牌圖片 2"></div>
                <div class="image-wrapper image-wrapper-3" data-image-id="3"><img alt="卡牌圖片 3"></div>
                <div class="diagonal-line"></div>
                <div class="cell-text-input break-words" contenteditable="true"></div>
            </div>
            <!-- Cell R8 C3 -->
            <div id="content_r8_c3" class="content-cell border-r border-b border-black" data-mode="select" tabindex="0" data-image-count="0">
                <div class="mode-selector-overlay flex flex-col space-y-2">
                    <button class="btn-image bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">貼上圖片 (Ctrl+V)</button>
                    <button class="btn-text bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">輸入文字</button>
                </div>
                <div class="image-wrapper image-wrapper-1" data-image-id="1"><img alt="卡牌圖片 1"></div>
                <div class="image-wrapper image-wrapper-2" data-image-id="2"><img alt="卡牌圖片 2"></div>
                <div class="image-wrapper image-wrapper-3" data-image-id="3"><img alt="卡牌圖片 3"></div>
                <div class="diagonal-line"></div>
                <div class="cell-text-input break-words" contenteditable="true"></div>
            </div>
            <!-- Cell R8 C4 -->
            <div id="content_r8_c4" class="content-cell border-r border-b border-black" data-mode="select" tabindex="0" data-image-count="0">
                <div class="mode-selector-overlay flex flex-col space-y-2">
                    <button class="btn-image bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">貼上圖片 (Ctrl+V)</button>
                    <button class="btn-text bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">輸入文字</button>
                </div>
                <div class="image-wrapper image-wrapper-1" data-image-id="1"><img alt="卡牌圖片 1"></div>
                <div class="image-wrapper image-wrapper-2" data-image-id="2"><img alt="卡牌圖片 2"></div>
                <div class="image-wrapper image-wrapper-3" data-image-id="3"><img alt="卡牌圖片 3"></div>
                <div class="diagonal-line"></div>
                <div class="cell-text-input break-words" contenteditable="true"></div>
            </div>
            <!-- Cell R8 C5 -->
            <div id="content_r8_c5" class="content-cell border-r border-b border-black" data-mode="select" tabindex="0" data-image-count="0">
                <div class="mode-selector-overlay flex flex-col space-y-2">
                    <button class="btn-image bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">貼上圖片 (Ctrl+V)</button>
                    <button class="btn-text bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition-colors">輸入文字</button>
                </div>
                <div class="image-wrapper image-wrapper-1" data-image-id="1"><img alt="卡牌圖片 1"></div>
                <div class="image-wrapper image-wrapper-2" data-image-id="2"><img alt="卡牌圖片 2"></div>
                <div class="image-wrapper image-wrapper-3" data-image-id="3"><img alt="卡牌圖片 3"></div>
                <div class="diagonal-line"></div>
                <div class="cell-text-input break-words" contenteditable="true"></div>
            </div>
            
        </div>
        
        <!-- 底部資訊/狀態欄 -->
        <div class="p-2 border-t border-black text-xs text-gray-600 text-center footer-info">
            <!-- 這些內容將在 JS 中被更新 -->
            <p><strong>操作提示:</strong> 點擊內容格後，先選擇 **貼上圖片** 或 **輸入文字**。</p>
            <p class="text-red-500">圖片模式下：按 Ctrl+V 貼上圖片 (桌面) 或點擊按鈕選擇圖片 (行動裝置/最多三張)，滾輪縮放，拖曳調整位置。三圖模式下，圖片會呈現**左(長方形)/右上/右下**分割。</p>
            <p class="text-blue-500 font-bold">目前模式：頁面重新整理後，所有輸入的內容和狀態都將被清除。</p>
        </div>

    </div>
    
</body>
</html>